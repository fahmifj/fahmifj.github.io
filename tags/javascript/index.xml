<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>javascript on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/javascript/</link>
    <description>Recent content in javascript on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sat, 06 Dec 2025 15:33:48 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/javascript/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Using Cloudflare Workers to Mirror My Blog</title>
      <link>https://fahmifj.github.io/blog/mirror-website-using-cloudflare-workers/</link>
      <pubDate>Sat, 06 Dec 2025 15:33:48 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/mirror-website-using-cloudflare-workers/</guid>
      <description>I want to host my blog on a custom domain that I own (fahmifj.space) instead of using the GitHub Pages domain (fahmifj.github.io).
However, migrating a site to another domain could negatively impact SEO. Although I&amp;rsquo;m not really concerned about it, I think it&amp;rsquo;s a great opportunity to learn something from this case.
So, instead of moving everything, I keep GH Pages as the primary site and let the custom domain act as a mirror.</description>
      <content:encoded><![CDATA[<p>I want to host my blog on a custom domain that I own (<code>fahmifj.space</code>) instead of using the GitHub Pages domain (<code>fahmifj.github.io</code>).</p>
<p>However, migrating a site to another domain could negatively impact SEO. Although I&rsquo;m not really concerned about it, I think it&rsquo;s a great opportunity to learn something from this case.</p>
<p>So, instead of moving everything, I keep GH Pages as the primary site and let the custom domain act as a mirror. Both domains serve the same content without redirecting one to the other.</p>
<p>This post documents the setup and explains why keeping GitHub Pages as the primary works better for me.</p>
<h2 id="cloudflare-workers-as-reverse-proxy">Cloudflare Workers as Reverse Proxy</h2>
<p>Cloudflare provides a feature called Workers. It allows you to write and run serverless code, similar in concept to Google Cloud Functions.</p>
<p>Using this feature, I write a Worker that acts as a reverse proxy. Its job is to fetch my GitHub Pages content and serve it back on the custom domain.</p>
<figure class="highlight">
    <pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">                       ┌──────────────────────────┐
</span></span><span class="line"><span class="cl">                       │   fahmifj.github.io      │
</span></span><span class="line"><span class="cl">                       │    (upstream hosting)    │
</span></span><span class="line"><span class="cl">                       └──────────┬───────────────┘
</span></span><span class="line"><span class="cl">                                  │ GitHub Pages origin
</span></span><span class="line"><span class="cl">                                  ▼
</span></span><span class="line"><span class="cl">                          Cloudflare Worker
</span></span><span class="line"><span class="cl">                          (proxy + rewrite)
</span></span><span class="line"><span class="cl">                                  │
</span></span><span class="line"><span class="cl">                                  ▼
</span></span><span class="line"><span class="cl">                            fahmifj.space
</span></span><span class="line"><span class="cl">                           (custom domain)</span></span></code></pre>
</figure><h3 id="create-worker-v1">Create Worker (v1)</h3>
<p>This first version of the Worker functions purely as a content fetcher.</p>
<figure class="highlight">
    <figcaption>
        <span class="hl-filename">worker.js</span>
    </figcaption>
    <pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Force everything to fetch from GitHub Pages 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="s2">&#34;fahmifj.github.io&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">headers</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">redirect</span><span class="o">:</span> <span class="s2">&#34;follow&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Copy GitHub response and serve it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre>
</figure><p>The result is straightforward, it serves the same content as GitHub Pages.</p>
<p><div class="img-container"><img src="./imgs/image-20251208204713163.png" alt="image-20251208204713163"  /></div>
</p>
<h3 id="attach-custom-domain-to-worker">Attach Custom Domain to Worker</h3>
<p>Next, I attach my custom domain to the Worker (<code>Workers &amp; Pages → My Worker → Settings → Domain &amp; Routers</code>).</p>
<img src="./imgs/image-20251209003601514.png" alt="image-20251209003601514" style="zoom: 50%;" />
<p>At this point, <code>fahmifj.space</code> is already serving the same content as <code>fahmifj.github.io</code>.</p>
<h3 id="worker-with-url-rewriter-v2">Worker with URL Rewriter (v2)</h3>
<p>Hugo builds my site with absolute URLs based on my GH Pages domain, which is <code>fahmifj.github.io</code>. Because of this, clicking most links on the custom domain sends users back to GH Pages.</p>
<p>To fix that, I need to make an adjustment on the Worker to rewrite all the GitHub Pages URLs and replace them with the custom domain. I also add a condition to:</p>
<ul>
<li>Block search engines indexing bot.</li>
<li>Return 404 for the sitemap.</li>
<li>Remove canonical link before the contents are served on the custom domain.</li>
</ul>
<figure class="highlight">
    <figcaption>
        <span class="hl-filename">worker.js</span>
    </figcaption>
    <pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">upstream</span> <span class="o">=</span> <span class="s2">&#34;fahmifj.github.io&#34;</span><span class="p">;</span> <span class="c1">// GitHub Pages domain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="s2">&#34;fahmifj.space&#34;</span><span class="p">;</span>  <span class="c1">// Custom domain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="c1">// Prevent indexing by googlebot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">ua</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;user-agent&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">ua</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&#34;googlebot&#34;</span><span class="p">,</span> <span class="s2">&#34;bingbot&#34;</span><span class="p">,</span> <span class="s2">&#34;slurp&#34;</span><span class="p">,</span> <span class="s2">&#34;duckduckbot&#34;</span><span class="p">,</span> <span class="s2">&#34;baiduspider&#34;</span><span class="p">,</span> <span class="s2">&#34;yandex&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;Not for indexing&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">403</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Do not serve sitemap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s2">&#34;/sitemap.xml&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">404</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">upstream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Fetch upstream content
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">headers</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">redirect</span><span class="o">:</span> <span class="s2">&#34;follow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Only HTML needs rewriting, leave CSS and JS as is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;content-type&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">contentType</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&#34;text/html&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Read HTML response
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">html</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//  Rewrite all URLs from upstream → custom domain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replaceAll</span><span class="p">(</span><span class="sb">`https://</span><span class="si">${</span><span class="nx">upstream</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="sb">`https://</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replaceAll</span><span class="p">(</span><span class="sb">`http://</span><span class="si">${</span><span class="nx">upstream</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="sb">`https://</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replaceAll</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">upstream</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Remove canonical &lt;link&gt; tag (so GitHub Pages stays canonical)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="sr">/&lt;link[^&gt;]+rel=[&#34;&#39;]?canonical[&#34;&#39;]?[^&gt;]*&gt;/gi</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Add no-index header (no crawling on my custom domain)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">newHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newHeaders</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&#34;X-Robots-Tag&#34;</span><span class="p">,</span> <span class="s2">&#34;noindex, nofollow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Return modified HTML
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">status</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">headers</span><span class="o">:</span> <span class="nx">newHeaders</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre>
</figure><h2 id="conclusion">Conclusion</h2>
<p>With this setup, the custom domain acting as a mirror can coexist with GH Pages.</p>
<p>You might think that it is odd to keep using GitHub pages even though I already have a custom domain. The reason is simple: I want my blog to stay online as long as possible by relying on a free service provided by GitHub itself.</p>
<p>If I used my custom domain as the primary site, I would be responsible for maintaining that domain (or even server). The custom domain can expire in one or two year and I might forget renewing it or even I decide to switch to another TLD. These all could negatively impact SEO*.</p>
<blockquote>
<p>*or .. maybe I&rsquo;m just a lazy sysadmin.</p>
</blockquote>
<p>But with GitHub Pages as the primary site, I don&rsquo;t have to worry about maintaining a domain. GitHub handles everything and the canonical URL stays consistent. This way, I will still have the freedom to change my custom domain in the future without worrying about SEO.</p>
<p>Okay that&rsquo;s it. See you in the next post!</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
